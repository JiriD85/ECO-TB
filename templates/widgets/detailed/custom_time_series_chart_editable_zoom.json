{
  "fqn": "custom_time_series_chart_editable_zoom",
  "name": "Custom Time Series Chart (Editable Zoom)",
  "deprecated": false,
  "image": "tb-image;/api/images/system/chart.svg",
  "description": "Custom time series chart with embedded, editable zoom selector code. Displays changes to time series data over time with a fully customizable bottom zoom window.",
  "descriptor": {
    "type": "timeseries",
    "sizeX": 8,
    "sizeY": 5,
    "resources": [
      {
        "url": "https://cdn.jsdelivr.net/npm/echarts@5.2.2/dist/echarts.min.js"
      }
    ],
    "templateHtml": "<div id=\"chartContainer\" style=\"width: 100%; height: 100%;\"></div>",
    "templateCss": "",
    "controllerScript": "var myChart;\nvar chartOptions;\nvar currentZoomState = null;  // Track zoom state to prevent reset\n\n// Dynamic x-axis label formatter based on time range\nfunction getXAxisLabelFormatter(timeRangeMs) {\n    // EDITABLE: Adjust these thresholds for different label formats\n    var oneHour = 60 * 60 * 1000;\n    var oneDay = 24 * oneHour;\n    var oneWeek = 7 * oneDay;\n    \n    return function(value) {\n        var date = new Date(value);\n        \n        if (timeRangeMs < oneHour) {\n            // Less than 1 hour: show time with seconds\n            return date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'});\n        } else if (timeRangeMs < oneDay) {\n            // Less than 1 day: show time without seconds\n            return date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});\n        } else if (timeRangeMs < oneWeek) {\n            // Less than 1 week: show date and time\n            return date.toLocaleDateString([], {month: 'short', day: 'numeric'}) + '\\n' + \n                   date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});\n        } else {\n            // More than 1 week: show date only\n            return date.toLocaleDateString([], {month: 'short', day: 'numeric'});\n        }\n    };\n}\n\nself.onInit = function() {\n    \n    // Initialize window.echarts instance\n    var chartElement = document.getElementById('chartContainer');\n    myChart = window.echarts.init(chartElement);\n    \n    // Listen for zoom events to track zoom state\n    myChart.on('datazoom', function(params) {\n        var option = myChart.getOption();\n        if (option.dataZoom && option.dataZoom.length > 0) {\n            // Store current zoom state\n            currentZoomState = {\n                start: option.dataZoom[0].start,\n                end: option.dataZoom[0].end\n            };\n        }\n    });\n    \n    // Calculate initial time range for label formatting\n    var timeRange = 60000; // default 1 minute\n    if (self.ctx.timeWindow) {\n        timeRange = self.ctx.timeWindow.maxTime - self.ctx.timeWindow.minTime;\n    }\n    \n    // Prepare initial chart options\n    chartOptions = {\n        tooltip: {\n            trigger: 'axis',\n            axisPointer: {\n                type: 'cross'\n            },\n            formatter: function(params) {\n                var result = '';\n                if (params.length > 0) {\n                    result += new Date(params[0].value[0]).toLocaleString() + '<br/>';\n                    params.forEach(function(param) {\n                        result += param.marker + ' ' + param.seriesName + ': ' + param.value[1] + '<br/>';\n                    });\n                }\n                return result;\n            }\n        },\n        legend: {\n            data: [],\n            top: 10,\n            left: 'center'\n        },\n        grid: {\n            left: '3%',\n            right: '4%',\n            top: '60px',\n            bottom: '80px',  // Make room for zoom slider (EDITABLE: adjust this value)\n            containLabel: true\n        },\n        xAxis: {\n            type: 'time',\n            boundaryGap: false,\n            axisLabel: {\n                formatter: getXAxisLabelFormatter(timeRange),\n                rotate: 0,  // EDITABLE: rotate labels if needed (0, 45, 90, etc.)\n                hideOverlap: true,  // Automatically hide overlapping labels\n                showMinLabel: true,\n                showMaxLabel: true,\n                // EDITABLE: Adjust interval for label density\n                // 'auto' lets ECharts decide, or use a number for fixed interval\n                interval: 'auto'\n            },\n            splitLine: {\n                show: false\n            }\n        },\n        yAxis: {\n            type: 'value',\n            axisLabel: {\n                formatter: '{value}'\n            }\n        },\n        series: [],\n        \n        // ==========================================\n        // ZOOM SELECTOR CONFIGURATION (EDITABLE)\n        // ==========================================\n        dataZoom: [\n            {\n                // Mouse wheel zoom (zoom by scrolling inside chart)\n                type: 'inside',\n                disabled: false,        // EDITABLE: set to true to disable mouse wheel zoom\n                realtime: true,         // EDITABLE: set to false for zoom only on release\n                start: 0,               // EDITABLE: initial zoom start position (0-100%)\n                end: 100,               // EDITABLE: initial zoom end position (0-100%)\n                minSpan: 5,             // EDITABLE: minimum zoom span (percentage)\n                maxSpan: 100,           // EDITABLE: maximum zoom span (percentage)\n                zoomOnMouseWheel: true, // EDITABLE: enable/disable mouse wheel zoom\n                moveOnMouseMove: true,  // EDITABLE: enable/disable pan with mouse drag\n                moveOnMouseWheel: false // EDITABLE: use Shift+wheel to pan instead of zoom\n            },\n            {\n                // Bottom slider zoom selector\n                type: 'slider',\n                show: true,             // EDITABLE: set to false to hide zoom slider\n                realtime: true,         // EDITABLE: set to false for updates only on release\n                start: 0,               // EDITABLE: initial slider start position (0-100%)\n                end: 100,               // EDITABLE: initial slider end position (0-100%)\n                \n                // Position and sizing (EDITABLE)\n                bottom: 10,             // EDITABLE: distance from bottom (pixels)\n                height: 30,             // EDITABLE: slider height (pixels)\n                left: '50px',           // EDITABLE: left margin\n                right: '50px',          // EDITABLE: right margin\n                \n                // Behavior settings (EDITABLE)\n                showDetail: true,       // EDITABLE: show detail data preview above handles\n                showDataShadow: true,   // EDITABLE: show data shadow in background\n                filterMode: 'filter',   // EDITABLE: 'filter', 'weakFilter', 'empty', or 'none'\n                \n                // Zoom limits (EDITABLE)\n                minSpan: 5,             // EDITABLE: minimum zoom span (percentage)\n                maxSpan: 100,           // EDITABLE: maximum zoom span (percentage)\n                \n                // Handle size (EDITABLE)\n                handleSize: '100%',     // EDITABLE: resize handle size\n                \n                // Colors and styling (EDITABLE)\n                borderColor: '#ddd',    // EDITABLE: border color\n                fillerColor: 'rgba(33, 150, 243, 0.2)', // EDITABLE: selected area color\n                handleStyle: {\n                    color: '#2196F3',   // EDITABLE: handle color\n                    borderColor: '#2196F3' // EDITABLE: handle border color\n                },\n                dataBackground: {\n                    lineStyle: {\n                        color: '#2196F3', // EDITABLE: data line color\n                        opacity: 0.5\n                    },\n                    areaStyle: {\n                        color: 'rgba(33, 150, 243, 0.2)', // EDITABLE: data area color\n                        opacity: 0.3\n                    }\n                },\n                selectedDataBackground: {\n                    lineStyle: {\n                        color: '#2196F3', // EDITABLE: selected data line color\n                        opacity: 0.8\n                    },\n                    areaStyle: {\n                        color: 'rgba(33, 150, 243, 0.3)', // EDITABLE: selected area color\n                        opacity: 0.5\n                    }\n                },\n                emphasis: {\n                    handleStyle: {\n                        borderColor: '#1976D2', // EDITABLE: handle color on hover\n                        borderWidth: 2\n                    }\n                },\n                \n                // Text styling (EDITABLE)\n                textStyle: {\n                    color: '#333'       // EDITABLE: label text color\n                },\n                \n                // Move handle sensitivity (EDITABLE)\n                moveHandleSize: 5,      // EDITABLE: move handle click area size\n                \n                // Zoom lock settings (EDITABLE)\n                zoomLock: false,        // EDITABLE: set to true to disable zoom, only allow pan\n                \n                // Throttle delay (EDITABLE)\n                throttle: 100           // EDITABLE: update throttle delay in milliseconds\n            }\n        ],\n        // ==========================================\n        // END ZOOM SELECTOR CONFIGURATION\n        // ==========================================\n        \n        animation: true,\n        animationDuration: 300\n    };\n    \n    // Prepare series data from configured datasources\n    if (self.ctx.data && self.ctx.data.length > 0) {\n        for (var i = 0; i < self.ctx.data.length; i++) {\n            var dataKey = self.ctx.data[i].dataKey;\n            chartOptions.legend.data.push(dataKey.label);\n            chartOptions.series.push({\n                name: dataKey.label,\n                type: self.ctx.settings && self.ctx.settings.chartType ? self.ctx.settings.chartType : 'line',\n                smooth: true,\n                data: [],\n                itemStyle: {\n                    color: dataKey.color || '#2196F3'\n                },\n                lineStyle: {\n                    width: 2\n                },\n                showSymbol: false,\n                areaStyle: self.ctx.settings && self.ctx.settings.fillArea ? {\n                    opacity: 0.3\n                } : null\n            });\n        }\n    }\n    \n    myChart.setOption(chartOptions);\n    self.onResize();\n};\n\nself.onResize = function() {\n    if (myChart) {\n        myChart.resize();\n    }\n};\n\nself.onDataUpdated = function() {\n    if (!myChart || !chartOptions) return;\n    \n    // Update series data\n    for (var i = 0; i < self.ctx.data.length; i++) {\n        var datasourceData = self.ctx.data[i];\n        var dataSet = datasourceData.data;\n        var chartData = [];\n        \n        for (var d = 0; d < dataSet.length; d++) {\n            var tsValuePair = dataSet[d];\n            var ts = tsValuePair[0];  // timestamp\n            var value = tsValuePair[1]; // value\n            chartData.push([ts, value]);\n        }\n        \n        if (chartOptions.series[i]) {\n            chartOptions.series[i].data = chartData;\n        }\n    }\n    \n    // Update time window bounds and x-axis formatter\n    if (self.ctx.timeWindow) {\n        var timeRange = self.ctx.timeWindow.maxTime - self.ctx.timeWindow.minTime;\n        chartOptions.xAxis.min = self.ctx.timeWindow.minTime;\n        chartOptions.xAxis.max = self.ctx.timeWindow.maxTime;\n        chartOptions.xAxis.axisLabel.formatter = getXAxisLabelFormatter(timeRange);\n    }\n    \n    // Preserve zoom state if it exists (prevents reset on dynamic updates)\n    // EDITABLE: Set to false to always reset zoom on data update\n    var preserveZoom = true;\n    \n    if (preserveZoom && currentZoomState) {\n        // Restore the zoom state\n        chartOptions.dataZoom[0].start = currentZoomState.start;\n        chartOptions.dataZoom[0].end = currentZoomState.end;\n        chartOptions.dataZoom[1].start = currentZoomState.start;\n        chartOptions.dataZoom[1].end = currentZoomState.end;\n        \n        // Use notMerge: false to preserve zoom state\n        myChart.setOption(chartOptions, false);\n    } else {\n        // Reset zoom state (default behavior for first load)\n        myChart.setOption(chartOptions, true);\n    }\n};\n\nself.onDestroy = function() {\n    if (myChart) {\n        myChart.dispose();\n        myChart = null;\n    }\n};\n\nself.typeParameters = function() {\n    return {\n        useCustomDatasources: false,\n        maxDatasources: -1,\n        maxDataKeys: -1,\n        dataKeysOptional: false\n    };\n};\n",
    "settingsForm": "[\n  {\n    \"id\": \"chartType\",\n    \"name\": \"Chart type\",\n    \"type\": \"select\",\n    \"default\": \"line\",\n    \"options\": [\n      {\"value\": \"line\", \"label\": \"Line\"},\n      {\"value\": \"bar\", \"label\": \"Bar\"}\n    ],\n    \"fieldClass\": \"flex\"\n  },\n  {\n    \"id\": \"fillArea\",\n    \"name\": \"Fill area under line\",\n    \"type\": \"boolean\",\n    \"default\": false,\n    \"fieldClass\": \"flex\"\n  }\n]",
    "dataKeySettingsForm": [],
    "latestDataKeySettingsForm": [],
    "settingsDirective": "",
    "dataKeySettingsDirective": "",
    "latestDataKeySettingsDirective": "",
    "hasBasicMode": false,
    "basicModeDirective": "",
    "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Temperature\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.8587686344902596,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\",\"aggregationType\":null,\"units\":null,\"decimals\":null,\"usePostProcessing\":null,\"postFuncBody\":null},{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Humidity\",\"color\":\"#FFC107\",\"settings\":{},\"_hash\":0.5534217244004682,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\",\"aggregationType\":null,\"units\":null,\"decimals\":null,\"usePostProcessing\":null,\"postFuncBody\":null}],\"alarmFilterConfig\":{\"statusList\":[\"ACTIVE\"]}}],\"timewindow\":{\"hideInterval\":false,\"hideLastInterval\":false,\"hideQuickInterval\":false,\"hideAggregation\":false,\"hideAggInterval\":false,\"hideTimezone\":false,\"selectedTab\":0,\"realtime\":{\"realtimeType\":0,\"timewindowMs\":60000,\"quickInterval\":\"CURRENT_DAY\",\"interval\":1000},\"aggregation\":{\"type\":\"AVG\",\"limit\":25000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"12px\",\"settings\":{\"chartType\":\"line\",\"fillArea\":false},\"title\":\"Custom Time Series Chart\",\"dropShadow\":true,\"enableFullscreen\":true,\"useDashboardTimewindow\":false,\"displayTimewindow\":true}"
  },
  "externalId": null,
  "resources": null,
  "id": {
    "entityType": "WIDGET_TYPE",
    "id": "fe72cbd0-d75a-11f0-adcd-fbd962729c18"
  },
  "createdTime": 1765544626445,
  "tenantId": {
    "entityType": "TENANT",
    "id": "efb63c10-b576-11ee-a6c2-a149ed03c64d"
  },
  "scada": false,
  "version": 1,
  "tags": [
    "chart",
    "time series",
    "custom",
    "zoom",
    "editable"
  ]
}