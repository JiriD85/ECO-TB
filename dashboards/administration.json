{
  "title": "Administration",
  "image": "tb-image;/api/images/tenant/belimo_retrofit_plus_padding.png",
  "mobileHide": false,
  "mobileOrder": 2,
  "configuration": {
    "description": "",
    "widgets": {
      "777ded27-e3b8-d901-ca42-3079a23f7a12": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "ECO Diagnostics Partner",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "false",
            "displayEntityName": true,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 15,
            "pageStepCount": 3,
            "pageStepIncrement": 15,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Retrofit companies",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "21d657b1-d301-fa72-ed75-6e2000eb5e51",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "{i18n:custom.retrofit-companies.address}",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "70%",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.1345774127559587,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "{i18n:custom.retrofit-companies.manage-projects}",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Projects",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "5e50c296-0eac-8841-a69a-1cbbfe04d1c5"
              }
            ],
            "actionCellButton": [
              {
                "name": "{i18n:custom.retrofit-companies.manage-projects}",
                "icon": "assignment",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "manage_projects",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "5f052715-0e89-d43b-60f4-83de99f5e2ac"
              },
              {
                "name": "{i18n:custom.retrofit-companies.manage-diagnostic-kits}",
                "icon": "medical_services",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "manage_diagnostickits",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "ef986bd4-8ab7-fde5-79e7-52b3bb257474"
              },
              {
                "name": "{i18n:custom.retrofit-companies.manage-users}",
                "icon": "people",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "user",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "347536c1-e013-249a-c93e-acc1706de1bb"
              },
              {
                "name": "{i18n:custom.retrofit-companies.edit-company}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editCompanyFormGroup\"\r\n      (ngSubmit)=\"save()\"  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n     <h2 class=\"text-lg font-semibold\">{{ 'custom.retrofit-companies.edit-company' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-company-title' | translate }}</mat-label>\r\n        <input matInput formControlName=\"title\" required>\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('title').hasError('required')\">\r\n          {{ 'custom.retrofit-companies.add-company-company-title-is-required' | translate }}\r\n        </mat-error>\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('title').hasError('maxlength')\">\r\n          {{ 'customer.title-max-length' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- Existing contact component -->\r\n      <tb-contact [parentForm]=\"editCompanyFormGroup\" [isEdit]=\"true\"></tb-contact>\r\n      \r\n      <!-- New field: Shortname -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-short-name' | translate }}</mat-label>\r\n        <input matInput formControlName=\"shortName\" required minlength=\"3\" maxlength=\"4\">\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('shortName').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-short-name-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- New field: Deadline for Cancelations (days) -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-cancelation-deadline' | translate }}</mat-label>\r\n        <input matInput type=\"number\" formControlName=\"cancelDeadline\">\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('cancelDeadline').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-cancelation-deadline-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- New field: Deadline for Payments (days) -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-payment-deadline' | translate }}</mat-label>\r\n        <input matInput type=\"number\" formControlName=\"paymentDeadline\">\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('paymentDeadline').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-payment-deadline-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n  </div>\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button mat-button color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\" cdkFocusInitial>\r\n      {{ 'action.cancel' | translate }}\r\n    </button>\r\n    <button mat-button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(isLoading$ | async) || editCompanyFormGroup.invalid || !editCompanyFormGroup.dirty\">\r\n      {{ 'custom.retrofit-companies.add-company-save-company' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "const POSTAL_CODE_PATTERNS = {\r\n  'United States': '(\\\\d{5}([\\\\-]\\\\d{4})?)',\r\n  'Australia': '[0-9]{4}',\r\n  'Austria': '[0-9]{4}',\r\n  'Belgium': '[0-9]{4}',\r\n  'Brazil': '[0-9]{5}[\\\\-]?[0-9]{3}',\r\n  'Canada': '^(?!.*[DFIOQU])[A-VXY][0-9][A-Z][ -]?[0-9][A-Z][0-9]$',\r\n  'Denmark': '[0-9]{3,4}',\r\n  'Faroe Islands': '[0-9]{3,4}',\r\n  'Netherlands': '[1-9][0-9]{3}\\\\s?[a-zA-Z]{2}',\r\n  'Germany': '[0-9]{5}',\r\n  'Hungary': '[0-9]{4}',\r\n  'Italy': '[0-9]{5}',\r\n  'Japan': '\\\\d{3}-\\\\d{4}',\r\n  'Luxembourg': '(L\\\\s*(-|—|–))\\\\s*?[\\\\d]{4}',\r\n  'Poland': '[0-9]{2}\\\\-[0-9]{3}',\r\n  'Spain': '((0[1-9]|5[0-2])|[1-4][0-9])[0-9]{3}',\r\n  'Sweden': '\\\\d{3}\\\\s?\\\\d{2}',\r\n  'United Kingdom': '[A-Za-z]{1,2}[0-9Rr][0-9A-Za-z]? [0-9][ABD-HJLNP-UW-Zabd-hjlnp-uw-z]{2}'\r\n};\r\n\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\n\r\nopenEditCompanyDialog();\r\n\r\nfunction openEditCompanyDialog() {\r\n  customDialog.customDialog(htmlTemplate, EditCompanyDialogController).subscribe();\r\n}\r\n\r\nfunction EditCompanyDialogController(instance) {\r\n  let vm = instance;\r\n  \r\n  vm.customer = {};\r\n\r\n  vm.editCompanyFormGroup = vm.fb.group({\r\n    title: ['', [vm.validators.required, vm.validators.maxLength(255)]]\r\n  });\r\n  \r\n  // Add existing form controls\r\n  vm.editCompanyFormGroup.addControl('country', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('city', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('state', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('zip', vm.fb.control('', zipValidators('')));\r\n  vm.editCompanyFormGroup.addControl('address', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('address2', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('phone', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('email', vm.fb.control('', [vm.validators.email]));\r\n  \r\n  // Add new controls for deadline fields\r\n  vm.editCompanyFormGroup.addControl('cancelDeadline', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('paymentDeadline', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('shortName', vm.fb.control('', []));\r\n  \r\n  // Update zip validators on country change\r\n  vm.editCompanyFormGroup.get('country').valueChanges.subscribe((country) => {\r\n    vm.editCompanyFormGroup.get('zip').setValidators(zipValidators(country));\r\n    vm.editCompanyFormGroup.get('zip').updateValueAndValidity({ onlySelf: true });\r\n    vm.editCompanyFormGroup.get('zip').markAsTouched({ onlySelf: true });\r\n  });\r\n  \r\n  getCompany();\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    vm.editCompanyFormGroup.markAsPristine();\r\n    saveCompanyObservable().subscribe(function (customer) {\r\n      widgetContext.rxjs.forkJoin([\r\n          saveAttributes(customer)\r\n      ]).subscribe(function () {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n      });\r\n    });\r\n  };\r\n  \r\n  function getCompany() {\r\n    customerService.getCustomer(entityId.id).subscribe((customer) => {\r\n        attributeService.getEntityAttributes(customer.id, \"SERVER_SCOPE\", [\"cancelDeadline\",\"paymentDeadline\",\"shortName\"]).subscribe(attributes => {\r\n      const shortNameObj = attributes.find(item => item.key === \"shortName\");\r\n      const shortName = shortNameObj ? shortNameObj.value : \"\";\r\n      const paymentDeadlineObj = attributes.find(item => item.key === \"paymentDeadline\");\r\n      const paymentDeadline = paymentDeadlineObj ? paymentDeadlineObj.value : \"\";\r\n      const cancelDeadlineObj = attributes.find(item => item.key === \"cancelDeadline\");\r\n      const cancelDeadline = cancelDeadlineObj ? cancelDeadlineObj.value : \"\";\r\n      vm.customer = customer;\r\n      // Patch form with customer details including deadlines (if available)\r\n      vm.editCompanyFormGroup.patchValue({\r\n        title: vm.customer.title,\r\n        country: vm.customer.country,\r\n        city: vm.customer.city,\r\n        state: vm.customer.state,\r\n        zip: vm.customer.zip,\r\n        address: vm.customer.address,\r\n        address2: vm.customer.address2,\r\n        phone: vm.customer.phone,\r\n        email: vm.customer.email,\r\n        cancelDeadline: cancelDeadline || '',\r\n        paymentDeadline: paymentDeadline || '',\r\n        shortName: shortName || ''\r\n      }, { emitEvent: false });\r\n      vm.editCompanyFormGroup.get('zip').setValidators(zipValidators(vm.customer.country));\r\n      vm.editCompanyFormGroup.get('zip').updateValueAndValidity({ onlySelf: true });\r\n    });\r\n    });\r\n  }\r\n  \r\n  function zipValidators(country) {\r\n    const validators = [];\r\n    if (country && POSTAL_CODE_PATTERNS[country]) {\r\n      const postalCodePattern = POSTAL_CODE_PATTERNS[country];\r\n      validators.push(vm.validators.pattern(postalCodePattern));\r\n    }\r\n    return validators;\r\n  }\r\n\r\n  function saveCompanyObservable() {\r\n    const formValues = vm.editCompanyFormGroup.value;\r\n    vm.customer.title = formValues.title;\r\n    vm.customer.country = formValues.country;\r\n    vm.customer.city = formValues.city;\r\n    vm.customer.state = formValues.state;\r\n    vm.customer.zip = formValues.zip;\r\n    vm.customer.address = formValues.address;\r\n    vm.customer.address2 = formValues.address2;\r\n    vm.customer.phone = formValues.phone;\r\n    vm.customer.email = formValues.email;\r\n   /* // Optionally update deadlines in the customer object\r\n    vm.customer.cancelDeadline = formValues.cancelDeadline;\r\n    vm.customer.paymentDeadline = formValues.paymentDeadline;\r\n    vm.customer.shortName = formValues.shortName;*/\r\n    return customerService.saveCustomer(vm.customer);\r\n  }\r\n  \r\n  function saveAttributes(customer) {\r\n    const formValues = vm.editCompanyFormGroup.value;\r\n    let attributesArray = [\r\n      { key: 'type', value: 'retail' },\r\n      { key: 'address', value: getAddressValue(customer) },\r\n      { key: 'cancelDeadline', value: formValues.cancelDeadline },\r\n      { key: 'paymentDeadline', value: formValues.paymentDeadline },\r\n      { key: 'shortName', value: formValues.shortName }\r\n    ];\r\n    return attributeService.saveEntityAttributes(customer.id, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n  \r\n  function getAddressValue(customer) {\r\n    var address = '';\r\n    if (customer.address) {\r\n      address += customer.address;\r\n    }\r\n    if (customer.address2) {\r\n      address += (address ? ', ' : '') + customer.address2;\r\n    }\r\n    if (customer.city) {\r\n      address += (address ? ', ' : '') + customer.city;\r\n    }\r\n    if (customer.state) {\r\n      address += (address ? ', ' : '') + customer.state;\r\n    }\r\n    if (customer.zip) {\r\n      address += (customer.state ? ' ' : (address ? ', ' : '')) + customer.zip;\r\n    }\r\n    if (customer.country) {\r\n      address += (address ? ', ' : '') + customer.country;\r\n    }\r\n    return address;\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.retrofit-companies.delete-company}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\nopenDeleteCustomerDialog();\n\nfunction openDeleteCustomerDialog() {\n  let titleTranslation = translationService.instant(\n    'custom.retrofit-companies.delete-company-titel',\n    { entityName: entityName }\n  );\n\n  let contentTranslation = translationService.instant(\n    'custom.retrofit-companies.delete-company-content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteCustomer();\n    }\n  });\n}\n\n\nfunction deleteCustomer() {\n  customerService.deleteCustomer(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.retrofit-companies.add-company}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addCompanyFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 600px;\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>{{ 'custom.retrofit-companies.add-company' | translate }}</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-company-title' | translate }}</mat-label>\r\n        <input matInput formControlName=\"title\" required>\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('title').hasError('required')\">\r\n          {{ 'custom.retrofit-companies.add-company-company-title-is-required' | translate }}\r\n        </mat-error>\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('title').hasError('maxlength')\">\r\n          {{ 'customer.title-max-length' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- Existing contact component -->\r\n      <tb-contact [parentForm]=\"addCompanyFormGroup\" [isEdit]=\"true\"></tb-contact>\r\n      \r\n      <!-- New field: Shortname -->\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-short-name' | translate }}</mat-label>\r\n        <input matInput formControlName=\"shortName\" required minlength=\"3\" maxlength=\"4\">\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('shortName').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-short-name-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- New field: Deadline for Cancelations (days) -->\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-cancelation-deadline' | translate }}</mat-label>\r\n        <input matInput type=\"number\" formControlName=\"cancelDeadline\" required>\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('cancelDeadline').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-cancelation-deadline-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- New field: Deadline for Payments (days) -->\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-payment-deadline' | translate }}</mat-label>\r\n        <input matInput type=\"number\" formControlName=\"paymentDeadline\" required>\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('paymentDeadline').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-payment-deadline-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n  </div>\r\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n    <button mat-button color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\" cdkFocusInitial>\r\n      {{ 'action.cancel' | translate }}\r\n    </button>\r\n    <button mat-button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(isLoading$ | async) || addCompanyFormGroup.invalid || !addCompanyFormGroup.dirty\">\r\n      {{ 'custom.retrofit-companies.add-company' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "const POSTAL_CODE_PATTERNS = {\r\n  'United States': '(\\\\d{5}([\\\\-]\\\\d{4})?)',\r\n  'Australia': '[0-9]{4}',\r\n  'Austria': '[0-9]{4}',\r\n  'Belgium': '[0-9]{4}',\r\n  'Brazil': '[0-9]{5}[\\\\-]?[0-9]{3}',\r\n  'Canada': '^(?!.*[DFIOQU])[A-VXY][0-9][A-Z][ -]?[0-9][A-Z][0-9]$',\r\n  'Denmark': '[0-9]{3,4}',\r\n  'Faroe Islands': '[0-9]{3,4}',\r\n  'Netherlands': '[1-9][0-9]{3}\\\\s?[a-zA-Z]{2}',\r\n  'Germany': '[0-9]{5}',\r\n  'Hungary': '[0-9]{4}',\r\n  'Italy': '[0-9]{5}',\r\n  'Japan': '\\\\d{3}-\\\\d{4}',\r\n  'Luxembourg': '(L\\\\s*(-|—|–))\\\\s*?[\\\\d]{4}',\r\n  'Poland': '[0-9]{2}\\\\-[0-9]{3}',\r\n  'Spain': '((0[1-9]|5[0-2])|[1-4][0-9])[0-9]{3}',\r\n  'Sweden': '\\\\d{3}\\\\s?\\\\d{2}',\r\n  'United Kingdom': '[A-Za-z]{1,2}[0-9Rr][0-9A-Za-z]? [0-9][ABD-HJLNP-UW-Zabd-hjlnp-uw-z]{2}'\r\n};\r\n\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet roleService = $injector.get(widgetContext.servicesMap.get('roleService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\r\n/*let stripeKey;*/\r\n\r\n/*attributeService\r\n  .getEntityAttributes({ entityType: 'TENANT', id: tenantId }, \"SERVER_SCOPE\", ['stripeKey'])\r\n  .subscribe(key => {\r\n      stripeKey = key[0].value;\r\n      openAddCompanyDialog();\r\n  });*/\r\n  \r\nopenAddCompanyDialog();\r\n\r\nfunction openAddCompanyDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddCompanyDialogController).subscribe();\r\n}\r\n\r\nfunction AddCompanyDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  // Initialize form with company title control\r\n  vm.addCompanyFormGroup = vm.fb.group({\r\n    title: ['', [vm.validators.required, vm.validators.maxLength(255)]]\r\n  });\r\n  \r\n  // Existing form controls\r\n  vm.addCompanyFormGroup.addControl('country', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('city', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('state', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('zip', vm.fb.control('', zipValidators('')));\r\n  vm.addCompanyFormGroup.addControl('address', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('address2', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('phone', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('email', vm.fb.control('', [vm.validators.email]));\r\n\r\n  // New controls for deadline fields\r\n  vm.addCompanyFormGroup.addControl('cancelDeadline', vm.fb.control(90, []));\r\n  vm.addCompanyFormGroup.addControl('paymentDeadline', vm.fb.control(14, []));\r\n  vm.addCompanyFormGroup.addControl('shortName', vm.fb.control('', []));\r\n  \r\n  // Update zip validators when country value changes\r\n  vm.addCompanyFormGroup.get('country').valueChanges.subscribe((country) => {\r\n    vm.addCompanyFormGroup.get('zip').setValidators(zipValidators(country));\r\n    vm.addCompanyFormGroup.get('zip').updateValueAndValidity({ onlySelf: true });\r\n    vm.addCompanyFormGroup.get('zip').markAsTouched({ onlySelf: true });\r\n  });\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    vm.addCompanyFormGroup.markAsPristine();\r\n    saveCompanyObservable().subscribe(function (customer) {\r\n      widgetContext.rxjs.forkJoin([\r\n        saveAttributes(customer),\r\n        saveUserGroups(customer.id)\r\n      ]).subscribe(function () {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n      });\r\n    });\r\n  };\r\n  \r\n  function zipValidators(country) {\r\n    const zipValidators = [];\r\n    if (country && POSTAL_CODE_PATTERNS[country]) {\r\n      const postalCodePattern = POSTAL_CODE_PATTERNS[country];\r\n      zipValidators.push(vm.validators.pattern(postalCodePattern));\r\n    }\r\n    return zipValidators;\r\n  }\r\n\r\n  function saveCompanyObservable() {\r\n    return getOrCreateSmartRetailCustomerGroup().pipe(\r\n      widgetContext.rxjs.switchMap((smartRetail) => {\r\n        const formValues = vm.addCompanyFormGroup.value;\r\n        let customer = {\r\n          title: formValues.title,\r\n          country: formValues.country,\r\n          city: formValues.city,\r\n          state: formValues.state,\r\n          zip: formValues.zip,\r\n          address: formValues.address,\r\n          address2: formValues.address2,\r\n          phone: formValues.phone,\r\n          email: formValues.email\r\n        };\r\n        return customerService.saveCustomer(customer, smartRetail.id.id);\r\n      })\r\n    );\r\n  }\r\n  \r\n  function getOrCreateSmartRetailCustomerGroup() {\r\n    return getEntityGroupByName(\"Belimo Retrofit\", \"CUSTOMER\").pipe(\r\n      widgetContext.rxjs.switchMap((group) => {\r\n        if (group) {\r\n          return widgetContext.rxjs.of(group);\r\n        } else {\r\n          var smartRetail = {\r\n            type: 'CUSTOMER',\r\n            name: 'Belimo Retrofit'\r\n          };\r\n          return entityGroupService.saveEntityGroup(smartRetail);\r\n        }\r\n      })\r\n    );\r\n  }\r\n  \r\n  function saveUserGroups(customerId) {\r\n    return widgetContext.rxjs.forkJoin([\r\n      getRoleByName(\"Belimo Retrofit Read Only\", \"GROUP\"),\r\n      getRoleByName(\"Belimo Retrofit Users\", \"GENERIC\"),\r\n      getRoleByName(\"Belimo Retrofit Administrators\", \"GENERIC\"),\r\n      getRoleByName(\"Belimo Retrofit Engineer\", \"GENERIC\"),\r\n      getEntityGroupByName(\"Belimo Retrofit\", \"DASHBOARD\"),\r\n      getEntityGroupByName(\"Belimo Retrofit Administrators\", \"DASHBOARD\")\r\n    ]).pipe(widgetContext.rxjs.switchMap((data) => {\r\n      var smartRetailReadOnlyGroupRole = data[0];\r\n      var smartRetailUserGenericRole = data[1];\r\n      var smartRetailAdministratorGenericRole = data[2];\r\n      var smartRetailEngineerGenericRole = data[3];\r\n      var smartRetailSharedGroup = data[4];\r\n      var smartRetailGroup = data[5];\r\n      \r\n      var smartRetailUsers = {\r\n        type: 'USER',\r\n        name: 'Belimo Retrofit Users',\r\n        ownerId: customerId\r\n      };\r\n      \r\n      var smartRetailAdministrators = {\r\n        type: 'USER',\r\n        name: 'Belimo Retrofit Administrators',\r\n        ownerId: customerId\r\n      };\r\n      \r\n      var smartRetailEngineer = {\r\n        type: 'USER',\r\n        name: 'Belimo Retrofit Engineer',\r\n        ownerId: customerId\r\n      };\r\n\r\n      return widgetContext.rxjs.forkJoin([\r\n        entityGroupService.saveEntityGroup(smartRetailUsers),\r\n        entityGroupService.saveEntityGroup(smartRetailAdministrators),\r\n        entityGroupService.saveEntityGroup(smartRetailEngineer)\r\n      ]).pipe(widgetContext.rxjs.switchMap((data) => {\r\n        var smartRetailUsersGroup = data[0];\r\n        var smartRetailAdministratorsGroup = data[1];\r\n        var smartRetailEngineerGroup = data[2];\r\n\r\n        const tasks = [];\r\n\r\n        if (smartRetailReadOnlyGroupRole) {\r\n          if (smartRetailSharedGroup) {\r\n            let smartRetailSharedGroupPermissionForUsers = {\r\n              userGroupId: smartRetailUsersGroup.id,\r\n              roleId: smartRetailReadOnlyGroupRole.id,\r\n              entityGroupId: smartRetailSharedGroup.id,\r\n              entityGroupType: smartRetailSharedGroup.type\r\n            };\r\n            let smartRetailSharedGroupPermissionForAdmins = {\r\n              userGroupId: smartRetailAdministratorsGroup.id,\r\n              roleId: smartRetailReadOnlyGroupRole.id,\r\n              entityGroupId: smartRetailSharedGroup.id,\r\n              entityGroupType: smartRetailSharedGroup.type\r\n            };\r\n            let smartRetailSharedGroupPermissionForEngineer = {\r\n              userGroupId: smartRetailEngineerGroup.id,\r\n              roleId: smartRetailReadOnlyGroupRole.id,\r\n              entityGroupId: smartRetailSharedGroup.id,\r\n              entityGroupType: smartRetailSharedGroup.type\r\n            };\r\n            tasks.push(roleService.saveGroupPermission(smartRetailSharedGroupPermissionForUsers));\r\n            tasks.push(roleService.saveGroupPermission(smartRetailSharedGroupPermissionForAdmins));\r\n            tasks.push(roleService.saveGroupPermission(smartRetailSharedGroupPermissionForEngineer));\r\n          }\r\n          if (smartRetailGroup) {\r\n            let smartRetailGroupPermissionForAdmins = {\r\n              userGroupId: smartRetailAdministratorsGroup.id,\r\n              roleId: smartRetailReadOnlyGroupRole.id,\r\n              entityGroupId: smartRetailGroup.id,\r\n              entityGroupType: smartRetailGroup.type\r\n            };\r\n            tasks.push(roleService.saveGroupPermission(smartRetailGroupPermissionForAdmins));\r\n          }\r\n        }\r\n\r\n        if (smartRetailUserGenericRole) {\r\n          let smartRetailUserGenericPermission = {\r\n            userGroupId: smartRetailUsersGroup.id,\r\n            roleId: smartRetailUserGenericRole.id\r\n          };\r\n          tasks.push(roleService.saveGroupPermission(smartRetailUserGenericPermission));\r\n        }\r\n\r\n        if (smartRetailAdministratorGenericRole) {\r\n          let smartRetailAdminGenericPermission = {\r\n            userGroupId: smartRetailAdministratorsGroup.id,\r\n            roleId: smartRetailAdministratorGenericRole.id\r\n          };\r\n          tasks.push(roleService.saveGroupPermission(smartRetailAdminGenericPermission));\r\n        }\r\n        \r\n        if (smartRetailEngineerGenericRole) {\r\n          let smartRetailEngineerGenericPermission = {\r\n            userGroupId: smartRetailEngineerGroup.id,\r\n            roleId: smartRetailEngineerGenericRole.id\r\n          };\r\n          tasks.push(roleService.saveGroupPermission(smartRetailEngineerGenericPermission));\r\n        }\r\n        \r\n        if (tasks.length) {\r\n          return widgetContext.rxjs.forkJoin(tasks);\r\n        } else {\r\n          return widgetContext.rxjs.of(null);\r\n        }\r\n      }));\r\n    }));\r\n  }\r\n  \r\n  function getRoleByName(roleName, type) {\r\n    var rolesPageLink = widgetContext.pageLink(10, 0, roleName);\r\n    return roleService.getRoles(rolesPageLink, type, { ignoreLoading: true }).pipe(\r\n      widgetContext.rxjs.map((data) => {\r\n        if (data.data.length) {\r\n          return data.data.find((role) => role.name === roleName);\r\n        } else {\r\n          return null;\r\n        }\r\n      })\r\n    );\r\n  }\r\n  \r\n  function getEntityGroupByName(groupName, groupType) {\r\n    var entityGroupsPageLink = widgetContext.pageLink(10, 0, groupName);\r\n    return entityGroupService.getEntityGroupsByPageLink(entityGroupsPageLink, groupType, { ignoreLoading: true }).pipe(\r\n      widgetContext.rxjs.map((data) => {\r\n        if (data.data.length) {\r\n          return data.data.find((group) => group.name === groupName);\r\n        } else {\r\n          return null;\r\n        }\r\n      })\r\n    );\r\n  }\r\n  \r\n  function saveAttributes(customer) {\r\n    const formValues = vm.addCompanyFormGroup.value;\r\n    let attributesArray = [\r\n      { key: 'address', value: getAddressValue(customer) },\r\n/*      { key: 'stripeKey', value: stripeKey },*/\r\n      { key: 'weatherAPIToken', value: '587f1474e94ea6b52e6ce6e99d13d75a' },\r\n      { key: 'cancelDeadline', value: formValues.cancelDeadline },\r\n      { key: 'paymentDeadline', value: formValues.paymentDeadline },\r\n      { key: 'shortName', value: formValues.shortName }\r\n    ];\r\n    return attributeService.saveEntityAttributes(customer.id, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n  \r\n  function getAddressValue(customer) {\r\n    var address = '';\r\n    if (customer.address) {\r\n      address += customer.address;\r\n    }\r\n    if (customer.address2) {\r\n      address += (address ? ', ' : '') + customer.address2;\r\n    }\r\n    if (customer.city) {\r\n      address += (address ? ', ' : '') + customer.city;\r\n    }\r\n    if (customer.state) {\r\n      address += (address ? ', ' : '') + customer.state;\r\n    }\r\n    if (customer.zip) {\r\n      address += (customer.state ? ' ' : (address ? ', ' : '')) + customer.zip;\r\n    }\r\n    if (customer.country) {\r\n      address += (address ? ', ' : '') + customer.country;\r\n    }\r\n    return address;\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "777ded27-e3b8-d901-ca42-3079a23f7a12",
        "typeFullFqn": "system.cards.entities_table"
      },
      "c2559a58-e82d-3250-7e35-f520ced0d916": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "203b0867-b867-ef98-1791-03046c133b7d",
              "dataKeys": [
                {
                  "name": "role",
                  "type": "attribute",
                  "label": "role",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.7805336660172157
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div style=\"width: 100%; height: 100%; padding: 0;\">\n   <tb-dashboard-state *ngIf=\"ctx.currentUser.authority === 'TENANT_ADMIN'\" [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"eco_administration\"></tb-dashboard-state>\n   <tb-dashboard-state *ngIf=\"ctx.currentUser.authority === 'CUSTOMER_USER'\" [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"customer_administration\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "// 29.01.2026 - Updated to use role attribute\nvar userRole = data[0] && data[0].role ? data[0].role : '';\n\nvar stateParams = ctx.stateController.getStateParams();\nstateParams[\"userRole\"] = userRole;\nctx.stateController.updateState(null, stateParams);\n\n// Determine state based on user role\nvar stateId = 'customer_administration'; // default\nif (userRole === 'ECO Administrator') {\n  stateId = 'eco_administration';\n} else if (userRole === 'Administrator') {\n  stateId = 'customer_administration';\n}\n\nreturn '<div style=\"width: 100%; height: 100%; padding: 0;\">' +\n  '<tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"' + stateId + '\"></tb-dashboard-state>' +\n'</div>';",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ""
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "useDashboardTimewindow": true,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "c2559a58-e82d-3250-7e35-f520ced0d916",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "0c7469aa-7b86-be27-5216-bc6cc702f8b1": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "entitiesTitle": "Gateways",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "Label",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 15,
            "defaultSortOrder": "Label",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Devices",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "60f60877-be45-311d-9ee7-25b68c466d89",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.08471582519880028
                },
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Name",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.46096251592014714
                },
                {
                  "name": "type",
                  "type": "entityField",
                  "label": "{i18n:custom.gateways.type}",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "useCellContentFunctionOnExport": false,
                    "cellContentFunction": "var type = value;\n\nvar typeSvg = getTypeSvg(type);\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\n\nreturn '<span>'+\n           '<img style=\"vertical-align: middle;\" class=\"mat-icon\" src=\"'+ typeSvgUrl +'\">' +\n           '<span style=\"vertical-align: middle; padding-left: 8px;\">'+ type +'</span>' +\n       '</span>';\n            \nfunction getTypeSvg(type) {\n    var typeSvg;\n    switch (type) {\n        case 'Smart Shelf':\n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M2.5 2C2.22386 2 2 2.22386 2 2.5V17.5C2 17.7761 2.22386 18 2.5 18C2.77614 18 3 17.7761 3 17.5V17H17V17.5C17 17.7761 17.2239 18 17.5 ' +\n                      '18C17.7761 18 18 17.7761 18 17.5V2.5C18 2.22386 17.7761 2 17.5 2C17.2239 2 17 2.22386 17 2.5V8H14C14.5523 8 15 7.55228 15 7V4C15 3.44772 14.5523 3 14 3H11C10.4477 3 10 3.44772 10 4V7C10 ' +\n                      '7.55228 10.4477 8 11 8H7C7.55228 8 8 7.55228 8 7V6C8 5.44772 7.55228 5 7 5H6C5.44772 5 5 5.44772 5 6V7C5 7.55228 5.44772 8 6 8H3V2.5C3 2.22386 2.77614 2 2.5 2ZM17 16V9H3V16H6C5.44772 16 ' +\n                      '5 15.5523 5 15V12C5 11.4477 5.44772 11 6 11H9C9.55228 11 10 11.4477 10 12V15C10 15.5523 9.55228 16 9 16H12C11.4477 16 11 15.5523 11 15V13C11 12.4477 11.4477 12 12 12H14C14.5523 12 15 ' +\n                      '12.4477 15 13V15C15 15.5523 14.5523 16 14 16H17Z\" fill=\"#212121\"/>';\n            break;\n        case 'Freezer':            \n            typeSvg = '<rect x=\"9\" y=\"2\" width=\"2\" height=\"16\" rx=\"1\" fill=\"#212121\"/>' +\n                      '<path d=\"M12.5 3.5L10 6L7.5 3.5M12.5 16.5L10 14L7.5 16.5\" stroke=\"#212121\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>' +\n                      '<path d=\"M16.8792 8.91509L13.4641 8.00002L14.3792 4.58496M5.62082 15.4151L6.53588 12L3.12082 11.085\" stroke=\"#212121\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>' +\n                      '<path d=\"M5.62085 4.58491L6.53591 7.99998L3.12085 8.91504M16.8792 11.0849L13.4641 12L14.3792 15.415\" stroke=\"#212121\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>' +\n                      '<rect x=\"16.4282\" y=\"5.13379\" width=\"2\" height=\"16\" rx=\"1\" transform=\"rotate(60 16.4282 5.13379)\" fill=\"#212121\"/>' +\n                      '<rect x=\"2.57178\" y=\"6.86621\" width=\"2\" height=\"16\" rx=\"1\" transform=\"rotate(-60 2.57178 6.86621)\" fill=\"#212121\"/>';\n            break;\n        case 'Chiller':            \n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M13.0001 7.49994C13.0001 8.53714 12.2661 9.2516 11.4454 9.64333C11.2807 9.72191 11.1185 9.75061 10.9657 9.73874C10.9881 9.82201 ' +\n                      '11.0001 9.90957 11.0001 9.99994C11.0001 10.0304 10.9988 10.0605 10.9961 10.0902C11.1511 10.0322 11.322 9.99993 11.5001 9.99993L12.5001 9.99994L13.5 9.99993C14.3285 9.99992 15.0003 ' +\n                      '10.6975 14.6435 11.4452C14.2517 12.2658 13.5373 12.9999 12.5001 12.9999C11.4629 12.9999 10.7484 12.2658 10.3567 11.4452C10.2781 11.2805 10.2494 11.1184 10.2613 10.9655C10.178 10.988 ' +\n                      '10.0905 10.9999 10.0001 10.9999C9.96965 10.9999 9.93949 10.9986 9.90971 10.9959C9.96779 11.1509 10 11.3218 10 11.5L10 12.4999L10 13.4999C10.0001 14.3284 9.30246 15.0002 8.55482 ' +\n                      '14.6433C7.73413 14.2516 7.00006 13.5371 7.00006 12.4999C7.00006 11.4627 7.73413 10.7483 8.55482 10.3566C8.71948 10.278 8.8817 10.2493 9.03459 10.2611C9.01212 10.1779 9.00013 10.0903 ' +\n                      '9.00013 9.99994C9.00013 9.9695 9.00149 9.93938 9.00416 9.90963C8.84921 9.96766 8.67837 9.9999 8.50029 9.99989L7.50031 9.99988L6.50033 9.99989C5.67189 9.9999 5.00006 9.3023 5.35692 ' +\n                      '8.55467C5.74865 7.73397 6.46311 6.99991 7.50031 6.99991C8.5375 6.99991 9.25197 7.73397 9.6437 8.55467C9.72227 8.71929 9.75098 8.88149 9.73911 9.03435C9.82232 9.01191 9.90983 8.99994 ' +\n                      '10.0001 8.99994C10.0306 8.99994 10.0607 9.0013 10.0905 9.00397C10.0324 8.84898 10.0002 8.67807 10.0002 8.49992L10.0002 7.49994L10.0002 6.49996C10.0001 5.67153 10.6977 4.99969 11.4454 ' +\n                      '5.35655C12.2661 5.74828 13.0001 6.46274 13.0001 7.49994Z\" fill=\"#212121\"/>' +\n                      '<circle cx=\"10\" cy=\"10\" r=\"8\" stroke=\"#212121\" stroke-width=\"2\"/>';\n            break;                      \n        case 'Smart Bin':\n            typeSvg = '<path d=\"M6.71849 14C5.15241 14 4.19394 12.2816 5.01686 10.9491L5.09816 10.8175C5.17797 10.8327 5.26094 10.8383 5.34575 10.8332C5.89704 10.8001 6.31713 10.3264 6.28404 9.77509L6.21705 8.65906C6.19838 8.34795 6.03571 8.06333 5.77714 7.88933C5.51856 7.71533 5.19363 7.67184 4.8984 7.77171L3.93237 8.09851C3.40921 8.27549 3.12858 8.84306 3.30556 9.36622C3.34237 9.47504 3.39608 9.57337 3.46278 9.65927L3.31523 9.89818C1.66939 12.5631 3.58633 16 6.71849 16H7.83485C8.38714 16 8.83485 15.5523 8.83485 15C8.83485 14.4478 8.38714 14 7.83485 14L6.71849 14Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M13.3135 13.8409C14.8789 13.8873 15.8879 12.198 15.1048 10.8418L14.5467 9.87495C14.2705 9.39666 14.4344 8.78507 14.9127 8.50893C15.391 8.23279 16.0026 8.39666 16.2787 8.87495L16.8369 9.84175C18.403 12.5543 16.3849 15.9329 13.2542 15.84L12.9735 15.8317C12.9324 15.9324 12.8741 16.0281 12.7983 16.1143C12.4337 16.5292 11.8019 16.5699 11.387 16.2054L10.621 15.5322C10.3869 15.3264 10.2621 15.0233 10.2835 14.7123C10.3049 14.4014 10.47 14.1182 10.7301 13.9465L11.6632 13.3305C12.124 13.0262 12.7444 13.1531 13.0487 13.614C13.0955 13.6849 13.1321 13.7596 13.1588 13.8363L13.3135 13.8409Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M11.6696 5.21002C10.9272 3.83113 8.95968 3.80195 8.17664 5.15821L7.61846 6.12501C7.34232 6.6033 6.73073 6.76718 6.25244 6.49104C5.77414 6.21489 5.61027 5.6033 5.88641 5.12501L6.44459 4.15821C8.01067 1.44568 11.9456 1.50404 13.4306 4.26183L13.5637 4.50907C13.6715 4.49425 13.7835 4.4969 13.8961 4.51943C14.4377 4.62774 14.7889 5.15457 14.6806 5.69613L14.4806 6.69613C14.4195 7.00175 14.2193 7.26139 13.9393 7.39833C13.6594 7.53526 13.3315 7.53382 13.0528 7.39444L12.0528 6.89444C11.5588 6.64745 11.3586 6.04678 11.6056 5.5528C11.6436 5.47681 11.6899 5.40777 11.743 5.34624L11.6696 5.21002Z\" fill=\"#212121\"/>';\n            break;          \n        case 'Door Sensor':\n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M14 4H6V16H14V4ZM8 12C8.55228 12 9 11.5523 9 11C9 10.4477 8.55228 10 8 10C7.44772 10 7 10.4477 7 11C7 11.5523 7.44772 12 8 12Z\" fill=\"#212121\"/>' +\n                      '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M16 17V3C16 2.44772 15.5523 2 15 2H5C4.44772 2 4 2.44772 4 3V17H3.5C3.22386 17 3 17.2239 3 17.5C3 17.7761 3.22386 18 3.5 18H16.5C16.7761 18 17 17.7761 17 17.5C17 17.2239 16.7761 17 16.5 17H16ZM15 3H5L5 17H15V3Z\" fill=\"#212121\"/>';\n            break;\n        case 'Liquid Level Sensor':\n            typeSvg = '<path d=\"M14.6363 0.453212C14.8228 0.210257 15.1772 0.210257 15.3637 0.453213C15.9404 1.2044 17 2.73057 17 3.80373C17 5.02723 16.1143 5.99982 15 5.99982C13.8857 5.99982 13 5.02723 13 3.80373C13 2.73057 14.0596 1.2044 14.6363 0.453212Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M8.3017 2.76073C8.67788 2.33798 9.32212 2.33798 9.6983 2.76073C11.2801 4.53832 15 9.0479 15 12.1437C15 15.4064 12.3427 18 9 18C5.65725 18 3 15.4064 3 12.1437C3 9.0479 6.71994 4.53832 8.3017 2.76073Z\" fill=\"#212121\"/>';\n            break;\n        case 'Motion Sensor':\n            typeSvg = '<path d=\"M2.5 5C2.22386 5 2 5.22386 2 5.5C2 5.77614 2.22386 6 2.5 6H4C4 6.55228 4.44772 7 5 7H15C15.5523 7 16 6.55228 16 6H17.5C17.7761 6 18 5.77614 18 5.5C18 5.22386 17.7761 5 17.5 5H2.5Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M12.0001 12C12.5524 12 13.0001 11.5523 13.0001 11C13.0001 10.4477 12.5524 10 12.0001 10C11.4478 10 11.0001 10.4477 11.0001 11C11.0001 11.5523 11.4478 12 12.0001 12Z\" fill=\"#212121\"/>' +\n                      '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M10.0001 16C14.0804 16 17.4472 12.9453 17.9384 8.99801C18.0066 8.44996 17.5524 8 17.0001 8H3.00009C2.4478 8 1.99353 8.44996 2.06173 8.99801C2.55295 12.9453 5.91978 16 10.0001 16ZM12.0001 13C13.1047 13 14.0001 12.1046 14.0001 11C14.0001 9.89543 13.1047 9 12.0001 9C10.8955 9 10.0001 9.89543 10.0001 11C10.0001 12.1046 10.8955 13 12.0001 13Z\" fill=\"#212121\"/>';\n            break;\n        case 'Occupancy Sensor':\n            typeSvg = '<path d=\"M7 3.5C7 4.32843 6.32843 5 5.5 5C4.67157 5 4 4.32843 4 3.5C4 2.67157 4.67157 2 5.5 2C6.32843 2 7 2.67157 7 3.5Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M3 12C2.44772 12 2 11.5523 2 11L2 7.88652C2 6.84462 2.84462 6 3.88652 6C3.90535 6 3.92403 6.00055 3.94255 6.00162C3.96157 6.00055 3.98072 6 4 6H7C7.01928 6 7.03843 6.00055 7.05745 6.00162C7.07597 6.00055 7.09465 6 7.11348 6C8.15538 6 9 6.84462 9 7.88652V11C9 11.5523 8.55229 12 8 12V17C8 17.5523 7.55228 18 7 18C6.44772 18 6 17.5523 6 17L6 14H5V17C5 17.5523 4.55228 18 4 18C3.44772 18 3 17.5523 3 17V12Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M16 18C15.4477 18 15 17.5523 15 17V14H14V17C14 17.5523 13.5523 18 13 18C12.4477 18 12 17.5523 12 17V14H10.7215C10.3724 14 10.1308 13.6513 10.2533 13.3244L12.4733 7.40449C12.7901 6.55968 13.5977 6 14.5 6C15.4023 6 16.2099 6.55968 16.5267 7.40449L18.7467 13.3244C18.8692 13.6513 18.6276 14 18.2785 14H17V17C17 17.5523 16.5523 18 16 18Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M14.5 5C15.3284 5 16 4.32843 16 3.5C16 2.67157 15.3284 2 14.5 2C13.6716 2 13 2.67157 13 3.5C13 4.32843 13.6716 5 14.5 5Z\" fill=\"#212121\"/>';\n            break;\n        case 'Smoke Sensor':\n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M9.64491 2.08319C9.48444 1.9888 9.28482 1.99138 9.12685 2.08988C8.96887 2.18839 8.87871 2.3665 8.89285 2.55213C8.98169 3.71876 8.78795 4.5943 8.45363 5.30483C8.11607 6.02225 7.62209 6.60008 7.06387 7.157C6.88401 7.33644 6.69008 7.52013 6.49214 7.70763C6.10197 8.07721 5.69618 8.46158 5.35189 8.85718C4.81113 9.47853 4.35082 10.1982 4.15741 11.131C3.35478 15.0023 6.43952 18.1649 10.361 17.9822C10.41 17.9806 10.4592 17.9779 10.5088 17.9741L10.55 17.9708L10.5673 17.9695C10.6635 17.9622 10.7585 17.9532 10.8523 17.9427C10.897 17.9427 10.9422 17.9409 10.9878 17.9375C11.1369 17.9261 11.2735 17.9002 11.3976 17.8614C12.9028 17.5787 14.0571 16.8581 14.836 15.8302C15.7453 14.6303 16.1036 13.0646 15.9781 11.4151C15.7275 8.1215 13.5473 4.37866 9.64491 2.08319ZM12.1372 15.5326C12.1487 15.5269 12.1601 15.521 12.1714 15.5152C12.2227 15.2706 12.2393 15.0003 12.2172 14.7101C12.1353 13.6344 11.5243 12.3752 10.3912 11.4298C10.3443 11.6743 10.2711 11.8979 10.1767 12.1045C9.97248 12.5515 9.68116 12.8915 9.40451 13.1748C9.2918 13.2902 9.1897 13.3891 9.09461 13.4812C8.93666 13.6341 8.79804 13.7684 8.66241 13.9284C8.46694 14.1591 8.33595 14.3839 8.28119 14.6575C8.20904 15.018 8.23357 15.3634 8.33595 15.6725C8.69526 15.8186 9.08844 15.9185 9.50948 15.9633C9.62655 15.764 9.79981 15.6036 9.97777 15.4389C10.3505 15.0938 10.7439 14.7297 10.6844 13.949C11.3929 14.3558 11.8813 14.938 12.1372 15.5326ZM13.2143 14.6343L13.2159 14.6563L13.2421 14.6222C13.7907 13.8983 14.0816 12.8503 13.9839 11.5668C13.8301 9.5445 12.7138 7.15459 10.6097 5.25541C10.5143 5.57021 10.3981 5.86993 10.2634 6.15628C9.78098 7.18157 9.09869 7.9521 8.47652 8.57282C8.20885 8.83986 7.97694 9.05847 7.76612 9.25719C7.43058 9.57348 7.14846 9.83941 6.86065 10.1701C6.45742 10.6334 6.21678 11.0502 6.11585 11.537C5.83546 12.8894 6.29313 14.1616 7.23945 14.9971C7.24423 14.8222 7.26422 14.6432 7.30064 14.4613C7.39921 13.9687 7.63564 13.5933 7.89951 13.2819C8.06367 13.0882 8.26661 12.8908 8.44919 12.7131C8.53584 12.6288 8.61792 12.549 8.68907 12.4761C8.93347 12.2258 9.13295 11.9826 9.26713 11.689C9.39844 11.4016 9.47964 11.0379 9.44124 10.5337C9.42702 10.347 9.51835 10.168 9.67788 10.0698C9.83741 9.97174 10.0384 9.97101 10.1986 10.068C12.0451 11.1851 13.0906 13.0082 13.2143 14.6343Z\" fill=\"#212121\"/>';\n            break;\n        default:\n            typeSvg = '<circle cx=\"10\" cy=\"10\" r=\"10\" fill=\"#AAAAAA\"/>';\n    }\n    \n    return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' + \n           typeSvg +\n           '</svg>';\n} \n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.8077097060074172,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "state",
                  "type": "attribute",
                  "label": "{i18n:custom.gateways.state}",
                  "color": "#ffc107",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "cellContentFunction": "var state = value;\nvar active = entity.active;\nif (active === 'false') {\n    state = 'disconnected';\n}\n\nvar stateSvg = getStateSvg(state);\nvar encodedStateSvg = encodeURIComponent(stateSvg);\nvar stateSvgUrl = 'data:image/svg+xml,' + encodedStateSvg;\nvar stateLabel = getStateLabel(state);\n\nreturn '<span>'+\n           '<img style=\"vertical-align: middle;\" class=\"mat-icon\" src=\"'+ stateSvgUrl +'\">' +\n           '<span style=\"vertical-align: middle; padding-left: 8px;\">'+ stateLabel +'</span>' +\n       '</span>';\n            \nfunction getStateSvg(state) {\n    switch (state) {\n        case 'critical':\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#E64A19\"/>' +\n                   '</svg>';\n        case 'major':            \n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#D5C21B\"/>' +\n                   '</svg>';\n        case 'normal':            \n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#1F8B4D\"/>' +\n                   '</svg>';\n        case 'disconnected':\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<g clip-path=\"url(#clip0_2839_52564)\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#CAC1D2\"/>' +\n                   '<path d=\"M1.92896 16.728L16.0711 2.58589L17.4853 4.00011L3.34317 18.1422L1.92896 16.728Z\" fill=\"#CAC1D2\"/>' +\n                   '<path d=\"M2.10692 16.3171C1.81393 16.0241 1.81393 15.5491 2.10692 15.2561L15.1852 2.17788C15.4781 1.88489 15.9532 1.88489 16.2462 2.17788C16.5392 2.47088 16.5392 2.94591 16.2462 3.2389L3.16794 16.3171C2.87495 16.6101 2.39991 16.6101 2.10692 16.3171Z\" fill=\"white\"/>' +\n                   '</g>' +\n                   '<defs>' +\n                   '<clipPath id=\"clip0_2839_52564\">' +\n                   '<rect width=\"20\" height=\"20\" fill=\"white\"/>' +\n                   '</clipPath>' +\n                   '</defs>' +\n                   '</svg>';\n        default:\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#AAAAAA\"/>' +\n                   '</svg>';\n    }\n}\n\nfunction getStateLabel(state) {\n    switch(state) {\n        case 'critical':\n            return 'Critical';\n        case 'major':\n            return 'Major';\n        case 'normal':\n            return 'Normal';\n        case 'disconnected':\n            return 'Disconnected';\n        default:\n            return state;\n    }\n}\n"
                  },
                  "_hash": 0.2718881518921066,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "active",
                  "type": "attribute",
                  "label": "{i18n:custom.gateways.active}",
                  "color": "#607d8b",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "hidden",
                    "columnSelectionToDisplay": "disabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.04680501891139488,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "project",
                  "type": "attribute",
                  "label": "{i18n:custom.gateways.project}",
                  "color": "#8bc34a",
                  "settings": {},
                  "_hash": 0.8763152471849911,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "measurement",
                  "type": "attribute",
                  "label": "{i18n:custom.gateways.measurement}",
                  "color": "#3f51b5",
                  "settings": {},
                  "_hash": 0.35624237678584225,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "div.tb-widget .tb-widget-title {\n    max-height: 100px !important;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "rowClick": [],
            "headerButton": [
              {
                "name": "{i18n:custom.gateways.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n/*params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten*/\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7d1a4c6c-81a8-efc8-e7aa-46a5d330d301"
              },
              {
                "name": "{i18n:custom.gateways.add-gateway}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form\r\n  #editEntityForm=\"ngForm\"\r\n  [formGroup]=\"editEntityFormGroup\"\r\n  (ngSubmit)=\"save()\"\r\n  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width:600px;\"\r\n>\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.gateways.add-gateway' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar\r\n    color=\"warn\"\r\n    mode=\"indeterminate\"\r\n    *ngIf=\"isLoading$ | async\"\r\n  ></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <mat-stepper\r\n      *ngIf=\"editEntityFormGroup\"\r\n      #stepper\r\n      [linear]=\"true\"\r\n      animationDuration=\"500ms\"\r\n      style=\"flex-grow: 1;\"\r\n    >\r\n      <!-- Step 1: Gateway details -->\r\n      <mat-step [stepControl]=\"editEntityFormGroup.get('general')\">\r\n        <ng-template matStepLabel>{{ 'custom.gateways.add-gateway-gateway-details' | translate }}</ng-template>\r\n\r\n        <div\r\n          class=\"flex flex-col justify-start items-stretch flex-grow\"\r\n          [formGroup]=\"editEntityFormGroup.get('general')\"\r\n        >\r\n          <!-- Device Type -->\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>{{ 'custom.gateways.add-gateway-device-type' | translate }}</mat-label>\r\n            <mat-select\r\n              formControlName=\"type\"\r\n              placeholder=\"Select Type\"\r\n              (selectionChange)=\"onDeviceTypeChange()\"\r\n            >\r\n              <mat-option value=\"RESI\">RESI</mat-option>\r\n              <mat-option value=\"Gateway\">LoRaWAN Gateway</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n\r\n          <!-- Non-Gateway fields -->\r\n          <div *ngIf=\"editEntityFormGroup.get('general').get('type').value !== 'Gateway'\">\r\n            <!--<div class=\"flex flex-col gap-0 sm:flex-row sm:gap-2\">-->\r\n             <div class=\"flex w-full gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Name</mat-label>\r\n                <input matInput formControlName=\"entityName\" required />\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('general').get('entityName').hasError('required')\">\r\n                  {{ 'custom.gateways.add-gateway-entity-name-required' | translate }}\r\n                </mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Label</mat-label>\r\n                <input matInput formControlName=\"entityLabel\" />\r\n              </mat-form-field>\r\n            </div>\r\n            <div formGroupName=\"attributes\" class=\"flex flex-col\">\r\n               <div class=\"flex w-full gap-2\">\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>{{ 'custom.gateways.add-gateway-display-name' | translate }}</mat-label>\r\n                  <input matInput formControlName=\"displayName\" />\r\n                </mat-form-field>\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>{{ 'custom.gateways.add-gateway-customer' | translate }}</mat-label>\r\n                  <input matInput formControlName=\"customer\" required readonly />\r\n                </mat-form-field>\r\n              </div>\r\n              <div class=\"flex flex-col gap-0 sm:flex-row sm:gap-2\">\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>{{ 'custom.gateways.add-gateway-serial-number' | translate }}</mat-label>\r\n                  <input matInput formControlName=\"serialNumber\" required />\r\n                </mat-form-field>\r\n              </div>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.gateways.add-gateway-inactivity-timeout' | translate }}</mat-label>\r\n                <input type=\"number\" matInput formControlName=\"inactivityTimeout\" required />\r\n              </mat-form-field>\r\n            </div>\r\n          </div>\r\n\r\n          <!-- Gateway-specific fields -->\r\n          <div *ngIf=\"editEntityFormGroup.get('general').get('type').value === 'Gateway'\">\r\n            <div class=\"flex w-full gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Name</mat-label>\r\n                <input matInput formControlName=\"entityName\" required />\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('general').get('entityName').hasError('required')\">\r\n                  {{ 'custom-gateways-add-gateway-entity-name-required' | translate }}\r\n                </mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Label</mat-label>\r\n                <input matInput formControlName=\"entityLabel\" />\r\n              </mat-form-field>\r\n            </div>\r\n            <div formGroupName=\"attributes\" fxLayout=\"column\">\r\n               <div class=\"flex w-full gap-2\">\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>{{ 'custom.gateways.add-gateway-display-name' | translate }}</mat-label>\r\n                  <input matInput formControlName=\"displayName\" />\r\n                </mat-form-field>\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>{{ 'custom.gateways.add-gateway-customer' | translate }}</mat-label>\r\n                  <input matInput formControlName=\"customer\" required readonly />\r\n                </mat-form-field>\r\n              </div>\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>Gateway ID</mat-label>\r\n                <input matInput formControlName=\"gatewayID\" required pattern=\"[a-zA-Z0-9]{16}\" />\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>{{ 'custom.gateways.add-gateway-inactivity-timeout' | translate }}</mat-label>\r\n                <input type=\"number\" matInput formControlName=\"inactivityTimeout\" required />\r\n              </mat-form-field>\r\n            </div>\r\n          </div>\r\n\r\n          <!-- Further Actions -->\r\n          <fieldset class=\"fieldset\" style=\"margin-bottom: 15px;\">\r\n            <legend>{{ 'custom.gateways.add-gateway-select-further-actions' | translate }}\r\n            </legend>\r\n            <div\r\n              style=\"display: flex; flex-direction: column; align-items: flex-start; margin-top: 5px; margin-bottom: 15px;\"\r\n            >\r\n              <div\r\n                class=\"flex justify-between items-center flex-auto w-full h-full\"\r\n                style=\"margin-top: 5px; margin-bottom: 15px;\"\r\n              >\r\n                <mat-checkbox\r\n                  formControlName=\"createKit\"\r\n                  (change)=\"onCreateKitChange($event)\"\r\n                  style=\"flex: 0 0 50%;\"\r\n                >\r\n                  {{ 'custom.gateways.add-gateway-create-kit' | translate }}\r\n                </mat-checkbox>\r\n                <mat-checkbox\r\n                  *ngIf=\"editEntityFormGroup.get('general').get('createKit').value\"\r\n                  formControlName=\"addDevices\"\r\n                  (change)=\"onAddDevicesChange($event)\"\r\n                  style=\"flex: 0 0 50%;\"\r\n                >\r\n                  {{ 'custom.gateways.add-gateway-add-devices' | translate }}\r\n                </mat-checkbox>\r\n              </div>\r\n              <mat-form-field\r\n                class=\"flex-1 block\"\r\n                *ngIf=\"editEntityFormGroup.get('general').get('createKit').value\"\r\n                style=\"width: 100%;\"\r\n              >\r\n                <mat-label>{{ 'custom.gateways.add-gateway-new-kit' | translate }}</mat-label>\r\n                <input matInput formControlName=\"newKit\" required />\r\n              </mat-form-field>\r\n              <mat-checkbox formControlName=\"activateSIM\" style=\"width:auto;\">{{ 'custom.gateways.add-gateway-activate-sim' | translate }}</mat-checkbox>\r\n              <div\r\n                *ngIf=\"editEntityFormGroup.get('general').get('activateSIM').value\"\r\n                formGroupName=\"connectivity\" class=\"w-full\"\r\n              >\r\n                <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                  <mat-label>ICCID</mat-label>\r\n                  <input matInput formControlName=\"ICCID\" required />\r\n                  <mat-error\r\n                    *ngIf=\"\r\n                      editEntityFormGroup.get('general').get('connectivity').get('ICCID').hasError(\r\n                        'required'\r\n                      )\r\n                    \"\r\n                  >\r\n                    {{ 'custom-gateways-add-gateway-iccid-required' | translate }}\r\n                  </mat-error>\r\n                </mat-form-field>\r\n                <div class=\"flex w-full gap-2\">\r\n                  <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                    <mat-label>Carrier</mat-label>\r\n                    <mat-select formControlName=\"carrierSIM\" placeholder=\"Select Carrier\" required>\r\n                      <mat-option value=\"tech+\">wherever SIM tech+</mat-option>\r\n                      <mat-option value=\"link+\">wherever SIM link+</mat-option>\r\n                    </mat-select>\r\n                    <mat-error\r\n                      *ngIf=\"\r\n                        editEntityFormGroup.get('general').get('connectivity').get('carrierSIM').hasError(\r\n                          'required'\r\n                        )\r\n                      \"\r\n                    >\r\n                      {{ 'custom-gateways-add-gateway-carrier-required' | translate }}\r\n                    </mat-error>\r\n                  </mat-form-field>\r\n                  <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                    <mat-label>SIM Status</mat-label>\r\n                    <mat-select formControlName=\"statusSIM\" placeholder=\"Select SIM-Status\" required>\r\n                      <mat-option value=\"2\">{{ 'custom.gateways.add-gateway-activate' | translate }}</mat-option>\r\n                      <mat-option value=\"5\">{{ 'custom.gateways.add-gateway-deactivate' | translate }}</mat-option>\r\n                    </mat-select>\r\n                    <mat-error\r\n                      *ngIf=\"\r\n                        editEntityFormGroup.get('general').get('connectivity').get('statusSIM').hasError(\r\n                          'required'\r\n                        )\r\n                      \"\r\n                    >\r\n                      {{ 'custom-gateways-add-gateway-status-required' | translate }}\r\n                    </mat-error>\r\n                  </mat-form-field>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </fieldset>\r\n        </div>\r\n\r\n        <!-- Step 1 Footer -->\r\n        <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n          <button\r\n            mat-button\r\n            color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\"\r\n            cdkFocusInitial\r\n          >\r\n            {{ 'action.cancel' | translate }}\r\n          </button>\r\n          <button\r\n            mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            matStepperNext\r\n            type=\"button\"\r\n            *ngIf=\"\r\n              editEntityFormGroup.get('general').get('type').value !== 'Gateway' ||\r\n              editEntityFormGroup.get('general').get('addDevices').value === true\r\n            \"\r\n            [disabled]=\"\r\n              (isLoading$ | async) ||\r\n              editEntityFormGroup.get('general').invalid ||\r\n              !editEntityFormGroup.get('general').dirty\r\n            \"\r\n          >\r\n            {{ 'custom.gateways.edit-gateway-next' | translate }}\r\n          </button>\r\n          <button\r\n            mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            type=\"submit\"\r\n            *ngIf=\"\r\n              editEntityFormGroup.get('general').get('type').value === 'Gateway' &&\r\n              editEntityFormGroup.get('general').get('addDevices').value === false\r\n            \"\r\n            [disabled]=\"\r\n              (isLoading$ | async) ||\r\n              editEntityFormGroup.invalid ||\r\n              !editEntityFormGroup.dirty\r\n            \"\r\n          >\r\n            {{ 'custom.gateways.add-gateway-create' | translate }}\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <!-- Step 2: Credentials -->\r\n      <mat-step\r\n        [stepControl]=\"editEntityFormGroup.get('credentials')\"\r\n        *ngIf=\"editEntityFormGroup.get('general').get('type').value !== 'Gateway'\"\r\n      >\r\n        <ng-template matStepLabel>Credentials</ng-template>\r\n        <div\r\n          class=\"flex flex-col justify-start items-stretch\"\r\n          style=\"margin-top: 30px;\"\r\n          [formGroup]=\"editEntityFormGroup.get('credentials')\"\r\n        >\r\n          <mat-form-field class=\"w-full\">\r\n            <mat-label>{{ 'custom.gateways.add-gateway-credentials-type' | translate }}</mat-label>\r\n            <input matInput formControlName=\"credentialsType\" readonly />\r\n          </mat-form-field>\r\n          <mat-form-field class=\"w-full\">\r\n            <mat-label>Client ID</mat-label>\r\n            <input matInput formControlName=\"clientId\" required />\r\n            <button\r\n              mat-icon-button\r\n              type=\"button\"\r\n              matSuffix\r\n              matTooltip=\"{{ 'custom.gateways.edit-gateway-copy-client-id' | translate }}\"\r\n              (click)=\"copyToClipboard($event, 'credentials.clientId')\"\r\n            >\r\n              <mat-icon>content_copy</mat-icon>\r\n            </button>\r\n            <mat-error\r\n              *ngIf=\"editEntityFormGroup.get('credentials').get('clientId').hasError('required')\"\r\n            >\r\n              {{ 'custom-gateways-add-gateway-client-id-required' | translate }}\r\n            </mat-error>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"w-full\">\r\n            <mat-label>{{ 'custom-gateways-add-gateway-user-name' | translate }}</mat-label>\r\n            <input matInput formControlName=\"userName\" required />\r\n            <button\r\n              mat-icon-button\r\n              type=\"button\"\r\n              matSuffix\r\n              matTooltip=\"{{ 'custom.gateways.edit-gateway-copy-user-name' | translate }}\"\r\n              (click)=\"copyToClipboard($event, 'credentials.userName')\"\r\n            >\r\n              <mat-icon>content_copy</mat-icon>\r\n            </button>\r\n            <mat-error\r\n              *ngIf=\"editEntityFormGroup.get('credentials').get('userName').hasError('required')\"\r\n            >\r\n              {{ 'custom-gateways-add-gateway-user-name-required' | translate }}\r\n            </mat-error>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"w-full\">\r\n            <mat-label>{{ 'custom-gateways-add-gateway-password' | translate }}</mat-label>\r\n            <input\r\n              matInput\r\n              [type]=\"hidePassword ? 'password' : 'text'\"\r\n              formControlName=\"password\"\r\n              required\r\n            />\r\n            <button\r\n              mat-icon-button\r\n              type=\"button\"\r\n              matSuffix\r\n              matTooltip=\"{{ hidePassword ? ('custom.gateways.edit-gateway-show-password' | translate) : 'Hide Password' }}\"\r\n              (click)=\"togglePasswordVisibility()\"\r\n            >\r\n              <mat-icon>{{ hidePassword ? 'visibility' : 'visibility_off' }}</mat-icon>\r\n            </button>\r\n            <button\r\n              mat-icon-button\r\n              type=\"button\"\r\n              matSuffix\r\n              matTooltip=\"{{'custom.gateways.edit-gateway-copy-password' | translate}}\"\r\n              (click)=\"copyToClipboard($event, 'credentials.password')\"\r\n            >\r\n              <mat-icon>content_copy</mat-icon>\r\n            </button>\r\n            <mat-error\r\n              *ngIf=\"editEntityFormGroup.get('credentials').get('password').hasError('required')\"\r\n            >\r\n              {{ 'custom-gateways-add-gateway-password-required' | translate }}\r\n            </mat-error>\r\n          </mat-form-field>\r\n        </div>\r\n        <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n          <button\r\n            mat-button\r\n            color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\"\r\n            cdkFocusInitial\r\n          >\r\n            {{ 'action.cancel' | translate }}\r\n          </button>\r\n          <button\r\n            mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            matStepperNext\r\n            type=\"button\"\r\n            *ngIf=\"editEntityFormGroup.get('general').get('addDevices').value === true\"\r\n          >\r\n            {{ 'custom.gateways.edit-gateway-next' | translate }}\r\n          </button>\r\n          <button\r\n            mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            type=\"submit\"\r\n            *ngIf=\"editEntityFormGroup.get('general').get('addDevices').value === false\"\r\n            [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid || !editEntityFormGroup.dirty\"\r\n          >\r\n            {{ 'custom.gateways.add-gateway-create' | translate }}\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <!-- Step 3: Devices -->\r\n      <mat-step label=\"Devices\" *ngIf=\"showDevicesStep\">\r\n        <ng-template matStepLabel>{{ 'custom.gateways.add-gateway-devices' | translate }}</ng-template>\r\n        <div\r\n          class=\"flex flex-col justify-start items-stretch\"\r\n          style=\"margin-top: 5px;\"\r\n          [formGroup]=\"editEntityFormGroup.get('devices')\"\r\n        >\r\n          <div style=\"padding-top: 10px;\">\r\n            <mat-tab-group (selectedIndexChange)=\"onTabChange($event)\">\r\n              <!-- Create Tab -->\r\n              <mat-tab label=\"{{'action.create' | translate}}\">\r\n                <ng-template matTabContent>\r\n                  <div style=\"margin-top: 10px;\">\r\n                    <div class=\"flex gap-2\" style=\"margin-bottom: 10px;\">\r\n                      <button\r\n                        mat-stroked-button\r\n                        type=\"button\"\r\n                        style=\"flex: 1; background-color: #f0f0f0; color: black;\"\r\n                        (click)=\"addPflow()\"\r\n                        *ngIf=\"editEntityFormGroup.get('general')?.get('type')?.value === 'RESI'\"\r\n                      >\r\n                        {{ 'custom-gateways-add-gateway-add-p-flow' | translate }}\r\n                      </button>\r\n                      <button\r\n                        mat-stroked-button\r\n                        type=\"button\"\r\n                        style=\"flex: 1; background-color: #f0f0f0; color: black;\"\r\n                        (click)=\"addSensor()\"\r\n                      >\r\n                        {{ 'custom.gateways.add-gateway-add-sensor' | translate }}\r\n                      </button>\r\n                    </div>\r\n\r\n                    <!-- P-Flow Devices -->\r\n                    <div formArrayName=\"pflowDevices\">\r\n                      <div\r\n                        *ngFor=\"\r\n                          let pflowGroup of editEntityFormGroup.get('devices').get('pflowDevices')\r\n                            .controls;\r\n                          let i = index\r\n                        \"\r\n                        [formGroupName]=\"i\"\r\n                        class=\"flex justify-start items-center gap-2\"\r\n                      >\r\n                        <div class=\"flex-1\">\r\n                          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                            <mat-label>P-Flow {{ i + 1 }}</mat-label>\r\n                            <input matInput formControlName=\"name\" required readonly />\r\n                          </mat-form-field>\r\n                        </div>\r\n                        <button mat-icon-button type=\"button\" (click)=\"removePflow(i)\" *ngIf=\"canRemovePflow(i)\">\r\n                          <mat-icon>delete</mat-icon>\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <!-- Sensor Devices -->\r\n                    <div formArrayName=\"sensorDevices\">\r\n                      <div\r\n                        *ngFor=\"\r\n                          let sensorGroup of editEntityFormGroup.get('devices').get('sensorDevices')\r\n                            .controls;\r\n                          let i = index\r\n                        \"\r\n                        [formGroupName]=\"i\"\r\n                        class=\"flex flex-col gap-2\"\r\n                      >\r\n                        <div class=\"flex justify-start items-center gap-2\">\r\n                          <div class=\"flex-none w-[65%]\">\r\n                            <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                              <mat-label>Sensor {{ i + 1 }}</mat-label>\r\n                              <input matInput formControlName=\"name\" required readonly />\r\n                            </mat-form-field>\r\n                          </div>\r\n                          <div class=\"flex-none w-[35%]\">\r\n                            <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                              <mat-label>{{ 'custom.gateways.add-gateway-sensor-type' | translate }}</mat-label>\r\n                              <mat-select\r\n                                formControlName=\"type\"\r\n                                required\r\n                                (selectionChange)=\"onSensorTypeChange(i)\"\r\n                              >\r\n                                <mat-option\r\n                                  *ngIf=\"\r\n                                    editEntityFormGroup.get('general')?.get('type')?.value ===\r\n                                    'RESI'\r\n                                  \"\r\n                                  value=\"Temperature Sensor\"\r\n                                >\r\n                                  {{ 'custom-gateways-add-gateway-temperature' | translate }}\r\n                                </mat-option>\r\n                                <mat-option\r\n                                  *ngIf=\"\r\n                                    editEntityFormGroup.get('general')?.get('type')?.value !==\r\n                                    'RESI'\r\n                                  \"\r\n                                  value=\"Room Sensor CO2\"\r\n                                >\r\n                                  CO2\r\n                                </mat-option>\r\n                              </mat-select>\r\n                            </mat-form-field>\r\n                          </div>\r\n                          <button\r\n                            mat-icon-button\r\n                            type=\"button\"\r\n                            (click)=\"removeSensor(i)\"\r\n                            *ngIf=\"canRemoveSensor(i)\"\r\n                          >\r\n                            <mat-icon>delete</mat-icon>\r\n                          </button>\r\n                        </div>\r\n                        <div\r\n                          *ngIf=\"sensorGroup.get('devEUI')\"\r\n                          class=\"flex gap-2 justify-start items-center\"\r\n                        >\r\n                          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                            <mat-label>devEUI</mat-label>\r\n                            <input\r\n                              matInput\r\n                              formControlName=\"devEUI\"\r\n                              required\r\n                              pattern=\"[a-zA-Z0-9]{16}\"\r\n                            />\r\n                            <mat-error *ngIf=\"sensorGroup.get('devEUI').hasError('required')\">\r\n                              {{ 'custom-gateways-add-gateway-dev-eui-required' | translate }}\r\n                            </mat-error>\r\n                            <mat-error *ngIf=\"sensorGroup.get('devEUI').hasError('pattern')\">\r\n                              {{ 'custom-gateways-add-gateway-dev-eui-format' | translate }}\r\n                            </mat-error>\r\n                          </mat-form-field>\r\n                          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                            <mat-label>appKey</mat-label>\r\n                            <input\r\n                              matInput\r\n                              formControlName=\"appKey\"\r\n                              required\r\n                              pattern=\"[a-zA-Z0-9]{32}\"\r\n                            />\r\n                            <mat-error *ngIf=\"sensorGroup.get('appKey').hasError('required')\">\r\n                              {{ 'custom-gateways-add-gateway-appkey-required' | translate }}\r\n                            </mat-error>\r\n                            <mat-error *ngIf=\"sensorGroup.get('appKey').hasError('pattern')\">\r\n                              {{ 'custom-gateways-add-gateway-appkey-format' | translate }}\r\n                            </mat-error>\r\n                          </mat-form-field>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </ng-template>\r\n              </mat-tab>\r\n\r\n              <!-- Assign Tab -->\r\n              <mat-tab label=\"{{'action.assign' | translate}}\">\r\n                <ng-template matTabContent>\r\n                  <div style=\"margin-top: 10px;\" [formGroup]=\"editEntityFormGroup.get('devices').get('assignmentStep')\">\r\n                    <div class=\"flex gap-2\" style=\"margin-bottom: 10px;\">\r\n                      <button\r\n                        mat-stroked-button\r\n                        type=\"button\"\r\n                        style=\"width: 100%; margin-bottom: 8px; background-color: #f0f0f0; color: black;\"\r\n                        (click)=\"addAssignDevice()\"\r\n                        *ngIf=\"editEntityFormGroup.get('general')?.get('type')?.value === 'RESI'\"\r\n                      >\r\n                        {{ 'custom-gateways-add-gateway-add-p-flow' | translate }}\r\n                      </button>\r\n                      <button\r\n                        mat-stroked-button\r\n                        type=\"button\"\r\n                        style=\"width: 100%; margin-bottom: 16px; background-color: #f0f0f0; color: black;\"\r\n                        (click)=\"addAssignSensor()\"\r\n                      >\r\n                        {{ 'custom.gateways.add-gateway-add-sensor' | translate }}\r\n                      </button>\r\n                    </div>\r\n\r\n                    <div formArrayName=\"devices\" *ngIf=\"editEntityFormGroup.get('general')?.get('type')?.value === 'RESI'\">\r\n                      <div\r\n                        *ngFor=\"let deviceGroup of editEntityFormGroup.get('devices').get('assignmentStep').get('devices').controls; let i = index\"\r\n                        [formGroupName]=\"i\"\r\n                        class=\"flex justify-start items-center gap-2\"\r\n                      >\r\n                        <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                          <mat-label>P-Flow {{ i + 1 }}</mat-label>\r\n                          <input\r\n                            type=\"text\"\r\n                            matInput\r\n                            formControlName=\"device\"\r\n                            [matAutocomplete]=\"auto\"\r\n                            (keyup)=\"filterAssignDevices(i)\"\r\n                            (focus)=\"resetAssignFilter(i)\"\r\n                            required\r\n                          />\r\n                          <mat-autocomplete #auto=\"matAutocomplete\" [displayWith]=\"displayDevice\">\r\n                            <mat-option *ngFor=\"let device of filteredAssignDevices[i]\" [value]=\"device\">\r\n                              <div class=\"device-item flex flex-col gap-1\">\r\n                                <div class=\"flex\">\r\n                                  <div>{{ device?.name }}</div>\r\n                                </div>\r\n                                <div class=\"flex justify-between items-center\">\r\n                                  <div class=\"device-type\">{{ device?.type }}</div>\r\n                                  <div class=\"device-name\">{{ device?.label }}</div>\r\n                                </div>\r\n                              </div>\r\n                              <mat-divider></mat-divider>\r\n                            </mat-option>\r\n                            <mat-option *ngIf=\"filteredAssignDevices[i].length === 0\" disabled>\r\n                              {{ 'custom-gateways-add-gateway-no-devices' | translate }}\r\n                            </mat-option>\r\n                          </mat-autocomplete>\r\n                          <mat-error *ngIf=\"deviceGroup.get('device')?.hasError('required')\">\r\n                            {{ 'custom-gateways-add-gateway-device-required' | translate }}\r\n                          </mat-error>\r\n                          <mat-error *ngIf=\"deviceGroup.get('device').hasError('invalidDevice')\">\r\n                            {{ 'custom-gateways-add-gateway-select-valid-device' | translate }}\r\n                          </mat-error>\r\n                        </mat-form-field>\r\n                        <button\r\n                          mat-icon-button\r\n                          type=\"button\"\r\n                          (click)=\"removeAssignDevice(i)\"\r\n                          *ngIf=\"canRemoveAssignDevice(i)\"\r\n                        >\r\n                          <mat-icon>delete</mat-icon>\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div formArrayName=\"sensors\">\r\n                      <div\r\n                        *ngFor=\"let sensorGroup of editEntityFormGroup.get('devices').get('assignmentStep').get('sensors').controls; let i = index\"\r\n                        [formGroupName]=\"i\"\r\n                        class=\"flex justify-start items-center gap-2\"\r\n                      >\r\n                        <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                          <mat-label>Sensor {{ i + 1 }}</mat-label>\r\n                          <input\r\n                            type=\"text\"\r\n                            matInput\r\n                            formControlName=\"device\"\r\n                            [matAutocomplete]=\"autoSensor\"\r\n                            (keyup)=\"filterAssignSensors(i)\"\r\n                            (focus)=\"resetAssignSensorFilter(i)\"\r\n                            required\r\n                          />\r\n                          <mat-autocomplete #autoSensor=\"matAutocomplete\" [displayWith]=\"displaySensor\">\r\n                            <mat-option *ngFor=\"let device of filteredAssignSensors[i]\" [value]=\"device\">\r\n                              <div class=\"device-item flex flex-col gap-1\">\r\n                                <div class=\"flex\">\r\n                                  <div>{{ device?.name }}</div>\r\n                                </div>\r\n                                <div class=\"flex justify-between items-center\">\r\n                                  <div class=\"device-type\">{{ device?.type }}</div>\r\n                                  <div class=\"device-name\">{{ device?.label }}</div>\r\n                                </div>\r\n                              </div>\r\n                              <mat-divider></mat-divider>\r\n                            </mat-option>\r\n                            <mat-option *ngIf=\"filteredAssignSensors[i].length === 0\" disabled>\r\n                              {{ 'custom-gateways-add-gateway-no-devices' | translate }}\r\n                            </mat-option>\r\n                          </mat-autocomplete>\r\n                          <mat-error *ngIf=\"sensorGroup.get('device')?.hasError('required')\">\r\n                            {{ 'custom-gateways-add-gateway-device-required' | translate }}\r\n                          </mat-error>\r\n                          <mat-error *ngIf=\"sensorGroup.get('device')?.hasError('invalidDevice')\">\r\n                            {{ 'custom-gateways-add-gateway-select-valid-device' | translate }}\r\n                          </mat-error>\r\n                        </mat-form-field>\r\n                        <button\r\n                          mat-icon-button\r\n                          type=\"button\"\r\n                          (click)=\"removeAssignSensor(i)\"\r\n                          *ngIf=\"canRemoveAssignSensor(i)\"\r\n                        >\r\n                          <mat-icon>delete</mat-icon>\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </ng-template>\r\n              </mat-tab>\r\n            </mat-tab-group>\r\n\r\n            <!-- Step 3 Footer -->\r\n            <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n              <button mat-button color=\"primary\" type=\"button\" [disabled]=\"isLoading$ | async\" (click)=\"cancel()\">\r\n                {{ 'action.cancel' | translate }}\r\n              </button>\r\n              <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid || !editEntityFormGroup.dirty\">\r\n                {{ 'custom.gateways.add-gateway-create' | translate }}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </mat-step>\r\n    </mat-stepper>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n.device-item {\n    line-height: 24px;\n    width: 100%;\n    padding-top: 8px;\n    padding-bottom: 8px;\n}\n\n.device-item .device-name {\n    font-size: 12px;\n    opacity: 0.7;\n}\n\n.device-item .device-type {\n    font-size: 14px;\n    opacity: 0.7;\n}\n\nmat-option {\n    height: auto !important;\n    white-space: normal !important;\n}\n\n.mat-select-value-text {\n    display: block;\n    width: 100%;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet diagnostickitsAll = [];\r\n// Fetch all customers, then fetch all their Diagnostickits\r\n//customerService.getCustomers(pageLink).subscribe(customers => {\r\n  //console.log(\"customers:\", customers);\r\n\r\n  // Track how many customer queries have completed\r\n  let processed = 0;\r\n  //const totalCustomers = customers.data.length;\r\n\r\n  /*customers.data.map(customer => {\r\n    // Build our query for this specific customer's ID\r\n    const assetSearchQuery = {\r\n      parameters: {\r\n        rootId: customer.id.id,       \r\n        rootType: 'CUSTOMER',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Diagnostickit']\r\n    };\r\n    assetService.findByQuery(assetSearchQuery).subscribe(diagnostickits => {\r\n      //console.log(\"diagnostickits of customer:\", customer.name, diagnostickits);    \r\n      // Merge these Diagnostickits into our master array\r\n      diagnostickitsAll.push(...diagnostickits);\r\n\r\n      // Increment the processed counter\r\n      processed++;\r\n      // If we've processed all customers, open the dialog\r\n      if (processed === totalCustomers) {\r\n        //console.log('All Diagnostickits across all customers:', diagnostickitsAll);\r\n        openAddEntityDialog();\r\n      }\r\n    });\r\n  });\r\n});*/\r\nopenAddEntityDialog();\r\nfunction openAddEntityDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddEntityDialogController).subscribe();\r\n}\r\n\r\nfunction getSelectedCustomerId() {\r\n  let stateParams = widgetContext.stateController.getStateParams();\r\n  return stateParams.entityId.id;\r\n}\r\n\r\nfunction getSelectedCustomerName() {\r\n  let stateParams = widgetContext.stateController.getStateParams();\r\n  try {\r\n    return stateParams.entityName;\r\n  } catch (error) {\r\n    return stateParams.entityName;\r\n  }\r\n}\r\n\r\nfunction generateRandomPassword() {\r\n  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';\r\n  let password = '';\r\n  for (let i = 0; i < 20; i++) {\r\n    password += chars.charAt(Math.floor(Math.random() * chars.length));\r\n  }\r\n  return password;\r\n}\r\n\r\nfunction AddEntityDialogController(instance) {\r\n  let vm = instance;\r\n  let customerID = widgetContext.stateController.getStateParams().entityId.id;\r\n  let customerName = widgetContext.stateController.getStateParams().entityName;\r\n  vm.allowedEntityTypes = ['ASSET', 'DEVICE', 'Gateway'];\r\n  vm.entitySearchDirection = {\r\n    from: 'FROM',\r\n    to: 'TO',\r\n  };\r\n    \r\n     function deviceSelectionValidator(control) {\r\n       if (!control.value) {\r\n            return null;\r\n       }\r\n       return (typeof control.value === 'object' && control.value !== null)\r\n         ? null\r\n         : { invalidDevice: true };\r\n    }\r\n    \r\n  vm.editEntityFormGroup = vm.fb.group({\r\n    general: vm.fb.group({\r\n      type: ['MUC', [vm.validators.required]],\r\n      entityName: [{ value: '' }, [vm.validators.required]],\r\n      entityLabel: [''],\r\n      createKit: [false],\r\n      addDevices: [false],\r\n      activateSIM: [false],\r\n      newKit: [''],\r\n      attributes: vm.fb.group({\r\n        isGateway: [true],\r\n        inactivityTimeout: ['60'],\r\n        street: [''],\r\n        displayName: [''],\r\n        city: [''],\r\n        plz: [''],\r\n        customer: [getSelectedCustomerName()],\r\n        gatewayID: [''],\r\n        serialNumber: ['']\r\n      }),\r\n      connectivity: vm.fb.group({\r\n        ICCID: [''],\r\n        statusSIM: [''],\r\n        carrierSIM: ['']\r\n      }),\r\n    }),\r\n    credentials: vm.fb.group({\r\n      credentialsType: ['MQTT_BASIC'],\r\n      clientId: ['', [vm.validators.required]],\r\n      userName: ['pke', [vm.validators.required]],\r\n      password: [generateRandomPassword(), [vm.validators.required]],\r\n    }),\r\n    devices: vm.fb.group({\r\n      pflowDevices: vm.fb.array([]),\r\n      sensorDevices: vm.fb.array([]),\r\n      assignmentStep: vm.fb.group({\r\n        devices: vm.fb.array([\r\n          vm.fb.group({\r\n            device: [null, [vm.validators.required]],\r\n          }),\r\n        ]),\r\n        sensors: vm.fb.array([]),\r\n      }),\r\n    }),\r\n  });\r\n\r\n  vm.selectedTabIndex = 0;\r\n  \r\n    // Call this when the user types in the input field.\r\n    // 'i' is the index of the assign device group.\r\n    vm.filterAssignDevices = function(i) {\r\n      // Get the current input value from the form control.\r\n      let inputValue = vm.editEntityFormGroup.get('devices')\r\n                          .get('assignmentStep')\r\n                          .get('devices')\r\n                          .at(i)\r\n                          .get('device').value;\r\n      \r\n      // If the value is not a string, fallback to an empty string.\r\n      let filterValue = (typeof inputValue === 'string' ? inputValue.toLowerCase() : '');\r\n      \r\n      if (!filterValue) {\r\n        vm.filteredAssignDevices[i] = vm.getAvailablePFlowDevices(i).slice();\r\n      } else {\r\n        vm.filteredAssignDevices[i] = vm.getAvailablePFlowDevices(i).filter(device =>\r\n          device.name.toLowerCase().includes(filterValue) ||\r\n          (device.label && device.label.toLowerCase().includes(filterValue)) ||\r\n          device.type.toLowerCase().includes(filterValue)\r\n        );\r\n      }\r\n    };\r\n    \r\n    // Reset the filtered devices when the field is focused:\r\n    vm.resetAssignFilter = function(i) {\r\n      vm.filteredAssignDevices[i] = vm.getAvailablePFlowDevices(i).slice();\r\n    };\r\n    \r\n    // A helper display function (as used in your inspiration code)\r\n    vm.displayDevice = function(device) {\r\n      return device ? `${device.name} (${device.type})` : '';\r\n    };\r\n    \r\n    vm.filterAssignSensors = function(i) {\r\n      // Get current input value from the sensor assign control.\r\n      let inputValue = vm.editEntityFormGroup.get('devices')\r\n                          .get('assignmentStep')\r\n                          .get('sensors')\r\n                          .at(i)\r\n                          .get('device').value;\r\n      \r\n      // If the input is an object, get its name property; otherwise use it directly.\r\n      let filterValue = '';\r\n      if (typeof inputValue === 'object' && inputValue !== null) {\r\n        filterValue = inputValue.name ? inputValue.name.toLowerCase() : '';\r\n      } else if (typeof inputValue === 'string') {\r\n        filterValue = inputValue.toLowerCase();\r\n      }\r\n      \r\n      if (!filterValue) {\r\n        vm.filteredAssignSensors[i] = vm.getAvailableSensorDevices(i).slice();\r\n      } else {\r\n        vm.filteredAssignSensors[i] = vm.getAvailableSensorDevices(i).filter(sensor =>\r\n          sensor.name.toLowerCase().includes(filterValue) ||\r\n          (sensor.label && sensor.label.toLowerCase().includes(filterValue)) ||\r\n          sensor.type.toLowerCase().includes(filterValue)\r\n        );\r\n      }\r\n    };\r\n\r\n    \r\n    // 2. Reset function for sensor assign field:\r\n    vm.resetAssignSensorFilter = function(i) {\r\n      vm.filteredAssignSensors[i] = vm.getAvailableSensorDevices(i).slice();\r\n    };\r\n    \r\n    // 3. Display function for sensor:\r\n    vm.displaySensor = function(sensor) {\r\n      return sensor ? `${sensor.name} (${sensor.type})` : '';\r\n    };\r\n\r\n  vm.addPflow = function () {\r\n      if(vm.editEntityFormGroup.get('general').get('type').value === 'RESI') {\r\n        const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n        const index = pflowDevicesArray.length + 1;\r\n        const pflowName = constructBasicPflowName(\r\n          vm.customerShortName,\r\n          vm.editEntityFormGroup.get('general').get('type').value,\r\n          vm.editEntityFormGroup.get('general').get('attributes').get('serialNumber')?.value || '',\r\n          vm.editEntityFormGroup.get('general').get('attributes').get('gatewayID')?.value || '',\r\n          index\r\n        );\r\n      \r\n\r\n        const newPflowGroup = vm.fb.group({\r\n          name: [pflowName],\r\n        });\r\n        pflowDevicesArray.push(newPflowGroup);\r\n      }\r\n  };\r\n\r\n  vm.removePflow = function (index) {\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n    if (\r\n      pflowDevicesArray.length > 1 &&\r\n      index === pflowDevicesArray.length - 1 &&\r\n      index > 0\r\n    ) {\r\n      pflowDevicesArray.removeAt(index);\r\n    }\r\n  };\r\n\r\n  vm.canRemovePflow = function (index) {\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n    return (\r\n      pflowDevicesArray.length > 1 &&\r\n      index === pflowDevicesArray.length - 1 &&\r\n      index > 0\r\n    );\r\n  };\r\n\r\n  vm.addSensor = function () {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      let sensorType;\r\n      if(vm.editEntityFormGroup.get('general').get('type').value === 'RESI') {\r\n            sensorType = 'Temperature Sensor';\r\n      } else{\r\n            sensorType = 'Room Sensor CO2';\r\n      }\r\n      \r\n      let sensorGroupConfig = {\r\n        name: [''],\r\n        type: [sensorType, [vm.validators.required]],\r\n      };\r\n    \r\n      if (\r\n          vm.editEntityFormGroup.get('general').get('type').value === 'Gateway' &&\r\n          vm.editEntityFormGroup.get('general').get('createKit').value &&\r\n          vm.editEntityFormGroup.get('general').get('addDevices').value &&\r\n          sensorType === 'Room Sensor CO2'\r\n        ) {\r\n          sensorGroupConfig['devEUI'] = ['', [vm.validators.required, vm.validators.pattern('[a-zA-Z0-9]{16}')]];\r\n          sensorGroupConfig['appKey'] = ['', [vm.validators.required, vm.validators.pattern('[a-zA-Z0-9]{32}')]];\r\n        }\r\n\r\n    \r\n      const newSensorGroup = vm.fb.group(sensorGroupConfig);\r\n      sensorDevicesArray.push(newSensorGroup);\r\n      updateSensorNames();\r\n    };\r\n\r\n  vm.removeSensor = function (index) {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      if (sensorDevicesArray.length > 0 && index >= 0) {\r\n        sensorDevicesArray.removeAt(index);\r\n\r\n        updateSensorNames();\r\n      }\r\n    };\r\n\r\n  vm.canRemoveSensor = function (index) {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      return (\r\n        sensorDevicesArray.length > 0 &&\r\n        index === sensorDevicesArray.length - 1\r\n      );\r\n    };\r\n\r\n\r\n  vm.onSensorTypeChange = function (index) {\r\n    const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices') ;\r\n    const sensorGroup = sensorDevicesArray.at(index);\r\n    const sensorType = sensorGroup.get('type').value;\r\n    const sensorName = constructSensorName(\r\n      vm.customerShortName,\r\n      vm.editEntityFormGroup.get('general').get('type').value,\r\n      vm.editEntityFormGroup.get('general').get('attributes').get('serialNumber')?.value || '',\r\n      vm.editEntityFormGroup.get('general').get('attributes').get('gatewayID')?.value || '',\r\n      index + 1,\r\n      sensorType\r\n    );\r\n    sensorGroup.get('name').setValue(sensorName);\r\n    \r\n     updateSensorNames();\r\n  };\r\n\r\n  vm.onTabChange = function (index) {\r\n    vm.selectedTabIndex = index;\r\n    vm.updateTabControls();\r\n  };\r\n\r\n  vm.updateTabControls = function () {\r\n    if (vm.selectedTabIndex === 0) {\r\n      vm.enableCreateTabControls();\r\n      vm.disableAssignTabControls();\r\n    } else if (vm.selectedTabIndex === 1) {\r\n      vm.enableAssignTabControls();\r\n      vm.disableCreateTabControls();\r\n    }\r\n  };\r\n\r\n  vm.enableCreateTabControls = function () {\r\n    vm.editEntityFormGroup.get('devices').get('pflowDevices').enable();\r\n    vm.editEntityFormGroup.get('devices').get('sensorDevices').enable();\r\n\r\n    updateEntityName();\r\n\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n   const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices') ;\r\n    \r\n    if (pflowDevicesArray.length === 0 && vm.editEntityFormGroup.get('general').get('type').value === 'RESI') {\r\n      vm.addPflow();\r\n    }\r\n    if (sensorDevicesArray.length === 0 && vm.editEntityFormGroup.get('general').get('type').value === 'Gateway') {\r\n        /*console.log(\"Hello 1\");*/\r\n      vm.addSensor();\r\n    }\r\n  };\r\n\r\n  vm.disableCreateTabControls = function () {\r\n    vm.editEntityFormGroup.get('devices').get('pflowDevices').disable();\r\n    vm.editEntityFormGroup.get('devices').get('sensorDevices').disable();\r\n    vm.editEntityFormGroup.get('devices').get('pflowDevices').reset();\r\n    vm.editEntityFormGroup.get('devices').get('sensorDevices').reset();\r\n  };\r\n\r\n  vm.enableAssignTabControls = function () {\r\n    vm.editEntityFormGroup.get('devices').get('assignmentStep').enable();\r\n  };\r\n\r\n  vm.disableAssignTabControls = function () {\r\n    vm.editEntityFormGroup.get('devices').get('assignmentStep').disable();\r\n    vm.editEntityFormGroup.get('devices').get('assignmentStep').reset();\r\n  };\r\n\r\n  vm.updateTabControls();\r\n\r\n  vm.showDevicesStep = false;\r\n  vm.availableDevices = [];\r\n  vm.pFlowDevices = [];\r\n  vm.sensorDevices = [];\r\n  vm.unassignedDevicesGroup = null;\r\n  vm.customerId = null;\r\n\r\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n    vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n  } else {\r\n    vm.customerId = {\r\n      id: widgetContext.currentUser.customerId,\r\n      entityType: 'CUSTOMER',\r\n    };\r\n  }\r\n\r\n  entityGroupService\r\n    .getEntityGroupsByOwnerId(\r\n      vm.customerId.entityType,\r\n      vm.customerId.id,\r\n      'DEVICE'\r\n    )\r\n    .subscribe((entityGroups) => {\r\n      vm.unassignedDevicesGroup = entityGroups.find(\r\n        (group) => group.name === 'Unassigned Diagnostickit Devices'\r\n      );\r\n      if (vm.unassignedDevicesGroup) {\r\n        var query = {\r\n          entityFilter: {\r\n            type: 'entityGroup',\r\n            groupType: 'DEVICE',\r\n            entityGroup: vm.unassignedDevicesGroup.id.id,\r\n          },\r\n          pageLink: {\r\n            pageSize: 100,\r\n            page: 0,\r\n          },\r\n          entityFields: [\r\n            { key: 'name', type: 'ENTITY_FIELD' },\r\n            { key: 'type', type: 'ENTITY_FIELD' },\r\n          ],\r\n        };\r\n        entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n          vm.availableDevices = data.data.map((entityData) => {\r\n            return {\r\n              deviceId: entityData.entityId,\r\n              name: entityData.latest['ENTITY_FIELD'].name.value,\r\n              type: entityData.latest['ENTITY_FIELD'].type.value,\r\n            };\r\n          });\r\n\r\n          vm.pFlowDevices = vm.availableDevices.filter(\r\n            (device) => device.type === 'P-Flow D116'\r\n          );\r\n          vm.sensorDevices = vm.availableDevices.filter(\r\n            (device) =>\r\n              device.type !== 'P-Flow D116' &&\r\n              device.type !== 'IoT Gateway' &&\r\n              device.type !== 'RESI' &&\r\n              device.type !== 'Gateway' &&\r\n              device.type !== 'MUC'\r\n          );\r\n          // Initialize the filtered list for assign fields.\r\n          // For example, if you have at least one assignment group already (default group):\r\n          if (\r\n            vm.editEntityFormGroup.get('devices').get('assignmentStep').get('devices')\r\n              .controls.length > 0\r\n          ) {\r\n            // For the first assign field (index 0)\r\n            let allPFlowDevices = vm.getAvailablePFlowDevices(0);\r\n            vm.filteredAssignDevices = {}; // ensure the object exists\r\n            vm.filteredAssignDevices[0] = allPFlowDevices.slice();\r\n          }\r\n          \r\n          if (\r\n              vm.editEntityFormGroup.get('devices').get('assignmentStep').get('sensors')\r\n                .controls.length > 0\r\n            ) {\r\n              // For the first sensor assign field (index 0)\r\n              let allSensors = vm.getAvailableSensorDevices(0);\r\n              vm.filteredAssignSensors = {}; // ensure the object exists\r\n              vm.filteredAssignSensors[0] = allSensors.slice();\r\n            }\r\n        });\r\n      }\r\n    });\r\n\r\n  vm.getAvailableSensorDevices = function (currentIndex) {\r\n    const assignSensorsArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('sensors').controls;\r\n    const selectedDevices = assignSensorsArray\r\n      .map((sensorGroup, index) =>\r\n        index !== currentIndex ? sensorGroup.get('device').value : null\r\n      )\r\n      .filter((device) => device !== null);\r\n\r\n    return vm.sensorDevices.filter(\r\n      (device) =>\r\n        !selectedDevices.some(\r\n          (selectedDevice) => device.name === selectedDevice.name\r\n        )\r\n    );\r\n  };\r\n\r\n  vm.getAvailablePFlowDevices = function (currentIndex) {\r\n    const assignDevicesArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('devices').controls;\r\n    const selectedDevices = assignDevicesArray\r\n      .map((deviceGroup, index) =>\r\n        index !== currentIndex ? deviceGroup.get('device').value : null\r\n      )\r\n      .filter((device) => device !== null);\r\n\r\n    return vm.pFlowDevices.filter(\r\n      (device) =>\r\n        !selectedDevices.some(\r\n          (selectedDevice) => device.name === selectedDevice.name\r\n        )\r\n    );\r\n  };\r\n\r\n  vm.onCreateKitChange = function (event) {\r\n    let createKitControl = event.checked;\r\n    if (!createKitControl) {\r\n      vm.editEntityFormGroup.get('general').get('newKit').setValue('');\r\n      vm.editEntityFormGroup.get('general').get('addDevices').setValue(false);\r\n      vm.showDevicesStep = false;\r\n    }\r\n  };\r\n\r\n  vm.onAddDevicesChange = function (event) {\r\n    const type = vm.editEntityFormGroup.get('general').get('type').value;\r\n    let addDevicesControl = event.checked;\r\n    vm.showDevicesStep = addDevicesControl;\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices');\r\n    const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n\r\n    if (addDevicesControl === true) {\r\n      if (pflowDevicesArray.length === 0 && type==='RESI') {\r\n        vm.addPflow();\r\n      }else if (type ==='Gateway'){\r\n        sensorDevicesArray.clear();\r\n        vm.addSensor();\r\n        pflowDevicesArray.clear();  \r\n      }\r\n    } else {\r\n      pflowDevicesArray.clear();\r\n      sensorDevicesArray.clear();\r\n    }\r\n  };\r\n\r\n  vm.addAssignDevice = function () {\r\n      const assignDevicesArray = vm.editEntityFormGroup.get('devices').get('assignmentStep').get('devices');\r\n      const newDeviceGroup = vm.fb.group({\r\n        device: [null, [vm.validators.required, deviceSelectionValidator]]\r\n      });\r\n      assignDevicesArray.push(newDeviceGroup);\r\n    };\r\n\r\n  vm.removeAssignDevice = function (index) {\r\n    const assignDevicesArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('devices') ;\r\n    if (\r\n      assignDevicesArray.length > 1 &&\r\n      index === assignDevicesArray.length - 1 &&\r\n      index > 0\r\n    ) {\r\n      assignDevicesArray.removeAt(index);\r\n    }\r\n  };\r\n\r\n  vm.canRemoveAssignDevice = function (index) {\r\n    const assignDevicesArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('devices') ;\r\n    return (\r\n      assignDevicesArray.length > 1 &&\r\n      index === assignDevicesArray.length - 1 &&\r\n      index > 0\r\n    );\r\n  };\r\n\r\n  vm.addAssignSensor = function () {\r\n      const assignSensorsArray = vm.editEntityFormGroup.get('devices').get('assignmentStep').get('sensors');\r\n      const newSensorGroup = vm.fb.group({\r\n        device: [null, [vm.validators.required, deviceSelectionValidator]]\r\n      });\r\n      assignSensorsArray.push(newSensorGroup);\r\n    \r\n      // Ensure the filtered sensor object exists\r\n      if (!vm.filteredAssignSensors) {\r\n        vm.filteredAssignSensors = {};\r\n      }\r\n      // Initialize the filtered sensors for the new index\r\n      const newIndex = assignSensorsArray.length - 1;\r\n      vm.filteredAssignSensors[newIndex] = vm.getAvailableSensorDevices(newIndex).slice();\r\n    };\r\n\r\n  vm.removeAssignSensor = function (index) {\r\n    const assignSensorsArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('sensors') ;\r\n    if (\r\n      assignSensorsArray.length > 0 &&\r\n      index >= 0\r\n    ) {\r\n      assignSensorsArray.removeAt(index);\r\n    }\r\n  };\r\n\r\n  vm.canRemoveAssignSensor = function (index) {\r\n    const assignSensorsArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('sensors') ;\r\n    return assignSensorsArray.length > 0 && index === assignSensorsArray.length -1;\r\n  };\r\n\r\n  vm.editEntityFormGroup\r\n    .get('general')\r\n    .get('entityName')\r\n    .valueChanges.subscribe((value) => {\r\n      vm.editEntityFormGroup.get('credentials').patchValue({\r\n        clientId: value,\r\n      });\r\n    });\r\n\r\n  updateControls();\r\n\r\n  function setupControlSubscriptions() {\r\n    vm.editEntityFormGroup\r\n      .get('general')\r\n      .get('entityName')\r\n      .valueChanges.subscribe((value) => {\r\n        vm.editEntityFormGroup.get('credentials').patchValue({\r\n          clientId: value,\r\n        });\r\n      });\r\n\r\n    const serialNumberControl = vm.editEntityFormGroup\r\n      .get('general')\r\n      .get('attributes')\r\n      .get('serialNumber');\r\n    if (serialNumberControl) {\r\n      serialNumberControl.valueChanges.subscribe(() => updateEntityName());\r\n    }\r\n\r\n    const gatewayIDControl = vm.editEntityFormGroup\r\n      .get('general')\r\n      .get('attributes')\r\n      .get('gatewayID');\r\n    if (gatewayIDControl) {\r\n      gatewayIDControl.valueChanges.subscribe(() => updateEntityName());\r\n    }\r\n\r\n    const typeControl = vm.editEntityFormGroup.get('general').get('type');\r\n    if (typeControl) {\r\n      typeControl.valueChanges.subscribe(() => {\r\n        updateEntityName();\r\n      });\r\n    }\r\n\r\n    const createKitControl = vm.editEntityFormGroup\r\n      .get('general')\r\n      .get('createKit');\r\n    if (createKitControl) {\r\n      createKitControl.valueChanges.subscribe(() => {\r\n        updateEntityName();\r\n      });\r\n    }\r\n  }\r\n\r\n  function updateControls() {\r\n    const type = vm.editEntityFormGroup.get('general').get('type').value;\r\n    const attributesGroup = vm.editEntityFormGroup.get('general').get('attributes');\r\n    const connectivityGroup = vm.editEntityFormGroup.get('general').get('connectivity');\r\n\r\n    if (type === 'Gateway') {\r\n      if (!attributesGroup.contains('gatewayID')) {\r\n        attributesGroup.addControl('gatewayID', vm.fb.control('', [vm.validators.required]));\r\n      }\r\n      if (attributesGroup.contains('serialNumber')) {\r\n        attributesGroup.removeControl('serialNumber');\r\n      }\r\n      vm.editEntityFormGroup.get('credentials').disable();\r\n    } else {\r\n      if (!attributesGroup.contains('serialNumber')) {\r\n        attributesGroup.addControl('serialNumber', vm.fb.control('', [vm.validators.required]));\r\n      }\r\n      if (attributesGroup.contains('gatewayID')) {\r\n        attributesGroup.removeControl('gatewayID');\r\n      }\r\n      vm.editEntityFormGroup.get('credentials').enable();\r\n    }\r\n    \r\n    if(vm.editEntityFormGroup.get('general').get('activateSIM').value === true) {\r\n        connectivityGroup.addControl('ICCID', vm.fb.control('', [vm.validators.required]));\r\n        connectivityGroup.addControl('carrierSIM', vm.fb.control('', [vm.validators.required]));\r\n        connectivityGroup.addControl('statusSIM', vm.fb.control('', [vm.validators.required]));\r\n    } else if(vm.editEntityFormGroup.get('general').get('activateSIM').value === false) {\r\n        connectivityGroup.removeControl('ICCID');\r\n        connectivityGroup.removeControl('carrierSIM');\r\n        connectivityGroup.removeControl('statusSIM');\r\n    }\r\n\r\n    setupControlSubscriptions();\r\n  }\r\n  \r\n  function updateSensorNames() {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      const sensorTypeCounts = {};\r\n    \r\n      for (let i = 0; i < sensorDevicesArray.length; i++) {\r\n        const sensorGroup = sensorDevicesArray.at(i);\r\n        const sensorType = sensorGroup.get('type').value;\r\n    \r\n        const countingType = (sensorType === 'Temperature Sensor' || sensorType === 'Room Sensor T') ? 'Temperature' : sensorType;\r\n    \r\n        if (!sensorTypeCounts[countingType]) {\r\n          sensorTypeCounts[countingType] = 1;\r\n        } else {\r\n          sensorTypeCounts[countingType] += 1;\r\n        }\r\n    \r\n        const sensorTypeIndex = sensorTypeCounts[countingType];\r\n    \r\n        const sensorName = constructSensorName(\r\n          vm.customerShortName,\r\n          vm.editEntityFormGroup.get('general').get('type').value,\r\n          vm.editEntityFormGroup.get('general').get('attributes').get('serialNumber')?.value || '',\r\n          vm.editEntityFormGroup.get('general').get('attributes').get('gatewayID')?.value || '',\r\n          sensorTypeIndex,\r\n          sensorType\r\n        );\r\n    \r\n        sensorGroup.get('name').setValue(sensorName);\r\n      }\r\n    }\r\n\r\n\r\n\r\n  function updateEntityName() {\r\n    const type = vm.editEntityFormGroup.get('general').get('type').value;\r\n    const serialNumber =\r\n      vm.editEntityFormGroup\r\n        .get('general')\r\n        .get('attributes')\r\n        .get('serialNumber')?.value || '';\r\n    const gatewayID =\r\n      vm.editEntityFormGroup\r\n        .get('general')\r\n        .get('attributes')\r\n        .get('gatewayID')?.value || '';\r\n    const customerShortName = vm.customerShortName || '';\r\n    const updatedDeviceName = constructDeviceName(\r\n      customerShortName,\r\n      type,\r\n      serialNumber,\r\n      gatewayID\r\n    );\r\n    vm.editEntityFormGroup.get('general').get('entityName').setValue(updatedDeviceName);\r\n\r\n    /*if (vm.editEntityFormGroup.get('general').get('createKit').value) {\r\n      const kitName = generateDiagnostickitName(type);\r\n      vm.editEntityFormGroup.get('general').get('newKit').setValue(kitName);\r\n    }*/\r\n\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n    for (let i = 0; i < pflowDevicesArray.length; i++) {\r\n      const pflowGroup = pflowDevicesArray.at(i);\r\n      const pflowName = constructBasicPflowName(\r\n        customerShortName,\r\n        type,\r\n        serialNumber,\r\n        gatewayID,\r\n        i + 1\r\n      );\r\n      pflowGroup.get('name').setValue(pflowName);\r\n    }\r\n\r\n    const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices') ;\r\n    for (let i = 0; i < sensorDevicesArray.length; i++) {\r\n      const sensorGroup = sensorDevicesArray.at(i);\r\n      const sensorType = sensorGroup.get('type').value;\r\n      const sensorName = constructSensorName(\r\n        customerShortName,\r\n        type,\r\n        serialNumber,\r\n        gatewayID,\r\n        i + 1,\r\n        sensorType\r\n      );\r\n      sensorGroup.get('name').setValue(sensorName);\r\n    }\r\n    \r\n    updateSensorNames();\r\n  }\r\n\r\n  attributeService\r\n    .getEntityAttributes(\r\n      { entityType: 'CUSTOMER', id: customerID },\r\n      'SERVER_SCOPE',\r\n      ['shortName']\r\n    )\r\n    .subscribe((attributes) => {\r\n      const shortNameAttr = attributes.find((attr) => attr.key === 'shortName');\r\n      vm.customerShortName = shortNameAttr\r\n        ? shortNameAttr.value\r\n        : generateCustomerShortName(customerName);\r\n      updateEntityName();\r\n    });\r\n\r\n  vm.editEntityFormGroup.get('general').get('type').valueChanges.subscribe(() => {\r\n    updateControls();\r\n    updateEntityName();\r\n  });\r\n  \r\n  vm.editEntityFormGroup.get('general').get('activateSIM').valueChanges.subscribe(() => {\r\n    updateControls();\r\n  });\r\n\r\n  setupControlSubscriptions();\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  vm.save = function () {\r\n    vm.editEntityFormGroup.markAsPristine();\r\n\r\n    var customer = widgetContext.stateController.getStateParams().entityId;\r\n    var formValues = vm.editEntityFormGroup.value;\r\n    var kit;\r\n\r\n    if (vm.editEntityFormGroup.get('general').get('createKit').value) {\r\n      saveDiagnostickitObservable(customer).subscribe(\r\n      function (Diagnostickit) {\r\n        kit = Diagnostickit;\r\n        let kitType;\r\n        switch (vm.editEntityFormGroup.get('general').get('type').value) {\r\n            case 'RESI':\r\n                kitType = \"basis\";\r\n                break;\r\n            case 'Gateway':\r\n                kitType = \"loraWan\";\r\n                break;\r\n            default:\r\n                kitType = \"basis\";\r\n                break;\r\n        }\r\n        let attribute = [{\r\n            key : \"kitType\",\r\n            value:kitType,\r\n        }];\r\n        /*console.log(\"kit\",kit);\r\n        console.log(\"kitType\",kitType);*/\r\n        \r\n        attributeService.saveEntityAttributes(kit.id,'SERVER_SCOPE',attribute).subscribe();\r\n        saveCustomerToDiagnostickitRelation(customer, Diagnostickit.id).subscribe();\r\n\r\n        if (vm.editEntityFormGroup.get('general').get('addDevices').value) {\r\n          if (vm.selectedTabIndex === 1) {\r\n            var devicesArray = vm.editEntityFormGroup\r\n              .get('devices')\r\n              .get('assignmentStep')\r\n              .get('devices').value;\r\n\r\n            var sensorsArray = vm.editEntityFormGroup\r\n              .get('devices')\r\n              .get('assignmentStep')\r\n              .get('sensors').value;\r\n\r\n            devicesArray = devicesArray.concat(sensorsArray);\r\n\r\n            assignExistingDevices(kit.id, devicesArray).subscribe(\r\n              function () {\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              },\r\n              function (error) {\r\n                widgetContext.dialogs.alert('Error assigning devices:', error.message);\r\n              }\r\n            );\r\n          } else if (vm.selectedTabIndex === 0) {\r\n            var pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices').value;\r\n\r\n            var pflowDevices = pflowDevicesArray.map(function (device) {\r\n              return { name: device.name, type: 'P-Flow D116' };\r\n            });\r\n\r\n            var sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices').value;\r\n            var sensorDevices = sensorDevicesArray.map(function (device) {\r\n              let sensor = { name: device.name, type: device.type };\r\n              if (device.type === 'Room Sensor CO2' && device.devEUI && device.appKey) {\r\n                sensor.devEUI = device.devEUI;\r\n                sensor.appKey = device.appKey;\r\n              }\r\n              return sensor;\r\n            });\r\n\r\n            var devicesToCreate = pflowDevices.concat(sensorDevices);\r\n\r\n            createAndAssignDevices(kit.id, devicesToCreate).subscribe(\r\n              function () {\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              },\r\n              function (error) {\r\n                widgetContext.dialogs.alert('Error creating and assigning devices:', error.message);\r\n              }\r\n            );\r\n          } else {\r\n            vm.dialogRef.close(null);\r\n          }\r\n        } else {\r\n          vm.dialogRef.close(null);\r\n        }\r\n      });\r\n    } else {\r\n      vm.dialogRef.close(null);\r\n    }\r\n\r\n    \r\n    function createAndAssignDevices(DiagnostickitId, devicesToCreate) {\r\n      var customerId = widgetContext.stateController.getStateParams().entityId;\r\n    \r\n      return getDiagnostickitDevicesGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap(function (DiagnostickitDevicesGroup) {\r\n        return getUnassignedDevicesGroupMeasurement(customerId).pipe(\r\n        widgetContext.rxjs.switchMap(function (unassignedDevicesGroupMeasurement) {\r\n          var observables = devicesToCreate.map(function (deviceInfo) {\r\n            return createDeviceObservable(customerId, DiagnostickitDevicesGroup,unassignedDevicesGroupMeasurement, deviceInfo).pipe(\r\n              widgetContext.rxjs.switchMap(function (savedDevice) {\r\n                return saveDeviceToDiagnostickitRelation(DiagnostickitId, savedDevice.id);\r\n              })\r\n            );\r\n          });\r\n    \r\n          return widgetContext.rxjs.forkJoin(observables);\r\n        })\r\n      );\r\n            \r\n        })\r\n      );\r\n    }\r\n    \r\n    function getDiagnostickitDevicesGroup(customerId) {\r\n      return entityGroupService\r\n        .getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE')\r\n        .pipe(\r\n          widgetContext.rxjs.switchMap(function (groups) {\r\n            return getOrCreateDevicesGroup(groups, 'Diagnostickit Devices', customerId);\r\n          })\r\n        );\r\n    }\r\n    function getUnassignedDevicesGroupMeasurement(customerId) {\r\n      return entityGroupService\r\n        .getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE')\r\n        .pipe(\r\n          widgetContext.rxjs.switchMap(function (groups) {\r\n            return getOrCreateDevicesGroup(groups, 'Unassigned Measurement Devices', customerId);\r\n          })\r\n        );\r\n    }\r\n\r\n\r\n    \r\n    function createDeviceObservable(customerId, DiagnostickitDevicesGroup,unassignedDevicesGroupMeasurement, deviceInfo) {\r\n      var device = {\r\n        name: deviceInfo.name,\r\n        type: deviceInfo.type,\r\n        customerId: customerId,\r\n      };\r\n    \r\n      return deviceService.saveDevice(device, DiagnostickitDevicesGroup.id.id).pipe(\r\n        widgetContext.rxjs.switchMap(function (savedDevice) {\r\n                if (deviceInfo.type === 'Room Sensor CO2' && deviceInfo.devEUI && deviceInfo.appKey) {\r\n                let attributesArray = [\r\n                  { key: 'devEui', value: deviceInfo.devEUI },\r\n                  { key: 'appKey', value: deviceInfo.appKey }\r\n                ];\r\n                return attributeService.saveEntityAttributes(savedDevice.id, 'SERVER_SCOPE', attributesArray).pipe(\r\n                  widgetContext.rxjs.map(() => savedDevice)\r\n                );\r\n              }\r\n            return entityGroupService\r\n              .addEntityToEntityGroup(unassignedDevicesGroupMeasurement.id.id, savedDevice.id.id)\r\n              .pipe(\r\n                widgetContext.rxjs.switchMap(() => {\r\n              return saveCustomerToDeviceRelation(customerId, savedDevice.id).pipe(\r\n                widgetContext.rxjs.map(function () {\r\n                  return savedDevice;\r\n                })\r\n              );\r\n            })\r\n          );\r\n        })\r\n      );\r\n    }\r\n\r\n    function updateSensorControls() {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      const isGateway = vm.editEntityFormGroup.get('general').get('type').value === 'Gateway';\r\n      const createKit = vm.editEntityFormGroup.get('general').get('createKit').value;\r\n      const addDevices = vm.editEntityFormGroup.get('general').get('addDevices').value;\r\n      \r\n      sensorDevicesArray.controls.forEach(sensorGroup => {\r\n        // Only for Room Sensor CO2 sensors\r\n        if (sensorGroup.get('type').value === 'Room Sensor CO2') {\r\n          if (isGateway && createKit && addDevices) {\r\n            // Add extra controls if missing\r\n            if (!sensorGroup.contains('devEUI')) {\r\n              sensorGroup.addControl('devEUI', vm.fb.control(''));\r\n            }\r\n            if (!sensorGroup.contains('appKey')) {\r\n              sensorGroup.addControl('appKey', vm.fb.control(''));\r\n            }\r\n          } else {\r\n            // Remove extra controls if present\r\n            if (sensorGroup.contains('devEUI')) {\r\n              sensorGroup.removeControl('devEUI');\r\n            }\r\n            if (sensorGroup.contains('appKey')) {\r\n              sensorGroup.removeControl('appKey');\r\n            }\r\n          }\r\n        } else {\r\n          // For any sensor that isn’t a Room Sensor CO2, remove extra controls if they exist.\r\n          if (sensorGroup.contains('devEUI')) {\r\n            sensorGroup.removeControl('devEUI');\r\n          }\r\n          if (sensorGroup.contains('appKey')) {\r\n            sensorGroup.removeControl('appKey');\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n\r\n    \r\n    function assignExistingDevices(DiagnostickitId, devicesArray) {\r\n        var observables = [];\r\n        devicesArray.forEach((deviceGroup) => {\r\n            if (deviceGroup.device) {\r\n                var deviceId = deviceGroup.device.deviceId;\r\n                observables.push(\r\n                    widgetContext.rxjs.forkJoin([\r\n                        entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n                        saveDeviceToDiagnostickitRelation(DiagnostickitId, deviceId)\r\n                    ])\r\n                );\r\n            } else {\r\n                var deviceId = deviceGroup.deviceId;\r\n                observables.push(\r\n                    widgetContext.rxjs.forkJoin([\r\n                        entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n                        saveDeviceToDiagnostickitRelation(DiagnostickitId, deviceId)\r\n                    ])\r\n                );\r\n            }\r\n        });\r\n        return widgetContext.rxjs.forkJoin(observables);\r\n    }\r\n    \r\n    function saveDeviceToDiagnostickitRelation(DiagnostickitId, deviceId) {\r\n        var relation = {\r\n            from: DiagnostickitId,\r\n            to: deviceId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Contains'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function saveDiagnostickitObservable(customer) {\r\n        return getDiagnostickitsGroup(customer).pipe(\r\n            widgetContext.rxjs.switchMap((DiagnostickitsGroup) => {\r\n                const formValues = vm.editEntityFormGroup.value;\r\n                const Diagnostickit = {\r\n                    name: formValues.general.newKit,\r\n                    type: 'Diagnostickit',\r\n                    customerId: customer\r\n                };\r\n                /*console.log(\"kit:\", Diagnostickit);*/\r\n    \r\n                return assetService.saveAsset(Diagnostickit, DiagnostickitsGroup.id.id).pipe(\r\n                    widgetContext.rxjs.switchMap((savedAsset) => {\r\n                        //console.log(\"saved asset:\", savedAsset);\r\n                        return widgetContext.rxjs.of(savedAsset);\r\n                    })\r\n                );\r\n            })\r\n        );\r\n    }\r\n    \r\n    try {\r\n      getTargetDeviceGroups(customer)\r\n        .pipe(\r\n          widgetContext.rxjs.switchMap((targetDevicesGroup) => {\r\n            var DiagnostickitDevicesGroup = targetDevicesGroup[0];\r\n            var unassignedDevicesGroupMeasurement= targetDevicesGroup[1];\r\n            var unassignedDevicesGroupKit = targetDevicesGroup[2];\r\n            var Gateways = targetDevicesGroup[3];\r\n            \r\n            if(vm.editEntityFormGroup.get('general').get('createKit').value) {\r\n                return saveEntityObservableKit(\r\n                  customer,\r\n                  DiagnostickitDevicesGroup,\r\n                  unassignedDevicesGroupMeasurement,\r\n                  Gateways\r\n            );\r\n            } else {\r\n                return saveEntityObservable(\r\n                  customer,\r\n                  DiagnostickitDevicesGroup,\r\n                  unassignedDevicesGroupMeasurement,\r\n                  unassignedDevicesGroupKit,\r\n                  Gateways\r\n                );\r\n            }\r\n          })\r\n        )\r\n        .subscribe(gateway =>{\r\n            \r\n            if(vm.editEntityFormGroup.get('general').get('createKit').value) {\r\n                saveDeviceToDiagnostickitRelation(kit.id, gateway.id).subscribe();\r\n            }\r\n            \r\n            saveCustomerToDeviceRelation(customer, gateway.id).subscribe();\r\n            saveAttributes(gateway.id).subscribe();\r\n            \r\n            if (vm.editEntityFormGroup.get('general').get('type').value !== 'Gateway') {\r\n            updateCredentials(gateway.id).subscribe(\r\n              () => {\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              },\r\n              (error) => {\r\n                widgetContext.dialogs.alert('Error updating credentials:', error.message);\r\n              }\r\n            );\r\n          } else {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n          }\r\n        });\r\n        \r\n    } catch (error) {\r\n      widgetContext.dialogs.alert('Unexpected error:', error.message);\r\n    }\r\n    \r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  function getDiagnostickitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var DiagnostickitsGroup = entityGroups.find(group => group.name === 'Diagnostickits');\r\n              if (DiagnostickitsGroup) {\r\n                  return widgetContext.rxjs.of(DiagnostickitsGroup);\r\n              } else {\r\n                  DiagnostickitsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Diagnostickits',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(DiagnostickitsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  \r\n  function getUnassignedKitGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n              if (UnassignedKitGroup) {\r\n                  return widgetContext.rxjs.of(UnassignedKitGroup);\r\n              } else {\r\n                  UnassignedKitGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Unassigned Kit',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  \r\n function saveCustomerToDiagnostickitRelation(customerId, DiagnostickitId) {\r\n    var relation = {\r\n        from: customerId,\r\n        to: DiagnostickitId,\r\n        typeGroup: 'COMMON',\r\n        type: 'Owns'\r\n    };\r\n    //console.log(\"Initiating save relation with payload:\", relation);\r\n\r\n    return entityRelationService.saveRelation(relation).pipe(\r\n        widgetContext.rxjs.tap({\r\n            next: (response) => {\r\n                //console.log(\"Successfully saved relation:\", response);\r\n            },\r\n            error: (error) => {\r\n                console.error(\"Error occurred while saving relation:\", error);\r\n            },\r\n        }),\r\n        widgetContext.rxjs.catchError((error) => {\r\n            console.error(\"Caught error while saving relation:\", error);\r\n            return widgetContext.rxjs.throwError(() => new Error(`Failed to save relation: ${error.message}`));\r\n        })\r\n    );\r\n}\r\n\r\nfunction saveCustomerToDeviceRelation(customerId, DeviceId) {\r\n    var relation = {\r\n        from: customerId,\r\n        to: DeviceId,\r\n        typeGroup: 'COMMON',\r\n        type: 'Contains'\r\n    };\r\n    //console.log(\"Initiating save relation with payload:\", relation);\r\n\r\n    return entityRelationService.saveRelation(relation).pipe(\r\n        widgetContext.rxjs.tap({\r\n            next: (response) => {\r\n                //console.log(\"Successfully saved relation:\", response);\r\n            },\r\n            error: (error) => {\r\n                console.error(\"Error occurred while saving relation:\", error);\r\n            },\r\n        }),\r\n        widgetContext.rxjs.catchError((error) => {\r\n            console.error(\"Caught error while saving relation:\", error);\r\n            return widgetContext.rxjs.throwError(() => new Error(`Failed to save relation: ${error.message}`));\r\n        })\r\n    );\r\n}\r\n\r\n\r\n\r\n  vm.copyToClipboard = function (event, controlName) {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const value = vm.editEntityFormGroup.get(controlName.split('.')).value;\r\n    navigator.clipboard.writeText(value).then(() => {\r\n      widgetContext.showSuccessToast(\r\n        'Copied to clipboard!',\r\n        2000,\r\n        'top',\r\n        'center'\r\n      );\r\n    }).catch((err) => {\r\n      widgetContext.showErrorToast(\r\n        'Failed to copy to clipboard.',\r\n        2000,\r\n        'top',\r\n        'center'\r\n      );\r\n    });\r\n  };\r\n\r\n  vm.onDeviceTypeChange = function (stepper) {\r\n     let pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n    let sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n    let assignSensorsArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('sensors');\r\n    let assignDevicesArray = vm.editEntityFormGroup\r\n          .get('devices')\r\n          .get('assignmentStep')\r\n          .get('devices');\r\n    const type = vm.editEntityFormGroup.get('general').get('type').value;\r\n    /*console.log(pflowDevicesArray);*/\r\n    \r\n    if (type === 'Gateway') {\r\n      vm.editEntityFormGroup.get('credentials').disable();\r\n        pflowDevicesArray.clear();\r\n        sensorDevicesArray.clear();\r\n        assignSensorsArray.clear();\r\n        assignDevicesArray.clear();\r\n      /*stepper.selectedIndex = 0;*/\r\n    } else {\r\n      vm.editEntityFormGroup.get('credentials').enable();\r\n      /*if (stepper.selectedIndex === 0) {\r\n        stepper.selectedIndex = 1;\r\n      }*/\r\n      sensorDevicesArray.clear();\r\n      assignSensorsArray.clear();\r\n      assignDevicesArray.clear();\r\n    }\r\n    /*console.log(pflowDevicesArray);*/\r\n  };\r\n\r\n  vm.editEntityFormGroup.get('general').get('type').valueChanges.subscribe((type) => {\r\n    if (type === 'Gateway') {\r\n      vm.editEntityFormGroup.get('credentials').disable();\r\n    } else {\r\n      vm.editEntityFormGroup.get('credentials').enable();\r\n    }\r\n  });\r\n\r\n  vm.hidePassword = true;\r\n\r\n  vm.togglePasswordVisibility = function () {\r\n    vm.hidePassword = !vm.hidePassword;\r\n  };\r\n\r\n  function getTargetDeviceGroups(customerId) {\r\n    return entityGroupService\r\n      .getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE')\r\n      .pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          return widgetContext.rxjs.forkJoin([\r\n            getOrCreateDevicesGroup(groups, 'Diagnostickit Devices', customerId),\r\n            getOrCreateDevicesGroup(groups, 'Unassigned Measurement Devices', customerId),\r\n            getOrCreateDevicesGroup(groups, 'Unassigned Diagnostickit Devices', customerId),\r\n            getOrCreateDevicesGroup(groups, 'Gateways', customerId),\r\n          ]);\r\n        })\r\n      );\r\n  }\r\n\r\n  function getOrCreateDevicesGroup(groups, groupName, customerId) {\r\n    var devicesGroup = groups.find((group) => group.name === groupName);\r\n    if (devicesGroup) {\r\n      return widgetContext.rxjs.of(devicesGroup);\r\n    } else {\r\n      devicesGroup = {\r\n        type: 'DEVICE',\r\n        name: groupName,\r\n        ownerId: customerId,\r\n      };\r\n      return entityGroupService.saveEntityGroup(devicesGroup);\r\n    }\r\n  }\r\n\r\n  function saveEntityObservable(customerId, DiagnostickitDevicesGroup,unassignedDevicesGroupMeasurement, unassignedDevicesGroup, Gateways) {\r\n    const formValues = vm.editEntityFormGroup.get('general').value;\r\n    let entity = {\r\n      name: formValues.entityName,\r\n      type: formValues.type,\r\n      label: formValues.entityLabel,\r\n      customerId: customerId,\r\n    };\r\n\r\n    return deviceService.saveDevice(entity, unassignedDevicesGroup.id.id).pipe(\r\n      widgetContext.rxjs.switchMap((savedDevice) => {\r\n        return entityGroupService\r\n          .addEntityToEntityGroup(DiagnostickitDevicesGroup.id.id, savedDevice.id.id)\r\n          .pipe(\r\n            widgetContext.rxjs.switchMap(() => { \r\n            return entityGroupService\r\n              .addEntityToEntityGroup(unassignedDevicesGroupMeasurement.id.id, savedDevice.id.id)\r\n              .pipe(\r\n                widgetContext.rxjs.switchMap(() => {\r\n                  return entityGroupService\r\n                    .addEntityToEntityGroup(Gateways.id.id, savedDevice.id.id)\r\n                    .pipe(\r\n                      widgetContext.rxjs.map(() => {\r\n                        return savedDevice;\r\n                      })\r\n                    );\r\n                })\r\n              );\r\n            })\r\n          );\r\n      })\r\n    );\r\n  }\r\n\r\nfunction saveEntityObservableKit(customerId, DiagnostickitDevicesGroup,unassignedDevicesGroupMeasurement, Gateways) {\r\n    const formValues = vm.editEntityFormGroup.get('general').value;\r\n    let entity = {\r\n      name: formValues.entityName,\r\n      type: formValues.type,\r\n      label: formValues.entityLabel,\r\n      customerId: customerId,\r\n    };\r\n\r\n    return deviceService.saveDevice(entity).pipe(\r\n      widgetContext.rxjs.switchMap((savedDevice) => {\r\n        return entityGroupService\r\n          .addEntityToEntityGroup(DiagnostickitDevicesGroup.id.id, savedDevice.id.id)\r\n          .pipe(\r\n            widgetContext.rxjs.switchMap(() => {\r\n            return entityGroupService\r\n          .addEntityToEntityGroup(unassignedDevicesGroupMeasurement.id.id, savedDevice.id.id)\r\n          .pipe(\r\n            widgetContext.rxjs.switchMap(() => {\r\n              return entityGroupService\r\n                .addEntityToEntityGroup(Gateways.id.id, savedDevice.id.id)\r\n                .pipe(\r\n                  widgetContext.rxjs.map(() => {\r\n                    return savedDevice;\r\n                  })\r\n                );\r\n            })\r\n          );\r\n            })\r\n          );\r\n      })\r\n    );\r\n  }\r\n  \r\n  function constructDeviceName(customerShortName, type, serialNumber = '', gatewayID = '') {\r\n    return type === 'Gateway'\r\n      ? `ECO_${gatewayID}_gw`\r\n      : `ECO_${serialNumber}_gw`;\r\n  }\r\n\r\n  function constructBasicPflowName(customerShortName, type, serialNumber = '', gatewayID = '', index = '') {\r\n    return type === 'Gateway'\r\n      ? `ECO_${gatewayID}_PF${index}`\r\n      : `ECO_${serialNumber}_PF${index}`;\r\n  }\r\n\r\n  /*function constructKitName(customerShortName, type, serialNumber = '', gatewayID = '') {\r\n    return type === 'Gateway'\r\n      ? `${customerShortName}_${gatewayID}_Kit`\r\n      : `${customerShortName}_${serialNumber}_Kit`;\r\n  }*/\r\n  /*function generateDiagnostickitName(kitType) {\r\n  // Current 2-digit year\r\n  const year = (new Date().getFullYear() % 100).toString().padStart(2, '0');\r\n  // Prefix depends on kitType\r\n  const prefix = kitType === 'basis' ? 'DBKIT' : 'DEKIT';\r\n\r\n  // Pattern to match, ignoring the year for the counter:\r\n  // e.g. DBKITxxEU-0001 or DEKITxxEU-0001\r\n  // where \"xx\" can be any 2-digit year\r\n  const pattern = new RegExp(`^${prefix}\\\\d{2}EU-(\\\\d{4})$`);\r\n\r\n  // Find the maximum counter among all matching kits\r\n  let maxNumber = 0;\r\n  diagnostickitsAll.forEach(d => {\r\n    const match = d.name.match(pattern);\r\n    if (match) {\r\n      const currentNum = parseInt(match[1], 10);\r\n      if (currentNum > maxNumber) {\r\n        maxNumber = currentNum;\r\n      }\r\n    }\r\n  });\r\n\r\n  // Next counter (increment by 1)\r\n  const nextNumber = (maxNumber + 1).toString().padStart(4, '0');\r\n\r\n  // Construct new name with current year (but counter won't reset per year)\r\n  return `${prefix}${year}EU-${nextNumber}`;\r\n}\r\n  */\r\n  function constructSensorName(customerShortName, type, serialNumber = '', gatewayID = '', index = '', sensorType = 'Temperature Sensor') {\r\n      const sensorTypeShort = sensorType === 'Temperature Sensor' || sensorType === 'Room Sensor T' ? 'TS' :\r\n                              sensorType === 'Room Sensor CO2' ? 'CO2_' :\r\n                              'Sensor';\r\n    \r\n      return type === 'Gateway'\r\n        ? `ECO_${gatewayID}_${sensorTypeShort}${index}`\r\n        : `ECO_${serialNumber}_${sensorTypeShort}${index}`;\r\n    }\r\n\r\n\r\n\r\n  function generateCustomerShortName(customerName) {\r\n    if (!customerName) return '';\r\n    return customerName\r\n      .split(' ')\r\n      .map((word) => word[0].toUpperCase())\r\n      .join('');\r\n  }\r\n\r\n  function updateCredentials(entityId) {\r\n    return deviceService.getDeviceCredentials(entityId.id).pipe(\r\n      widgetContext.rxjs.mergeMap((existingCredentials) => {\r\n        let credentials = vm.editEntityFormGroup.get('credentials').value;\r\n        let deviceCredentials = {\r\n          id: existingCredentials.id,\r\n          deviceId: existingCredentials.deviceId,\r\n          credentialsType: credentials.credentialsType,\r\n          credentialsValue: JSON.stringify({\r\n            clientId: credentials.clientId,\r\n            userName: credentials.userName,\r\n            password: credentials.password,\r\n          }),\r\n        };\r\n        return deviceService.saveDeviceCredentials(deviceCredentials);\r\n      }),\r\n      widgetContext.rxjs.catchError((error) => {\r\n        widgetContext.showErrorToast(\r\n          `Failed to update credentials: ${error.message}`,\r\n          4000,\r\n          'top',\r\n          'center'\r\n        );\r\n        return widgetContext.rxjs.throwError(error);\r\n      })\r\n    );\r\n  }\r\n\r\n function saveAttributes(entityId) {\r\n     \r\n     /*console.log(\"entityId:\", entityId);*/\r\n      let attributes = vm.editEntityFormGroup.get('general').get('attributes').value;\r\n      let attributesArray = [];\r\n    \r\n      attributes.inactivityTimeout *= 60000;\r\n    \r\n      for (let key in attributes) {\r\n        if (attributes[key] !== null && attributes[key] !== '') {\r\n          attributesArray.push({\r\n            key: key,\r\n            value: attributes[key],\r\n          });\r\n        }\r\n      }\r\n    \r\n      if (vm.editEntityFormGroup.get('general').get('activateSIM').value) {\r\n        var connectivityValues = vm.editEntityFormGroup.get('general').get('connectivity').value;\r\n        var connectivityAttr = {\r\n          key: \"connectivity\",\r\n          value: {\r\n            \"carrier\": connectivityValues.carrierSIM,\r\n            \"ICCID\": connectivityValues.ICCID,\r\n            \"simStatus\": connectivityValues.statusSIM,\r\n          }\r\n        };\r\n    \r\n        attributesArray.push(connectivityAttr);\r\n      }\r\n      var kitAttr = {\r\n            key: 'diagnostickit',\r\n            value: vm.editEntityFormGroup.get('general').get('newKit').value\r\n        }\r\n    \r\n      attributesArray.push(kitAttr);\r\n      if (attributesArray.length > 0) {\r\n        return attributeService.saveEntityAttributes(\r\n          entityId,\r\n          'SERVER_SCOPE',\r\n          attributesArray\r\n        ).pipe(\r\n          widgetContext.rxjs.tap(() => {\r\n            /*console.log('Attributes saved successfully.');*/\r\n          }),\r\n          widgetContext.rxjs.catchError((error) => {\r\n            console.error('Error saving attributes:', error);\r\n            return widgetContext.rxjs.throwError(error);\r\n          })\r\n        );\r\n      } else {\r\n        return widgetContext.rxjs.of([]);\r\n      }\r\n    }\r\n\r\n\r\n\r\n  function saveRelations(entityId) {\r\n    let relations = vm.editEntityFormGroup.get('relations').value;\r\n    let tasks = [];\r\n    for (let i = 0; i < relations.length; i++) {\r\n      let relation = {\r\n        type: relations[i].relationType,\r\n        typeGroup: 'COMMON',\r\n      };\r\n      if (relations[i].direction == 'FROM') {\r\n        relation.to = relations[i].relatedEntity;\r\n        relation.from = entityId;\r\n      } else {\r\n        relation.to = entityId;\r\n        relation.from = relations[i].relatedEntity;\r\n      }\r\n      tasks.push(entityRelationService.saveRelation(relation));\r\n    }\r\n    if (tasks.length > 0) {\r\n      return widgetContext.rxjs.forkJoin(tasks);\r\n    }\r\n    return widgetContext.rxjs.of([]);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "dd13ad24-5569-02a3-b26d-446d9e9d436b"
              }
            ],
            "actionCellButton": [
              {
                "name": "{i18n:custom.gateways.edit-gateway}",
                "icon": "edit",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"editDeviceFormGroup\" (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 500px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.gateways.edit-gateway' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <mat-horizontal-stepper [linear]=\"true\" #stepper style=\"flex-grow: 1;\">\r\n        \r\n      <mat-step [stepControl]=\"editDeviceFormGroup.get('gatewayDetails')\">\r\n        <ng-template matStepLabel>Gateway</ng-template>\r\n        <div class=\"flex flex-col justify-start items-stretch flex-grow\" [formGroup]=\"editDeviceFormGroup.get('gatewayDetails')\">\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Name</mat-label>\r\n            <input matInput formControlName=\"name\" required readonly>\r\n            <mat-error *ngIf=\"editDeviceFormGroup.get('gatewayDetails.name').hasError('required')\">\r\n              {{ 'custom.devices.device-name-is-required' | translate }}\r\n            </mat-error>\r\n          </mat-form-field>\r\n          <!--<mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Type</mat-label>\r\n            <mat-select formControlName=\"type\" required>\r\n              <mat-option *ngFor=\"let type of deviceTypes\" [value]=\"type\">\r\n                {{ type }}\r\n              </mat-option>\r\n            </mat-select>\r\n            <mat-error *ngIf=\"editDeviceFormGroup.get('gatewayDetails.type').hasError('required')\">\r\n              Device type is required.\r\n            </mat-error>\r\n          </mat-form-field>-->\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Label</mat-label>\r\n            <input matInput formControlName=\"label\">\r\n          </mat-form-field>\r\n          <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n              <button mat-button mat-raised-button color=\"primary\" matStepperNext type=\"button\">\r\n                {{ 'custom.gateways.edit-gateway-next' | translate }}\r\n              </button>\r\n            </div>\r\n        </div>\r\n      </mat-step>\r\n      \r\n      <mat-step [stepControl]=\"editDeviceFormGroup.get('simDetails')\">\r\n        <div class=\"flex flex-col justify-start items-stretch flex-grow\" [formGroup]=\"editDeviceFormGroup.get('simDetails')\">\r\n          <ng-template matStepLabel>{{ 'custom.gateways.edit-gateway-sim-card' | translate }}</ng-template>\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>ICCID</mat-label>\r\n            <input matInput formControlName=\"ICCID\">\r\n          </mat-form-field>\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Carrier</mat-label>\r\n            <mat-select formControlName=\"carrierSIM\">\r\n              <mat-option value=\"tech+\">wherever SIM tech+</mat-option>\r\n              <mat-option value=\"link+\">wherever SIM link+</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>SIM Status</mat-label>\r\n            <mat-select formControlName=\"statusSIM\">\r\n              <mat-option [value]=\"2\">{{ 'custom.gateways.edit-gateway-activate' | translate }}</mat-option>\r\n              <mat-option [value]=\"5\">{{ 'custom.gateways.edit-gateway-deactivate' | translate }}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n              <button mat-button mat-raised-button color=\"primary\" matStepperNext type=\"button\">\r\n                {{ 'custom.gateways.edit-gateway-next' | translate }}\r\n              </button>\r\n            </div>\r\n        </div>\r\n      </mat-step>\r\n      \r\n      <mat-step [stepControl]=\"editDeviceFormGroup.get('credentialsDetails')\">\r\n        <div class=\"flex flex-col justify-start items-stretch flex-grow\" [formGroup]=\"editDeviceFormGroup.get('credentialsDetails')\">\r\n          <ng-template matStepLabel>{{ 'custom.gateways.edit-gateway-credentials' | translate }}</ng-template>\r\n          \r\n          <!-- MQTT_BASIC Fields -->\r\n          <div *ngIf=\"editDeviceFormGroup.get('credentialsDetails').get('credentialsType').value === 'MQTT_BASIC'\">\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>Client ID</mat-label>\r\n                <input matInput formControlName=\"clientId\" required />\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"{{ 'custom.gateways.edit-gateway-copy-client-id' | translate }}\" (click)=\"copyToClipboard($event, 'credentialsDetails.clientId')\">\r\n                  <mat-icon>content_copy</mat-icon>\r\n                </button>\r\n                <mat-error *ngIf=\"editDeviceFormGroup.get('credentialsDetails.clientId').hasError('required')\">{{ 'integration.client-id-required' | translate }}</mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>{{ 'custom.gateways.edit-gateway-user-name' | translate }}</mat-label>\r\n                <input matInput formControlName=\"userName\" required />\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"{{ 'custom.gateways.edit-gateway-copy-user-name' | translate }}\" (click)=\"copyToClipboard($event, 'credentialsDetails.userName')\">\r\n                  <mat-icon>content_copy</mat-icon>\r\n                </button>\r\n                <mat-error *ngIf=\"editDeviceFormGroup.get('credentialsDetails.userName').hasError('required')\">{{ 'device.user-name-required' | translate }}</mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>{{ 'custom.gateways.edit-gateway-password' | translate }}</mat-label>\r\n                <input matInput [type]=\"hidePassword ? 'password' : 'text'\" formControlName=\"password\" readonly/>\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"{{ hidePassword ? ('custom.gateways.edit-gateway-show-password' | translate) : 'Hide Password' }}\" (click)=\"togglePasswordVisibility()\">\r\n                    <mat-icon>{{ hidePassword ? 'visibility' : 'visibility_off' }}</mat-icon>\r\n                </button>\r\n                <button mat-icon-button type=\"button\" matSuffix [matTooltip]=\"'custom.gateways.edit-gateway-copy-password' | translate\" (click)=\"copyToClipboard($event, 'credentialsDetails.password')\">\r\n                    <mat-icon>content_copy</mat-icon>\r\n                </button>\r\n                <button mat-icon-button type=\"button\" matSuffix [matTooltip]=\"'custom.gateways.edit-gateway-generate-new-password' | translate\" (click)=\"generatePassword()\">\r\n                    <mat-icon>autorenew</mat-icon>\r\n                  </button>\r\n              </mat-form-field>\r\n          </div>\r\n          \r\n          <!-- ACCESS_TOKEN Fields -->\r\n          <div *ngIf=\"editDeviceFormGroup.get('credentialsDetails').get('credentialsType').value === 'ACCESS_TOKEN'\">\r\n            <div class=\"flex flex-col justify-evenly items-stretch flex-auto w-full h-full\">\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>Credentials ID</mat-label>\r\n                <input matInput formControlName=\"credentialsId\" required>\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"Copy Credentials ID\" (click)=\"copyToClipboard($event, 'credentialsDetails.credentialsId')\">\r\n                    <mat-icon>content_copy</mat-icon>\r\n                </button>\r\n                <mat-error *ngIf=\"editDeviceFormGroup.get('credentialsDetails.credentialsId').hasError('required')\">\r\n                    {{ 'custom.retrofit-companies.add-company-credentials-id-is-required' | translate }}\r\n                </mat-error>\r\n              </mat-form-field>\r\n              <br>\r\n            </div>\r\n          </div>\r\n          \r\n          <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n              <button mat-button matStepperPrevious type=\"button\"> {{ 'custom.gateways.edit-gateway-back' | translate }}</button>\r\n              <button mat-button mat-raised-button color=\"primary\" type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || editDeviceFormGroup.invalid || !editDeviceFormGroup.dirty\">\r\n                {{ 'custom.gateways.edit-gateway-update-device' | translate }}\r\n              </button>\r\n            </div>\r\n        </div>\r\n      </mat-step>\r\n      \r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>\r\n",
                "customCss": "\n.device-item {\n    line-height: 24px;\n    width: 100%;\n    padding-top: 8px;\n    padding-bottom: 8px;\n}\n\n.device-item .device-name {\n    font-size: 12px;\n    opacity: 0.7;\n}\n\n.device-item .device-type {\n    font-size: 14px;\n    opacity: 0.7;\n}\n\nmat-option {\n    height: auto !important;\n    white-space: normal !important;\n}\n\n.mat-select-value-text {\n    display: block;\n    width: 100%;\n}\n\n/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\n\r\nconst { mergeMap, of } = widgetContext.rxjs;\r\n\r\nopenEditDeviceDialog();\r\n\r\nfunction openEditDeviceDialog() {\r\n  customDialog.customDialog(htmlTemplate, EditDeviceDialogController).subscribe();\r\n}\r\n\r\nfunction EditDeviceDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.deviceTypes = [\r\n      'MUC',\r\n      'LoRaWAN Gateway',\r\n      'IoT Gateway',\r\n      'RESI'\r\n  ];\r\n\r\n  vm.device = {};\r\n  vm.credentials = {};\r\n  vm.hidePassword = true;\r\n\r\n  vm.editDeviceFormGroup = vm.fb.group({\r\n    gatewayDetails: vm.fb.group({\r\n      name: ['', [vm.validators.required]],\r\n      type: ['', [vm.validators.required]],\r\n      label: ['']\r\n    }),\r\n    simDetails: vm.fb.group({\r\n      ICCID: [''],\r\n      statusSIM: [''],\r\n      carrierSIM: ['']\r\n    }),\r\n    credentialsDetails: vm.fb.group({\r\n      clientId:[''],\r\n      userName:[''],\r\n      password: [''],\r\n      credentialsId:[''],\r\n      credentialsType:['']\r\n    })\r\n  });\r\n\r\n  getDevice();\r\n\r\n  vm.cancel = function() {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  vm.save = function() {\r\n    saveDevice().pipe(\r\n      mergeMap(() => {\r\n        if (vm.editDeviceFormGroup.get('credentialsDetails').dirty) {\r\n          return updateDeviceCredentials(vm.device.id);\r\n        }\r\n        return of(null);\r\n      })\r\n    ).subscribe(\r\n      function () {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n      },\r\n      function (error) {\r\n        console.error('Failed to save device or credentials:', error);\r\n        widgetContext.showErrorToast(`Failed to save device or credentials: ${error.message}`, 4000, 'top', 'center');\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.copyToClipboard = function (event, controlName) {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const value = vm.editDeviceFormGroup.get(controlName.split('.')).value;\r\n    navigator.clipboard.writeText(value).then(() => {\r\n      widgetContext.showSuccessToast(\r\n        'Copied to clipboard!',\r\n        2000,\r\n        'top',\r\n        'center'\r\n      );\r\n    }).catch((err) => {\r\n      widgetContext.showErrorToast(\r\n        'Failed to copy to clipboard.',\r\n        2000,\r\n        'top',\r\n        'center'\r\n      );\r\n    });\r\n  };\r\n\r\n  vm.togglePasswordVisibility = function () {\r\n    vm.hidePassword = !vm.hidePassword;\r\n  };\r\n\r\n  vm.generatePassword = function() {\r\n    const newPassword = generatePassword();\r\n    vm.editDeviceFormGroup.get('credentialsDetails.password').setValue(newPassword);\r\n    vm.editDeviceFormGroup.get('credentialsDetails').markAsDirty(); \r\n  };\r\n\r\n  function generatePassword() {\r\n    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\r\n    let password = '';\r\n    for (let i = 0; i < 20; i++) {\r\n      password += chars.charAt(Math.floor(Math.random() * chars.length));\r\n    }\r\n    return password;\r\n  }\r\n\r\n  function getDevice() {\r\n    deviceService.getDevice(entityId.id).subscribe(\r\n      function (device) {\r\n        vm.device = device;\r\n        attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE', ['connectivity']).subscribe(\r\n          function (attributes) {\r\n            if (attributes && attributes.length > 0) {\r\n              const connectivity = attributes.find(attr => attr.key === 'connectivity').value;\r\n              vm.editDeviceFormGroup.get('simDetails').patchValue({\r\n                ICCID: connectivity.ICCID,\r\n                carrierSIM: connectivity.carrier,\r\n                statusSIM: connectivity.simStatus\r\n              });\r\n            }\r\n\r\n            vm.editDeviceFormGroup.get('gatewayDetails').patchValue({\r\n              name: vm.device.name,\r\n              type: vm.device.type,\r\n              label: vm.device.label\r\n            });\r\n\r\n            getDeviceCredentials(entityId.id);\r\n          },\r\n          function (error) {\r\n            console.error('Failed to fetch attributes:', error);\r\n          }\r\n        );\r\n      }\r\n    );\r\n  }\r\n\r\n  function getDeviceCredentials(eid) {\r\n    deviceService.getDeviceCredentials(eid).subscribe(\r\n      (credentials) => {\r\n        let credentialsObject = { credentialsType: credentials.credentialsType };\r\n\r\n        if (credentials.credentialsType === \"MQTT_BASIC\") {\r\n          let credentialsValue = JSON.parse(credentials.credentialsValue);\r\n          credentialsObject.clientId = credentialsValue.clientId;\r\n          credentialsObject.userName = credentialsValue.userName;\r\n          credentialsObject.password = credentialsValue.password;\r\n        } else if (credentials.credentialsType === \"ACCESS_TOKEN\") {\r\n          const credentialsValue = credentials.credentialsValue ? JSON.parse(credentials.credentialsValue) : null;\r\n          if (credentialsValue && credentialsValue.credentialsId) {\r\n            credentialsObject.credentialsId = credentialsValue.credentialsId;\r\n          } else {\r\n            credentialsObject.credentialsId = '';\r\n            console.warn('Missing credentialsId in the device credentials.');\r\n          }\r\n        }\r\n\r\n        vm.credentials = credentialsObject;\r\n\r\n        vm.editDeviceFormGroup.get('credentialsDetails').patchValue({\r\n          credentialsType: credentialsObject.credentialsType || '',\r\n          clientId: credentialsObject.clientId || '',\r\n          userName: credentialsObject.userName || '',\r\n          password: credentialsObject.password || '',\r\n          credentialsId: credentialsObject.credentialsId || ''\r\n        });\r\n\r\n        vm.editDeviceFormGroup.markAsPristine();\r\n        vm.editDeviceFormGroup.markAsUntouched();\r\n        vm.editDeviceFormGroup.updateValueAndValidity();\r\n      },\r\n      (error) => {\r\n        console.error('Failed to load device credentials:', error);\r\n      }\r\n    );\r\n  }\r\n\r\n  function saveDevice() {\r\n    const gatewayValues = vm.editDeviceFormGroup.get('gatewayDetails').value;\r\n    const simValues = vm.editDeviceFormGroup.get('simDetails').value;\r\n\r\n    vm.device.name = gatewayValues.name;\r\n    if (vm.device.type !== gatewayValues.type) {\r\n      vm.device.type = gatewayValues.type;\r\n      vm.device.deviceProfileId = null;\r\n    }\r\n    vm.device.label = gatewayValues.label;\r\n\r\n    const attributes = [\r\n      {\r\n        key: 'connectivity',\r\n        value: {\r\n          ICCID: simValues.ICCID,\r\n          carrier: simValues.carrierSIM,\r\n          simStatus: simValues.statusSIM\r\n        }\r\n      }\r\n    ];\r\n\r\n    return deviceService.saveDevice(vm.device).pipe(\r\n      mergeMap(() => {\r\n        return attributeService.saveEntityAttributes(entityId, 'SERVER_SCOPE', attributes);\r\n      })\r\n    );\r\n  }\r\n\r\n  function updateDeviceCredentials(eid) {\r\n    return deviceService.getDeviceCredentials(eid).pipe(\r\n      mergeMap(existingCredentials => {\r\n        const credentialsValues = vm.editDeviceFormGroup.get('credentialsDetails').value;\r\n        let newCredentials = {\r\n          id: existingCredentials.id,\r\n          deviceId: existingCredentials.deviceId,\r\n          credentialsType: credentialsValues.credentialsType\r\n        };\r\n\r\n        if (credentialsValues.credentialsType === 'MQTT_BASIC') {\r\n          newCredentials.credentialsValue = JSON.stringify({\r\n            clientId: credentialsValues.clientId,\r\n            userName: credentialsValues.userName,\r\n            password: credentialsValues.password\r\n          });\r\n        } else if (credentialsValues.credentialsType === 'ACCESS_TOKEN') {\r\n          newCredentials.credentialsValue = JSON.stringify({\r\n            credentialsId: credentialsValues.credentialsId\r\n          });\r\n        }\r\n\r\n        return deviceService.saveDeviceCredentials(newCredentials);\r\n      })\r\n    );\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7e870fd2-9559-9a6e-d847-beefc971ecaa"
              },
              {
                "name": "{i18n:custom.gateways.delete-device}",
                "icon": "delete",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteDeviceDialog();\n\nfunction openDeleteDeviceDialog() {\n  let titleTranslation = translationService.instant(\n    'custom.gateways.delete-device-title',\n    { entityName: entityName }\n  );\n\n  let contentTranslation = translationService.instant(\n    'custom.gateways.delete-device-content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteDevice();\n    }\n  });\n}\n\nfunction deleteDevice() {\n  deviceService.deleteDevice(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "70f87b5b-3dbc-91e6-0e59-80511b0be772"
              }
            ]
          },
          "titleIcon": "devices_other",
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "28px",
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "0c7469aa-7b86-be27-5216-bc6cc702f8b1",
        "typeFullFqn": "system.cards.entities_table"
      },
      "3c990db9-ab04-d3a5-ae24-bc58de2fbc94": {
        "typeFullFqn": "system.cards.entities_table",
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1713435502260,
                "endTimeMs": 1713521902260
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "enableSearch": true,
            "enableSelectColumnDisplay": true,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "displayEntityLabel": false,
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "name",
            "useRowStyleFunction": false,
            "entitiesTitle": "Entities"
          },
          "title": "Entities table",
          "dropShadow": true,
          "enableFullscreen": true,
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400,
            "padding": "5px 10px 5px 10px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "d13f6078-0d81-ec59-529c-64acbbcaf470",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Name",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.1849002505353028
                },
                {
                  "name": "active",
                  "type": "attribute",
                  "label": "active",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.8128568406469565,
                  "decimals": 0
                },
                {
                  "name": "type",
                  "type": "entityField",
                  "label": "Type",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.3089029814236317,
                  "decimals": 0
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.9719730919393044,
                  "decimals": 0
                },
                {
                  "name": "licenseActivationStatus",
                  "type": "attribute",
                  "label": "licenseActivationStatus",
                  "color": "#607d8b",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar licenseActivationStatus = value;\r\nif (licenseActivationStatus == 'true') { // all key values here are strings\r\n  color = '#27AE60';\r\n} else {\r\n  color = '#EB5757';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span>';\r\n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.10755740653396839,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "displayTimewindow": false,
          "configMode": "advanced",
          "actions": {
            "actionCellButton": [
              {
                "name": "Add Device to Doctorkit",
                "icon": "medical_services",
                "useShowWidgetActionFunction": false,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<!--=======================================================================-->\n<!--=====  There are two example templates: for edit and add entity   =====-->\n<!--=======================================================================-->\n<!--========================  Edit entity example  ========================-->\n<!--=======================================================================-->\n<!-- -->\n<!--<form #editEntityForm=\"ngForm\" [formGroup]=\"editEntityFormGroup\"-->\n<!--      (ngSubmit)=\"save()\"  class=\"edit-entity-form\">-->\n<!--    <mat-toolbar fxLayout=\"row\" color=\"primary\">-->\n<!--        <h2>Edit {{entityType.toLowerCase()}} {{entityName}}</h2>-->\n<!--        <span fxFlex></span>-->\n<!--        <button mat-icon-button (click)=\"cancel()\" type=\"button\">-->\n<!--            <mat-icon class=\"material-icons\">close</mat-icon>-->\n<!--        </button>-->\n<!--    </mat-toolbar>-->\n<!--    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">-->\n<!--    </mat-progress-bar>-->\n<!--    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>-->\n<!--    <div mat-dialog-content fxLayout=\"column\">-->\n<!--        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Name</mat-label>-->\n<!--                <input matInput formControlName=\"entityName\" required readonly=\"\">-->\n<!--            </mat-form-field>-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Label</mat-label>-->\n<!--                <input matInput formControlName=\"entityLabel\">-->\n<!--            </mat-form-field>-->\n<!--        </div>-->\n<!--        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Type</mat-label>-->\n<!--                <input matInput formControlName=\"entityType\" readonly>-->\n<!--            </mat-form-field>-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Type</mat-label>-->\n<!--                <input matInput formControlName=\"type\" readonly>-->\n<!--            </mat-form-field>-->\n<!--        </div>-->\n<!--        <div formGroupName=\"attributes\" fxLayout=\"column\">-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Latitude</mat-label>-->\n<!--                    <input type=\"number\" step=\"any\" matInput formControlName=\"latitude\">-->\n<!--                </mat-form-field>-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Longitude</mat-label>-->\n<!--                    <input type=\"number\" step=\"any\" matInput formControlName=\"longitude\">-->\n<!--                </mat-form-field>-->\n<!--            </div>-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Address</mat-label>-->\n<!--                    <input matInput formControlName=\"address\">-->\n<!--                </mat-form-field>-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Owner</mat-label>-->\n<!--                    <input matInput formControlName=\"owner\">-->\n<!--                </mat-form-field>-->\n<!--            </div>-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Integer Value</mat-label>-->\n<!--                    <input type=\"number\" step=\"1\" matInput formControlName=\"number\">-->\n<!--                    <mat-error *ngIf=\"editEntityFormGroup.get('attributes.number').hasError('pattern')\">-->\n<!--                        Invalid integer value.-->\n<!--                    </mat-error>-->\n<!--                </mat-form-field>-->\n<!--                <div class=\"boolean-value-input\" fxLayout=\"column\" fxLayoutAlign=\"center start\" fxFlex>-->\n<!--                    <label class=\"checkbox-label\">Boolean Value</label>-->\n<!--                    <mat-checkbox formControlName=\"booleanValue\" style=\"margin-bottom: 40px;\">-->\n<!--                        {{ (editEntityFormGroup.get('attributes.booleanValue').value ? \"value.true\" : \"value.false\") | translate }}-->\n<!--                    </mat-checkbox>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--        <div class=\"relations-list old-relations\">-->\n<!--            <div class=\"mat-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">Relations</div>-->\n<!--            <div class=\"body\" [fxShow]=\"oldRelations().length\">-->\n<!--                <div class=\"row\" fxLayout=\"row\" fxLayoutAlign=\"start center\" formArrayName=\"oldRelations\" -->\n<!--                     *ngFor=\"let relation of oldRelations().controls; let i = index;\">-->\n<!--                    <div [formGroupName]=\"i\" class=\"mat-elevation-z2\" fxFlex fxLayout=\"row\" style=\"padding: 5px 0 5px 5px;\">-->\n<!--                        <div fxFlex fxLayout=\"column\">-->\n<!--                            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                                <mat-form-field class=\"mat-block\" style=\"min-width: 100px;\">-->\n<!--                                    <mat-label>Direction</mat-label>-->\n<!--                                    <mat-select formControlName=\"direction\" name=\"direction\">-->\n<!--                                        <mat-option *ngFor=\"let direction of entitySearchDirection | keyvalue\" [value]=\"direction.value\">-->\n<!--                                            {{ (\"relation.search-direction.\" + direction.value) | translate}}-->\n<!--                                        </mat-option>-->\n<!--                                    </mat-select>-->\n<!--                                    <mat-error *ngIf=\"relation.get('direction').hasError('required')\">-->\n<!--                                        Relation direction is required.-->\n<!--                                    </mat-error>-->\n<!--                                </mat-form-field>-->\n<!--                                <tb-relation-type-autocomplete-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        formControlName=\"relationType\"-->\n<!--                                        required=\"true\">-->\n<!--                                </tb-relation-type-autocomplete>-->\n<!--                            </div>-->\n<!--                            <div fxLayout=\"row\" fxLayout.xs=\"column\">-->\n<!--                                <tb-entity-select-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        required=\"true\"-->\n<!--                                        formControlName=\"relatedEntity\">-->\n<!--                                </tb-entity-select>-->\n<!--                            </div>-->\n<!--                        </div>-->\n<!--                        <div fxLayout=\"column\" fxLayoutAlign=\"center center\">-->\n<!--                            <button mat-icon-button color=\"primary\"-->\n<!--                                    aria-label=\"Remove\"-->\n<!--                                    type=\"button\"-->\n<!--                                    (click)=\"removeOldRelation(i, relation.value)\"-->\n<!--                                    matTooltip=\"Remove relation\"-->\n<!--                                    matTooltipPosition=\"above\">-->\n<!--                                <mat-icon>close</mat-icon>-->\n<!--                            </button>-->\n<!--                        </div>-->\n<!--                    </div>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--        <div class=\"relations-list\">-->\n<!--            <div class=\"mat-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">New Relations</div>-->\n<!--            <div class=\"body\" [fxShow]=\"relations().length\">-->\n<!--                <div class=\"row\" fxLayout=\"row\" fxLayoutAlign=\"start center\" formArrayName=\"relations\" *ngFor=\"let relation of relations().controls; let i = index;\">-->\n<!--                    <div [formGroupName]=\"i\" class=\"mat-elevation-z2\" fxFlex fxLayout=\"row\" style=\"padding: 5px 0 5px 5px;\">-->\n<!--                        <div fxFlex fxLayout=\"column\">-->\n<!--                            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                                <mat-form-field class=\"mat-block\" style=\"min-width: 100px;\">-->\n<!--                                    <mat-label>Direction</mat-label>-->\n<!--                                    <mat-select formControlName=\"direction\" name=\"direction\">-->\n<!--                                        <mat-option *ngFor=\"let direction of entitySearchDirection | keyvalue\" [value]=\"direction.value\">-->\n<!--                                            {{ (\"relation.search-direction.\" + direction.value) | translate}}-->\n<!--                                        </mat-option>-->\n<!--                                    </mat-select>-->\n<!--                                    <mat-error *ngIf=\"relation.get('direction').hasError('required')\">-->\n<!--                                        Relation direction is required.-->\n<!--                                    </mat-error>-->\n<!--                                </mat-form-field>-->\n<!--                                <tb-relation-type-autocomplete-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        formControlName=\"relationType\"-->\n<!--                                        [required]=\"true\">-->\n<!--                                </tb-relation-type-autocomplete>-->\n<!--                            </div>-->\n<!--                            <div fxLayout=\"row\" fxLayout.xs=\"column\">-->\n<!--                                <tb-entity-select-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        [required]=\"true\"-->\n<!--                                        formControlName=\"relatedEntity\">-->\n<!--                                </tb-entity-select>-->\n<!--                            </div>-->\n<!--                        </div>-->\n<!--                        <div fxLayout=\"column\" fxLayoutAlign=\"center center\">-->\n<!--                            <button mat-icon-button color=\"primary\"-->\n<!--                                    aria-label=\"Remove\"-->\n<!--                                    type=\"button\"-->\n<!--                                    (click)=\"removeRelation(i)\"-->\n<!--                                    matTooltip=\"Remove relation\"-->\n<!--                                    matTooltipPosition=\"above\">-->\n<!--                                <mat-icon>close</mat-icon>-->\n<!--                            </button>-->\n<!--                        </div>-->\n<!--                    </div>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--            <div>-->\n<!--                <button mat-raised-button color=\"primary\"-->\n<!--                        type=\"button\"-->\n<!--                        (click)=\"addRelation()\"-->\n<!--                        matTooltip=\"Add Relation\"-->\n<!--                        matTooltipPosition=\"above\">-->\n<!--                    Add-->\n<!--                </button>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--    </div>-->\n<!--    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">-->\n<!--        <button mat-button color=\"primary\"-->\n<!--                type=\"button\"-->\n<!--                [disabled]=\"(isLoading$ | async)\"-->\n<!--                (click)=\"cancel()\" cdkFocusInitial>-->\n<!--            Cancel-->\n<!--        </button>-->\n<!--        <button mat-button mat-raised-button color=\"primary\"-->\n<!--                type=\"submit\"-->\n<!--                [disabled]=\"(isLoading$ | async) || editEntityForm.invalid || !editEntityForm.dirty\">-->\n<!--            Save-->\n<!--        </button>-->\n<!--    </div>-->\n<!--</form>-->\n<!---->\n<!--========================================================================-->\n<!--=========================  Add entity example  =========================-->\n<!--========================================================================-->\n<!---->\n<!--<form #addEntityForm=\"ngForm\" [formGroup]=\"addEntityFormGroup\"-->\n<!--      (ngSubmit)=\"save()\" class=\"add-entity-form\">-->\n<!--    <mat-toolbar fxLayout=\"row\" color=\"primary\">-->\n<!--        <h2>Add entity</h2>-->\n<!--        <span fxFlex></span>-->\n<!--        <button mat-icon-button (click)=\"cancel()\" type=\"button\">-->\n<!--            <mat-icon class=\"material-icons\">close</mat-icon>-->\n<!--        </button>-->\n<!--    </mat-toolbar>-->\n<!--    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">-->\n<!--    </mat-progress-bar>-->\n<!--    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>-->\n<!--    <div mat-dialog-content fxLayout=\"column\">-->\n<!--        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Name</mat-label>-->\n<!--                <input matInput formControlName=\"entityName\" required>-->\n<!--                <mat-error *ngIf=\"addEntityFormGroup.get('entityName').hasError('required')\">-->\n<!--                    Entity name is required.-->\n<!--                </mat-error>-->\n<!--            </mat-form-field>-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Label</mat-label>-->\n<!--                <input matInput formControlName=\"entityLabel\" >-->\n<!--            </mat-form-field>-->\n<!--        </div>-->\n<!--        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--            <tb-entity-type-select-->\n<!--                    class=\"mat-block\"-->\n<!--                    formControlName=\"entityType\"-->\n<!--                    [showLabel]=\"true\"-->\n<!--                    [allowedEntityTypes]=\"allowedEntityTypes\"-->\n<!--            ></tb-entity-type-select>-->\n<!--            <tb-entity-subtype-autocomplete-->\n<!--                    fxFlex *ngIf=\"addEntityFormGroup.get('entityType').value == 'ASSET'\"-->\n<!--                    class=\"mat-block\"-->\n<!--                    formControlName=\"type\"-->\n<!--                    [required]=\"true\"-->\n<!--                    [entityType]=\"'ASSET'\"-->\n<!--            ></tb-entity-subtype-autocomplete>-->\n<!--            <tb-entity-subtype-autocomplete-->\n<!--                    fxFlex *ngIf=\"addEntityFormGroup.get('entityType').value != 'ASSET'\"-->\n<!--                    class=\"mat-block\"-->\n<!--                    formControlName=\"type\"-->\n<!--                    [required]=\"true\"-->\n<!--                    [entityType]=\"'DEVICE'\"-->\n<!--            ></tb-entity-subtype-autocomplete>-->\n<!--        </div>-->\n<!--        <div formGroupName=\"attributes\" fxLayout=\"column\">-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Latitude</mat-label>-->\n<!--                    <input type=\"number\" step=\"any\" matInput formControlName=\"latitude\">-->\n<!--                </mat-form-field>-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Longitude</mat-label>-->\n<!--                    <input type=\"number\" step=\"any\" matInput formControlName=\"longitude\">-->\n<!--                </mat-form-field>-->\n<!--            </div>-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Address</mat-label>-->\n<!--                    <input matInput formControlName=\"address\">-->\n<!--                </mat-form-field>-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Owner</mat-label>-->\n<!--                    <input matInput formControlName=\"owner\">-->\n<!--                </mat-form-field>-->\n<!--            </div>-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Integer Value</mat-label>-->\n<!--                    <input type=\"number\" step=\"1\" matInput formControlName=\"number\">-->\n<!--                    <mat-error *ngIf=\"addEntityFormGroup.get('attributes.number').hasError('pattern')\">-->\n<!--                        Invalid integer value.-->\n<!--                    </mat-error>-->\n<!--                </mat-form-field>-->\n<!--                <div class=\"boolean-value-input\" fxLayout=\"column\" fxLayoutAlign=\"center start\" fxFlex>-->\n<!--                    <label class=\"checkbox-label\">Boolean Value</label>-->\n<!--                    <mat-checkbox formControlName=\"booleanValue\" style=\"margin-bottom: 40px;\">-->\n<!--                        {{ (addEntityFormGroup.get('attributes.booleanValue').value ? \"value.true\" : \"value.false\") | translate }}-->\n<!--                    </mat-checkbox>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--        <div class=\"relations-list\">-->\n<!--            <div class=\"mat-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">Relations</div>-->\n<!--            <div class=\"body\" [fxShow]=\"relations().length\">-->\n<!--                <div class=\"row\" fxLayout=\"row\" fxLayoutAlign=\"start center\" formArrayName=\"relations\" *ngFor=\"let relation of relations().controls; let i = index;\">-->\n<!--                    <div [formGroupName]=\"i\" class=\"mat-elevation-z2\" fxFlex fxLayout=\"row\" style=\"padding: 5px 0 5px 5px;\">-->\n<!--                        <div fxFlex fxLayout=\"column\">-->\n<!--                            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                                <mat-form-field class=\"mat-block\" style=\"min-width: 100px;\">-->\n<!--                                    <mat-label>Direction</mat-label>-->\n<!--                                    <mat-select formControlName=\"direction\" name=\"direction\">-->\n<!--                                        <mat-option *ngFor=\"let direction of entitySearchDirection | keyvalue\" [value]=\"direction.value\">-->\n<!--                                            {{ (\"relation.search-direction.\" + direction.value) | translate}}-->\n<!--                                        </mat-option>-->\n<!--                                    </mat-select>-->\n<!--                                    <mat-error *ngIf=\"relation.get('direction').hasError('required')\">-->\n<!--                                        Relation direction is required.-->\n<!--                                    </mat-error>-->\n<!--                                </mat-form-field>-->\n<!--                                <tb-relation-type-autocomplete-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        formControlName=\"relationType\"-->\n<!--                                        [required]=\"true\">-->\n<!--                                </tb-relation-type-autocomplete>-->\n<!--                            </div>-->\n<!--                            <div fxLayout=\"row\" fxLayout.xs=\"column\">-->\n<!--                                <tb-entity-select-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        [required]=\"true\"-->\n<!--                                        formControlName=\"relatedEntity\">-->\n<!--                                </tb-entity-select>-->\n<!--                            </div>-->\n<!--                        </div>-->\n<!--                        <div fxLayout=\"column\" fxLayoutAlign=\"center center\">-->\n<!--                            <button mat-icon-button color=\"primary\"-->\n<!--                                    aria-label=\"Remove\"-->\n<!--                                    type=\"button\"-->\n<!--                                    (click)=\"removeRelation(i)\"-->\n<!--                                    matTooltip=\"Remove relation\"-->\n<!--                                    matTooltipPosition=\"above\">-->\n<!--                                <mat-icon>close</mat-icon>-->\n<!--                            </button>-->\n<!--                        </div>-->\n<!--                    </div>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--            <div>-->\n<!--                <button mat-raised-button color=\"primary\"-->\n<!--                        type=\"button\"-->\n<!--                        (click)=\"addRelation()\"-->\n<!--                        matTooltip=\"Add Relation\"-->\n<!--                        matTooltipPosition=\"above\">-->\n<!--                    Add-->\n<!--                </button>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--    </div>-->\n<!--    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">-->\n<!--        <button mat-button color=\"primary\"-->\n<!--                type=\"button\"-->\n<!--                [disabled]=\"(isLoading$ | async)\"-->\n<!--                (click)=\"cancel()\" cdkFocusInitial>-->\n<!--            Cancel-->\n<!--        </button>-->\n<!--        <button mat-button mat-raised-button color=\"primary\"-->\n<!--                type=\"submit\"-->\n<!--                [disabled]=\"(isLoading$ | async) || addEntityForm.invalid || !addEntityForm.dirty\">-->\n<!--            Create-->\n<!--        </button>-->\n<!--    </div>-->\n<!--</form>-->\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "/*=======================================================================*/\n/*=====  There are three examples: for delete, edit and add entity  =====*/\n/*=======================================================================*/\n/*=======================  Delete entity example  =======================*/\n/*=======================================================================*/\n//\n//let $injector = widgetContext.$scope.$injector;\n//let dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\n//let assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n//let deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\n//\n//openDeleteEntityDialog();\n//\n//function openDeleteEntityDialog() {\n//    let title = 'Delete ' + entityId.entityType.toLowerCase() + ' ' +\n//                 entityName;\n//    let content = 'Are you sure you want to delete the ' +\n//                  entityId.entityType.toLowerCase() + ' ' + entityName + '?';\n//    dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n//        function(result) {\n//            if (result) {\n//                deleteEntity();\n//            }\n//        }\n//    );\n//}\n//\n//function deleteEntity() {\n//    deleteEntityObservable(entityId).subscribe(\n//        function success() {\n//            widgetContext.updateAliases();\n//        },\n//        function fail() {\n//            showErrorDialog();\n//        }\n//    );\n//}\n//\n//function deleteEntityObservable(entityId) {\n//    if (entityId.entityType == \"ASSET\") {\n//        return assetService.deleteAsset(entityId.id);\n//    } else if (entityId.entityType == \"DEVICE\") {\n//        return deviceService.deleteDevice(entityId.id);\n//    }\n//}\n//\n//function showErrorDialog() {\n//    let title = 'Error';\n//    let content = 'An error occurred while deleting the entity. Please try again.';\n//    dialogs.alert(title, content, 'CLOSE').subscribe(\n//        function(result) {}\n//    );\n//}\n//\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n//\n//let $injector = widgetContext.$scope.$injector;\n//let customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\n//let entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\n//let assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n//let deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\n//let attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n//let entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\n//\n//openEditEntityDialog();\n//\n//function openEditEntityDialog() {\n//    customDialog.customDialog(htmlTemplate, EditEntityDialogController).subscribe();\n//}\n//\n//function EditEntityDialogController(instance) {\n//    let vm = instance;\n//\n//    vm.entityName = entityName;\n//    vm.entityType = entityId.entityType;\n//    vm.entitySearchDirection = {\n//        from: \"FROM\",\n//        to: \"TO\"\n//    };\n//    vm.attributes = {};\n//    vm.oldRelationsData = [];\n//    vm.relationsToDelete = [];\n//    vm.entity = {};\n//\n//    vm.editEntityFormGroup = vm.fb.group({\n//        entityName: ['', [vm.validators.required]],\n//        entityType: [null],\n//        entityLabel: [null],\n//        type: ['', [vm.validators.required]],\n//        attributes: vm.fb.group({\n//            latitude: [null],\n//            longitude: [null],\n//            address: [null],\n//            owner: [null],\n//            number: [null, [vm.validators.pattern(/^-?[0-9]+$/)]],\n//            booleanValue: [false]\n//        }),\n//        oldRelations: vm.fb.array([]),\n//        relations: vm.fb.array([])\n//    });\n//\n//    getEntityInfo();\n//\n//    vm.cancel = function() {\n//        vm.dialogRef.close(null);\n//    };\n//\n//    vm.relations = function() {\n//        return vm.editEntityFormGroup.get('relations');\n//    };\n//\n//    vm.oldRelations = function() {\n//        return vm.editEntityFormGroup.get('oldRelations');\n//    };\n//\n//    vm.addRelation = function() {\n//        vm.relations().push(vm.fb.group({\n//            relatedEntity: [null, [vm.validators.required]],\n//            relationType: [null, [vm.validators.required]],\n//            direction: [null, [vm.validators.required]]\n//        }));\n//    };\n//\n//    function addOldRelation() {\n//        vm.oldRelations().push(vm.fb.group({\n//            relatedEntity: [{value: null, disabled: true}, [vm.validators.required]],\n//            relationType: [{value: null, disabled: true}, [vm.validators.required]],\n//            direction: [{value: null, disabled: true}, [vm.validators.required]]\n//        }));\n//    }\n//\n//    vm.removeRelation = function(index) {\n//        vm.relations().removeAt(index);\n//        vm.relations().markAsDirty();\n//    };\n//\n//    vm.removeOldRelation = function(index, relation) {\n//        vm.oldRelations().removeAt(index);\n//        vm.relationsToDelete.push(relation);\n//        vm.oldRelations().markAsDirty();\n//    };\n//\n//    vm.save = function() {\n//        vm.editEntityFormGroup.markAsPristine();\n//        widgetContext.rxjs.forkJoin([\n//            saveAttributes(entityId),\n//            saveRelations(entityId),\n//            saveEntity()\n//        ]).subscribe(\n//            function () {\n//                widgetContext.updateAliases();\n//                vm.dialogRef.close(null);\n//            }\n//        );\n//    };\n//\n//    function getEntityAttributes(attributes) {\n//        for (var i = 0; i < attributes.length; i++) {\n//            vm.attributes[attributes[i].key] = attributes[i].value;\n//        }\n//    }\n//\n//    function getEntityRelations(relations) {\n//        let relationsFrom = relations[0];\n//        let relationsTo = relations[1];\n//        for (let i=0; i < relationsFrom.length; i++) {\n//            let relation = {\n//                direction: 'FROM',\n//                relationType: relationsFrom[i].type,\n//                relatedEntity: relationsFrom[i].to\n//            };\n//            vm.oldRelationsData.push(relation);\n//            addOldRelation();\n//        }\n//        for (let i=0; i < relationsTo.length; i++) {\n//            let relation = {\n//                direction: 'TO',\n//                relationType: relationsTo[i].type,\n//                relatedEntity: relationsTo[i].from\n//            };\n//            vm.oldRelationsData.push(relation);\n//            addOldRelation();\n//        }\n//    }\n//\n//    function getEntityInfo() {\n//         widgetContext.rxjs.forkJoin([\n//             entityRelationService.findInfoByFrom(entityId),\n//             entityRelationService.findInfoByTo(entityId),\n//             attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE'),\n//             entityService.getEntity(entityId.entityType, entityId.id)\n//         ]).subscribe(\n//             function (data) {\n//                 getEntityRelations(data.slice(0,2));\n//                 getEntityAttributes(data[2]);\n//                 vm.entity = data[3];\n//                 vm.editEntityFormGroup.patchValue({\n//                     entityName: vm.entity.name,\n//                     entityType: vm.entityType,\n//                     entityLabel: vm.entity.label,\n//                     type: vm.entity.type,\n//                     attributes: vm.attributes,\n//                     oldRelations: vm.oldRelationsData\n//                 }, {emitEvent: false});\n//             }\n//         );\n//     }\n//\n//    function saveEntity() {\n//        const formValues = vm.editEntityFormGroup.value;\n//        if (vm.entity.label !== formValues.entityLabel){\n//            vm.entity.label = formValues.entityLabel;\n//            if (formValues.entityType == 'ASSET') {\n//                return assetService.saveAsset(vm.entity);\n//            } else if (formValues.entityType == 'DEVICE') {\n//                return deviceService.saveDevice(vm.entity);\n//            }\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//\n//    function saveAttributes(entityId) {\n//        let attributes = vm.editEntityFormGroup.get('attributes').value;\n//        let attributesArray = [];\n//        for (let key in attributes) {\n//            if (attributes[key] !== vm.attributes[key]) {\n//                attributesArray.push({key: key, value: attributes[key]});\n//            }\n//        }\n//        if (attributesArray.length > 0) {\n//            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//\n//    function saveRelations(entityId) {\n//        let relations = vm.editEntityFormGroup.get('relations').value;\n//        let tasks = [];\n//        for(let i=0; i < relations.length; i++) {\n//            let relation = {\n//                type: relations[i].relationType,\n//                typeGroup: 'COMMON'\n//            };\n//            if (relations[i].direction == 'FROM') {\n//                relation.to = relations[i].relatedEntity;\n//                relation.from = entityId;\n//            } else {\n//                relation.to = entityId;\n//                relation.from = relations[i].relatedEntity;\n//            }\n//            tasks.push(entityRelationService.saveRelation(relation));\n//        }\n//        for (let i=0; i < vm.relationsToDelete.length; i++) {\n//            let relation = {\n//                type: vm.relationsToDelete[i].relationType\n//            };\n//            if (vm.relationsToDelete[i].direction == 'FROM') {\n//                relation.to = vm.relationsToDelete[i].relatedEntity;\n//                relation.from = entityId;\n//            } else {\n//                relation.to = entityId;\n//                relation.from = vm.relationsToDelete[i].relatedEntity;\n//            }\n//            tasks.push(entityRelationService.deleteRelation(relation.from, relation.type, relation.to));\n//        }\n//        if (tasks.length > 0) {\n//            return widgetContext.rxjs.forkJoin(tasks);\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//}\n//\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n//\n//let $injector = widgetContext.$scope.$injector;\n//let customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\n//let assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n//let deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\n//let attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n//let entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\n//\n//openAddEntityDialog();\n//\n//function openAddEntityDialog() {\n//    customDialog.customDialog(htmlTemplate, AddEntityDialogController).subscribe();\n//}\n//\n//function AddEntityDialogController(instance) {\n//    let vm = instance;\n//\n//    vm.allowedEntityTypes = ['ASSET', 'DEVICE'];\n//    vm.entitySearchDirection = {\n//        from: \"FROM\",\n//        to: \"TO\"\n//    }\n//\n//    vm.addEntityFormGroup = vm.fb.group({\n//      entityName: ['', [vm.validators.required]],\n//      entityType: ['DEVICE'],\n//      entityLabel: [null],\n//      type: ['', [vm.validators.required]],\n//      attributes: vm.fb.group({\n//          latitude: [null],\n//          longitude: [null],\n//          address: [null],\n//          owner: [null],\n//          number: [null, [vm.validators.pattern(/^-?[0-9]+$/)]],\n//          booleanValue: [null]\n//      }),\n//      relations: vm.fb.array([])\n//    });\n//\n//    vm.cancel = function() {\n//        vm.dialogRef.close(null);\n//    };\n//\n//    vm.relations = function() {\n//        return vm.addEntityFormGroup.get('relations');\n//    };\n//\n//    vm.addRelation = function() {\n//        vm.relations().push(vm.fb.group({\n//          relatedEntity: [null, [vm.validators.required]],\n//          relationType: [null, [vm.validators.required]],\n//          direction: [null, [vm.validators.required]]\n//        }));\n//    };\n//\n//    vm.removeRelation = function(index) {\n//        vm.relations().removeAt(index);\n//        vm.relations().markAsDirty();\n//    };\n//\n//    vm.save = function() {\n//        vm.addEntityFormGroup.markAsPristine();\n//        saveEntityObservable().subscribe(\n//            function (entity) {\n//                widgetContext.rxjs.forkJoin([\n//                    saveAttributes(entity.id),\n//                    saveRelations(entity.id)\n//                ]).subscribe(\n//                    function () {\n//                        widgetContext.updateAliases();\n//                        vm.dialogRef.close(null);\n//                    }\n//                );\n//            }\n//        );\n//    };\n//\n//    function saveEntityObservable() {\n//        const formValues = vm.addEntityFormGroup.value;\n//        let entity = {\n//            name: formValues.entityName,\n//            type: formValues.type,\n//            label: formValues.entityLabel\n//        };\n//        if (formValues.entityType == 'ASSET') {\n//            return assetService.saveAsset(entity);\n//        } else if (formValues.entityType == 'DEVICE') {\n//            return deviceService.saveDevice(entity);\n//        }\n//    }\n//\n//    function saveAttributes(entityId) {\n//        let attributes = vm.addEntityFormGroup.get('attributes').value;\n//        let attributesArray = [];\n//        for (let key in attributes) {\n//            if(attributes[key] !== null) {\n//                attributesArray.push({key: key, value: attributes[key]});\n//            }\n//        }\n//        if (attributesArray.length > 0) {\n//            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//\n//    function saveRelations(entityId) {\n//        let relations = vm.addEntityFormGroup.get('relations').value;\n//        let tasks = [];\n//        for(let i=0; i < relations.length; i++) {\n//            let relation = {\n//                type: relations[i].relationType,\n//                typeGroup: 'COMMON'\n//            };\n//            if (relations[i].direction == 'FROM') {\n//                relation.to = relations[i].relatedEntity;\n//                relation.from = entityId;\n//            } else {\n//                relation.to = entityId;\n//                relation.from = relations[i].relatedEntity;\n//            }\n//            tasks.push(entityRelationService.saveRelation(relation));\n//        }\n//        if (tasks.length > 0) {\n//            return widgetContext.rxjs.forkJoin(tasks);\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "de8b83e9-cadb-9935-a0a3-45e634805302"
              }
            ]
          },
          "showTitleIcon": false,
          "titleIcon": "list",
          "iconColor": null,
          "titleFont": null,
          "titleColor": null,
          "enableDataExport": true,
          "desktopHide": true
        },
        "row": 0,
        "col": 0,
        "id": "3c990db9-ab04-d3a5-ae24-bc58de2fbc94"
      },
      "d2cec1c0-f9bb-1c7c-25ae-ea8853bc3b7e": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Diagnostic Kits",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "false",
            "displayEntityName": false,
            "entityNameColumnTitle": "Doktorkit ID",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "Label",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "Diagnostic Kit ID",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Diagnostic Kits",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "2519c941-a1b9-45bd-9821-88acf22e10af",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Diagnostic Kit ID",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.5282490591409559,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.4511182927579178
                },
                {
                  "name": "kitType",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostic-kits.diagnostic-kit-type}",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "if(value==='basis'){\n    return 'Diagnostics Basis Kit';\n}\nif(value==='extension'){\n    return 'Diagnostics Extension Kit';\n}\nif(value==='loraWan'){\n    return 'Diagnostics LoRaWAN Kit';\n}",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.69568544537813,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "subscriptionStatus",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostic-kits.subscription-status}",
                  "color": "#607d8b",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar licenseStatus = value;\r\nif (licenseStatus == 'active') { // all key values here are strings\r\n  color = '#4caf50';\r\n} else if (licenseStatus == 'pending') { // all key values here are strings\r\n  color = '#ffeb3b';\r\n} else if (licenseStatus == 'no license') { // all key values here are strings\r\n  color = '#D3D3D3';\r\n} else {\r\n  color = '#f44336';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span> ' + licenseStatus;\r\n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7919897897079038,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "nextPaymentDate",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostic-kits.next-payment}",
                  "color": "#607d8b",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "function formatDate(value) {\r\n  const date = new Date(value);\r\n  if (isNaN(date.getTime())) {\r\n    return \"\"; // Return empty string if the date is invalid\r\n  }\r\n  date.setHours(0, 0, 0, 0);\r\n  const day = date.getDate().toString().padStart(2, '0');\r\n  const month = (date.getMonth() + 1).toString().padStart(2, '0');\r\n  const year = date.getFullYear();\r\n  return `${day}/${month}/${year}`;\r\n}\r\n\r\nconst date = new Date(value);\r\ndate.setHours(0, 0, 0, 0);\r\nreturn formatDate(date); // Outputs in DD/MM/YYYY format",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.18765907366705847,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "validTo",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostic-kits.valid-to}",
                  "color": "#9c27b0",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "function formatDate(value) {\r\n  const date = new Date(value);\r\n  if (isNaN(date.getTime())) {\r\n    return \"\"; // Return empty string if the date is invalid\r\n  }\r\n  date.setHours(0, 0, 0, 0);\r\n  const day = date.getDate().toString().padStart(2, '0');\r\n  const month = (date.getMonth() + 1).toString().padStart(2, '0');\r\n  const year = date.getFullYear();\r\n  return `${day}/${month}/${year}`;\r\n}\r\n\r\nconst date = new Date(value);\r\ndate.setHours(0, 0, 0, 0);\r\nreturn formatDate(date); // Outputs in DD/MM/YYYY format",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5643595879016474,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "{i18n:custom.diagnostic-kits.open-devices}",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "92ce5e29-82ad-9f6e-51be-7bf3e7ae613d"
              }
            ],
            "actionCellButton": [
              {
                "name": "{i18n:custom.diagnostic-kits.edit-diagnostic-kit}",
                "icon": "edit",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"editEntityFormGroup\"\r\n      (ngSubmit)=\"save()\" \r\n      class=\"edit-entity-form max-w-3xl mx-auto\">\r\n    \r\n   <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n         <h2 class=\"text-lg font-semibold\">{{'custom.diagnostic-kits.edit-diagnostic-kit' | translate}}</h2>\r\n        <span class=\"flex-1\"></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n            <mat-icon>close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n    <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n\r\n        <!-- First row: Name-->\r\n        <div class=\"flex w-full gap-2\">\r\n\r\n            <!-- Name (Top-level form control) -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Diagnostic Kit Id</mat-label>\r\n                <input matInput \r\n                       formControlName=\"entityName\" \r\n                       required readonly>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('entityName')?.hasError('required')\">\r\n                  {{'custom.diagnostic-kits.diagnostic-kit-id-is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n\r\n            <!-- Label -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Label</mat-label>\r\n                <input matInput formControlName=\"label\" required>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('label')?.hasError('required')\">\r\n                  {{'custom.diagnostic-kits.label-is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n        </div>\r\n\r\n        <!-- Second row: kitType -->\r\n         <div class=\"flex w-full\">\r\n            <!-- HIDE Installation Type if measurementType is 'loraWan' -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\"\r\n                            *ngIf=\"editEntityFormGroup.get('attributes.measurementType')?.value !== 'loraWan'\"\r\n                            [formGroup]=\"editEntityFormGroup.controls['attributes']\">\r\n                <mat-label>{{'custom.diagnostic-kits.installation-type' | translate}}</mat-label>\r\n                <mat-select formControlName=\"kitType\" required>\r\n                     <mat-option value=\"basis\">Diagnostics Basis Kit</mat-option>\r\n                     <mat-option value=\"extension\">Diagnostics Extension Kit</mat-option>\r\n                     <mat-option value=\"loraWan\">Diagnostics LoRaWAN Kit</mat-option>\r\n                </mat-select>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('attributes.installationType')?.hasError('required')\">\r\n                  {{'custom.diagnostic-kits.diagnostic-kit-type-is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n        </div>\r\n    </div>\r\n\r\n    <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n        <button mat-button\r\n                color=\"primary\"\r\n                type=\"button\"\r\n                [disabled]=\"(isLoading$ | async)\"\r\n                (click)=\"cancel()\"\r\n                cdkFocusInitial>\r\n             {{'action.cancel' | translate}}\r\n        </button>\r\n        <button mat-button\r\n                mat-raised-button\r\n                color=\"primary\"\r\n                type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid\">\r\n            {{'action.save' | translate}}\r\n        </button>\r\n    </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\n\r\nopenEditEntityDialog();\r\n\r\nfunction openEditEntityDialog() {\r\n    customDialog.customDialog(htmlTemplate, EditEntityDialogController).subscribe();\r\n}\r\n\r\nfunction EditEntityDialogController(instance) {\r\n    let vm = instance;\r\n    vm.entityName = entityName; \r\n    vm.label = entityLabel; \r\n    vm.attributes = {};\r\n    vm.entity = {};\r\n\r\n    // Build the form group with a nested 'attributes' group\r\n    vm.editEntityFormGroup = vm.fb.group({\r\n        entityName: ['', [vm.validators.required]],\r\n        label: ['', [vm.validators.required]],\r\n        attributes: vm.fb.group({\r\n            kitType: [null]\r\n        })\r\n    });\r\n\r\n    getEntityInfo();\r\n\r\n    vm.cancel = function() {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function() {\r\n        // Mark the form as pristine right before saving\r\n        vm.editEntityFormGroup.markAsPristine();\r\n\r\n        // Save both entity main fields and attributes\r\n        widgetContext.rxjs.forkJoin([\r\n            saveAttributes(entityId),\r\n            saveEntity()\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n    function getEntityInfo() {\r\n        // Retrieve attributes + entity info in parallel\r\n        widgetContext.rxjs.forkJoin([\r\n            attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE'),\r\n            entityService.getEntity(entityId.entityType, entityId.id)\r\n        ]).subscribe(([attrData, entityData]) => {\r\n            vm.attributes = {};\r\n            // Populate vm.attributes from server response\r\n            for (let i = 0; i < attrData.length; i++) {\r\n                vm.attributes[attrData[i].key] = attrData[i].value;\r\n            }\r\n\r\n            vm.entity = entityData;\r\n\r\n            // Patch form values. \r\n            // Note that 'attributes' is a nested form group, so we pass an object for it.\r\n            vm.editEntityFormGroup.patchValue({\r\n                entityName: vm.entity.name,\r\n                label: vm.entity.label,\r\n                attributes: {\r\n                    kitType: vm.attributes.kitType\r\n                }\r\n            }, { emitEvent: false });\r\n        });\r\n    }\r\n\r\n    function saveEntity() {\r\n        const formValues = vm.editEntityFormGroup.value;\r\n        \r\n        // Always update name & label (ensures \"Save\" works even if no change)\r\n        vm.entity.name = formValues.entityName;\r\n        vm.entity.label = formValues.label;\r\n        /*console.log(\"enitity\",vm.entity);*/\r\n        return assetService.saveAsset(vm.entity);\r\n        \r\n        // If some other type, or no changes, return an observable that completes.\r\n        return widgetContext.rxjs.of([]);\r\n    }\r\n\r\n    function saveAttributes(entityId) {\r\n        // Compare original vs. new values to only send changed attributes\r\n        const currentAttributes = vm.attributes;\r\n        const updatedAttributes = vm.editEntityFormGroup.value.attributes;\r\n        \r\n        let attributesArray = [];\r\n        for (let key in updatedAttributes) {\r\n            if (updatedAttributes.hasOwnProperty(key)) {\r\n                if (updatedAttributes[key] !== currentAttributes[key]) {\r\n                    attributesArray.push({ key: key, value: updatedAttributes[key] });\r\n                }\r\n            }\r\n        }\r\n\r\n        if (attributesArray.length > 0) {\r\n            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n        }\r\n        return widgetContext.rxjs.of([]);\r\n    }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "4ba82627-39fc-7ac8-015e-8bb5184d8c82"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.open-diagnostic-kit-devices}",
                "icon": "devices_other",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "71c478b6-a4b1-e569-e99a-85d5562cc721"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.license.management}",
                "icon": "verified",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addEntityFormGroup\" (ngSubmit)=\"checkout()\" class=\"add-entity-form\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.diagnostic-kits.manage-diagnostic-kits' | translate }}</h2>\r\n        <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <!-- If NO device is assigned, show this info text -->\r\n    <div *ngIf=\"!deviceFound\" class=\"info-text\">\r\n      {{ 'custom.diagnostic-kits.please-assign-pflow' | translate }}\r\n    </div>\r\n\r\n    <!-- MAIN VIEW -->\r\n    <div *ngIf=\"view === 'main'\" class=\"button-group flex flex-col gap-4\">\r\n      <!--<div *ngIf=\"kitActivated\" class=\"info-text\">\r\n        The Diagnostic Kit is already activated and cannot be purchased again.\r\n      </div>-->\r\n      <button mat-raised-button color=\"primary\" \r\n              (click)=\"activateLicense()\"\r\n              [disabled]=\"!deviceFound || !canActivateLicense\">\r\n        {{ 'custom.diagnostic-kits.activate-license' | translate }}\r\n      </button>\r\n      <button mat-raised-button color=\"primary\" \r\n              (click)=\"licenseStatus()\"\r\n              [disabled]=\"!deviceFound || !subscriptionExists\">\r\n        {{ 'custom.diagnostic-kits.license-status' | translate }}\r\n      </button>\r\n      <button mat-raised-button color=\"primary\" \r\n              (click)=\"cancelLicense()\"\r\n              [disabled]=\"!deviceFound || !subscriptionExists || cancelDisabled\">\r\n        {{ 'custom.diagnostic-kits.cancel-license' | translate }}\r\n      </button>\r\n    </div>\r\n\r\n    <!-- ACTIVATE LICENSE VIEW -->\r\n    <div *ngIf=\"view === 'activate'\" class=\"flex flex-col gap-4\">\r\n      <div class=\"flex justify-center items-center gap-8\">\r\n        <div class=\"flex flex-col\">\r\n          <div>{{ 'custom.diagnostic-kits.pay-by-invoice' | translate }}</div>\r\n          <mat-checkbox [checked]=\"isInvoice\" (change)=\"onSelectInvoice($event)\"></mat-checkbox>\r\n        </div>\r\n        <div class=\"flex flex-col\">\r\n          <div>{{ 'custom.diagnostic-kits.credit-card-alternative-payments' | translate }}</div>\r\n          <mat-checkbox [checked]=\"isCard\" (change)=\"onSelectCard($event)\"></mat-checkbox>\r\n        </div>\r\n      </div>\r\n      <div class=\"action-buttons\">\r\n        <button mat-raised-button color=\"primary\" type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || (!isInvoice && !isCard)\">\r\n          {{ 'custom.diagnostic-kits.checkout' | translate }}\r\n        </button>\r\n        <button mat-button color=\"primary\" type=\"button\" (click)=\"backToMain()\">{{ 'custom.diagnostic-kits.back' | translate }}</button>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- BUY DIAGNOSTICKIT VIEW (one-time purchase) -->\r\n    <div *ngIf=\"view === 'buy'\" class=\"flex flex-col gap-4\">\r\n      <div class=\"flex justify-center items-center gap-8\">\r\n        <div class=\"flex flex-col\">\r\n          <div>{{ 'custom.diagnostic-kits.pay-by-invoice' | translate }}</div>\r\n          <mat-checkbox [checked]=\"buyInvoice\" (change)=\"onSelectBuyInvoice($event)\"></mat-checkbox>\r\n        </div>\r\n        <div class=\"flex flex-col\">\r\n          <div>{{ 'custom.diagnostic-kits.credit-card-alternative-payments' | translate }}</div>\r\n          <mat-checkbox [checked]=\"buyCard\" (change)=\"onSelectBuyCard($event)\"></mat-checkbox>\r\n        </div>\r\n      </div>\r\n      <div class=\"action-buttons\">\r\n        <button mat-raised-button color=\"primary\" type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || (!buyInvoice && !buyCard)\">\r\n          {{ 'custom.diagnostic-kits.purchase' | translate }}\r\n        </button>\r\n        <button mat-button color=\"primary\" type=\"button\" (click)=\"backToMain()\">{{ 'custom.diagnostic-kits.back' | translate }}</button>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- LICENSE STATUS VIEW -->\r\n    <div *ngIf=\"view === 'licenseStatus'\" fxLayout=\"column\">\r\n      <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n      <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n        <table class=\"subscription-table\">\r\n          <thead>\r\n            <tr>\r\n              <th>{{ 'custom.diagnostic-kits.start-date' | translate }}</th>\r\n              <th>{{ 'custom.diagnostic-kits.price' | translate }}</th>\r\n              <th>{{ 'custom.diagnostic-kits.billing-cycle' | translate }}</th>\r\n              <th>{{ 'custom.diagnostic-kits.next-billing' | translate }}</th>\r\n              <th>{{ 'custom.diagnostic-kits.valid-to' | translate }}</th>\r\n              <th>Status</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            <tr>\r\n              <td>{{ subscriptionStartDate | date:'dd/MM/yyyy' }}</td>\r\n              <td>{{ subscriptionPrice }}</td>\r\n              <td>{{ billingCycle }}</td>\r\n              <!-- \r\n                If nextPaymentDate is 0, show empty string.\r\n                Otherwise, format it as a date.\r\n              -->\r\n              <td>{{ nextPaymentDate === 0 ? '' : (nextPaymentDate | date:'dd/MM/yyyy') }}</td>\r\n              <td>{{ validTill | date:'dd/MM/yyyy' }}</td>\r\n              <td>\r\n                <span class=\"status-label\"\r\n                      [ngClass]=\"{\r\n                        'status-active': subscriptionStatus === 'active',\r\n                        'status-open-payment': subscriptionStatus === 'pending',\r\n                        'status-inactive': subscriptionStatus === 'inactive',\r\n                        'status-canceled': subscriptionStatus === 'canceled'\r\n                      }\">\r\n                  {{ subscriptionStatus }}\r\n                </span>\r\n              </td>\r\n            </tr>\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n      <!-- Pay button if subscription is pending -->\r\n      <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n        <button mat-raised-button color=\"primary\" type=\"button\"\r\n                *ngIf=\"subscriptionStatus === 'pending' || subscriptionStatus === 'inactive'\"\r\n                [disabled]=\"(isLoading$ | async)\"\r\n                (click)=\"initiatePayment()\">\r\n          {{ 'custom.diagnostic-kits.pay' | translate }}\r\n        </button>\r\n        <button mat-button color=\"primary\" type=\"button\" (click)=\"backToMain()\">{{ 'action.back' | translate }}</button>\r\n        <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">{{ 'action.close' | translate }}</button>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- CANCEL LICENSE CONFIRMATION VIEW -->\r\n    <div *ngIf=\"view === 'cancelSubscription'\" class=\"flex flex-col gap-4\">\r\n      <div class=\"info-text\">\r\n        {{ cancelMessage }}\r\n      </div>\r\n      <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n        <button mat-raised-button color=\"primary\" type=\"button\" (click)=\"confirmCancelSubscription()\">\r\n          {{ 'custom.diagnostic-kits.confirm-cancellation' | translate }}\r\n        </button>\r\n        <button mat-button color=\"primary\" type=\"button\" (click)=\"backToMain()\">{{ 'action.cancel' | translate }}</button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n\r\n  <!-- FOOTER ACTIONS FOR MAIN VIEW ONLY -->\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\"\r\n       *ngIf=\"view !== 'activate' && view !== 'licenseStatus' && view !== 'cancelSubscription' && view !== 'buy'\">\r\n    <button mat-button color=\"primary\" type=\"button\" [disabled]=\"(isLoading$ | async)\" (click)=\"cancel()\" cdkFocusInitial>\r\n      {{ 'action.close' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n\n.subscription-table {\n    width: 100%;\n    border-collapse: collapse;\n    margin: 20px 0;\n    font-size: 16px;\n    text-align: left;\n}\n.subscription-table th, .subscription-table td {\n    border: 1px solid #ddd;\n    padding: 8px;\n}\n.subscription-table th {\n    background-color: #f2f2f2;\n    font-weight: bold;\n}\n.status-label {\n    padding: 5px 10px;\n    border-radius: 15px;\n    color: #fff;\n    font-weight: bold;\n    display: inline-block;\n}\n.status-active {\n    background-color: #4caf50; /* Green for active */\n}\n.status-open-payment {\n    background-color: #ffeb3b; /* Yellow for open payment */\n}\n.status-canceled {\n    background-color: #f44336; /* Red for canceled */\n}\n.status-inactive {\n    background-color: #f44336; /* Red for canceled */\n}\n.status-cancelled-trial {\n    background-color: #ff9800; /* Orange for cancelled at trial end */\n}",
                "customFunction": "// --------------------------------------------------\r\n// JS CODE - ADAPTED FOR REST FETCH CALLS WITH OPEN PAYMENTS\r\n// NEXT BILLING FIELD IS EMPTY IF nextPaymentDate = 0\r\n// --------------------------------------------------\r\n\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet PageLink = widgetContext.pageLink;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet assetProfileService = $injector.get(widgetContext.servicesMap.get('assetProfileService'));\r\n\r\n// Tenant and entity references\r\nlet tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\r\nlet doctorkitId = entityId;\r\nvar customer;\r\nif (widgetContext.currentUser.authority !== 'CUSTOMER_USER') {\r\n  customer = widgetContext.stateController.getStateParams().entityId;\r\n} else {\r\n  customer = { entityType: \"CUSTOMER\", id: widgetContext.currentUser.customerId };\r\n}\r\n\r\n// Stripe / Payment\r\nlet stripeSecretKey;\r\nlet sessionId = '';\r\nlet customerId;\r\nlet customerStripeId;\r\nlet subscriptionId;\r\n\r\n// Deadlines\r\nlet cancelDeadline;\r\nlet paymentDeadline;\r\n\r\n// Product-related\r\nlet products = [];\r\nlet filteredProducts = [];\r\nlet selectedProductId = '';\r\nlet selectedLicenseType = '';\r\n\r\n// Subscription details variables for License Status view\r\nlet subscriptionStartDate = 0;\r\nlet subscriptionPrice = '';\r\nlet billingCycle = '';\r\nlet nextPaymentDate = 0;       // If this is 0, the HTML shows an empty string\r\nlet subscriptionEndDate = 0;\r\nlet subscriptionStatus = '';   // active, pending, inactive, canceled, or \"no subscription\"\r\nlet lastInvoiceStatus = '';\r\nlet nextPaymentAttempt = null;\r\nlet unpaidInvoiceToPay = null;\r\nlet hostedInvoiceUrl = '';\r\nlet validTill = 0;\r\nlet pendingValidTill = 0;\r\n\r\n// Dialog view management and flags\r\nlet view = 'main';\r\nlet deviceFound = false;\r\nlet subscriptionActive = false;\r\nlet subscriptionExists = false;\r\nlet kitBought = false;\r\nlet kitName = '';\r\nlet kitType = '';\r\nlet buyInvoice = false;\r\nlet buyCard = false;\r\nlet assignedDevices = [];\r\nlet loraRoomSensorsCount = 0;\r\nlet currentUrl = window.location.href;\r\nlet bearerToken = '';\r\n\r\n// Query for \"Product\" assets\r\nlet query = {\r\n  \"parameters\": {\r\n    \"rootId\": customer.id,\r\n    \"rootType\": \"CUSTOMER\",\r\n    \"direction\": \"FROM\",\r\n    \"relationTypeGroup\": \"COMMON\",\r\n    \"maxLevel\": 1073741824,\r\n    \"fetchLastLevelOnly\": true\r\n  },\r\n  \"relationType\": \"Contains\",\r\n  \"assetTypes\": [\"Product\"]\r\n};\r\n\r\nlet cancelMessage = '';\r\n\r\n// ---------------------------------------------------\r\n// NEW FUNCTION: Calculate Cancellation Information\r\n// ---------------------------------------------------\r\nasync function calculateCancellationInfo() {\r\n  if (!stripeSecretKey || !subscriptionId) {\r\n    throw new Error('Missing required information to check cancellation details.');\r\n  }\r\n  try {\r\n    const response = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error fetching subscription: ${response.statusText}`);\r\n    }\r\n    const subscription = await response.json();\r\n    const currentPeriodEnd = subscription.current_period_end;\r\n    const currentPeriodStart = subscription.current_period_start;\r\n    const currentTime = Math.floor(Date.now() / 1000);\r\n    const cycleLength = currentPeriodEnd - currentPeriodStart;\r\n    const cancellationDeadlineSeconds = cancelDeadline * 24 * 60 * 60;\r\n    const bufferSeconds = 10;\r\n    let cancelAtTimestamp, infoMessage;\r\n    \r\n    if ((currentPeriodEnd - currentTime) <= cancellationDeadlineSeconds) {\r\n      // Inside cancellation deadline: renew one more cycle before canceling.\r\n      cancelAtTimestamp = currentPeriodEnd + cycleLength - bufferSeconds;\r\n      infoMessage = `You are within the cancellation deadline. Your subscription will renew for one more cycle and cancel at the end of the next cycle on ${new Date(cancelAtTimestamp * 1000).toLocaleDateString()}.`;\r\n    } else {\r\n      // Outside the deadline: cancel at the end of the current cycle.\r\n      cancelAtTimestamp = currentPeriodEnd - bufferSeconds;\r\n      infoMessage = `You are outside the cancellation deadline. Your subscription will cancel at the end of the current cycle on ${new Date(cancelAtTimestamp * 1000).toLocaleDateString()}.`;\r\n    }\r\n    \r\n    return infoMessage;\r\n  } catch (error) {\r\n    console.error(\"Error in calculateCancellationInfo:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------\r\n// INITIAL LOGIC - always open the dialog\r\n// ---------------------------------------------------\r\nassetService.getAssetInfo(doctorkitId.id).subscribe(info => {\r\n  kitName = info.name;\r\n  customerId = info.customerId;\r\n  attributeService.getEntityAttributes(customer, \"SERVER_SCOPE\", ['stripeKey','cancelDeadline','paymentDeadline']).subscribe(attribute => {\r\n    // Read stripe secret key\r\n    stripeSecretKey = attribute[0].value;\r\n    // Read cancelDeadline (in days) - default to 90 if not set\r\n    const cancelDeadlineObj = attribute.find(item => item.key === \"cancelDeadline\");\r\n    cancelDeadline = cancelDeadlineObj ? cancelDeadlineObj.value : 90;\r\n    // Read paymentDeadline (in days) - default to 14 if not set\r\n    const paymentDeadlineObj = attribute.find(item => item.key === \"paymentDeadline\");\r\n    paymentDeadline = paymentDeadlineObj ? paymentDeadlineObj.value : 14;\r\n    \r\n    // Fetch additional attributes\r\n    attributeService.getEntityAttributes(doctorkitId, \"SERVER_SCOPE\", ['subscriptionId', 'subscriptionStatus', 'validTo', 'kitType', 'activated', 'boughtKitStatus']).subscribe(attributes => {\r\n      let subscriptionAttr = attributes.find(a => a.key === 'subscriptionId');\r\n      subscriptionId = subscriptionAttr?.value || null;\r\n      \r\n      let subStatusAttr = attributes.find(a => a.key === 'subscriptionStatus');\r\n      subscriptionStatus = subStatusAttr ? subStatusAttr.value : \"no subscription\";\r\n      \r\n      let validToAttr = attributes.find(a => a.key === 'validTo');\r\n      validTill = validToAttr ? Number(validToAttr.value) : 0;\r\n      \r\n      let kitTypeAttr = attributes.find(a => a.key === 'kitType');\r\n      kitType = kitTypeAttr?.value || null;\r\n      let activatedAttr = attributes.find(a => a.key === 'activated');\r\n      let kitActivated = activatedAttr ? (activatedAttr.value === true || activatedAttr.value === 'true') : false;\r\n      let kitBoughtAttr = attributes.find(a => a.key === 'boughtKitStatus');\r\n      kitBought = kitBoughtAttr ? (kitBoughtAttr.value === true || kitBoughtAttr.value === 'true') : false;\r\n      subscriptionExists = !!subscriptionId;\r\n      let isBasisKit = (kitType === 'basis');\r\n      if (subscriptionId) {\r\n        checkSubscriptionStatus(subscriptionId)\r\n          .then(subscriptionData => {\r\n            if (subscriptionData && subscriptionData.status === 'active') {\r\n              subscriptionActive = true;\r\n            }\r\n            fetchCustomerStripeId(() => fetchAssignedAssetsAndDevices(doctorkitId.id, kitActivated, isBasisKit));\r\n          })\r\n          .catch(error => {\r\n            console.error(\"Error fetching subscription status:\", error);\r\n            fetchCustomerStripeId(() => fetchAssignedAssetsAndDevices(doctorkitId.id, kitActivated, isBasisKit));\r\n          });\r\n      } else {\r\n        fetchCustomerStripeId(() => fetchAssignedAssetsAndDevices(doctorkitId.id, kitActivated, isBasisKit));\r\n      }\r\n    });\r\n  });\r\n});\r\n\r\nfunction fetchCustomerStripeId(callback) {\r\n  attributeService.getEntityAttributes(customerId, \"SERVER_SCOPE\", ['stripe_id']).subscribe(stripeId => {\r\n    customerStripeId = stripeId?.[0]?.value || null;\r\n    callback();\r\n  });\r\n}\r\n\r\n// ---------------------------------------------------\r\n// FETCH ASSIGNED DEVICES\r\n// ---------------------------------------------------\r\nfunction fetchAssignedAssetsAndDevices(doktorkitId, kitActivated, isBasisKit) {\r\n  const deviceSearchQuery = {\r\n    parameters: {\r\n      rootId: doktorkitId,\r\n      rootType: \"ASSET\",\r\n      direction: \"FROM\",\r\n      relationTypeGroup: \"COMMON\",\r\n      maxLevel: 100,\r\n      fetchLastLevelOnly: false\r\n    },\r\n    relationType: \"Contains\",\r\n    deviceTypes: [\"P-Flow D116\", \"Temperature Sensor\", \"Room Sensor T\", \"Room Sensor CO2\"]\r\n  };\r\n  deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n    (deviceList) => {\r\n      deviceFound = !!(deviceList && deviceList.length > 0);\r\n      assignedDevices = deviceList || [];\r\n      loraRoomSensorsCount = 0;\r\n      assignedDevices.forEach(dev => {\r\n        if (dev.type === \"Room Sensor T\" || dev.type === \"Room Sensor CO2\") {\r\n          loraRoomSensorsCount++;\r\n        }\r\n      });\r\n      fetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          \"username\": \"belimo.api@pke-iot.expert\",\r\n          \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n        })\r\n      })\r\n      .then(resp => resp.json())\r\n      .then(loginData => {\r\n        bearerToken = loginData.token;\r\n        fetchProductsAndOpenDialog(kitActivated, isBasisKit);\r\n      })\r\n      .catch(err => {\r\n        console.error(\"Error fetching bearer token for product queries:\", err);\r\n        openAddEntityDialog(kitActivated, isBasisKit);\r\n      });\r\n    },\r\n    (error) => {\r\n      console.error(\"Error fetching assigned devices:\", error);\r\n      fetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          \"username\": \"belimo.api@pke-iot.expert\",\r\n          \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n        })\r\n      })\r\n      .then(resp => resp.json())\r\n      .then(loginData => {\r\n        bearerToken = loginData.token;\r\n        fetchProductsAndOpenDialog(kitActivated, isBasisKit);\r\n      })\r\n      .catch(err2 => {\r\n        console.error(\"Error fetching bearer token:\", err2);\r\n        openAddEntityDialog(kitActivated, isBasisKit);\r\n      });\r\n    }\r\n  );\r\n}\r\n\r\n// ---------------------------------------------------\r\n// FETCH PRODUCTS (via REST) AND THEN OPEN DIALOG\r\n// ---------------------------------------------------\r\nfunction fetchProductsAndOpenDialog(kitActivated, isBasisKit) {\r\n  fetch('https://cloud.pke-iot.expert/api/assets', {\r\n    method: 'POST',\r\n    headers: {\r\n      'accept': 'application/json',\r\n      'Content-Type': 'application/json',\r\n      'X-Authorization': 'Bearer ' + bearerToken\r\n    },\r\n    body: JSON.stringify(query)\r\n  })\r\n  .then(resp => resp.json())\r\n  .then(assetList => {\r\n    let fetches = assetList.map(asset => {\r\n      return new Promise((resolve) => {\r\n        fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${asset.id.id}/values/attributes?keys=prodType`, {\r\n          method: 'GET',\r\n          headers: {\r\n            'accept': 'application/json',\r\n            'X-Authorization': 'Bearer ' + bearerToken\r\n          }\r\n        })\r\n        .then(resp2 => resp2.json())\r\n        .then(prodTypeAttr => {\r\n          asset.prodType = (prodTypeAttr && prodTypeAttr.length > 0 && prodTypeAttr[0].key === 'prodType') ? prodTypeAttr[0].value : null;\r\n          products.push(asset);\r\n          resolve();\r\n        })\r\n        .catch(err => {\r\n          console.error(\"Error fetching prodType for asset:\", asset.id.id, err);\r\n          resolve();\r\n        });\r\n      });\r\n    });\r\n    Promise.all(fetches).then(() => {\r\n      openAddEntityDialog(kitActivated, isBasisKit);\r\n    });\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching product assets:\", error);\r\n    openAddEntityDialog(kitActivated, isBasisKit);\r\n  });\r\n}\r\n\r\nasync function checkSubscriptionStatus(subscriptionId) {\r\n  try {\r\n    const response = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error fetching subscription details: ${response.statusText}`);\r\n    }\r\n    return await response.json();\r\n  } catch (error) {\r\n    console.error('Error fetching subscription:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------\r\n// CANCEL SUBSCRIPTION LOGIC\r\n// ---------------------------------------------------\r\nasync function cancelSubscriptionWithCalculatedDate() {\r\n  if (!stripeSecretKey || !subscriptionId) {\r\n    console.error('Missing required information to cancel subscription.');\r\n    return;\r\n  }\r\n  try {\r\n    const response = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error fetching subscription: ${response.statusText}`);\r\n    }\r\n    const subscription = await response.json();\r\n    const currentPeriodEnd = subscription.current_period_end;\r\n    const currentPeriodStart = subscription.current_period_start;\r\n    const currentTime = Math.floor(Date.now() / 1000);\r\n    const cycleLength = currentPeriodEnd - currentPeriodStart;\r\n    const cancellationDeadlineSeconds = cancelDeadline * 24 * 60 * 60;\r\n    const bufferSeconds = 10;\r\n    let cancelAtTimestamp, cancelInfo;\r\n    \r\n    if ((currentPeriodEnd - currentTime) <= cancellationDeadlineSeconds) {\r\n      cancelAtTimestamp = currentPeriodEnd + cycleLength - bufferSeconds;\r\n      cancelInfo = `Your subscription will renew for one more cycle and cancel at the end of the next cycle on ${new Date(cancelAtTimestamp * 1000).toLocaleDateString()}.`;\r\n    } else {\r\n      cancelAtTimestamp = currentPeriodEnd - bufferSeconds;\r\n      cancelInfo = `Your subscription will cancel at the end of the current cycle on ${new Date(cancelAtTimestamp * 1000).toLocaleDateString()}.`;\r\n    }\r\n    \r\n    const updateResponse = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: new URLSearchParams({ 'cancel_at': cancelAtTimestamp.toString() })\r\n    });\r\n    if (!updateResponse.ok) {\r\n      throw new Error(`Error updating subscription cancellation: ${updateResponse.statusText}`);\r\n    }\r\n    await updateResponse.json();\r\n    return cancelInfo;\r\n  } catch (error) {\r\n    console.error(\"Error in cancelSubscriptionWithCalculatedDate:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------\r\n// LICENSE STATUS LOGIC\r\n// ---------------------------------------------------\r\nasync function handleSubscriptionDetails(subscriptionId) {\r\n  try {\r\n    const subscriptionResponse = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}`, 'Content-Type': 'application/json' }\r\n    });\r\n    const subscription = await subscriptionResponse.json();\r\n    // Save dates as Unix timestamps (in ms)\r\n    subscriptionStartDate = subscription.start_date * 1000;\r\n    nextPaymentDate = subscription.current_period_end * 1000;\r\n    subscriptionPrice = (subscription.plan.amount / 100).toFixed(2) + ' ' + subscription.plan.currency.toUpperCase();\r\n    billingCycle = subscription.plan.interval;\r\n    \r\n    let tempValidTill = nextPaymentDate;\r\n    if (subscription.cancel_at) {\r\n      if (subscription.status === 'canceled') {\r\n        subscriptionEndDate = subscription.canceled_at * 1000;\r\n        subscriptionStatus = 'canceled';\r\n        tempValidTill = 0;\r\n      } else {\r\n        subscriptionEndDate = subscription.cancel_at * 1000;\r\n        subscriptionStatus = 'canceled';\r\n        tempValidTill = subscriptionEndDate;\r\n      }\r\n    } else if (subscription.status === 'canceled') {\r\n      subscriptionEndDate = subscription.canceled_at * 1000;\r\n      subscriptionStatus = 'canceled';\r\n      tempValidTill = 0;\r\n    } else if (subscription.status === 'active') {\r\n      subscriptionStatus = 'active';\r\n      tempValidTill = nextPaymentDate;\r\n    }\r\n    validTill = tempValidTill;\r\n    if (subscriptionStatus === 'canceled' && validTill === nextPaymentDate) {\r\n      // We consider it canceled and remove the next payment date\r\n      nextPaymentDate = 0;\r\n    }\r\n  } catch (error) {\r\n    console.error('Error fetching subscription details:', error);\r\n  }\r\n}\r\n\r\nasync function handleUnpaidInvoices(subscriptionId, customerStripeId) {\r\n  try {\r\n    const invoiceResponse = await fetch(`https://api.stripe.com/v1/invoices?subscription=${subscriptionId}&limit=100`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}`, 'Content-Type': 'application/json' }\r\n    });\r\n    const invoices = await invoiceResponse.json();\r\n    if (invoices.data.length === 0) {\r\n      lastInvoiceStatus = 'paid';\r\n      return;\r\n    }\r\n    const unpaidInvoices = invoices.data.filter(invoice => invoice.status === 'open');\r\n    let currentTime = Math.floor(Date.now() / 1000);\r\n    if (unpaidInvoices.length > 0) {\r\n      let inv = unpaidInvoices[0];\r\n      hostedInvoiceUrl = inv.hosted_invoice_url || '';\r\n      let invoiceCreated = inv.created;\r\n      let deadline = invoiceCreated + (paymentDeadline * 24 * 60 * 60);\r\n      pendingValidTill = deadline * 1000;\r\n      lastInvoiceStatus = currentTime > deadline ? 'inactive' : 'pending';\r\n    } else {\r\n      lastInvoiceStatus = 'paid';\r\n    }\r\n  } catch (error) {\r\n    console.error('Error handling unpaid invoices:', error);\r\n  }\r\n}\r\n\r\nfunction determineSubscriptionStatus() {\r\n  if (subscriptionStatus === 'canceled') {\r\n    return;\r\n  } else if (lastInvoiceStatus === 'inactive') {\r\n    subscriptionStatus = 'inactive';\r\n    validTill = 0;\r\n  } else if (lastInvoiceStatus === 'pending') {\r\n    subscriptionStatus = 'pending';\r\n    validTill = pendingValidTill;\r\n  } else if (lastInvoiceStatus === 'paid' || lastInvoiceStatus === 'draft') {\r\n    subscriptionStatus = 'active';\r\n    validTill = nextPaymentDate;\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------\r\n// Save Subscription Attributes to Doctorkit\r\n// ---------------------------------------------------\r\nfunction saveSubscriptionAttributes() {\r\n  let attrsToSave = [\r\n    { key: \"subscriptionStartDate\", value: subscriptionStartDate },\r\n    { key: \"subscriptionPrice\", value: subscriptionPrice },\r\n    { key: \"billingCycle\", value: billingCycle },\r\n    { key: \"nextPaymentDate\", value: nextPaymentDate },\r\n    { key: \"validTo\", value: validTill },\r\n    { key: \"subscriptionStatus\", value: subscriptionStatus }\r\n  ];\r\n  attributeService.saveEntityAttributes(doctorkitId, \"SERVER_SCOPE\", attrsToSave).subscribe(\r\n    () => { console.log(\"Subscription attributes saved successfully.\"); },\r\n    error => { console.error(\"Error saving subscription attributes:\", error); }\r\n  );\r\n}\r\n\r\n// ---------------------------------------------------\r\n// OPEN DIALOG\r\n// ---------------------------------------------------\r\nfunction openAddEntityDialog(kitActivated, isBasisKit) {\r\n  customDialog.customDialog(htmlTemplate, (instance) => AddEntityDialogController(instance, kitActivated, isBasisKit)).subscribe();\r\n}\r\n\r\nfunction AddEntityDialogController(instance, kitActivated, isBasisKit) {\r\n  let vm = instance;\r\n  vm.view = view;\r\n  vm.deviceFound = deviceFound;\r\n  vm.subscriptionActive = subscriptionActive;\r\n  vm.subscriptionExists = subscriptionExists;\r\n  vm.kitName = kitName;\r\n  vm.kitType = kitType;\r\n  vm.kitActivated = kitActivated;\r\n  vm.isBasisKit = isBasisKit;\r\n  vm.kitBought = kitBought;\r\n  \r\n  vm.isInvoice = false;\r\n  vm.isCard = false;\r\n  vm.buyInvoice = buyInvoice;\r\n  vm.buyCard = buyCard;\r\n  vm.addEntityFormGroup = vm.fb.group({});\r\n  \r\n  // Determine if Activate License button should be enabled:\r\n  vm.canActivateLicense = (subscriptionStatus === 'no subscription' || (subscriptionStatus === 'canceled' && validTill < Date.now()));\r\n  \r\n  if (subscriptionId && customerStripeId) {\r\n    handleSubscriptionDetails(subscriptionId).then(() => {\r\n      vm.cancelDisabled = (subscriptionStatus === 'pending' || subscriptionStatus === 'inactive' || subscriptionStatus === 'canceled');\r\n    }).catch(() => {\r\n      vm.cancelDisabled = false;\r\n    });\r\n  } else {\r\n    vm.cancelDisabled = true;\r\n  }\r\n  \r\n  vm.buyDiagnostickit = function () {\r\n    filterBuyProducts();\r\n    if (!filteredProducts.length) {\r\n      alert(\"No product found for kitType = \" + vm.kitType);\r\n    } else {\r\n      vm.view = 'buy';\r\n    }\r\n  };\r\n  \r\n  vm.activateLicense = function () {\r\n    vm.view = 'activate';\r\n    filterSubscriptionProducts();\r\n    if (filteredProducts.length > 0) {\r\n      selectedProductId = filteredProducts[0].id.id;\r\n    } else {\r\n      alert(vm.kitType === 'loraWan' ? \"No product with prodType = 'loraSimLicense' found!\" : \"No product with prodType = 'datalicense' found!\");\r\n    }\r\n  };\r\n  \r\n  vm.licenseStatus = function () {\r\n    vm.view = 'licenseStatus';\r\n    if (subscriptionId && customerStripeId) {\r\n      handleSubscriptionDetails(subscriptionId).then(() => {\r\n        handleUnpaidInvoices(subscriptionId, customerStripeId).then(() => {\r\n          determineSubscriptionStatus();\r\n          vm.cancelDisabled = (subscriptionStatus === 'pending' || subscriptionStatus === 'inactive' || subscriptionStatus === 'canceled');\r\n          vm.subscriptionStartDate = subscriptionStartDate;\r\n          vm.subscriptionPrice = subscriptionPrice;\r\n          vm.billingCycle = billingCycle;\r\n          vm.nextPaymentDate = nextPaymentDate;\r\n          vm.nextPaymentAttempt = nextPaymentAttempt;\r\n          vm.subscriptionStatus = subscriptionStatus;\r\n          vm.validTill = validTill;\r\n          saveSubscriptionAttributes();\r\n        });\r\n      });\r\n    } else {\r\n      alert(\"There is no completed subscription for this Doctorkit.\");\r\n    }\r\n  };\r\n  \r\n  // Show cancellation info before confirmation\r\n  vm.cancelLicense = function () {\r\n    if (vm.cancelDisabled) {\r\n      alert(\"Your subscription is already scheduled for cancellation or has been cancelled.\");\r\n      return;\r\n    }\r\n    vm.view = 'cancelSubscription';\r\n    calculateCancellationInfo()\r\n      .then(info => {\r\n        vm.cancelMessage = `Are you sure you want to cancel the subscription for \"${vm.kitName}\"?\\n\\n${info}`;\r\n      })\r\n      .catch(err => {\r\n        vm.cancelMessage = `Are you sure you want to cancel the subscription for \"${vm.kitName}\"? (Error determining cancellation details)`;\r\n      });\r\n  };\r\n  \r\n  // Actually cancel after confirmation\r\n  vm.confirmCancelSubscription = function () {\r\n    cancelSubscriptionWithCalculatedDate()\r\n      .then(info => {\r\n        alert(info);\r\n        vm.dialogRef.close(null);\r\n      })\r\n      .catch(err => {\r\n        alert(\"Error processing cancellation. Please try again.\");\r\n        vm.dialogRef.close(null);\r\n      });\r\n  };\r\n  \r\n  vm.backToMain = function () {\r\n    vm.view = 'main';\r\n  };\r\n  \r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.onSelectInvoice = function (event) {\r\n    vm.isInvoice = event.checked;\r\n    if (vm.isInvoice) { vm.isCard = false; }\r\n  };\r\n  vm.onSelectCard = function (event) {\r\n    vm.isCard = event.checked;\r\n    if (vm.isCard) { vm.isInvoice = false; }\r\n  };\r\n  vm.onSelectBuyInvoice = function (event) {\r\n    vm.buyInvoice = event.checked;\r\n    if (vm.buyInvoice) { vm.buyCard = false; }\r\n  };\r\n  vm.onSelectBuyCard = function (event) {\r\n    vm.buyCard = event.checked;\r\n    if (vm.buyCard) { vm.buyInvoice = false; }\r\n  };\r\n  \r\n  function filterSubscriptionProducts() {\r\n    filteredProducts = vm.kitType === 'loraWan' \r\n      ? products.filter(p => p.prodType === 'loraSimLicense')\r\n      : products.filter(p => p.prodType === 'datalicense');\r\n  }\r\n  \r\n  function filterBuyProducts() {\r\n    if (!vm.kitType) return;\r\n    let desiredProdType = vm.kitType === 'basis' ? 'basisKit'\r\n                        : vm.kitType === 'extension' ? 'extensionKit'\r\n                        : vm.kitType === 'loraWan' ? 'loraWanKit'\r\n                        : '';\r\n    filteredProducts = products.filter(p => p.prodType === desiredProdType);\r\n  }\r\n  \r\n  vm.checkout = function () {\r\n    vm.addEntityFormGroup.markAsPristine();\r\n    if (vm.view === 'activate') {\r\n      if (!vm.isInvoice && !vm.isCard) {\r\n        alert(\"Please select a payment method first.\");\r\n        return;\r\n      }\r\n      if (!filteredProducts.length) {\r\n        alert(\"No available product found to proceed!\");\r\n        return;\r\n      }\r\n      let selectedProduct = filteredProducts[0];\r\n      if (!selectedProduct) {\r\n        alert(\"No product found to activate.\");\r\n        return;\r\n      }\r\n      selectedProductId = selectedProduct.id.id;\r\n      selectedLicenseType = /base/i.test(selectedProduct.name) ? 'Base'\r\n                         : /pro/i.test(selectedProduct.name) ? 'Pro'\r\n                         : 'Unknown';\r\n      fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${selectedProductId}/values/attributes?keys=price_stripe_id`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'accept': 'application/json',\r\n          'X-Authorization': 'Bearer ' + bearerToken\r\n        }\r\n      })\r\n      .then(resp => resp.json())\r\n      .then(attrData => {\r\n        let priceAttr = attrData.find(a => a.key === 'price_stripe_id');\r\n        if (priceAttr) {\r\n          const priceId = priceAttr.value;\r\n          if (vm.isInvoice) {\r\n            createSubscriptionInvoiceMethod(priceId, vm);\r\n          } else if (vm.isCard) {\r\n            createCheckoutSession(priceId, vm);\r\n          }\r\n        } else {\r\n          console.error('Price ID not found for the selected product.');\r\n          alert(\"Unable to proceed. The selected product has no price_stripe_id.\");\r\n        }\r\n      })\r\n      .catch(err => {\r\n        console.error(\"Error fetching subscription price_stripe_id:\", err);\r\n        alert(\"Unable to fetch the product price. Please try again.\");\r\n      });\r\n    } else if (vm.view === 'buy') {\r\n      if (!vm.buyInvoice && !vm.buyCard) {\r\n        alert(\"Please select a payment method first.\");\r\n        return;\r\n      }\r\n      if (!filteredProducts.length) {\r\n        alert(\"No available product found to proceed!\");\r\n        return;\r\n      }\r\n      let selectedProduct = filteredProducts[0];\r\n      if (!selectedProduct) {\r\n        alert(\"No product found for your kit type.\");\r\n        return;\r\n      }\r\n      selectedProductId = selectedProduct.id.id;\r\n      selectedLicenseType = /basisKit/i.test(selectedProduct.name) ? 'basisKit'\r\n                         : /extensionKit/i.test(selectedProduct.name) ? 'extensionKit'\r\n                         : /loraWanKit/i.test(selectedProduct.name) ? 'loraWanKit'\r\n                         : 'unknownKitType';\r\n      fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${selectedProductId}/values/attributes?keys=price_stripe_id`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'accept': 'application/json',\r\n          'X-Authorization': 'Bearer ' + bearerToken\r\n        }\r\n      })\r\n      .then(resp => resp.json())\r\n      .then(async (attrData) => {\r\n        let priceAttr = attrData.find(a => a.key === 'price_stripe_id');\r\n        if (!priceAttr) {\r\n          console.error('Price ID not found for the selected product.');\r\n          alert(\"Unable to proceed. The selected kit has no price_stripe_id.\");\r\n          return;\r\n        }\r\n        const kitPriceId = priceAttr.value;\r\n        let sensorCount = vm.kitType === 'loraWan' ? loraRoomSensorsCount : 0;\r\n        let co2SensorProduct = products.find(p => p.prodType === 'co2RoomSensor');\r\n        if (vm.buyInvoice) {\r\n          await createOneTimeInvoiceWithSensors(kitPriceId, co2SensorProduct, sensorCount, vm);\r\n        } else if (vm.buyCard) {\r\n          await createOneTimeCheckoutSessionWithSensors(kitPriceId, co2SensorProduct, sensorCount, vm);\r\n        }\r\n      })\r\n      .catch(err => {\r\n        console.error('Error fetching kit price_stripe_id:', err);\r\n        alert(\"Failed to fetch kit price. Please try again.\");\r\n      });\r\n    }\r\n  };\r\n  \r\n  vm.initiatePayment = function() {\r\n    if (hostedInvoiceUrl) {\r\n      window.location.href = hostedInvoiceUrl;\r\n    } else {\r\n      alert(\"No open invoice available for payment.\");\r\n    }\r\n  };\r\n}\r\n\r\n// ---------------------------------------------------\r\n// STRIPE PAYMENT METHODS (SUBSCRIPTION)\r\n// ---------------------------------------------------\r\nasync function createCheckoutSession(priceId, instance) {\r\n  try {\r\n    const priceResponse = await fetch(`https://api.stripe.com/v1/prices/${priceId}?expand[]=product`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!priceResponse.ok) {\r\n      throw new Error(`Error fetching price details: ${priceResponse.statusText}`);\r\n    }\r\n    const priceData = await priceResponse.json();\r\n    const isRecurring = !!priceData.recurring;\r\n    const mode = isRecurring ? 'subscription' : 'payment';\r\n    const successUrl = currentUrl;\r\n    const cancelUrl = currentUrl;\r\n    const bodyParams = new URLSearchParams({\r\n      'success_url': successUrl,\r\n      'cancel_url': cancelUrl,\r\n      'payment_method_types[]': 'card',\r\n      'line_items[0][price]': priceId,\r\n      'line_items[0][quantity]': '1',\r\n      'mode': mode,\r\n      'customer': customerStripeId\r\n    });\r\n    const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: bodyParams\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error creating checkout session: ${response.statusText}`);\r\n    }\r\n    const data = await response.json();\r\n    if (data.id) {\r\n      const preAttrs = [\r\n        { key: \"sessionIdLicense\", value: data.id }\r\n      ];\r\n      await new Promise((resolve, reject) => {\r\n        attributeService.saveEntityAttributes(doctorkitId, \"SERVER_SCOPE\", preAttrs).subscribe(\r\n          () => resolve(),\r\n          (error) => {\r\n            console.error(\"Error saving sessionId:\", error);\r\n            reject(error);\r\n          }\r\n        );\r\n      });\r\n    }\r\n    if (data.url) {\r\n      window.location.href = data.url;\r\n    } else {\r\n      console.error('Checkout session URL not found in response');\r\n      alert(\"No checkout URL found. Unable to proceed to payment.\");\r\n    }\r\n  } catch (error) {\r\n    console.error('Error creating checkout session:', error);\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\nasync function createSubscriptionInvoiceMethod(priceId, instance) {\r\n  try {\r\n    let subParams = new URLSearchParams({\r\n      customer: customerStripeId,\r\n      'items[0][price]': priceId,\r\n      'items[0][quantity]': '1',\r\n      collection_method: 'send_invoice',\r\n      days_until_due: paymentDeadline.toString(),\r\n      'expand[]': 'latest_invoice'\r\n    });\r\n    const subResp = await fetch('https://api.stripe.com/v1/subscriptions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: subParams\r\n    });\r\n    if (!subResp.ok) {\r\n      throw new Error(`Error creating subscription with invoice: ${subResp.statusText}`);\r\n    }\r\n    const subscriptionData = await subResp.json();\r\n    let latestInvoice = subscriptionData.latest_invoice;\r\n    if (latestInvoice && latestInvoice.id) {\r\n      const finalizeResp = await fetch(`https://api.stripe.com/v1/invoices/${latestInvoice.id}/finalize?auto_advance=true`, {\r\n        method: 'POST',\r\n        headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n      });\r\n      if (!finalizeResp.ok) {\r\n        throw new Error(`Error finalizing invoice: ${finalizeResp.statusText}`);\r\n      }\r\n      await finalizeResp.json();\r\n    }\r\n    const attrs = [\r\n      { key: \"licenseActivationStatus\", value: false },\r\n      { key: \"subscriptionId\", value: subscriptionData.id }\r\n    ];\r\n    attributeService.saveEntityAttributes(doctorkitId, \"SERVER_SCOPE\", attrs).subscribe(\r\n      () => {\r\n        alert(\"Subscription created via invoice. Invoice sent immediately!\");\r\n        instance.dialogRef.close(null);\r\n      },\r\n      (error) => {\r\n        console.error('Error saving invoice attributes:', error);\r\n        instance.dialogRef.close(null);\r\n      }\r\n    );\r\n  } catch (error) {\r\n    console.error(\"Error in createSubscriptionInvoiceMethod:\", error);\r\n    alert(\"Invoice creation failed. Please try again.\");\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------\r\n// ONE-TIME PURCHASE METHODS\r\n// ---------------------------------------------------\r\nasync function createOneTimeCheckoutSessionWithSensors(kitPriceId, co2SensorProduct, sensorCount, instance) {\r\n  try {\r\n    let lineItemCount = 0;\r\n    const bodyParams = new URLSearchParams();\r\n    bodyParams.append('success_url', currentUrl);\r\n    bodyParams.append('cancel_url', currentUrl);\r\n    bodyParams.append('payment_method_types[]', 'card');\r\n    bodyParams.append('mode', 'payment');\r\n    bodyParams.append('customer', customerStripeId);\r\n    bodyParams.append(`line_items[${lineItemCount}][price]`, kitPriceId);\r\n    bodyParams.append(`line_items[${lineItemCount}][quantity]`, '1');\r\n    lineItemCount++;\r\n    if (co2SensorProduct && sensorCount > 0) {\r\n      let sensorPriceAttrResp = await fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${co2SensorProduct.id.id}/values/attributes?keys=price_stripe_id`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'accept': 'application/json',\r\n          'X-Authorization': 'Bearer ' + bearerToken\r\n        }\r\n      });\r\n      let sensorPriceAttrData = await sensorPriceAttrResp.json();\r\n      let sensorAttr = sensorPriceAttrData.find(a => a.key === 'price_stripe_id');\r\n      if (sensorAttr) {\r\n        let sensorPriceId = sensorAttr.value;\r\n        bodyParams.append(`line_items[${lineItemCount}][price]`, sensorPriceId);\r\n        bodyParams.append(`line_items[${lineItemCount}][quantity]`, sensorCount.toString());\r\n        lineItemCount++;\r\n      }\r\n    }\r\n    const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: bodyParams\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error creating one-time checkout session: ${response.statusText}`);\r\n    }\r\n    const data = await response.json();\r\n    if (data.id) {\r\n      const preAttrs = [\r\n        { key: \"sessionIdKitBuy\", value: data.id }\r\n      ];\r\n      await new Promise((resolve, reject) => {\r\n        attributeService.saveEntityAttributes(doctorkitId, \"SERVER_SCOPE\", preAttrs).subscribe(\r\n          () => resolve(),\r\n          (error) => {\r\n            console.error(\"Error saving one-time session attributes:\", error);\r\n            reject(error);\r\n          }\r\n        );\r\n      });\r\n    }\r\n    if (data.url) {\r\n      window.location.href = data.url;\r\n    } else {\r\n      console.error('One-time checkout session URL not found in response');\r\n      alert(\"No checkout URL found. Unable to proceed to payment.\");\r\n    }\r\n  } catch (error) {\r\n    console.error('Error creating one-time checkout session with sensors:', error);\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\nasync function createOneTimeInvoiceWithSensors(kitPriceId, co2SensorProduct, sensorCount, instance) {\r\n  try {\r\n    const kitPriceResp = await fetch(`https://api.stripe.com/v1/prices/${kitPriceId}`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!kitPriceResp.ok) {\r\n      throw new Error(`Error fetching kit price details: ${kitPriceResp.statusText}`);\r\n    }\r\n    const kitPriceData = await kitPriceResp.json();\r\n    const kitAmount = kitPriceData.unit_amount;\r\n    const kitCurrency = kitPriceData.currency;\r\n    let invoiceBody = new URLSearchParams({\r\n      customer: customerStripeId,\r\n      auto_advance: 'false',\r\n      collection_method: 'send_invoice',\r\n      days_until_due: paymentDeadline.toString()\r\n    });\r\n    const invoiceResp = await fetch('https://api.stripe.com/v1/invoices', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: invoiceBody\r\n    });\r\n    if (!invoiceResp.ok) {\r\n      throw new Error(`Error creating draft invoice: ${invoiceResp.statusText}`);\r\n    }\r\n    const invoiceData = await invoiceResp.json();\r\n    let kitItemBody = new URLSearchParams({\r\n      customer: customerStripeId,\r\n      invoice: invoiceData.id,\r\n      amount: kitAmount.toString(),\r\n      currency: kitCurrency,\r\n      description: `One-time kit purchase: ${selectedLicenseType}`\r\n    });\r\n    const kitItemResp = await fetch('https://api.stripe.com/v1/invoiceitems', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: kitItemBody\r\n    });\r\n    if (!kitItemResp.ok) {\r\n      throw new Error(`Error creating kit invoice item: ${kitItemResp.statusText}`);\r\n    }\r\n    if (co2SensorProduct && sensorCount > 0) {\r\n      let sensorPriceAttrResp = await fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${co2SensorProduct.id.id}/values/attributes?keys=price_stripe_id`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'accept': 'application/json',\r\n          'X-Authorization': 'Bearer ' + bearerToken\r\n        }\r\n      });\r\n      let sensorPriceAttrData = await sensorPriceAttrResp.json();\r\n      let sensorAttr = sensorPriceAttrData.find(a => a.key === 'price_stripe_id');\r\n      if (sensorAttr) {\r\n        let sensorPriceId = sensorAttr.value;\r\n        const sensorPriceResp = await fetch(`https://api.stripe.com/v1/prices/${sensorPriceId}`, {\r\n          method: 'GET',\r\n          headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n        });\r\n        if (!sensorPriceResp.ok) {\r\n          throw new Error(`Error fetching sensor price details: ${sensorPriceResp.statusText}`);\r\n        }\r\n        const sensorPriceData = await sensorPriceResp.json();\r\n        let sensorAmount = sensorPriceData.unit_amount;\r\n        let sensorCurrency = sensorPriceData.currency;\r\n        let sensorItemBody = new URLSearchParams({\r\n          customer: customerStripeId,\r\n          invoice: invoiceData.id,\r\n          amount: (sensorAmount * sensorCount).toString(),\r\n          currency: sensorCurrency,\r\n          description: `One-time purchase: ${sensorCount} CO2/Room Sensors`\r\n        });\r\n        const sensorItemResp = await fetch('https://api.stripe.com/v1/invoiceitems', {\r\n          method: 'POST',\r\n          headers: {\r\n            'Authorization': `Bearer ${stripeSecretKey}`,\r\n            'Content-Type': 'application/x-www-form-urlencoded'\r\n          },\r\n          body: sensorItemBody\r\n        });\r\n        if (!sensorItemResp.ok) {\r\n          throw new Error(`Error creating sensor invoice item: ${sensorItemResp.statusText}`);\r\n        }\r\n      }\r\n    }\r\n    const finalizeResp = await fetch(`https://api.stripe.com/v1/invoices/${invoiceData.id}/finalize`, {\r\n      method: 'POST',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!finalizeResp.ok) {\r\n      throw new Error(`Error finalizing invoice: ${finalizeResp.statusText}`);\r\n    }\r\n    await finalizeResp.json();\r\n    const attributes = [\r\n      { key: \"invoiceIdKitBuy\", value: invoiceData.id }\r\n    ];\r\n    attributeService.saveEntityAttributes(doctorkitId, \"SERVER_SCOPE\", attributes).subscribe(\r\n      () => {\r\n        alert(\"Invoice created and sent for one-time purchase!\");\r\n        instance.dialogRef.close(null);\r\n      },\r\n      (error) => {\r\n        console.error('Error updating one-time invoice attributes:', error);\r\n        instance.dialogRef.close(null);\r\n      }\r\n    );\r\n  } catch (err) {\r\n    console.error(\"Error creating one-time invoice with sensors:\", err);\r\n    alert(\"Failed to create invoice. Please try again.\");\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------\r\n// (Optional) For open payments in detail\r\n// ---------------------------------------------------\r\nfunction manageOpenPayments(instance) {\r\n  let vm = instance;\r\n  vm.lastInvoiceStatus = lastInvoiceStatus;\r\n  vm.nextPaymentDate = nextPaymentDate;\r\n  vm.subscriptionStartDate = subscriptionStartDate;\r\n  vm.subscriptionPrice = subscriptionPrice;\r\n  vm.billingCycle = billingCycle;\r\n  vm.nextPaymentAttempt = nextPaymentAttempt;\r\n  vm.subscriptionStatus = subscriptionStatus;\r\n  vm.subscriptionEndDate = subscriptionEndDate;\r\n  vm.initiatePayment = async function() {\r\n    if (hostedInvoiceUrl) { window.location.href = hostedInvoiceUrl; }\r\n  };\r\n  vm.cancel = function() { vm.dialogRef.close(null); };\r\n  window.addEventListener('focus', checkSessionStatusOnce);\r\n  function checkSessionStatusOnce() {\r\n    if (sessionId) {\r\n      fetch(`https://api.stripe.com/v1/invoices/${sessionId}`, {\r\n        method: 'GET',\r\n        headers: { 'Authorization': `Bearer ${stripeSecretKey}`, 'Content-Type': 'application/json' }\r\n      })\r\n      .then(response => response.json())\r\n      .then(invoice => {\r\n        if (invoice.status === 'paid' || invoice.status === 'open') { vm.dialogRef.close(null); }\r\n      })\r\n      .catch(error => {\r\n        console.error('Error checking invoice status:', error);\r\n        vm.dialogRef.close(null);\r\n      });\r\n    }\r\n    window.removeEventListener('focus', checkSessionStatusOnce);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "51144411-138c-66a2-5449-82564dca8d2f"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.open-payments}",
                "icon": "payments",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false\r\n",
                "type": "customPretty",
                "customHtml": "<form #paymentForm=\"ngForm\" (ngSubmit)=\"initiatePayment()\" class=\"add-entity-form\">\r\n    <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n        <h2>Subscription Status</h2>\r\n        <span fxFlex></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\" style=\"position: absolute; right: 0;\">\r\n            <mat-icon class=\"material-icons\">close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n    <div mat-dialog-content fxLayout=\"column\">\r\n        <table class=\"subscription-table\">\r\n            <thead>\r\n                <tr>\r\n                    <th>Start Date</th>\r\n                    <th>Price</th>\r\n                    <th>Billing Cycle</th>\r\n                    <th>Next Billing</th>\r\n                    <th *ngIf=\"nextPaymentAttempt\">Next Payment Attempt</th>\r\n                    <th *ngIf=\"subscriptionStatus === 'canceled' || subscriptionStatus === 'cancelled_at_trial_end'\">Subscription End</th>\r\n                    <th>Status</th>\r\n                </tr>\r\n            </thead>\r\n            <tbody>\r\n                <tr>\r\n                    <td>{{ subscriptionStartDate }}</td>\r\n                    <td>{{ subscriptionPrice }}</td>\r\n                    <td>{{ billingCycle }}</td>\r\n                    <td>{{ nextPaymentDate }}</td>\r\n                    <td *ngIf=\"nextPaymentAttempt\">{{ nextPaymentAttempt }}</td>\r\n                    <td *ngIf=\"subscriptionStatus === 'canceled' || subscriptionStatus === 'cancelled_at_trial_end'\">{{ subscriptionEndDate }}</td>\r\n                    <td>\r\n                        <span class=\"status-label\" [ngClass]=\"{\r\n                            'status-active': subscriptionStatus === 'active',\r\n                            'status-open-payment': subscriptionStatus === 'open',\r\n                            'status-canceled': subscriptionStatus === 'canceled',\r\n                            'status-cancelled-trial': subscriptionStatus === 'cancelled_at_trial_end'\r\n                        }\">\r\n                            {{ subscriptionStatus }}\r\n                        </span>\r\n                    </td>\r\n                </tr>\r\n            </tbody>\r\n        </table>\r\n    </div>\r\n    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n        <button mat-button color=\"primary\" type=\"button\" [disabled]=\"(isLoading$ | async)\" (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n        </button>\r\n        <button mat-raised-button color=\"primary\" type=\"submit\" *ngIf=\"subscriptionStatus === 'open'\" [disabled]=\"(isLoading$ | async)\">\r\n            Pay\r\n        </button>\r\n    </div>\r\n</form>",
                "customCss": ".edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n\n.subscription-table {\n    width: 100%;\n    border-collapse: collapse;\n    margin: 20px 0;\n    font-size: 16px;\n    text-align: left;\n}\n.subscription-table th, .subscription-table td {\n    border: 1px solid #ddd;\n    padding: 8px;\n}\n.subscription-table th {\n    background-color: #f2f2f2;\n    font-weight: bold;\n}\n.status-label {\n    padding: 5px 10px;\n    border-radius: 15px;\n    color: #fff;\n    font-weight: bold;\n    display: inline-block;\n}\n.status-active {\n    background-color: #4caf50; /* Green for active */\n}\n.status-open-payment {\n    background-color: #ffeb3b; /* Yellow for open payment */\n}\n.status-canceled {\n    background-color: #f44336; /* Red for canceled */\n}\n.status-cancelled-trial {\n    background-color: #ff9800; /* Orange for cancelled at trial end */\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet assetProfileService = $injector.get(widgetContext.servicesMap.get('assetProfileService'));\nlet tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\nlet stripeSecretKey;\nlet sessionId = ''; // Store the session ID globally\nlet doctorkitId = entityId;\nlet customerId;\nlet customerStripeId;\nlet subscriptionId;\nlet lastInvoiceStatus;\nlet hostedInvoiceUrl;\nlet nextPaymentDate;\nlet subscriptionStartDate;\nlet subscriptionPrice;\nlet billingCycle;\nlet nextPaymentAttempt;\nlet subscriptionStatus;\nlet subscriptionEndDate;\nlet unpaidInvoiceToPay;\n\nassetService.getAssetInfo(doctorkitId.id).subscribe(info => {\n    console.log(\"CustomerID\", info.customerId);\n    customerId = info.customerId;\n\n    attributeService.getEntityAttributes({ entityType: 'TENANT', id: tenantId }, \"SERVER_SCOPE\", ['stripeKey']).subscribe(attribute => {\n        console.log(\"Attribute\", attribute);\n        stripeSecretKey = attribute[0].value;\n\n        attributeService.getEntityAttributes(doctorkitId, \"SERVER_SCOPE\", ['subscriptionId']).subscribe(subscription => {\n            console.log(\"subscription\", subscription);\n            subscriptionId = subscription?.[0]?.value || null;\n            console.log(\"subscriptionId\", subscriptionId);\n            attributeService.getEntityAttributes(customerId, \"SERVER_SCOPE\", ['stripe_id']).subscribe(stripeId => {\n                customerStripeId = stripeId?.[0]?.value || null;\n                console.log(\"customerStripeId\", customerStripeId);\n\n                if (subscriptionId && customerStripeId) {\n                    handleSubscriptionDetails(subscriptionId).then(() => {\n                        handleUnpaidInvoices(subscriptionId, customerStripeId).then(() => {\n                            determineSubscriptionStatus();\n                            openAddEntityDialog();\n                        });\n                    });\n                }\n                else {\n                    //toast(\"There is no subscription completed for this Doctorkit\");\n                }\n            });\n        });\n    });\n});\n\nasync function handleSubscriptionDetails(subscriptionId) {\n    try {\n        // Fetch the subscription details from Stripe\n        const subscriptionResponse = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\n            method: 'GET',\n            headers: {\n                'Authorization': `Bearer ${stripeSecretKey}`,\n                'Content-Type': 'application/json'\n            }\n        });\n        const subscription = await subscriptionResponse.json();\n        console.log('Subscription details:', subscription);\n        // Extract next payment date, subscription start date, price, and billing cycle\n        subscriptionStartDate = new Date(subscription.start_date * 1000).toLocaleDateString();\n        nextPaymentDate = new Date(subscription.current_period_end * 1000).toLocaleDateString();\n        subscriptionPrice = (subscription.plan.amount / 100).toFixed(2) + ' ' + subscription.plan.currency.toUpperCase();\n        billingCycle = subscription.plan.interval;\n\n        if (subscription.cancel_at_period_end) {\n            subscriptionEndDate = new Date(subscription.current_period_end * 1000).toLocaleDateString();\n            const currentDate = new Date().setHours(0, 0, 0, 0);\n            const endDate = new Date(subscription.current_period_end).setHours(0, 0, 0, 0);\n\n            if (subscription.status === 'canceled' && endDate < currentDate) {\n                subscriptionStatus = 'canceled';\n            } else {\n                subscriptionStatus = 'cancelled_at_trial_end';\n            }\n        } else if (subscription.status === 'canceled') {\n            subscriptionEndDate = new Date(subscription.canceled_at * 1000).toLocaleDateString();\n            subscriptionStatus = 'canceled';\n        } else if (subscription.status === 'active') {\n            subscriptionStatus = 'active';\n        }\n    } catch (error) {\n        console.error('Error fetching subscription details:', error);\n    }\n}\n\nasync function handleUnpaidInvoices(subscriptionId, customerStripeId) {\n    try {\n        // Retrieve all invoices for the subscription\n        const invoiceResponse = await fetch(`https://api.stripe.com/v1/invoices?subscription=${subscriptionId}&limit=100`, {\n            method: 'GET',\n            headers: {\n                'Authorization': `Bearer ${stripeSecretKey}`,\n                'Content-Type': 'application/json'\n            }\n        });\n\n        const invoices = await invoiceResponse.json();\n\n        if (invoices.data.length === 0) {\n            console.log('No invoices found for the specified subscription.');\n            return;\n        }\n\n        // Check for any invoices with the status \"open\"\n        const unpaidInvoices = invoices.data.filter(invoice => invoice.status === 'open');\n        \n        if (unpaidInvoices.length > 0) {\n            console.log('There are unpaid invoices:', unpaidInvoices);\n            lastInvoiceStatus = 'open';\n            unpaidInvoiceToPay = unpaidInvoices[0];\n            nextPaymentAttempt = unpaidInvoiceToPay.next_payment_attempt\n                ? new Date(unpaidInvoiceToPay.next_payment_attempt * 1000).toLocaleDateString()\n                : null;\n            hostedInvoiceUrl = unpaidInvoiceToPay.hosted_invoice_url;\n        } else {\n            console.log('No unpaid invoices found.');\n            lastInvoiceStatus = 'paid';\n        }\n    } catch (error) {\n        console.error('Error handling unpaid invoices:', error);\n    }\n}\n\nfunction determineSubscriptionStatus() {\n    if (subscriptionStatus === 'cancelled_at_trial_end' || subscriptionStatus === 'canceled') {\n        // Do not override if already canceled or set to cancel at end of trial\n        return;\n    }\n\n    if (lastInvoiceStatus === 'paid' || lastInvoiceStatus === 'draft') {\n        subscriptionStatus = 'active';\n    } else if (lastInvoiceStatus === 'open') {\n        subscriptionStatus = 'open';\n    }\n}\n\nfunction openAddEntityDialog() {\n    customDialog.customDialog(htmlTemplate, (instance) => manageOpenPayments(instance)).subscribe();\n}\n\nfunction manageOpenPayments(instance) {\n    let vm = instance;\n    vm.lastInvoiceStatus = lastInvoiceStatus;\n    vm.nextPaymentDate = nextPaymentDate;\n    vm.subscriptionStartDate = subscriptionStartDate;\n    vm.subscriptionPrice = subscriptionPrice;\n    vm.billingCycle = billingCycle;\n    vm.nextPaymentAttempt = nextPaymentAttempt;\n    vm.subscriptionStatus = subscriptionStatus;\n    vm.subscriptionEndDate = subscriptionEndDate;\n    vm.initiatePayment = async function() {\n        if (hostedInvoiceUrl) {\n            window.open(hostedInvoiceUrl, '_blank');\n            /*try {\n                // Retrieve the unpaid invoice to check if the payment was done\n                const invoiceResponse = await fetch(`https://api.stripe.com/v1/invoices/${unpaidInvoiceToPay.id}`, {\n                    method: 'GET',\n                    headers: {\n                        'Authorization': `Bearer ${stripeSecretKey}`,\n                        'Content-Type': 'application/json'\n                    }\n                });\n\n                const invoice = await invoiceResponse.json();\n\n                console.log('Invoice retrieved after payment attempt:', invoice);\n                console.log('Invoice status:', invoice.status);\n\n                if (invoice.status === 'paid') {\n                    //alert('Payment successful.');\n                    console.log('Payment successful.');\n                    const attributes = [\n                        { key: \"licenseActitivationStatus\", value: true },\n                    ];\n                    attributeService.saveEntityAttributes(\n                        doctorkitId,\n                        \"SERVER_SCOPE\",\n                        attributes\n                    ).subscribe(\n                        () => {\n                            console.log('Analysis attribute saved successfully.');\n                            vm.dialogRef.close(null);\n                        },\n                        (error) => {\n                            console.error('Error saving licenseActivationStatus attribute:', error);\n                        }\n                    );\n                } else if (invoice.status === 'open') {\n                    console.log('Payment not completed.');\n                    //alert('Payment not completed.');\n                    vm.dialogRef.close(null);\n                }\n            } catch (error) {\n                console.error('Error checking invoice status:', error);\n                alert('Error checking invoice status:', error);\n            }*/\n        }\n    };\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n    window.addEventListener('focus', checkSessionStatusOnce);\n\n    // Check session status when user returns to the tab\n    function checkSessionStatusOnce() {\n        if (sessionId) {\n            fetch(`https://api.stripe.com/v1/invoices/${sessionId}`, {\n                method: 'GET',\n                headers: {\n                    'Authorization': `Bearer ${stripeSecretKey}`,\n                    'Content-Type': 'application/json'\n                }\n            })\n                .then(response => response.json())\n                .then(invoice => {\n                    console.log('Invoice status:', invoice.status);\n\n                    if (invoice.status === 'paid') {\n                        console.log('Payment successful.');\n                        //alert('Payment successful.');\n                        attributeService.saveEntityAttributes(\n                            doctorkitId,\n                            \"SERVER_SCOPE\",\n                            attributes\n                        ).subscribe(\n                            () => {\n                                console.log('Analysis attribute saved successfully.');\n                                vm.dialogRef.close(null);\n                            },\n                            (error) => {\n                                console.error('Error saving licenseActivationStatus attribute:', error);\n                            }\n                        );\n                        vm.dialogRef.close(null);\n                    } else if (invoice.status === 'open') {\n                        console.log('Payment not completed.');\n                        //alert('Payment not completed.');\n                        vm.dialogRef.close(null);\n                    }\n                })\n                .catch(error => {\n                    console.error('Error checking invoice status:', error);\n                    //alert('Error checking invoice status:', error);\n                    vm.dialogRef.close(null);\n                });\n        }\n        window.removeEventListener('focus', checkSessionStatusOnce);\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "169c33f1-a2e4-c0ab-8558-7fed9e3755f9"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.cancel-subscription}",
                "icon": "cancel",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;\n",
                "type": "custom",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\r\nlet stripeSecretKey;\r\nlet subscriptionId;\r\n\r\nattributeService.getEntityAttributes({ entityType: 'TENANT', id: tenantId }, \"SERVER_SCOPE\", ['stripeKey']).subscribe(attribute => {\r\n  console.log(\"Attribute\", attribute);\r\n  if (attribute && attribute.length > 0 && attribute[0].hasOwnProperty('value')) {\r\n    stripeSecretKey = attribute[0].value;\r\n    attributeService.getEntityAttributes(entityId, \"SERVER_SCOPE\", ['subscriptionId']).subscribe(attribute => {\r\n      if (attribute && attribute.length > 0 && attribute[0].hasOwnProperty('value')) {\r\n        subscriptionId = attribute[0].value || null;\r\n      }\r\n\r\n      if (subscriptionId) {\r\n        openCancelSubscriptionDialog();\r\n      } else {\r\n        alert(\"Doktorkit has no active Subscription!\");\r\n      }\r\n    });\r\n  } else {\r\n    alert(\"Stripe key not found for tenant!\");\r\n  }\r\n});\r\n\r\nfunction openCancelSubscriptionDialog() {\r\n  var title = 'Are you sure you want to cancel the subscription for ' + entityName + '?';\r\n  var content = 'Be careful, after confirmation, the subscription will be set to cancel at the end of the current period!';\r\n  dialogs.confirm(title, content, 'Cancel', 'Confirm Cancellation').subscribe(\r\n    function(result) {\r\n      if (result) {\r\n        cancelSubscriptionAtPeriodEnd();\r\n      }\r\n    }\r\n  );\r\n}\r\n\r\nasync function cancelSubscriptionAtPeriodEnd() {\r\n  if (!stripeSecretKey || !subscriptionId) {\r\n    console.error('Missing required information to cancel subscription.');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const url = `https://api.stripe.com/v1/subscriptions/${subscriptionId}`;\r\n    const headers = {\r\n      'Authorization': `Bearer ${stripeSecretKey}`,\r\n      'Content-Type': 'application/x-www-form-urlencoded'\r\n    };\r\n    const body = 'cancel_at_period_end=true';\r\n\r\n    const response = await fetch(url, {\r\n      method: 'POST',\r\n      headers: headers,\r\n      body: body\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error('Failed to set subscription to cancel at period end');\r\n    }\r\n\r\n    const responseData = await response.json();\r\n    console.log('Subscription set to cancel at period end successfully:', responseData);\r\n    alert('Subscription set to cancel at the end of the current period successfully!');\r\n    widgetContext.updateAliases();\r\n  } catch (error) {\r\n    console.error('Failed to set subscription to cancel at period end:', error);\r\n  }\r\n}\r\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7c7d6f3d-6cbd-7c01-b7d0-75c94fa8d94e"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.next-delete-diagnostic-kit}",
                "icon": "delete",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteDiagnostickitDialog();\n\nfunction openDeleteDiagnostickitDialog() {\n  let titleTranslation = translationService.instant(\n    'custom.diagnostic-kits.delete.title',\n    { entityName: entityName }\n  );\n\n  let contentTranslation = translationService.instant(\n    'custom.diagnostic-kits.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteDiagnostickit();\n    }\n  });\n}\n\nfunction deleteDiagnostickit() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteDiagnostickitToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Diagnostickit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Diagnostickit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDiagnostickitToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "338d9fd7-c752-eb0e-4687-2c2e32ca1a32"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:action.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n//params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "86c3f72e-d682-b95b-e997-3167fc8c83cd"
              },
              {
                "name": "Activate Multiple Kits",
                "icon": "verified",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "/*var userRole = widgetContext.stateController.getStateParams().userRole;\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\"&& userRole !== \"ECO Administrator\"){\n    return true;\n}else{\n    return false;\n}*/\nreturn false;",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"addEntityFormGroup\" (ngSubmit)=\"onSubmit()\" class=\"add-entity-form\">\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\n    <h2>Manage Doktorkits</h2>\n    <span fxFlex></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n\n  <!-- Alert Messages Container -->\n  <div *ngIf=\"alerts && alerts.length\">\n    <div\n      *ngFor=\"let alert of alerts; let i = index\"\n      class=\"alert\"\n      [ngClass]=\"{\n        'alert-error': alert.type === 'error',\n        'alert-warning': alert.type === 'warning',\n        'alert-success': alert.type === 'success'\n      }\"\n    >\n      {{ alert.message }}\n      <span class=\"close-btn\" (click)=\"removeAlert(i)\">&times;</span>\n    </div>\n  </div>\n\n  <div mat-dialog-content fxLayout=\"column\">\n    <ng-container *ngIf=\"currentStep === 1\">\n      <!-- STEP 1: Select Kits -->\n      <div fxLayout=\"column\" fxLayoutGap=\"8px\">\n        <mat-form-field class=\"mat-block\">\n          <mat-label>Select Doktorkits</mat-label>\n          <mat-select formControlName=\"selectedKits\" multiple>\n            <mat-option *ngFor=\"let kit of kits\" [value]=\"kit.id.id\">\n              {{ kit.name }}\n            </mat-option>\n          </mat-select>\n          <mat-error *ngIf=\"addEntityFormGroup.get('selectedKits')?.errors?.required\">\n            Please select at least one Doktorkit\n          </mat-error>\n        </mat-form-field>\n      </div>\n    </ng-container>\n\n    <ng-container *ngIf=\"currentStep === 2\">\n      <!-- STEP 2: Product + Invoice Option -->\n      <div fxLayout=\"column\" fxLayoutGap=\"8px\">\n        <mat-form-field class=\"mat-block\">\n          <mat-label>Select Product</mat-label>\n          <mat-select formControlName=\"product\" required>\n            <mat-option *ngFor=\"let product of products\" [value]=\"product.id.id\">\n              {{ product.name }}\n            </mat-option>\n          </mat-select>\n          <mat-error *ngIf=\"addEntityFormGroup.get('product')?.errors?.required\">\n            Product selection is required\n          </mat-error>\n        </mat-form-field>\n\n        <mat-checkbox formControlName=\"invoice\">\n          Pay by Invoice (send invoice to customer email)\n        </mat-checkbox>\n      </div>\n    </ng-container>\n  </div>\n\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\n    <button mat-button color=\"primary\" type=\"button\" (click)=\"onPrevious()\" *ngIf=\"currentStep === 2\">\n      Previous\n    </button>\n    <button mat-button color=\"primary\" type=\"button\" (click)=\"onNext()\" *ngIf=\"currentStep === 1\">\n      Next\n    </button>\n    <button\n      mat-button\n      mat-raised-button\n      color=\"primary\"\n      type=\"submit\"\n      *ngIf=\"currentStep === 2\"\n      [disabled]=\"(isLoading$ | async) || addEntityFormGroup.invalid\"\n    >\n      Complete\n    </button>\n    <button mat-button color=\"primary\" type=\"button\" [disabled]=\"(isLoading$ | async)\" (click)=\"cancel()\">\n      Cancel\n    </button>\n  </div>\n</form>",
                "customCss": " /* Base alert styling */\n  .alert {\n    display: flex;\n    align-items: center;\n    padding: 1rem;\n    margin: 0.5rem 0;\n    border-radius: 4px;\n    color: #fff;\n    font-weight: 500;\n    font-family: sans-serif;\n    position: relative;\n  }\n\n  .alert .close-btn {\n    margin-left: auto;\n    cursor: pointer;\n    font-weight: bold;\n    padding: 0 0.5rem;\n    opacity: 0.8;\n  }\n  .alert .close-btn:hover {\n    opacity: 1;\n  }\n\n  /* Error (Red) */\n  .alert-error {\n    background-color: #f44336;\n    border-left: 6px solid #d32f2f;\n  }\n\n  /* Success (Green) */\n  .alert-success {\n    background-color: #4caf50;\n    border-left: 6px solid #388e3c;\n  }\n\n  /* Warning (Orange) */\n  .alert-warning {\n    background-color: #ff9800;\n    border-left: 6px solid #f57c00;\n  }",
                "customFunction": "// Initialize necessary services and variables\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet PageLink = widgetContext.pageLink;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet assetProfileService = $injector.get(widgetContext.servicesMap.get('assetProfileService'));\r\n\r\nlet tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\r\nlet stripeSecretKey;\r\nlet sessionId = '';\r\nlet products = [];\r\nlet kits = [];\r\nlet selectedKits = [];\r\nlet selectedProductId = '';\r\nlet selectedLicenseType = '';\r\nlet customer = widgetContext.stateController.getStateParams().entityId.id; \r\nlet customerId;\r\nlet customerStripeId;\r\nlet subscriptionId;\r\nlet kitMap = {};\r\n\r\nvar pageLink = PageLink(50, 0);\r\n\r\n// Define queries\r\nvar query = {\r\n  parameters: {\r\n    rootId: tenantId,\r\n    rootType: \"TENANT\",\r\n    direction: \"FROM\",\r\n    relationTypeGroup: \"COMMON\",\r\n    maxLevel: 1073741824,\r\n    fetchLastLevelOnly: true\r\n  },\r\n  relationType: \"Contains\",\r\n  assetTypes: [\"Product\"]\r\n};\r\n\r\nvar queryKit = {\r\n  parameters: {\r\n    rootId: customer,\r\n    rootType: \"CUSTOMER\",\r\n    direction: \"FROM\",\r\n    relationTypeGroup: \"COMMON\",\r\n    maxLevel: 1,\r\n    fetchLastLevelOnly: false\r\n  },\r\n  relationType: \"Owns\",\r\n  assetTypes: [\"Doktorkit\"]\r\n};\r\n\r\n// Initialization function\r\nfunction init() {\r\n  fetchProductsKitsAndOpenDialog();\r\n}\r\ninit();\r\n\r\n// Fetch products and kits, then open dialog\r\nfunction fetchProductsKitsAndOpenDialog() {\r\n  attributeService\r\n    .getEntityAttributes({ entityType: \"TENANT\", id: tenantId }, \"SERVER_SCOPE\", [\"stripeKey\"])\r\n    .subscribe((attr) => {\r\n      stripeSecretKey = attr[0].value;\r\n      /*console.log(\"Fetched Stripe Secret Key:\", stripeSecretKey);*/\r\n\r\n      assetService.findByQuery(queryKit).subscribe((allKits) => {\r\n        kits = allKits;\r\n        kits.forEach((k) => {\r\n          kitMap[k.id.id] = { name: k.name, id: k.id.id };\r\n        });\r\n\r\n        assetService.findByQuery(query).subscribe((assets) => {\r\n          let filteredProducts = [];\r\n          let productFetches = assets.map((asset) => {\r\n            return attributeService\r\n              .getEntityAttributes(asset.id, \"SERVER_SCOPE\", [\"prodType\"])\r\n              .toPromise()\r\n              .then((attributes) => {\r\n                if (\r\n                  attributes.length > 0 &&\r\n                  attributes[0].key === \"prodType\" &&\r\n                  attributes[0].value === \"doktorkit\"\r\n                ) {\r\n                  filteredProducts.push(asset);\r\n                }\r\n              });\r\n          });\r\n          Promise.all(productFetches).then(() => {\r\n            products = filteredProducts;\r\n            openAddEntityDialog();\r\n          });\r\n        });\r\n      });\r\n    }, (error) => {\r\n      console.error(\"Error fetching tenant attributes:\", error);\r\n    });\r\n}\r\n\r\n// Open the dialog\r\nfunction openAddEntityDialog(billingCycleAnchor = null) {\r\n  customDialog.customDialog(htmlTemplate, (instance) => \r\n    AddEntityDialogController(instance, billingCycleAnchor)\r\n  ).subscribe();\r\n}\r\n\r\n// Dialog Controller\r\nfunction AddEntityDialogController(instance, billingCycleAnchor) {\r\n  let vm = instance;\r\n  vm.currentStep = 1;\r\n  vm.kits = kits;\r\n  vm.products = products;\r\n  vm.selectedKits = [];\r\n\r\n  // Store multiple alerts\r\n  vm.alerts = [];\r\n\r\n  // Initialize form\r\n  vm.addEntityFormGroup = vm.fb.group({\r\n    selectedKits: [[], [vm.validators.required]],\r\n    product: [\"\", [vm.validators.required]],\r\n    invoice: [false]\r\n  });\r\n\r\n  // Cancel function\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  // Next step\r\n  vm.onNext = function () {\r\n    let next = true;  \r\n    vm.selectedKits = vm.addEntityFormGroup.value.selectedKits;\r\n    if (!vm.selectedKits || !vm.selectedKits.length) {\r\n      addAlert(\"Please select at least one Doktorkit\", \"error\");\r\n      return;\r\n    }\r\n    checkKitsValidity(vm.selectedKits).then((result) => {\r\n      let { validKitIds, noDeviceKits, activeSubKits } = result;\r\n\r\n      if (noDeviceKits.length > 0) {\r\n        addAlert(\r\n          `These selected kits have no assigned devices: ${noDeviceKits.map((id) => kitMap[id].name).join(\", \")}`,\r\n          \"warning\"\r\n        );\r\n        next = false;\r\n      }\r\n      if (activeSubKits.length > 0) {\r\n        addAlert(\r\n          `These selected kits already have an active subscription: ${activeSubKits.map((id) => kitMap[id].name).join(\", \")}`,\r\n          \"warning\"\r\n        );\r\n        next = false;\r\n      }\r\n      if(next){\r\n          vm.currentStep = 2;\r\n      }\r\n    });\r\n  };\r\n\r\n  // Previous step\r\n  vm.onPrevious = function () {\r\n    vm.currentStep = 1;\r\n  };\r\n\r\n  // Submit function\r\n  vm.onSubmit = function () {\r\n    const formValues = vm.addEntityFormGroup.value;\r\n    selectedProductId = formValues.product;\r\n    selectedKits = formValues.selectedKits;\r\n    let payByInvoice = formValues.invoice;\r\n\r\n    const selectedProduct = vm.products.find((p) => p.id.id === selectedProductId);\r\n    if (selectedProduct) {\r\n      if (/base/i.test(selectedProduct.name)) {\r\n        selectedLicenseType = \"Base\";\r\n      } else if (/pro/i.test(selectedProduct.name)) {\r\n        selectedLicenseType = \"Pro\";\r\n      } else {\r\n        selectedLicenseType = \"Unknown\";\r\n      }\r\n    } else {\r\n      selectedLicenseType = \"Unknown\";\r\n    }\r\n\r\n    attributeService\r\n      .getEntityAttributes({ entityType: \"ASSET\", id: selectedProductId }, \"SERVER_SCOPE\", [\"price_stripe_id\"])\r\n      .subscribe((attributes) => {\r\n        if (attributes.length > 0 && attributes[0].key === \"price_stripe_id\") {\r\n          const priceId = attributes[0].value;\r\n\r\n          if (payByInvoice) {\r\n            createSubscriptionInvoiceMethod(selectedKits, priceId).then((subscriptionData) => {\r\n              if (subscriptionData) {\r\n                let subId = subscriptionData.id;\r\n                let updates = selectedKits.map((kitId) => {\r\n                  let attrs = [\r\n                    { key: \"subscriptionId\", value: subId },\r\n                    { key: \"licenseActivationStatus\", value: false },\r\n                    { key: \"licenseType\", value: selectedLicenseType }\r\n                  ];\r\n                  return attributeService\r\n                    .saveEntityAttributes({ entityType: \"ASSET\", id: kitId }, \"SERVER_SCOPE\", attrs)\r\n                    .toPromise();\r\n                });\r\n                Promise.all(updates)\r\n                  .then(() => {\r\n                    addAlert(\"Subscription created via invoice. Invoice sent immediately!\", \"success\");\r\n                    vm.dialogRef.close(null);\r\n                  })\r\n                  .catch((err) => {\r\n                    console.error(\"Error saving invoice attributes:\", err);\r\n                    addAlert(\"Failed to save invoice attributes.\", \"error\");\r\n                    vm.dialogRef.close(null);\r\n                  });\r\n              } else {\r\n                addAlert(\"Invoice subscription creation failed. Please try again.\", \"error\");\r\n              }\r\n            });\r\n          } else {\r\n            createCheckoutSessionForAllKits(selectedKits, priceId, vm, billingCycleAnchor);\r\n          }\r\n        } else {\r\n          addAlert(\"Price ID not found for the selected product.\", \"error\");\r\n        }\r\n      }, (error) => {\r\n        console.error(\"Error fetching price attributes:\", error);\r\n        addAlert(\"Error fetching price details.\", \"error\");\r\n      });\r\n  };\r\n\r\n  // Remove alert\r\n  vm.removeAlert = function (index) {\r\n    vm.alerts.splice(index, 1);\r\n  };\r\n\r\n  // Add alert\r\n  function addAlert(message, type) {\r\n    vm.alerts.push({ message, type });\r\n  }\r\n\r\n  // Check validity of selected kits\r\n  async function checkKitsValidity(kitIds) {\r\n    let validKitIds = [];\r\n    let noDeviceKits = [];\r\n    let activeSubKits = [];\r\n\r\n    for (let kitId of kitIds) {\r\n      let { isValid, reason } = await validateKit(kitId);\r\n      if (isValid) {\r\n        validKitIds.push(kitId);\r\n      } else {\r\n        if (reason === \"no-devices\") {\r\n          noDeviceKits.push(kitId);\r\n        } else if (reason === \"active-sub\") {\r\n          activeSubKits.push(kitId);\r\n        }\r\n      }\r\n    }\r\n    return { validKitIds, noDeviceKits, activeSubKits };\r\n  }\r\n\r\n  // Validate individual kit\r\n  async function validateKit(kitId) {\r\n    try {\r\n      let kitInfo = await assetService.getAssetInfo(kitId).toPromise();\r\n      customerId = kitInfo.customerId;\r\n\r\n      const deviceSearchQuery = {\r\n        parameters: {\r\n          rootId: kitId,\r\n          rootType: \"ASSET\",\r\n          direction: \"FROM\",\r\n          relationTypeGroup: \"COMMON\",\r\n          maxLevel: 100,\r\n          fetchLastLevelOnly: false\r\n        },\r\n        relationType: \"Contains\",\r\n        deviceTypes: [\"P-Flow D116\"]\r\n      };\r\n      let devices = await deviceService.findByQuery(deviceSearchQuery).toPromise();\r\n\r\n      if (devices && devices.length > 0) {\r\n        let existingSub = await attributeService\r\n          .getEntityAttributes({ entityType: \"ASSET\", id: kitId }, \"SERVER_SCOPE\", [\"subscriptionId\"])\r\n          .toPromise();\r\n        subscriptionId = existingSub?.[0]?.value || null;\r\n\r\n        if (subscriptionId) {\r\n          let subscriptionData = await checkSubscriptionStatus(subscriptionId);\r\n          if (subscriptionData && subscriptionData.status === \"active\") {\r\n            if (subscriptionData.cancel_at_period_end) {\r\n              return { isValid: true };\r\n            } else {\r\n              return { isValid: false, reason: \"active-sub\" };\r\n            }\r\n          } else {\r\n            return { isValid: true };\r\n          }\r\n        } else {\r\n          return { isValid: true };\r\n        }\r\n      } else {\r\n        return { isValid: false, reason: \"no-devices\" };\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Error validating kit:\", err);\r\n      return { isValid: false, reason: \"error\" };\r\n    }\r\n  }\r\n}\r\n\r\n// Function to create subscription via invoice\r\nasync function createSubscriptionInvoiceMethod(kitIds, priceId) {\r\n  try {\r\n    let firstKitInfo = await assetService.getAssetInfo(kitIds[0]).toPromise();\r\n    let tbCustId = firstKitInfo.customerId;\r\n\r\n    let attributeStripeKey = await attributeService\r\n      .getEntityAttributes({ entityType: \"TENANT\", id: tenantId }, \"SERVER_SCOPE\", [\"stripeKey\"])\r\n      .toPromise();\r\n    stripeSecretKey = attributeStripeKey?.[0]?.value || null;\r\n\r\n    let custStripeAttr = await attributeService\r\n      .getEntityAttributes(\r\n        { entityType: \"CUSTOMER\", id: tbCustId.id ? tbCustId.id : tbCustId },\r\n        \"SERVER_SCOPE\",\r\n        [\"stripe_id\"]\r\n      )\r\n      .toPromise();\r\n    let stripeCustomerId = custStripeAttr?.[0]?.value || null;\r\n    if (!stripeCustomerId) {\r\n      console.error(\"No stripe_id found for this customer. Cannot create subscription!\");\r\n      return null;\r\n    }\r\n\r\n    let quantity = kitIds.length;\r\n    let subParams = new URLSearchParams({\r\n      customer: stripeCustomerId,\r\n      \"items[0][price]\": priceId,\r\n      \"items[0][quantity]\": quantity.toString(),\r\n      collection_method: \"send_invoice\",\r\n      days_until_due: \"14\",\r\n      \"expand[]\": \"latest_invoice\"\r\n    });\r\n\r\n    const subResp = await fetch(\"https://api.stripe.com/v1/subscriptions\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        Authorization: `Bearer ${stripeSecretKey}`,\r\n        \"Content-Type\": \"application/x-www-form-urlencoded\"\r\n      },\r\n      body: subParams\r\n    });\r\n    if (!subResp.ok) {\r\n      throw new Error(`Error creating subscription with invoice: ${subResp.statusText}`);\r\n    }\r\n    const subscriptionData = await subResp.json();\r\n\r\n    let latestInvoice = subscriptionData.latest_invoice;\r\n    if (latestInvoice && latestInvoice.id) {\r\n      let finalizeUrl = `https://api.stripe.com/v1/invoices/${latestInvoice.id}/finalize?auto_advance=true`;\r\n      const finalizeResp = await fetch(finalizeUrl, {\r\n        method: \"POST\",\r\n        headers: {\r\n          Authorization: `Bearer ${stripeSecretKey}`\r\n        }\r\n      });\r\n      if (!finalizeResp.ok) {\r\n        throw new Error(`Error finalizing invoice: ${finalizeResp.statusText}`);\r\n      }\r\n      await finalizeResp.json();\r\n    }\r\n    return subscriptionData;\r\n  } catch (error) {\r\n    console.error(\"Error in createSubscriptionInvoiceMethod:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\n// Function to create checkout session for all kits\r\nasync function createCheckoutSessionForAllKits(kitIds, priceId, instance, billingCycleAnchor = null) {\r\n  try {\r\n    let firstKitInfo = await assetService.getAssetInfo(kitIds[0]).toPromise();\r\n    customerId = firstKitInfo.customerId;\r\n\r\n    let attributeStripeKey = await attributeService\r\n      .getEntityAttributes({ entityType: \"TENANT\", id: tenantId }, \"SERVER_SCOPE\", [\"stripeKey\"])\r\n      .toPromise();\r\n    stripeSecretKey = attributeStripeKey?.[0]?.value || null;\r\n\r\n    let priceDataResp = await fetch(`https://api.stripe.com/v1/prices/${priceId}`, {\r\n      method: \"GET\",\r\n      headers: { Authorization: `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!priceDataResp.ok) {\r\n      throw new Error(`Error fetching price details: ${priceDataResp.statusText}`);\r\n    }\r\n    let priceData = await priceDataResp.json();\r\n    let isRecurring = priceData.recurring !== null;\r\n    let mode = isRecurring ? \"subscription\" : \"payment\";\r\n\r\n    let stripeIdAttr = await attributeService\r\n      .getEntityAttributes(customerId, \"SERVER_SCOPE\", [\"stripe_id\"])\r\n      .toPromise();\r\n    customerStripeId = stripeIdAttr?.[0]?.value || null;\r\n\r\n    // Fetch current URL for success and cancel URLs\r\n    let currentUrl = window.location.href;\r\n    const successUrl = currentUrl;\r\n    const cancelUrl = currentUrl;\r\n\r\n    let bodyParams = new URLSearchParams({\r\n      success_url: successUrl,\r\n      cancel_url: cancelUrl,\r\n      \"payment_method_types[]\": \"card\",\r\n      \"line_items[0][price]\": priceId,\r\n      \"line_items[0][quantity]\": kitIds.length.toString(),\r\n      mode: mode\r\n    });\r\n\r\n    if (customerStripeId) {\r\n      bodyParams.append(\"customer\", customerStripeId);\r\n    }\r\n    if (isRecurring && billingCycleAnchor) {\r\n      bodyParams.append(\"subscription_data[billing_cycle_anchor]\", billingCycleAnchor);\r\n      bodyParams.append(\"subscription_data[proration_behavior]\", \"none\");\r\n    }\r\n\r\n    let response = await fetch(\"https://api.stripe.com/v1/checkout/sessions\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        Authorization: `Bearer ${stripeSecretKey}`,\r\n        \"Content-Type\": \"application/x-www-form-urlencoded\"\r\n      },\r\n      body: bodyParams\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error creating checkout session: ${response.statusText}`);\r\n    }\r\n    let data = await response.json();\r\n\r\n    if (data.id && data.url) {\r\n      sessionId = data.id;\r\n      selectedLicenseType = selectedLicenseType; // Ensure licenseType is set\r\n\r\n      /*console.log(\"Checkout Session ID:\", sessionId);*/\r\n\r\n      // Save licenseType and sessionId to each selected kit before redirecting\r\n      let updates = kitIds.map((kitId) => {\r\n        let attrs = [\r\n          { key: \"licenseType\", value: selectedLicenseType },\r\n          { key: \"sessionId\", value: sessionId }\r\n        ];\r\n        return attributeService\r\n          .saveEntityAttributes({ entityType: \"ASSET\", id: kitId }, \"SERVER_SCOPE\", attrs)\r\n          .toPromise()\r\n          .then(() => {\r\n            /*console.log(`Saved licenseType and sessionId to kit ${kitId}.`);*/\r\n          })\r\n          .catch((err) => {\r\n            console.error(`Error saving attributes to kit ${kitId}:`, err);\r\n          });\r\n      });\r\n\r\n      // Wait for all updates to complete\r\n      await Promise.all(updates);\r\n\r\n      // Redirect to Stripe Checkout in the same tab\r\n      window.location.href = data.url;\r\n    } else {\r\n      console.error(\"Checkout session response does not contain id or url.\");\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error in createCheckoutSessionForAllKits:\", error);\r\n    addAlert(\"Failed to create checkout session. Please try again.\", \"error\");\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\n// Function to check payment status for all kits (if needed)\r\nasync function checkPaymentStatusForAllKits(sessionId, kitIds, licenseType, instance) {\r\n  try {\r\n    const response = await fetch(`https://api.stripe.com/v1/checkout/sessions/${sessionId}`, {\r\n      method: \"GET\",\r\n      headers: { Authorization: `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error: ${response.statusText}`);\r\n    }\r\n    const data = await response.json();\r\n\r\n    if (data.payment_status === \"paid\") {\r\n      alert(\"Payment completed successfully!\");\r\n      let subId = data.subscription || null;\r\n\r\n      let updates = kitIds.map(async (kitId) => {\r\n        let attributes = [\r\n          { key: \"licenseActivationStatus\", value: true },\r\n          { key: \"licenseType\", value: licenseType }\r\n        ];\r\n        if (subId) {\r\n          attributes.push({ key: \"subscriptionId\", value: subId });\r\n        }\r\n        return attributeService\r\n          .saveEntityAttributes({ entityType: \"ASSET\", id: kitId }, \"SERVER_SCOPE\", attributes)\r\n          .toPromise();\r\n      });\r\n\r\n      await Promise.all(updates);\r\n      instance.dialogRef.close(null);\r\n      return \"paid\";\r\n    } else {\r\n      instance.dialogRef.close(null);\r\n      alert(\"Payment was not successful. Please try again.\");\r\n      return data.payment_status;\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error checking payment status for all kits:\", error);\r\n    return \"error\";\r\n  }\r\n}\r\n\r\n// Function to check subscription status via Stripe\r\nasync function checkSubscriptionStatus(subscriptionId) {\r\n  try {\r\n    const response = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n      method: \"GET\",\r\n      headers: { Authorization: `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error fetching subscription details: ${response.statusText}`);\r\n    }\r\n    return await response.json();\r\n  } catch (error) {\r\n    console.error(\"Error fetching subscription:\", error);\r\n    throw error;\r\n  }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "9b81f168-6fff-da00-7bac-427fd0220fed"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.add-diagnostic-kit}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<!-- HTML Template for the \"Add Diagnostickit\" Dialog -->\r\n<form\r\n  #addEntityForm=\"ngForm\"\r\n  [formGroup]=\"addDiagnostickitFormGroup\"\r\n  (ngSubmit)=\"save()\"\r\n  class=\"add-entity-form max-w-3xl mx-auto\"\r\n  style=\"width: 350px;\"\r\n>\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.diagnostic-kits.add-diagnostic-kit' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar\r\n    color=\"warn\"\r\n    mode=\"indeterminate\"\r\n    *ngIf=\"isLoading$ | async\"\r\n  ></mat-progress-bar>\r\n\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <div class=\"flex flex-col gap-0 sm:gap-2\">\r\n      \r\n      <!-- Diagnostickit Name / ID -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>Diagnostickit ID</mat-label>\r\n        <input matInput formControlName=\"name\" required/>\r\n        <mat-error *ngIf=\"addDiagnostickitFormGroup.get('name').hasError('required')\">\r\n          {{ 'custom.diagnostic-kits.diagnostic-kit-id-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Label -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>Label</mat-label>\r\n        <input matInput formControlName=\"label\"/>\r\n        <mat-error *ngIf=\"addDiagnostickitFormGroup.get('label').hasError('required')\">\r\n          {{ 'custom.diagnostic-kits.label-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Diagnostic Kit Type -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.diagnostic-kits.diagnostic-kit-type' | translate }}</mat-label>\r\n        <mat-select formControlName=\"kitType\" required>\r\n          <mat-option value=\"basis\">Diagnostics Basis Kit</mat-option>\r\n          <!--<mat-option value=\"extension\">Diagnostics Extension Kit</mat-option>-->\r\n          <mat-option value=\"loraWan\">Diagnostics LoRaWAN Kit</mat-option>\r\n        </mat-select>\r\n        <mat-error *ngIf=\"addDiagnostickitFormGroup.get('kitType')?.hasError('required')\">\r\n          {{ 'custom.diagnostic-kits.diagnostic-kit-type-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button\r\n      mat-button\r\n      color=\"primary\"\r\n      type=\"button\"\r\n      [disabled]=\"(isLoading$ | async)\"\r\n      (click)=\"cancel()\"\r\n      cdkFocusInitial\r\n    >\r\n      {{ 'action.cancel' | translate }}\r\n    </button>\r\n    <button\r\n      mat-button\r\n      mat-raised-button\r\n      color=\"primary\"\r\n      type=\"submit\"\r\n      [disabled]=\"(isLoading$ | async)\"\r\n    >\r\n      {{ 'custom.diagnostic-kits.add-diagnostic-kit' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "// JS/Typescript Code\r\n\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nconst rxjs = widgetContext.rxjs;\r\nlet customerId;\r\nlet diagnostickitsAll = []; // Will store all Diagnostickits across customers\r\n\r\n// Determine which customer ID to use\r\nlet customerName = widgetContext.stateController.getStateParams().entityName;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n    customerId = widgetContext.stateController.getStateParams().entityId;\r\n} else {\r\n    customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n}\r\n\r\n// Page link to fetch customers\r\nconst pageLink = widgetContext.pageLink(100, 0, null, null); // PageSize: 100, PageNumber: 0\r\n\r\n// Fetch all customers, then fetch all their Diagnostickits\r\n/*customerService.getCustomers(pageLink).subscribe(customers => {\r\n  //console.log(\"customers:\", customers);\r\n\r\n  // Track how many customer queries have completed\r\n  let processed = 0;\r\n  const totalCustomers = customers.data.length;\r\n\r\n  customers.data.map(customer => {\r\n    // Build our query for this specific customer's ID\r\n    const assetSearchQuery = {\r\n      parameters: {\r\n        rootId: customer.id.id,       \r\n        rootType: 'CUSTOMER',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Diagnostickit']\r\n    };\r\n\r\n    assetService.findByQuery(assetSearchQuery).subscribe(diagnostickits => {\r\n      //console.log(\"diagnostickits of customer:\", customer.name, diagnostickits);    \r\n      // Merge these Diagnostickits into our master array\r\n      diagnostickitsAll.push(...diagnostickits);\r\n\r\n      // Increment the processed counter\r\n      processed++;\r\n      // If we've processed all customers, open the dialog\r\n      if (processed === totalCustomers) {\r\n        //console.log('All Diagnostickits across all customers:', diagnostickitsAll);\r\n        openAddDiagnostickitDialog(diagnostickitsAll);\r\n      }\r\n    });\r\n  });\r\n});*/\r\nopenAddDiagnostickitDialog(diagnostickitsAll);\r\n// Opens the custom dialog, passing in the collected diagnostickitsAll\r\nfunction openAddDiagnostickitDialog(diagnostickitsAll) {\r\n  customDialog.customDialog(htmlTemplate, AddDiagnostickitDialogController, { diagnostickitsAll }).subscribe();\r\n}\r\n\r\n// The Dialog Controller\r\nfunction AddDiagnostickitDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  // We have access to diagnostickitsAll via instance.data\r\n  vm.diagnostickitsAll = instance.data.diagnostickitsAll || [];\r\n\r\n  // Reactive form definition\r\n  vm.addDiagnostickitFormGroup = vm.fb.group({\r\n    name: [null, [vm.validators.required]],\r\n    label: [null],\r\n    kitType: ['basis', [vm.validators.required]]\r\n  });\r\n\r\n /*function generateDiagnostickitName(kitType) {\r\n  // Current 2-digit year\r\n  const year = (new Date().getFullYear() % 100).toString().padStart(2, '0');\r\n\r\n  // Determine the prefix for the *new* kit\r\n  const prefix = kitType === 'basis' ? 'DBKIT' : 'DEKIT';\r\n\r\n  // Single pattern to match either DBKIT or DEKIT, ignoring the year for the counter\r\n  // Explanation:\r\n  //   ^D(B|E)KIT         => Must start with DBKIT or DEKIT\r\n  //   \\d{2}             => Then two digits (the year)\r\n  //   EU-               => Then 'EU-'\r\n  //   (\\d{4})           => Capture the 4-digit counter\r\n  const pattern = /^D(B|E)KIT\\d{2}EU-(\\d{4})$/;\r\n\r\n  let maxNumber = 0;\r\n\r\n  // Find the max counter among all kits that match DBKITyyEU-#### or DEKITyyEU-####\r\n  vm.diagnostickitsAll.forEach(d => {\r\n    const match = d.name.match(pattern);\r\n    if (match) {\r\n      // match[2] should contain the 4-digit counter\r\n      const currentNum = parseInt(match[2], 10);\r\n      if (currentNum > maxNumber) {\r\n        maxNumber = currentNum;\r\n      }\r\n    }\r\n  });\r\n\r\n  // Next counter (increment by 1)\r\n  const nextNumber = (maxNumber + 1).toString().padStart(4, '0');\r\n\r\n  // Construct new name with correct prefix, current year, and the incremented counter\r\n  return `${prefix}${year}EU-${nextNumber}`;\r\n}*/\r\n\r\n\r\n\r\n  // Whenever the kitType changes, regenerate the name\r\n  /*vm.addDiagnostickitFormGroup.get('kitType').valueChanges.subscribe((newKitType) => {\r\n    const newName = generateDiagnostickitName(newKitType);\r\n    vm.addDiagnostickitFormGroup.patchValue(\r\n      { name: newName },\r\n      { emitEvent: false } // avoid infinite loop\r\n    );\r\n  });*/\r\n\r\n  // Initialize the name based on the default kitType ('basis')\r\n  /*vm.addDiagnostickitFormGroup.patchValue({\r\n    name: generateDiagnostickitName(vm.addDiagnostickitFormGroup.get('kitType').value)\r\n  }, { emitEvent: false });*/\r\n\r\n  // Cancel / close the dialog\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  // Save action\r\n  vm.save = function () {\r\n    const stateParams = widgetContext.stateController.getStateParams();\r\n    var projectId, measurementId;\r\n\r\n    projectId = {\r\n      id: (stateParams.selectedProject && stateParams.selectedProject.entityId && stateParams.selectedProject.entityId.id)\r\n        ? stateParams.selectedProject.entityId.id\r\n        : '',\r\n      entityType: 'ASSET'\r\n    };\r\n\r\n    measurementId = {\r\n      id: (stateParams.selectedMeasurement && stateParams.selectedMeasurement.entityId && stateParams.selectedMeasurement.entityId.id)\r\n        ? stateParams.selectedMeasurement.entityId.id\r\n        : '',\r\n      entityType: 'ASSET'\r\n    };\r\n    \r\n    let localCustomerId;\r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        localCustomerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        localCustomerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n\r\n    vm.addDiagnostickitFormGroup.markAsPristine();\r\n\r\n    // Save the Diagnostickit asset, then link it\r\n    saveDiagnostickitObservable(localCustomerId).subscribe(\r\n      function (Diagnostickit) {\r\n        const observables = [\r\n          saveCustomerToDiagnostickitRelation(localCustomerId, Diagnostickit.id),\r\n          saveAttributes(Diagnostickit.id)\r\n        ];\r\n\r\n        // If there's a selected project, relate it\r\n        if(projectId.id !== \"\"){\r\n            observables.push(saveProjectToDiagnostickitRelation(projectId, Diagnostickit.id));\r\n        }\r\n        // If there's a selected measurement, relate it\r\n        if(measurementId.id !== \"\"){\r\n            observables.push(saveMeasurementToDiagnostickitRelation(measurementId, Diagnostickit.id));\r\n        }\r\n\r\n        widgetContext.rxjs.forkJoin(observables).subscribe(\r\n          function () {\r\n            var params = widgetContext.stateController.getStateParams();\r\n            // Update selectedDiagnostickit in state params\r\n            params['selectedDiagnostickit'] = {\r\n              entityId: Diagnostickit.id,\r\n              entityName: Diagnostickit.name\r\n            };\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n          }\r\n        );\r\n      }\r\n    );\r\n  };\r\n\r\n  // -------------- Helper Functions -------------- //\r\n\r\n  // Save Diagnostickit asset inside the 'Diagnostickits' group and also add it to 'Unassigned Kit' group\r\n  function saveDiagnostickitObservable(customerId) {\r\n    return getDiagnostickitsGroup(customerId).pipe(\r\n      widgetContext.rxjs.switchMap((DiagnostickitsGroup) => {\r\n        return getUnassignedKitGroup(customerId).pipe(\r\n          widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\r\n            const formValues = vm.addDiagnostickitFormGroup.value;\r\n            const Diagnostickit = {\r\n              name: formValues.name,\r\n              label: formValues.label,\r\n              type: 'Diagnostickit',\r\n              customerId: customerId\r\n            };\r\n\r\n            return assetService.saveAsset(Diagnostickit, DiagnostickitsGroup.id.id).pipe(\r\n              widgetContext.rxjs.switchMap((savedAsset) => {\r\n                // Add the new Diagnostickit to the \"Unassigned Kit\" group\r\n                return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, savedAsset.id.id).pipe(\r\n                  widgetContext.rxjs.map(() => {\r\n                    return savedAsset; \r\n                  })\r\n                );\r\n              })\r\n            );\r\n          })\r\n        );\r\n      })\r\n    );\r\n  }\r\n\r\n  // Get or create the \"Diagnostickits\" group\r\n  function getDiagnostickitsGroup(customerId) {\r\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n      widgetContext.rxjs.switchMap((entityGroups) => {\r\n        var DiagnostickitsGroup = entityGroups.find(group => group.name === 'Diagnostickits');\r\n        if (DiagnostickitsGroup) {\r\n          return widgetContext.rxjs.of(DiagnostickitsGroup);\r\n        } else {\r\n          DiagnostickitsGroup = {\r\n            type: 'ASSET',\r\n            name: 'Diagnostickits',\r\n            ownerId: customerId\r\n          };\r\n          return entityGroupService.saveEntityGroup(DiagnostickitsGroup);\r\n        }\r\n      })\r\n    );\r\n  }\r\n\r\n  // Get or create the \"Unassigned Kit\" group\r\n  function getUnassignedKitGroup(customerId) {\r\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n      widgetContext.rxjs.switchMap((entityGroups) => {\r\n        var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n        if (UnassignedKitGroup) {\r\n          return widgetContext.rxjs.of(UnassignedKitGroup);\r\n        } else {\r\n          UnassignedKitGroup = {\r\n            type: 'ASSET',\r\n            name: 'Unassigned Kit',\r\n            ownerId: customerId\r\n          };\r\n          return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n        }\r\n      })\r\n    );\r\n  }\r\n\r\n  // Create relation: Customer -> Diagnostickit\r\n  function saveCustomerToDiagnostickitRelation(customerId, DiagnostickitId) {\r\n    var relation = {\r\n      from: customerId,\r\n      to: DiagnostickitId,\r\n      typeGroup: 'COMMON',\r\n      type: 'Owns'\r\n    };\r\n    return entityRelationService.saveRelation(relation);\r\n  }\r\n\r\n  // Create relation: Project -> Diagnostickit\r\n  function saveProjectToDiagnostickitRelation(projectId, DiagnostickitId) {\r\n    var relation = {\r\n      from: projectId,\r\n      to: DiagnostickitId,\r\n      typeGroup: 'COMMON',\r\n      type: 'Owns'\r\n    };\r\n    return entityRelationService.saveRelation(relation);\r\n  }\r\n\r\n  // Create relation: Measurement -> Diagnostickit\r\n  function saveMeasurementToDiagnostickitRelation(measurementId, DiagnostickitId) {\r\n    var relation = {\r\n      from: measurementId,\r\n      to: DiagnostickitId,\r\n      typeGroup: 'COMMON',\r\n      type: 'Owns'\r\n    };\r\n    return entityRelationService.saveRelation(relation);\r\n  }\r\n\r\n  // Save attributes for the newly created Diagnostickit\r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n      {\r\n        key: 'state',\r\n        value: 'normal'\r\n      },\r\n      {\r\n        key: 'kitType',\r\n        value: vm.addDiagnostickitFormGroup.get('kitType').value\r\n      }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e965b8a1-a6ac-5ae4-fd79-2b7220b91ed1"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.transfer-kit}",
                "buttonType": "icon",
                "icon": "mdi:swap-horizontal",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form #transferKitForm=\"ngForm\" [formGroup]=\"transferKitFormGroup\" (ngSubmit)=\"save()\" class=\"transferKitFormGroup max-w-3xl mx-auto\" style=\"width: 800px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.diagnostic-kits.transfer-kit' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n   <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n      <mat-label>Kit</mat-label>\r\n      <mat-select formControlName=\"kit\" required (selectionChange)=\"onKitSelected($event)\">\r\n        <mat-option *ngFor=\"let kit of kits\" [value]=\"kit\">\r\n          {{ kit.name }}\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"transferKitFormGroup.get('kit')?.hasError('required')\">\r\n        {{ 'custom.diagnostic-kits.kit-is-required' | translate }}\r\n      </mat-error>\r\n    </mat-form-field>\r\n    \r\n    <div class=\"flex justify-center items-center\" style=\"padding-bottom: 10px;\">\r\n      <mat-icon>arrow_downward</mat-icon>\r\n    </div>\r\n\r\n   <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n      <mat-label>{{ 'custom.diagnostic-kits.customer' | translate }}</mat-label>\r\n      <mat-select formControlName=\"customer\" required (selectionChange)=\"onCustomerSelected($event)\">\r\n        <mat-option *ngFor=\"let cust of customers\" [value]=\"cust\">\r\n          {{ cust.title }}\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"transferKitFormGroup.get('customer')?.hasError('required')\">\r\n        {{ 'custom.diagnostic-kits.customer-is-required' | translate }}\r\n      </mat-error>\r\n    </mat-form-field>\r\n    \r\n    <div *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" class=\"flex justify-center items-center pb-5\">\r\n      <mat-icon>arrow_downward</mat-icon>\r\n    </div>\r\n      \r\n    <fieldset *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" class=\"fieldset\" style=\"margin-bottom: 16px;\">\r\n      <div class=\"flex flex-row justify-start items-center py-2.5\">\r\n        <div style=\"width: 40px; display: flex; justify-content: center; align-items: center;\">\r\n          <mat-icon>info</mat-icon>\r\n        </div>\r\n        <div class=\"flex-1\">\r\n          <p style=\"font-size: 15px; margin: 0;\">\r\n            {{ 'custom.diagnostic-kits.kit-has-assigned-measurement-warning' | translate }}\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </fieldset>\r\n    \r\n    <div *ngIf=\"foundProject\" class=\"flex justify-start items-center\" style=\"margin-top:10px;\">\r\n      <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n        <mat-label>{{ 'custom.diagnostic-kits.found-project' | translate }}</mat-label>\r\n        <input matInput formControlName=\"foundProject\" readonly>\r\n      </mat-form-field>\r\n      \r\n      <div style=\"padding: 0 10px;\">\r\n        <mat-icon>arrow_right_alt</mat-icon>\r\n      </div>\r\n      \r\n      <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n        <mat-label>{{ 'custom.diagnostic-kits.transferred-project' | translate }}Transferred Project</mat-label>\r\n        <input matInput formControlName=\"transferredProject\" readonly>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" style=\"margin-top:10px;\">\r\n      <div *ngFor=\"let measurement of projectMeasurements; let i = index\" class=\"flex flex-row justify-start items-center\" style=\"margin-bottom:8px;\">\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.found-measurement' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'measurement' + i\" readonly>\r\n        </mat-form-field>\r\n        <div style=\"padding: 0 10px;\">\r\n          <mat-icon>arrow_right_alt</mat-icon>\r\n        </div>\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.transferred-measurement' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'transferredMeasurement' + i\" readonly>\r\n        </mat-form-field>\r\n      </div>\r\n    </div>\r\n\r\n    <div *ngIf=\"allDevices && allDevices.length > 0\" style=\"margin-top:10px;\">\r\n      <div *ngFor=\"let device of allDevices; let i = index\" class=\"flex flex-row justify-start items-center\" style=\"margin-bottom:8px;\">\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.found-device' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'device' + i\" readonly>\r\n        </mat-form-field>\r\n        <div style=\"padding: 0 10px;\">\r\n          <mat-icon>arrow_right_alt</mat-icon>\r\n        </div>\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.transferred-device' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'transferredDevice' + i\" readonly>\r\n        </mat-form-field>\r\n      </div>\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">{{ 'action.cancel' | translate }}</button>\r\n    <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"transferKitFormGroup.invalid\">\r\n      {{ 'action.save' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.transferKitFormGroup .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.transferKitFormGroup .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.transferKitFormGroup\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.transferKitFormGroup\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet dialogs = injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\nlet customerId, customer;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet pageLink = {\r\n  pageSize: 100, page: 0, textSearch: '', sortOrder: 'ASC', sortProperty: 'title',\r\n  toQuery: function () {\r\n    let q = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) q += '&textSearch=' + encodeURIComponent(this.textSearch);\r\n    if (this.sortProperty) q += '&sortProperty=' + encodeURIComponent(this.sortProperty);\r\n    if (this.sortOrder) q += '&sortOrder=' + encodeURIComponent(this.sortOrder);\r\n    return q;\r\n  }\r\n};\r\n\r\nlet kits = [];\r\nlet customers = [];\r\nlet kitsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (kitsLoaded && customersLoaded) openTransferKitDialog(kits, customers);\r\n}\r\n\r\nlet kitSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id, rootType: 'CUSTOMER', direction: 'FROM',\r\n    relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Diagnostickit']\r\n};\r\n\r\nassetService.findByQuery(kitSearchQuery).subscribe(\r\n  result => { kits = result; kitsLoaded = true; checkAndOpenDialog(); },\r\n  () => { kits = []; kitsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\n// NOTE: credentials come from your original snippet\r\nlet bearerToken = '';\r\nfetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n  method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n  body: JSON.stringify({ \"username\": \"belimo.api@pke-iot.expert\", \"password\": \"vfx3cvr@VMJ3bxk3urg\" })\r\n})\r\n  .then(resp => resp.json())\r\n  .then(loginData => {\r\n    bearerToken = loginData.token;\r\n    return fetch('https://cloud.pke-iot.expert/api/customers?pageSize=100&page=0', {\r\n      method: 'GET',\r\n      headers: { 'accept': 'application/json', 'X-Authorization': 'Bearer ' + bearerToken }\r\n    });\r\n  })\r\n  .then(resp2 => resp2.json())\r\n  .then(customersList => {\r\n    customers = customersList.data;\r\n    if (customer) customers = customers.filter(cust => cust.title !== customer);\r\n    customersLoaded = true; checkAndOpenDialog();\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching customers:\", error);\r\n    alert('Failed to fetch customers.');\r\n  });\r\n\r\nfunction openTransferKitDialog(kits, customers) {\r\n  customDialog.customDialog(htmlTemplate, TransferKitDialogController, { kits, customers }).subscribe();\r\n}\r\n\r\nfunction TransferKitDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.kits = data.kits || [];\r\n  vm.customers = data.customers || [];\r\n\r\n  vm.transferKitFormGroup = vm.fb.group({\r\n    kit: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n  vm.transferKitFormGroup.addControl('transferredProject', vm.fb.control({ value: '', disabled: true }));\r\n\r\n  vm.allDevices = [];\r\n  vm.devicesWithMeasurements = [];\r\n  vm.foundProject = null;\r\n  vm.projectMeasurements = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n     vm.measurementRenameMap = new Map();\r\n\r\n\r\n  const groupCache = new Map(); // key: ownerId|scope|name -> Observable(group)\r\n  function ensureGroup(ownerIdObj, scopeType, name) {\r\n    const key = ownerIdObj.id + '|' + scopeType + '|' + name;\r\n    if (groupCache.has(key)) return groupCache.get(key);\r\n\r\n    const obs = entityGroupService.getEntityGroupsByOwnerId(ownerIdObj.entityType, ownerIdObj.id, scopeType).pipe(\r\n      widgetContext.rxjs.switchMap(groups => {\r\n        let g = (groups || []).find(x => x.name === name);\r\n        if (g) return widgetContext.rxjs.of(g);\r\n        const payload = { type: scopeType, name, ownerId: ownerIdObj };\r\n        return entityGroupService.saveEntityGroup(payload).pipe(\r\n          // If backend races and says \"already exists\", re-fetch once\r\n          widgetContext.rxjs.catchError(err => {\r\n            if (err && err.status === 400) {\r\n              return entityGroupService.getEntityGroupsByOwnerId(ownerIdObj.entityType, ownerIdObj.id, scopeType).pipe(\r\n                widgetContext.rxjs.map(gs => (gs || []).find(x => x.name === name))\r\n              );\r\n            }\r\n            return widgetContext.rxjs.throwError(err);\r\n          })\r\n        );\r\n      }),\r\n      widgetContext.rxjs.shareReplay(1)\r\n    );\r\n    groupCache.set(key, obs);\r\n    return obs;\r\n  }\r\n\r\n  function addToGroupSafe(groupId, entityId) {\r\n    return entityGroupService.addEntitiesToEntityGroup(groupId, [entityId]).pipe(\r\n      widgetContext.rxjs.catchError(err => {\r\n        // tolerate duplicate-membership/409/400 responses\r\n        return widgetContext.rxjs.of(null);\r\n      })\r\n    );\r\n  }\r\n\r\n  function getProjectsGroup(owner)                { return ensureGroup(owner, 'ASSET',  'Projects'); }\r\n  function getMeasurementsGroup(owner)            { return ensureGroup(owner, 'ASSET',  'Measurements'); }\r\n  function getDiagnostickitsGroup(owner)          { return ensureGroup(owner, 'ASSET',  'Diagnostickits'); }\r\n  function getGatewaysGroup(owner)                { return ensureGroup(owner, 'DEVICE', 'Gateways'); }\r\n  function getDiagnostickitDevicesGroup(owner)    { return ensureGroup(owner, 'DEVICE', 'Diagnostickit Devices'); }\r\n  function getUnassignedMeasurementDevicesGroup(owner) { return ensureGroup(owner, 'DEVICE', 'Unassigned Measurement Devices'); }\r\n\r\n  vm.transferKitFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId, rootType: 'CUSTOMER', direction: 'FROM',\r\n          relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { vm.transferredProject = null; vm.customerShortName = null; }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null; vm.customerShortName = null;\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        if (vm.transferKitFormGroup.get('transferredMeasurement' + index)) {\r\n          vm.transferKitFormGroup.get('transferredMeasurement' + index).setValue('');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  vm.onKitSelected = function (event) {\r\n    let selectedKit = event.value;\r\n    vm.allDevices = [];\r\n    vm.devicesWithMeasurements = [];\r\n    vm.foundProject = null;\r\n    vm.projectMeasurements = [];\r\n\r\n    Object.keys(vm.transferKitFormGroup.controls)\r\n      .filter(n => n.startsWith('measurement') || n.startsWith('transferredMeasurement') || n.startsWith('device') || n.startsWith('transferredDevice'))\r\n      .forEach(n => vm.transferKitFormGroup.removeControl(n));\r\n    \r\n    let selectedCustomer = vm.transferKitFormGroup.get('customer').value;\r\n    if (!selectedKit || !selectedCustomer) {\r\n      console.warn(\"Kit or customer not selected yet.\");\r\n      return;\r\n    }\r\n    \r\n    let selectedKitId = selectedKit.id.id ? selectedKit.id.id : selectedKit.id;\r\n\r\n    let deviceSearchQuery = {\r\n      parameters: {\r\n        rootId: selectedKitId, rootType: 'ASSET', direction: 'FROM',\r\n        relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: true\r\n      },\r\n      relationType: 'Contains',\r\n      deviceTypes: ['P-Flow D116','Room Sensor CO2','Temperature Sensor','RESI','Gateway','LTE Status']\r\n    };\r\n    \r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n      devices => {\r\n        vm.allDevices = devices || [];\r\n        if (vm.allDevices.length === 0) return;\r\n\r\n        vm.allDevices.forEach((device, index) => {\r\n          vm.transferKitFormGroup.addControl('device' + index, vm.fb.control({ value: device.name, disabled: true }));\r\n          vm.transferKitFormGroup.addControl('transferredDevice' + index, vm.fb.control({ value: device.name, disabled: true }));\r\n        });\r\n\r\n        let measurementChecks = vm.allDevices.map(device => {\r\n          let measurementQuery = {\r\n            parameters: {\r\n              rootId: (device.id.id ? device.id.id : device.id), rootType: 'DEVICE', direction: 'TO',\r\n              relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: false\r\n            },\r\n            relationType: 'Measurement',\r\n            assetTypes: ['Measurement']\r\n          };\r\n          return assetService.findByQuery(measurementQuery).pipe(\r\n            widgetContext.rxjs.map(measurements => ({ device, measurements: measurements || [] }))\r\n          );\r\n        });\r\n\r\n        widgetContext.rxjs.forkJoin(measurementChecks).subscribe(\r\n          measurementResults => {\r\n            vm.devicesWithMeasurements = measurementResults.filter(r => r.measurements.length > 0);\r\n            let projectChecks = [];\r\n            vm.devicesWithMeasurements.forEach(item => {\r\n              item.measurements.forEach(meas => {\r\n                let projectQuery = {\r\n                  parameters: {\r\n                    rootId: (meas.id.id ? meas.id.id : meas.id), rootType: 'ASSET', direction: 'TO',\r\n                    relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: 'Owns',\r\n                  assetTypes: ['Project']\r\n                };\r\n                projectChecks.push(assetService.findByQuery(projectQuery).pipe(\r\n                  widgetContext.rxjs.map(projects => ({ measurement: meas, projects: projects || [] }))\r\n                ));\r\n              });\r\n            });\r\n            if (projectChecks.length === 0) return;\r\n\r\n            widgetContext.rxjs.forkJoin(projectChecks).subscribe(\r\n              projectResults => {\r\n                let found = projectResults.find(r => r.projects.length > 0);\r\n                if (found) {\r\n                  vm.foundProject = found.projects[0];\r\n                  if (!vm.transferKitFormGroup.get('foundProject')) {\r\n                    vm.transferKitFormGroup.addControl('foundProject', vm.fb.control({ value: vm.foundProject.name, disabled: true }));\r\n                  } else {\r\n                    vm.transferKitFormGroup.get('foundProject').setValue(vm.foundProject.name);\r\n                  }\r\n                  searchMeasurementsForProject(vm.foundProject);\r\n                }\r\n              },\r\n              err => console.error(\"Error during project queries:\", err)\r\n            );\r\n          },\r\n          err => console.error(\"Error in measurement checks:\", err)\r\n        );\r\n      },\r\n      err => console.error(\"Error finding devices for kit:\", err)\r\n    );\r\n  };\r\n\r\n  vm.onCustomerSelected = function () {\r\n    let kit = vm.transferKitFormGroup.get('kit').value;\r\n    if (kit) vm.onKitSelected({ value: kit });\r\n  };\r\n\r\n  function updateFoundProjectName(customerShortName, existingProjects) {\r\n    if (!customerShortName) return;\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) { maxNumericSuffix = parsedNum; }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    vm.transferredProject = candidate;\r\n    vm.transferKitFormGroup.get('transferredProject').setValue(candidate);\r\n  }\r\n\r\n  function renameProjectMeasurements() {\r\n    if (!vm.customerShortName) return;\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n      let newProjectNameCtrl = vm.transferKitFormGroup.get('transferredProject');\r\n      let oldName = measurement.name;\r\n      let parts = oldName.split('_');\r\n      let newName = newProjectNameCtrl.value + '_' + parts[2];\r\n      let control = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n      if (control) control.setValue(newName);\r\n    });\r\n  }\r\n\r\n  function searchMeasurementsForProject(project) {\r\n    let projectId = project.id.id ? project.id.id : project.id;\r\n    let projectMeasurementQuery = {\r\n      parameters: {\r\n        rootId: projectId, rootType: 'ASSET', direction: 'FROM',\r\n        relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Measurement']\r\n    };\r\n    assetService.findByQuery(projectMeasurementQuery).subscribe(\r\n      measurements => {\r\n        vm.projectMeasurements = measurements || [];\r\n        Object.keys(vm.transferKitFormGroup.controls)\r\n          .filter(n => n.startsWith('measurement') || n.startsWith('transferredMeasurement'))\r\n          .forEach(n => vm.transferKitFormGroup.removeControl(n));\r\n        (measurements || []).forEach((measurement, index) => {\r\n          vm.transferKitFormGroup.addControl('measurement' + index, vm.fb.control({ value: measurement.name, disabled: true }));\r\n          vm.transferKitFormGroup.addControl('transferredMeasurement' + index, vm.fb.control({ value: '', disabled: true }));\r\n        });\r\n        renameProjectMeasurements();\r\n      },\r\n      err => console.error(\"Error finding measurements for project:\", err)\r\n    );\r\n  }\r\n\r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      }),\r\n      widgetContext.rxjs.catchError(() => widgetContext.rxjs.of(null)) // tolerate if old relation missing\r\n    );\r\n  }\r\n\r\n  function getVrDevicesForDevice(deviceId) {\r\n    return entityRelationService.findByTo({ id: deviceId, entityType: 'DEVICE' }).pipe(\r\n      widgetContext.rxjs.map(rels =>\r\n        (rels || [])\r\n          .filter(r => r.typeGroup === 'COMMON' && r.type === 'VR' && r.from?.entityType === 'DEVICE')\r\n          .map(r => (r.from.id.id ? r.from.id.id : r.from.id)) // return VR device UUIDs\r\n      )\r\n    );\r\n  }\r\n\r\n  function computeNewVrName(oldVrName) {\r\n      const original = (oldVrName || '').trim();\r\n      if (!original) { \r\n        console.debug('[VR Rename] Empty VR name; skip');\r\n        return null;\r\n      }\r\n    \r\n      // 1) Primary: precise map-based rename (oldMeasName or oldMeasName_)\r\n      if (vm.measurementRenameMap && vm.measurementRenameMap.size > 0) {\r\n        const entries = Array.from(vm.measurementRenameMap.entries())\r\n          .sort((a, b) => b[0].length - a[0].length); // longest first\r\n    \r\n        for (const [oldMeasNameRaw, newMeasNameRaw] of entries) {\r\n          const oldMeas = String(oldMeasNameRaw || '').trim();\r\n          const newMeas = String(newMeasNameRaw || '').trim();\r\n          if (!oldMeas || !newMeas) continue;\r\n    \r\n          // exact match\r\n          if (original === oldMeas) {\r\n            const renamed = newMeas;\r\n            console.debug('[VR Rename] Exact match:', { original, oldMeas, newMeas, renamed });\r\n            return renamed;\r\n          }\r\n          // prefix match \"<oldMeas>_<suffix>\"\r\n          const prefix = oldMeas + '_';\r\n          if (original.startsWith(prefix)) {\r\n            const suffix = original.substring(prefix.length);\r\n            const renamed = newMeas + '_' + suffix;\r\n            console.debug('[VR Rename] Prefix match:', { original, oldMeas, newMeas, suffix, renamed });\r\n            return renamed;\r\n          }\r\n        }\r\n      } else {\r\n        console.debug('[VR Rename] Empty measurementRenameMap; will try ECO fallback for', original);\r\n      }\r\n    \r\n      // 2) Fallback: if we can’t match the old measurement name, but there is exactly ONE new measurement name,\r\n      //    replace everything BEFORE \"_ECO_\" with that name.\r\n      //    This gives:  \"<anything>_ECO_...\" -> \"<singleNewMeas>_ECO_...\"\r\n      const newNames = vm.measurementRenameMap ? Array.from(vm.measurementRenameMap.values()).map(v => String(v || '').trim()).filter(Boolean) : [];\r\n      if (newNames.length === 1) {\r\n        const soleNew = newNames[0];\r\n        // Typical delimiter in your VR naming: \"_ECO_\"\r\n        const ecoIdx = original.indexOf('_ECO_');\r\n        if (ecoIdx > 0) {\r\n          const suffixFromEco = original.substring(ecoIdx + 1); // keep \"ECO_...\"\r\n          const renamed = soleNew + '_' + suffixFromEco;\r\n          console.debug('[VR Rename] Fallback via _ECO_:',\r\n            { original, soleNew, suffixFromEco, renamed });\r\n          return renamed;\r\n        }\r\n        // If \"_ECO_\" is not present, as a safer generic fallback: replace up to the 3rd underscore (common in \"X_Y_Z_...\")\r\n        const parts = original.split('_');\r\n        if (parts.length >= 3) {\r\n          const suffix = parts.slice(3).join('_'); // keep everything after first 3 segments\r\n          const renamed = suffix ? (soleNew + '_' + suffix) : soleNew;\r\n          console.debug('[VR Rename] Fallback via 3-seg prefix:',\r\n            { original, soleNew, suffix, renamed });\r\n          return renamed;\r\n        }\r\n      }\r\n    \r\n      console.debug('[VR Rename] No matching rule for', original);\r\n      return null; // no rename\r\n    }\r\n\r\n\r\n\r\n\r\n  function transferVrDevice(vrDeviceId, newOwner, hasProjectMeasurements) {\r\n    return deviceService.getDevice(vrDeviceId).pipe(\r\n      widgetContext.rxjs.switchMap(vr => {\r\n        const maybeNewName = computeNewVrName(vr.name);\r\n        if (maybeNewName && maybeNewName !== vr.name) vr.name = maybeNewName;\r\n        return deviceService.saveDevice(vr).pipe(\r\n          widgetContext.rxjs.switchMap(updatedVr => {\r\n            const vrEntity = updatedVr.id && updatedVr.id.entityType\r\n              ? updatedVr.id\r\n              : { id: updatedVr.id, entityType: 'DEVICE' };\r\n\r\n            return entityGroupService.changeEntityOwner(newOwner, vrEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() =>\r\n                (updatedVr.type === 'Gateway VR')\r\n                  ? getGatewaysGroup(newOwner).pipe(\r\n                      widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, vrEntity.id))\r\n                    )\r\n                  : widgetContext.rxjs.of(null)\r\n              ),\r\n              widgetContext.rxjs.switchMap(() =>\r\n                (!hasProjectMeasurements)\r\n                  ? getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                      widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, vrEntity.id))\r\n                    )\r\n                  : widgetContext.rxjs.of(null)\r\n              )\r\n            );\r\n\r\n          })\r\n        );\r\n      })\r\n    );\r\n  }\r\n\r\n  function transferVrsForPhysicalDevice(physicalDeviceId, newOwner, hasProjectMeasurements) {\r\n    return getVrDevicesForDevice(physicalDeviceId).pipe(\r\n      widgetContext.rxjs.switchMap(vrIds => {\r\n        if (!vrIds || vrIds.length === 0) return widgetContext.rxjs.of(null);\r\n        const ops = vrIds.map(vrId => transferVrDevice(vrId, newOwner, hasProjectMeasurements));\r\n        return widgetContext.rxjs.forkJoin(ops);\r\n      })\r\n    );\r\n  }\r\n\r\n  vm.save = function () {\r\n    const formValue = vm.transferKitFormGroup.value;\r\n    const selectedCustomer = formValue.customer;\r\n    if (!selectedCustomer || !selectedCustomer.id) { console.warn('No customer selected.'); return; }\r\n\r\n    if (!vm.customerShortName) vm.customerShortName = selectedCustomer.title;\r\n    const selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n    const newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n\r\n    const saveObservables = [];\r\n    const hasProjectMeasurements = vm.foundProject || (vm.projectMeasurements && vm.projectMeasurements.length > 0);\r\n    const selectedKit = formValue.kit;\r\n    if (!selectedKit.name) { console.warn(\"Selected kit has no name. Aborting save.\"); return; }\r\n    \r\n      vm.measurementRenameMap = new Map();\r\n      if (Array.isArray(vm.projectMeasurements) && vm.projectMeasurements.length > 0) {\r\n        vm.projectMeasurements.forEach((measurement, index) => {\r\n          const ctrl = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n          const newName = ctrl ? String(ctrl.value || '').trim() : '';\r\n          const oldName = String(measurement.name || '').trim();\r\n          if (oldName && newName) {\r\n            vm.measurementRenameMap.set(oldName, newName);\r\n            console.debug('[VR Rename] map:', oldName, '→', newName);\r\n          }\r\n        });\r\n      } else {\r\n        console.debug('[VR Rename] No project measurements; VR renames may be skipped.');\r\n      }\r\n\r\n\r\n    const preEnsure$ = widgetContext.rxjs.forkJoin([\r\n      getDiagnostickitsGroup(newOwner),\r\n      getDiagnostickitDevicesGroup(newOwner),\r\n      getGatewaysGroup(newOwner),\r\n      getUnassignedMeasurementDevicesGroup(newOwner),\r\n      getProjectsGroup(newOwner),\r\n      getMeasurementsGroup(newOwner)\r\n    ]).pipe(widgetContext.rxjs.catchError(() => widgetContext.rxjs.of(null)));\r\n\r\n\r\n    preEnsure$.subscribe(() => {\r\n      // KIT\r\n      let kitSave$ = assetService.saveAsset(selectedKit).pipe(\r\n        widgetContext.rxjs.switchMap(updatedKit => {\r\n          let kitEntity = updatedKit.id && updatedKit.id.entityType ? updatedKit.id : { id: updatedKit.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n            widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, kitEntity)),\r\n            widgetContext.rxjs.switchMap(() =>\r\n              getDiagnostickitsGroup(newOwner).pipe(\r\n                widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, kitEntity.id))\r\n              )\r\n            )\r\n          );\r\n        })\r\n      );\r\n      saveObservables.push(kitSave$);\r\n\r\n\r\n      if (vm.foundProject) {\r\n        let project = vm.foundProject;\r\n        let candidate = (vm.transferredProject && vm.transferredProject.trim()) || ((vm.customerShortName || selectedCustomer.title) + '_Project_1');\r\n        vm.transferredProject = candidate;\r\n        project.name = candidate;\r\n        if (!project.type || !project.type.trim()) project.type = \"Project\";\r\n\r\n        let projectSave$ = assetService.saveAsset(project).pipe(\r\n          widgetContext.rxjs.switchMap(updatedProject => {\r\n            let projectEntity = updatedProject.id && updatedProject.id.entityType ? updatedProject.id : { id: updatedProject.id, entityType: 'ASSET' };\r\n            return entityGroupService.changeEntityOwner(newOwner, projectEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, projectEntity)),\r\n              widgetContext.rxjs.switchMap(() => getProjectsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, projectEntity.id))\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(projectSave$);\r\n      }\r\n\r\n\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        let newMeasurementName = vm.transferKitFormGroup.get('transferredMeasurement' + index).value;\r\n        if (!newMeasurementName || !newMeasurementName.trim()) return;\r\n\r\n        measurement.name = newMeasurementName.trim();\r\n        let measurementSave$ = assetService.saveAsset(measurement).pipe(\r\n          widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n            let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType ? updatedMeasurement.id : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n            return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, measurementEntity)),\r\n              widgetContext.rxjs.switchMap(() => getMeasurementsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, measurementEntity.id))\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(measurementSave$);\r\n      });\r\n\r\n\r\n      vm.allDevices.forEach((device, index) => {\r\n        let newDeviceName = vm.transferKitFormGroup.get('transferredDevice' + index).value;\r\n        if (!newDeviceName || !newDeviceName.trim()) return;\r\n        device.name = newDeviceName.trim();\r\n\r\n        let deviceSave$ = deviceService.saveDevice(device).pipe(\r\n          widgetContext.rxjs.switchMap(updatedDevice => {\r\n            const deviceEntity = updatedDevice.id && updatedDevice.id.entityType ? updatedDevice.id : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n            return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() =>\r\n                getDiagnostickitDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                )\r\n              ),\r\n              widgetContext.rxjs.switchMap(() => {\r\n                if (updatedDevice.type === 'RESI' || updatedDevice.type === 'Gateway') {\r\n                  return getGatewaysGroup(newOwner).pipe(\r\n                    widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                  );\r\n                }\r\n                return widgetContext.rxjs.of(null);\r\n              }),\r\n              widgetContext.rxjs.switchMap(() => {\r\n                if (!hasProjectMeasurements) {\r\n                  return getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                    widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                  );\r\n                }\r\n                return widgetContext.rxjs.of(null);\r\n              }),\r\n\r\n              widgetContext.rxjs.switchMap(() =>\r\n                transferVrsForPhysicalDevice(deviceEntity.id, newOwner, hasProjectMeasurements)\r\n              )\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(deviceSave$);\r\n      });\r\n\r\n      widgetContext.rxjs.forkJoin(saveObservables).subscribe(\r\n        () => { widgetContext.updateAliases(); vm.dialogRef.close(formValue); },\r\n        err => { console.error('Error updating assets:', err); }\r\n      );\r\n    });\r\n  };\r\n\r\n  vm.cancel = function () { vm.dialogRef.close(null); };\r\n}\r\n\r\n\r\n\r\n/*let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet dialogs = injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\nlet customerId, customer;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet pageLink = {\r\n  pageSize: 100,\r\n  page: 0,\r\n  textSearch: '',\r\n  sortOrder: 'ASC',\r\n  sortProperty: 'title',\r\n  toQuery: function () {\r\n    let query = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) { query += '&textSearch=' + encodeURIComponent(this.textSearch); }\r\n    if (this.sortProperty) { query += '&sortProperty=' + encodeURIComponent(this.sortProperty); }\r\n    if (this.sortOrder) { query += '&sortOrder=' + encodeURIComponent(this.sortOrder); }\r\n    return query;\r\n  }\r\n};\r\n\r\nlet kits = [];\r\nlet customers = [];\r\nlet kitsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (kitsLoaded && customersLoaded) {\r\n    openTransferKitDialog(kits, customers);\r\n  }\r\n}\r\n\r\nlet kitSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id,\r\n    rootType: 'CUSTOMER',\r\n    direction: 'FROM',\r\n    relationTypeGroup: 'COMMON',\r\n    maxLevel: 10,\r\n    fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Diagnostickit']\r\n};\r\n\r\nassetService.findByQuery(kitSearchQuery).subscribe(\r\n  result => { kits = result; kitsLoaded = true; checkAndOpenDialog(); },\r\n  () => { kits = []; kitsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\nlet bearerToken = '';\r\nfetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n  method: 'POST',\r\n  headers: {\r\n    'Content-Type': 'application/json'\r\n  },\r\n  body: JSON.stringify({\r\n    \"username\": \"belimo.api@pke-iot.expert\",\r\n    \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n  })\r\n})\r\n  .then(resp => resp.json())\r\n  .then(loginData => {\r\n    bearerToken = loginData.token;\r\n    return fetch('https://cloud.pke-iot.expert/api/customers?pageSize=100&page=0', {\r\n      method: 'GET',\r\n      headers: {\r\n        'accept': 'application/json',\r\n        'X-Authorization': 'Bearer ' + bearerToken\r\n      }\r\n    });\r\n  })\r\n  .then(resp2 => resp2.json())\r\n  .then(customersList => {\r\n    // Process the customers data here.\r\n    customers = customersList.data;\r\n    if (customer) { customers = customers.filter(cust => cust.title !== customer); }\r\n    customersLoaded = true;\r\n    checkAndOpenDialog();\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching customers:\", error);\r\n    alert('Failed to fetch customers.');\r\n  });\r\n\r\n\r\nfunction openTransferKitDialog(kits, customers) {\r\n  customDialog.customDialog(htmlTemplate, TransferKitDialogController, {\r\n    kits: kits,\r\n    customers: customers\r\n  }).subscribe();\r\n}\r\n\r\nfunction TransferKitDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.kits = data.kits || [];\r\n  vm.customers = data.customers || [];\r\n\r\n  vm.transferKitFormGroup = vm.fb.group({\r\n    kit: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n  vm.transferKitFormGroup.addControl('transferredProject', vm.fb.control({ value: '', disabled: true }));\r\n\r\n  vm.allDevices = [];\r\n  vm.devicesWithMeasurements = [];\r\n  vm.foundProject = null;\r\n  vm.projectMeasurements = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n\r\n  vm.transferKitFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId,\r\n          rootType: 'CUSTOMER',\r\n          direction: 'FROM',\r\n          relationTypeGroup: 'COMMON',\r\n          maxLevel: 10,\r\n          fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { \r\n          vm.transferredProject = null; \r\n          vm.customerShortName = null; \r\n        }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null;\r\n      vm.customerShortName = null;\r\n      // Clear out the transferred measurements when no customer is selected.\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        if (vm.transferKitFormGroup.get('transferredMeasurement' + index)) {\r\n          vm.transferKitFormGroup.get('transferredMeasurement' + index).setValue('');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  vm.onKitSelected = function (event) {\r\n    let selectedKit = event.value;\r\n    vm.allDevices = [];\r\n    vm.devicesWithMeasurements = [];\r\n    vm.foundProject = null;\r\n    vm.projectMeasurements = [];\r\n\r\n    // Remove previous measurement and device controls.\r\n    Object.keys(vm.transferKitFormGroup.controls)\r\n      .filter(controlName => controlName.startsWith('measurement') ||\r\n                             controlName.startsWith('transferredMeasurement') ||\r\n                             controlName.startsWith('device') ||\r\n                             controlName.startsWith('transferredDevice'))\r\n      .forEach(controlName => {\r\n        vm.transferKitFormGroup.removeControl(controlName);\r\n      });\r\n    \r\n    let selectedCustomer = vm.transferKitFormGroup.get('customer').value;\r\n    if (!selectedKit || !selectedCustomer) {\r\n      console.warn(\"Kit or customer not selected yet.\");\r\n      return;\r\n    }\r\n    \r\n    let selectedKitId = selectedKit.id.id ? selectedKit.id.id : selectedKit.id;\r\n\r\n    let deviceSearchQuery = {\r\n      parameters: {\r\n        rootId: selectedKitId,\r\n        rootType: 'ASSET',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: true\r\n      },\r\n      relationType: 'Contains',\r\n      deviceTypes: [\r\n          'P-Flow D116',\r\n          'Room Sensor CO2',\r\n          'Temperature Sensor',\r\n          'RESI',\r\n          'Gateway',\r\n          'LTE Status'\r\n      ]\r\n    };\r\n    \r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n      devices => {\r\n        vm.allDevices = devices || [];\r\n        \r\n        if (vm.allDevices.length === 0) {\r\n          console.warn(\"No devices found in selected kit.\");\r\n          return;\r\n        }\r\n        // For each device, add two controls: one showing the original device name, and one for transferred device,\r\n        // which is automatically set to the same name as the found device.\r\n        vm.allDevices.forEach((device, index) => {\r\n          vm.transferKitFormGroup.addControl(\r\n            'device' + index,\r\n            vm.fb.control({ value: device.name, disabled: true })\r\n          );\r\n          vm.transferKitFormGroup.addControl(\r\n            'transferredDevice' + index,\r\n            vm.fb.control({ value: device.name, disabled: true })\r\n          );\r\n        });\r\n\r\n        let measurementChecks = vm.allDevices.map(device => {\r\n          let measurementQuery = {\r\n            parameters: {\r\n              rootId: (device.id.id ? device.id.id : device.id),\r\n              rootType: 'DEVICE',\r\n              direction: 'TO',\r\n              relationTypeGroup: 'COMMON',\r\n              maxLevel: 1073741824,\r\n              fetchLastLevelOnly: false\r\n            },\r\n            relationType: 'Measurement',\r\n            assetTypes: ['Measurement']\r\n          };\r\n          return assetService.findByQuery(measurementQuery).pipe(\r\n            widgetContext.rxjs.map(measurements => {\r\n              return { device: device, measurements: measurements || [] };\r\n            })\r\n          );\r\n        });\r\n        widgetContext.rxjs.forkJoin(measurementChecks).subscribe(\r\n          measurementResults => {\r\n            vm.devicesWithMeasurements = measurementResults.filter(r => r.measurements.length > 0);\r\n            let projectChecks = [];\r\n            vm.devicesWithMeasurements.forEach(item => {\r\n              item.measurements.forEach(meas => {\r\n                let projectQuery = {\r\n                  parameters: {\r\n                    rootId: (meas.id.id ? meas.id.id : meas.id),\r\n                    rootType: 'ASSET',\r\n                    direction: 'TO',\r\n                    relationTypeGroup: 'COMMON',\r\n                    maxLevel: 10,\r\n                    fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: 'Owns',\r\n                  assetTypes: ['Project']\r\n                };\r\n                projectChecks.push(\r\n                  assetService.findByQuery(projectQuery).pipe(\r\n                    widgetContext.rxjs.map(projects => {\r\n                      return { measurement: meas, projects: projects || [] };\r\n                    })\r\n                  )\r\n                );\r\n              });\r\n            });\r\n            if (projectChecks.length === 0) {\r\n              return;\r\n            }\r\n            widgetContext.rxjs.forkJoin(projectChecks).subscribe(\r\n              projectResults => {\r\n                let found = projectResults.find(r => r.projects.length > 0);\r\n                if (found) {\r\n                  vm.foundProject = found.projects[0];\r\n                  if (!vm.transferKitFormGroup.get('foundProject')) {\r\n                    vm.transferKitFormGroup.addControl(\r\n                      'foundProject',\r\n                      vm.fb.control({ value: vm.foundProject.name, disabled: true })\r\n                    );\r\n                  } else {\r\n                    vm.transferKitFormGroup.get('foundProject').setValue(vm.foundProject.name);\r\n                  }\r\n                  searchMeasurementsForProject(vm.foundProject);\r\n                }\r\n              },\r\n              err => {\r\n                console.error(\"Error during project queries:\", err);\r\n              }\r\n            );\r\n          },\r\n          err => {\r\n            console.error(\"Error in measurement checks:\", err);\r\n          }\r\n        );\r\n      },\r\n      err => {\r\n        console.error(\"Error finding devices for kit:\", err);\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.onCustomerSelected = function (event) {\r\n    let kit = vm.transferKitFormGroup.get('kit').value;\r\n    if (kit) {\r\n      vm.onKitSelected({ value: kit });\r\n    }\r\n  };\r\n\r\n  function updateFoundProjectName(customerShortName, existingProjects) {\r\n    if (!customerShortName) {\r\n      console.warn(\"Customer short name is not defined.\");\r\n      return;\r\n    }\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) {\r\n          maxNumericSuffix = parsedNum;\r\n        }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    vm.transferredProject = candidate;\r\n    vm.transferKitFormGroup.get('transferredProject').setValue(candidate);\r\n    // Device names remain as set.\r\n  }\r\n\r\n  function renameProjectMeasurements() {\r\n    if (!vm.customerShortName) {\r\n      console.warn(\"Customer short name not set. Skipping measurement rename.\");\r\n      return;\r\n    }\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n    let newProjectName = vm.transferKitFormGroup.get('transferredProject');\r\n      let oldName = measurement.name;\r\n      let parts = oldName.split('_');\r\n      let newName = newProjectName.value + '_' + parts[2];\r\n      let control = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n      if (control) {\r\n        control.setValue(newName);\r\n      }\r\n    });\r\n  }\r\n\r\n  function searchMeasurementsForProject(project) {\r\n    let projectId = project.id.id ? project.id.id : project.id;\r\n    let projectMeasurementQuery = {\r\n      parameters: {\r\n        rootId: projectId,\r\n        rootType: 'ASSET',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Measurement']\r\n    };\r\n    assetService.findByQuery(projectMeasurementQuery).subscribe(\r\n      measurements => {\r\n        vm.projectMeasurements = measurements || [];\r\n\r\n        // Remove old measurement controls.\r\n        Object.keys(vm.transferKitFormGroup.controls)\r\n          .filter(controlName => controlName.startsWith('measurement') ||\r\n                                 controlName.startsWith('transferredMeasurement'))\r\n          .forEach(controlName => {\r\n            vm.transferKitFormGroup.removeControl(controlName);\r\n          });\r\n\r\n        (measurements || []).forEach((measurement, index) => {\r\n          vm.transferKitFormGroup.addControl(\r\n            'measurement' + index,\r\n            vm.fb.control({ value: measurement.name, disabled: true })\r\n          );\r\n          // Create transferred measurement control as disabled.\r\n          vm.transferKitFormGroup.addControl(\r\n            'transferredMeasurement' + index,\r\n            vm.fb.control({ value: '', disabled: true })\r\n          );\r\n        });\r\n\r\n        renameProjectMeasurements();\r\n      },\r\n      err => {\r\n        console.error(\"Error finding measurements for project:\", err);\r\n      }\r\n    );\r\n  }\r\n\r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      })\r\n    );\r\n  }\r\n  \r\n  // --- Group helper functions ---\r\n    function getProjectsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let projectsGroup = groups.find(g => g.name === 'Projects');\r\n          if (projectsGroup) {\r\n            return widgetContext.rxjs.of(projectsGroup);\r\n          } else {\r\n            projectsGroup = { type: 'ASSET', name: 'Projects', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(projectsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getMeasurementsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let measurementsGroup = groups.find(g => g.name === 'Measurements');\r\n          if (measurementsGroup) {\r\n            return widgetContext.rxjs.of(measurementsGroup);\r\n          } else {\r\n            measurementsGroup = { type: 'ASSET', name: 'Measurements', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(measurementsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getDiagnostickitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let kitsGroup = groups.find(g => g.name === 'Diagnostickits');\r\n          if (kitsGroup) {\r\n            return widgetContext.rxjs.of(kitsGroup);\r\n          } else {\r\n            kitsGroup = { type: 'ASSET', name: 'Diagnostickits', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(kitsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    // Modified getGatewaysGroup: Removed the type check\r\n    function getGatewaysGroup(customerId, updatedDevice) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let devicesGroup = groups.find(g => g.name === 'Gateways');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = { type: 'DEVICE', name: 'Gateways', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n    \r\n    function getDiagnostickitDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let devicesGroup = groups.find(g => g.name === 'Diagnostickit Devices');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = { type: 'DEVICE', name: 'Diagnostickit Devices', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    \r\n    function getUnassignedMeasurementDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let unassignedGroup = groups.find(g => g.name === 'Unassigned Measurement Devices');\r\n          if (unassignedGroup) {\r\n            return widgetContext.rxjs.of(unassignedGroup);\r\n          } else {\r\n            unassignedGroup = { type: 'DEVICE', name: 'Unassigned Measurement Devices', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(unassignedGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n  vm.save = function () {\r\n    let formValue = vm.transferKitFormGroup.value;\r\n    let selectedCustomer = formValue.customer;\r\n    if (!selectedCustomer || !selectedCustomer.id) {\r\n      console.warn('No customer selected.');\r\n      return;\r\n    }\r\n\r\n    if (!vm.customerShortName) {\r\n      vm.customerShortName = selectedCustomer.title;\r\n    }\r\n    let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n    let newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n\r\n    let saveObservables = [];\r\n    \r\n    let hasProjectMeasurements = vm.foundProject || (vm.projectMeasurements && vm.projectMeasurements.length > 0);\r\n    \r\n    let selectedKit = formValue.kit;\r\n    if (!selectedKit.name) {\r\n      console.warn(\"Selected kit has no name. Aborting save.\");\r\n      return;\r\n    }\r\n    let kitSave$ = assetService.saveAsset(selectedKit).pipe(\r\n      widgetContext.rxjs.switchMap(updatedKit => {\r\n        let kitEntity = updatedKit.id && updatedKit.id.entityType \r\n                          ? updatedKit.id \r\n                          : { id: updatedKit.id, entityType: 'ASSET' };\r\n        return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n            widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, kitEntity)),\r\n            // Always assign to Diagnostickits group\r\n            widgetContext.rxjs.switchMap(() => \r\n              getDiagnostickitsGroup(newOwner).pipe(\r\n                widgetContext.rxjs.switchMap(group => \r\n                  entityGroupService.addEntitiesToEntityGroup(group.id.id, [kitEntity.id])\r\n                )\r\n              )\r\n            ),\r\n            // If no project/measurements, also add to Unassigned Kit Group\r\n         );\r\n      })\r\n    );\r\n    saveObservables.push(kitSave$);\r\n\r\n    if (vm.foundProject) {\r\n      let project = vm.foundProject;\r\n      let candidate = vm.transferredProject && vm.transferredProject.trim();\r\n      if (!candidate) {\r\n        console.warn(\"Transferred project name was empty.\");\r\n        candidate = (vm.customerShortName || selectedCustomer.title) + '_Project_1';\r\n        formValue.transferredProject = candidate;\r\n        console.warn(\"Using fallback: \" + candidate);\r\n      }\r\n      project.name = candidate;\r\n      if (!project.type || project.type.trim() === \"\") {\r\n        project.type = \"Project\";\r\n      }\r\n      let projectSave$ = assetService.saveAsset(project).pipe(\r\n        widgetContext.rxjs.switchMap(updatedProject => {\r\n          let projectEntity = updatedProject.id && updatedProject.id.entityType \r\n                              ? updatedProject.id \r\n                              : { id: updatedProject.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, projectEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, projectEntity)),\r\n              widgetContext.rxjs.switchMap(() => getProjectsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(projectsGroup =>\r\n                entityGroupService.addEntitiesToEntityGroup(projectsGroup.id.id, [projectEntity.id])\r\n              )\r\n            );\r\n        })\r\n      );\r\n      saveObservables.push(projectSave$);\r\n    }\r\n\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n      let newMeasurementName = vm.transferKitFormGroup.get('transferredMeasurement' + index).value;\r\n      if (!newMeasurementName || newMeasurementName.trim() === \"\") {\r\n        console.warn(`New name for measurement at index ${index} is empty. Skipping update.`);\r\n        return;\r\n      }\r\n      measurement.name = newMeasurementName.trim();\r\n      let measurementSave$ = assetService.saveAsset(measurement).pipe(\r\n        widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n          let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType \r\n                                  ? updatedMeasurement.id \r\n                                  : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, measurementEntity)),\r\n              widgetContext.rxjs.switchMap(() => getMeasurementsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(measurementsGroup =>\r\n                entityGroupService.addEntitiesToEntityGroup(measurementsGroup.id.id, [measurementEntity.id])\r\n              )\r\n            );\r\n        })\r\n      );\r\n      saveObservables.push(measurementSave$);\r\n    });\r\n\r\n    // For each device, update its name with the value from the transferred device control.\r\n    // In the vm.save function, within the device update chain:\r\n    vm.allDevices.forEach((device, index) => {\r\n      let newDeviceName = vm.transferKitFormGroup.get('transferredDevice' + index).value;\r\n      if (!newDeviceName || newDeviceName.trim() === \"\") {\r\n        console.warn(`New name for device at index ${index} is empty. Skipping update.`);\r\n        return;\r\n      }\r\n      device.name = newDeviceName.trim();\r\n      let deviceSave$ = deviceService.saveDevice(device).pipe(\r\n        widgetContext.rxjs.switchMap(updatedDevice => {\r\n          let deviceEntity = updatedDevice.id && updatedDevice.id.entityType \r\n                             ? updatedDevice.id \r\n                             : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n          return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n            // Always assign to Diagnostickit Devices group\r\n            widgetContext.rxjs.switchMap(() => {\r\n              return getDiagnostickitDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(devicesGroup =>\r\n                    entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n            }\r\n            ),\r\n            // Conditionally assign to Gateways group if updatedDevice.type is 'RESI' or 'Gateway'\r\n            widgetContext.rxjs.switchMap(() => {\r\n              if (updatedDevice.type === 'RESI' || updatedDevice.type === 'Gateway') {\r\n                return getGatewaysGroup(newOwner, updatedDevice).pipe(\r\n                  widgetContext.rxjs.switchMap(devicesGroup =>\r\n                    entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n              } else {\r\n                return widgetContext.rxjs.of(null);\r\n              }\r\n            }),\r\n            // Additionally, if no project/measurements exist, assign to Unassigned Measurement Devices\r\n            widgetContext.rxjs.switchMap(() => {\r\n              if (!hasProjectMeasurements) {\r\n                return getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(group =>\r\n                    entityGroupService.addEntitiesToEntityGroup(group.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n              } else {\r\n                return widgetContext.rxjs.of(null);\r\n              }\r\n            })\r\n          );\r\n        })\r\n      );\r\n      saveObservables.push(deviceSave$);\r\n    });\r\n\r\n\r\n    widgetContext.rxjs.forkJoin(saveObservables).subscribe(\r\n      () => {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(formValue);\r\n      },\r\n      err => {\r\n        console.error('Error updating assets:', err);\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n}\r\n*/",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "20030896-36ba-fa5d-814d-09bac156d398"
              },
              {
                "name": "Refresh",
                "icon": "refresh",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "3218fb1e-c187-8197-670e-0ffb20e33283"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "d2cec1c0-f9bb-1c7c-25ae-ea8853bc3b7e",
        "typeFullFqn": "system.cards.entities_table"
      },
      "ed6cf40c-1c37-2fe9-4436-22c669817f3e": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "filterId": null,
              "dataKeys": []
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "var DoktorkitState;\r\nif (data && data.length && data[0]['entityId']) {\r\n    DoktorkitState = true;\r\n} else {\r\n    DoktorkitState = false;\r\n}\r\n\r\nvar typeSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24\" viewBox=\"0 -960 960 960\" width=\"24\"><path d=\"M160-80q-33 0-56.5-23.5T80-160v-480q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v480q0 33-23.5 56.5T800-80H160Zm240-640h160v-80H400v80Zm40 360v120h80v-120h120v-80H520v-120h-80v120H320v80h120Z\"/></svg>';\r\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\r\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\r\n\r\nvar header = '<div class=\"header\" fxLayout=\"column\" fxLayoutAlign=\"start stretch\" fxLayoutGap=\"8px\">' +\r\n                '<div fxLayout=\"row\" fxLayoutAlign=\"start stretch\">' +\r\n                  '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><button id=\"go-back\" matTooltip=\"Go back\" type=\"button\" mat-icon-button><mat-icon>arrow_back</mat-icon></button></div>' +\r\n                 /* '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><img style=\"vertical-align: middle;\" class=\"title-icon mat-icon\" src=\"'+ typeSvgUrl +'\"></div>' +*/\r\n                  '<div fxFlex fxLayout=\"column\" fxLayoutAlign=\"center\">' +\r\n                     '<div class=\"title\">Edit Doktorkit: {{ ctx.stateController.getStateParams().selectedDoktorkit?.entityName }}</div>' +\r\n                  '</div>' +\r\n                '</div>' +\r\n                '<div fxLayout=\"row\" fxLayoutAlign=\"stretch stretch\" fxLayoutGap=\"8px\">' +\r\n                  /*'<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"add-Kit\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">add_circle</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"Doktorkits\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">devices_other</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"Sensorkits\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">sensors</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +*/\r\n                  '<div fxFlex=\"50\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"get-location\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">location_on</mat-icon>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"50\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"delete-Doktorkit\" type=\"button\" mat-raised-button color=\"accent\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">delete</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                '</div>' +\r\n             '</div>';\r\n             \r\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\r\n          (DoktorkitState \r\n            ? (header +\r\n               '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"edit_Doktorkit_card\"></tb-dashboard-state>') \r\n            : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"doktorkits_card_all_customer\"></tb-dashboard-state>') +\r\n       '</div>';\r\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n.main-layout .header {\n    height: 100px;\n    margin: 6px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n.main-layout .tb-mat-20 {\n    width: 1px;\n    height: 2px;\n    margin: 2px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 12px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedDoktorkit'] = null;\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "116515c2-d9bd-80b6-7a34-97373a802806"
              },
              {
                "name": "Doktorkit-devices",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f921410a-47b7-5884-1c63-d010a39064a4"
              }
            ],
            "headerButton": []
          }
        },
        "row": 0,
        "col": 0,
        "id": "ed6cf40c-1c37-2fe9-4436-22c669817f3e",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "4cc2a279-fbae-dce8-0827-5a24057fe53e": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\n     <div fxLayout=\"row\" style=\"width: 100%; height: 60px;\" fxLayoutAlign=\"center start\">\n        <h5 fxFlex class=\"market-title\">Doktorkits</h5>\n        <button id=\"add-Doktorkit\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">add</mat-icon><span>Add Doktorkit</span></button>\n     </div>\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"doktorkits_map_all\"></tb-dashboard-state>\n    </div>\n</div>",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-container .tb-widget .tb-multiple-input {\n    background-color: #FAFAFA;\n    border-radius: 4px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .input-field {\n    padding-right: 30px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input mat-slide-toggle {\n    margin-top: 15px !important;\n    margin-bottom: 0 !important;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-slide-toggle-content {\n    width: 120px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-bar {\n    width: 42px;\n    height: 24px;\n    border-radius: 16px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb-container {\n    top: 2px;\n    left: 2px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-thumb-container {\n    transform: translate3d(18px, 0, 0);\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb {\n    background-color: #fafafa;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-bar {\n    background-color: #F2994A;\n}\n",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "add-Doktorkit",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDoktorkitFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 350px;\">\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\n    <h2>Add Doktorkit</h2>\n    <span fxFlex></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content fxLayout=\"column\">\n    <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">\n      <mat-form-field fxFlex class=\"mat-block\">\n        <mat-label>Doktorkit title</mat-label>\n        <input matInput formControlName=\"name\" required>\n        <mat-error *ngIf=\"addDoktorkitFormGroup.get('name').hasError('required')\">\n          Doktorkit title is required.\n        </mat-error>\n      </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      Cancel\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addDoktorkitFormGroup.invalid || !addDoktorkitFormGroup.dirty\">\n      Add Doktorkit\n    </button>\n  </div>\n</form>\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\n\r\nopenAddDoktorkitDialog();\r\n\r\nfunction openAddDoktorkitDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddDoktorkitDialogController).subscribe();\r\n}\r\n\r\nfunction AddDoktorkitDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.addDoktorkitFormGroup = vm.fb.group({\r\n    name: ['', [vm.validators.required]]\r\n  });\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    const stateParams = widgetContext.stateController.getStateParams();\r\n    var customerId;\r\n    var projectId;\r\n    var measurementId;\r\n    projectId = {id:(stateParams.selectedProject && stateParams.selectedProject.entityId && stateParams.selectedProject.entityId.id) ? stateParams.selectedProject.entityId.id : '',entityType: 'ASSET'}; \r\n    measurementId = {id:(stateParams.selectedMeasurement && stateParams.selectedMeasurement.entityId && stateParams.selectedMeasurement.entityId.id) ? stateParams.selectedMeasurement.entityId.id : '',entityType: 'ASSET'}; \r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        customerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n    vm.addDoktorkitFormGroup.markAsPristine();\r\n    saveDoktorkitObservable(customerId).subscribe(\r\n      function (Doktorkit) {\r\n        const observables = [\r\n        saveCustomerToDoktorkitRelation(customerId, Doktorkit.id),\r\n        saveAttributes(Doktorkit.id)\r\n        ];\r\n        // Add saveProjectToMeasurementRelation to observables if projectId is not empty\r\n        if(projectId.id !== \"\"){\r\n            observables.push(saveProjectToDoktorkitRelation(projectId, Doktorkit.id));\r\n        }\r\n        if(measurementId.id !== \"\"){\r\n            observables.push(saveMeasurementToDoktorkitRelation(measurementId, Doktorkit.id));\r\n        }\r\n          widgetContext.rxjs.forkJoin(observables).subscribe(\r\n              function () {\r\n                var params = widgetContext.stateController.getStateParams();\r\n                var selectedDoktorkit = params['selectedDoktorkit'];\r\n                params['selectedDoktorkit'] = { entityId: Doktorkit.id, entityName: Doktorkit.name, entityLabel: '' };\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              }\r\n        );\r\n      }\r\n    );\r\n  };\r\n\r\n  function saveDoktorkitObservable(customerId) {\r\n    return getDoktorkitsGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((DoktorkitsGroup) => {\r\n            return getUnassignedKitGroup(customerId).pipe(\r\n                widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\r\n                    const formValues = vm.addDoktorkitFormGroup.value;\r\n                    const Doktorkit = {\r\n                        name: formValues.name,\r\n                        type: 'Doktorkit',\r\n                        customerId: customerId\r\n                    };\r\n\r\n                    return assetService.saveAsset(Doktorkit, DoktorkitsGroup.id.id).pipe(\r\n                        widgetContext.rxjs.switchMap((savedAsset) => {\r\n                            // Ensure this line returns an observable\r\n                            return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, savedAsset.id.id).pipe(\r\n                                widgetContext.rxjs.map(() => {\r\n                                    return savedAsset; // Return the saved asset after adding to the entity group\r\n                                })\r\n                            );\r\n                        })\r\n                    );\r\n                })\r\n            );\r\n        })\r\n    );\r\n}\r\n\r\n\r\n  \r\n  function getDoktorkitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var DoktorkitsGroup = entityGroups.find(group => group.name === 'Doktorkits');\r\n              if (DoktorkitsGroup) {\r\n                  return widgetContext.rxjs.of(DoktorkitsGroup);\r\n              } else {\r\n                  DoktorkitsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Doktorkits',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(DoktorkitsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  function getUnassignedKitGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n              if (UnassignedKitGroup) {\r\n                  return widgetContext.rxjs.of(UnassignedKitGroup);\r\n              } else {\r\n                  UnassignedKitGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Unassigned Kit',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n\r\n  function saveCustomerToDoktorkitRelation(customerId, DoktorkitId) {\r\n      var relation = {\r\n          from: customerId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveProjectToDoktorkitRelation(projectId, DoktorkitId) {\r\n      var relation = {\r\n          from: projectId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveMeasurementToDoktorkitRelation(measurementId, DoktorkitId) {\r\n      var relation = {\r\n          from: measurementId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n        {\r\n            key: 'latitude',\r\n            value: 48.1406022\r\n        },\r\n        {\r\n            key: 'longitude',\r\n            value: 16.2932688\r\n        },\r\n        {\r\n            key: 'alias',\r\n            value: 'N/A'\r\n        },        \r\n        {\r\n            key: 'address',\r\n            value: 'N/A'\r\n        },\r\n        {\r\n            key: 'state',\r\n            value: 'normal'\r\n        },\r\n        {\r\n            key: 'units',\r\n            value: 'metric'\r\n        },\r\n        {\r\n            key: 'floorplan',\r\n            value: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCEtLSBDcmVhdGVkIHdpdGggSW5rc2NhcGUgKGh0dHA6Ly93d3cuaW5rc2NhcGUub3JnLykgLS0+Cjxzdmcgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc5LjM3NSA3OS4zNzUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiA8cmVjdCB4PSIyLjcwMTkiIHk9IjIuNzAxOSIgd2lkdGg9IjczLjk3MSIgaGVpZ2h0PSI3My45NzEiIGZpbGw9IiNmZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9Ii4xMTIxIiBzdHlsZT0icGFpbnQtb3JkZXI6bWFya2VycyBmaWxsIHN0cm9rZSIvPgogPGcgdHJhbnNmb3JtPSJtYXRyaXgoLjI2NDU4IDAgMCAuMjY0NTggMi42MzUgLTIuODgzNCkiIHN0cm9rZS13aWR0aD0iMXB4IiBzdHlsZT0ic2hhcGUtaW5zaWRlOnVybCgjcmVjdDQ4MzYpO3doaXRlLXNwYWNlOnByZSIgYXJpYS1sYWJlbD0iICAgTm8gcGxhbiBjb25maWd1cmVkIj4KICA8cGF0aCBkPSJtMTAxLjY3IDExOC4yOXYyOC40MzhoLTMuNzg5MWwtMTQuMzE2LTIxLjkzNHYyMS45MzRoLTMuNzY5NXYtMjguNDM4aDMuNzY5NWwxNC4zNzUgMjEuOTkydi0yMS45OTJ6Ii8+CiAgPHBhdGggZD0ibTEwNi44MyAxMzUuOTVxMC00LjU4OTggMi41NzgxLTcuNjU2MiAyLjU3ODEtMy4wODU5IDcuMDExNy0zLjA4NTl0Ny4wMTE3IDMuMDI3M3EyLjU3ODEgMy4wMDc4IDIuNjM2NyA3LjUxOTV2MC42NDQ1M3EwIDQuNTg5OC0yLjU5NzcgNy42NTYyLTIuNTc4MSAzLjA2NjQtNy4wMTE3IDMuMDY2NC00LjQ1MzEgMC03LjA1MDgtMy4wNjY0LTIuNTc4MS0zLjA2NjQtMi41NzgxLTcuNjU2MnptMy42MTMzIDAuNDQ5MjJxMCAzLjE0NDUgMS40ODQ0IDUuNDQ5MiAxLjUwMzkgMi4zMDQ3IDQuNTMxMiAyLjMwNDcgMi45NDkyIDAgNC40NTMxLTIuMjY1NiAxLjUwMzktMi4yODUyIDEuNTIzNC01LjQyOTd2LTAuNTA3ODFxMC0zLjEwNTUtMS41MDM5LTUuNDI5Ny0xLjUwMzktMi4zNDM4LTQuNTExNy0yLjM0MzgtMi45ODgzIDAtNC40OTIyIDIuMzQzOC0xLjQ4NDQgMi4zMjQyLTEuNDg0NCA1LjQyOTd6Ii8+CiAgPHBhdGggZD0ibTE1MC4xNyAxNDcuMTJxLTMuODA4NiAwLTYuMDM1Mi0yLjQ0MTR2MTAuMTc2aC0zLjYzMjh2LTI5LjI1OGgzLjMyMDNsMC4xNzU3OCAyLjMyNDJxMi4yMjY2LTIuNzE0OCA2LjExMzMtMi43MTQ4IDQuMDAzOSAwIDYuMTMyOCAyLjk2ODggMi4xMjg5IDIuOTY4OCAyLjEyODkgNy44MTI1djAuNDEwMTZxMCA0LjYyODktMi4xNDg0IDcuNjc1OC0yLjEyODkgMy4wNDY5LTYuMDU0NyAzLjA0Njl6bS0xLjExMzMtMTguODY3cS0zLjI4MTIgMC00LjkyMTkgMi45MTAydjEwLjExN3ExLjY2MDIgMi44NzExIDQuOTYwOSAyLjg3MTEgMi45Mjk3IDAgNC4yNzczLTIuMzA0NyAxLjM2NzItMi4zMDQ3IDEuMzY3Mi01LjQ0OTJ2LTAuNDEwMTZxMC0zLjE0NDUtMS4zNjcyLTUuNDI5Ny0xLjM0NzYtMi4zMDQ3LTQuMzE2NC0yLjMwNDd6Ii8+CiAgPHBhdGggZD0ibTE2Ni45MSAxMTYuNzN2MzBoLTMuNjMyOHYtMzB6Ii8+CiAgPHBhdGggZD0ibTE4NS43NSAxNDYuNzNxLTAuMzUxNTctMC43NjE3Mi0wLjUwNzgyLTIuMjI2Ni0xLjAxNTYgMS4wNzQyLTIuNTM5MSAxLjg1NTUtMS41MjM0IDAuNzYxNzItMy40NzY2IDAuNzYxNzItMy4yNDIyIDAtNS4xOTUzLTEuODE2NC0xLjk1MzEtMS44MTY0LTEuOTUzMS00LjQ1MzEgMC0zLjM5ODQgMi41NzgxLTUuMTU2MiAyLjU3ODEtMS43NzczIDYuOTMzNi0xLjc3NzNoMy41NzQydi0xLjY3OTdxMC0xLjg3NS0xLjEzMjgtMi45ODgzLTEuMTEzMy0xLjEzMjgtMy4zMjAzLTEuMTMyOC0yLjA1MDggMC0zLjMyMDMgMS4wMTU2LTEuMjUgMC45OTYxLTEuMjUgMi4zMjQyaC0zLjYxMzNxMC0yLjI2NTYgMi4yODUyLTQuMjU3OCAyLjI4NTItMS45OTIyIDYuMTEzMy0xLjk5MjIgMy40Mzc1IDAgNS42NDQ1IDEuNzU3OCAyLjIwNyAxLjc1NzggMi4yMDcgNS4zMTI1djkuNDkyMnEwIDIuOTI5NyAwLjc0MjE5IDQuNjQ4NHYwLjMxMjV6bS01Ljk5NjEtMi43NzM0cTEuOTUzMSAwIDMuMzc4OS0wLjk3NjU2IDEuNDQ1My0wLjk3NjU2IDIuMDMxMi0yLjE2OHYtNC4zNTU1aC0zLjM1OTRxLTYuMDkzOCAwLjExNzE5LTYuMDkzOCAzLjkwNjIgMCAxLjUwMzkgMS4wMTU2IDIuNTU4NiAxLjAxNTYgMS4wMzUyIDMuMDI3MyAxLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTIwMy4yMyAxMjguMjVxLTEuNzM4MyAwLTMuMDY2NCAwLjkzNzUtMS4zMjgxIDAuOTM3NS0yLjA4OTggMi40NDE0djE1LjA5OGgtMy42MTMzdi0yMS4xMzNoMy40MThsMC4xMTcxOSAyLjYzNjdxMi40MDIzLTMuMDI3MyA2LjMwODYtMy4wMjczIDMuMTA1NSAwIDQuOTIxOSAxLjczODMgMS44MzU5IDEuNzM4MyAxLjg1NTUgNS44Mzk4djEzLjk0NWgtMy42MzI4di0xMy44ODdxMC0yLjQ4MDUtMS4wOTM4LTMuNTM1Mi0xLjA3NDItMS4wNTQ3LTMuMTI1LTEuMDU0N3oiLz4KICA8cGF0aCBkPSJtNTcuOTQxIDE5NC4xNXExLjkzMzYgMCAzLjM3ODktMS4xNTIzIDEuNDY0OC0xLjE1MjMgMS42MDE2LTIuOTQ5MmgzLjQzNzVxLTAuMTM2NzIgMi44MzItMi41OTc3IDQuOTYwOS0yLjQ2MDkgMi4xMDk0LTUuODIwMyAyLjEwOTQtNC43NjU2IDAtNy4wODk4LTMuMTQ0NS0yLjMwNDctMy4xNDQ1LTIuMzA0Ny03LjQwMjN2LTAuODIwMzFxMC00LjI1NzggMi4zMDQ3LTcuNDAyNCAyLjMyNDItMy4xNDQ1IDcuMDg5OC0zLjE0NDUgMy43MTA5IDAgNS45OTYxIDIuMjA3IDIuMjg1MiAyLjE4NzUgMi40MjE5IDUuNDQ5MmgtMy40Mzc1cS0wLjEzNjcyLTEuOTUzMS0xLjQ4NDQtMy4zMjAzLTEuMzI4MS0xLjM2NzItMy40OTYxLTEuMzY3Mi0yLjIyNjYgMC0zLjQ5NjEgMS4xMzI4LTEuMjUgMS4xMzI4LTEuNzc3MyAyLjg3MTEtMC41MDc4MSAxLjczODMtMC41MDc4MSAzLjU3NDJ2MC44MjAzMXEwIDEuODU1NSAwLjUwNzgxIDMuNTkzOCAwLjUwNzgxIDEuNzM4MyAxLjc1NzggMi44NzExIDEuMjY5NSAxLjExMzMgMy41MTU2IDEuMTEzM3oiLz4KICA8cGF0aCBkPSJtNjkuNDY1IDE4NS45NXEwLTQuNTg5OCAyLjU3ODEtNy42NTYyIDIuNTc4MS0zLjA4NTkgNy4wMTE3LTMuMDg1OSA0LjQzMzYgMCA3LjAxMTcgMy4wMjczIDIuNTc4MSAzLjAwNzggMi42MzY3IDcuNTE5NXYwLjY0NDUzcTAgNC41ODk4LTIuNTk3NyA3LjY1NjItMi41NzgxIDMuMDY2NC03LjAxMTcgMy4wNjY0LTQuNDUzMSAwLTcuMDUwOC0zLjA2NjQtMi41NzgxLTMuMDY2NC0yLjU3ODEtNy42NTYyem0zLjYxMzMgMC40NDkyMnEwIDMuMTQ0NSAxLjQ4NDQgNS40NDkyIDEuNTAzOSAyLjMwNDcgNC41MzEyIDIuMzA0NyAyLjk0OTIgMCA0LjQ1MzEtMi4yNjU2IDEuNTAzOS0yLjI4NTIgMS41MjM0LTUuNDI5N3YtMC41MDc4MXEwLTMuMTA1NS0xLjUwMzktNS40Mjk3LTEuNTAzOS0yLjM0MzgtNC41MTE3LTIuMzQzOC0yLjk4ODMgMC00LjQ5MjIgMi4zNDM4LTEuNDg0NCAyLjMyNDItMS40ODQ0IDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTAyIDE3OC4yNXEtMS43MzgzIDAtMy4wNjY0IDAuOTM3NS0xLjMyODEgMC45Mzc1LTIuMDg5OCAyLjQ0MTR2MTUuMDk4aC0zLjYxMzN2LTIxLjEzM2gzLjQxOGwwLjExNzE5IDIuNjM2N3EyLjQwMjMtMy4wMjczIDYuMzA4Ni0zLjAyNzMgMy4xMDU1IDAgNC45MjE5IDEuNzM4MyAxLjgzNTkgMS43MzgzIDEuODU1NSA1LjgzOTh2MTMuOTQ1aC0zLjYzMjh2LTEzLjg4N3EwLTIuNDgwNS0xLjA5MzgtMy41MzUyLTEuMDc0Mi0xLjA1NDctMy4xMjUtMS4wNTQ3eiIvPgogIDxwYXRoIGQ9Im0xMjQuNDYgMTc4LjM3aC00LjMxNjR2MTguMzU5aC0zLjYxMzN2LTE4LjM1OWgtMy4zMzk4di0yLjc3MzRoMy4zMzk4di0xLjgzNTlxMC0zLjU5MzggMi4wNzAzLTUuNTA3OCAyLjA3MDMtMS45MzM2IDUuNjY0MS0xLjkzMzYgMi4xODc1IDAgNS41MjczIDEuMTkxNGwtMC42MDU0NiAzLjA0NjlxLTIuNTM5MS0wLjk5NjA5LTQuNjY4LTAuOTk2MDktMi4zMjQyIDAtMy4zNTk0IDEuMDU0Ny0xLjAxNTYgMS4wMzUyLTEuMDE1NiAzLjE0NDV2MS44MzU5aDQuMzE2NHptNy4xMDk0LTIuNzczNHYyMS4xMzNoLTMuNjEzM3YtMjEuMTMzeiIvPgogIDxwYXRoIGQ9Im0xNDUuNTIgMjA1LjA3cS0xLjY0MDYgMC00LjAyMzQtMC44MDA3OC0yLjM4MjgtMC44MDA3OC0zLjgwODYtMi44NzExbDEuODk0NS0yLjE0ODRxMi4zNDM4IDIuODUxNiA1LjY2NDEgMi44NTE2IDIuNTU4NiAwIDQuMDgyLTEuNDQ1MyAxLjUyMzQtMS40MjU4IDEuNTIzNC00LjE5OTJ2LTEuODU1NXEtMi4xNDg0IDIuNTE5NS01LjkxOCAyLjUxOTUtMy44MDg2IDAtNi4wNTQ3LTMuMDQ2OS0yLjI0NjEtMy4wNDY5LTIuMjQ2MS03LjY3NTh2LTAuNDEwMTZxMC00Ljg0MzggMi4yMjY2LTcuODEyNSAyLjI0NjEtMi45Njg4IDYuMTEzMy0yLjk2ODggMy44ODY3IDAgNi4wMzUyIDIuNzM0NGwwLjE3NTc4LTIuMzQzOGgzLjI4MTJ2MjAuNjg0cTAgNC4xOTkyLTIuNSA2LjQ4NDQtMi41IDIuMzA0Ny02LjQ0NTMgMi4zMDQ3em0tNS4yNzM0LTE4LjY3MnEwIDMuMTQ0NSAxLjMwODYgNS40MTAyIDEuMzI4MSAyLjI0NjEgNC4yNTc4IDIuMjQ2MSAzLjQzNzUgMCA1LjAzOTEtMy4xMjV2LTkuNjI4OXEtMC42ODM1OS0xLjMwODYtMS44OTQ1LTIuMTY4LTEuMjEwOS0wLjg3ODktMy4xMDU1LTAuODc4OS0yLjk0OTIgMC00LjI3NzMgMi4zMDQ3LTEuMzI4MSAyLjI4NTItMS4zMjgxIDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTczLjA2IDE5Ni43My0wLjA3ODEtMi4wODk4cS0yLjA3MDMgMi40ODA1LTYuMTcxOSAyLjQ4MDUtMy4xMDU1IDAtNS4wMTk1LTEuODM1OS0xLjkxNDEtMS44MzU5LTEuOTE0MS02LjA1NDd2LTEzLjYzM2gzLjYxMzN2MTMuNjcycTAgMi44NTE2IDEuMTkxNCAzLjgyODEgMS4yMTA5IDAuOTU3MDMgMi42OTUzIDAuOTU3MDMgNC4wODIgMCA1LjUwNzgtMy4wNjY0di0xNS4zOTFoMy42MzI4djIxLjEzM3oiLz4KICA8cGF0aCBkPSJtMTkwLjQ0IDE3OC42OHEtMy41MzUyIDAtNC44MjQyIDMuMDQ2OXYxNWgtMy42MTMzdi0yMS4xMzNoMy41MTU2bDAuMDc4MSAyLjQyMTlxMS43MzgzLTIuODEyNSA1LjAxOTUtMi44MTI1IDEuMDE1NiAwIDEuNjAxNiAwLjI3MzQ0bC0wLjAxOTUgMy4zNTk0cS0wLjgwMDc4LTAuMTU2MjUtMS43NTc4LTAuMTU2MjV6Ii8+CiAgPHBhdGggZD0ibTIxMS45MSAxOTMuMDRxLTEuMDM1MiAxLjU2MjUtMi45Mjk3IDIuODMyLTEuODk0NSAxLjI1LTUuMDE5NSAxLjI1LTQuNDE0MSAwLTcuMDcwMy0yLjg3MTEtMi42MzY3LTIuODcxMS0yLjYzNjctNy4zNDM4di0wLjgyMDMxcTAtMy40NTcgMS4zMDg2LTUuODc4OSAxLjMyODEtMi40NDE0IDMuNDM3NS0zLjcxMDkgMi4xMDk0LTEuMjg5MSA0LjQ5MjItMS4yODkxIDQuNTMxMiAwIDYuNjAxNiAyLjk2ODggMi4wODk4IDIuOTQ5MiAyLjA4OTggNy4zODI4djEuNjIxMWgtMTQuMjk3cTAuMDc4MSAyLjkxMDIgMS43MTg4IDQuOTYwOSAxLjY2MDIgMi4wMzEyIDQuNTUwOCAyLjAzMTIgMS45MTQxIDAgMy4yNDIyLTAuNzgxMjUgMS4zMjgxLTAuNzgxMjUgMi4zMjQyLTIuMDg5OHptLTguNDE4LTE0Ljg2M3EtMi4xNDg0IDAtMy42MzI4IDEuNTYyNS0xLjQ4NDQgMS41NjI1LTEuODU1NSA0LjQ5MjJoMTAuNTY2di0wLjI3MzQ0cS0wLjEzNjcyLTIuMTA5NC0xLjIzMDUtMy45NDUzLTEuMDc0Mi0xLjgzNTktMy44NDc3LTEuODM1OXoiLz4KICA8cGF0aCBkPSJtMjMwLjAzIDE5Ni43My0wLjE3NTc4LTIuMjY1NnEtMi4xNjggMi42NTYyLTYuMDM1MiAyLjY1NjItMy43MTA5IDAtNS45OTYxLTMuMDA3OC0yLjI4NTItMy4wMDc4LTIuMzI0Mi03LjU1ODZ2LTAuNTY2NDFxMC00Ljg0MzggMi4yODUyLTcuODEyNSAyLjMwNDctMi45Njg4IDYuMDc0Mi0yLjk2ODggMy43MzA1IDAgNS44NTk0IDIuNXYtMTAuOTc3aDMuNjMyOHYzMHptLTEwLjg5OC0xMC4zMzJxMCAzLjE0NDUgMS4zMjgxIDUuNDEwMiAxLjMyODEgMi4yNDYxIDQuMjU3OCAyLjI0NjEgMy4zNTk0IDAgNS0zLjA2NjR2LTkuNzI2NnEtMS42MjExLTMuMDA3OC00Ljk2MDktMy4wMDc4LTIuOTQ5MiAwLTQuMjk2OSAyLjMwNDctMS4zMjgxIDIuMjg1Mi0xLjMyODEgNS40Mjk3eiIvPgogPC9nPgo8L3N2Zz4K'\r\n        }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7cad1c71-0765-4277-32a8-c87808a0c689"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "4cc2a279-fbae-dce8-0827-5a24057fe53e",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "af8bd4a6-39c7-d8a5-2894-64840ac87fdd": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Doktorkits",
            "enableSearch": true,
            "enableSelectColumnDisplay": true,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": true,
            "entityNameColumnTitle": "Doktorkit ID",
            "displayEntityLabel": true,
            "entityLabelColumnTitle": "Label",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Doktorkits",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "2519c941-a1b9-45bd-9821-88acf22e10af",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "Address",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "70%",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.1345774127559587,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "locationName",
                  "type": "attribute",
                  "label": "Location Alias",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.7448728411727017,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "Open devices",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "92ce5e29-82ad-9f6e-51be-7bf3e7ae613d"
              }
            ],
            "actionCellButton": [
              {
                "name": "Open Doktorkit devices",
                "icon": "devices_other",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "71c478b6-a4b1-e569-e99a-85d5562cc721"
              }
            ],
            "headerButton": [
              {
                "name": "Refresh",
                "icon": "refresh",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "3218fb1e-c187-8197-670e-0ffb20e33283"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "af8bd4a6-39c7-d8a5-2894-64840ac87fdd",
        "typeFullFqn": "system.cards.entities_table"
      },
      "c12ec825-a7ef-cc4d-da3d-064fba7cc7d7": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1694019264779,
                "endTimeMs": 1694105664779
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Users",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "email",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Users",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "fbfce281-668f-0ad0-d8f4-6870d3ef679f",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "Email",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5669544029828533
                },
                {
                  "name": "firstName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.first-name}",
                  "color": "#4caf50",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.835575628975763,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.last-name}",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7276117794959098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [],
            "actionCellButton": [
              {
                "name": "{i18n:custom.user-management.edit-user}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editUserFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.user-management.edit-smart-retail-user' | translate }}</h2>\n     <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('required')\">\n            {{ 'custom.user-management.email-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('pattern')\">\n            {{ 'custom.user-management.invalid-value-format' | translate }}\n        </mat-error>\n    </mat-form-field>\n    <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.first-name' | translate }}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.last-name' | translate }}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editUserFormGroup.invalid || !editUserFormGroup.dirty\">\n      {{ 'custom.user-management.save-user' | translate }}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\n\nopenEditUserDialog();\n\nfunction openEditUserDialog() {\n  customDialog.customDialog(htmlTemplate, EditUserDialogController).subscribe();\n}\n\nfunction EditUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.user = {};\n  \n  vm.editUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null]\n  });\n  \n  getUser();\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    vm.editUserFormGroup.markAsPristine();\n    saveUserObservable().subscribe(\n      function () {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      }\n    );\n  };\n  \n  function getUser() {\n      userService.getUser(entityId.id).subscribe(\n          (user) => {\n                vm.user = user;          \n                vm.editUserFormGroup.patchValue({\n                  email: vm.user.email,\n                  firstName: vm.user.firstName,\n                  lastName: vm.user.lastName\n                }, {emitEvent: false});\n          }\n    );\n  }\n  \n  function saveUserObservable() {\n      const formValues = vm.editUserFormGroup.value;\n      vm.user.email = formValues.email;\n      vm.user.firstName = formValues.firstName;\n      vm.user.lastName = formValues.lastName;\n      return userService.saveUser(vm.user);\n  }\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.user-management.delete-user}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteUserDialog();\n\nfunction openDeleteUserDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.user-management.delete.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.user-management.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteUser();\n    }\n  });\n}\n\n\nfunction deleteUser() {\n  userService.deleteUser(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.user-management.add-user}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addUserFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.user-management.add-smart-retail-user' | translate }}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n            {{ 'custom.user-management.email-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n            {{ 'custom.user-management.invalid-value-format' | translate }}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.first-name' | translate }}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.last-name' | translate }}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>{{ 'custom.user-management.activation-method' | translate }}</mat-label>\n        <mat-select formControlName=\"userActivationMethod\">\n            <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n                {{ method.name }}\n            </mat-option>\n        </mat-select>\n    </mat-form-field>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      {{ 'custom.user-management.add-user' | translate }}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.activationMethods = [\n        {\n            value: 'displayActivationLink',\n            name: translationService.instant('custom.user-management.display-activation-link')\n        },\n        {\n            value: 'sendActivationMail',\n            name: translationService.instant('custom.user-management.send-activation-email')\n        }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    userActivationMethod: ['displayActivationLink']\n  });\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    var customerId;\n/*    var authority = widgetContext.currentUser.authority;\n    var stateParams = widgetContext.stateController.getStateParams();*/\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n    vm.addUserFormGroup.markAsPristine();\n/*    console.log(\"Customer ID: \" + customerId);\n    console.log(\"Authority: \" + authority);\n    console.log(\"State Params: \" + JSON.stringify(stateParams));*/\n    \n    const formValues = vm.addUserFormGroup.value;\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n    const sendActivationMail = (formValues.userActivationMethod === 'sendActivationMail');\n    \n    widgetContext.rxjs.forkJoin([\n        getTargetUserGroup(customerId), \n        getDashboardByName('Smart Diagnostics')\n    ]).pipe(\n        widgetContext.rxjs.switchMap((data) => {\n            var userGroup = data[0];\n            var defaultDashboard = data[1];\n            /*console.log(defaultDashboard);*/\n            if (defaultDashboard) {\n                user.additionalInfo = {\n                    defaultDashboardId: defaultDashboard.id.id,\n                    defaultDashboardFullscreen: true\n                };\n            }\n            /*console.log(\"user\", user);*/\n            return saveUserObservable(userGroup, user, sendActivationMail);\n        }),\n        // Added switchMap to save the 'role' attribute after the user is saved\n        widgetContext.rxjs.switchMap((savedUser) => {\n            // Define the attribute to be saved\n            const roleAttribute = {\n                key: 'role',\n                value: 'Belimo Retrofit Users'\n            };\n            \n            // Call the attributeService to save the attribute\n            return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n                // Pass the savedUser to the next operator\n                widgetContext.rxjs.map(() => savedUser)\n            );\n        })\n    ).subscribe((user) => {\n        widgetContext.updateAliases();\n        if (formValues.userActivationMethod === 'displayActivationLink') {\n            userService.getActivationLink(user.id.id).subscribe(\n                (activationLink) => {\n                    displayActivationLink(activationLink).subscribe(\n                        () => {\n                            vm.dialogRef.close(null);\n                        }\n                    );\n                }\n            );\n        } else {\n            vm.dialogRef.close(null);\n        }\n    });\n  };\n  \n  function saveUserObservable(userGroup, user, sendActivationMail) {\n      return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n  \n  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Users', customerId);\n          })\n      );\n  }\n  \n/*  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerAndType(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Users', customerId);\n          })\n      );\n  }*/\n  \n  function getOrCreateUserGroup(groups, groupName, customerId) {\n      var usersGroup = groups.find(group => group.name === groupName);\n      if (usersGroup) {\n          return widgetContext.rxjs.of(usersGroup);\n      } else {\n          usersGroup = {\n              type: 'USER',\n              name: groupName,\n              ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(usersGroup);\n      }\n  }\n  \n  function getDashboardByName(dashboardName) {\n      var dashboardsPageLink = widgetContext.pageLink(100, 0, dashboardName);\n      return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n          widgetContext.rxjs.map((data) => {\n            if (data.data.length) {\n                return data.data.find((dashboard) => dashboard.name === dashboardName);\n            } else {\n                return null;\n            }\n          })\n      );\n  }\n  \n    function displayActivationLink(activationLink) {\n        const template = '<form style=\"min-width: 400px;\">\\n' +\n            '  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\\n' +\n            '    <h2 translate>user.activation-link</h2>\\n' +\n            '        <span class=\"flex-1\"></span>\\n' +\n            '    <button mat-icon-button\\n' +\n            '            (click)=\"close()\"\\n' +\n            '            type=\"button\">\\n' +\n            '      <mat-icon class=\"material-icons\">close</mat-icon>\\n' +\n            '    </button>\\n' +\n            '  </mat-toolbar>\\n' +\n            '  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\\n' +\n            '  </mat-progress-bar>\\n' +\n            '  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\\n' +\n            '  <div mat-dialog-content tb-toast toastTarget=\"activationLinkDialogContent\">\\n' +\n            '    <div class=\"flex flex-col gap-0 sm:gap-2\">\\n' +\n            '      <span [innerHTML]=\"\\'user.activation-link-text\\' | translate: {activationLink: activationLink}\"></span>\\n' +\n            '      <div class=\"flex justify-center items-center\">\\n' +\n            '        <pre class=\"tb-highlight\" class=\"flex\"><code>{{ activationLink }}</code></pre>\\n' +\n            '        <button mat-icon-button\\n' +\n            '                color=\"primary\"\\n' +\n            '                ngxClipboard\\n' +\n            '                cbContent=\"{{ activationLink }}\"\\n' +\n            '                (cbOnSuccess)=\"onActivationLinkCopied()\"\\n' +\n            '                matTooltip=\"{{ \\'user.copy-activation-link\\' | translate }}\"\\n' +\n            '                matTooltipPosition=\"above\">\\n' +\n            '          <mat-icon svgIcon=\"mdi:clipboard-arrow-left\"></mat-icon>\\n' +\n            '        </button>\\n' +\n            '      </div>\\n' +\n            '    </div>\\n' +\n            '  </div>\\n' +\n            '  <div mat-dialog-actions class=\"flex justify-end gap-2\">\\n' +\n            '    <button mat-button color=\"primary\"\\n' +\n            '            type=\"button\"\\n' +\n            '            cdkFocusInitial\\n' +\n            '            [disabled]=\"(isLoading$ | async)\"\\n' +\n            '            (click)=\"close()\">\\n' +\n            '      {{ \\'action.ok\\' | translate }}\\n' +\n            '    </button>\\n' +\n            '  </div>\\n' +\n            '</form>';\n        return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink});\n    }\n\n    function ActivationLinkDialogController(instance) {\n        var vm = instance;\n\n        vm.activationLink = instance.data.activationLink;\n\n        vm.onActivationLinkCopied = onActivationLinkCopied;\n        vm.close = close;\n\n        function onActivationLinkCopied(){\n            widgetContext.showSuccessToast(translate.instant('user.activation-link-copied-message'), 1000, 'bottom', 'left', 'activationLinkDialogContent');\n        }\n\n        function close() {\n            vm.dialogRef.close(null);\n        }\n    }\n  \n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "c12ec825-a7ef-cc4d-da3d-064fba7cc7d7",
        "typeFullFqn": "system.cards.entities_table"
      },
      "b687c65c-76de-dd49-b3b9-51eacf22114c": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1694019264779,
                "endTimeMs": 1694105664779
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Administrators",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "email",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Administrators",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "1cab31a1-6ad5-e39d-7798-e0dfee1cd61c",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "Email",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5669544029828533
                },
                {
                  "name": "firstName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.first-name}",
                  "color": "#4caf50",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.835575628975763,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.last-name}",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7276117794959098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [],
            "actionCellButton": [
              {
                "name": "{i18n:custom.user-management.edit-user}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editUserFormGroup\"\n      (ngSubmit)=\"save()\"  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n     <h2 class=\"text-lg font-semibold\">{{'custom.user-management.edit-smart-retail-administrator' | translate}}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('required')\">\n            {{'custom.user-management.email-is-required' | translate}}\n        </mat-error>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('pattern')\">\n            {{'custom.user-management.invalid-value-format' | translate}}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.first-name' | translate}}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.last-name' | translate}}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{'action.cancel' | translate}}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editUserFormGroup.invalid || !editUserFormGroup.dirty\">\n      {{'custom.user-management.save-user' | translate}}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\n\nopenEditUserDialog();\n\nfunction openEditUserDialog() {\n  customDialog.customDialog(htmlTemplate, EditUserDialogController).subscribe();\n}\n\nfunction EditUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.user = {};\n  \n  vm.editUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null]\n  });\n  \n  getUser();\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    vm.editUserFormGroup.markAsPristine();\n    saveUserObservable().subscribe(\n      function () {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      }\n    );\n  };\n  \n  function getUser() {\n      userService.getUser(entityId.id).subscribe(\n          (user) => {\n                vm.user = user;          \n                vm.editUserFormGroup.patchValue({\n                  email: vm.user.email,\n                  firstName: vm.user.firstName,\n                  lastName: vm.user.lastName\n                }, {emitEvent: false});\n          }\n    );\n  }\n  \n  function saveUserObservable() {\n      const formValues = vm.editUserFormGroup.value;\n      vm.user.email = formValues.email;\n      vm.user.firstName = formValues.firstName;\n      vm.user.lastName = formValues.lastName;\n      return userService.saveUser(vm.user);\n  }\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.user-management.delete-user}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteUserDialog();\n\nfunction openDeleteUserDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.user-management.delete.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.user-management.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteUser();\n    }\n  });\n}\n\nfunction deleteUser() {\n  userService.deleteUser(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.user-management.add-administrator}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addUserFormGroup\"\n      (ngSubmit)=\"save()\"  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.user-management.add-smart-retail-administrator' | translate }}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n            {{ 'custom.user-management.email-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n            {{ 'custom.user-management.invalid-value-format' | translate }}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.first-name' | translate }}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.last-name' | translate }}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>{{ 'custom.user-management.activation-method' | translate }}</mat-label>\n        <mat-select formControlName=\"userActivationMethod\">\n            <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n                {{ method.name }}\n            </mat-option>\n        </mat-select>\n    </mat-form-field>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      {{ 'custom.user-management.add-user' | translate }}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.activationMethods = [\n        {\n            value: 'displayActivationLink',\n            name: translationService.instant('custom.user-management.display-activation-link')\n        },\n        {\n            value: 'sendActivationMail',\n            name: translationService.instant('custom.user-management.send-activation-email')\n        }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    userActivationMethod: ['displayActivationLink']\n  });\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    var customerId;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n    vm.addUserFormGroup.markAsPristine();\n    \n    const formValues = vm.addUserFormGroup.value;\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n    const sendActivationMail = (formValues.userActivationMethod === 'sendActivationMail');\n    \n    widgetContext.rxjs.forkJoin([\n        getTargetUserGroup(customerId), \n        getDashboardByName('Smart Diagnostic Administration')\n    ]).pipe(\n        widgetContext.rxjs.switchMap((data) => {\n            /*console.log(data[1]);*/\n            var userGroup = data[0];\n            var defaultDashboard = data[1];\n            if (defaultDashboard) {\n                user.additionalInfo = {\n                    defaultDashboardId: defaultDashboard.id.id,\n                    defaultDashboardFullscreen: true\n                };\n            }\n            /*console.log(\"user\", user);*/\n            return saveUserObservable(userGroup, user, sendActivationMail);\n        }),\n        // Added switchMap to save the 'role' attribute after the user is saved\n        widgetContext.rxjs.switchMap((savedUser) => {\n            // Define the attribute to be saved\n            const roleAttribute = {\n                key: 'role',\n                value: 'Belimo Retrofit Administrators'\n            };\n            \n            // Call the attributeService to save the attribute\n            return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n                // Pass the savedUser to the next operator\n                widgetContext.rxjs.map(() => savedUser)\n            );\n        })\n    ).subscribe((user) => {\n        widgetContext.updateAliases();\n        if (formValues.userActivationMethod === 'displayActivationLink') {\n            userService.getActivationLink(user.id.id).subscribe(\n                (activationLink) => {\n                    displayActivationLink(activationLink).subscribe(\n                        () => {\n                            vm.dialogRef.close(null);\n                        }\n                    );\n                }\n            );\n        } else {\n            vm.dialogRef.close(null);\n        }\n    });\n  };\n  \n  function saveUserObservable(userGroup, user, sendActivationMail) {\n      return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n  \n  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Administrators', customerId);\n          })\n      );\n  }\n  \n  function getOrCreateUserGroup(groups, groupName, customerId) {\n      var usersGroup = groups.find(group => group.name === groupName);\n      if (usersGroup) {\n          return widgetContext.rxjs.of(usersGroup);\n      } else {\n          usersGroup = {\n              type: 'USER',\n              name: groupName,\n              ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(usersGroup);\n      }\n  }\n  \n  function getDashboardByName(dashboardName) {\n      var dashboardsPageLink = widgetContext.pageLink(10, 0, dashboardName);\n      return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n          widgetContext.rxjs.map((data) => {\n            if (data.data.length) {\n                return data.data.find((dashboard) => dashboard.name === dashboardName);\n            } else {\n                return null;\n            }\n          })\n      );\n  }\n  \n    function displayActivationLink(activationLink) {\n        const template = '<form style=\"min-width: 400px;\">\\n' +\n            '  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\\n' +\n            '    <h2 translate>user.activation-link</h2>\\n' +\n            '        <span class=\"flex-1\"></span>\\n' +\n            '    <button mat-icon-button\\n' +\n            '            (click)=\"close()\"\\n' +\n            '            type=\"button\">\\n' +\n            '      <mat-icon class=\"material-icons\">close</mat-icon>\\n' +\n            '    </button>\\n' +\n            '  </mat-toolbar>\\n' +\n            '  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\\n' +\n            '  </mat-progress-bar>\\n' +\n            '  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\\n' +\n            '  <div mat-dialog-content tb-toast toastTarget=\"activationLinkDialogContent\">\\n' +\n            '    <div class=\"flex flex-col gap-0 sm:gap-2\">\\n' +\n            '      <span [innerHTML]=\"\\'user.activation-link-text\\' | translate: {activationLink: activationLink}\"></span>\\n' +\n            '      <div class=\"flex justify-center items-center\">\\n' +\n            '        <pre class=\"tb-highlight\" class=\"flex\"><code>{{ activationLink }}</code></pre>\\n' +\n            '        <button mat-icon-button\\n' +\n            '                color=\"primary\"\\n' +\n            '                ngxClipboard\\n' +\n            '                cbContent=\"{{ activationLink }}\"\\n' +\n            '                (cbOnSuccess)=\"onActivationLinkCopied()\"\\n' +\n            '                matTooltip=\"{{ \\'user.copy-activation-link\\' | translate }}\"\\n' +\n            '                matTooltipPosition=\"above\">\\n' +\n            '          <mat-icon svgIcon=\"mdi:clipboard-arrow-left\"></mat-icon>\\n' +\n            '        </button>\\n' +\n            '      </div>\\n' +\n            '    </div>\\n' +\n            '  </div>\\n' +\n            '  <div mat-dialog-actions class=\"flex justify-end gap-2\">\\n' +\n            '    <button mat-button color=\"primary\"\\n' +\n            '            type=\"button\"\\n' +\n            '            cdkFocusInitial\\n' +\n            '            [disabled]=\"(isLoading$ | async)\"\\n' +\n            '            (click)=\"close()\">\\n' +\n            '      {{ \\'action.ok\\' | translate }}\\n' +\n            '    </button>\\n' +\n            '  </div>\\n' +\n            '</form>';\n        return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink});\n    }\n\n    function ActivationLinkDialogController(instance) {\n        var vm = instance;\n\n        vm.activationLink = instance.data.activationLink;\n\n        vm.onActivationLinkCopied = onActivationLinkCopied;\n        vm.close = close;\n\n        function onActivationLinkCopied(){\n            widgetContext.showSuccessToast(translate.instant('user.activation-link-copied-message'), 1000, 'bottom', 'left', 'activationLinkDialogContent');\n        }\n\n        function close() {\n            vm.dialogRef.close(null);\n        }\n    }\n  \n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "b687c65c-76de-dd49-b3b9-51eacf22114c",
        "typeFullFqn": "system.cards.entities_table"
      },
      "8a5a3b08-5990-7d43-feca-892f176bff4c": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1694019264779,
                "endTimeMs": 1694105664779
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Engineer",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "email",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Engineers",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "4128d7f0-9e28-5c7d-cf9a-b43cfe893568",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "Email",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5669544029828533
                },
                {
                  "name": "firstName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.first-name}",
                  "color": "#4caf50",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.835575628975763,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.last-name}",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7276117794959098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [],
            "actionCellButton": [
              {
                "name": "{i18n:custom.user-management.edit-user}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editUserFormGroup\"\n      (ngSubmit)=\"save()\"   class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{'custom.user-management.edit-smart-retail-engineer' | translate}}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('required')\">\n            {{'custom.user-management.email-is-required' | translate}}\n        </mat-error>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('pattern')\">\n            {{'custom.user-management.invalid-value-format' | translate}}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.first-name' | translate}}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.last-name' | translate}}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{'action.cancel' | translate}}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editUserFormGroup.invalid || !editUserFormGroup.dirty\">\n      {{'custom.user-management.save-user' | translate}}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\n\nopenEditUserDialog();\n\nfunction openEditUserDialog() {\n  customDialog.customDialog(htmlTemplate, EditUserDialogController).subscribe();\n}\n\nfunction EditUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.user = {};\n  \n  vm.editUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null]\n  });\n  \n  getUser();\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    vm.editUserFormGroup.markAsPristine();\n    saveUserObservable().subscribe(\n      function () {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      }\n    );\n  };\n  \n  function getUser() {\n      userService.getUser(entityId.id).subscribe(\n          (user) => {\n                vm.user = user;          \n                vm.editUserFormGroup.patchValue({\n                  email: vm.user.email,\n                  firstName: vm.user.firstName,\n                  lastName: vm.user.lastName\n                }, {emitEvent: false});\n          }\n    );\n  }\n  \n  function saveUserObservable() {\n      const formValues = vm.editUserFormGroup.value;\n      vm.user.email = formValues.email;\n      vm.user.firstName = formValues.firstName;\n      vm.user.lastName = formValues.lastName;\n      return userService.saveUser(vm.user);\n  }\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.user-management.delete-user}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteUserDialog();\n\nfunction openDeleteUserDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.user-management.delete.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.user-management.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteUser();\n    }\n  });\n}\n\nfunction deleteUser() {\n  userService.deleteUser(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.user-management.add-engineer}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addUserFormGroup\"\n      (ngSubmit)=\"save()\"   class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{'custom.user-management.add-smart-retail-engineer' | translate}}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n            {{'custom.user-management.email-is-required' | translate}}\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n            {{'custom.user-management.invalid-value-format' | translate}}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.first-name' | translate}}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.last-name' | translate}}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>{{'custom.user-management.activation-method' | translate}}</mat-label>\n        <mat-select formControlName=\"userActivationMethod\">\n            <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n                {{ method.name }}\n            </mat-option>\n        </mat-select>\n    </mat-form-field>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{'action.cancel' | translate}}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      {{'custom.user-management.save-user' | translate}}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.activationMethods = [\n        {\n            value: 'displayActivationLink',\n            name: translationService.instant('custom.user-management.display-activation-link')\n        },\n        {\n            value: 'sendActivationMail',\n            name: translationService.instant('custom.user-management.send-activation-email')\n        }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    userActivationMethod: ['displayActivationLink']\n  });\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    var customerId;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n    vm.addUserFormGroup.markAsPristine();\n    \n    const formValues = vm.addUserFormGroup.value;\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n    const sendActivationMail = (formValues.userActivationMethod === 'sendActivationMail');\n    \n    widgetContext.rxjs.forkJoin([\n        getTargetUserGroup(customerId), \n        getDashboardByName('Smart Diagnostics')\n    ]).pipe(\n        widgetContext.rxjs.switchMap((data) => {\n            /*console.log(data[1]);*/\n            var userGroup = data[0];\n            var defaultDashboard = data[1];\n            if (defaultDashboard) {\n                user.additionalInfo = {\n                    defaultDashboardId: defaultDashboard.id.id,\n                    defaultDashboardFullscreen: true\n                };\n            }\n            /*console.log(\"user\", user);*/\n            return saveUserObservable(userGroup, user, sendActivationMail);\n        }),\n        // Added switchMap to save the 'role' attribute after the user is saved\n        widgetContext.rxjs.switchMap((savedUser) => {\n            // Define the attribute to be saved\n            const roleAttribute = {\n                key: 'role',\n                value: 'Belimo Retrofit Engineer'\n            };\n            \n            // Call the attributeService to save the attribute\n            return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n                // Pass the savedUser to the next operator\n                widgetContext.rxjs.map(() => savedUser)\n            );\n        })\n    ).subscribe((user) => {\n        widgetContext.updateAliases();\n        if (formValues.userActivationMethod === 'displayActivationLink') {\n            userService.getActivationLink(user.id.id).subscribe(\n                (activationLink) => {\n                    displayActivationLink(activationLink).subscribe(\n                        () => {\n                            vm.dialogRef.close(null);\n                        }\n                    );\n                }\n            );\n        } else {\n            vm.dialogRef.close(null);\n        }\n    });\n  };\n  \n  function saveUserObservable(userGroup, user, sendActivationMail) {\n      return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n  \n  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Engineer', customerId);\n          })\n      );\n  }\n  \n  function getOrCreateUserGroup(groups, groupName, customerId) {\n      var usersGroup = groups.find(group => group.name === groupName);\n      if (usersGroup) {\n          return widgetContext.rxjs.of(usersGroup);\n      } else {\n          usersGroup = {\n              type: 'USER',\n              name: groupName,\n              ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(usersGroup);\n      }\n  }\n  \n  function getDashboardByName(dashboardName) {\n      var dashboardsPageLink = widgetContext.pageLink(10, 0, dashboardName);\n      return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n          widgetContext.rxjs.map((data) => {\n            if (data.data.length) {\n                return data.data.find((dashboard) => dashboard.name === dashboardName);\n            } else {\n                return null;\n            }\n          })\n      );\n  }\n  \n    function displayActivationLink(activationLink) {\n        const template = '<form style=\"min-width: 400px;\">\\n' +\n            '  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\\n' +\n            '    <h2 translate>user.activation-link</h2>\\n' +\n            '        <span class=\"flex-1\"></span>\\n' +\n            '    <button mat-icon-button\\n' +\n            '            (click)=\"close()\"\\n' +\n            '            type=\"button\">\\n' +\n            '      <mat-icon class=\"material-icons\">close</mat-icon>\\n' +\n            '    </button>\\n' +\n            '  </mat-toolbar>\\n' +\n            '  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\\n' +\n            '  </mat-progress-bar>\\n' +\n            '  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\\n' +\n            '  <div mat-dialog-content tb-toast toastTarget=\"activationLinkDialogContent\">\\n' +\n            '    <div class=\"flex flex-col gap-0 sm:gap-2\">\\n' +\n            '      <span [innerHTML]=\"\\'user.activation-link-text\\' | translate: {activationLink: activationLink}\"></span>\\n' +\n            '      <div class=\"flex justify-center items-center\">\\n' +\n            '        <pre class=\"tb-highlight\" class=\"flex\"><code>{{ activationLink }}</code></pre>\\n' +\n            '        <button mat-icon-button\\n' +\n            '                color=\"primary\"\\n' +\n            '                ngxClipboard\\n' +\n            '                cbContent=\"{{ activationLink }}\"\\n' +\n            '                (cbOnSuccess)=\"onActivationLinkCopied()\"\\n' +\n            '                matTooltip=\"{{ \\'user.copy-activation-link\\' | translate }}\"\\n' +\n            '                matTooltipPosition=\"above\">\\n' +\n            '          <mat-icon svgIcon=\"mdi:clipboard-arrow-left\"></mat-icon>\\n' +\n            '        </button>\\n' +\n            '      </div>\\n' +\n            '    </div>\\n' +\n            '  </div>\\n' +\n            '  <div mat-dialog-actions class=\"flex justify-end gap-2\">\\n' +\n            '    <button mat-button color=\"primary\"\\n' +\n            '            type=\"button\"\\n' +\n            '            cdkFocusInitial\\n' +\n            '            [disabled]=\"(isLoading$ | async)\"\\n' +\n            '            (click)=\"close()\">\\n' +\n            '      {{ \\'action.ok\\' | translate }}\\n' +\n            '    </button>\\n' +\n            '  </div>\\n' +\n            '</form>';\n        return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink});\n    }\n\n    function ActivationLinkDialogController(instance) {\n        var vm = instance;\n\n        vm.activationLink = instance.data.activationLink;\n\n        vm.onActivationLinkCopied = onActivationLinkCopied;\n        vm.close = close;\n\n        function onActivationLinkCopied(){\n            widgetContext.showSuccessToast(translate.instant('user.activation-link-copied-message'), 1000, 'bottom', 'left', 'activationLinkDialogContent');\n        }\n\n        function close() {\n            vm.dialogRef.close(null);\n        }\n    }\n  \n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "8a5a3b08-5990-7d43-feca-892f176bff4c",
        "typeFullFqn": "system.cards.entities_table"
      },
      "4f27f5c7-75b2-c14a-821f-ae5786bf1323": {
        "typeFullFqn": "system.cards.markdown_card",
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "04917190-aea7-e407-e308-4598f1671a71",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1737447672095,
                "endTimeMs": 1737534072095
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": true,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ""
          },
          "title": "{i18n:custom.user-management.user-management}",
          "showTitleIcon": true,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "actions": {
            "headerButton": [
              {
                "name": "{i18n:action.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n/*params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten*/\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f9a94ea9-abbd-daa2-234c-959b21e21b65"
              }
            ]
          },
          "enableDataExport": false,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "titleFont": {
            "size": 22,
            "sizeUnit": "px",
            "family": "Roboto",
            "weight": "500",
            "style": "normal"
          },
          "titleIcon": ""
        },
        "row": 0,
        "col": 0,
        "id": "4f27f5c7-75b2-c14a-821f-ae5786bf1323"
      },
      "2131ced7-032b-7d7f-1c04-917bd7a89699": {
        "typeFullFqn": "system.cards.markdown_card",
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "2519c941-a1b9-45bd-9821-88acf22e10af",
              "dataKeys": [
                {
                  "name": "assignedTo",
                  "type": "attribute",
                  "label": "assignedTo",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.21981810512762745
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "b9cbe0a5-7efe-a173-4f8f-81c7c69ed24c",
              "dataKeys": [
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "progress",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.3833688932754432
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "a11b6c4c-e7f7-210b-79a7-2b5de01a5f87",
              "dataKeys": [
                {
                  "name": "role",
                  "type": "attribute",
                  "label": "role",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.5214076894341932
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1765453220664,
                "endTimeMs": 1765539620664
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "### Markdown/HTML card\n - **Current entity**: ${entityName}.\n - **Current value**: ${Temperature}.",
            "markdownTextFunction": "\n// Count entities from datasources using aliasName\n// aliasName \"All Diagnostic Kits\" -> Kits\n// aliasName \"All Projects\" -> Projects\n// aliasName \"All Users\" -> Users\n\nvar kitsTotal = 0, kitsAssigned = 0, kitsAvailable = 0;\nvar projectsTotal = 0, projectsPlanned = 0, projectsActive = 0, projectsFinished = 0, projectsAborted = 0;\nvar usersTotal = 0, usersAdmin = 0, usersEngineer = 0, usersUser = 0;\n\ndata.forEach(function(item) {\n  var alias = item.aliasName || '';\n\n  if (alias === 'All Diagnostic Kits') {\n    // Diagnostic Kits\n    kitsTotal++;\n    if (item.assignedTo && item.assignedTo !== 'None' && item.assignedTo !== '') {\n      kitsAssigned++;\n    } else {\n      kitsAvailable++;\n    }\n  } else if (alias === 'All Projects') {\n    // Projects\n    projectsTotal++;\n    var progress = item.progress || '';\n    if (progress === 'in preparation' || progress === 'planned') {\n      projectsPlanned++;\n    } else if (progress === 'active') {\n      projectsActive++;\n    } else if (progress === 'finished') {\n      projectsFinished++;\n    } else if (progress === 'aborted') {\n      projectsAborted++;\n    }\n  } else if (alias === 'All Users') {\n    // Users\n    usersTotal++;\n    var role = (item.role || '').toLowerCase();\n    if (role.includes('administrator')) {\n      usersAdmin++;\n    } else if (role.includes('engineer')) {\n      usersEngineer++;\n    } else {\n      usersUser++;\n    }\n  }\n});\n\nreturn `\n<div class=\"tile-container\">\n\n  <!-- Diagnostic Kits -->\n  <div class=\"slider-card kits\">\n    <div class=\"card-header\">\n      <mat-icon class=\"card-icon\">medical_services</mat-icon>\n      <h2 class=\"card-title\">Diagnostic Kits</h2>\n    </div>\n    <div class=\"card-stats\">\n      <div class=\"stat-total\">${kitsTotal}</div>\n      <div class=\"stat-breakdown\">\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot assigned\"></span>Assigned</span>\n          <span class=\"stat-value\">${kitsAssigned}</span>\n        </div>\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot available\"></span>Available</span>\n          <span class=\"stat-value\">${kitsAvailable}</span>\n        </div>\n      </div>\n    </div>\n    <div class=\"card-divider\"></div>\n    <div class=\"card-footer\">\n      <a id=\"btn-manage-kits\" class=\"card-button\" role=\"button\">\n        <mat-icon>arrow_forward</mat-icon>\n        Manage Kits\n      </a>\n    </div>\n  </div>\n\n  <!-- Projects -->\n  <div class=\"slider-card projects\">\n    <div class=\"card-header\">\n      <mat-icon class=\"card-icon\">folder_open</mat-icon>\n      <h2 class=\"card-title\">Projects</h2>\n    </div>\n    <div class=\"card-stats\">\n      <div class=\"stat-total\">${projectsTotal}</div>\n      <div class=\"stat-breakdown\">\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot planned\"></span>Planned</span>\n          <span class=\"stat-value\">${projectsPlanned}</span>\n        </div>\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot active\"></span>Active</span>\n          <span class=\"stat-value\">${projectsActive}</span>\n        </div>\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot finished\"></span>Finished</span>\n          <span class=\"stat-value\">${projectsFinished}</span>\n        </div>\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot aborted\"></span>Aborted</span>\n          <span class=\"stat-value\">${projectsAborted}</span>\n        </div>\n      </div>\n    </div>\n    <div class=\"card-divider\"></div>\n    <div class=\"card-footer\">\n      <a id=\"btn-manage-projects\" class=\"card-button\" role=\"button\">\n        <mat-icon>arrow_forward</mat-icon>\n        Manage Projects\n      </a>\n    </div>\n  </div>\n\n  <!-- Users -->\n  <div class=\"slider-card users\">\n    <div class=\"card-header\">\n      <mat-icon class=\"card-icon\">group</mat-icon>\n      <h2 class=\"card-title\">Users</h2>\n    </div>\n    <div class=\"card-stats\">\n      <div class=\"stat-total\">${usersTotal}</div>\n      <div class=\"stat-breakdown\">\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot admin\"></span>Administrators</span>\n          <span class=\"stat-value\">${usersAdmin}</span>\n        </div>\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot engineer\"></span>Engineers</span>\n          <span class=\"stat-value\">${usersEngineer}</span>\n        </div>\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot user\"></span>Users</span>\n          <span class=\"stat-value\">${usersUser}</span>\n        </div>\n      </div>\n    </div>\n    <div class=\"card-divider\"></div>\n    <div class=\"card-footer\">\n      <a id=\"btn-manage-users\" class=\"card-button\" role=\"button\">\n        <mat-icon>arrow_forward</mat-icon>\n        Manage Users\n      </a>\n    </div>\n  </div>\n\n</div>\n`;\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": "/* === Root === */\n:host {\n    display: block;\n    height: 100%;\n}\n\n/* === Container === */\n.tile-container {\n    display: flex;\n    gap: 2rem;\n    width: 100%;\n    height: 100%;\n    justify-content: center;\n    align-items: stretch;\n    box-sizing: border-box;\n    padding: 1.5rem;\n}\n\n/* === Card === */\n.slider-card {\n    background: linear-gradient(135deg, var(--card-color) 0%, var(--card-color-dark) 100%);\n    border-radius: 12px;\n    display: flex;\n    flex-direction: column;\n    width: 100%;\n    max-width: 340px;\n    min-height: 280px;\n    padding: 1.5rem 1.75rem;\n    position: relative;\n    transition: transform 0.2s ease, box-shadow 0.2s ease;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n}\n\n.slider-card:hover {\n    transform: translateY(-4px);\n    box-shadow: 0 8px 24px rgba(0,0,0,0.15);\n}\n\n/* Card Colors */\n.slider-card.kits {\n    --card-color: #3a6a9e;\n    --card-color-dark: #2c5278;\n}\n.slider-card.projects {\n    --card-color: #26a69a;\n    --card-color-dark: #00897b;\n}\n.slider-card.users {\n    --card-color: #9c27b0;\n    --card-color-dark: #7b1fa2;\n}\n\n/* === Header === */\n.card-header {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n    margin-bottom: 1.25rem;\n}\n\n.card-icon {\n    font-size: 2.5rem !important;\n    width: 2.5rem !important;\n    height: 2.5rem !important;\n    color: rgba(255,255,255,0.9);\n}\n\n.card-title {\n    font-size: 1.1rem;\n    font-weight: 600;\n    color: #ffffff;\n    margin: 0;\n    letter-spacing: 0.02em;\n}\n\n/* === Stats === */\n.card-stats {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n}\n\n.stat-total {\n    font-size: 3.5rem;\n    font-weight: 700;\n    color: #ffffff;\n    line-height: 1;\n    margin-bottom: 1.25rem;\n}\n\n.stat-breakdown {\n    display: flex;\n    flex-direction: column;\n    gap: 0.6rem;\n}\n\n.stat-row {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    font-size: 0.9rem;\n    color: rgba(255,255,255,0.9);\n}\n\n.stat-label {\n    display: flex;\n    align-items: center;\n    gap: 0.6rem;\n}\n\n/* ECO Colors for stat dots */\n.stat-dot {\n    width: 10px;\n    height: 10px;\n    border-radius: 50%;\n    background-color: rgba(255,255,255,0.5);\n}\n\n/* Diagnostic Kits */\n.stat-dot.assigned { background-color: #EB5757; }  /* red */\n.stat-dot.available { background-color: #27AE60; } /* green */\n\n/* Projects */\n.stat-dot.planned { background-color: #F2994A; }   /* orange */\n.stat-dot.active { background-color: #27AE60; }    /* green */\n.stat-dot.finished { background-color: #2F80ED; }  /* blue */\n\n/* Users */\n.stat-dot.admin { background-color: #EB5757; }     /* red */\n.stat-dot.engineer { background-color: #2F80ED; }  /* blue */\n.stat-dot.user { background-color: #27AE60; }      /* green */\n\n.stat-value {\n    font-weight: 600;\n    font-size: 0.95rem;\n}\n\n/* === Divider === */\n.card-divider {\n    width: 100%;\n    height: 1px;\n    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);\n    margin: 1.25rem 0;\n}\n\n/* === Footer === */\n.card-footer {\n    margin-top: auto;\n}\n\n.card-button {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.7rem 1.4rem;\n    background: rgba(255,255,255,0.15);\n    border: 1px solid rgba(255,255,255,0.4);\n    border-radius: 6px;\n    color: #ffffff;\n    font-size: 0.875rem;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    text-decoration: none;\n}\n\n.card-button:hover {\n    background: rgba(255,255,255,0.95);\n    color: var(--card-color-dark);\n    border-color: transparent;\n}\n\n.card-button mat-icon {\n    font-size: 18px !important;\n    width: 18px !important;\n    height: 18px !important;\n}\n\n/* === Responsive === */\n@media (max-width: 1100px) {\n    .tile-container {\n        flex-wrap: wrap;\n        gap: 1.5rem;\n    }\n    .slider-card {\n        flex: 1 1 calc(50% - 1rem);\n        max-width: unset;\n    }\n}\n\n@media (max-width: 700px) {\n    .tile-container {\n        padding: 1rem;\n    }\n    .slider-card {\n        flex: 1 1 100%;\n    }\n}\n\n/* Aborted - red color */\n.stat-dot.aborted { background-color: #EB5757; }  /* red */\n"
          },
          "title": "Customer Overview",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "actions": {
            "elementClick": [
              {
                "name": "btn-manage-kits",
                "icon": "arrow_forward",
                "type": "custom",
                "customFunction": "\nconst $injector = widgetContext.$scope.$injector;\nconst entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nconst rxjs = widgetContext.rxjs;\nconst forkJoin = rxjs.forkJoin;\nconst of = rxjs.of;\nconst map = rxjs.map;\nconst switchMap = rxjs.switchMap;\nconst catchError = rxjs.catchError;\n\n// Create pageLink correctly\nconst pageLink = widgetContext.pageLink(1, 0, null, null, null);\n\n// Get current user info\nconst currentUser = widgetContext.currentUser;\nconst isTenantAdmin = currentUser.authority === 'TENANT_ADMIN';\n\n// Get owner ID based on user type\nlet ownerId;\nif (isTenantAdmin) {\n    ownerId = { id: currentUser.tenantId, entityType: 'TENANT' };\n} else {\n    ownerId = { id: currentUser.customerId, entityType: 'CUSTOMER' };\n}\n\n// Helper: get entity count from group by name\nfunction getGroupCount(groups, groupName) {\n    const group = groups.find(g => g.name === groupName);\n    if (!group) {\n        return of(0);\n    }\n    // Use correct pageLink\n    return entityGroupService.getEntityGroupEntities(group.id.id, pageLink).pipe(\n        map(response => response.totalElements || 0),\n        catchError((err) => {\n            console.error('Error getting group count for ' + groupName, err);\n            return of(0);\n        })\n    );\n}\n\n// Fetch all ASSET groups for this owner\nentityGroupService.getEntityGroupsByOwnerId(ownerId.entityType, ownerId.id, 'ASSET').pipe(\n    switchMap((groups) => {\n        return forkJoin({\n            total: getGroupCount(groups, 'Diagnostickits'),\n            assigned: getGroupCount(groups, 'Assigned Diagnostic Kits'),\n            unassigned: getGroupCount(groups, 'Unassigned Diagnostic Kits')\n        });\n    }),\n    catchError((err) => {\n        console.error('Error fetching kit counts:', err);\n        return of({ total: 0, assigned: 0, unassigned: 0 });\n    })\n).subscribe(counts => {\n    const params = widgetContext.stateController.getStateParams();\n\n    // Add customer info for Customer Users\n    if (!isTenantAdmin) {\n        params.entityId = { id: currentUser.customerId, entityType: 'CUSTOMER' };\n        params.entityName = currentUser.customerTitle || '';\n        params.entityLabel = currentUser.customerTitle || '';\n    }\n\n    params.kitsTotal = counts.total;\n    params.kitsAssigned = counts.assigned;\n    params.kitsAvailable = counts.unassigned;\n    widgetContext.stateController.openState('manage_diagnostickits', params);\n});\n",
                "id": "act-manage-kits"
              },
              {
                "name": "btn-manage-projects",
                "icon": "arrow_forward",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "act-manage-projects",
                "customFunction": "\n// Get current user info\nconst currentUser = widgetContext.currentUser;\nconst customerId = currentUser.customerId;\n\n// Build stateParams with customer info\nconst params = widgetContext.stateController.getStateParams();\nparams.entityId = { id: customerId, entityType: 'CUSTOMER' };\nparams.entityName = currentUser.customerTitle || '';\nparams.entityLabel = currentUser.customerTitle || '';\n\n// Open manage_projects state with customer context\nwidgetContext.stateController.openState('manage_projects', params);\n"
              },
              {
                "name": "btn-manage-users",
                "icon": "arrow_forward",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "manage_users",
                "setEntityId": false,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "act-manage-users"
              }
            ]
          },
          "enableDataExport": false,
          "borderRadius": "8px",
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": ""
        },
        "row": 0,
        "col": 0,
        "id": "2131ced7-032b-7d7f-1c04-917bd7a89699"
      },
      "66d379dd-2e7b-4977-7e01-d183cac74835": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1694019264779,
                "endTimeMs": 1694105664779
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Users",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "email",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Users",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "fbfce281-668f-0ad0-d8f4-6870d3ef679f",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "Email",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5669544029828533
                },
                {
                  "name": "firstName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.first-name}",
                  "color": "#4caf50",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.835575628975763,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.last-name}",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7276117794959098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [],
            "actionCellButton": [
              {
                "name": "{i18n:custom.user-management.edit-user}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editUserFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.user-management.edit-smart-retail-user' | translate }}</h2>\n     <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('required')\">\n            {{ 'custom.user-management.email-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('pattern')\">\n            {{ 'custom.user-management.invalid-value-format' | translate }}\n        </mat-error>\n    </mat-form-field>\n    <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.first-name' | translate }}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.last-name' | translate }}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editUserFormGroup.invalid || !editUserFormGroup.dirty\">\n      {{ 'custom.user-management.save-user' | translate }}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\n\nopenEditUserDialog();\n\nfunction openEditUserDialog() {\n  customDialog.customDialog(htmlTemplate, EditUserDialogController).subscribe();\n}\n\nfunction EditUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.user = {};\n  \n  vm.editUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null]\n  });\n  \n  getUser();\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    vm.editUserFormGroup.markAsPristine();\n    saveUserObservable().subscribe(\n      function () {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      }\n    );\n  };\n  \n  function getUser() {\n      userService.getUser(entityId.id).subscribe(\n          (user) => {\n                vm.user = user;          \n                vm.editUserFormGroup.patchValue({\n                  email: vm.user.email,\n                  firstName: vm.user.firstName,\n                  lastName: vm.user.lastName\n                }, {emitEvent: false});\n          }\n    );\n  }\n  \n  function saveUserObservable() {\n      const formValues = vm.editUserFormGroup.value;\n      vm.user.email = formValues.email;\n      vm.user.firstName = formValues.firstName;\n      vm.user.lastName = formValues.lastName;\n      return userService.saveUser(vm.user);\n  }\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.user-management.delete-user}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteUserDialog();\n\nfunction openDeleteUserDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.user-management.delete.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.user-management.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteUser();\n    }\n  });\n}\n\n\nfunction deleteUser() {\n  userService.deleteUser(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.user-management.add-user}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addUserFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.user-management.add-smart-retail-user' | translate }}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n            {{ 'custom.user-management.email-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n            {{ 'custom.user-management.invalid-value-format' | translate }}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.first-name' | translate }}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.last-name' | translate }}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>{{ 'custom.user-management.activation-method' | translate }}</mat-label>\n        <mat-select formControlName=\"userActivationMethod\">\n            <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n                {{ method.name }}\n            </mat-option>\n        </mat-select>\n    </mat-form-field>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      {{ 'custom.user-management.add-user' | translate }}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.activationMethods = [\n        {\n            value: 'displayActivationLink',\n            name: translationService.instant('custom.user-management.display-activation-link')\n        },\n        {\n            value: 'sendActivationMail',\n            name: translationService.instant('custom.user-management.send-activation-email')\n        }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    userActivationMethod: ['displayActivationLink']\n  });\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    var customerId;\n/*    var authority = widgetContext.currentUser.authority;\n    var stateParams = widgetContext.stateController.getStateParams();*/\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n    vm.addUserFormGroup.markAsPristine();\n/*    console.log(\"Customer ID: \" + customerId);\n    console.log(\"Authority: \" + authority);\n    console.log(\"State Params: \" + JSON.stringify(stateParams));*/\n    \n    const formValues = vm.addUserFormGroup.value;\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n    const sendActivationMail = (formValues.userActivationMethod === 'sendActivationMail');\n    \n    widgetContext.rxjs.forkJoin([\n        getTargetUserGroup(customerId), \n        getDashboardByName('Smart Diagnostics')\n    ]).pipe(\n        widgetContext.rxjs.switchMap((data) => {\n            var userGroup = data[0];\n            var defaultDashboard = data[1];\n            /*console.log(defaultDashboard);*/\n            if (defaultDashboard) {\n                user.additionalInfo = {\n                    defaultDashboardId: defaultDashboard.id.id,\n                    defaultDashboardFullscreen: true\n                };\n            }\n            /*console.log(\"user\", user);*/\n            return saveUserObservable(userGroup, user, sendActivationMail);\n        }),\n        // Added switchMap to save the 'role' attribute after the user is saved\n        widgetContext.rxjs.switchMap((savedUser) => {\n            // Define the attribute to be saved\n            const roleAttribute = {\n                key: 'role',\n                value: 'Belimo Retrofit Users'\n            };\n            \n            // Call the attributeService to save the attribute\n            return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n                // Pass the savedUser to the next operator\n                widgetContext.rxjs.map(() => savedUser)\n            );\n        })\n    ).subscribe((user) => {\n        widgetContext.updateAliases();\n        if (formValues.userActivationMethod === 'displayActivationLink') {\n            userService.getActivationLink(user.id.id).subscribe(\n                (activationLink) => {\n                    displayActivationLink(activationLink).subscribe(\n                        () => {\n                            vm.dialogRef.close(null);\n                        }\n                    );\n                }\n            );\n        } else {\n            vm.dialogRef.close(null);\n        }\n    });\n  };\n  \n  function saveUserObservable(userGroup, user, sendActivationMail) {\n      return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n  \n  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Users', customerId);\n          })\n      );\n  }\n  \n/*  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerAndType(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Users', customerId);\n          })\n      );\n  }*/\n  \n  function getOrCreateUserGroup(groups, groupName, customerId) {\n      var usersGroup = groups.find(group => group.name === groupName);\n      if (usersGroup) {\n          return widgetContext.rxjs.of(usersGroup);\n      } else {\n          usersGroup = {\n              type: 'USER',\n              name: groupName,\n              ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(usersGroup);\n      }\n  }\n  \n  function getDashboardByName(dashboardName) {\n      var dashboardsPageLink = widgetContext.pageLink(100, 0, dashboardName);\n      return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n          widgetContext.rxjs.map((data) => {\n            if (data.data.length) {\n                return data.data.find((dashboard) => dashboard.name === dashboardName);\n            } else {\n                return null;\n            }\n          })\n      );\n  }\n  \n    function displayActivationLink(activationLink) {\n        const template = '<form style=\"min-width: 400px;\">\\n' +\n            '  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\\n' +\n            '    <h2 translate>user.activation-link</h2>\\n' +\n            '        <span class=\"flex-1\"></span>\\n' +\n            '    <button mat-icon-button\\n' +\n            '            (click)=\"close()\"\\n' +\n            '            type=\"button\">\\n' +\n            '      <mat-icon class=\"material-icons\">close</mat-icon>\\n' +\n            '    </button>\\n' +\n            '  </mat-toolbar>\\n' +\n            '  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\\n' +\n            '  </mat-progress-bar>\\n' +\n            '  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\\n' +\n            '  <div mat-dialog-content tb-toast toastTarget=\"activationLinkDialogContent\">\\n' +\n            '    <div class=\"flex flex-col gap-0 sm:gap-2\">\\n' +\n            '      <span [innerHTML]=\"\\'user.activation-link-text\\' | translate: {activationLink: activationLink}\"></span>\\n' +\n            '      <div class=\"flex justify-center items-center\">\\n' +\n            '        <pre class=\"tb-highlight\" class=\"flex\"><code>{{ activationLink }}</code></pre>\\n' +\n            '        <button mat-icon-button\\n' +\n            '                color=\"primary\"\\n' +\n            '                ngxClipboard\\n' +\n            '                cbContent=\"{{ activationLink }}\"\\n' +\n            '                (cbOnSuccess)=\"onActivationLinkCopied()\"\\n' +\n            '                matTooltip=\"{{ \\'user.copy-activation-link\\' | translate }}\"\\n' +\n            '                matTooltipPosition=\"above\">\\n' +\n            '          <mat-icon svgIcon=\"mdi:clipboard-arrow-left\"></mat-icon>\\n' +\n            '        </button>\\n' +\n            '      </div>\\n' +\n            '    </div>\\n' +\n            '  </div>\\n' +\n            '  <div mat-dialog-actions class=\"flex justify-end gap-2\">\\n' +\n            '    <button mat-button color=\"primary\"\\n' +\n            '            type=\"button\"\\n' +\n            '            cdkFocusInitial\\n' +\n            '            [disabled]=\"(isLoading$ | async)\"\\n' +\n            '            (click)=\"close()\">\\n' +\n            '      {{ \\'action.ok\\' | translate }}\\n' +\n            '    </button>\\n' +\n            '  </div>\\n' +\n            '</form>';\n        return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink});\n    }\n\n    function ActivationLinkDialogController(instance) {\n        var vm = instance;\n\n        vm.activationLink = instance.data.activationLink;\n\n        vm.onActivationLinkCopied = onActivationLinkCopied;\n        vm.close = close;\n\n        function onActivationLinkCopied(){\n            widgetContext.showSuccessToast(translate.instant('user.activation-link-copied-message'), 1000, 'bottom', 'left', 'activationLinkDialogContent');\n        }\n\n        function close() {\n            vm.dialogRef.close(null);\n        }\n    }\n  \n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "66d379dd-2e7b-4977-7e01-d183cac74835",
        "typeFullFqn": "system.cards.entities_table"
      },
      "244b2e44-0ee2-0751-5a29-0d9eaebe24ab": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1694019264779,
                "endTimeMs": 1694105664779
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Administrators",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "email",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Administrators",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "1cab31a1-6ad5-e39d-7798-e0dfee1cd61c",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "Email",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5669544029828533
                },
                {
                  "name": "firstName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.first-name}",
                  "color": "#4caf50",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.835575628975763,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.last-name}",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7276117794959098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [],
            "actionCellButton": [
              {
                "name": "{i18n:custom.user-management.edit-user}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editUserFormGroup\"\n      (ngSubmit)=\"save()\"  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n     <h2 class=\"text-lg font-semibold\">{{'custom.user-management.edit-smart-retail-administrator' | translate}}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('required')\">\n            {{'custom.user-management.email-is-required' | translate}}\n        </mat-error>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('pattern')\">\n            {{'custom.user-management.invalid-value-format' | translate}}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.first-name' | translate}}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.last-name' | translate}}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{'action.cancel' | translate}}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editUserFormGroup.invalid || !editUserFormGroup.dirty\">\n      {{'custom.user-management.save-user' | translate}}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\n\nopenEditUserDialog();\n\nfunction openEditUserDialog() {\n  customDialog.customDialog(htmlTemplate, EditUserDialogController).subscribe();\n}\n\nfunction EditUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.user = {};\n  \n  vm.editUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null]\n  });\n  \n  getUser();\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    vm.editUserFormGroup.markAsPristine();\n    saveUserObservable().subscribe(\n      function () {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      }\n    );\n  };\n  \n  function getUser() {\n      userService.getUser(entityId.id).subscribe(\n          (user) => {\n                vm.user = user;          \n                vm.editUserFormGroup.patchValue({\n                  email: vm.user.email,\n                  firstName: vm.user.firstName,\n                  lastName: vm.user.lastName\n                }, {emitEvent: false});\n          }\n    );\n  }\n  \n  function saveUserObservable() {\n      const formValues = vm.editUserFormGroup.value;\n      vm.user.email = formValues.email;\n      vm.user.firstName = formValues.firstName;\n      vm.user.lastName = formValues.lastName;\n      return userService.saveUser(vm.user);\n  }\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.user-management.delete-user}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteUserDialog();\n\nfunction openDeleteUserDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.user-management.delete.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.user-management.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteUser();\n    }\n  });\n}\n\nfunction deleteUser() {\n  userService.deleteUser(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.user-management.add-administrator}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addUserFormGroup\"\n      (ngSubmit)=\"save()\"  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.user-management.add-smart-retail-administrator' | translate }}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n            {{ 'custom.user-management.email-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n            {{ 'custom.user-management.invalid-value-format' | translate }}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.first-name' | translate }}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.last-name' | translate }}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>{{ 'custom.user-management.activation-method' | translate }}</mat-label>\n        <mat-select formControlName=\"userActivationMethod\">\n            <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n                {{ method.name }}\n            </mat-option>\n        </mat-select>\n    </mat-form-field>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      {{ 'custom.user-management.add-user' | translate }}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.activationMethods = [\n        {\n            value: 'displayActivationLink',\n            name: translationService.instant('custom.user-management.display-activation-link')\n        },\n        {\n            value: 'sendActivationMail',\n            name: translationService.instant('custom.user-management.send-activation-email')\n        }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    userActivationMethod: ['displayActivationLink']\n  });\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    var customerId;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n    vm.addUserFormGroup.markAsPristine();\n    \n    const formValues = vm.addUserFormGroup.value;\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n    const sendActivationMail = (formValues.userActivationMethod === 'sendActivationMail');\n    \n    widgetContext.rxjs.forkJoin([\n        getTargetUserGroup(customerId), \n        getDashboardByName('Smart Diagnostic Administration')\n    ]).pipe(\n        widgetContext.rxjs.switchMap((data) => {\n            /*console.log(data[1]);*/\n            var userGroup = data[0];\n            var defaultDashboard = data[1];\n            if (defaultDashboard) {\n                user.additionalInfo = {\n                    defaultDashboardId: defaultDashboard.id.id,\n                    defaultDashboardFullscreen: true\n                };\n            }\n            /*console.log(\"user\", user);*/\n            return saveUserObservable(userGroup, user, sendActivationMail);\n        }),\n        // Added switchMap to save the 'role' attribute after the user is saved\n        widgetContext.rxjs.switchMap((savedUser) => {\n            // Define the attribute to be saved\n            const roleAttribute = {\n                key: 'role',\n                value: 'Belimo Retrofit Administrators'\n            };\n            \n            // Call the attributeService to save the attribute\n            return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n                // Pass the savedUser to the next operator\n                widgetContext.rxjs.map(() => savedUser)\n            );\n        })\n    ).subscribe((user) => {\n        widgetContext.updateAliases();\n        if (formValues.userActivationMethod === 'displayActivationLink') {\n            userService.getActivationLink(user.id.id).subscribe(\n                (activationLink) => {\n                    displayActivationLink(activationLink).subscribe(\n                        () => {\n                            vm.dialogRef.close(null);\n                        }\n                    );\n                }\n            );\n        } else {\n            vm.dialogRef.close(null);\n        }\n    });\n  };\n  \n  function saveUserObservable(userGroup, user, sendActivationMail) {\n      return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n  \n  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Administrators', customerId);\n          })\n      );\n  }\n  \n  function getOrCreateUserGroup(groups, groupName, customerId) {\n      var usersGroup = groups.find(group => group.name === groupName);\n      if (usersGroup) {\n          return widgetContext.rxjs.of(usersGroup);\n      } else {\n          usersGroup = {\n              type: 'USER',\n              name: groupName,\n              ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(usersGroup);\n      }\n  }\n  \n  function getDashboardByName(dashboardName) {\n      var dashboardsPageLink = widgetContext.pageLink(10, 0, dashboardName);\n      return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n          widgetContext.rxjs.map((data) => {\n            if (data.data.length) {\n                return data.data.find((dashboard) => dashboard.name === dashboardName);\n            } else {\n                return null;\n            }\n          })\n      );\n  }\n  \n    function displayActivationLink(activationLink) {\n        const template = '<form style=\"min-width: 400px;\">\\n' +\n            '  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\\n' +\n            '    <h2 translate>user.activation-link</h2>\\n' +\n            '        <span class=\"flex-1\"></span>\\n' +\n            '    <button mat-icon-button\\n' +\n            '            (click)=\"close()\"\\n' +\n            '            type=\"button\">\\n' +\n            '      <mat-icon class=\"material-icons\">close</mat-icon>\\n' +\n            '    </button>\\n' +\n            '  </mat-toolbar>\\n' +\n            '  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\\n' +\n            '  </mat-progress-bar>\\n' +\n            '  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\\n' +\n            '  <div mat-dialog-content tb-toast toastTarget=\"activationLinkDialogContent\">\\n' +\n            '    <div class=\"flex flex-col gap-0 sm:gap-2\">\\n' +\n            '      <span [innerHTML]=\"\\'user.activation-link-text\\' | translate: {activationLink: activationLink}\"></span>\\n' +\n            '      <div class=\"flex justify-center items-center\">\\n' +\n            '        <pre class=\"tb-highlight\" class=\"flex\"><code>{{ activationLink }}</code></pre>\\n' +\n            '        <button mat-icon-button\\n' +\n            '                color=\"primary\"\\n' +\n            '                ngxClipboard\\n' +\n            '                cbContent=\"{{ activationLink }}\"\\n' +\n            '                (cbOnSuccess)=\"onActivationLinkCopied()\"\\n' +\n            '                matTooltip=\"{{ \\'user.copy-activation-link\\' | translate }}\"\\n' +\n            '                matTooltipPosition=\"above\">\\n' +\n            '          <mat-icon svgIcon=\"mdi:clipboard-arrow-left\"></mat-icon>\\n' +\n            '        </button>\\n' +\n            '      </div>\\n' +\n            '    </div>\\n' +\n            '  </div>\\n' +\n            '  <div mat-dialog-actions class=\"flex justify-end gap-2\">\\n' +\n            '    <button mat-button color=\"primary\"\\n' +\n            '            type=\"button\"\\n' +\n            '            cdkFocusInitial\\n' +\n            '            [disabled]=\"(isLoading$ | async)\"\\n' +\n            '            (click)=\"close()\">\\n' +\n            '      {{ \\'action.ok\\' | translate }}\\n' +\n            '    </button>\\n' +\n            '  </div>\\n' +\n            '</form>';\n        return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink});\n    }\n\n    function ActivationLinkDialogController(instance) {\n        var vm = instance;\n\n        vm.activationLink = instance.data.activationLink;\n\n        vm.onActivationLinkCopied = onActivationLinkCopied;\n        vm.close = close;\n\n        function onActivationLinkCopied(){\n            widgetContext.showSuccessToast(translate.instant('user.activation-link-copied-message'), 1000, 'bottom', 'left', 'activationLinkDialogContent');\n        }\n\n        function close() {\n            vm.dialogRef.close(null);\n        }\n    }\n  \n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "244b2e44-0ee2-0751-5a29-0d9eaebe24ab",
        "typeFullFqn": "system.cards.entities_table"
      },
      "4b84e1ab-9b9c-6173-ae5b-51a78fafe48c": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1694019264779,
                "endTimeMs": 1694105664779
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Engineer",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "email",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Engineers",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "4128d7f0-9e28-5c7d-cf9a-b43cfe893568",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "Email",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5669544029828533
                },
                {
                  "name": "firstName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.first-name}",
                  "color": "#4caf50",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.835575628975763,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.last-name}",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7276117794959098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [],
            "actionCellButton": [
              {
                "name": "{i18n:custom.user-management.edit-user}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editUserFormGroup\"\n      (ngSubmit)=\"save()\"   class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{'custom.user-management.edit-smart-retail-engineer' | translate}}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('required')\">\n            {{'custom.user-management.email-is-required' | translate}}\n        </mat-error>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('pattern')\">\n            {{'custom.user-management.invalid-value-format' | translate}}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.first-name' | translate}}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.last-name' | translate}}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{'action.cancel' | translate}}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editUserFormGroup.invalid || !editUserFormGroup.dirty\">\n      {{'custom.user-management.save-user' | translate}}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\n\nopenEditUserDialog();\n\nfunction openEditUserDialog() {\n  customDialog.customDialog(htmlTemplate, EditUserDialogController).subscribe();\n}\n\nfunction EditUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.user = {};\n  \n  vm.editUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null]\n  });\n  \n  getUser();\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    vm.editUserFormGroup.markAsPristine();\n    saveUserObservable().subscribe(\n      function () {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      }\n    );\n  };\n  \n  function getUser() {\n      userService.getUser(entityId.id).subscribe(\n          (user) => {\n                vm.user = user;          \n                vm.editUserFormGroup.patchValue({\n                  email: vm.user.email,\n                  firstName: vm.user.firstName,\n                  lastName: vm.user.lastName\n                }, {emitEvent: false});\n          }\n    );\n  }\n  \n  function saveUserObservable() {\n      const formValues = vm.editUserFormGroup.value;\n      vm.user.email = formValues.email;\n      vm.user.firstName = formValues.firstName;\n      vm.user.lastName = formValues.lastName;\n      return userService.saveUser(vm.user);\n  }\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.user-management.delete-user}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteUserDialog();\n\nfunction openDeleteUserDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.user-management.delete.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.user-management.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteUser();\n    }\n  });\n}\n\nfunction deleteUser() {\n  userService.deleteUser(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.user-management.add-engineer}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addUserFormGroup\"\n      (ngSubmit)=\"save()\"   class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{'custom.user-management.add-smart-retail-engineer' | translate}}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n            {{'custom.user-management.email-is-required' | translate}}\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n            {{'custom.user-management.invalid-value-format' | translate}}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.first-name' | translate}}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.last-name' | translate}}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>{{'custom.user-management.activation-method' | translate}}</mat-label>\n        <mat-select formControlName=\"userActivationMethod\">\n            <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n                {{ method.name }}\n            </mat-option>\n        </mat-select>\n    </mat-form-field>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{'action.cancel' | translate}}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      {{'custom.user-management.save-user' | translate}}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.activationMethods = [\n        {\n            value: 'displayActivationLink',\n            name: translationService.instant('custom.user-management.display-activation-link')\n        },\n        {\n            value: 'sendActivationMail',\n            name: translationService.instant('custom.user-management.send-activation-email')\n        }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    userActivationMethod: ['displayActivationLink']\n  });\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    var customerId;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n    vm.addUserFormGroup.markAsPristine();\n    \n    const formValues = vm.addUserFormGroup.value;\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n    const sendActivationMail = (formValues.userActivationMethod === 'sendActivationMail');\n    \n    widgetContext.rxjs.forkJoin([\n        getTargetUserGroup(customerId), \n        getDashboardByName('Smart Diagnostics')\n    ]).pipe(\n        widgetContext.rxjs.switchMap((data) => {\n            /*console.log(data[1]);*/\n            var userGroup = data[0];\n            var defaultDashboard = data[1];\n            if (defaultDashboard) {\n                user.additionalInfo = {\n                    defaultDashboardId: defaultDashboard.id.id,\n                    defaultDashboardFullscreen: true\n                };\n            }\n            /*console.log(\"user\", user);*/\n            return saveUserObservable(userGroup, user, sendActivationMail);\n        }),\n        // Added switchMap to save the 'role' attribute after the user is saved\n        widgetContext.rxjs.switchMap((savedUser) => {\n            // Define the attribute to be saved\n            const roleAttribute = {\n                key: 'role',\n                value: 'Belimo Retrofit Engineer'\n            };\n            \n            // Call the attributeService to save the attribute\n            return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n                // Pass the savedUser to the next operator\n                widgetContext.rxjs.map(() => savedUser)\n            );\n        })\n    ).subscribe((user) => {\n        widgetContext.updateAliases();\n        if (formValues.userActivationMethod === 'displayActivationLink') {\n            userService.getActivationLink(user.id.id).subscribe(\n                (activationLink) => {\n                    displayActivationLink(activationLink).subscribe(\n                        () => {\n                            vm.dialogRef.close(null);\n                        }\n                    );\n                }\n            );\n        } else {\n            vm.dialogRef.close(null);\n        }\n    });\n  };\n  \n  function saveUserObservable(userGroup, user, sendActivationMail) {\n      return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n  \n  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Engineer', customerId);\n          })\n      );\n  }\n  \n  function getOrCreateUserGroup(groups, groupName, customerId) {\n      var usersGroup = groups.find(group => group.name === groupName);\n      if (usersGroup) {\n          return widgetContext.rxjs.of(usersGroup);\n      } else {\n          usersGroup = {\n              type: 'USER',\n              name: groupName,\n              ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(usersGroup);\n      }\n  }\n  \n  function getDashboardByName(dashboardName) {\n      var dashboardsPageLink = widgetContext.pageLink(10, 0, dashboardName);\n      return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n          widgetContext.rxjs.map((data) => {\n            if (data.data.length) {\n                return data.data.find((dashboard) => dashboard.name === dashboardName);\n            } else {\n                return null;\n            }\n          })\n      );\n  }\n  \n    function displayActivationLink(activationLink) {\n        const template = '<form style=\"min-width: 400px;\">\\n' +\n            '  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\\n' +\n            '    <h2 translate>user.activation-link</h2>\\n' +\n            '        <span class=\"flex-1\"></span>\\n' +\n            '    <button mat-icon-button\\n' +\n            '            (click)=\"close()\"\\n' +\n            '            type=\"button\">\\n' +\n            '      <mat-icon class=\"material-icons\">close</mat-icon>\\n' +\n            '    </button>\\n' +\n            '  </mat-toolbar>\\n' +\n            '  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\\n' +\n            '  </mat-progress-bar>\\n' +\n            '  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\\n' +\n            '  <div mat-dialog-content tb-toast toastTarget=\"activationLinkDialogContent\">\\n' +\n            '    <div class=\"flex flex-col gap-0 sm:gap-2\">\\n' +\n            '      <span [innerHTML]=\"\\'user.activation-link-text\\' | translate: {activationLink: activationLink}\"></span>\\n' +\n            '      <div class=\"flex justify-center items-center\">\\n' +\n            '        <pre class=\"tb-highlight\" class=\"flex\"><code>{{ activationLink }}</code></pre>\\n' +\n            '        <button mat-icon-button\\n' +\n            '                color=\"primary\"\\n' +\n            '                ngxClipboard\\n' +\n            '                cbContent=\"{{ activationLink }}\"\\n' +\n            '                (cbOnSuccess)=\"onActivationLinkCopied()\"\\n' +\n            '                matTooltip=\"{{ \\'user.copy-activation-link\\' | translate }}\"\\n' +\n            '                matTooltipPosition=\"above\">\\n' +\n            '          <mat-icon svgIcon=\"mdi:clipboard-arrow-left\"></mat-icon>\\n' +\n            '        </button>\\n' +\n            '      </div>\\n' +\n            '    </div>\\n' +\n            '  </div>\\n' +\n            '  <div mat-dialog-actions class=\"flex justify-end gap-2\">\\n' +\n            '    <button mat-button color=\"primary\"\\n' +\n            '            type=\"button\"\\n' +\n            '            cdkFocusInitial\\n' +\n            '            [disabled]=\"(isLoading$ | async)\"\\n' +\n            '            (click)=\"close()\">\\n' +\n            '      {{ \\'action.ok\\' | translate }}\\n' +\n            '    </button>\\n' +\n            '  </div>\\n' +\n            '</form>';\n        return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink});\n    }\n\n    function ActivationLinkDialogController(instance) {\n        var vm = instance;\n\n        vm.activationLink = instance.data.activationLink;\n\n        vm.onActivationLinkCopied = onActivationLinkCopied;\n        vm.close = close;\n\n        function onActivationLinkCopied(){\n            widgetContext.showSuccessToast(translate.instant('user.activation-link-copied-message'), 1000, 'bottom', 'left', 'activationLinkDialogContent');\n        }\n\n        function close() {\n            vm.dialogRef.close(null);\n        }\n    }\n  \n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "4b84e1ab-9b9c-6173-ae5b-51a78fafe48c",
        "typeFullFqn": "system.cards.entities_table"
      },
      "2433d7c8-6c4d-26d5-f123-adb09148fbec": {
        "typeFullFqn": "system.cards.markdown_card",
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "04917190-aea7-e407-e308-4598f1671a71",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1737447672095,
                "endTimeMs": 1737534072095
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": true,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ""
          },
          "title": "{i18n:custom.user-management.user-management}",
          "showTitleIcon": true,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "actions": {
            "headerButton": [
              {
                "name": "{i18n:action.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n/*params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten*/\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f9a94ea9-abbd-daa2-234c-959b21e21b65"
              }
            ]
          },
          "enableDataExport": false,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "titleFont": {
            "size": 22,
            "sizeUnit": "px",
            "family": "Roboto",
            "weight": "500",
            "style": "normal"
          },
          "titleIcon": ""
        },
        "row": 0,
        "col": 0,
        "id": "2433d7c8-6c4d-26d5-f123-adb09148fbec"
      },
      "f5be3f90-8574-86fb-1e71-7381ecb6956d": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "203b0867-b867-ef98-1791-03046c133b7d",
              "dataKeys": [
                {
                  "name": "role",
                  "type": "attribute",
                  "label": "role",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.8853142583803868
                },
                {
                  "name": "ownerName",
                  "type": "entityField",
                  "label": "customer",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.48497657295220475,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "d75c5b86-8b39-59e2-59f3-ae1c1ee40910",
              "dataKeys": [
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "projectProgress",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.6077801146000442,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Name",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.8167362021349891
                },
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "selectedProgress",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.04285551819508693,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "c849d52c-a3c7-5008-a4c0-c2d0406fe515",
              "dataKeys": [
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "measurementProgress",
                  "color": "#607d8b",
                  "settings": {},
                  "_hash": 0.3810102775224764,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678196817440,
                "endTimeMs": 1678283217440
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "\n// Check if project is selected\nvar stateParams = ctx.stateController.getStateParams();\nvar selectedProject = stateParams.selectedProject;\nvar projectState = selectedProject ? true : false;\n\nctx.stateController.updateState(null, stateParams);\n\n// Get project info directly from stateParams (not from datasource!)\nvar selectedProjectName = '';\nvar selectedProjectLabel = '';\nif (selectedProject) {\n  selectedProjectName = selectedProject.entityName || '';\n  selectedProjectLabel = selectedProject.entityLabel || '';\n}\n\n// Datasources:\n// \"Current User\" -> role, customer\n// \"Project\" -> projectProgress (all projects from state entity)\n// \"Selected Project\" -> selectedProgress\n// \"Project Measurements\" -> measurementProgress\n\nvar userRole = '';\nvar customerName = '';\nvar projectsTotal = 0, projectsPlanned = 0, projectsActive = 0, projectsFinished = 0, projectsAborted = 0;\nvar selectedProgress = '';\nvar measurementsTotal = 0;\n\ndata.forEach(function(item) {\n  var alias = item.aliasName || '';\n\n  if (alias === 'Current User') {\n    userRole = item.role || '';\n    customerName = item.customer || '';\n  } else if (alias === 'Project') {\n    // Changed from \"All Projects\" to \"Project\" to match actual datasource alias\n    projectsTotal++;\n    var progress = (item.projectProgress || '').toLowerCase();\n    if (progress === 'in preparation' || progress === 'planned') {\n      projectsPlanned++;\n    } else if (progress === 'active') {\n      projectsActive++;\n    } else if (progress === 'finished') {\n      projectsFinished++;\n    } else if (progress === 'aborted') {\n      projectsAborted++;\n    }\n  } else if (alias === 'Selected Project') {\n    selectedProgress = item.selectedProgress || 'in preparation';\n  } else if (alias === 'Project Measurements') {\n    measurementsTotal++;\n  }\n});\n\nvar isTenantAdmin = ctx.currentUser.authority === 'TENANT_ADMIN';\nvar isEcoAdmin = userRole === 'ECO Administrator';\nvar isRestrictedUser = userRole === 'Belimo Retrofit Users' || userRole === 'ECO Diagnostics Users' || userRole === 'Users' || userRole === 'User';\nvar canManage = isTenantAdmin || isEcoAdmin || !isRestrictedUser;\nstateParams['userRole'] = userRole;\nctx.stateController.updateState(null, stateParams);\n\nvar headerHtml = '';\nvar contentHtml = '';\n\nif (projectState) {\n  // === PROJECT DETAIL VIEW ===\n  var progressClass = (selectedProgress || 'in-preparation').toLowerCase().replace(' ', '-');\n  var progressLabel = selectedProgress || 'In Preparation';\n  if (progressLabel.toLowerCase() === 'in preparation') progressLabel = 'In Preparation';\n\n  // Title: entityName - entityLabel (or just entityName if no label)\n  var titleText = selectedProjectLabel ? (selectedProjectName + ' - ' + selectedProjectLabel) : selectedProjectName;\n\n  headerHtml = '<div class=\"manage-header projects\">' +\n      '<div class=\"header-left\">' +\n          '<a id=\"btn-go-back\" class=\"back-button\" role=\"button\" title=\"Go Back\">' +\n              '<mat-icon>arrow_back</mat-icon>' +\n          '</a>' +\n          '<div class=\"header-title\">' +\n              '<h1><mat-icon>folder_open</mat-icon>' + titleText + '</h1>' +\n              '<div class=\"header-stats\">' +\n                  '<span class=\"stat-item\"><span class=\"stat-dot ' + progressClass + '\"></span>' + progressLabel + '</span>' +\n                  '<span class=\"stat-item\"><span class=\"stat-value\">' + measurementsTotal + '</span> Measurements</span>' +\n              '</div>' +\n          '</div>' +\n      '</div>' +\n      '<div class=\"header-right\">' +\n          (canManage ? '<a id=\"btn-add-measurement\" class=\"header-action-btn\" role=\"button\" title=\"Add Measurement\"><mat-icon>add</mat-icon>Add Measurement</a>' : '') +\n          (canManage ? '<a id=\"btn-project-wizard\" class=\"header-action-btn wizard\" role=\"button\" title=\"Project Wizard\"><mat-icon>rocket_launch</mat-icon>Project Wizard</a>' : '') +\n      '</div>' +\n  '</div>';\n\n  contentHtml = '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"project_measurements\"></tb-dashboard-state>';\n\n} else {\n  // === PROJECT LIST VIEW ===\n  headerHtml = '<div class=\"manage-header projects\">' +\n      '<div class=\"header-left\">' +\n          '<a id=\"btn-go-back\" class=\"back-button\" role=\"button\" title=\"Go Back\">' +\n              '<mat-icon>arrow_back</mat-icon>' +\n          '</a>' +\n          '<div class=\"header-title\">' +\n              '<h1><mat-icon>folder_open</mat-icon>Projects</h1>' +\n              '<div class=\"header-stats\">' +\n                  '<span class=\"stat-item\"><span class=\"stat-dot total\"></span><span class=\"stat-value\">' + projectsTotal + '</span> Total</span>' +\n                  '<span class=\"stat-item\"><span class=\"stat-dot planned\"></span><span class=\"stat-value\">' + projectsPlanned + '</span> Planned</span>' +\n                  '<span class=\"stat-item\"><span class=\"stat-dot active\"></span><span class=\"stat-value\">' + projectsActive + '</span> Active</span>' +\n                  '<span class=\"stat-item\"><span class=\"stat-dot finished\"></span><span class=\"stat-value\">' + projectsFinished + '</span> Finished</span>' +\n                  '<span class=\"stat-item\"><span class=\"stat-dot aborted\"></span><span class=\"stat-value\">' + projectsAborted + '</span> Aborted</span>' +\n              '</div>' +\n          '</div>' +\n      '</div>' +\n      '<div class=\"header-right\">' +\n          (canManage ? '<a id=\"btn-add-project\" class=\"header-action-btn\" role=\"button\" title=\"Add Project\"><mat-icon>add</mat-icon>Add Project</a>' : '') +\n      '</div>' +\n  '</div>';\n\n  contentHtml = '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"projects_all\"></tb-dashboard-state>';\n}\n\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\n       headerHtml +\n       contentHtml +\n       '</div>';\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget {\n    border-radius: 0px;\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n/* === Reusable Manage Header === */\n.manage-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem;\n    border-radius: 8px;\n    color: #ffffff;\n    min-height: 70px;\n    margin-bottom: 1rem;\n}\n\n.manage-header.kits {\n    background: linear-gradient(135deg, #3a6a9e 0%, #2c5278 100%);\n}\n\n.manage-header.projects {\n    background: linear-gradient(135deg, #26a69a 0%, #00897b 100%);\n}\n\n.manage-header.users {\n    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);\n}\n\n.header-left {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n}\n\n.back-button {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    width: 40px;\n    height: 40px;\n    background: rgba(255,255,255,0.15);\n    border: 1px solid rgba(255,255,255,0.3);\n    border-radius: 8px;\n    color: #ffffff;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    text-decoration: none;\n}\n\n.back-button:hover {\n    background: rgba(255,255,255,0.25);\n}\n\n.back-button mat-icon {\n    font-size: 24px !important;\n    width: 24px !important;\n    height: 24px !important;\n}\n\n.header-title {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n}\n\n.header-title h1 {\n    font-size: 1.4rem;\n    font-weight: 600;\n    margin: 0;\n    display: flex;\n    align-items: center;\n    gap: 0.6rem;\n}\n\n.header-title h1 mat-icon {\n    font-size: 26px !important;\n    width: 26px !important;\n    height: 26px !important;\n    opacity: 0.9;\n}\n\n.header-stats {\n    display: flex;\n    gap: 1.25rem;\n    font-size: 0.85rem;\n    opacity: 0.9;\n}\n\n.stat-item {\n    display: flex;\n    align-items: center;\n    gap: 0.35rem;\n}\n\n.stat-dot {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n}\n\n.stat-dot.total { background-color: #ffffff; }\n.stat-dot.assigned { background-color: #EB5757; }\n.stat-dot.available { background-color: #27AE60; }\n.stat-dot.planned { background-color: #F2994A; }\n.stat-dot.in-preparation { background-color: #F2994A; }\n.stat-dot.active { background-color: #27AE60; }\n.stat-dot.finished { background-color: #2F80ED; }\n.stat-dot.aborted { background-color: #EB5757; }\n.stat-dot.admin { background-color: #EB5757; }\n.stat-dot.engineer { background-color: #2F80ED; }\n.stat-dot.user { background-color: #27AE60; }\n\n.stat-value {\n    font-weight: 600;\n}\n\n.header-right {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n}\n\n.header-action-btn {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.6rem 1.2rem;\n    background: rgba(255,255,255,0.15);\n    border: 1px solid rgba(255,255,255,0.4);\n    border-radius: 6px;\n    color: #ffffff !important;\n    font-size: 0.875rem;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    text-decoration: none;\n}\n\n.header-action-btn mat-icon {\n    color: #ffffff !important;\n}\n\n.header-action-btn:hover {\n    background: rgba(255,255,255,0.95);\n    color: #2c5278 !important;\n    border-color: transparent;\n}\n\n.header-action-btn:hover mat-icon {\n    color: #2c5278 !important;\n}\n\n/* Project Wizard Button - distinct styling */\n.header-action-btn.wizard {\n    background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);\n    border-color: transparent;\n}\n\n.header-action-btn.wizard:hover {\n    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);\n    color: #ffffff !important;\n    transform: translateY(-1px);\n    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);\n}\n\n.header-action-btn.wizard:hover mat-icon {\n    color: #ffffff !important;\n}\n\n/* Force white text in manage-header */\n.manage-header,\n.manage-header h1,\n.manage-header .header-title,\n.manage-header .header-stats,\n.manage-header .stat-item,\n.manage-header .stat-value,\n.manage-header mat-icon {\n    color: #ffffff !important;\n}\n\n.content-area {\n    flex: 1;\n    overflow: hidden;\n}\n\n.main-layout .header {\n    height: 60px;\n    margin: 4px;\n}\n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n/* Flexbox height fix - prevent scrolling */\n.main-layout {\n    display: flex;\n    flex-direction: column;\n    min-height: 0;\n    overflow: hidden;\n}\n\n.main-layout > .manage-header {\n    flex: 0 0 auto;\n}\n\n.main-layout > tb-dashboard-state {\n    flex: 1 1 auto;\n    min-height: 0;\n    height: 100%;\n    overflow: hidden;\n}\n\n/* Ensure parent containers also have proper height */\n.tb-markdown-view {\n    height: 100%;\n    overflow: hidden;\n}\n\n.tb-markdown-view > div {\n    height: 100%;\n    overflow: hidden;\n}\n"
          },
          "title": "Manage Projects Header",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow.no-padding {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 4px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "btn-go-back",
                "icon": "arrow_back",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nvar number = (widgetContext.stateController.getStateIndex())-1;\nwidgetContext.stateController.updateState(null, params);\nwidgetContext.stateController.navigatePrevState(number);",
                "id": "act-go-back"
              },
              {
                "name": "btn-add-project",
                "icon": "add",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addProjectFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 600px; max-width: 90vw;\">\n  <mat-toolbar class=\"flex items-center\" color=\"primary\">\n    <mat-icon style=\"margin-right: 12px;\">folder_open</mat-icon>\n    <h2 style=\"margin: 0; font-size: 18px;\">Add Project</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col gap-3 p-4\">\n\n    <!-- Customer Section -->\n    <fieldset *ngIf=\"isTenantAdmin\" class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">business</mat-icon>\n        Customer\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Customer</mat-label>\n        <mat-select formControlName=\"customer\" (selectionChange)=\"onCustomerChange()\" required>\n          <mat-option *ngFor=\"let c of customers\" [value]=\"c\">{{ c.name }}</mat-option>\n        </mat-select>\n        <mat-error *ngIf=\"addProjectFormGroup.get('customer')?.hasError('required')\">Customer is required.</mat-error>\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Project Info Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">folder</mat-icon>\n        Project Info\n      </legend>\n      <tb-image-input formControlName=\"projectPicture\" label=\"Project Picture\" noImageText=\"No picture selected\"></tb-image-input>\n      <mat-form-field appearance=\"fill\" class=\"w-full disabled-field\">\n        <mat-label>Project ID</mat-label>\n        <input matInput formControlName=\"name\" required readonly>\n        <mat-error *ngIf=\"addProjectFormGroup.get('name').hasError('required')\">Project title is required.</mat-error>\n      </mat-form-field>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Label</mat-label>\n        <input matInput formControlName=\"entityLabel\">\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Address Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">location_on</mat-icon>\n        Address\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Project address</mat-label>\n        <input matInput formControlName=\"address\" [matAutocomplete]=\"addrAuto\" autocomplete=\"off\">\n        <button mat-icon-button matSuffix type=\"button\" (click)=\"searchAddress()\" [disabled]=\"(addProjectFormGroup.get('address').value || '').length < 5\">\n          <mat-icon>search</mat-icon>\n        </button>\n        <mat-autocomplete #addrAuto=\"matAutocomplete\" [displayWith]=\"displayAddressOption\" (optionSelected)=\"onAddressSelected($event.option.value)\">\n          <mat-option *ngFor=\"let opt of addressOptions\" [value]=\"opt\">{{ opt.label }}</mat-option>\n        </mat-autocomplete>\n        <mat-hint *ngIf=\"(addProjectFormGroup.get('address').value || '').length < 5\">Enter at least 5 characters to search</mat-hint>\n      </mat-form-field>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Postal Code</mat-label>\n          <input matInput formControlName=\"postalCode\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 2;\">\n          <mat-label>City</mat-label>\n          <input matInput formControlName=\"city\">\n        </mat-form-field>\n      </div>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Latitude</mat-label>\n          <input matInput formControlName=\"latitude\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Longitude</mat-label>\n          <input matInput formControlName=\"longitude\">\n        </mat-form-field>\n      </div>\n    </fieldset>\n\n  </div>\n  <div class=\"flex justify-end items-center gap-2 p-4\" style=\"border-top: 1px solid #e0e0e0; background: #fafafa;\">\n    <button mat-button (click)=\"cancel()\" type=\"button\">Cancel</button>\n    <button mat-raised-button color=\"primary\" type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addProjectFormGroup.invalid || !addProjectFormGroup.dirty\">\n      <mat-icon style=\"font-size: 18px; width: 18px; height: 18px; margin-right: 4px;\">save</mat-icon>\n      Save\n    </button>\n  </div>\n</form>",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled,\n.edit-project-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form .mdc-text-field--filled:not(.mdc-text-field--disabled),\n.edit-project-form .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .disabled-field input,\n.edit-project-form .disabled-field input {\n  color: rgba(0, 0, 0, 0.6) !important;\n}\n\n.add-entity-form .disabled-field,\n.edit-project-form .disabled-field {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\nmat-icon {\n  vertical-align: middle;\n  margin-right: 4px;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\n//let $scope = widgetContext.$scope;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\n\r\nlet shortNameAttr;\r\nlet customerShortName;\r\nlet nextProjectId = 0;\r\n\r\nconst ctx = widgetContext;\r\nconst isTenantAdmin = ctx.currentUser.authority === 'TENANT_ADMIN';\r\n\r\nlet customers = [];\r\nlet customerId;\r\nlet customerName;\r\n\r\nconst pageLink = ctx.pageLink(1000, 0, null, null, null);\r\n\r\ncustomerService.getUserCustomers(pageLink).subscribe(pageData => {\r\n\r\n    customers = (pageData && pageData.data) ? pageData.data : [];\r\n\r\n    // Non-Tenant-Admin → genau ein Customer\r\n    if (!isTenantAdmin && customers.length === 1) {\r\n        const c = customers[0];\r\n        customerId = {\r\n            id: c.id.id,\r\n            entityType: 'CUSTOMER'\r\n        };\r\n        customerName = c.name;\r\n    }\r\n\r\n    openAddProjectDialog();\r\n});\r\n\r\nfunction getLastProjectId(projects) {\r\n    let maxNumber = 0;\r\n    projects.forEach(item => {\r\n        const name = item.name;\r\n        const parts = name.split('_');\r\n        if (parts.length === 2) {\r\n            const number = parseInt(parts[1], 10);\r\n            if (number > maxNumber) {\r\n                maxNumber = number;\r\n            }\r\n        }\r\n    });\r\n    const nextProjectId = maxNumber + 1;\r\n    return nextProjectId;\r\n}\r\n\r\nfunction openAddProjectDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddProjectDialogController).subscribe();\r\n}\r\n\r\nfunction AddProjectDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.isTenantAdmin = isTenantAdmin;\r\n  vm.customers = customers;\r\n\r\nvm.addProjectFormGroup = vm.fb.group({\r\n    customer: [{ value: null, disabled: !isTenantAdmin }, vm.validators.required],\r\n    name: [{ value: '', disabled: true }, vm.validators.required],\r\n    entityLabel: [''],\r\n    projectPicture: [null],\r\n    address: [''],\r\n    postalCode: [''],\r\n    city: [''],\r\n    latitude: [''],\r\n    longitude: ['']\r\n});\r\n\r\n  // --- Address search state ---\r\n  vm.addressOptions = [];\r\n  vm._lastSelectedAddressLabel = null;\r\n\r\n  vm.displayAddressOption = function (opt) {\r\n    // MatAutocomplete calls displayWith with object OR string\r\n    if (!opt) return '';\r\n    return (typeof opt === 'string') ? opt : (opt.label || '');\r\n  };\r\n\r\n  vm.searchAddress = function () {\r\n    const qRaw = vm.addProjectFormGroup.get('address').value || '';\r\n    const q = (typeof qRaw === 'string') ? qRaw.trim() : vm.displayAddressOption(qRaw).trim();\r\n\r\n    if (q.length < 5) {\r\n      vm.addressOptions = [];\r\n      return;\r\n    }\r\n\r\n    searchAddressViaPhoton(q);\r\n  };\r\n\r\n  vm.onAddressSelected = function (opt) {\r\n    if (!opt) return;\r\n\r\n    vm._lastSelectedAddressLabel = opt.label;\r\n\r\n    // Patch-Objekt vorbereiten\r\n    const patchData = {\r\n      address: opt.label,\r\n      latitude: opt.lat,\r\n      longitude: opt.lon\r\n    };\r\n\r\n    // Nur postalCode und city setzen, wenn sie im Formular NICHT bereits ausgefüllt sind\r\n    const currentPostalCode = (vm.addProjectFormGroup.get('postalCode').value || '').trim();\r\n    const currentCity = (vm.addProjectFormGroup.get('city').value || '').trim();\r\n\r\n    if (!currentPostalCode && opt.postcode) {\r\n      patchData.postalCode = opt.postcode;\r\n    }\r\n    if (!currentCity && opt.city) {\r\n      patchData.city = opt.city;\r\n    }\r\n\r\n    vm.addProjectFormGroup.patchValue(patchData);\r\n\r\n    vm.addProjectFormGroup.get('address').markAsDirty();\r\n    vm.addProjectFormGroup.get('latitude').markAsDirty();\r\n    vm.addProjectFormGroup.get('longitude').markAsDirty();\r\n\r\n    if (!currentPostalCode && opt.postcode) {\r\n      vm.addProjectFormGroup.get('postalCode').markAsDirty();\r\n    }\r\n    if (!currentCity && opt.city) {\r\n      vm.addProjectFormGroup.get('city').markAsDirty();\r\n    }\r\n\r\n    // optional: Ergebnisse leeren, damit Dropdown zugeht\r\n    vm.addressOptions = [];\r\n  };\r\n\r\n  // --- Debounced auto-search without rxjs operators ---\r\n  let addrTimer = null;\r\n  let lastQuery = '';\r\n\r\n  vm.addProjectFormGroup.get('address').valueChanges.subscribe(val => {\r\n    // Wenn eine Auswahl gerade gesetzt wurde, nicht sofort neu suchen\r\n    if (typeof val === 'string' && vm._lastSelectedAddressLabel && val === vm._lastSelectedAddressLabel) {\r\n      return;\r\n    }\r\n\r\n    const s = (typeof val === 'string')\r\n      ? val.trim()\r\n      : (vm.displayAddressOption(val) || '').trim();\r\n\r\n    // Reset results for short strings\r\n    if (s.length < 5) {\r\n      vm.addressOptions = [];\r\n      lastQuery = s;\r\n      if (addrTimer) {\r\n        clearTimeout(addrTimer);\r\n        addrTimer = null;\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Simple distinctUntilChanged\r\n    if (s === lastQuery) {\r\n      return;\r\n    }\r\n    lastQuery = s;\r\n\r\n    // Debounce\r\n    if (addrTimer) {\r\n      clearTimeout(addrTimer);\r\n    }\r\n    addrTimer = setTimeout(() => {\r\n      searchAddressViaPhoton(s);\r\n    }, 350);\r\n  });\r\n\r\n\r\n  function searchAddressViaPhoton(query) {\r\n    // Hole postalCode und city aus dem Formular\r\n    const postalCode = (vm.addProjectFormGroup.get('postalCode').value || '').trim();\r\n    const city = (vm.addProjectFormGroup.get('city').value || '').trim();\r\n\r\n    // Verfeinerte Query erstellen\r\n    let refinedQuery = query;\r\n    if (postalCode) {\r\n      refinedQuery += ' ' + postalCode;\r\n    }\r\n    if (city) {\r\n      refinedQuery += ' ' + city;\r\n    }\r\n\r\n    const url =\r\n      'https://photon.komoot.io/api' +\r\n      '?q=' + encodeURIComponent(refinedQuery) +\r\n      '&limit=5';\r\n\r\n    fetch(url)\r\n      .then(res => {\r\n        if (!res.ok) throw new Error('HTTP ' + res.status);\r\n        return res.json();\r\n      })\r\n      .then(data => {\r\n        const features = (data && data.features) ? data.features : [];\r\n\r\n        vm.addressOptions = features.map(f => {\r\n          const p = f.properties || {};\r\n          const coords = (f.geometry && f.geometry.coordinates) ? f.geometry.coordinates : [null, null];\r\n          const lon = coords[0];\r\n          const lat = coords[1];\r\n\r\n          // Bausteine\r\n          const street = p.street || p.name || '';\r\n          const house = p.housenumber ? (' ' + p.housenumber) : '';\r\n          const place = (street + house).trim() || (p.label || p.name || '').trim();\r\n\r\n          const cc = (p.countrycode || '').toUpperCase();\r\n          const postcode = p.postcode || '';\r\n          const cityFromResult = p.city || p.town || p.village || p.state || '';\r\n\r\n          // Ziel-Format: \"Adresse, CC-PLZ Ort\"\r\n          let tail = '';\r\n          if (cc || postcode || cityFromResult) {\r\n            tail = (cc ? cc : '');\r\n            if (cc && postcode) tail += '-' + postcode;\r\n            else if (!cc && postcode) tail += postcode;\r\n            if ((cc || postcode) && cityFromResult) tail += ' ' + cityFromResult;\r\n            else if (!cc && !postcode && cityFromResult) tail += cityFromResult;\r\n          }\r\n\r\n          const label = tail ? (place + ', ' + tail) : place;\r\n\r\n          return {\r\n            label,\r\n            lat: (typeof lat === 'number') ? lat : parseFloat(lat),\r\n            lon: (typeof lon === 'number') ? lon : parseFloat(lon),\r\n            postcode: postcode,\r\n            city: cityFromResult,\r\n            raw: f\r\n          };\r\n        });\r\n      })\r\n      .catch(err => {\r\n        console.error('Address search failed', err);\r\n        vm.addressOptions = [];\r\n      });\r\n  }\r\n\r\n\r\n  \r\nif (!isTenantAdmin && customerId) {\r\n    vm.addProjectFormGroup.patchValue({\r\n        customer: customers[0]\r\n    });\r\n    vm.addProjectFormGroup.get('customer').markAsDirty();\r\n    loadCustomerData(customerId);\r\n}\r\n\r\n  \r\nvm.onCustomerChange = function () {\r\n    const c = vm.addProjectFormGroup.value.customer;\r\n    if (!c) return;\r\n\r\n    customerId = {\r\n        id: c.id.id,\r\n        entityType: 'CUSTOMER'\r\n    };\r\n    customerName = c.name;\r\n\r\n    loadCustomerData(customerId);\r\n};\r\n\r\n  \r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    vm.addProjectFormGroup.markAsPristine();\r\n    saveProjectObservable(customerId).subscribe(\r\n      function (Project) {\r\n          widgetContext.rxjs.forkJoin([\r\n              saveCustomerToProjectRelation(customerId, Project.id),\r\n              saveAttributes(Project.id)\r\n          ]).subscribe(\r\n              function () {\r\n                var params = widgetContext.stateController.getStateParams();\r\n                var selectedProject = params['selectedProject'];\r\n                params['selectedProject'] = { entityId: Project.id, entityName: Project.name, entityLabel: '' };\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              }\r\n        );\r\n      }\r\n    );\r\n  };\r\n  \r\nfunction loadCustomerData(customerId) {\r\n\r\n    let assetSearchQuery = {\r\n        parameters: {\r\n            rootId: customerId.id,\r\n            rootType: 'CUSTOMER',\r\n            direction: 'FROM',\r\n            relationTypeGroup: 'COMMON',\r\n            maxLevel: 10,\r\n            fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n    };\r\n\r\n    assetService.findByQuery(assetSearchQuery).subscribe(projects => {\r\n\r\n        nextProjectId = getLastProjectId(projects);\r\n\r\n        attributeService\r\n            .getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName'])\r\n            .subscribe(attributes => {\r\n\r\n                const shortNameAttr = attributes.find(a => a.key === 'shortName');\r\n                customerShortName = shortNameAttr\r\n                    ? shortNameAttr.value\r\n                    : customerName;\r\n\r\n                vm.addProjectFormGroup.patchValue({\r\n                    name: customerShortName + '_' + nextProjectId\r\n                });\r\n\r\n                vm.addProjectFormGroup.get('name').markAsDirty();\r\n            });\r\n    });\r\n}\r\n\r\n  function saveProjectObservable(customerId) {\r\n    return getProjectsGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((ProjectsGroup) => {\r\n            const formValues = vm.addProjectFormGroup.getRawValue();\r\n            let Project = {\r\n              name: formValues.name,\r\n              type: 'Project',\r\n              label: formValues.entityLabel,\r\n              customerId: customerId\r\n            };\r\n            return assetService.saveAsset(Project, ProjectsGroup.id.id)\r\n        })\r\n    );\r\n  }\r\n  \r\n  function getProjectsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var ProjectsGroup = entityGroups.find(group => group.name === 'Projects');\r\n              if (ProjectsGroup) {\r\n                  return widgetContext.rxjs.of(ProjectsGroup);\r\n              } else {\r\n                  ProjectsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Projects',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(ProjectsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n\r\n  function saveCustomerToProjectRelation(customerId, ProjectId) {\r\n      var relation = {\r\n          from: customerId,\r\n          to: ProjectId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  \r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n        {\r\n            key: 'latitude',\r\n            value: vm.addProjectFormGroup.value.latitude || 48.1406022\r\n        },\r\n        {\r\n            key: 'longitude',\r\n            value: vm.addProjectFormGroup.value.longitude || 16.2932688\r\n        },\r\n        {\r\n            key: 'address',\r\n            value: vm.addProjectFormGroup.value.address\r\n        },        \r\n        {\r\n            key: 'progress',\r\n            value: 'in preparation'\r\n        },\r\n        {\n            key: 'units',\n            value: 'metric'\n        }\n    ];\n    // Add projectPicture if provided\n    if (vm.addProjectFormGroup.value.projectPicture) {\n        attributesArray.push({\n            key: 'projectPicture',\n            value: vm.addProjectFormGroup.value.projectPicture\n        });\n    }\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "act-add-project"
              },
              {
                "name": "btn-add-measurement",
                "icon": "add",
                "type": "custom",
                "customFunction": {
                  "body": "const stateParams = widgetContext.stateController.getStateParams();\nconst selectedProject = stateParams.selectedProject;\n\nif (!selectedProject || !selectedProject.entityId || !selectedProject.entityId.id) {\n    console.error('No project selected. Please select a project first.');\n    return;\n}\n\nconst projectId = { id: selectedProject.entityId.id, entityType: 'ASSET' };\nconst projectName = selectedProject.entityName;\n\n// Determine customerId\nconst NULL_UUID = '13814000-1dd2-11b2-8080-808080808080';\nfunction isValidCustomerId(id) {\n    return id && id !== NULL_UUID;\n}\n\nconst userRole = stateParams.userRole;\nconst stateEntityId = stateParams.entityId;\nlet customerId;\n\nif ((widgetContext.currentUser.authority === 'TENANT_ADMIN' || userRole === 'ECO Administrator') && stateEntityId && stateEntityId.id && isValidCustomerId(stateEntityId.id)) {\n    customerId = stateEntityId;\n    openDialog();\n} else if (isValidCustomerId(widgetContext.currentUser.customerId)) {\n    customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\n    openDialog();\n} else {\n    // Fetch customerId from project asset\n    const $injector = widgetContext.$scope.$injector;\n    const assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n    assetService.getAsset(projectId.id).subscribe(projectAsset => {\n        if (projectAsset && projectAsset.customerId && isValidCustomerId(projectAsset.customerId.id)) {\n            customerId = projectAsset.customerId;\n            openDialog();\n        } else {\n            console.error('Cannot determine customerId. Project has no valid customer assigned.');\n        }\n    });\n}\n\nfunction openDialog() {\n    projectWizard.openAddMeasurementDialog(widgetContext, projectId, projectName, customerId, function(result) {\n        // Update state params with new measurement\n        const params = widgetContext.stateController.getStateParams();\n        params['selectedMeasurement'] = {\n            entityId: result.id,\n            entityName: result.name,\n            entityLabel: result.label || ''\n        };\n        widgetContext.updateAliases();\n\n        // If connectKit checkbox was checked and it's ultrasonic, open connect dialog\n        if (result.connectKit && result.measurementType === 'ultrasonic') {\n            dataImporter.dataConnectorDialog(widgetContext, result.id, result.name);\n        }\n    });\n}",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                    "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "id": "act-add-measurement"
              },
              {
                "name": "btn-project-wizard",
                "icon": "rocket_launch",
                "type": "custom",
                "customFunction": {
                  "body": "const stateParams = widgetContext.stateController.getStateParams();\nconst selectedProject = stateParams.selectedProject;\n\nif (!selectedProject || !selectedProject.entityId || !selectedProject.entityId.id) {\n    console.error('No project selected. Please select a project first.');\n    return;\n}\n\nconst projectId = { id: selectedProject.entityId.id, entityType: 'ASSET' };\nconst projectName = selectedProject.entityName || '';\nconst projectLabel = selectedProject.entityLabel || '';\n\nprojectWizard.openProjectWizardDialog(widgetContext, projectId, projectName, projectLabel, function() {\n    widgetContext.updateAliases();\n}, { dataImporter: dataImporter });",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                    "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "id": "act-project-wizard"
              }
            ]
          },
          "pageSize": 1024,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "borderRadius": "8"
        },
        "row": 0,
        "col": 0,
        "id": "f5be3f90-8574-86fb-1e71-7381ecb6956d",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "03ceaaed-0eb5-4d4e-a3ef-0c4394cb2cb8": {
        "typeFullFqn": "system.map",
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1745755787013,
                "endTimeMs": 1745842187013
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": false,
          "backgroundColor": "rgba(0, 0, 0, 0)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "mapType": "geoMap",
            "layers": [
              {
                "label": "{i18n:widgets.maps.layer.roadmap}",
                "provider": "openstreet",
                "layerType": "CartoDB.Positron",
                "referenceLayer": null
              },
              {
                "label": "{i18n:widgets.maps.layer.satellite}",
                "provider": "openstreet",
                "layerType": "Esri.WorldImagery"
              },
              {
                "label": "{i18n:widgets.maps.layer.hybrid}",
                "provider": "openstreet",
                "layerType": "Esri.WorldImagery",
                "referenceLayer": "openstreetmap_hybrid"
              },
              {
                "label": "{i18n:widgets.maps.layer.topographic}",
                "provider": "openstreet",
                "layerType": "Esri.WorldTopoMap",
                "referenceLayer": null
              },
              {
                "label": null,
                "provider": "openstreet",
                "layerType": "OpenStreetMap.HOT",
                "referenceLayer": null
              },
              {
                "label": null,
                "provider": "openstreet",
                "layerType": "Esri.WorldStreetMap",
                "referenceLayer": null
              },
              {
                "provider": "openstreet",
                "layerType": "OpenStreetMap.Mapnik"
              }
            ],
            "imageSource": null,
            "markers": [
              {
                "dsType": "entity",
                "dsLabel": "",
                "dsDeviceId": null,
                "dsEntityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
                "dsFilterId": "3744b253-8d5c-7528-b178-0c8be5c3adca",
                "additionalDataSources": null,
                "additionalDataKeys": [
                  {
                    "name": "progress",
                    "type": "attribute",
                    "label": "progress",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.9725950885098493
                  },
                  {
                    "name": "name",
                    "type": "entityField",
                    "label": "name",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.2872987416504812,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  },
                  {
                    "name": "address",
                    "type": "attribute",
                    "label": "address",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8026110588871542
                  },
                  {
                    "name": "outsideTemp",
                    "type": "timeseries",
                    "label": "outsideTemp",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.759902282076257
                  },
                  {
                    "name": "outsideHumidity",
                    "type": "timeseries",
                    "label": "outsideHumidity",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.05821233805088244
                  },
                  {
                    "name": "label",
                    "type": "entityField",
                    "label": "label",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8646915284773707,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  }
                ],
                "label": {
                  "show": true,
                  "type": "function",
                  "pattern": "${entityName}",
                  "patternFunction": {
                    "body": "var color = utils.getProgressColor(data.progress).color;\r\n\r\nreturn '<span style=\"border: solid ' + color + '; border-radius: 10px; color: ' + color + '; background-color: #fff; padding: 3px 5px; font-size: 14px; position: relative; bottom: 6px;\">' + \r\n           '${entityName}' + \r\n        '</span>';",
                    "modules": {
                      "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js",
                      "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js"
                    }
                  }
                },
                "tooltip": {
                  "show": false,
                  "trigger": "hover",
                  "autoclose": true,
                  "type": "function",
                  "pattern": "<b>${entityName}</b><br/><br/><b>Latitude:</b> ${latitude:7}<br/><b>Longitude:</b> ${longitude:7}<br/><b>Temperature:</b> ${temperature} °C<br/><small>See tooltip settings for details</small>",
                  "offsetX": 0,
                  "offsetY": -1,
                  "patternFunction": {
                    "body": "const locationName = data.locationName || data.label || entityName;\nconst name = data.name || entityName;\nconst progress = data.progress;\nconst address = data.address || '';\n\nlet progressHtml = '';\nif (progress) {\n    let color, bgColor, label;\n    switch (progress) {\n        case 'active':\n            color = '#27AE60';\n            bgColor = 'rgba(39, 174, 96, 0.12)';\n            label = 'Active';\n            break;\n        case 'in preparation':\n            color = '#F2994A';\n            bgColor = 'rgba(242, 153, 74, 0.12)';\n            label = 'In Preparation';\n            break;\n        case 'finished':\n            color = '#2F80ED';\n            bgColor = 'rgba(47, 128, 237, 0.12)';\n            label = 'Finished';\n            break;\n        case 'aborted':\n            color = '#EB5757';\n            bgColor = 'rgba(235, 87, 87, 0.12)';\n            label = 'Aborted';\n            break;\n        default:\n            color = '#828282';\n            bgColor = 'rgba(130, 130, 130, 0.12)';\n            label = progress || 'Unknown';\n    }\n    progressHtml = '<span style=\"padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; color: ' + color + '; background-color: ' + bgColor + ';\">' + label + '</span>';\n}\n\nreturn '<div style=\"font-family: Roboto; font-size: 14px;\">' +\n    '<div style=\"font-weight: 600; margin-bottom: 4px;\">' + locationName + '</div>' +\n    '<div style=\"color: #666; font-size: 12px; margin-bottom: 4px;\">' + name + '</div>' +\n    (progressHtml ? '<div>' + progressHtml + '</div>' : '') +\n    '<div style=\"color: #999; font-size: 11px; margin-top: 8px;\">Click for details</div>' +\n    '</div>';",
                    "modules": {}
                  },
                  "tagActions": null
                },
                "click": {
                  "type": "customPretty",
                  "customHtml": "<form class=\"project-popup-form\">\n  <button class=\"popup-close\" mat-icon-button (click)=\"close()\" type=\"button\">\n    <mat-icon class=\"material-icons\">close</mat-icon>\n  </button>\n  <div mat-dialog-content>\n    <!-- Project Picture -->\n    <section *ngIf=\"project.picture\" class=\"flex flex-col items-center justify-center\" style=\"padding-bottom: 16px;\">\n      <img class=\"project-picture\" [src]=\"project.picture\"/>\n    </section>\n    \n    <!-- Project Name -->\n    <section class=\"flex flex-col items-center justify-center\" style=\"padding-bottom: 16px;\">\n      <div class=\"popup-title\">{{ project.locationName }}</div>\n      <div class=\"popup-subtitle\">{{ project.name }}</div>\n    </section>\n    \n    <mat-divider style=\"margin-bottom: 16px;\"></mat-divider>\n    \n    <!-- Project Details -->\n    <section class=\"flex flex-col gap-2\" style=\"padding-bottom: 16px;\">\n      <div class=\"flex flex-row items-baseline\">\n        <div class=\"popup-label\">Address</div>\n        <div class=\"popup-value\">{{ project.address }}</div>\n      </div>\n      <div class=\"flex flex-row items-center\">\n        <div class=\"popup-label\">Progress</div>\n        <div class=\"popup-badge\" [style.color]=\"project.progressStyle.color\" [style.background-color]=\"project.progressStyle.bgColor\">\n          {{ project.progressStyle.label }}\n        </div>\n      </div>\n      <div class=\"flex flex-row items-center\" *ngIf=\"project.measurementsCount !== null\">\n        <div class=\"popup-label\">Measurements</div>\n        <div class=\"popup-value\">{{ project.measurementsCount }}</div>\n      </div>\n    </section>\n    \n    <!-- Timestamps -->\n    <section *ngIf=\"project.startTime || project.endTime\" class=\"flex flex-row gap-2 flex-wrap\" style=\"padding-bottom: 16px;\">\n      <div *ngIf=\"project.startTime\" class=\"timestamp-badge\" [style.color]=\"project.startTime.color\" [style.background-color]=\"project.startTime.bgColor\">\n        <mat-icon style=\"font-size: 14px; width: 14px; height: 14px; margin-right: 4px;\">{{ project.startTime.icon }}</mat-icon>\n        <span>{{ project.startTime.label }}</span>\n      </div>\n      <div *ngIf=\"project.endTime\" class=\"timestamp-badge\" [style.color]=\"project.endTime.color\" [style.background-color]=\"project.endTime.bgColor\">\n        <mat-icon style=\"font-size: 14px; width: 14px; height: 14px; margin-right: 4px;\">{{ project.endTime.icon }}</mat-icon>\n        <span>{{ project.endTime.label }}</span>\n      </div>\n    </section>\n    \n    <!-- Buttons -->\n    <section class=\"flex flex-row gap-2 items-center justify-center flex-wrap\" style=\"padding-top: 8px;\">\n      <button *ngIf=\"showWizardButton\" type=\"button\" mat-flat-button color=\"primary\" class=\"popup-button wizard-button\" (click)=\"openProjectWizard()\">\n        <mat-icon>rocket_launch</mat-icon>\n        <span>Project Wizard</span>\n      </button>\n      <button type=\"button\" mat-stroked-button class=\"popup-button edit-button\" (click)=\"openEditProject()\">\n        <mat-icon>edit</mat-icon>\n        <span>Edit</span>\n      </button>\n    </section>\n  </div>\n</form>",
                  "customCss": ".project-popup-form {\n    width: 420px;\n    position: relative;\n    padding: 16px;\n}\n\n.project-popup-form .mat-mdc-dialog-content {\n    max-height: 95vh;\n    padding: 0;\n}\n\n.project-popup-form .popup-close {\n    position: absolute;\n    top: 8px;\n    right: 8px;\n    z-index: 1;\n}\n\n.project-popup-form .project-picture {\n    width: 160px;\n    height: 160px;\n    border-radius: 8px;\n    object-fit: cover;\n}\n\n.project-popup-form .popup-title {\n    font-weight: 600;\n    font-size: 18px;\n    line-height: 24px;\n    color: #29313C;\n    text-align: center;\n}\n\n.project-popup-form .popup-subtitle {\n    font-size: 14px;\n    color: #666;\n    text-align: center;\n}\n\n.project-popup-form .popup-label {\n    font-size: 13px;\n    line-height: 16px;\n    font-weight: 500;\n    color: rgba(0, 0, 0, 0.38);\n    width: 110px;\n    flex-shrink: 0;\n}\n\n.project-popup-form .popup-value {\n    font-size: 14px;\n    line-height: 20px;\n    font-weight: 500;\n    letter-spacing: 0.25px;\n    color: #29313C;\n}\n\n.project-popup-form .popup-badge {\n    display: inline-block;\n    padding: 4px 8px;\n    border-radius: 8px;\n    font-size: 12px;\n    font-weight: 500;\n    line-height: 16px;\n}\n\n.project-popup-form .timestamp-badge {\n    display: inline-flex;\n    align-items: center;\n    padding: 4px 8px;\n    border-radius: 4px;\n    font-size: 11px;\n    font-weight: 500;\n}\n\n.project-popup-form .popup-button {\n    display: flex;\n    align-items: center;\n    gap: 4px;\n}\n\n.project-popup-form .wizard-button {\n    background-color: #307FE5;\n}\n\n.project-popup-form .edit-button {\n    color: #F2994A;\n    border-color: #F2994A;\n}\n\n.project-popup-form .mat-mdc-outlined-button.mat-primary:not(:disabled),\n.project-popup-form .mat-mdc-stroked-button.mat-primary:not(:disabled) {\n    color: #307FE5;\n    border-color: #307FE5;\n}",
                  "customFunction": {
                    "body": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet rxjs = widgetContext.rxjs;\n\n// Load attributes and relations in parallel\nrxjs.forkJoin([\n    attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE', \n        ['locationName', 'address', 'progress', 'startTimeMs', 'endTimeMs', 'projectPicture']\n    ),\n    entityRelationService.findByFrom(entityId, 'Owns')\n]).subscribe(function(results) {\n    let attributes = results[0];\n    let relations = results[1];\n    \n    let attrMap = {};\n    attributes.forEach(function(attr) {\n        attrMap[attr.key] = attr.value;\n    });\n    \n    // Count measurements (relations with type Owns to ASSETs)\n    let measurementsCount = relations.filter(function(rel) {\n        return rel.to && rel.to.entityType === 'ASSET';\n    }).length;\n    \n    openProjectPopupDialog(attrMap, measurementsCount);\n});\n\nfunction openProjectPopupDialog(attrMap, measurementsCount) {\n    customDialog.customDialog(htmlTemplate, ProjectPopupController).subscribe();\n    \n    function ProjectPopupController(instance) {\n        let vm = instance;\n        \n        // Progress styling\n        let progressStyle = getProgressColor(attrMap.progress);\n        \n        // Timestamp styling\n        let startTime = getTimestampStyle(attrMap.startTimeMs, 'start');\n        let endTime = getTimestampStyle(attrMap.endTimeMs, 'end');\n        \n        vm.project = {\n            name: entityName,\n            locationName: attrMap.locationName || entityLabel || entityName,\n            address: attrMap.address || 'N/A',\n            progress: attrMap.progress,\n            progressStyle: progressStyle,\n            picture: attrMap.projectPicture || null,\n            startTime: startTime,\n            endTime: endTime,\n            measurementsCount: measurementsCount\n        };\n        \n        vm.showWizardButton = (attrMap.progress === 'in preparation' || attrMap.progress === 'active');\n        \n        vm.close = function() {\n            vm.dialogRef.close(null);\n        };\n        \n        vm.openProjectWizard = function() {\n            vm.dialogRef.close(null);\n            projectWizard.openProjectWizardDialog(widgetContext, entityId, entityName, entityLabel, function() {\n                widgetContext.updateAliases();\n            }, { dataImporter: dataImporter });\n        };\n        \n        vm.openMeasurements = function() {\n            vm.dialogRef.close(null);\n            var params = widgetContext.stateController.getStateParams();\n            var selectedProject = params['selectedProject'];\n            if (selectedProject && selectedProject.entityId.id === entityId.id) {\n                params['selectedProject'] = null;\n            } else {\n                params['selectedProject'] = { \n                    entityId: entityId, \n                    entityName: entityName, \n                    entityLabel: entityLabel \n                };\n            }\n            widgetContext.stateController.updateState(null, params);\n        };\n        vm.openEditProject = function() {\n            vm.dialogRef.close(null);\n            projectWizard.openEditProjectDialog(widgetContext, entityId, entityName, entityLabel, function() {\n                widgetContext.updateAliases();\n            });\n        };\n\n        \n        // Helper functions\n        function getProgressColor(progress) {\n            let color, bgColor, label;\n            switch (progress) {\n                case 'in preparation':\n                    color = '#F2994A';\n                    bgColor = 'rgba(242, 153, 74, 0.12)';\n                    label = 'In Preparation';\n                    break;\n                case 'planned':\n                    color = '#F2994A';\n                    bgColor = 'rgba(242, 153, 74, 0.12)';\n                    label = 'Planned';\n                    break;\n                case 'active':\n                    color = '#27AE60';\n                    bgColor = 'rgba(39, 174, 96, 0.12)';\n                    label = 'Active';\n                    break;\n                case 'finished':\n                    color = '#2F80ED';\n                    bgColor = 'rgba(47, 128, 237, 0.12)';\n                    label = 'Finished';\n                    break;\n                case 'aborted':\n                    color = '#EB5757';\n                    bgColor = 'rgba(235, 87, 87, 0.12)';\n                    label = 'Aborted';\n                    break;\n                default:\n                    color = '#828282';\n                    bgColor = 'rgba(130, 130, 130, 0.12)';\n                    label = progress || 'N/A';\n            }\n            return { color: color, bgColor: bgColor, label: label };\n        }\n        \n        function getTimestampStyle(timestampMs, type) {\n            if (timestampMs === null || timestampMs === undefined) {\n                return null;\n            }\n            var date = new Date(Number(timestampMs));\n            var pad = function(n) { return n.toString().padStart(2, '0'); };\n            var formattedTime = date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' + pad(date.getDate()) +\n                ' ' + pad(date.getHours()) + ':' + pad(date.getMinutes());\n            \n            var icon, color, bgColor, label;\n            if (type === 'start') {\n                icon = 'play_circle';\n                color = '#27AE60';\n                bgColor = 'rgba(39, 174, 96, 0.12)';\n                label = 'Start: ' + formattedTime;\n            } else {\n                icon = 'stop_circle';\n                color = '#2F80ED';\n                bgColor = 'rgba(47, 128, 237, 0.12)';\n                label = 'End: ' + formattedTime;\n            }\n            return { icon: icon, color: color, bgColor: bgColor, label: label };\n        }\n    }\n}",
                    "modules": {
                      "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                      "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                    }
                  },
                  "customResources": [],
                  "openInSeparateDialog": false,
                  "openInPopover": false
                },
                "groups": null,
                "edit": {
                  "enabledActions": [
                    "add",
                    "move"
                  ],
                  "attributeScope": "SERVER_SCOPE",
                  "snappable": false
                },
                "xKey": {
                  "name": "latitude",
                  "label": "latitude",
                  "type": "attribute",
                  "settings": {},
                  "color": "#2196f3"
                },
                "yKey": {
                  "name": "longitude",
                  "label": "longitude",
                  "type": "attribute",
                  "settings": {},
                  "color": "#2196f3"
                },
                "markerType": "icon",
                "markerShape": {
                  "shape": "markerShape1",
                  "size": 34,
                  "color": {
                    "type": "constant",
                    "color": "#307FE5"
                  }
                },
                "markerIcon": {
                  "size": 40,
                  "color": {
                    "type": "function",
                    "color": "#307FE5",
                    "rangeKey": null,
                    "range": null,
                    "colorFunction": {
                      "body": "return utils.getProgressColor(data.progress).color;",
                      "modules": {
                        "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                      }
                    }
                  },
                  "iconContainer": "iconContainer4",
                  "icon": "domain"
                },
                "markerImage": {
                  "type": "image",
                  "image": "/assets/markers/shape1.svg",
                  "imageSize": 34
                },
                "markerOffsetX": 0.5,
                "markerOffsetY": 1,
                "markerClustering": {
                  "enable": true,
                  "zoomOnClick": true,
                  "maxZoom": null,
                  "maxClusterRadius": 80,
                  "zoomAnimation": true,
                  "showCoverageOnHover": true,
                  "spiderfyOnMaxZoom": false,
                  "chunkedLoad": false,
                  "lazyLoad": true,
                  "useClusterMarkerColorFunction": false,
                  "clusterMarkerColorFunction": null
                }
              }
            ],
            "polygons": [],
            "circles": [],
            "additionalDataSources": [
              {
                "dsType": "entity",
                "dsLabel": "",
                "dataKeys": [
                  {
                    "name": "latitude",
                    "type": "attribute",
                    "label": "selectedProject",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.5634367819170003,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  }
                ],
                "dsEntityAliasId": "faef915b-be60-5c6b-d62c-114957e80421"
              },
              {
                "dsType": "entity",
                "dsLabel": "",
                "dataKeys": [
                  {
                    "name": "role",
                    "type": "attribute",
                    "label": "role",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.7014478669430672
                  },
                  {
                    "name": "displayAbortedMeasurement",
                    "type": "attribute",
                    "label": "displayAbortedMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8011587598224269
                  },
                  {
                    "name": "displayActiveMeasurement",
                    "type": "attribute",
                    "label": "displayActiveMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8205299052205228
                  },
                  {
                    "name": "displayFinishedMeasurement",
                    "type": "attribute",
                    "label": "displayFinishedMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.038665901375789624
                  },
                  {
                    "name": "displayPreparationMeasurement",
                    "type": "attribute",
                    "label": "displayPreparationMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.21373032656145663
                  }
                ],
                "dsEntityAliasId": "203b0867-b867-ef98-1791-03046c133b7d"
              }
            ],
            "controlsPosition": "topleft",
            "zoomActions": [
              "scroll",
              "doubleClick",
              "controlButtons"
            ],
            "scales": [
              "metric"
            ],
            "dragModeButton": true,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "defaultCenterPosition": "0,0",
            "defaultZoomLevel": null,
            "mapPageSize": 16384,
            "mapActionButtons": [
              {
                "label": "Filter",
                "icon": "filter_alt",
                "color": "#0000008A",
                "action": {
                  "type": "openDashboardState",
                  "targetDashboardStateId": "Measurement_state_filter",
                  "setEntityId": true,
                  "stateEntityParamName": null,
                  "openRightLayout": false,
                  "popoverPreferredPlacement": "top",
                  "popoverHideOnClickOutside": true,
                  "popoverHideDashboardToolbar": true,
                  "popoverWidth": "300px",
                  "popoverHeight": "250px",
                  "popoverStyle": {
                    "padding": "16px",
                    "borderRadius": "8px",
                    "boxShadow": "0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",
                    "background": "#ffffff"
                  },
                  "openInSeparateDialog": false,
                  "openInPopover": true
                }
              }
            ],
            "background": {
              "type": "color",
              "color": "#fff",
              "overlay": {
                "enabled": false,
                "color": "rgba(255,255,255,0.72)",
                "blur": 3
              }
            },
            "padding": "8px"
          },
          "title": "Map",
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "showTitleIcon": false,
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": true,
          "widgetStyle": {},
          "widgetCss": "",
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "configMode": "advanced",
          "titleFont": null,
          "titleColor": null,
          "margin": "0px",
          "borderRadius": "8px",
          "iconSize": "24px",
          "titleIcon": "map",
          "iconColor": "#1F6BDD",
          "actions": {
            "headerButton": []
          },
          "enableDataExport": false
        },
        "row": 0,
        "col": 0,
        "id": "03ceaaed-0eb5-4d4e-a3ef-0c4394cb2cb8"
      },
      "65f06cd0-359d-d0bf-f7aa-8f4700ea7d44": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "state",
                  "type": "attribute",
                  "label": "state",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.8057369620518648
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.49953012506084726
                },
                {
                  "name": "active",
                  "type": "attribute",
                  "label": "active",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.21088975870489435
                },
                {
                  "name": "type",
                  "type": "entityField",
                  "label": "Type",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.5157976480659352
                },
                {
                  "name": "batteryLevel",
                  "type": "timeseries",
                  "label": "batteryLevel",
                  "color": "#607d8b",
                  "settings": {},
                  "_hash": 0.1659349558331873
                },
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "progress",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.20684451568213258,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "locationName",
                  "type": "attribute",
                  "label": "locationName",
                  "color": "#8bc34a",
                  "settings": {},
                  "_hash": 0.5554495301365088
                },
                {
                  "name": "installationType",
                  "type": "attribute",
                  "label": "installationType",
                  "color": "#3f51b5",
                  "settings": {},
                  "_hash": 0.821480189837247
                },
                {
                  "name": "measurementType",
                  "type": "attribute",
                  "label": "measurementType",
                  "color": "#e91e63",
                  "settings": {},
                  "_hash": 0.31692184501390863
                },
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "address",
                  "color": "#ffeb3b",
                  "settings": {},
                  "_hash": 0.14141450952611212
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678196817440,
                "endTimeMs": 1678283217440
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "# Markdown/HTML card \\n - **Current entity**: **${entityName}**. \\n - **Current value**: **${Random}**.",
            "markdownTextFunction": {
              "body": "var name, label, address, progress;\nif (data && data.length) {\n    name = data[0]['entityName'] || 'N/A';\n    label = data[0]['Label'] || 'N/A';\n    address = data[0]['address'] || 'N/A';\n    progress = data[0]['progress'] || 'N/A';\n} else {\n    name = 'N/A';\n    label = 'N/A';\n    address = 'N/A';\n    progress = 'N/A';\n}\n\n// Project Wizard style header with Go Back and Project Wizard buttons\nvar header = '<div class=\"project-header\" style=\"display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px;\">' +\n  '<div style=\"display: flex; flex-direction: column; gap: 4px;\">' +\n    '<div style=\"display: flex; align-items: center; gap: 12px;\">' +\n      '<span style=\"font-weight: 600; font-size: 16px; color: #333;\">' + name + '</span>' +\n      '<span style=\"font-size: 13px; color: #666;\">' + label + '</span>' +\n    '</div>' +\n    '<div style=\"display: flex; align-items: center; gap: 12px; margin-top: 4px;\">' +\n      '<div style=\"display: flex; align-items: center; gap: 8px;\">' +\n        '<mat-icon style=\"font-size: 16px; width: 16px; height: 16px; color: #666;\">location_on</mat-icon>' +\n        '<span style=\"font-size: 12px; color: #666;\">' + address + '</span>' +\n      '</div>' +\n      '<div style=\"margin-left: 16px;\">' + utils.getProgressHtml(progress) + '</div>' +\n    '</div>' +\n  '</div>' +\n  '<div style=\"display: flex; align-items: center; gap: 8px;\">' +\n    '<button id=\"go-back\" type=\"button\" mat-raised-button class=\"header-btn-secondary\">' +\n      '<mat-icon>arrow_back</mat-icon>' +\n      '<span>{i18n:custom.diagnostics.action.go-back.title}</span>' +\n    '</button>' +\n    '<button id=\"open-project-wizard\" type=\"button\" mat-raised-button class=\"header-btn-primary\">' +\n      '<mat-icon>rocket_launch</mat-icon>' +\n      '<span>Project Wizard</span>' +\n    '</button>' +\n  '</div>' +\n'</div>';\n\nreturn header;\n",
              "modules": {
                "clientUtils": "tb-resource;/api/resource/js_module/tenant/client-utils.js",
                "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
              }
            },
            "applyDefaultMarkdownStyle": false,
            "markdownCss": ".project-header {\n    background: #fafafa !important;\n    border: 1px solid #e0e0e0 !important;\n    border-radius: 8px !important;\n}\n.project-header .header-btn-primary {\n    background-color: var(--tb-primary-500) !important;\n    color: white !important;\n}\n.project-header .header-btn-primary:hover {\n    background-color: var(--tb-primary-600) !important;\n}\n.project-header .header-btn-secondary {\n    background-color: var(--tb-primary-500) !important;\n    color: white !important;\n}\n.project-header .header-btn-secondary:hover {\n    background-color: var(--tb-primary-600) !important;\n}"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "37e5e007-da10-e64c-be1e-899094481e42",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\n\nparams['selectedProject'] = null;\nparams['targetStateParameter'] = null;\n\nparams = {\n    \"userRole\": params.userRole\n};\n\nwidgetContext.stateController.updateState(null, params);"
              },
              {
                "name": "settings",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "const targetElement = $($event.target).closest('#settings', widgetContext.$container[0]);\n\nvar type = decodeURIComponent($(targetElement).attr('data-device-type'));\n\nvar stateId = getSettingsState(type);\n\nvar params = {\n    selectedDevice: {\n        entityId: entityId,\n        entityName: entityName,\n        entityLabel: entityLabel,\n    },\n    targetEntityParamName: 'selectedDevice'\n};\n\nwidgetContext.actionsApi.openDashboardStateInPopover($event, stateId, params, true, 'bottomRight', true, '400px', getSettingsHeight(type));\n\nfunction getSettingsState(type) {\n    switch (type) {\n        case 'P-Flow D116':\n            return 'pflow_settings';\n        case 'Room Sensor T':            \n            return 'roomsensort_settings';\n        case 'Room Sensor CO2':            \n            return 'roomsensorco2_settings';                      \n        case 'Door Sensor':\n            return 'door_settings';\n        case 'Motion Sensor':\n            return 'motion_sensor_settings';\n        case 'Occupancy Sensor':\n            return 'occupancy_sensor_settings';\n        default:\n            return 'unknown_settings';\n    }\n}\n\nfunction getSettingsHeight(type) {\n    switch (type) {\n        case 'P-Flow D116':\n            return '800px';\n        case 'Room Sensor T':            \n            return '600px';\n        case 'Room Sensor CO2':            \n            return '800px';                  \n        case 'Door Sensor':\n            return '500px';\n        case 'Motion Sensor':\n            return '340px';\n        case 'Occupancy Sensor':\n            return '500px';\n        default:\n            return '35vh';\n    }\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "076da598-f2dc-6fda-6744-db268a4c6df7"
              },
              {
                "name": "battery-level",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "battery_level_details",
                "setEntityId": true,
                "stateEntityParamName": "selectedDevice",
                "openRightLayout": false,
                "popoverPreferredPlacement": "bottomRight",
                "popoverHideOnClickOutside": true,
                "popoverHideDashboardToolbar": true,
                "popoverWidth": "500px",
                "popoverHeight": "300px",
                "popoverStyle": {},
                "openInSeparateDialog": false,
                "openInPopover": true,
                "id": "44417062-4a4f-0479-0042-93952e15436a"
              },
              {
                "name": "details-full",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = {\n    selectedMeasurement: {\n        entityId: entityId,\n        entityName: entityName,\n        entityLabel: entityLabel,\n    },\n    targetEntityParamName: 'selectedMeasurement'\n};\n\n// Navigate to measurement_dashboard - the markdown widget there handles the conditional display\nwidgetContext.stateController.openState('measurement_dashboard', params, true);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1532b4d5-2d3c-872e-57ed-d477f9b2e502"
              },
              {
                "name": "details-day",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "const targetElement = $($event.target).closest('#details-day', widgetContext.$container[0]);\n\nvar type = decodeURIComponent($(targetElement).attr('data-device-type'));\n\nvar stateId = getDeviceState(type);\n\nvar params = {\n    selectedDevice: {\n        entityId: entityId,\n        entityName: entityName,\n        entityLabel: entityLabel,\n    },\n    targetEntityParamName: 'selectedDevice'\n};\n\nwidgetContext.actionsApi.openDashboardStateInPopover($event, stateId, params, true, 'bottomRight', true, '1600px', getDeviceHeight(type));\n\nfunction getDeviceState(type) {\n    switch (type) {\n        case 'P-Flow D116':\n            return 'pflow_details_full';\n        case 'Room Sensor T':            \n            return 'roomsensort_details_full';\n        case 'Room Sensor CO2':            \n            return 'roomsensorco2_details_full';                      \n        case 'Door Sensor':\n            return 'door_details_full';\n        case 'Motion Sensor':\n            return 'motion_details_full';\n        case 'Occupancy Sensor':\n            return 'occupancy_details_fulls';\n        default:\n            return 'unknown_settings';\n    }\n}\n\nfunction getDeviceHeight(type) {\n    switch (type) {\n        case 'P-Flow D116':\n            return '1000px';\n        case 'Room Sensor T':            \n            return '1000px';\n        case 'Room Sensor CO2':            \n            return '1000px';                  \n        case 'Door Sensor':\n            return '1000px';\n        case 'Motion Sensor':\n            return '1000px';\n        case 'Occupancy Sensor':\n            return '1000px';\n        default:\n            return '35vh';\n    }\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1831fd41-86a5-53ac-1e1b-ab4f23f60807"
              },
              {
                "name": "measurement-parameters",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "modules": {
                  "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js"
                },
                "customFunction": "const measurementId = widgetContext.stateController.getStateParams()?.selectedMeasurement?.entityId;\n\nif (!measurementId || !measurementId.id) {\n    console.error('No measurement selected');\n    return;\n}\n\nprojectWizard.openMeasurementParametersDialog(widgetContext, measurementId);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "a066a7c4-4bbb-d780-315e-af760f5b1e4e"
              },
              {
                "name": "sensor-data",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "sensor_data",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "301c8f82-5367-e4eb-a578-ca81965b5e9a"
              },
              {
                "name": "open-project-wizard",
                "icon": "assignment",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": {
                  "body": "var stateParams = widgetContext.stateController.getStateParams();\nvar selectedProject = stateParams ? stateParams.selectedProject : null;\n\nif (selectedProject && selectedProject.entityId) {\n    projectWizard.openProjectWizardDialog(widgetContext, selectedProject.entityId, selectedProject.entityName, selectedProject.entityLabel, function() { widgetContext.updateAliases(); }, { dataImporter: dataImporter });\n} else {\n    console.error('No project selected');\n}",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                    "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "project-wizard-action-1769529175158"
              }
            ],
            "headerButton": []
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "65f06cd0-359d-d0bf-f7aa-8f4700ea7d44",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "4ebd4327-6b2e-432c-9f12-5d87a6ca7e76": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678196817440,
                "endTimeMs": 1678283217440
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": false,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "entitiesTitle": "{i18n:custom.diagnostics.measurements.title}",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "false",
            "displayEntityName": true,
            "entityNameColumnTitle": "{i18n:custom.diagnostics.measurement-name.title}",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "pageStepCount": 3,
            "pageStepIncrement": 10,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "{i18n:custom.diagnostics.measurements.title}",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "c849d52c-a3c7-5008-a4c0-c2d0406fe515",
              "filterId": "8366ab5b-1381-2841-d917-ec7a70bd8d7c",
              "dataKeys": [
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.measurement-address.title}",
                  "color": "#ffc107",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "hidden",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5439377495268714,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.8686344328279582
                },
                {
                  "name": "state",
                  "type": "attribute",
                  "label": "{i18n:entity-field.state}",
                  "color": "#ffc107",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "20%",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var state = value;\n\nvar stateSvg = getStateSvg(state);\nvar encodedStateSvg = encodeURIComponent(stateSvg);\nvar stateSvgUrl = 'data:image/svg+xml,' + encodedStateSvg;\nvar stateLabel = getStateLabel(state);\n\nreturn '<span>'+\n           '<img style=\"vertical-align: middle;\" class=\"mat-icon\" src=\"'+ stateSvgUrl +'\">' +\n           '<span style=\"vertical-align: middle; padding-left: 8px;\">'+ stateLabel +'</span>' +\n       '</span>';\n            \nfunction getStateSvg(state) {\n    switch (state) {\n        case 'critical':\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#E64A19\"/>' +\n                   '</svg>';\n        case 'major':            \n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#D5C21B\"/>' +\n                   '</svg>';\n        case 'normal':            \n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#1F8B4D\"/>' +\n                   '</svg>';\n        default:\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#AAAAAA\"/>' +\n                   '</svg>';\n    }\n}\n\nfunction getStateLabel(state) {\n    switch(state) {\n        case 'critical':\n            return 'Critical';\n        case 'major':\n            return 'Major';\n        case 'normal':\n            return 'Normal';\n        default:\n            return state;\n    }\n}\n",
                    "defaultColumnVisibility": "hidden",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.2718881518921066,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.measurement-progress.title}",
                  "color": "#ffc107",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": {
                      "body": "return utils.getProgressHtml(value);",
                      "modules": {
                        "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                      }
                    },
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.6466565617082951,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "measurementType",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.measurement-type.title}",
                  "color": "#607d8b",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": {
                      "body": "return utils.getMeasurementTypeHtml(value);",
                      "modules": {
                        "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                      }
                    },
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.011120189088471788,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "div.tb-widget .tb-widget-title {\n    max-height: 100px !important;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "rowClick": [
              {
                "name": "Selected Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = {\n    selectedMeasurement: {\n        entityId: entityId,\n        entityName: entityName,\n        entityLabel: entityLabel,\n    },\n    targetEntityParamName: 'selectedMeasurement'\n};\n\n// Navigate to measurement_dashboard - the markdown widget there handles the conditional display\nwidgetContext.stateController.openState('measurement_dashboard', params, true);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "27b78a0c-3e2d-8d90-72dd-10f9f80351b5"
              }
            ],
            "actionCellButton": [
              {
                "id": "measurement-info-action",
                "name": "Live Data",
                "icon": "sensors",
                "type": "custom",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "customFunction": {
                  "body": "const measurementId = entityId;\nprojectWizard.openMeasurementInfoDialog(widgetContext, measurementId);",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false
              },
              {
                "name": "Connect Measurement",
                "icon": "add_chart",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var progress = data.Progress || data.progress;\nvar isUltrasonic = data['Measurement Type'] === 'ultrasonic';\nreturn isUltrasonic && (progress === 'in preparation' || progress === 'planned');",
                "type": "custom",
                "customFunction": {
                  "body": "utils.dataConnectorDialog(widgetContext, entityId, entityName);",
                  "modules": {
                    "utils": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "c020f915-da89-ba7e-5aaa-49066cf1451c"
              },
              {
                "name": "{i18n:custom.diagnostics.action.measurement-parameters}",
                "icon": "settings",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\r\n/*console.log(widgetContext.stateController.getStateParams());\r\nconsole.log(\"user role:\", userRole);*/\r\n        \r\nif (userRole !== 'Belimo Retrofit Users') {\r\n    return true;\r\n} else {\r\n    return false;\r\n}\r\n    \r\n    /*return (userRoleValue !== 'Belimo Retrofit Users');*/\r\n    \r\n\r\n   \r\n\r\n \r\n",
                "type": "custom",
                "customFunction": {
                  "body": "const measurementId = entityId;\n\nif (!measurementId || !measurementId.id) {\n    console.error(\"No measurement selected\");\n    return;\n}\n\nprojectWizard.openMeasurementParametersDialog(widgetContext, measurementId);",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e9d60eaa-56f8-bbfb-45db-110033a2739a"
              },
              {
                "id": "delete-measurement-1769460037673",
                "name": "Delete Measurement",
                "icon": "delete",
                "type": "custom",
                "customFunction": {
                  "body": "const measurementId = entityId;\nconst measurementName = entityName || entityLabel || 'this measurement';\n\nif (!measurementId || !measurementId.id) {\n    console.error(\"No measurement selected\");\n    return;\n}\n\nprojectWizard.deleteMeasurement(widgetContext, measurementId, measurementName);",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js"
                  }
                }
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.diagnostics.action.go-back.title}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\n/*var number = (widgetContext.stateController.getStateIndex())-1;*/\r\n\r\nparams['selectedProject'] = null;\r\nparams['targetStateParameter'] = null;\r\n\r\nparams = {\r\n    \"userRole\": params.userRole\r\n};\r\n\r\nwidgetContext.stateController.updateState(null,params);\r\n/*widgetContext.stateController.navigatePrevState(number);*/",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "3ef7bac7-ead3-49d4-a2aa-1b80aae1b476"
              },
              {
                "name": "Measurement",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": {
                  "body": "const stateParams = widgetContext.stateController.getStateParams();\nconst selectedProject = stateParams.selectedProject;\n\nif (!selectedProject || !selectedProject.entityId || !selectedProject.entityId.id) {\n    console.error('No project selected. Please select a project first.');\n    return;\n}\n\nconst projectId = { id: selectedProject.entityId.id, entityType: 'ASSET' };\nconst projectName = selectedProject.entityName;\n\n// Determine customerId\nconst NULL_UUID = '13814000-1dd2-11b2-8080-808080808080';\nfunction isValidCustomerId(id) {\n    return id && id !== NULL_UUID;\n}\n\nconst userRole = stateParams.userRole;\nconst stateEntityId = stateParams.entityId;\nlet customerId;\n\nif ((widgetContext.currentUser.authority === 'TENANT_ADMIN' || userRole === 'ECO Administrator') && stateEntityId && stateEntityId.id && isValidCustomerId(stateEntityId.id)) {\n    customerId = stateEntityId;\n    openDialog();\n} else if (isValidCustomerId(widgetContext.currentUser.customerId)) {\n    customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\n    openDialog();\n} else {\n    // Fetch customerId from project asset\n    const $injector = widgetContext.$scope.$injector;\n    const assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n    assetService.getAsset(projectId.id).subscribe(projectAsset => {\n        if (projectAsset && projectAsset.customerId && isValidCustomerId(projectAsset.customerId.id)) {\n            customerId = projectAsset.customerId;\n            openDialog();\n        } else {\n            console.error('Cannot determine customerId. Project has no valid customer assigned.');\n        }\n    });\n}\n\nfunction openDialog() {\n    projectWizard.openAddMeasurementDialog(widgetContext, projectId, projectName, customerId, function(result) {\n        // Update state params with new measurement\n        const params = widgetContext.stateController.getStateParams();\n        params['selectedMeasurement'] = {\n            entityId: result.id,\n            entityName: result.name,\n            entityLabel: result.label || ''\n        };\n        widgetContext.updateAliases();\n        \n        // If connectKit checkbox was checked and it's ultrasonic, open connect dialog\n        if (result.connectKit && result.measurementType === 'ultrasonic') {\n            dataImporter.dataConnectorDialog(widgetContext, result.id, result.name);\n        }\n    });\n}",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                    "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "6f6daae0-99ef-3112-baf1-9e8e6cc178b2"
              }
            ]
          },
          "titleIcon": "devices_other",
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "28px",
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "4ebd4327-6b2e-432c-9f12-5d87a6ca7e76",
        "typeFullFqn": "system.cards.entities_table"
      },
      "fb924e54-6e4b-2d41-5545-dab85e028210": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": false,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "{i18n:custom.diagnostics.projects.title}",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "false",
            "displayEntityName": true,
            "entityNameColumnTitle": "{i18n:custom.diagnostics.project-id.title}",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": false,
            "defaultPageSize": 10,
            "pageStepCount": 3,
            "pageStepIncrement": 10,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "{i18n:custom.diagnostics.projects.title}",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "d75c5b86-8b39-59e2-59f3-ae1c1ee40910",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "{i18n:custom.diagnostics.project-name.title}",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.23547368231999988,
                  "decimals": 0,
                  "aggregationType": null,
                  "units": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.project-address.title}",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "hidden",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.8348661406382081,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": false,
                  "postFuncBody": null
                },
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.project-progress.title}",
                  "color": "#f44336",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": {
                      "body": "return utils.getProgressHtml(value);",
                      "modules": {
                        "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                      }
                    },
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.15334267783981326,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "generalReport",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.project-report.title}",
                  "color": "#ffc107",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar description;\r\nvar generalReport = value;\r\nvar status;\r\nif (generalReport == 'true') { // all key values here are strings\r\n  color = '#27AE60';\r\n  status = 'paid';\r\n  description = '{i18n:custom.diagnostics.report-status.paid.title}';\r\n} else {\r\n  color = '#EB5757';\r\n  status = 'inactive';\r\n  description = '{i18n:custom.diagnostics.report-status.inactive.title}';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span>'+ ' ' + description;",
                    "defaultColumnVisibility": "hidden",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.47896411690699625,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "assignedKit",
                  "type": "attribute",
                  "label": "assignedKit",
                  "color": "#607d8b",
                  "settings": {},
                  "_hash": 0.6930228824112628
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "Select Project",
                "icon": "more_horiz",
                "type": "openDashboardState",
                "targetDashboardStateId": "manage_projects",
                "setEntityId": true,
                "stateEntityParamName": "selectedProject",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "a7ad4745-1f21-49fd-38f4-70825fe6875f"
              }
            ],
            "actionCellButton": [
              {
                "name": "Edit Project",
                "icon": "edit",
                "useShowWidgetActionFunction": false,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #editProjectForm=\"ngForm\" [formGroup]=\"editProjectFormGroup\"\n      (ngSubmit)=\"save()\" class=\"edit-project-form\" style=\"width: 600px; max-width: 90vw;\">\n  <mat-toolbar class=\"flex items-center\" color=\"primary\">\n    <mat-icon style=\"margin-right: 12px;\">edit</mat-icon>\n    <h2 style=\"margin: 0; font-size: 18px;\">Edit Project</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col gap-3 p-4\">\n\n    <!-- Customer Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">business</mat-icon>\n        Customer\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full disabled-field\">\n        <mat-label>Customer</mat-label>\n        <input matInput formControlName=\"customerName\" readonly>\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Project Info Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">folder</mat-icon>\n        Project Info\n      </legend>\n      <tb-image-input formControlName=\"projectPicture\" label=\"Project Picture\" noImageText=\"No picture selected\"></tb-image-input>\n      <mat-form-field appearance=\"fill\" class=\"w-full disabled-field\">\n        <mat-label>Project ID</mat-label>\n        <input matInput formControlName=\"name\" readonly>\n      </mat-form-field>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Label</mat-label>\n        <input matInput formControlName=\"entityLabel\">\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Address Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">location_on</mat-icon>\n        Address\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Project address</mat-label>\n        <input matInput formControlName=\"address\" [matAutocomplete]=\"addrAuto\" autocomplete=\"off\">\n        <button mat-icon-button matSuffix type=\"button\" (click)=\"searchAddress()\" [disabled]=\"(editProjectFormGroup.get('address').value || '').length < 5\">\n          <mat-icon>search</mat-icon>\n        </button>\n        <mat-autocomplete #addrAuto=\"matAutocomplete\" [displayWith]=\"displayAddressOption\" (optionSelected)=\"onAddressSelected($event.option.value)\">\n          <mat-option *ngFor=\"let opt of addressOptions\" [value]=\"opt\">{{ opt.label }}</mat-option>\n        </mat-autocomplete>\n        <mat-hint *ngIf=\"(editProjectFormGroup.get('address').value || '').length < 5\">Enter at least 5 characters to search</mat-hint>\n      </mat-form-field>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Postal Code</mat-label>\n          <input matInput formControlName=\"postalCode\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 2;\">\n          <mat-label>City</mat-label>\n          <input matInput formControlName=\"city\">\n        </mat-form-field>\n      </div>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Latitude</mat-label>\n          <input matInput formControlName=\"latitude\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Longitude</mat-label>\n          <input matInput formControlName=\"longitude\">\n        </mat-form-field>\n      </div>\n    </fieldset>\n\n    <!-- Status Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">timeline</mat-icon>\n        Status\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Progress</mat-label>\n        <mat-select formControlName=\"progress\">\n          <mat-option value=\"in preparation\">In Preparation</mat-option>\n          <mat-option value=\"active\">Active</mat-option>\n          <mat-option value=\"finished\">Finished</mat-option>\n          <mat-option value=\"aborted\">Aborted</mat-option>\n        </mat-select>\n      </mat-form-field>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1.5;\">\n          <mat-label>Start Date</mat-label>\n          <mat-datetimepicker-toggle [for]=\"startDatePicker\" matPrefix></mat-datetimepicker-toggle>\n          <mat-datetimepicker #startDatePicker type=\"date\" openOnFocus=\"true\"></mat-datetimepicker>\n          <input matInput formControlName=\"startDate\" [matDatetimepicker]=\"startDatePicker\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Start Time</mat-label>\n          <mat-datetimepicker-toggle [for]=\"startTimePicker\" matPrefix></mat-datetimepicker-toggle>\n          <mat-datetimepicker #startTimePicker type=\"time\" openOnFocus=\"true\"></mat-datetimepicker>\n          <input matInput formControlName=\"startTime\" [matDatetimepicker]=\"startTimePicker\">\n        </mat-form-field>\n      </div>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1.5;\">\n          <mat-label>End Date</mat-label>\n          <mat-datetimepicker-toggle [for]=\"endDatePicker\" matPrefix></mat-datetimepicker-toggle>\n          <mat-datetimepicker #endDatePicker type=\"date\" openOnFocus=\"true\"></mat-datetimepicker>\n          <input matInput formControlName=\"endDate\" [matDatetimepicker]=\"endDatePicker\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>End Time</mat-label>\n          <mat-datetimepicker-toggle [for]=\"endTimePicker\" matPrefix></mat-datetimepicker-toggle>\n          <mat-datetimepicker #endTimePicker type=\"time\" openOnFocus=\"true\"></mat-datetimepicker>\n          <input matInput formControlName=\"endTime\" [matDatetimepicker]=\"endTimePicker\">\n        </mat-form-field>\n      </div>\n    </fieldset>\n\n  </div>\n  <div class=\"flex justify-end items-center gap-2 p-4\" style=\"border-top: 1px solid #e0e0e0; background: #fafafa;\">\n    <button mat-button (click)=\"cancel()\" type=\"button\">Cancel</button>\n    <button mat-raised-button color=\"primary\" type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editProjectFormGroup.invalid || !editProjectFormGroup.dirty\">\n      <mat-icon style=\"font-size: 18px; width: 18px; height: 18px; margin-right: 4px;\">save</mat-icon>\n      Save\n    </button>\n  </div>\n</form>",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled,\n.edit-project-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form .mdc-text-field--filled:not(.mdc-text-field--disabled),\n.edit-project-form .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .disabled-field input,\n.edit-project-form .disabled-field input {\n  color: rgba(0, 0, 0, 0.6) !important;\n}\n\n.add-entity-form .disabled-field,\n.edit-project-form .disabled-field {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\nmat-icon {\n  vertical-align: middle;\n  margin-right: 4px;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\n\n// Load project data and open dialog\nassetService.getAsset(entityId.id).subscribe(project => {\n    // Load project attributes (including status fields)\n    attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE',\n        ['latitude', 'longitude', 'address', 'postalCode', 'city', 'projectPicture', 'progress', 'startTimeMs', 'endTimeMs']\n    ).subscribe(attributes => {\n        const attrMap = {};\n        attributes.forEach(a => { attrMap[a.key] = a.value; });\n\n        // Load customer name\n        if (project.customerId && project.customerId.id) {\n            customerService.getCustomer(project.customerId.id).subscribe(customer => {\n                openEditProjectDialog(project, attrMap, customer ? customer.name : 'Unknown');\n            });\n        } else {\n            openEditProjectDialog(project, attrMap, 'Unknown');\n        }\n    });\n});\n\nfunction openEditProjectDialog(project, attrMap, customerName) {\n    customDialog.customDialog(htmlTemplate, EditProjectDialogController).subscribe();\n\n    function EditProjectDialogController(instance) {\n        let vm = instance;\n\n        vm.project = project;\n        vm.attrMap = attrMap;\n\n        // Initialize date values from timestamps\n        let startDate = null;\n        let startTime = null;\n        let endDate = null;\n        let endTime = null;\n\n        if (attrMap.startTimeMs) {\n            const startDateTime = new Date(Number(attrMap.startTimeMs));\n            startDate = startDateTime;\n            startTime = startDateTime;\n        }\n        if (attrMap.endTimeMs) {\n            const endDateTime = new Date(Number(attrMap.endTimeMs));\n            endDate = endDateTime;\n            endTime = endDateTime;\n        }\n\n        vm.editProjectFormGroup = vm.fb.group({\n            customerName: [{ value: customerName, disabled: true }],\n            name: [{ value: project.name, disabled: true }],\n            entityLabel: [project.label || ''],\n            projectPicture: [attrMap.projectPicture || null],\n            // Status fields\n            progress: [attrMap.progress || 'in preparation'],\n            startDate: [startDate],\n            startTime: [startTime],\n            endDate: [endDate],\n            endTime: [endTime],\n            // Address fields\n            address: [attrMap.address || ''],\n            postalCode: [attrMap.postalCode || ''],\n            city: [attrMap.city || ''],\n            latitude: [attrMap.latitude || ''],\n            longitude: [attrMap.longitude || '']\n        });\n\n        // Auto-set start/end time when progress changes\n        vm.editProjectFormGroup.get('progress').valueChanges.subscribe(function(progress) {\n            const startDateControl = vm.editProjectFormGroup.get('startDate');\n            const startTimeControl = vm.editProjectFormGroup.get('startTime');\n            const endDateControl = vm.editProjectFormGroup.get('endDate');\n            const endTimeControl = vm.editProjectFormGroup.get('endTime');\n\n            if (progress === 'active' && !startDateControl.value && !startTimeControl.value) {\n                const now = new Date();\n                startDateControl.setValue(now);\n                startTimeControl.setValue(now);\n                startDateControl.markAsDirty();\n                startTimeControl.markAsDirty();\n            }\n\n            if ((progress === 'finished' || progress === 'aborted') && !endDateControl.value && !endTimeControl.value) {\n                const now = new Date();\n                endDateControl.setValue(now);\n                endTimeControl.setValue(now);\n                endDateControl.markAsDirty();\n                endTimeControl.markAsDirty();\n            }\n        });\n\n        // --- Address search state ---\n        vm.addressOptions = [];\n        vm._lastSelectedAddressLabel = null;\n\n        vm.displayAddressOption = function(opt) {\n            if (!opt) return '';\n            return (typeof opt === 'string') ? opt : (opt.label || '');\n        };\n\n        vm.searchAddress = function() {\n            const qRaw = vm.editProjectFormGroup.get('address').value || '';\n            const q = (typeof qRaw === 'string') ? qRaw.trim() : vm.displayAddressOption(qRaw).trim();\n            if (q.length < 5) {\n                vm.addressOptions = [];\n                return;\n            }\n            searchAddressViaPhoton(q);\n        };\n\n        vm.onAddressSelected = function(opt) {\n            if (!opt) return;\n            vm._lastSelectedAddressLabel = opt.label;\n\n            const patchData = {\n                address: opt.label,\n                latitude: opt.lat,\n                longitude: opt.lon\n            };\n\n            const currentPostalCode = (vm.editProjectFormGroup.get('postalCode').value || '').trim();\n            const currentCity = (vm.editProjectFormGroup.get('city').value || '').trim();\n\n            if (!currentPostalCode && opt.postcode) {\n                patchData.postalCode = opt.postcode;\n            }\n            if (!currentCity && opt.city) {\n                patchData.city = opt.city;\n            }\n\n            vm.editProjectFormGroup.patchValue(patchData);\n            vm.editProjectFormGroup.get('address').markAsDirty();\n            vm.editProjectFormGroup.get('latitude').markAsDirty();\n            vm.editProjectFormGroup.get('longitude').markAsDirty();\n\n            if (!currentPostalCode && opt.postcode) {\n                vm.editProjectFormGroup.get('postalCode').markAsDirty();\n            }\n            if (!currentCity && opt.city) {\n                vm.editProjectFormGroup.get('city').markAsDirty();\n            }\n\n            vm.addressOptions = [];\n        };\n\n        // --- Debounced auto-search ---\n        let addrTimer = null;\n        let lastQuery = '';\n\n        vm.editProjectFormGroup.get('address').valueChanges.subscribe(val => {\n            if (typeof val === 'string' && vm._lastSelectedAddressLabel && val === vm._lastSelectedAddressLabel) {\n                return;\n            }\n\n            const s = (typeof val === 'string')\n                ? val.trim()\n                : (vm.displayAddressOption(val) || '').trim();\n\n            if (s.length < 5) {\n                vm.addressOptions = [];\n                lastQuery = s;\n                if (addrTimer) {\n                    clearTimeout(addrTimer);\n                    addrTimer = null;\n                }\n                return;\n            }\n\n            if (s === lastQuery) return;\n            lastQuery = s;\n\n            if (addrTimer) clearTimeout(addrTimer);\n            addrTimer = setTimeout(() => {\n                searchAddressViaPhoton(s);\n            }, 350);\n        });\n\n        function searchAddressViaPhoton(query) {\n            const postalCode = (vm.editProjectFormGroup.get('postalCode').value || '').trim();\n            const city = (vm.editProjectFormGroup.get('city').value || '').trim();\n\n            let refinedQuery = query;\n            if (postalCode) refinedQuery += ' ' + postalCode;\n            if (city) refinedQuery += ' ' + city;\n\n            const url = 'https://photon.komoot.io/api?q=' + encodeURIComponent(refinedQuery) + '&limit=5';\n\n            fetch(url)\n                .then(res => {\n                    if (!res.ok) throw new Error('HTTP ' + res.status);\n                    return res.json();\n                })\n                .then(data => {\n                    const features = (data && data.features) ? data.features : [];\n                    vm.addressOptions = features.map(f => {\n                        const p = f.properties || {};\n                        const coords = (f.geometry && f.geometry.coordinates) ? f.geometry.coordinates : [null, null];\n                        const lon = coords[0];\n                        const lat = coords[1];\n\n                        const street = p.street || p.name || '';\n                        const house = p.housenumber ? (' ' + p.housenumber) : '';\n                        const place = (street + house).trim() || (p.label || p.name || '').trim();\n\n                        const cc = (p.countrycode || '').toUpperCase();\n                        const postcode = p.postcode || '';\n                        const cityFromResult = p.city || p.town || p.village || p.state || '';\n\n                        let tail = '';\n                        if (cc || postcode || cityFromResult) {\n                            tail = (cc ? cc : '');\n                            if (cc && postcode) tail += '-' + postcode;\n                            else if (!cc && postcode) tail += postcode;\n                            if ((cc || postcode) && cityFromResult) tail += ' ' + cityFromResult;\n                            else if (!cc && !postcode && cityFromResult) tail += cityFromResult;\n                        }\n\n                        const label = tail ? (place + ', ' + tail) : place;\n\n                        return {\n                            label,\n                            lat: (typeof lat === 'number') ? lat : parseFloat(lat),\n                            lon: (typeof lon === 'number') ? lon : parseFloat(lon),\n                            postcode: postcode,\n                            city: cityFromResult,\n                            raw: f\n                        };\n                    });\n                })\n                .catch(err => {\n                    console.error('Address search failed', err);\n                    vm.addressOptions = [];\n                });\n        }\n\n        vm.cancel = function() {\n            vm.dialogRef.close(null);\n        };\n\n        vm.save = function() {\n            vm.editProjectFormGroup.markAsPristine();\n\n            // Update asset label\n            const formValues = vm.editProjectFormGroup.getRawValue();\n            const updatedProject = {\n                ...vm.project,\n                label: formValues.entityLabel\n            };\n\n            assetService.saveAsset(updatedProject).subscribe(() => {\n                // Build startTimeMs and endTimeMs from date/time pickers\n                let startTimeMs = null;\n                let endTimeMs = null;\n\n                if (formValues.startDate) {\n                    const startDateObj = new Date(formValues.startDate);\n                    if (formValues.startTime) {\n                        const startTimeObj = new Date(formValues.startTime);\n                        startDateObj.setHours(startTimeObj.getHours(), startTimeObj.getMinutes(), startTimeObj.getSeconds());\n                    }\n                    startTimeMs = startDateObj.getTime();\n                }\n\n                if (formValues.endDate) {\n                    const endDateObj = new Date(formValues.endDate);\n                    if (formValues.endTime) {\n                        const endTimeObj = new Date(formValues.endTime);\n                        endDateObj.setHours(endTimeObj.getHours(), endTimeObj.getMinutes(), endTimeObj.getSeconds());\n                    }\n                    endTimeMs = endDateObj.getTime();\n                }\n\n                // Save attributes\n                const attributesArray = [\n                    { key: 'latitude', value: formValues.latitude || vm.attrMap.latitude || 48.1406022 },\n                    { key: 'longitude', value: formValues.longitude || vm.attrMap.longitude || 16.2932688 },\n                    { key: 'address', value: formValues.address || '' },\n                    { key: 'postalCode', value: formValues.postalCode || '' },\n                    { key: 'city', value: formValues.city || '' },\n                    { key: 'progress', value: formValues.progress || 'in preparation' }\n                ];\n\n                if (startTimeMs !== null) {\n                    attributesArray.push({ key: 'startTimeMs', value: startTimeMs });\n                }\n                if (endTimeMs !== null) {\n                    attributesArray.push({ key: 'endTimeMs', value: endTimeMs });\n                }\n\n                if (formValues.projectPicture) {\n                    attributesArray.push({ key: 'projectPicture', value: formValues.projectPicture });\n                }\n\n                attributeService.saveEntityAttributes(entityId, 'SERVER_SCOPE', attributesArray).subscribe(() => {\n                    widgetContext.updateAliases();\n                    vm.dialogRef.close(null);\n                });\n            });\n        };\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e8f12b3a-4c5d-9e7f-a1b2-3c4d5e6f7890"
              },
              {
                "name": "Project Wizard",
                "icon": "rocket_launch",
                "useShowWidgetActionFunction": false,
                "showWidgetActionFunction": "return data.progress === 'in preparation' || data.progress === 'active';",
                "type": "customPretty",
                "customHtml": "",
                "customCss": "",
                "customFunction": {
                  "body": "// Use the Project Wizard library with dataImporter for device assignment\nprojectWizard.openProjectWizardDialog(widgetContext, entityId, entityName, entityLabel, function() {\n    widgetContext.updateAliases();\n}, { dataImporter: dataImporter });\n",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                    "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "9848fd08-5b93-6f97-dc69-65e325748065"
              },
              {
                "name": "Delete Project",
                "icon": "delete",
                "type": "custom",
                "customFunction": {
                  "body": "const projectId = entityId;\nconst projectName = entityName;\nutils.deleteProject(widgetContext, projectId, projectName, function() {\n  widgetContext.updateAliases();\n});",
                  "modules": {
                    "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                  }
                },
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole || '';\nvar isTenantAdmin = widgetContext.currentUser.authority === 'TENANT_ADMIN';\nvar isEcoAdmin = userRole === 'ECO Administrator';\nvar isBelimoAdmin = userRole === 'Belimo Retrofit Administrators';\nvar isEcoDiagAdmin = userRole === 'ECO Diagnostics Administrators';\nvar isAdmin = userRole === 'Administrators';\nreturn isTenantAdmin || isEcoAdmin || isBelimoAdmin || isEcoDiagAdmin || isAdmin;",
                "id": "act-delete-project"
              }
            ],
            "headerButton": [
              {
                "name": "Go Back",
                "buttonType": "raised",
                "showIcon": true,
                "icon": "arrow_back",
                "buttonColor": "#ffffff",
                "buttonFillColor": "var(--tb-primary-500)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n/*params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten*/\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "715d95c5-edd0-8a23-af00-6074f1a5717f"
              },
              {
                "name": "Connect",
                "buttonType": "raised",
                "showIcon": true,
                "icon": "addchart",
                "buttonColor": "#ffffff",
                "buttonFillColor": "var(--tb-accent-500)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": {
                  "body": "utils.dataConnectorDialog(widgetContext, entityId, entityName);",
                  "modules": {
                    "utils": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "3c824487-b796-a41c-5d9e-7eca11e18a04"
              },
              {
                "name": "Project",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addProjectFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 600px; max-width: 90vw;\">\n  <mat-toolbar class=\"flex items-center\" color=\"primary\">\n    <mat-icon style=\"margin-right: 12px;\">folder_open</mat-icon>\n    <h2 style=\"margin: 0; font-size: 18px;\">Add Project</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col gap-3 p-4\">\n\n    <!-- Customer Section -->\n    <fieldset *ngIf=\"isTenantAdmin\" class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">business</mat-icon>\n        Customer\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Customer</mat-label>\n        <mat-select formControlName=\"customer\" (selectionChange)=\"onCustomerChange()\" required>\n          <mat-option *ngFor=\"let c of customers\" [value]=\"c\">{{ c.name }}</mat-option>\n        </mat-select>\n        <mat-error *ngIf=\"addProjectFormGroup.get('customer')?.hasError('required')\">Customer is required.</mat-error>\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Project Info Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">folder</mat-icon>\n        Project Info\n      </legend>\n      <tb-image-input formControlName=\"projectPicture\" label=\"Project Picture\" noImageText=\"No picture selected\"></tb-image-input>\n      <mat-form-field appearance=\"fill\" class=\"w-full disabled-field\">\n        <mat-label>Project ID</mat-label>\n        <input matInput formControlName=\"name\" required readonly>\n        <mat-error *ngIf=\"addProjectFormGroup.get('name').hasError('required')\">Project title is required.</mat-error>\n      </mat-form-field>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Label</mat-label>\n        <input matInput formControlName=\"entityLabel\">\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Address Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">location_on</mat-icon>\n        Address\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Project address</mat-label>\n        <input matInput formControlName=\"address\" [matAutocomplete]=\"addrAuto\" autocomplete=\"off\">\n        <button mat-icon-button matSuffix type=\"button\" (click)=\"searchAddress()\" [disabled]=\"(addProjectFormGroup.get('address').value || '').length < 5\">\n          <mat-icon>search</mat-icon>\n        </button>\n        <mat-autocomplete #addrAuto=\"matAutocomplete\" [displayWith]=\"displayAddressOption\" (optionSelected)=\"onAddressSelected($event.option.value)\">\n          <mat-option *ngFor=\"let opt of addressOptions\" [value]=\"opt\">{{ opt.label }}</mat-option>\n        </mat-autocomplete>\n        <mat-hint *ngIf=\"(addProjectFormGroup.get('address').value || '').length < 5\">Enter at least 5 characters to search</mat-hint>\n      </mat-form-field>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Postal Code</mat-label>\n          <input matInput formControlName=\"postalCode\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 2;\">\n          <mat-label>City</mat-label>\n          <input matInput formControlName=\"city\">\n        </mat-form-field>\n      </div>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Latitude</mat-label>\n          <input matInput formControlName=\"latitude\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Longitude</mat-label>\n          <input matInput formControlName=\"longitude\">\n        </mat-form-field>\n      </div>\n    </fieldset>\n\n  </div>\n  <div class=\"flex justify-end items-center gap-2 p-4\" style=\"border-top: 1px solid #e0e0e0; background: #fafafa;\">\n    <button mat-button (click)=\"cancel()\" type=\"button\">Cancel</button>\n    <button mat-raised-button color=\"primary\" type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addProjectFormGroup.invalid || !addProjectFormGroup.dirty\">\n      <mat-icon style=\"font-size: 18px; width: 18px; height: 18px; margin-right: 4px;\">save</mat-icon>\n      Save\n    </button>\n  </div>\n</form>",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled,\n.edit-project-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form .mdc-text-field--filled:not(.mdc-text-field--disabled),\n.edit-project-form .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .disabled-field input,\n.edit-project-form .disabled-field input {\n  color: rgba(0, 0, 0, 0.6) !important;\n}\n\n.add-entity-form .disabled-field,\n.edit-project-form .disabled-field {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\nmat-icon {\n  vertical-align: middle;\n  margin-right: 4px;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\n//let $scope = widgetContext.$scope;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\n\r\nlet shortNameAttr;\r\nlet customerShortName;\r\nlet nextProjectId = 0;\r\n\r\nconst ctx = widgetContext;\r\nconst isTenantAdmin = ctx.currentUser.authority === 'TENANT_ADMIN';\r\n\r\nlet customers = [];\r\nlet customerId;\r\nlet customerName;\r\n\r\nconst pageLink = ctx.pageLink(1000, 0, null, null, null);\r\n\r\ncustomerService.getUserCustomers(pageLink).subscribe(pageData => {\r\n\r\n    customers = (pageData && pageData.data) ? pageData.data : [];\r\n\r\n    // Non-Tenant-Admin → genau ein Customer\r\n    if (!isTenantAdmin && customers.length === 1) {\r\n        const c = customers[0];\r\n        customerId = {\r\n            id: c.id.id,\r\n            entityType: 'CUSTOMER'\r\n        };\r\n        customerName = c.name;\r\n    }\r\n\r\n    openAddProjectDialog();\r\n});\r\n\r\nfunction getLastProjectId(projects) {\r\n    let maxNumber = 0;\r\n    projects.forEach(item => {\r\n        const name = item.name;\r\n        const parts = name.split('_');\r\n        if (parts.length === 2) {\r\n            const number = parseInt(parts[1], 10);\r\n            if (number > maxNumber) {\r\n                maxNumber = number;\r\n            }\r\n        }\r\n    });\r\n    const nextProjectId = maxNumber + 1;\r\n    return nextProjectId;\r\n}\r\n\r\nfunction openAddProjectDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddProjectDialogController).subscribe();\r\n}\r\n\r\nfunction AddProjectDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.isTenantAdmin = isTenantAdmin;\r\n  vm.customers = customers;\r\n\r\nvm.addProjectFormGroup = vm.fb.group({\r\n    customer: [{ value: null, disabled: !isTenantAdmin }, vm.validators.required],\r\n    name: [{ value: '', disabled: true }, vm.validators.required],\r\n    entityLabel: [''],\r\n    projectPicture: [null],\r\n    address: [''],\r\n    postalCode: [''],\r\n    city: [''],\r\n    latitude: [''],\r\n    longitude: ['']\r\n});\r\n\r\n  // --- Address search state ---\r\n  vm.addressOptions = [];\r\n  vm._lastSelectedAddressLabel = null;\r\n\r\n  vm.displayAddressOption = function (opt) {\r\n    // MatAutocomplete calls displayWith with object OR string\r\n    if (!opt) return '';\r\n    return (typeof opt === 'string') ? opt : (opt.label || '');\r\n  };\r\n\r\n  vm.searchAddress = function () {\r\n    const qRaw = vm.addProjectFormGroup.get('address').value || '';\r\n    const q = (typeof qRaw === 'string') ? qRaw.trim() : vm.displayAddressOption(qRaw).trim();\r\n\r\n    if (q.length < 5) {\r\n      vm.addressOptions = [];\r\n      return;\r\n    }\r\n\r\n    searchAddressViaPhoton(q);\r\n  };\r\n\r\n  vm.onAddressSelected = function (opt) {\r\n    if (!opt) return;\r\n\r\n    vm._lastSelectedAddressLabel = opt.label;\r\n\r\n    // Patch-Objekt vorbereiten\r\n    const patchData = {\r\n      address: opt.label,\r\n      latitude: opt.lat,\r\n      longitude: opt.lon\r\n    };\r\n\r\n    // Nur postalCode und city setzen, wenn sie im Formular NICHT bereits ausgefüllt sind\r\n    const currentPostalCode = (vm.addProjectFormGroup.get('postalCode').value || '').trim();\r\n    const currentCity = (vm.addProjectFormGroup.get('city').value || '').trim();\r\n\r\n    if (!currentPostalCode && opt.postcode) {\r\n      patchData.postalCode = opt.postcode;\r\n    }\r\n    if (!currentCity && opt.city) {\r\n      patchData.city = opt.city;\r\n    }\r\n\r\n    vm.addProjectFormGroup.patchValue(patchData);\r\n\r\n    vm.addProjectFormGroup.get('address').markAsDirty();\r\n    vm.addProjectFormGroup.get('latitude').markAsDirty();\r\n    vm.addProjectFormGroup.get('longitude').markAsDirty();\r\n\r\n    if (!currentPostalCode && opt.postcode) {\r\n      vm.addProjectFormGroup.get('postalCode').markAsDirty();\r\n    }\r\n    if (!currentCity && opt.city) {\r\n      vm.addProjectFormGroup.get('city').markAsDirty();\r\n    }\r\n\r\n    // optional: Ergebnisse leeren, damit Dropdown zugeht\r\n    vm.addressOptions = [];\r\n  };\r\n\r\n  // --- Debounced auto-search without rxjs operators ---\r\n  let addrTimer = null;\r\n  let lastQuery = '';\r\n\r\n  vm.addProjectFormGroup.get('address').valueChanges.subscribe(val => {\r\n    // Wenn eine Auswahl gerade gesetzt wurde, nicht sofort neu suchen\r\n    if (typeof val === 'string' && vm._lastSelectedAddressLabel && val === vm._lastSelectedAddressLabel) {\r\n      return;\r\n    }\r\n\r\n    const s = (typeof val === 'string')\r\n      ? val.trim()\r\n      : (vm.displayAddressOption(val) || '').trim();\r\n\r\n    // Reset results for short strings\r\n    if (s.length < 5) {\r\n      vm.addressOptions = [];\r\n      lastQuery = s;\r\n      if (addrTimer) {\r\n        clearTimeout(addrTimer);\r\n        addrTimer = null;\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Simple distinctUntilChanged\r\n    if (s === lastQuery) {\r\n      return;\r\n    }\r\n    lastQuery = s;\r\n\r\n    // Debounce\r\n    if (addrTimer) {\r\n      clearTimeout(addrTimer);\r\n    }\r\n    addrTimer = setTimeout(() => {\r\n      searchAddressViaPhoton(s);\r\n    }, 350);\r\n  });\r\n\r\n\r\n  function searchAddressViaPhoton(query) {\r\n    // Hole postalCode und city aus dem Formular\r\n    const postalCode = (vm.addProjectFormGroup.get('postalCode').value || '').trim();\r\n    const city = (vm.addProjectFormGroup.get('city').value || '').trim();\r\n\r\n    // Verfeinerte Query erstellen\r\n    let refinedQuery = query;\r\n    if (postalCode) {\r\n      refinedQuery += ' ' + postalCode;\r\n    }\r\n    if (city) {\r\n      refinedQuery += ' ' + city;\r\n    }\r\n\r\n    const url =\r\n      'https://photon.komoot.io/api' +\r\n      '?q=' + encodeURIComponent(refinedQuery) +\r\n      '&limit=5';\r\n\r\n    fetch(url)\r\n      .then(res => {\r\n        if (!res.ok) throw new Error('HTTP ' + res.status);\r\n        return res.json();\r\n      })\r\n      .then(data => {\r\n        const features = (data && data.features) ? data.features : [];\r\n\r\n        vm.addressOptions = features.map(f => {\r\n          const p = f.properties || {};\r\n          const coords = (f.geometry && f.geometry.coordinates) ? f.geometry.coordinates : [null, null];\r\n          const lon = coords[0];\r\n          const lat = coords[1];\r\n\r\n          // Bausteine\r\n          const street = p.street || p.name || '';\r\n          const house = p.housenumber ? (' ' + p.housenumber) : '';\r\n          const place = (street + house).trim() || (p.label || p.name || '').trim();\r\n\r\n          const cc = (p.countrycode || '').toUpperCase();\r\n          const postcode = p.postcode || '';\r\n          const cityFromResult = p.city || p.town || p.village || p.state || '';\r\n\r\n          // Ziel-Format: \"Adresse, CC-PLZ Ort\"\r\n          let tail = '';\r\n          if (cc || postcode || cityFromResult) {\r\n            tail = (cc ? cc : '');\r\n            if (cc && postcode) tail += '-' + postcode;\r\n            else if (!cc && postcode) tail += postcode;\r\n            if ((cc || postcode) && cityFromResult) tail += ' ' + cityFromResult;\r\n            else if (!cc && !postcode && cityFromResult) tail += cityFromResult;\r\n          }\r\n\r\n          const label = tail ? (place + ', ' + tail) : place;\r\n\r\n          return {\r\n            label,\r\n            lat: (typeof lat === 'number') ? lat : parseFloat(lat),\r\n            lon: (typeof lon === 'number') ? lon : parseFloat(lon),\r\n            postcode: postcode,\r\n            city: cityFromResult,\r\n            raw: f\r\n          };\r\n        });\r\n      })\r\n      .catch(err => {\r\n        console.error('Address search failed', err);\r\n        vm.addressOptions = [];\r\n      });\r\n  }\r\n\r\n\r\n  \r\nif (!isTenantAdmin && customerId) {\r\n    vm.addProjectFormGroup.patchValue({\r\n        customer: customers[0]\r\n    });\r\n    vm.addProjectFormGroup.get('customer').markAsDirty();\r\n    loadCustomerData(customerId);\r\n}\r\n\r\n  \r\nvm.onCustomerChange = function () {\r\n    const c = vm.addProjectFormGroup.value.customer;\r\n    if (!c) return;\r\n\r\n    customerId = {\r\n        id: c.id.id,\r\n        entityType: 'CUSTOMER'\r\n    };\r\n    customerName = c.name;\r\n\r\n    loadCustomerData(customerId);\r\n};\r\n\r\n  \r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    vm.addProjectFormGroup.markAsPristine();\r\n    saveProjectObservable(customerId).subscribe(\r\n      function (Project) {\r\n          widgetContext.rxjs.forkJoin([\r\n              saveCustomerToProjectRelation(customerId, Project.id),\r\n              saveAttributes(Project.id)\r\n          ]).subscribe(\r\n              function () {\r\n                var params = widgetContext.stateController.getStateParams();\r\n                var selectedProject = params['selectedProject'];\r\n                params['selectedProject'] = { entityId: Project.id, entityName: Project.name, entityLabel: '' };\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              }\r\n        );\r\n      }\r\n    );\r\n  };\r\n  \r\nfunction loadCustomerData(customerId) {\r\n\r\n    let assetSearchQuery = {\r\n        parameters: {\r\n            rootId: customerId.id,\r\n            rootType: 'CUSTOMER',\r\n            direction: 'FROM',\r\n            relationTypeGroup: 'COMMON',\r\n            maxLevel: 10,\r\n            fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n    };\r\n\r\n    assetService.findByQuery(assetSearchQuery).subscribe(projects => {\r\n\r\n        nextProjectId = getLastProjectId(projects);\r\n\r\n        attributeService\r\n            .getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName'])\r\n            .subscribe(attributes => {\r\n\r\n                const shortNameAttr = attributes.find(a => a.key === 'shortName');\r\n                customerShortName = shortNameAttr\r\n                    ? shortNameAttr.value\r\n                    : customerName;\r\n\r\n                vm.addProjectFormGroup.patchValue({\r\n                    name: customerShortName + '_' + nextProjectId\r\n                });\r\n\r\n                vm.addProjectFormGroup.get('name').markAsDirty();\r\n            });\r\n    });\r\n}\r\n\r\n  function saveProjectObservable(customerId) {\r\n    return getProjectsGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((ProjectsGroup) => {\r\n            const formValues = vm.addProjectFormGroup.getRawValue();\r\n            let Project = {\r\n              name: formValues.name,\r\n              type: 'Project',\r\n              label: formValues.entityLabel,\r\n              customerId: customerId\r\n            };\r\n            return assetService.saveAsset(Project, ProjectsGroup.id.id)\r\n        })\r\n    );\r\n  }\r\n  \r\n  function getProjectsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var ProjectsGroup = entityGroups.find(group => group.name === 'Projects');\r\n              if (ProjectsGroup) {\r\n                  return widgetContext.rxjs.of(ProjectsGroup);\r\n              } else {\r\n                  ProjectsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Projects',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(ProjectsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n\r\n  function saveCustomerToProjectRelation(customerId, ProjectId) {\r\n      var relation = {\r\n          from: customerId,\r\n          to: ProjectId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  \r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n        {\r\n            key: 'latitude',\r\n            value: vm.addProjectFormGroup.value.latitude || 48.1406022\r\n        },\r\n        {\r\n            key: 'longitude',\r\n            value: vm.addProjectFormGroup.value.longitude || 16.2932688\r\n        },\r\n        {\r\n            key: 'address',\r\n            value: vm.addProjectFormGroup.value.address\r\n        },        \r\n        {\r\n            key: 'progress',\r\n            value: 'in preparation'\r\n        },\r\n        {\n            key: 'units',\n            value: 'metric'\n        }\n    ];\n    // Add projectPicture if provided\n    if (vm.addProjectFormGroup.value.projectPicture) {\n        attributesArray.push({\n            key: 'projectPicture',\n            value: vm.addProjectFormGroup.value.projectPicture\n        });\n    }\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "2c6e09e8-98b9-f1ca-0a64-7cce095767a2"
              }
            ],
            "rowDoubleClick": []
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "pageSize": 1024,
          "configMode": "advanced",
          "titleFont": null,
          "titleColor": null,
          "titleIcon": null,
          "iconColor": null,
          "borderRadius": "0px"
        },
        "row": 0,
        "col": 0,
        "id": "fb924e54-6e4b-2d41-5545-dab85e028210",
        "typeFullFqn": "system.cards.entities_table"
      },
      "40680065-1e6b-c6f8-af6a-23e82a99fad9": {
        "typeFullFqn": "system.map",
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1745755787013,
                "endTimeMs": 1745842187013
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": false,
          "backgroundColor": "rgba(0, 0, 0, 0)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "mapType": "geoMap",
            "layers": [
              {
                "label": "{i18n:widgets.maps.layer.roadmap}",
                "provider": "openstreet",
                "layerType": "CartoDB.Positron",
                "referenceLayer": null
              },
              {
                "label": "{i18n:widgets.maps.layer.satellite}",
                "provider": "openstreet",
                "layerType": "Esri.WorldImagery"
              },
              {
                "label": "{i18n:widgets.maps.layer.hybrid}",
                "provider": "openstreet",
                "layerType": "Esri.WorldImagery",
                "referenceLayer": "openstreetmap_hybrid"
              },
              {
                "label": "{i18n:widgets.maps.layer.topographic}",
                "provider": "openstreet",
                "layerType": "Esri.WorldTopoMap",
                "referenceLayer": null
              },
              {
                "label": null,
                "provider": "openstreet",
                "layerType": "OpenStreetMap.HOT",
                "referenceLayer": null
              },
              {
                "label": null,
                "provider": "openstreet",
                "layerType": "Esri.WorldStreetMap",
                "referenceLayer": null
              },
              {
                "provider": "openstreet",
                "layerType": "OpenStreetMap.Mapnik"
              }
            ],
            "imageSource": null,
            "markers": [
              {
                "dsType": "entity",
                "dsLabel": "",
                "dsDeviceId": null,
                "dsEntityAliasId": "d75c5b86-8b39-59e2-59f3-ae1c1ee40910",
                "dsFilterId": "3744b253-8d5c-7528-b178-0c8be5c3adca",
                "additionalDataSources": null,
                "additionalDataKeys": [
                  {
                    "name": "progress",
                    "type": "attribute",
                    "label": "progress",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.9725950885098493
                  },
                  {
                    "name": "name",
                    "type": "entityField",
                    "label": "name",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.2872987416504812,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  },
                  {
                    "name": "address",
                    "type": "attribute",
                    "label": "address",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8026110588871542
                  },
                  {
                    "name": "outsideTemp",
                    "type": "timeseries",
                    "label": "outsideTemp",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.759902282076257
                  },
                  {
                    "name": "outsideHumidity",
                    "type": "timeseries",
                    "label": "outsideHumidity",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.05821233805088244
                  },
                  {
                    "name": "label",
                    "type": "entityField",
                    "label": "label",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8646915284773707,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  }
                ],
                "label": {
                  "show": true,
                  "type": "function",
                  "pattern": "${entityName}",
                  "patternFunction": {
                    "body": "var color = utils.getProgressColor(data.progress).color;\r\n\r\nreturn '<span style=\"border: solid ' + color + '; border-radius: 10px; color: ' + color + '; background-color: #fff; padding: 3px 5px; font-size: 14px; position: relative; bottom: 6px;\">' + \r\n           '${entityName}' + \r\n        '</span>';",
                    "modules": {
                      "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                    }
                  }
                },
                "tooltip": {
                  "show": false,
                  "type": "function",
                  "pattern": "<b>${entityName}</b><br/><br/><b>Latitude:</b> ${latitude:7}<br/><b>Longitude:</b> ${longitude:7}<br/><b>Temperature:</b> ${temperature} °C<br/><small>See tooltip settings for details</small>",
                  "patternFunction": {
                    "body": "const locationName = data.locationName || data.label || entityName;\nconst name = data.name || entityName;\nconst progress = data.progress;\nconst address = data.address || '';\n\nlet progressHtml = '';\nif (progress) {\n    let color, bgColor, label;\n    switch (progress) {\n        case 'active':\n            color = '#27AE60';\n            bgColor = 'rgba(39, 174, 96, 0.12)';\n            label = 'Active';\n            break;\n        case 'in preparation':\n            color = '#F2994A';\n            bgColor = 'rgba(242, 153, 74, 0.12)';\n            label = 'In Preparation';\n            break;\n        case 'finished':\n            color = '#2F80ED';\n            bgColor = 'rgba(47, 128, 237, 0.12)';\n            label = 'Finished';\n            break;\n        case 'aborted':\n            color = '#EB5757';\n            bgColor = 'rgba(235, 87, 87, 0.12)';\n            label = 'Aborted';\n            break;\n        default:\n            color = '#828282';\n            bgColor = 'rgba(130, 130, 130, 0.12)';\n            label = progress || 'Unknown';\n    }\n    progressHtml = '<span style=\"padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; color: ' + color + '; background-color: ' + bgColor + ';\">' + label + '</span>';\n}\n\nreturn '<div style=\"font-family: Roboto; font-size: 14px;\">' +\n    '<div style=\"font-weight: 600; margin-bottom: 4px;\">' + locationName + '</div>' +\n    '<div style=\"color: #666; font-size: 12px; margin-bottom: 4px;\">' + name + '</div>' +\n    (progressHtml ? '<div>' + progressHtml + '</div>' : '') +\n    '<div style=\"color: #999; font-size: 11px; margin-top: 8px;\">Click for details</div>' +\n    '</div>';",
                    "modules": {}
                  },
                  "trigger": "hover",
                  "autoclose": true,
                  "offsetX": 0,
                  "offsetY": -1,
                  "tagActions": null
                },
                "click": {
                  "type": "customPretty",
                  "customHtml": "<form class=\"project-popup-form\">\n  <button class=\"popup-close\" mat-icon-button (click)=\"close()\" type=\"button\">\n    <mat-icon class=\"material-icons\">close</mat-icon>\n  </button>\n  <div mat-dialog-content>\n    <!-- Project Picture -->\n    <section *ngIf=\"project.picture\" class=\"flex flex-col items-center justify-center\" style=\"padding-bottom: 16px;\">\n      <img class=\"project-picture\" [src]=\"project.picture\"/>\n    </section>\n    \n    <!-- Project Name -->\n    <section class=\"flex flex-col items-center justify-center\" style=\"padding-bottom: 16px;\">\n      <div class=\"popup-title\">{{ project.locationName }}</div>\n      <div class=\"popup-subtitle\">{{ project.name }}</div>\n    </section>\n    \n    <mat-divider style=\"margin-bottom: 16px;\"></mat-divider>\n    \n    <!-- Project Details -->\n    <section class=\"flex flex-col gap-2\" style=\"padding-bottom: 16px;\">\n      <div class=\"flex flex-row items-baseline\">\n        <div class=\"popup-label\">Address</div>\n        <div class=\"popup-value\">{{ project.address }}</div>\n      </div>\n      <div class=\"flex flex-row items-center\">\n        <div class=\"popup-label\">Progress</div>\n        <div class=\"popup-badge\" [style.color]=\"project.progressStyle.color\" [style.background-color]=\"project.progressStyle.bgColor\">\n          {{ project.progressStyle.label }}\n        </div>\n      </div>\n      <div class=\"flex flex-row items-center\" *ngIf=\"project.measurementsCount !== null\">\n        <div class=\"popup-label\">Measurements</div>\n        <div class=\"popup-value\">{{ project.measurementsCount }}</div>\n      </div>\n    </section>\n    \n    <!-- Timestamps -->\n    <section *ngIf=\"project.startTime || project.endTime\" class=\"flex flex-row gap-2 flex-wrap\" style=\"padding-bottom: 16px;\">\n      <div *ngIf=\"project.startTime\" class=\"timestamp-badge\" [style.color]=\"project.startTime.color\" [style.background-color]=\"project.startTime.bgColor\">\n        <mat-icon style=\"font-size: 14px; width: 14px; height: 14px; margin-right: 4px;\">{{ project.startTime.icon }}</mat-icon>\n        <span>{{ project.startTime.label }}</span>\n      </div>\n      <div *ngIf=\"project.endTime\" class=\"timestamp-badge\" [style.color]=\"project.endTime.color\" [style.background-color]=\"project.endTime.bgColor\">\n        <mat-icon style=\"font-size: 14px; width: 14px; height: 14px; margin-right: 4px;\">{{ project.endTime.icon }}</mat-icon>\n        <span>{{ project.endTime.label }}</span>\n      </div>\n    </section>\n    \n    <!-- Buttons -->\n    <section class=\"flex flex-row gap-2 items-center justify-center flex-wrap\" style=\"padding-top: 8px;\">\n      <button *ngIf=\"showWizardButton\" type=\"button\" mat-flat-button color=\"primary\" class=\"popup-button wizard-button\" (click)=\"openProjectWizard()\">\n        <mat-icon>rocket_launch</mat-icon>\n        <span>Project Wizard</span>\n      </button>\n      <button type=\"button\" mat-stroked-button color=\"primary\" class=\"popup-button\" (click)=\"openMeasurements()\">\n        <mat-icon>assignment</mat-icon>\n        <span>Measurements</span>\n      </button>\n      <button type=\"button\" mat-stroked-button class=\"popup-button edit-button\" (click)=\"openEditProject()\">\n        <mat-icon>edit</mat-icon>\n        <span>Edit</span>\n      </button>\n    </section>\n  </div>\n</form>",
                  "customCss": ".project-popup-form {\n    width: 420px;\n    position: relative;\n    padding: 16px;\n}\n\n.project-popup-form .mat-mdc-dialog-content {\n    max-height: 95vh;\n    padding: 0;\n}\n\n.project-popup-form .popup-close {\n    position: absolute;\n    top: 8px;\n    right: 8px;\n    z-index: 1;\n}\n\n.project-popup-form .project-picture {\n    width: 160px;\n    height: 160px;\n    border-radius: 8px;\n    object-fit: cover;\n}\n\n.project-popup-form .popup-title {\n    font-weight: 600;\n    font-size: 18px;\n    line-height: 24px;\n    color: #29313C;\n    text-align: center;\n}\n\n.project-popup-form .popup-subtitle {\n    font-size: 14px;\n    color: #666;\n    text-align: center;\n}\n\n.project-popup-form .popup-label {\n    font-size: 13px;\n    line-height: 16px;\n    font-weight: 500;\n    color: rgba(0, 0, 0, 0.38);\n    width: 110px;\n    flex-shrink: 0;\n}\n\n.project-popup-form .popup-value {\n    font-size: 14px;\n    line-height: 20px;\n    font-weight: 500;\n    letter-spacing: 0.25px;\n    color: #29313C;\n}\n\n.project-popup-form .popup-badge {\n    display: inline-block;\n    padding: 4px 8px;\n    border-radius: 8px;\n    font-size: 12px;\n    font-weight: 500;\n    line-height: 16px;\n}\n\n.project-popup-form .timestamp-badge {\n    display: inline-flex;\n    align-items: center;\n    padding: 4px 8px;\n    border-radius: 4px;\n    font-size: 11px;\n    font-weight: 500;\n}\n\n.project-popup-form .popup-button {\n    display: flex;\n    align-items: center;\n    gap: 4px;\n}\n\n.project-popup-form .wizard-button {\n    background-color: #307FE5;\n}\n\n.project-popup-form .edit-button {\n    color: #F2994A;\n    border-color: #F2994A;\n}\n\n.project-popup-form .mat-mdc-outlined-button.mat-primary:not(:disabled),\n.project-popup-form .mat-mdc-stroked-button.mat-primary:not(:disabled) {\n    color: #307FE5;\n    border-color: #307FE5;\n}",
                  "customFunction": {
                    "body": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet rxjs = widgetContext.rxjs;\n\n// Load attributes and relations in parallel\nrxjs.forkJoin([\n    attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE', \n        ['locationName', 'address', 'progress', 'startTimeMs', 'endTimeMs', 'projectPicture']\n    ),\n    entityRelationService.findByFrom(entityId, 'Owns')\n]).subscribe(function(results) {\n    let attributes = results[0];\n    let relations = results[1];\n    \n    let attrMap = {};\n    attributes.forEach(function(attr) {\n        attrMap[attr.key] = attr.value;\n    });\n    \n    // Count measurements (relations with type Owns to ASSETs)\n    let measurementsCount = relations.filter(function(rel) {\n        return rel.to && rel.to.entityType === 'ASSET';\n    }).length;\n    \n    openProjectPopupDialog(attrMap, measurementsCount);\n});\n\nfunction openProjectPopupDialog(attrMap, measurementsCount) {\n    customDialog.customDialog(htmlTemplate, ProjectPopupController).subscribe();\n    \n    function ProjectPopupController(instance) {\n        let vm = instance;\n        \n        // Progress styling\n        let progressStyle = getProgressColor(attrMap.progress);\n        \n        // Timestamp styling\n        let startTime = getTimestampStyle(attrMap.startTimeMs, 'start');\n        let endTime = getTimestampStyle(attrMap.endTimeMs, 'end');\n        \n        vm.project = {\n            name: entityName,\n            locationName: attrMap.locationName || entityLabel || entityName,\n            address: attrMap.address || 'N/A',\n            progress: attrMap.progress,\n            progressStyle: progressStyle,\n            picture: attrMap.projectPicture || null,\n            startTime: startTime,\n            endTime: endTime,\n            measurementsCount: measurementsCount\n        };\n        \n        vm.showWizardButton = (attrMap.progress === 'in preparation' || attrMap.progress === 'active');\n        \n        vm.close = function() {\n            vm.dialogRef.close(null);\n        };\n        \n        vm.openProjectWizard = function() {\n            vm.dialogRef.close(null);\n            projectWizard.openProjectWizardDialog(widgetContext, entityId, entityName, entityLabel, function() {\n                widgetContext.updateAliases();\n            }, { dataImporter: dataImporter });\n        };\n        \n        vm.openMeasurements = function() {\n            vm.dialogRef.close(null);\n            var params = widgetContext.stateController.getStateParams();\n            var selectedProject = params['selectedProject'];\n            if (selectedProject && selectedProject.entityId.id === entityId.id) {\n                params['selectedProject'] = null;\n            } else {\n                params['selectedProject'] = { \n                    entityId: entityId, \n                    entityName: entityName, \n                    entityLabel: entityLabel \n                };\n            }\n            widgetContext.stateController.updateState(null, params);\n        };\n        vm.openEditProject = function() {\n            vm.dialogRef.close(null);\n            projectWizard.openEditProjectDialog(widgetContext, entityId, entityName, entityLabel, function() {\n                widgetContext.updateAliases();\n            });\n        };\n\n        \n        // Helper functions\n        function getProgressColor(progress) {\n            let color, bgColor, label;\n            switch (progress) {\n                case 'in preparation':\n                    color = '#F2994A';\n                    bgColor = 'rgba(242, 153, 74, 0.12)';\n                    label = 'In Preparation';\n                    break;\n                case 'planned':\n                    color = '#F2994A';\n                    bgColor = 'rgba(242, 153, 74, 0.12)';\n                    label = 'Planned';\n                    break;\n                case 'active':\n                    color = '#27AE60';\n                    bgColor = 'rgba(39, 174, 96, 0.12)';\n                    label = 'Active';\n                    break;\n                case 'finished':\n                    color = '#2F80ED';\n                    bgColor = 'rgba(47, 128, 237, 0.12)';\n                    label = 'Finished';\n                    break;\n                case 'aborted':\n                    color = '#EB5757';\n                    bgColor = 'rgba(235, 87, 87, 0.12)';\n                    label = 'Aborted';\n                    break;\n                default:\n                    color = '#828282';\n                    bgColor = 'rgba(130, 130, 130, 0.12)';\n                    label = progress || 'N/A';\n            }\n            return { color: color, bgColor: bgColor, label: label };\n        }\n        \n        function getTimestampStyle(timestampMs, type) {\n            if (timestampMs === null || timestampMs === undefined) {\n                return null;\n            }\n            var date = new Date(Number(timestampMs));\n            var pad = function(n) { return n.toString().padStart(2, '0'); };\n            var formattedTime = date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' + pad(date.getDate()) +\n                ' ' + pad(date.getHours()) + ':' + pad(date.getMinutes());\n            \n            var icon, color, bgColor, label;\n            if (type === 'start') {\n                icon = 'play_circle';\n                color = '#27AE60';\n                bgColor = 'rgba(39, 174, 96, 0.12)';\n                label = 'Start: ' + formattedTime;\n            } else {\n                icon = 'stop_circle';\n                color = '#2F80ED';\n                bgColor = 'rgba(47, 128, 237, 0.12)';\n                label = 'End: ' + formattedTime;\n            }\n            return { icon: icon, color: color, bgColor: bgColor, label: label };\n        }\n    }\n}",
                    "modules": {
                      "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                      "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                    }
                  },
                  "customResources": [],
                  "openInSeparateDialog": false,
                  "openInPopover": false
                },
                "groups": null,
                "edit": {
                  "enabledActions": [
                    "add",
                    "move"
                  ],
                  "attributeScope": "SERVER_SCOPE",
                  "snappable": false
                },
                "xKey": {
                  "name": "latitude",
                  "label": "latitude",
                  "type": "attribute",
                  "settings": {},
                  "color": "#2196f3"
                },
                "yKey": {
                  "name": "longitude",
                  "label": "longitude",
                  "type": "attribute",
                  "settings": {},
                  "color": "#2196f3"
                },
                "markerType": "icon",
                "markerShape": {
                  "shape": "markerShape1",
                  "size": 34,
                  "color": {
                    "type": "constant",
                    "color": "#307FE5"
                  }
                },
                "markerIcon": {
                  "iconContainer": "iconContainer4",
                  "icon": "domain",
                  "size": 40,
                  "color": {
                    "type": "function",
                    "color": "#307FE5",
                    "rangeKey": null,
                    "range": null,
                    "colorFunction": {
                      "body": "return utils.getProgressColor(data.progress).color;",
                      "modules": {
                        "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                      }
                    }
                  }
                },
                "markerImage": {
                  "type": "image",
                  "image": "/assets/markers/shape1.svg",
                  "imageSize": 34
                },
                "markerOffsetX": 0.5,
                "markerOffsetY": 1,
                "markerClustering": {
                  "enable": true,
                  "zoomOnClick": true,
                  "maxZoom": null,
                  "maxClusterRadius": 80,
                  "zoomAnimation": true,
                  "showCoverageOnHover": true,
                  "spiderfyOnMaxZoom": false,
                  "chunkedLoad": false,
                  "lazyLoad": true,
                  "useClusterMarkerColorFunction": false,
                  "clusterMarkerColorFunction": null
                }
              }
            ],
            "polygons": [],
            "circles": [],
            "additionalDataSources": [
              {
                "dsType": "entity",
                "dsLabel": "",
                "dataKeys": [
                  {
                    "name": "latitude",
                    "type": "attribute",
                    "label": "selectedProject",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.5634367819170003,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  }
                ],
                "dsEntityAliasId": "faef915b-be60-5c6b-d62c-114957e80421"
              },
              {
                "dsType": "entity",
                "dsLabel": "",
                "dataKeys": [
                  {
                    "name": "role",
                    "type": "attribute",
                    "label": "role",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.7014478669430672
                  },
                  {
                    "name": "displayAbortedMeasurement",
                    "type": "attribute",
                    "label": "displayAbortedMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8011587598224269
                  },
                  {
                    "name": "displayActiveMeasurement",
                    "type": "attribute",
                    "label": "displayActiveMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8205299052205228
                  },
                  {
                    "name": "displayFinishedMeasurement",
                    "type": "attribute",
                    "label": "displayFinishedMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.038665901375789624
                  },
                  {
                    "name": "displayPreparationMeasurement",
                    "type": "attribute",
                    "label": "displayPreparationMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.21373032656145663
                  }
                ],
                "dsEntityAliasId": "203b0867-b867-ef98-1791-03046c133b7d"
              }
            ],
            "controlsPosition": "topleft",
            "zoomActions": [
              "scroll",
              "doubleClick",
              "controlButtons"
            ],
            "scales": [
              "metric"
            ],
            "dragModeButton": true,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "defaultCenterPosition": "0,0",
            "defaultZoomLevel": null,
            "mapPageSize": 16384,
            "mapActionButtons": [
              {
                "label": "Filter",
                "icon": "filter_alt",
                "color": "#0000008A",
                "action": {
                  "type": "openDashboardState",
                  "targetDashboardStateId": "Measurement_state_filter",
                  "setEntityId": true,
                  "stateEntityParamName": null,
                  "openRightLayout": false,
                  "popoverPreferredPlacement": "top",
                  "popoverHideOnClickOutside": true,
                  "popoverHideDashboardToolbar": true,
                  "popoverWidth": "300px",
                  "popoverHeight": "250px",
                  "popoverStyle": {
                    "padding": "16px",
                    "borderRadius": "8px",
                    "boxShadow": "0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",
                    "background": "#ffffff"
                  },
                  "openInSeparateDialog": false,
                  "openInPopover": true
                }
              },
              {
                "label": "Add Project",
                "icon": "add",
                "color": "#0000008a",
                "action": {
                  "type": "placeMapItem",
                  "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addProjectFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 600px; max-width: 90vw;\">\n  <mat-toolbar class=\"flex items-center\" color=\"primary\">\n    <mat-icon style=\"margin-right: 12px;\">folder_open</mat-icon>\n    <h2 style=\"margin: 0; font-size: 18px;\">Add Project</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col gap-3 p-4\">\n\n    <!-- Customer Section -->\n    <fieldset *ngIf=\"isTenantAdmin\" class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">business</mat-icon>\n        Customer\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Customer</mat-label>\n        <mat-select formControlName=\"customer\" (selectionChange)=\"onCustomerChange()\" required>\n          <mat-option *ngFor=\"let c of customers\" [value]=\"c\">{{ c.name }}</mat-option>\n        </mat-select>\n        <mat-error *ngIf=\"addProjectFormGroup.get('customer')?.hasError('required')\">Customer is required.</mat-error>\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Project Info Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">folder</mat-icon>\n        Project Info\n      </legend>\n      <tb-image-input formControlName=\"projectPicture\" label=\"Project Picture\" noImageText=\"No picture selected\"></tb-image-input>\n      <mat-form-field appearance=\"fill\" class=\"w-full disabled-field\">\n        <mat-label>Project ID</mat-label>\n        <input matInput formControlName=\"name\" required readonly>\n        <mat-error *ngIf=\"addProjectFormGroup.get('name').hasError('required')\">Project title is required.</mat-error>\n      </mat-form-field>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Label</mat-label>\n        <input matInput formControlName=\"entityLabel\">\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Address Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">location_on</mat-icon>\n        Address\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Project address</mat-label>\n        <input matInput formControlName=\"address\" [matAutocomplete]=\"addrAuto\" autocomplete=\"off\">\n        <button mat-icon-button matSuffix type=\"button\" (click)=\"searchAddress()\" [disabled]=\"(addProjectFormGroup.get('address').value || '').length < 5\">\n          <mat-icon>search</mat-icon>\n        </button>\n        <mat-autocomplete #addrAuto=\"matAutocomplete\" [displayWith]=\"displayAddressOption\" (optionSelected)=\"onAddressSelected($event.option.value)\">\n          <mat-option *ngFor=\"let opt of addressOptions\" [value]=\"opt\">{{ opt.label }}</mat-option>\n        </mat-autocomplete>\n        <mat-hint *ngIf=\"(addProjectFormGroup.get('address').value || '').length < 5\">Enter at least 5 characters to search</mat-hint>\n      </mat-form-field>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Postal Code</mat-label>\n          <input matInput formControlName=\"postalCode\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 2;\">\n          <mat-label>City</mat-label>\n          <input matInput formControlName=\"city\">\n        </mat-form-field>\n      </div>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Latitude</mat-label>\n          <input matInput formControlName=\"latitude\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Longitude</mat-label>\n          <input matInput formControlName=\"longitude\">\n        </mat-form-field>\n      </div>\n    </fieldset>\n\n  </div>\n  <div class=\"flex justify-end items-center gap-2 p-4\" style=\"border-top: 1px solid #e0e0e0; background: #fafafa;\">\n    <button mat-button (click)=\"cancel()\" type=\"button\">Cancel</button>\n    <button mat-raised-button color=\"primary\" type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addProjectFormGroup.invalid || !addProjectFormGroup.dirty\">\n      <mat-icon style=\"font-size: 18px; width: 18px; height: 18px; margin-right: 4px;\">save</mat-icon>\n      Save\n    </button>\n  </div>\n</form>",
                  "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled,\n.edit-project-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form .mdc-text-field--filled:not(.mdc-text-field--disabled),\n.edit-project-form .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .disabled-field input,\n.edit-project-form .disabled-field input {\n  color: rgba(0, 0, 0, 0.6) !important;\n}\n\n.add-entity-form .disabled-field,\n.edit-project-form .disabled-field {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\nmat-icon {\n  vertical-align: middle;\n  margin-right: 4px;\n}",
                  "customFunction": "/*========================================================================*/\n/*========  Add Project with Customer Selection & Reverse Geocoding  =====*/\n/*========================================================================*/\n\nlet $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\nlet $http = $injector.get(widgetContext.servicesMap.get('http'));\n\n// Get marker coordinates\nconst markerLat = additionalParams.coordinates.x;\nconst markerLon = additionalParams.coordinates.y;\n\nconsole.log(\"Marker Coordinates: \", markerLat, markerLon);\n\n// Check if Tenant Admin\nconst isTenantAdmin = widgetContext.currentUser.authority === 'TENANT_ADMIN';\nconst pageLink = widgetContext.pageLink(1000, 0, null, null, null);\n\n// Shared variables for async operations\nlet customers = [];\nlet selectedCustomerId = null;\nlet selectedCustomerName = null;\nlet addressData = null;\nlet nextProjectId = 0;\nlet customerShortName = '';\n\n// Step 1: Reverse Geocoding\nreverseGeocode(markerLat, markerLon)\n  .then(data => {\n    addressData = data;\n    console.log('Reverse geocoding result:', addressData);\n\n    // Step 2: Fetch customers\n    return fetchCustomers();\n  })\n  .then(() => {\n    console.log('Customers fetched:', customers);\n\n    // Step 3: Open dialog with customer selection\n    openAddProjectDialog();\n  })\n  .catch(error => {\n    console.error('Error in Add Project workflow:', error);\n  });\n\n/**\n * Reverse Geocoding: Converts lat/lon to address using Photon API\n * Address format: Straßenname Hausnummer, CC-Postleitzahl Ort\n */\nfunction reverseGeocode(lat, lon) {\n  return new Promise((resolve, reject) => {\n    const url = `https://photon.komoot.io/reverse?lat=${lat}&lon=${lon}&limit=1`;\n\n    $http.get(url).subscribe(\n      response => {\n        if (response && response.features && response.features.length > 0) {\n          const feature = response.features[0];\n          const props = feature.properties;\n\n          // Build address in format: Straßenname Hausnummer, CC-Postleitzahl Ort\n          let street = props.street || props.name || '';\n          let housenumber = props.housenumber || '';\n          let postcode = props.postcode || '';\n          let city = props.city || props.town || props.village || '';\n          let countryCode = props.countrycode ? props.countrycode.toUpperCase() : '';\n\n          // Street + Housenumber part\n          let addressLine = street;\n          if (housenumber) {\n            addressLine += ' ' + housenumber;\n          }\n\n          // CC-Postcode + City part\n          let locationLine = '';\n          if (countryCode && postcode) {\n            locationLine = countryCode + '-' + postcode;\n          } else if (postcode) {\n            locationLine = postcode;\n          }\n          if (city) {\n            locationLine += (locationLine ? ' ' : '') + city;\n          }\n\n          // Combined format: \"Street Number, CC-Postcode City\"\n          let fullAddress = addressLine;\n          if (locationLine) {\n            fullAddress += ', ' + locationLine;\n          }\n\n          const result = {\n            address: fullAddress,\n            postalCode: postcode,\n            city: city,\n            latitude: lat,\n            longitude: lon\n          };\n\n          resolve(result);\n        } else {\n          resolve({\n            address: '',\n            postalCode: '',\n            city: '',\n            latitude: lat,\n            longitude: lon\n          });\n        }\n      },\n      error => {\n        console.error('Photon API error:', error);\n        reject(error);\n      }\n    );\n  });\n}\n\n/**\n * Fetch customers based on user role\n */\nfunction fetchCustomers() {\n  return new Promise((resolve, reject) => {\n    customerService.getUserCustomers(pageLink).subscribe(\n      pageData => {\n        customers = (pageData && pageData.data) ? pageData.data : [];\n\n        // Non-Tenant-Admin → automatically select the single customer\n        if (!isTenantAdmin && customers.length === 1) {\n          const c = customers[0];\n          selectedCustomerId = {\n            id: c.id.id,\n            entityType: 'CUSTOMER'\n          };\n          selectedCustomerName = c.name;\n        }\n\n        resolve();\n      },\n      error => {\n        console.error('Error fetching customers:', error);\n        reject(error);\n      }\n    );\n  });\n}\n\nfunction openAddProjectDialog() {\n  customDialog.customDialog(htmlTemplate, AddProjectDialogController).subscribe();\n}\n\nfunction AddProjectDialogController(instance) {\n  let vm = instance;\n\n  vm.isTenantAdmin = isTenantAdmin;\n  vm.customers = customers;\n\n  // FormGroup erstellen\n  vm.addProjectFormGroup = vm.fb.group({\n    customer: [{ value: null, disabled: !isTenantAdmin }, vm.validators.required],\n    name: [{ value: '', disabled: true }, vm.validators.required],\n    entityLabel: [''],\n    projectPicture: [''],\n    address: [addressData ? addressData.address : ''],\n    postalCode: [addressData ? addressData.postalCode : ''],\n    city: [addressData ? addressData.city : ''],\n    latitude: [addressData ? addressData.latitude.toFixed(6) : markerLat.toFixed(6)],\n    longitude: [addressData ? addressData.longitude.toFixed(6) : markerLon.toFixed(6)]\n  });\n\n  // Customer vorausfüllen (Non-Tenant-Admin)\n  if (!isTenantAdmin && selectedCustomerId) {\n    vm.addProjectFormGroup.patchValue({\n      customer: customers[0]\n    });\n    vm.addProjectFormGroup.get('customer').markAsDirty();\n    loadCustomerData(selectedCustomerId, selectedCustomerName);\n  }\n\n  // Customer Change Handler\n  vm.onCustomerChange = function () {\n    const c = vm.addProjectFormGroup.getRawValue().customer;\n    if (!c) return;\n\n    selectedCustomerId = {\n      id: c.id.id,\n      entityType: 'CUSTOMER'\n    };\n    selectedCustomerName = c.name;\n\n    loadCustomerData(selectedCustomerId, selectedCustomerName);\n  };\n\n  // Load customer-specific data (projects + shortName)\n  function loadCustomerData(customerId, customerName) {\n    const assetSearchQuery = {\n      \"parameters\": {\n        \"rootId\": customerId.id,\n        \"rootType\": \"CUSTOMER\",\n        \"direction\": \"FROM\",\n        \"relationTypeGroup\": \"COMMON\",\n        \"maxLevel\": 10,\n        \"fetchLastLevelOnly\": false\n      },\n      \"relationType\": \"Owns\",\n      \"assetTypes\": [\"Project\"]\n    };\n\n    assetService.findByQuery(assetSearchQuery).subscribe(projects => {\n      nextProjectId = getLastProjectId(projects);\n\n      attributeService\n        .getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName'])\n        .subscribe(attributes => {\n          const shortNameAttr = attributes.find(a => a.key === 'shortName');\n          customerShortName = shortNameAttr ? shortNameAttr.value : customerName;\n\n          vm.addProjectFormGroup.patchValue({\n            name: customerShortName + '_' + nextProjectId\n          });\n\n          vm.addProjectFormGroup.get('name').markAsDirty();\n        });\n    });\n  }\n\n  function getLastProjectId(projects) {\n    let maxNumber = 0;\n    projects.forEach(item => {\n      const name = item.name;\n      const parts = name.split('_');\n      if (parts.length === 2) {\n        const number = parseInt(parts[1], 10);\n        if (number > maxNumber) {\n          maxNumber = number;\n        }\n      }\n    });\n    return maxNumber + 1;\n  }\n\n  vm.cancel = function() {\n    vm.dialogRef.close(null);\n  };\n\n  vm.save = function () {\n    if (!selectedCustomerId) {\n      console.error('No customer selected');\n      return;\n    }\n\n    // Validate that name is set\n    const formValues = vm.addProjectFormGroup.getRawValue();\n    if (!formValues.name || formValues.name === '') {\n      console.error('Project name is not set. Please select a customer first.');\n      return;\n    }\n\n    vm.addProjectFormGroup.markAsPristine();\n    saveProjectObservable(selectedCustomerId).subscribe(\n      function (Project) {\n        widgetContext.rxjs.forkJoin([\n          saveCustomerToProjectRelation(selectedCustomerId, Project.id),\n          saveAttributes(Project.id)\n        ]).subscribe(\n          function () {\n            var params = widgetContext.stateController.getStateParams();\n            params['selectedProject'] = {\n              entityId: Project.id,\n              entityName: Project.name,\n              entityLabel: ''\n            };\n            widgetContext.updateAliases();\n            vm.dialogRef.close(null);\n          }\n        );\n      }\n    );\n  };\n\n  function saveProjectObservable(customerId) {\n    return getProjectsGroup(customerId).pipe(\n      widgetContext.rxjs.switchMap((ProjectsGroup) => {\n        const formValues = vm.addProjectFormGroup.getRawValue();\n        let Project = {\n          name: formValues.name,\n          type: 'Project',\n          label: formValues.entityLabel,\n          customerId: customerId\n        };\n        return assetService.saveAsset(Project, ProjectsGroup.id.id)\n      })\n    );\n  }\n\n  function saveAttributes(entityId) {\n    let attributesArray = getMapItemLocationAttributes();\n    const formValues = vm.addProjectFormGroup.getRawValue();\n\n    attributesArray.push({key: 'address', value: formValues.address});\n    attributesArray.push({key: 'postalCode', value: formValues.postalCode});\n    attributesArray.push({key: 'city', value: formValues.city});\n    attributesArray.push({key: 'progress', value: 'in preparation'});\n    attributesArray.push({key: 'units', value: 'metric'});\n    attributesArray.push({key: 'projectPicture', value: formValues.projectPicture || ''});\n\n    if (attributesArray.length > 0) {\n      return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n    }\n    return widgetContext.rxjs.of([]);\n  }\n\n  function getProjectsGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\n      widgetContext.rxjs.switchMap((entityGroups) => {\n        var ProjectsGroup = entityGroups.find(group => group.name === 'Projects');\n        if (ProjectsGroup) {\n          return widgetContext.rxjs.of(ProjectsGroup);\n        } else {\n          ProjectsGroup = {\n            type: 'ASSET',\n            name: 'Projects',\n            ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(ProjectsGroup);\n        }\n      })\n    );\n  }\n\n  function saveCustomerToProjectRelation(customerId, ProjectId) {\n    var relation = {\n      from: customerId,\n      to: ProjectId,\n      typeGroup: 'COMMON',\n      type: 'Owns'\n    };\n    return entityRelationService.saveRelation(relation);\n  }\n\n  function getMapItemLocationAttributes() {\n    const attributes = [];\n    const mapItemType = $event.shape;\n    if (mapItemType === 'Marker') {\n      const mapType = widgetContext.mapInstance.type();\n      attributes.push({key: mapType === 'image' ? 'xPos' : 'latitude', value: additionalParams.coordinates.x});\n      attributes.push({key: mapType === 'image' ? 'yPos' : 'longitude', value: additionalParams.coordinates.y});\n    } else if (mapItemType === 'Rectangle' || mapItemType === 'Polygon') {\n      attributes.push({key: 'perimeter', value: additionalParams.coordinates});\n    } else if (mapItemType === 'Circle') {\n      attributes.push({key: 'circle', value: additionalParams.coordinates});\n    }\n    return attributes;\n  }\n}\n",
                  "customResources": [],
                  "mapItemType": "marker",
                  "mapItemTooltips": {},
                  "openInSeparateDialog": false,
                  "openInPopover": false
                }
              }
            ],
            "background": {
              "type": "color",
              "color": "#fff",
              "overlay": {
                "enabled": false,
                "color": "rgba(255,255,255,0.72)",
                "blur": 3
              }
            },
            "padding": "8px"
          },
          "title": "Map",
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "showTitleIcon": false,
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": true,
          "widgetStyle": {},
          "widgetCss": "",
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "configMode": "advanced",
          "titleFont": null,
          "titleColor": null,
          "margin": "0px",
          "borderRadius": "8px",
          "iconSize": "24px",
          "titleIcon": "map",
          "iconColor": "#1F6BDD",
          "actions": {
            "headerButton": []
          },
          "enableDataExport": false
        },
        "row": 0,
        "col": 0,
        "id": "40680065-1e6b-c6f8-af6a-23e82a99fad9"
      },
      "c6b19443-5057-176b-d3f8-2eebb67fc35e": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "203b0867-b867-ef98-1791-03046c133b7d",
              "dataKeys": [
                {
                  "name": "role",
                  "type": "attribute",
                  "label": "role",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.8853142583803868
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "0d59106c-3aec-67d1-e5c6-1bea2904541b",
              "dataKeys": [
                {
                  "name": "assignedTo",
                  "type": "attribute",
                  "label": "assignedTo",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.7564806610383635
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678196817440,
                "endTimeMs": 1678283217440
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "\n// Datasources:\n// \"Current User\" -> user role\n// \"Customer Diagnostic Kits\" -> kits (changed from \"All Diagnostic Kits\")\n\nvar userRole = '';\nvar kitsTotal = 0, kitsAssigned = 0, kitsAvailable = 0;\n\ndata.forEach(function(item) {\n  var alias = item.aliasName || '';\n\n  if (alias === 'Current User') {\n    // Current User\n    userRole = item.role || '';\n  } else if (alias === 'Customer Diagnostic Kits') {\n    // Changed from \"All Diagnostic Kits\" to match actual datasource alias\n    kitsTotal++;\n    if (item.assignedTo && item.assignedTo !== 'None' && item.assignedTo !== '') {\n      kitsAssigned++;\n    } else {\n      kitsAvailable++;\n    }\n  }\n});\n\nvar stateParams = ctx.stateController.getStateParams();\nvar isTenantAdmin = ctx.currentUser.authority === 'TENANT_ADMIN';\nvar isEcoAdmin = userRole === 'ECO Administrator';\nvar isAdmin = isTenantAdmin || isEcoAdmin;\nstateParams['userRole'] = userRole;\nctx.stateController.updateState(null, stateParams);\n\n// Header HTML with Go Back, Transfer Kit (ECO Admin only), and Add Kit (ECO/Tenant Admin) buttons\nvar headerHtml = '<div class=\"manage-header kits\">' +\n    '<div class=\"header-left\">' +\n        '<a id=\"btn-go-back\" class=\"back-button\" role=\"button\" title=\"Go Back\">' +\n            '<mat-icon>arrow_back</mat-icon>' +\n        '</a>' +\n        '<div class=\"header-title\">' +\n            '<h1><mat-icon>medical_services</mat-icon>Diagnostic Kits</h1>' +\n            '<div class=\"header-stats\">' +\n                '<span class=\"stat-item\"><span class=\"stat-dot total\"></span><span class=\"stat-value\">' + kitsTotal + '</span> Total</span>' +\n                '<span class=\"stat-item\"><span class=\"stat-dot assigned\"></span><span class=\"stat-value\">' + kitsAssigned + '</span> Assigned</span>' +\n                '<span class=\"stat-item\"><span class=\"stat-dot available\"></span><span class=\"stat-value\">' + kitsAvailable + '</span> Available</span>' +\n            '</div>' +\n        '</div>' +\n    '</div>' +\n    '<div class=\"header-right\">' +\n        (isEcoAdmin ? '<a id=\"btn-transfer-kit\" class=\"header-action-btn transfer\" role=\"button\" title=\"Transfer Kit\"><mat-icon>swap_horiz</mat-icon>Transfer Kit</a>' : '') +\n        (isAdmin ? '<a id=\"btn-add-kit\" class=\"header-action-btn\" role=\"button\" title=\"Add Kit\"><mat-icon>add</mat-icon>Add Kit</a>' : '') +\n    '</div>' +\n'</div>';\n\n// Content - fxFlex directly on tb-dashboard-state\nvar contentHtml = isAdmin\n    ? '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"manage_diagnostickits_admin\"></tb-dashboard-state>'\n    : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"manage_diagnostickits_admin\"></tb-dashboard-state>';\n\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\n       headerHtml +\n       contentHtml +\n       '</div>';\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget {\n    border-radius: 0px;\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n/* === Reusable Manage Header === */\n.manage-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem;\n    border-radius: 8px;\n    color: #ffffff;\n    min-height: 70px;\n    margin-bottom: 1rem;\n}\n\n.manage-header.kits {\n    background: linear-gradient(135deg, #3a6a9e 0%, #2c5278 100%);\n}\n\n.manage-header.projects {\n    background: linear-gradient(135deg, #26a69a 0%, #00897b 100%);\n}\n\n.manage-header.users {\n    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);\n}\n\n.header-left {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n}\n\n.back-button {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    width: 40px;\n    height: 40px;\n    background: rgba(255,255,255,0.15);\n    border: 1px solid rgba(255,255,255,0.3);\n    border-radius: 8px;\n    color: #ffffff;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    text-decoration: none;\n}\n\n.back-button:hover {\n    background: rgba(255,255,255,0.25);\n}\n\n.back-button mat-icon {\n    font-size: 24px !important;\n    width: 24px !important;\n    height: 24px !important;\n}\n\n.header-title {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n}\n\n.header-title h1 {\n    font-size: 1.4rem;\n    font-weight: 600;\n    margin: 0;\n    display: flex;\n    align-items: center;\n    gap: 0.6rem;\n}\n\n.header-title h1 mat-icon {\n    font-size: 26px !important;\n    width: 26px !important;\n    height: 26px !important;\n    opacity: 0.9;\n}\n\n.header-stats {\n    display: flex;\n    gap: 1.25rem;\n    font-size: 0.85rem;\n    opacity: 0.9;\n}\n\n.stat-item {\n    display: flex;\n    align-items: center;\n    gap: 0.35rem;\n}\n\n.stat-dot {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n}\n\n.stat-dot.total { background-color: #ffffff; }\n.stat-dot.assigned { background-color: #EB5757; }\n.stat-dot.available { background-color: #27AE60; }\n.stat-dot.planned { background-color: #F2994A; }\n.stat-dot.active { background-color: #27AE60; }\n.stat-dot.finished { background-color: #2F80ED; }\n.stat-dot.admin { background-color: #EB5757; }\n.stat-dot.engineer { background-color: #2F80ED; }\n.stat-dot.user { background-color: #27AE60; }\n\n.stat-value {\n    font-weight: 600;\n}\n\n.header-right {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n}\n\n.header-action-btn {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.6rem 1.2rem;\n    background: rgba(255,255,255,0.15);\n    border: 1px solid rgba(255,255,255,0.4);\n    border-radius: 6px;\n    color: #ffffff !important;\n    font-size: 0.875rem;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    text-decoration: none;\n}\n\n.header-action-btn mat-icon {\n    color: #ffffff !important;\n}\n\n.header-action-btn:hover {\n    background: rgba(255,255,255,0.95);\n    color: #2c5278 !important;\n    border-color: transparent;\n}\n\n.header-action-btn:hover mat-icon {\n    color: #2c5278 !important;\n}\n\n\n/* Force white text in manage-header */\n.manage-header,\n.manage-header h1,\n.manage-header .header-title,\n.manage-header .header-stats,\n.manage-header .stat-item,\n.manage-header .stat-value,\n.manage-header mat-icon {\n    color: #ffffff !important;\n}\n\n.content-area {\n    flex: 1;\n    overflow: hidden;\n}\n\n.main-layout .header {\n    height: 60px;\n    margin: 4px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n/* Flexbox height fix - prevent scrolling */\n.main-layout {\n    display: flex;\n    flex-direction: column;\n    min-height: 0;\n    overflow: hidden;\n}\n\n.main-layout > .manage-header {\n    flex: 0 0 auto;\n}\n\n.main-layout > tb-dashboard-state {\n    flex: 1 1 auto;\n    min-height: 0;\n    height: 100%;\n    overflow: hidden;\n}\n\n/* Ensure parent containers also have proper height */\n.tb-markdown-view {\n    height: 100%;\n    overflow: hidden;\n}\n\n.tb-markdown-view > div {\n    height: 100%;\n    overflow: hidden;\n}\n\n/* Transfer Kit Button - distinct styling */\n.header-action-btn.transfer {\n    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);\n    margin-right: 8px;\n}\n\n.header-action-btn.transfer:hover {\n    background: linear-gradient(135deg, #d97706 0%, #b45309 100%);\n    transform: translateY(-1px);\n    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);\n}\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow.no-padding {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 4px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "btn-go-back",
                "icon": "arrow_back",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nvar number = (widgetContext.stateController.getStateIndex())-1;\nwidgetContext.stateController.updateState(null, params);\nwidgetContext.stateController.navigatePrevState(number);",
                "id": "act-go-back"
              },
              {
                "name": "btn-add-kit",
                "icon": "add",
                "type": "customPretty",
                "customHtml": "<form\n  #addKitForm=\"ngForm\"\n  [formGroup]=\"addKitFormGroup\"\n  (ngSubmit)=\"save()\"\n  class=\"add-kit-dialog\"\n>\n  <!-- Header -->\n  <div class=\"dialog-header\">\n    <mat-icon>medical_services</mat-icon>\n    <h2>Add Diagnostic Kit</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\" class=\"close-btn\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </div>\n\n  <mat-progress-bar color=\"accent\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\n\n  <div class=\"dialog-body\">\n    <!-- Customer Selection Card -->\n    <div class=\"section-card customer-card\">\n      <div class=\"card-header-mini\">\n        <mat-icon>business</mat-icon>\n        <span>Customer</span>\n      </div>\n      <mat-form-field appearance=\"outline\" class=\"w-full\">\n        <mat-label>Select Customer</mat-label>\n        <mat-select formControlName=\"customerId\" (selectionChange)=\"onCustomerChange($event)\" required>\n          <mat-option *ngFor=\"let customer of customers\" [value]=\"customer.id.id\">\n            {{ customer.name }}\n          </mat-option>\n        </mat-select>\n        <mat-icon matPrefix>person</mat-icon>\n        <mat-error *ngIf=\"addKitFormGroup.get('customerId').hasError('required')\">\n          Please select a customer\n        </mat-error>\n      </mat-form-field>\n    </div>\n\n    <!-- Stepper -->\n    <mat-stepper #stepper [linear]=\"true\" [formGroup]=\"addKitFormGroup\" (selectionChange)=\"onStepChange($event)\" class=\"kit-stepper\">\n\n      <!-- Step 1: Kit & Gateway Details -->\n      <mat-step [stepControl]=\"addKitFormGroup.get('kitDetails')\">\n        <ng-template matStepLabel>Kit & Gateway</ng-template>\n\n        <div [formGroup]=\"addKitFormGroup.get('kitDetails')\" class=\"step-content\">\n\n          <div class=\"form-row\">\n            <!-- Kit Type Card -->\n            <div class=\"form-col\">\n              <div class=\"input-group\">\n                <label class=\"input-label\">Kit Type</label>\n                <mat-form-field appearance=\"outline\" class=\"w-full\">\n                  <mat-select formControlName=\"kitType\" (selectionChange)=\"onKitTypeChange($event)\" required>\n                    <mat-select-trigger>\n                      <div class=\"flex items-center gap-2\">\n                        <mat-icon *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis'\" style=\"font-size: 18px; width: 18px; height: 18px; color: #3b82f6;\">router</mat-icon>\n                        <mat-icon *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'lorawan'\" style=\"font-size: 18px; width: 18px; height: 18px; color: #8b5cf6;\">cell_tower</mat-icon>\n                        <span *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis'\">Base Kit (RESI)</span>\n                        <span *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'lorawan'\">Room Kit (LoRaWAN)</span>\n                      </div>\n                    </mat-select-trigger>\n                    <mat-option value=\"basis\">\n                      <div class=\"flex items-center gap-2\">\n                        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px; color: #3b82f6;\">router</mat-icon>\n                        <span>Base Kit (RESI)</span>\n                      </div>\n                    </mat-option>\n                    <mat-option value=\"lorawan\">\n                      <div class=\"flex items-center gap-2\">\n                        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px; color: #8b5cf6;\">cell_tower</mat-icon>\n                        <span>Room Kit (LoRaWAN)</span>\n                      </div>\n                    </mat-option>\n                  </mat-select>\n                  <mat-icon matPrefix>category</mat-icon>\n                </mat-form-field>\n              </div>\n            </div>\n\n            <!-- Kit Name -->\n            <div class=\"form-col\">\n              <div class=\"input-group\">\n                <label class=\"input-label\">Kit Name</label>\n                <mat-form-field appearance=\"outline\" class=\"w-full\">\n                  <input matInput formControlName=\"kitName\" required\n                         [placeholder]=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis' ? 'DBKIT001' : 'DRKIT001'\" />\n                  <mat-icon matPrefix>label</mat-icon>\n                  <mat-hint>{{ addKitFormGroup.get('kitDetails').get('kitType').value === 'basis' ? 'Format: DBKIT...' : 'Format: DRKIT...' }}</mat-hint>\n                  <mat-error *ngIf=\"addKitFormGroup.get('kitDetails').get('kitName').hasError('required')\">\n                    Kit name is required\n                  </mat-error>\n                  <mat-error *ngIf=\"addKitFormGroup.get('kitDetails').get('kitName').hasError('pattern')\">\n                    Use {{ addKitFormGroup.get('kitDetails').get('kitType').value === 'basis' ? 'DBKIT...' : 'DRKIT...' }} format\n                  </mat-error>\n                </mat-form-field>\n              </div>\n            </div>\n          </div>\n\n          <!-- Gateway Section -->\n          <div class=\"section-card gateway-card\">\n            <div class=\"card-header-mini\">\n              <mat-icon>settings_input_antenna</mat-icon>\n              <span>Gateway Configuration</span>\n              <span class=\"badge\" [class.badge-blue]=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis'\"\n                                  [class.badge-purple]=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'lorawan'\">\n                {{ addKitFormGroup.get('kitDetails').get('kitType').value === 'basis' ? 'RESI' : 'LoRaWAN' }}\n              </span>\n            </div>\n\n            <div *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis'\" class=\"gateway-form\">\n              <mat-form-field appearance=\"outline\" class=\"w-full\">\n                <mat-label>Gateway Serial Number</mat-label>\n                <input matInput formControlName=\"gatewaySerial\" placeholder=\"Enter serial number\" />\n                <mat-icon matPrefix>qr_code</mat-icon>\n                <mat-icon matSuffix *ngIf=\"addKitFormGroup.get('kitDetails').get('gatewaySerial').value?.length > 0\"\n                          [class.valid-icon]=\"addKitFormGroup.get('kitDetails').get('gatewaySerial').valid\"\n                          [class.invalid-icon]=\"addKitFormGroup.get('kitDetails').get('gatewaySerial').invalid\">\n                  {{ addKitFormGroup.get('kitDetails').get('gatewaySerial').valid ? 'check_circle' : 'error' }}\n                </mat-icon>\n                <mat-hint>Serial number from the RESI gateway label</mat-hint>\n                <mat-error>Gateway Serial Number is required</mat-error>\n              </mat-form-field>\n            </div>\n\n            <div *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'lorawan'\" class=\"gateway-form\">\n              <mat-form-field appearance=\"outline\" class=\"w-full\">\n                <mat-label>Gateway ID</mat-label>\n                <input matInput formControlName=\"gatewayId\" placeholder=\"16-character ID\" maxlength=\"16\" />\n                <mat-icon matPrefix>vpn_key</mat-icon>\n                <mat-icon matSuffix *ngIf=\"addKitFormGroup.get('kitDetails').get('gatewayId').value?.length > 0\"\n                          [class.valid-icon]=\"isGatewayIdValid()\"\n                          [class.invalid-icon]=\"!isGatewayIdValid()\">\n                  {{ isGatewayIdValid() ? 'check_circle' : 'error' }}\n                </mat-icon>\n                <mat-hint>\n                  <span class=\"char-counter\" [class.complete]=\"addKitFormGroup.get('kitDetails').get('gatewayId').value?.length === 16\">\n                    {{ addKitFormGroup.get('kitDetails').get('gatewayId').value?.length || 0 }}/16 characters\n                  </span>\n                </mat-hint>\n                <mat-error>Must be exactly 16 alphanumeric characters</mat-error>\n              </mat-form-field>\n            </div>\n          </div>\n\n          <!-- Step Actions -->\n          <div class=\"step-actions\">\n            <span></span>\n            <button mat-flat-button color=\"primary\" matStepperNext type=\"button\"\n                    [disabled]=\"addKitFormGroup.get('kitDetails').invalid || addKitFormGroup.get('customerId').invalid\"\n                    class=\"next-btn\">\n              Continue <mat-icon>arrow_forward</mat-icon>\n            </button>\n          </div>\n        </div>\n      </mat-step>\n\n      <!-- Step 2: Devices -->\n      <mat-step [stepControl]=\"addKitFormGroup.get('devices')\">\n        <ng-template matStepLabel>Devices</ng-template>\n\n        <div [formGroup]=\"addKitFormGroup.get('devices')\" class=\"step-content\">\n\n          <!-- Base Kit Devices -->\n          <div *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis'\">\n            <div class=\"info-banner\">\n              <mat-icon>lightbulb</mat-icon>\n              <span>Device names are auto-generated based on gateway serial number.</span>\n            </div>\n\n            <!-- P-Flow Devices -->\n            <div class=\"section-card devices-card\">\n              <div class=\"card-header-mini\">\n                <mat-icon>sensors</mat-icon>\n                <span>P-Flow D116 Devices</span>\n                <span class=\"device-count\">{{ pflowDevicesArray.length }}</span>\n              </div>\n              <div formArrayName=\"pflowDevices\" class=\"devices-list\">\n                <div *ngFor=\"let device of pflowDevicesArray.controls; let i = index\" [formGroupName]=\"i\" class=\"device-item\">\n                  <div class=\"device-icon pflow\">\n                    <mat-icon>speed</mat-icon>\n                  </div>\n                  <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                    <input matInput formControlName=\"name\" readonly />\n                  </mat-form-field>\n                  <button mat-icon-button type=\"button\" (click)=\"removePflowDevice(i)\" [disabled]=\"!canRemoveDevice('pflow', i)\" class=\"delete-btn\">\n                    <mat-icon>close</mat-icon>\n                  </button>\n                </div>\n                <div *ngIf=\"pflowDevicesArray.length === 0\" class=\"empty-state\">\n                  <span>No P-Flow devices added yet</span>\n                </div>\n              </div>\n              <button mat-stroked-button type=\"button\" (click)=\"addPflowDevice()\" class=\"add-device-btn\">\n                <mat-icon>add_circle_outline</mat-icon> Add P-Flow D116\n              </button>\n            </div>\n\n            <!-- Temperature Sensors -->\n            <div class=\"section-card devices-card\">\n              <div class=\"card-header-mini\">\n                <mat-icon>thermostat</mat-icon>\n                <span>Temperature Sensors</span>\n                <span class=\"device-count\">{{ tempSensorsArray.length }}</span>\n              </div>\n              <div formArrayName=\"tempSensors\" class=\"devices-list\">\n                <div *ngFor=\"let sensor of tempSensorsArray.controls; let i = index\" [formGroupName]=\"i\" class=\"device-item\">\n                  <div class=\"device-icon temp\">\n                    <mat-icon>thermostat</mat-icon>\n                  </div>\n                  <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                    <input matInput formControlName=\"name\" readonly />\n                  </mat-form-field>\n                  <button mat-icon-button type=\"button\" (click)=\"removeTempSensor(i)\" [disabled]=\"!canRemoveDevice('temp', i)\" class=\"delete-btn\">\n                    <mat-icon>close</mat-icon>\n                  </button>\n                </div>\n                <div *ngIf=\"tempSensorsArray.length === 0\" class=\"empty-state\">\n                  <span>No temperature sensors added yet</span>\n                </div>\n              </div>\n              <button mat-stroked-button type=\"button\" (click)=\"addTempSensor()\" class=\"add-device-btn\">\n                <mat-icon>add_circle_outline</mat-icon> Add Temperature Sensor\n              </button>\n            </div>\n          </div>\n\n          <!-- Room Kit Devices -->\n          <div *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'lorawan'\">\n            <div class=\"info-banner\">\n              <mat-icon>lightbulb</mat-icon>\n              <span>Enter DevEUI and AppKey for each CO2 sensor. Names are auto-generated.</span>\n            </div>\n\n            <div class=\"section-card devices-card\">\n              <div class=\"card-header-mini\">\n                <mat-icon>co2</mat-icon>\n                <span>Room Sensor CO2</span>\n                <span class=\"device-count\">{{ roomSensorsArray.length }}</span>\n              </div>\n              <div formArrayName=\"roomSensors\" class=\"devices-list\">\n                <div *ngFor=\"let sensor of roomSensorsArray.controls; let i = index\" [formGroupName]=\"i\" class=\"device-item-card\">\n                  <div class=\"device-item-header\">\n                    <div class=\"device-icon co2\">\n                      <mat-icon>co2</mat-icon>\n                    </div>\n                    <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                      <input matInput formControlName=\"name\" readonly />\n                    </mat-form-field>\n                    <button mat-icon-button type=\"button\" (click)=\"removeRoomSensor(i)\" [disabled]=\"!canRemoveDevice('room', i)\" class=\"delete-btn\">\n                      <mat-icon>close</mat-icon>\n                    </button>\n                  </div>\n                  <div class=\"credentials-row\">\n                    <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                      <mat-label>DevEUI</mat-label>\n                      <input matInput formControlName=\"devEUI\" required maxlength=\"16\" placeholder=\"16 characters\" />\n                      <mat-icon matPrefix>fingerprint</mat-icon>\n                      <mat-icon matSuffix *ngIf=\"sensor.get('devEUI').value?.length > 0\"\n                                [class.valid-icon]=\"isDevEUIValid(sensor)\"\n                                [class.invalid-icon]=\"!isDevEUIValid(sensor)\">\n                        {{ isDevEUIValid(sensor) ? 'check_circle' : 'error' }}\n                      </mat-icon>\n                      <mat-hint>\n                        <span class=\"char-counter\" [class.complete]=\"sensor.get('devEUI').value?.length === 16\">\n                          {{ sensor.get('devEUI').value?.length || 0 }}/16\n                        </span>\n                      </mat-hint>\n                    </mat-form-field>\n                    <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                      <mat-label>AppKey</mat-label>\n                      <input matInput formControlName=\"appKey\" required maxlength=\"32\" placeholder=\"32 characters\" />\n                      <mat-icon matPrefix>key</mat-icon>\n                      <mat-icon matSuffix *ngIf=\"sensor.get('appKey').value?.length > 0\"\n                                [class.valid-icon]=\"isAppKeyValid(sensor)\"\n                                [class.invalid-icon]=\"!isAppKeyValid(sensor)\">\n                        {{ isAppKeyValid(sensor) ? 'check_circle' : 'error' }}\n                      </mat-icon>\n                      <mat-hint>\n                        <span class=\"char-counter\" [class.complete]=\"sensor.get('appKey').value?.length === 32\">\n                          {{ sensor.get('appKey').value?.length || 0 }}/32\n                        </span>\n                      </mat-hint>\n                    </mat-form-field>\n                  </div>\n                </div>\n                <div *ngIf=\"roomSensorsArray.length === 0\" class=\"empty-state\">\n                  <span>No CO2 sensors added yet</span>\n                </div>\n              </div>\n              <button mat-stroked-button type=\"button\" (click)=\"addRoomSensor()\" class=\"add-device-btn\">\n                <mat-icon>add_circle_outline</mat-icon> Add Room Sensor CO2\n              </button>\n            </div>\n          </div>\n\n          <!-- Step Actions -->\n          <div class=\"step-actions\">\n            <button mat-button matStepperPrevious type=\"button\" class=\"back-btn\">\n              <mat-icon>arrow_back</mat-icon> Back\n            </button>\n            <button mat-flat-button color=\"primary\" matStepperNext type=\"button\" class=\"next-btn\">\n              Continue <mat-icon>arrow_forward</mat-icon>\n            </button>\n          </div>\n        </div>\n      </mat-step>\n\n      <!-- Step 3: Credentials (only for Base Kit / RESI Gateway) -->\n      <mat-step *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis'\">\n        <ng-template matStepLabel>Credentials & Summary</ng-template>\n\n        <div class=\"step-content\">\n          <div class=\"info-banner\">\n            <mat-icon>security</mat-icon>\n            <span>Configure MQTT credentials for the RESI gateway connection.</span>\n          </div>\n\n          <!-- Credentials Card -->\n          <div class=\"section-card credentials-card\">\n            <div class=\"card-header-mini\">\n              <mat-icon>vpn_key</mat-icon>\n              <span>MQTT Credentials</span>\n            </div>\n            <div [formGroup]=\"addKitFormGroup.get('credentials')\" class=\"credentials-form\">\n              <mat-form-field appearance=\"outline\" class=\"w-full\">\n                <mat-label>Client ID</mat-label>\n                <input matInput formControlName=\"clientId\" required readonly />\n                <mat-icon matPrefix>badge</mat-icon>\n              </mat-form-field>\n              <div class=\"credentials-row\">\n                <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                  <mat-label>Username</mat-label>\n                  <input matInput formControlName=\"userName\" required />\n                  <mat-icon matPrefix>person</mat-icon>\n                </mat-form-field>\n                <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                  <mat-label>Password</mat-label>\n                  <input matInput formControlName=\"password\" required />\n                  <mat-icon matPrefix>lock</mat-icon>\n                  <button mat-icon-button matSuffix type=\"button\" (click)=\"regeneratePassword()\" matTooltip=\"Generate new password\">\n                    <mat-icon>refresh</mat-icon>\n                  </button>\n                </mat-form-field>\n              </div>\n            </div>\n          </div>\n\n          <!-- Summary Card -->\n          <div class=\"section-card summary-card\">\n            <div class=\"card-header-mini\">\n              <mat-icon>summarize</mat-icon>\n              <span>Kit Summary</span>\n            </div>\n            <div class=\"summary-grid\">\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>business</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Customer</span>\n                  <span class=\"summary-value\">{{ getSelectedCustomerName() }}</span>\n                </div>\n              </div>\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>medical_services</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Kit</span>\n                  <span class=\"summary-value\">{{ addKitFormGroup.get('kitDetails').get('kitName').value }}</span>\n                  <span class=\"summary-badge\">Base Kit</span>\n                </div>\n              </div>\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>router</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Gateway</span>\n                  <span class=\"summary-value\">{{ getGatewayName() }}</span>\n                </div>\n              </div>\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>devices</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Devices</span>\n                  <span class=\"summary-value\">{{ getTotalDeviceCount() }} device(s)</span>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <!-- Step Actions -->\n          <div class=\"step-actions\">\n            <button mat-button matStepperPrevious type=\"button\" class=\"back-btn\">\n              <mat-icon>arrow_back</mat-icon> Back\n            </button>\n            <button mat-flat-button color=\"primary\" type=\"submit\" [disabled]=\"addKitFormGroup.invalid || (isLoading$ | async)\" class=\"submit-btn\">\n              <mat-icon>check_circle</mat-icon> Create Kit\n            </button>\n          </div>\n        </div>\n      </mat-step>\n\n      <!-- Step 3 for Room Kit: Summary (no credentials needed) -->\n      <mat-step *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'lorawan'\">\n        <ng-template matStepLabel>Summary</ng-template>\n\n        <div class=\"step-content\">\n          <!-- Summary Card -->\n          <div class=\"section-card summary-card\">\n            <div class=\"card-header-mini\">\n              <mat-icon>summarize</mat-icon>\n              <span>Kit Summary</span>\n            </div>\n            <div class=\"summary-grid\">\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>business</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Customer</span>\n                  <span class=\"summary-value\">{{ getSelectedCustomerName() }}</span>\n                </div>\n              </div>\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>medical_services</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Kit</span>\n                  <span class=\"summary-value\">{{ addKitFormGroup.get('kitDetails').get('kitName').value }}</span>\n                  <span class=\"summary-badge purple\">Room Kit</span>\n                </div>\n              </div>\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>wifi_tethering</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Gateway</span>\n                  <span class=\"summary-value\">{{ getGatewayName() }}</span>\n                </div>\n              </div>\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>co2</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">CO2 Sensors</span>\n                  <span class=\"summary-value\">{{ getTotalDeviceCount() }} device(s)</span>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <!-- Step Actions -->\n          <div class=\"step-actions\">\n            <button mat-button matStepperPrevious type=\"button\" class=\"back-btn\">\n              <mat-icon>arrow_back</mat-icon> Back\n            </button>\n            <button mat-flat-button color=\"primary\" type=\"submit\" [disabled]=\"addKitFormGroup.invalid || (isLoading$ | async)\" class=\"submit-btn\">\n              <mat-icon>check_circle</mat-icon> Create Kit\n            </button>\n          </div>\n        </div>\n      </mat-step>\n\n    </mat-stepper>\n  </div>\n</form>",
                "customCss": "\n/* ============================================\n   ADD KIT DIALOG - PROFESSIONAL DESIGN\n   ============================================ */\n\n.add-kit-dialog {\n  width: 780px;\n  max-height: 85vh;\n  display: flex;\n  flex-direction: column;\n  background: #f8fafc;\n  border-radius: 12px;\n  overflow: hidden;\n}\n\n/* Header */\n/* Header - compact */\n.dialog-header {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  padding: 14px 20px;\n  background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);\n  color: white;\n}\n.dialog-header mat-icon {\n  font-size: 24px;\n  width: 24px;\n  height: 24px;\n}\n.dialog-header h2 {\n  margin: 0;\n  font-size: 18px;\n  font-weight: 600;\n}\n.close-btn {\n  color: rgba(255,255,255,0.8) !important;\n}\n.close-btn:hover {\n  color: white !important;\n  background: rgba(255,255,255,0.1) !important;\n}\n\n/* Dialog Body - reduced padding */\n.dialog-body {\n  flex: 1;\n  overflow-y: auto;\n  padding: 16px;\n}\n\n/* Section Cards - compact */\n.section-card {\n  background: white;\n  border-radius: 8px;\n  border: 1px solid #e2e8f0;\n  margin-bottom: 12px;\n  overflow: hidden;\n}\n\n.card-header-mini {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  padding: 10px 14px;\n  background: #f8fafc;\n  border-bottom: 1px solid #e2e8f0;\n  font-weight: 600;\n  font-size: 14px;\n  color: #334155;\n}\n.card-header-mini mat-icon {\n  font-size: 18px;\n  width: 18px;\n  height: 18px;\n  color: #64748b;\n}\n\n/* Customer Card */\n.customer-card {\n  padding: 14px;\n}\n.customer-card .card-header-mini {\n  padding: 0;\n  background: transparent;\n  border: none;\n  margin-bottom: 10px;\n}\n\n/* Gateway Card */\n.gateway-card {\n  border-left: 3px solid #3b82f6;\n}\n.gateway-form {\n  padding: 14px;\n}\n\n/* Badge Styles */\n.badge {\n  font-size: 11px;\n  font-weight: 600;\n  padding: 3px 8px;\n  border-radius: 12px;\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n  margin-left: auto;\n}\n.badge-blue {\n  background: #dbeafe;\n  color: #1d4ed8;\n}\n.badge-purple {\n  background: #ede9fe;\n  color: #7c3aed;\n}\n\n/* Form Styling - compact */\n.step-content {\n  padding-top: 8px;\n}\n\n.form-row {\n  display: flex;\n  gap: 12px;\n  margin-bottom: 4px;\n}\n.form-col {\n  flex: 1;\n}\n\n.input-group {\n  margin-bottom: 4px;\n}\n.input-label {\n  font-size: 12px;\n  font-weight: 600;\n  color: #64748b;\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n  margin-bottom: 6px;\n  display: block;\n}\n\n/* Mat Form Field Overrides */\n.add-kit-dialog .mat-mdc-form-field-subscript-wrapper {\n  margin-top: 4px;\n}\n\n.option-content {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n}\n.option-content mat-icon {\n  color: #64748b;\n}\n.option-content small {\n  color: #94a3b8;\n  font-size: 12px;\n  margin-left: auto;\n}\n\n/* Validation Icons */\n.valid-icon {\n  color: #10b981 !important;\n}\n.invalid-icon {\n  color: #ef4444 !important;\n}\n\n/* Character Counter */\n.char-counter {\n  font-family: 'SF Mono', Monaco, monospace;\n  font-size: 12px;\n  color: #94a3b8;\n}\n.char-counter.complete {\n  color: #10b981;\n  font-weight: 600;\n}\n\n/* Info Banner - compact */\n.info-banner {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  padding: 10px 14px;\n  background: #eff6ff;\n  border: 1px solid #bfdbfe;\n  border-radius: 6px;\n  margin-bottom: 12px;\n  font-size: 13px;\n  color: #1e40af;\n}\n.info-banner mat-icon {\n  color: #3b82f6;\n  font-size: 18px;\n  width: 18px;\n  height: 18px;\n  flex-shrink: 0;\n}\n\n/* Devices Card - compact */\n.devices-card {\n  border-left: 3px solid #8b5cf6;\n}\n.devices-list {\n  padding: 8px 14px;\n}\n\n.device-count {\n  margin-left: auto;\n  background: #e2e8f0;\n  color: #475569;\n  font-size: 12px;\n  font-weight: 700;\n  padding: 2px 8px;\n  border-radius: 10px;\n}\n\n/* Device Item - aligned */\n.device-item {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  padding: 6px 0;\n  border-bottom: 1px solid #f1f5f9;\n}\n.device-item:last-child {\n  border-bottom: none;\n}\n.device-item .mat-mdc-form-field {\n  margin-bottom: 0;\n}\n\n/* Room Sensor Card */\n.device-item-card {\n  background: #f8fafc;\n  border: 1px solid #e2e8f0;\n  border-radius: 6px;\n  padding: 10px;\n  margin-bottom: 8px;\n}\n.device-item-header {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  margin-bottom: 8px;\n}\n\n/* Device Icon - white icons, centered */\n.device-icon {\n  width: 32px;\n  height: 32px;\n  min-width: 32px;\n  border-radius: 6px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  flex-shrink: 0;\n}\n.device-icon mat-icon {\n  font-size: 18px;\n  width: 18px;\n  height: 18px;\n  color: white !important;\n}\n.device-icon.pflow {\n  background: #3b82f6;\n}\n.device-icon.temp {\n  background: #f59e0b;\n}\n.device-icon.co2 {\n  background: #10b981;\n}\n\n.credentials-row {\n  display: flex;\n  gap: 10px;\n}\n\n.empty-state {\n  text-align: center;\n  padding: 12px;\n  color: #94a3b8;\n  font-size: 14px;\n}\n\n.delete-btn {\n  color: #94a3b8 !important;\n  flex-shrink: 0;\n}\n.delete-btn:hover:not([disabled]) {\n  color: #ef4444 !important;\n  background: #fef2f2 !important;\n}\n.delete-btn[disabled] {\n  opacity: 0.3;\n}\n\n.add-device-btn {\n  margin: 6px 14px 10px;\n  border-color: #cbd5e1 !important;\n  color: #475569 !important;\n  font-size: 14px !important;\n}\n.add-device-btn mat-icon {\n  margin-right: 4px;\n  font-size: 18px;\n}\n.add-device-btn:hover {\n  background: #f1f5f9 !important;\n}\n\n/* Credentials Card - compact */\n.credentials-card {\n  border-left: 3px solid #f59e0b;\n}\n.credentials-form {\n  padding: 12px 14px;\n}\n\n/* Summary Card - compact */\n.summary-card {\n  border-left: 3px solid #10b981;\n}\n.summary-grid {\n  padding: 4px 14px 10px;\n}\n.summary-row {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  padding: 6px 0;\n  border-bottom: 1px solid #f1f5f9;\n}\n.summary-row:last-child {\n  border-bottom: none;\n}\n.summary-icon {\n  width: 32px;\n  height: 32px;\n  background: #f1f5f9;\n  border-radius: 8px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  flex-shrink: 0;\n}\n.summary-icon mat-icon {\n  color: #64748b;\n  font-size: 18px;\n  width: 18px;\n  height: 18px;\n}\n.summary-content {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  gap: 2px;\n}\n.summary-label {\n  font-size: 13px;\n  color: #94a3b8;\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n}\n.summary-value {\n  font-size: 16px;\n  font-weight: 600;\n  color: #1e293b;\n}\n.summary-badge {\n  font-size: 12px;\n  font-weight: 600;\n  padding: 3px 10px;\n  border-radius: 12px;\n  background: #dbeafe;\n  color: #1d4ed8;\n  margin-left: auto;\n  align-self: center;\n}\n.summary-badge.purple {\n  background: #ede9fe;\n  color: #7c3aed;\n}\n\n/* Step Actions - compact */\n.step-actions {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-top: 16px;\n  padding-top: 12px;\n  border-top: 1px solid #e2e8f0;\n}\n\n.back-btn {\n  color: #64748b !important;\n}\n.back-btn mat-icon {\n  margin-right: 4px;\n}\n\n.next-btn, .submit-btn {\n  font-weight: 600 !important;\n  padding: 0 24px !important;\n  height: 44px !important;\n  border-radius: 8px !important;\n}\n.next-btn mat-icon, .submit-btn mat-icon {\n  margin-left: 6px;\n}\n.submit-btn mat-icon {\n  margin-left: 0;\n  margin-right: 6px;\n}\n\n/* Stepper Styling - compact */\n.kit-stepper {\n  background: transparent !important;\n}\n.kit-stepper .mat-horizontal-stepper-header-container {\n  background: white;\n  border-radius: 8px;\n  border: 1px solid #e2e8f0;\n  padding: 4px 10px;\n  margin-bottom: 12px;\n}\n.kit-stepper .mat-step-header {\n  border-radius: 8px;\n}\n.kit-stepper .mat-step-header:hover {\n  background: #f8fafc;\n}\n.kit-stepper .mat-step-icon-selected {\n  background: #1e3a5f !important;\n}\n",
                "customFunction": "\nlet $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\nconst rxjs = widgetContext.rxjs;\nconst pageLink = widgetContext.pageLink(1000, 0, null, null, null);\n\n// Load customers first, then open dialog\ncustomerService.getCustomers(pageLink).subscribe(\n  function(result) {\n    openAddKitDialog(result.data || []);\n  },\n  function(error) {\n    console.error('Failed to load customers:', error);\n    openAddKitDialog([]);\n  }\n);\n\nfunction openAddKitDialog(customers) {\n  customDialog.customDialog(htmlTemplate, AddKitDialogController, { customers: customers }).subscribe();\n}\n\nfunction generateRandomPassword() {\n  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';\n  let password = '';\n  for (let i = 0; i < 20; i++) {\n    password += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return password;\n}\n\nfunction AddKitDialogController(instance) {\n  let vm = instance;\n  vm.customers = instance.data.customers || [];\n\n  // Form group - gatewaySerial has validators since default kit type is 'basis'\n  vm.addKitFormGroup = vm.fb.group({\n    customerId: [null, [vm.validators.required]],\n    kitDetails: vm.fb.group({\n      kitType: ['basis', [vm.validators.required]],\n      kitName: ['', [vm.validators.required, vm.validators.pattern(/^DBKIT.*$/)]],\n      gatewaySerial: ['', [vm.validators.required]],\n      gatewayId: ['']\n    }),\n    devices: vm.fb.group({\n      pflowDevices: vm.fb.array([]),\n      tempSensors: vm.fb.array([]),\n      roomSensors: vm.fb.array([])\n    }),\n    credentials: vm.fb.group({\n      clientId: ['', [vm.validators.required]],\n      userName: ['pke', [vm.validators.required]],\n      password: [generateRandomPassword(), [vm.validators.required]]\n    })\n  });\n\n  // Form array getters\n  vm.pflowDevicesArray = vm.addKitFormGroup.get('devices').get('pflowDevices');\n  vm.tempSensorsArray = vm.addKitFormGroup.get('devices').get('tempSensors');\n  vm.roomSensorsArray = vm.addKitFormGroup.get('devices').get('roomSensors');\n\n  // Pre-select customer if available from state params\n  let stateParams = widgetContext.stateController.getStateParams();\n  if (stateParams.entityId && stateParams.entityId.id) {\n    vm.addKitFormGroup.get('customerId').setValue(stateParams.entityId.id);\n  }\n\n  // ========== NAME CONSTRUCTION ==========\n  function constructPflowName(gatewayIdentifier, index) {\n    return 'ECO_' + gatewayIdentifier + '_PF' + index;\n  }\n\n  function constructTempSensorName(gatewayIdentifier, index) {\n    return 'ECO_' + gatewayIdentifier + '_TS' + index;\n  }\n\n  function constructRoomSensorName(gatewayIdentifier, index) {\n    return 'ECO_' + gatewayIdentifier + '_CO2_' + index;\n  }\n\n  function getGatewayIdentifier() {\n    const kitType = vm.addKitFormGroup.get('kitDetails').get('kitType').value;\n    if (kitType === 'basis') {\n      return vm.addKitFormGroup.get('kitDetails').get('gatewaySerial').value || '';\n    } else {\n      return vm.addKitFormGroup.get('kitDetails').get('gatewayId').value || '';\n    }\n  }\n\n  function updateAllDeviceNames() {\n    const gwId = getGatewayIdentifier();\n\n    // Update P-Flow names\n    for (let i = 0; i < vm.pflowDevicesArray.length; i++) {\n      vm.pflowDevicesArray.at(i).get('name').setValue(constructPflowName(gwId, i + 1));\n    }\n\n    // Update Temperature Sensor names\n    for (let i = 0; i < vm.tempSensorsArray.length; i++) {\n      vm.tempSensorsArray.at(i).get('name').setValue(constructTempSensorName(gwId, i + 1));\n    }\n\n    // Update Room Sensor names\n    for (let i = 0; i < vm.roomSensorsArray.length; i++) {\n      vm.roomSensorsArray.at(i).get('name').setValue(constructRoomSensorName(gwId, i + 1));\n    }\n  }\n\n  // Watch gateway identifier changes\n  vm.addKitFormGroup.get('kitDetails').get('gatewaySerial').valueChanges.subscribe(function() {\n    updateAllDeviceNames();\n    updateClientId();\n  });\n\n  vm.addKitFormGroup.get('kitDetails').get('gatewayId').valueChanges.subscribe(function() {\n    updateAllDeviceNames();\n    updateClientId();\n  });\n\n  // Customer change handler\n  vm.onCustomerChange = function(event) {\n    vm.addKitFormGroup.get('kitDetails').get('kitName').updateValueAndValidity();\n  };\n\n  // Gateway ID validation helper (for Room Kit LoRaWAN)\n  vm.isGatewayIdValid = function() {\n    const gatewayId = vm.addKitFormGroup.get('kitDetails').get('gatewayId').value || '';\n    return /^[a-zA-Z0-9]{16}$/.test(gatewayId);\n  };\n\n  // DevEUI validation helper (16 alphanumeric chars)\n  vm.isDevEUIValid = function(sensorGroup) {\n    const devEUI = sensorGroup.get('devEUI').value || '';\n    return /^[a-zA-Z0-9]{16}$/.test(devEUI);\n  };\n\n  // AppKey validation helper (32 alphanumeric chars)\n  vm.isAppKeyValid = function(sensorGroup) {\n    const appKey = sensorGroup.get('appKey').value || '';\n    return /^[a-zA-Z0-9]{32}$/.test(appKey);\n  };\n\n  // Kit type change handler\n  vm.onKitTypeChange = function(event) {\n    const kitType = event.value;\n    const kitNameControl = vm.addKitFormGroup.get('kitDetails').get('kitName');\n    const gatewaySerialControl = vm.addKitFormGroup.get('kitDetails').get('gatewaySerial');\n    const gatewayIdControl = vm.addKitFormGroup.get('kitDetails').get('gatewayId');\n\n    const credentialsGroup = vm.addKitFormGroup.get('credentials');\n\n    if (kitType === 'basis') {\n      // Base Kit: DBKIT pattern, gatewaySerial required, gatewayId no validators, credentials required\n      kitNameControl.setValidators([vm.validators.required, vm.validators.pattern(/^DBKIT.*$/)]);\n      gatewaySerialControl.setValidators([vm.validators.required]);\n      gatewayIdControl.clearValidators();\n      gatewayIdControl.setValue('');\n      // Set credentials validators\n      credentialsGroup.get('clientId').setValidators([vm.validators.required]);\n      credentialsGroup.get('userName').setValidators([vm.validators.required]);\n      credentialsGroup.get('password').setValidators([vm.validators.required]);\n    } else {\n      // Room Kit: DRKIT pattern, gatewayId required with pattern, gatewaySerial no validators, no credentials\n      kitNameControl.setValidators([vm.validators.required, vm.validators.pattern(/^DRKIT.*$/)]);\n      gatewaySerialControl.clearValidators();\n      gatewaySerialControl.setValue('');\n      gatewayIdControl.setValidators([vm.validators.required, vm.validators.pattern(/^[a-zA-Z0-9]{16}$/)]);\n      // Clear credentials validators\n      credentialsGroup.get('clientId').clearValidators();\n      credentialsGroup.get('userName').clearValidators();\n      credentialsGroup.get('password').clearValidators();\n    }\n    kitNameControl.updateValueAndValidity();\n    gatewaySerialControl.updateValueAndValidity();\n    gatewayIdControl.updateValueAndValidity();\n    credentialsGroup.get('clientId').updateValueAndValidity();\n    credentialsGroup.get('userName').updateValueAndValidity();\n    credentialsGroup.get('password').updateValueAndValidity();\n\n    // Clear device arrays when kit type changes\n    while (vm.pflowDevicesArray.length) vm.pflowDevicesArray.removeAt(0);\n    while (vm.tempSensorsArray.length) vm.tempSensorsArray.removeAt(0);\n    while (vm.roomSensorsArray.length) vm.roomSensorsArray.removeAt(0);\n\n    updateClientId();\n  };\n\n  // Step change handler\n  vm.onStepChange = function(event) {\n    if (event.selectedIndex === 1) {\n      // Entering devices step - update device names\n      updateAllDeviceNames();\n    }\n    if (event.selectedIndex === 2) {\n      // Entering credentials step - update client ID\n      updateClientId();\n    }\n  };\n\n  function updateClientId() {\n    const gwId = getGatewayIdentifier();\n    // Client ID matches gateway name format: ECO_{identifier}_GW\n    const clientId = 'ECO_' + gwId + '_GW';\n    vm.addKitFormGroup.get('credentials').get('clientId').setValue(clientId);\n  }\n\n  // ========== DEVICE ARRAY METHODS ==========\n  vm.addPflowDevice = function() {\n    const gwId = getGatewayIdentifier();\n    const index = vm.pflowDevicesArray.length + 1;\n    vm.pflowDevicesArray.push(vm.fb.group({\n      name: [constructPflowName(gwId, index)]\n    }));\n  };\n\n  vm.removePflowDevice = function(index) {\n    if (vm.pflowDevicesArray.length > 0 && index === vm.pflowDevicesArray.length - 1) {\n      vm.pflowDevicesArray.removeAt(index);\n    }\n  };\n\n  vm.addTempSensor = function() {\n    const gwId = getGatewayIdentifier();\n    const index = vm.tempSensorsArray.length + 1;\n    vm.tempSensorsArray.push(vm.fb.group({\n      name: [constructTempSensorName(gwId, index)]\n    }));\n  };\n\n  vm.removeTempSensor = function(index) {\n    if (vm.tempSensorsArray.length > 0 && index === vm.tempSensorsArray.length - 1) {\n      vm.tempSensorsArray.removeAt(index);\n    }\n  };\n\n  vm.addRoomSensor = function() {\n    const gwId = getGatewayIdentifier();\n    const index = vm.roomSensorsArray.length + 1;\n    vm.roomSensorsArray.push(vm.fb.group({\n      name: [constructRoomSensorName(gwId, index)],\n      devEUI: ['', [vm.validators.required, vm.validators.pattern('[a-zA-Z0-9]{16}')]],\n      appKey: ['', [vm.validators.required, vm.validators.pattern('[a-zA-Z0-9]{32}')]]\n    }));\n  };\n\n  vm.removeRoomSensor = function(index) {\n    if (vm.roomSensorsArray.length > 0 && index === vm.roomSensorsArray.length - 1) {\n      vm.roomSensorsArray.removeAt(index);\n    }\n  };\n\n  vm.canRemoveDevice = function(type, index) {\n    if (type === 'pflow') {\n      return vm.pflowDevicesArray.length > 0 && index === vm.pflowDevicesArray.length - 1;\n    } else if (type === 'temp') {\n      return vm.tempSensorsArray.length > 0 && index === vm.tempSensorsArray.length - 1;\n    } else if (type === 'room') {\n      return vm.roomSensorsArray.length > 0 && index === vm.roomSensorsArray.length - 1;\n    }\n    return false;\n  };\n\n  vm.regeneratePassword = function() {\n    vm.addKitFormGroup.get('credentials').get('password').setValue(generateRandomPassword());\n  };\n\n  // ========== HELPER FUNCTIONS FOR SUMMARY ==========\n  vm.getSelectedCustomerName = function() {\n    const customerId = vm.addKitFormGroup.get('customerId').value;\n    const customer = vm.customers.find(function(c) { return c.id.id === customerId; });\n    return customer ? customer.name : '-';\n  };\n\n  vm.getGatewayName = function() {\n    const kitType = vm.addKitFormGroup.get('kitDetails').get('kitType').value;\n    if (kitType === 'basis') {\n      const serial = vm.addKitFormGroup.get('kitDetails').get('gatewaySerial').value;\n      return 'ECO_' + serial + '_GW';\n    } else {\n      const gwId = vm.addKitFormGroup.get('kitDetails').get('gatewayId').value;\n      return 'ECO_' + gwId + '_GW';\n    }\n  };\n\n  vm.getTotalDeviceCount = function() {\n    const kitType = vm.addKitFormGroup.get('kitDetails').get('kitType').value;\n    if (kitType === 'basis') {\n      return vm.pflowDevicesArray.length + vm.tempSensorsArray.length;\n    } else {\n      return vm.roomSensorsArray.length;\n    }\n  };\n\n  vm.cancel = function() {\n    vm.dialogRef.close(null);\n  };\n\n  // ========== SAVE LOGIC ==========\n  vm.save = function() {\n    vm.addKitFormGroup.markAsPristine();\n\n    const customerId = { id: vm.addKitFormGroup.get('customerId').value, entityType: 'CUSTOMER' };\n    const kitDetails = vm.addKitFormGroup.get('kitDetails').value;\n    const credentials = vm.addKitFormGroup.get('credentials').value;\n    const devices = vm.addKitFormGroup.get('devices').value;\n\n    // 1. Create Kit\n    createKit(customerId, kitDetails).pipe(\n      rxjs.switchMap(function(kit) {\n        // 2. Create Gateway and link to Kit\n        return createGateway(customerId, kitDetails, credentials).pipe(\n          rxjs.switchMap(function(gateway) {\n            // Link gateway to kit\n            return saveDeviceToKitRelation(kit.id, gateway.id).pipe(\n              rxjs.map(function() { return { kit: kit, gateway: gateway }; })\n            );\n          })\n        );\n      }),\n      rxjs.switchMap(function(result) {\n        // 3. Create Devices and link to Kit\n        return createDevices(customerId, kitDetails, devices).pipe(\n          rxjs.switchMap(function(createdDevices) {\n            if (createdDevices.length === 0) {\n              return rxjs.of(result);\n            }\n            // Link each device to kit\n            const relationObservables = createdDevices.map(function(device) {\n              return saveDeviceToKitRelation(result.kit.id, device.id);\n            });\n            return rxjs.forkJoin(relationObservables).pipe(\n              rxjs.map(function() { return result; })\n            );\n          })\n        );\n      })\n    ).subscribe(\n      function(result) {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      },\n      function(error) {\n        console.error('Error creating kit:', error);\n        widgetContext.dialogs.alert('Error', 'Failed to create kit: ' + (error.message || error));\n      }\n    );\n  };\n\n  // ========== ENTITY CREATION FUNCTIONS ==========\n\n  function createKit(customerId, kitDetails) {\n    return getOrCreateEntityGroup(customerId, 'ASSET', 'Diagnostickits').pipe(\n      rxjs.switchMap(function(diagnostickitsGroup) {\n        return getOrCreateEntityGroup(customerId, 'ASSET', 'Unassigned Diagnostic Kits').pipe(\n          rxjs.switchMap(function(unassignedGroup) {\n            const kit = {\n              name: kitDetails.kitName,\n              label: kitDetails.kitName,\n              type: 'Diagnostickit',\n              customerId: customerId\n            };\n\n            return assetService.saveAsset(kit, diagnostickitsGroup.id.id).pipe(\n              rxjs.switchMap(function(savedKit) {\n                return entityGroupService.addEntityToEntityGroup(unassignedGroup.id.id, savedKit.id.id).pipe(\n                  rxjs.switchMap(function() {\n                    const attributes = [{ key: 'kitType', value: kitDetails.kitType }];\n                    return attributeService.saveEntityAttributes(savedKit.id, 'SERVER_SCOPE', attributes).pipe(\n                      rxjs.switchMap(function() {\n                        return saveRelation(customerId, savedKit.id, 'Owns').pipe(\n                          rxjs.map(function() { return savedKit; })\n                        );\n                      })\n                    );\n                  })\n                );\n              })\n            );\n          })\n        );\n      })\n    );\n  }\n\n  function createGateway(customerId, kitDetails, credentials) {\n    return getOrCreateEntityGroup(customerId, 'DEVICE', 'Diagnostickit Devices').pipe(\n      rxjs.switchMap(function(devicesGroup) {\n        return getOrCreateEntityGroup(customerId, 'DEVICE', 'Unassigned Measurement Devices').pipe(\n          rxjs.switchMap(function(unassignedGroup) {\n            let gatewayName, gatewayType, gatewayAttributes;\n\n            if (kitDetails.kitType === 'basis') {\n              gatewayName = 'ECO_' + kitDetails.gatewaySerial + '_GW';\n              gatewayType = 'RESI';\n              gatewayAttributes = [\n                { key: 'isGateway', value: true },\n                { key: 'serialNumber', value: kitDetails.gatewaySerial },\n                { key: 'inactivityTimeout', value: 60 }\n              ];\n            } else {\n              gatewayName = 'ECO_' + kitDetails.gatewayId + '_GW';\n              gatewayType = 'Gateway';\n              gatewayAttributes = [\n                { key: 'isGateway', value: true },\n                { key: 'gatewayID', value: kitDetails.gatewayId },\n                { key: 'inactivityTimeout', value: 60 }\n              ];\n            }\n\n            const gateway = {\n              name: gatewayName,\n              label: kitDetails.kitName,\n              type: gatewayType,\n              customerId: customerId\n            };\n\n            return deviceService.saveDevice(gateway, devicesGroup.id.id).pipe(\n              rxjs.switchMap(function(savedGateway) {\n                return entityGroupService.addEntityToEntityGroup(unassignedGroup.id.id, savedGateway.id.id).pipe(\n                  rxjs.switchMap(function() {\n                    return attributeService.saveEntityAttributes(savedGateway.id, 'SERVER_SCOPE', gatewayAttributes).pipe(\n                      rxjs.switchMap(function() {\n                        // Update credentials only for Base Kit (RESI gateway)\n                        if (kitDetails.kitType === 'basis') {\n                          return updateDeviceCredentials(savedGateway.id, credentials).pipe(\n                            rxjs.switchMap(function() {\n                              return saveRelation(customerId, savedGateway.id, 'Owns').pipe(\n                                rxjs.map(function() { return savedGateway; })\n                              );\n                            })\n                          );\n                        } else {\n                          // Room Kit (LoRaWAN) - no credentials needed\n                          return saveRelation(customerId, savedGateway.id, 'Owns').pipe(\n                            rxjs.map(function() { return savedGateway; })\n                          );\n                        }\n                      })\n                    );\n                  })\n                );\n              })\n            );\n          })\n        );\n      })\n    );\n  }\n\n  function updateDeviceCredentials(deviceId, credentials) {\n    return deviceService.getDeviceCredentials(deviceId.id).pipe(\n      rxjs.switchMap(function(existingCredentials) {\n        const deviceCredentials = {\n          id: existingCredentials.id,\n          deviceId: existingCredentials.deviceId,\n          credentialsType: 'MQTT_BASIC',\n          credentialsValue: JSON.stringify({\n            clientId: credentials.clientId,\n            userName: credentials.userName,\n            password: credentials.password\n          })\n        };\n        return deviceService.saveDeviceCredentials(deviceCredentials);\n      })\n    );\n  }\n\n  function createDevices(customerId, kitDetails, devices) {\n    let devicesToCreate = [];\n\n    if (kitDetails.kitType === 'basis') {\n      devices.pflowDevices.forEach(function(d) {\n        devicesToCreate.push({ name: d.name, type: 'P-Flow D116' });\n      });\n      devices.tempSensors.forEach(function(d) {\n        devicesToCreate.push({ name: d.name, type: 'Temperature Sensor' });\n      });\n    } else {\n      devices.roomSensors.forEach(function(d) {\n        devicesToCreate.push({\n          name: d.name,\n          type: 'Room Sensor CO2',\n          devEUI: d.devEUI,\n          appKey: d.appKey\n        });\n      });\n    }\n\n    if (devicesToCreate.length === 0) {\n      return rxjs.of([]);\n    }\n\n    return getOrCreateEntityGroup(customerId, 'DEVICE', 'Diagnostickit Devices').pipe(\n      rxjs.switchMap(function(devicesGroup) {\n        return getOrCreateEntityGroup(customerId, 'DEVICE', 'Unassigned Measurement Devices').pipe(\n          rxjs.switchMap(function(unassignedGroup) {\n            const observables = devicesToCreate.map(function(deviceInfo) {\n              const device = {\n                name: deviceInfo.name,\n                label: kitDetails.kitName,\n                type: deviceInfo.type,\n                customerId: customerId\n              };\n\n              return deviceService.saveDevice(device, devicesGroup.id.id).pipe(\n                rxjs.switchMap(function(savedDevice) {\n                  return entityGroupService.addEntityToEntityGroup(unassignedGroup.id.id, savedDevice.id.id).pipe(\n                    rxjs.switchMap(function() {\n                      if (deviceInfo.type === 'Room Sensor CO2') {\n                        const attributes = [\n                          { key: 'devEui', value: deviceInfo.devEUI },\n                          { key: 'appKey', value: deviceInfo.appKey }\n                        ];\n                        return attributeService.saveEntityAttributes(savedDevice.id, 'SERVER_SCOPE', attributes).pipe(\n                          rxjs.switchMap(function() {\n                            return saveRelation(customerId, savedDevice.id, 'Owns').pipe(\n                              rxjs.map(function() { return savedDevice; })\n                            );\n                          })\n                        );\n                      }\n                      return saveRelation(customerId, savedDevice.id, 'Owns').pipe(\n                        rxjs.map(function() { return savedDevice; })\n                      );\n                    })\n                  );\n                })\n              );\n            });\n\n            return rxjs.forkJoin(observables);\n          })\n        );\n      })\n    );\n  }\n\n  function getOrCreateEntityGroup(ownerId, entityType, groupName) {\n    return entityGroupService.getEntityGroupsByOwnerId(ownerId.entityType, ownerId.id, entityType).pipe(\n      rxjs.switchMap(function(groups) {\n        const existingGroup = groups.find(function(g) { return g.name === groupName; });\n        if (existingGroup) {\n          return rxjs.of(existingGroup);\n        }\n        const newGroup = {\n          type: entityType,\n          name: groupName,\n          ownerId: ownerId\n        };\n        return entityGroupService.saveEntityGroup(newGroup);\n      })\n    );\n  }\n\n  function saveRelation(fromId, toId, relationType) {\n    const relation = {\n      from: fromId,\n      to: toId,\n      typeGroup: 'COMMON',\n      type: relationType\n    };\n    return entityRelationService.saveRelation(relation);\n  }\n\n  function saveDeviceToKitRelation(kitId, deviceId) {\n    const relation = {\n      from: kitId,\n      to: deviceId,\n      typeGroup: 'COMMON',\n      type: 'Contains'\n    };\n    return entityRelationService.saveRelation(relation);\n  }\n}\n",
                "customResources": [],
                "id": "act-add-kit"
              },
              {
                "name": "btn-transfer-kit",
                "buttonType": "icon",
                "icon": "mdi:swap-horizontal",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\nreturn userRole === 'ECO Administrator';",
                "type": "customPretty",
                "customHtml": "<form #transferKitForm=\"ngForm\" [formGroup]=\"transferKitFormGroup\" (ngSubmit)=\"save()\" class=\"transfer-kit-dialog\">\n  <!-- Header -->\n  <div class=\"dialog-header\">\n    <mat-icon>swap_horiz</mat-icon>\n    <h2>{{ 'custom.diagnostic-kits.transfer-kit' | translate }}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\" class=\"close-btn\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </div>\n\n  <div class=\"dialog-body\">\n    <!-- Kit Selection Card -->\n    <div class=\"section-card kit-card\">\n      <div class=\"card-header-mini\">\n        <span>{{ 'custom.diagnostic-kits.select-kit' | translate }}</span>\n      </div>\n      <div class=\"card-content\">\n        <mat-form-field appearance=\"fill\" class=\"full-width\">\n          <mat-label>Kit</mat-label>\n          <mat-select formControlName=\"kit\" required (selectionChange)=\"onKitSelected($event)\">\n            <mat-option *ngFor=\"let kit of kits\" [value]=\"kit\">\n              {{ kit.name }}\n            </mat-option>\n          </mat-select>\n          <mat-error *ngIf=\"transferKitFormGroup.get('kit')?.hasError('required')\">\n            {{ 'custom.diagnostic-kits.kit-is-required' | translate }}\n          </mat-error>\n        </mat-form-field>\n      </div>\n    </div>\n\n    <!-- Transfer Arrow -->\n    <div class=\"transfer-arrow-simple\">\n      <mat-icon>arrow_downward</mat-icon>\n    </div>\n\n    <!-- Customer Selection Card -->\n    <div class=\"section-card customer-card\">\n      <div class=\"card-header-mini\">\n        <span>{{ 'custom.diagnostic-kits.target-customer' | translate }}</span>\n      </div>\n      <div class=\"card-content\">\n        <mat-form-field appearance=\"fill\" class=\"full-width\">\n          <mat-label>{{ 'custom.diagnostic-kits.customer' | translate }}</mat-label>\n          <mat-select formControlName=\"customer\" required (selectionChange)=\"onCustomerSelected($event)\">\n            <mat-option *ngFor=\"let cust of customers\" [value]=\"cust\">\n              {{ cust.title }}\n            </mat-option>\n          </mat-select>\n          <mat-error *ngIf=\"transferKitFormGroup.get('customer')?.hasError('required')\">\n            {{ 'custom.diagnostic-kits.customer-is-required' | translate }}\n          </mat-error>\n        </mat-form-field>\n      </div>\n    </div>\n\n    <!-- Warning Banner (if kit has measurements) -->\n    <div *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" class=\"warning-banner\">\n      <mat-icon>warning</mat-icon>\n      <span>{{ 'custom.diagnostic-kits.kit-has-assigned-measurement-warning' | translate }}</span>\n    </div>\n\n    <!-- Transfer Preview (if customer selected) -->\n    <div *ngIf=\"foundProject\" class=\"section-card transfer-card\">\n      <div class=\"card-header-mini\">\n        <span>{{ 'custom.diagnostic-kits.transfer-details' | translate }}</span>\n        <span class=\"badge badge-orange\">{{ 'custom.diagnostic-kits.preview' | translate }}</span>\n      </div>\n      <div class=\"card-content\">\n        <!-- Project Transfer -->\n        <div class=\"transfer-row\">\n          <mat-form-field appearance=\"fill\" class=\"transfer-field\">\n            <mat-label>{{ 'custom.diagnostic-kits.found-project' | translate }}</mat-label>\n            <input matInput formControlName=\"foundProject\" readonly>\n          </mat-form-field>\n          <mat-icon class=\"arrow-icon\">arrow_forward</mat-icon>\n          <mat-form-field appearance=\"fill\" class=\"transfer-field\">\n            <mat-label>{{ 'custom.diagnostic-kits.transferred-project' | translate }}</mat-label>\n            <input matInput formControlName=\"transferredProject\" readonly>\n          </mat-form-field>\n        </div>\n\n        <!-- Measurements Transfer -->\n        <div *ngFor=\"let measurement of projectMeasurements; let i = index\" class=\"transfer-row\">\n          <mat-form-field appearance=\"fill\" class=\"transfer-field\">\n            <mat-label>{{ 'custom.diagnostic-kits.found-measurement' | translate }}</mat-label>\n            <input matInput [formControlName]=\"'measurement' + i\" readonly>\n          </mat-form-field>\n          <mat-icon class=\"arrow-icon\">arrow_forward</mat-icon>\n          <mat-form-field appearance=\"fill\" class=\"transfer-field\">\n            <mat-label>{{ 'custom.diagnostic-kits.transferred-measurement' | translate }}</mat-label>\n            <input matInput [formControlName]=\"'transferredMeasurement' + i\" readonly>\n          </mat-form-field>\n        </div>\n\n        <!-- Devices Transfer -->\n        <div *ngFor=\"let device of allDevices; let i = index\" class=\"transfer-row\">\n          <mat-form-field appearance=\"fill\" class=\"transfer-field\">\n            <mat-label>{{ 'custom.diagnostic-kits.found-device' | translate }}</mat-label>\n            <input matInput [formControlName]=\"'device' + i\" readonly>\n          </mat-form-field>\n          <mat-icon class=\"arrow-icon\">arrow_forward</mat-icon>\n          <mat-form-field appearance=\"fill\" class=\"transfer-field\">\n            <mat-label>{{ 'custom.diagnostic-kits.transferred-device' | translate }}</mat-label>\n            <input matInput [formControlName]=\"'transferredDevice' + i\" readonly>\n          </mat-form-field>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <!-- Footer -->\n  <div class=\"dialog-footer\">\n    <button mat-button type=\"button\" (click)=\"cancel()\" class=\"cancel-btn\">\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"transferKitFormGroup.invalid\" class=\"submit-btn\">\n      <mat-icon>swap_horiz</mat-icon>\n      {{ 'custom.diagnostic-kits.transfer' | translate }}\n    </button>\n  </div>\n</form>",
                "customCss": "/* Transfer Kit Dialog */\n.transfer-kit-dialog {\n  width: 700px;\n  max-height: 85vh;\n  display: flex;\n  flex-direction: column;\n  background: #f8fafc;\n}\n\n/* Header */\n.dialog-header {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  padding: 14px 20px;\n  background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);\n  color: white;\n}\n.dialog-header mat-icon {\n  font-size: 24px;\n  width: 24px;\n  height: 24px;\n}\n.dialog-header h2 {\n  margin: 0;\n  font-size: 18px;\n  font-weight: 600;\n}\n.close-btn {\n  color: rgba(255,255,255,0.8) !important;\n}\n.close-btn:hover {\n  color: white !important;\n  background: rgba(255,255,255,0.1) !important;\n}\n\n/* Body */\n.dialog-body {\n  flex: 1;\n  overflow-y: auto;\n  padding: 16px;\n}\n\n/* Section Cards */\n.section-card {\n  background: white;\n  border-radius: 8px;\n  border: 1px solid #e2e8f0;\n  margin-bottom: 12px;\n  overflow: hidden;\n}\n\n.card-header-mini {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  padding: 10px 14px;\n  background: #f8fafc;\n  border-bottom: 1px solid #e2e8f0;\n  font-weight: 600;\n  font-size: 14px;\n  color: #334155;\n}\n\n.card-content {\n  padding: 14px;\n}\n\n/* Card border colors */\n.kit-card {\n  border-left: 3px solid #8b5cf6;\n}\n.customer-card {\n  border-left: 3px solid #3b82f6;\n}\n.transfer-card {\n  border-left: 3px solid #f59e0b;\n}\n\n/* Form Fields */\n.full-width {\n  width: 100%;\n}\n\n.transfer-kit-dialog .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n.transfer-kit-dialog .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n/* Simple Arrow */\n.transfer-arrow-simple {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 8px 0;\n}\n.transfer-arrow-simple mat-icon {\n  color: #f59e0b;\n  font-size: 28px;\n  width: 28px;\n  height: 28px;\n}\n\n/* Warning Banner */\n.warning-banner {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  padding: 12px 16px;\n  background: #fef3c7;\n  border: 1px solid #fcd34d;\n  border-radius: 8px;\n  margin-bottom: 12px;\n  color: #92400e;\n  font-size: 14px;\n}\n.warning-banner mat-icon {\n  color: #d97706;\n  font-size: 22px;\n  width: 22px;\n  height: 22px;\n}\n\n/* Badge */\n.badge {\n  font-size: 11px;\n  font-weight: 600;\n  padding: 3px 8px;\n  border-radius: 12px;\n  text-transform: uppercase;\n  margin-left: auto;\n}\n.badge-orange {\n  background: #ffedd5;\n  color: #c2410c;\n}\n\n/* Transfer Rows */\n.transfer-row {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  margin-bottom: 12px;\n}\n.transfer-row:last-child {\n  margin-bottom: 0;\n}\n.transfer-field {\n  flex: 1;\n}\n.arrow-icon {\n  color: #f59e0b !important;\n  flex-shrink: 0;\n}\n\n/* Footer */\n.dialog-footer {\n  display: flex;\n  justify-content: flex-end;\n  align-items: center;\n  gap: 12px;\n  padding: 12px 20px;\n  background: white;\n  border-top: 1px solid #e2e8f0;\n}\n\n.cancel-btn {\n  color: #64748b !important;\n}\n\n.submit-btn {\n  font-weight: 600 !important;\n  padding: 0 20px !important;\n  height: 42px !important;\n  border-radius: 8px !important;\n  background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%) !important;\n}\n.submit-btn mat-icon {\n  margin-right: 6px;\n}\n.submit-btn:hover:not([disabled]) {\n  background: linear-gradient(135deg, #b45309 0%, #d97706 100%) !important;\n}\n.submit-btn[disabled] {\n  background: #e2e8f0 !important;\n  color: #94a3b8 !important;\n}",
                "customFunction": "let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet dialogs = injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\nlet customerId, customer;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet pageLink = {\r\n  pageSize: 100, page: 0, textSearch: '', sortOrder: 'ASC', sortProperty: 'title',\r\n  toQuery: function () {\r\n    let q = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) q += '&textSearch=' + encodeURIComponent(this.textSearch);\r\n    if (this.sortProperty) q += '&sortProperty=' + encodeURIComponent(this.sortProperty);\r\n    if (this.sortOrder) q += '&sortOrder=' + encodeURIComponent(this.sortOrder);\r\n    return q;\r\n  }\r\n};\r\n\r\nlet kits = [];\r\nlet customers = [];\r\nlet kitsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (kitsLoaded && customersLoaded) openTransferKitDialog(kits, customers);\r\n}\r\n\r\nlet kitSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id, rootType: 'CUSTOMER', direction: 'FROM',\r\n    relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Diagnostickit']\r\n};\r\n\r\nassetService.findByQuery(kitSearchQuery).subscribe(\r\n  result => { kits = result; kitsLoaded = true; checkAndOpenDialog(); },\r\n  () => { kits = []; kitsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\n// NOTE: credentials come from your original snippet\r\nlet bearerToken = '';\r\nfetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n  method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n  body: JSON.stringify({ \"username\": \"belimo.api@pke-iot.expert\", \"password\": \"vfx3cvr@VMJ3bxk3urg\" })\r\n})\r\n  .then(resp => resp.json())\r\n  .then(loginData => {\r\n    bearerToken = loginData.token;\r\n    return fetch('https://cloud.pke-iot.expert/api/customers?pageSize=100&page=0', {\r\n      method: 'GET',\r\n      headers: { 'accept': 'application/json', 'X-Authorization': 'Bearer ' + bearerToken }\r\n    });\r\n  })\r\n  .then(resp2 => resp2.json())\r\n  .then(customersList => {\r\n    customers = customersList.data;\r\n    if (customer) customers = customers.filter(cust => cust.title !== customer);\r\n    customersLoaded = true; checkAndOpenDialog();\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching customers:\", error);\r\n    alert('Failed to fetch customers.');\r\n  });\r\n\r\nfunction openTransferKitDialog(kits, customers) {\r\n  customDialog.customDialog(htmlTemplate, TransferKitDialogController, { kits, customers }).subscribe();\r\n}\r\n\r\nfunction TransferKitDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.kits = data.kits || [];\r\n  vm.customers = data.customers || [];\r\n\r\n  vm.transferKitFormGroup = vm.fb.group({\r\n    kit: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n  vm.transferKitFormGroup.addControl('transferredProject', vm.fb.control({ value: '', disabled: true }));\r\n\r\n  vm.allDevices = [];\r\n  vm.devicesWithMeasurements = [];\r\n  vm.foundProject = null;\r\n  vm.projectMeasurements = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n     vm.measurementRenameMap = new Map();\r\n\r\n\r\n  const groupCache = new Map(); // key: ownerId|scope|name -> Observable(group)\r\n  function ensureGroup(ownerIdObj, scopeType, name) {\r\n    const key = ownerIdObj.id + '|' + scopeType + '|' + name;\r\n    if (groupCache.has(key)) return groupCache.get(key);\r\n\r\n    const obs = entityGroupService.getEntityGroupsByOwnerId(ownerIdObj.entityType, ownerIdObj.id, scopeType).pipe(\r\n      widgetContext.rxjs.switchMap(groups => {\r\n        let g = (groups || []).find(x => x.name === name);\r\n        if (g) return widgetContext.rxjs.of(g);\r\n        const payload = { type: scopeType, name, ownerId: ownerIdObj };\r\n        return entityGroupService.saveEntityGroup(payload).pipe(\r\n          // If backend races and says \"already exists\", re-fetch once\r\n          widgetContext.rxjs.catchError(err => {\r\n            if (err && err.status === 400) {\r\n              return entityGroupService.getEntityGroupsByOwnerId(ownerIdObj.entityType, ownerIdObj.id, scopeType).pipe(\r\n                widgetContext.rxjs.map(gs => (gs || []).find(x => x.name === name))\r\n              );\r\n            }\r\n            return widgetContext.rxjs.throwError(err);\r\n          })\r\n        );\r\n      }),\r\n      widgetContext.rxjs.shareReplay(1)\r\n    );\r\n    groupCache.set(key, obs);\r\n    return obs;\r\n  }\r\n\r\n  function addToGroupSafe(groupId, entityId) {\r\n    return entityGroupService.addEntitiesToEntityGroup(groupId, [entityId]).pipe(\r\n      widgetContext.rxjs.catchError(err => {\r\n        // tolerate duplicate-membership/409/400 responses\r\n        return widgetContext.rxjs.of(null);\r\n      })\r\n    );\r\n  }\r\n\r\n  function getProjectsGroup(owner)                { return ensureGroup(owner, 'ASSET',  'Projects'); }\r\n  function getMeasurementsGroup(owner)            { return ensureGroup(owner, 'ASSET',  'Measurements'); }\r\n  function getDiagnostickitsGroup(owner)          { return ensureGroup(owner, 'ASSET',  'Diagnostickits'); }\r\n  function getGatewaysGroup(owner)                { return ensureGroup(owner, 'DEVICE', 'Gateways'); }\r\n  function getDiagnostickitDevicesGroup(owner)    { return ensureGroup(owner, 'DEVICE', 'Diagnostickit Devices'); }\r\n  function getUnassignedMeasurementDevicesGroup(owner) { return ensureGroup(owner, 'DEVICE', 'Unassigned Measurement Devices'); }\r\n\r\n  vm.transferKitFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId, rootType: 'CUSTOMER', direction: 'FROM',\r\n          relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { vm.transferredProject = null; vm.customerShortName = null; }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null; vm.customerShortName = null;\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        if (vm.transferKitFormGroup.get('transferredMeasurement' + index)) {\r\n          vm.transferKitFormGroup.get('transferredMeasurement' + index).setValue('');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  vm.onKitSelected = function (event) {\r\n    let selectedKit = event.value;\r\n    vm.allDevices = [];\r\n    vm.devicesWithMeasurements = [];\r\n    vm.foundProject = null;\r\n    vm.projectMeasurements = [];\r\n\r\n    Object.keys(vm.transferKitFormGroup.controls)\r\n      .filter(n => n.startsWith('measurement') || n.startsWith('transferredMeasurement') || n.startsWith('device') || n.startsWith('transferredDevice'))\r\n      .forEach(n => vm.transferKitFormGroup.removeControl(n));\r\n    \r\n    let selectedCustomer = vm.transferKitFormGroup.get('customer').value;\r\n    if (!selectedKit || !selectedCustomer) {\r\n      console.warn(\"Kit or customer not selected yet.\");\r\n      return;\r\n    }\r\n    \r\n    let selectedKitId = selectedKit.id.id ? selectedKit.id.id : selectedKit.id;\r\n\r\n    let deviceSearchQuery = {\r\n      parameters: {\r\n        rootId: selectedKitId, rootType: 'ASSET', direction: 'FROM',\r\n        relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: true\r\n      },\r\n      relationType: 'Contains',\r\n      deviceTypes: ['P-Flow D116','Room Sensor CO2','Temperature Sensor','RESI','Gateway','LTE Status']\r\n    };\r\n    \r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n      devices => {\r\n        vm.allDevices = devices || [];\r\n        if (vm.allDevices.length === 0) return;\r\n\r\n        vm.allDevices.forEach((device, index) => {\r\n          vm.transferKitFormGroup.addControl('device' + index, vm.fb.control({ value: device.name, disabled: true }));\r\n          vm.transferKitFormGroup.addControl('transferredDevice' + index, vm.fb.control({ value: device.name, disabled: true }));\r\n        });\r\n\r\n        let measurementChecks = vm.allDevices.map(device => {\r\n          let measurementQuery = {\r\n            parameters: {\r\n              rootId: (device.id.id ? device.id.id : device.id), rootType: 'DEVICE', direction: 'TO',\r\n              relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: false\r\n            },\r\n            relationType: 'Measurement',\r\n            assetTypes: ['Measurement']\r\n          };\r\n          return assetService.findByQuery(measurementQuery).pipe(\r\n            widgetContext.rxjs.map(measurements => ({ device, measurements: measurements || [] }))\r\n          );\r\n        });\r\n\r\n        widgetContext.rxjs.forkJoin(measurementChecks).subscribe(\r\n          measurementResults => {\r\n            vm.devicesWithMeasurements = measurementResults.filter(r => r.measurements.length > 0);\r\n            let projectChecks = [];\r\n            vm.devicesWithMeasurements.forEach(item => {\r\n              item.measurements.forEach(meas => {\r\n                let projectQuery = {\r\n                  parameters: {\r\n                    rootId: (meas.id.id ? meas.id.id : meas.id), rootType: 'ASSET', direction: 'TO',\r\n                    relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: 'Owns',\r\n                  assetTypes: ['Project']\r\n                };\r\n                projectChecks.push(assetService.findByQuery(projectQuery).pipe(\r\n                  widgetContext.rxjs.map(projects => ({ measurement: meas, projects: projects || [] }))\r\n                ));\r\n              });\r\n            });\r\n            if (projectChecks.length === 0) return;\r\n\r\n            widgetContext.rxjs.forkJoin(projectChecks).subscribe(\r\n              projectResults => {\r\n                let found = projectResults.find(r => r.projects.length > 0);\r\n                if (found) {\r\n                  vm.foundProject = found.projects[0];\r\n                  if (!vm.transferKitFormGroup.get('foundProject')) {\r\n                    vm.transferKitFormGroup.addControl('foundProject', vm.fb.control({ value: vm.foundProject.name, disabled: true }));\r\n                  } else {\r\n                    vm.transferKitFormGroup.get('foundProject').setValue(vm.foundProject.name);\r\n                  }\r\n                  searchMeasurementsForProject(vm.foundProject);\r\n                }\r\n              },\r\n              err => console.error(\"Error during project queries:\", err)\r\n            );\r\n          },\r\n          err => console.error(\"Error in measurement checks:\", err)\r\n        );\r\n      },\r\n      err => console.error(\"Error finding devices for kit:\", err)\r\n    );\r\n  };\r\n\r\n  vm.onCustomerSelected = function () {\r\n    let kit = vm.transferKitFormGroup.get('kit').value;\r\n    if (kit) vm.onKitSelected({ value: kit });\r\n  };\r\n\r\n  function updateFoundProjectName(customerShortName, existingProjects) {\r\n    if (!customerShortName) return;\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) { maxNumericSuffix = parsedNum; }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    vm.transferredProject = candidate;\r\n    vm.transferKitFormGroup.get('transferredProject').setValue(candidate);\r\n  }\r\n\r\n  function renameProjectMeasurements() {\r\n    if (!vm.customerShortName) return;\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n      let newProjectNameCtrl = vm.transferKitFormGroup.get('transferredProject');\r\n      let oldName = measurement.name;\r\n      let parts = oldName.split('_');\r\n      let newName = newProjectNameCtrl.value + '_' + parts[2];\r\n      let control = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n      if (control) control.setValue(newName);\r\n    });\r\n  }\r\n\r\n  function searchMeasurementsForProject(project) {\r\n    let projectId = project.id.id ? project.id.id : project.id;\r\n    let projectMeasurementQuery = {\r\n      parameters: {\r\n        rootId: projectId, rootType: 'ASSET', direction: 'FROM',\r\n        relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Measurement']\r\n    };\r\n    assetService.findByQuery(projectMeasurementQuery).subscribe(\r\n      measurements => {\r\n        vm.projectMeasurements = measurements || [];\r\n        Object.keys(vm.transferKitFormGroup.controls)\r\n          .filter(n => n.startsWith('measurement') || n.startsWith('transferredMeasurement'))\r\n          .forEach(n => vm.transferKitFormGroup.removeControl(n));\r\n        (measurements || []).forEach((measurement, index) => {\r\n          vm.transferKitFormGroup.addControl('measurement' + index, vm.fb.control({ value: measurement.name, disabled: true }));\r\n          vm.transferKitFormGroup.addControl('transferredMeasurement' + index, vm.fb.control({ value: '', disabled: true }));\r\n        });\r\n        renameProjectMeasurements();\r\n      },\r\n      err => console.error(\"Error finding measurements for project:\", err)\r\n    );\r\n  }\r\n\r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      }),\r\n      widgetContext.rxjs.catchError(() => widgetContext.rxjs.of(null)) // tolerate if old relation missing\r\n    );\r\n  }\r\n\r\n  function getVrDevicesForDevice(deviceId) {\r\n    return entityRelationService.findByTo({ id: deviceId, entityType: 'DEVICE' }).pipe(\r\n      widgetContext.rxjs.map(rels =>\r\n        (rels || [])\r\n          .filter(r => r.typeGroup === 'COMMON' && r.type === 'VR' && r.from?.entityType === 'DEVICE')\r\n          .map(r => (r.from.id.id ? r.from.id.id : r.from.id)) // return VR device UUIDs\r\n      )\r\n    );\r\n  }\r\n\r\n  function computeNewVrName(oldVrName) {\r\n      const original = (oldVrName || '').trim();\r\n      if (!original) { \r\n        console.debug('[VR Rename] Empty VR name; skip');\r\n        return null;\r\n      }\r\n    \r\n      // 1) Primary: precise map-based rename (oldMeasName or oldMeasName_)\r\n      if (vm.measurementRenameMap && vm.measurementRenameMap.size > 0) {\r\n        const entries = Array.from(vm.measurementRenameMap.entries())\r\n          .sort((a, b) => b[0].length - a[0].length); // longest first\r\n    \r\n        for (const [oldMeasNameRaw, newMeasNameRaw] of entries) {\r\n          const oldMeas = String(oldMeasNameRaw || '').trim();\r\n          const newMeas = String(newMeasNameRaw || '').trim();\r\n          if (!oldMeas || !newMeas) continue;\r\n    \r\n          // exact match\r\n          if (original === oldMeas) {\r\n            const renamed = newMeas;\r\n            console.debug('[VR Rename] Exact match:', { original, oldMeas, newMeas, renamed });\r\n            return renamed;\r\n          }\r\n          // prefix match \"<oldMeas>_<suffix>\"\r\n          const prefix = oldMeas + '_';\r\n          if (original.startsWith(prefix)) {\r\n            const suffix = original.substring(prefix.length);\r\n            const renamed = newMeas + '_' + suffix;\r\n            console.debug('[VR Rename] Prefix match:', { original, oldMeas, newMeas, suffix, renamed });\r\n            return renamed;\r\n          }\r\n        }\r\n      } else {\r\n        console.debug('[VR Rename] Empty measurementRenameMap; will try ECO fallback for', original);\r\n      }\r\n    \r\n      // 2) Fallback: if we can’t match the old measurement name, but there is exactly ONE new measurement name,\r\n      //    replace everything BEFORE \"_ECO_\" with that name.\r\n      //    This gives:  \"<anything>_ECO_...\" -> \"<singleNewMeas>_ECO_...\"\r\n      const newNames = vm.measurementRenameMap ? Array.from(vm.measurementRenameMap.values()).map(v => String(v || '').trim()).filter(Boolean) : [];\r\n      if (newNames.length === 1) {\r\n        const soleNew = newNames[0];\r\n        // Typical delimiter in your VR naming: \"_ECO_\"\r\n        const ecoIdx = original.indexOf('_ECO_');\r\n        if (ecoIdx > 0) {\r\n          const suffixFromEco = original.substring(ecoIdx + 1); // keep \"ECO_...\"\r\n          const renamed = soleNew + '_' + suffixFromEco;\r\n          console.debug('[VR Rename] Fallback via _ECO_:',\r\n            { original, soleNew, suffixFromEco, renamed });\r\n          return renamed;\r\n        }\r\n        // If \"_ECO_\" is not present, as a safer generic fallback: replace up to the 3rd underscore (common in \"X_Y_Z_...\")\r\n        const parts = original.split('_');\r\n        if (parts.length >= 3) {\r\n          const suffix = parts.slice(3).join('_'); // keep everything after first 3 segments\r\n          const renamed = suffix ? (soleNew + '_' + suffix) : soleNew;\r\n          console.debug('[VR Rename] Fallback via 3-seg prefix:',\r\n            { original, soleNew, suffix, renamed });\r\n          return renamed;\r\n        }\r\n      }\r\n    \r\n      console.debug('[VR Rename] No matching rule for', original);\r\n      return null; // no rename\r\n    }\r\n\r\n\r\n\r\n\r\n  function transferVrDevice(vrDeviceId, newOwner, hasProjectMeasurements) {\r\n    return deviceService.getDevice(vrDeviceId).pipe(\r\n      widgetContext.rxjs.switchMap(vr => {\r\n        const maybeNewName = computeNewVrName(vr.name);\r\n        if (maybeNewName && maybeNewName !== vr.name) vr.name = maybeNewName;\r\n        return deviceService.saveDevice(vr).pipe(\r\n          widgetContext.rxjs.switchMap(updatedVr => {\r\n            const vrEntity = updatedVr.id && updatedVr.id.entityType\r\n              ? updatedVr.id\r\n              : { id: updatedVr.id, entityType: 'DEVICE' };\r\n\r\n            return entityGroupService.changeEntityOwner(newOwner, vrEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() =>\r\n                (updatedVr.type === 'Gateway VR')\r\n                  ? getGatewaysGroup(newOwner).pipe(\r\n                      widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, vrEntity.id))\r\n                    )\r\n                  : widgetContext.rxjs.of(null)\r\n              ),\r\n              widgetContext.rxjs.switchMap(() =>\r\n                (!hasProjectMeasurements)\r\n                  ? getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                      widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, vrEntity.id))\r\n                    )\r\n                  : widgetContext.rxjs.of(null)\r\n              )\r\n            );\r\n\r\n          })\r\n        );\r\n      })\r\n    );\r\n  }\r\n\r\n  function transferVrsForPhysicalDevice(physicalDeviceId, newOwner, hasProjectMeasurements) {\r\n    return getVrDevicesForDevice(physicalDeviceId).pipe(\r\n      widgetContext.rxjs.switchMap(vrIds => {\r\n        if (!vrIds || vrIds.length === 0) return widgetContext.rxjs.of(null);\r\n        const ops = vrIds.map(vrId => transferVrDevice(vrId, newOwner, hasProjectMeasurements));\r\n        return widgetContext.rxjs.forkJoin(ops);\r\n      })\r\n    );\r\n  }\r\n\r\n  vm.save = function () {\r\n    const formValue = vm.transferKitFormGroup.value;\r\n    const selectedCustomer = formValue.customer;\r\n    if (!selectedCustomer || !selectedCustomer.id) { console.warn('No customer selected.'); return; }\r\n\r\n    if (!vm.customerShortName) vm.customerShortName = selectedCustomer.title;\r\n    const selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n    const newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n\r\n    const saveObservables = [];\r\n    const hasProjectMeasurements = vm.foundProject || (vm.projectMeasurements && vm.projectMeasurements.length > 0);\r\n    const selectedKit = formValue.kit;\r\n    if (!selectedKit.name) { console.warn(\"Selected kit has no name. Aborting save.\"); return; }\r\n    \r\n      vm.measurementRenameMap = new Map();\r\n      if (Array.isArray(vm.projectMeasurements) && vm.projectMeasurements.length > 0) {\r\n        vm.projectMeasurements.forEach((measurement, index) => {\r\n          const ctrl = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n          const newName = ctrl ? String(ctrl.value || '').trim() : '';\r\n          const oldName = String(measurement.name || '').trim();\r\n          if (oldName && newName) {\r\n            vm.measurementRenameMap.set(oldName, newName);\r\n            console.debug('[VR Rename] map:', oldName, '→', newName);\r\n          }\r\n        });\r\n      } else {\r\n        console.debug('[VR Rename] No project measurements; VR renames may be skipped.');\r\n      }\r\n\r\n\r\n    const preEnsure$ = widgetContext.rxjs.forkJoin([\r\n      getDiagnostickitsGroup(newOwner),\r\n      getDiagnostickitDevicesGroup(newOwner),\r\n      getGatewaysGroup(newOwner),\r\n      getUnassignedMeasurementDevicesGroup(newOwner),\r\n      getProjectsGroup(newOwner),\r\n      getMeasurementsGroup(newOwner)\r\n    ]).pipe(widgetContext.rxjs.catchError(() => widgetContext.rxjs.of(null)));\r\n\r\n\r\n    preEnsure$.subscribe(() => {\r\n      // KIT\r\n      let kitSave$ = assetService.saveAsset(selectedKit).pipe(\r\n        widgetContext.rxjs.switchMap(updatedKit => {\r\n          let kitEntity = updatedKit.id && updatedKit.id.entityType ? updatedKit.id : { id: updatedKit.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n            widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, kitEntity)),\r\n            widgetContext.rxjs.switchMap(() =>\r\n              getDiagnostickitsGroup(newOwner).pipe(\r\n                widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, kitEntity.id))\r\n              )\r\n            )\r\n          );\r\n        })\r\n      );\r\n      saveObservables.push(kitSave$);\r\n\r\n\r\n      if (vm.foundProject) {\r\n        let project = vm.foundProject;\r\n        let candidate = (vm.transferredProject && vm.transferredProject.trim()) || ((vm.customerShortName || selectedCustomer.title) + '_Project_1');\r\n        vm.transferredProject = candidate;\r\n        project.name = candidate;\r\n        if (!project.type || !project.type.trim()) project.type = \"Project\";\r\n\r\n        let projectSave$ = assetService.saveAsset(project).pipe(\r\n          widgetContext.rxjs.switchMap(updatedProject => {\r\n            let projectEntity = updatedProject.id && updatedProject.id.entityType ? updatedProject.id : { id: updatedProject.id, entityType: 'ASSET' };\r\n            return entityGroupService.changeEntityOwner(newOwner, projectEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, projectEntity)),\r\n              widgetContext.rxjs.switchMap(() => getProjectsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, projectEntity.id))\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(projectSave$);\r\n      }\r\n\r\n\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        let newMeasurementName = vm.transferKitFormGroup.get('transferredMeasurement' + index).value;\r\n        if (!newMeasurementName || !newMeasurementName.trim()) return;\r\n\r\n        measurement.name = newMeasurementName.trim();\r\n        let measurementSave$ = assetService.saveAsset(measurement).pipe(\r\n          widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n            let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType ? updatedMeasurement.id : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n            return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, measurementEntity)),\r\n              widgetContext.rxjs.switchMap(() => getMeasurementsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, measurementEntity.id))\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(measurementSave$);\r\n      });\r\n\r\n\r\n      vm.allDevices.forEach((device, index) => {\r\n        let newDeviceName = vm.transferKitFormGroup.get('transferredDevice' + index).value;\r\n        if (!newDeviceName || !newDeviceName.trim()) return;\r\n        device.name = newDeviceName.trim();\r\n\r\n        let deviceSave$ = deviceService.saveDevice(device).pipe(\r\n          widgetContext.rxjs.switchMap(updatedDevice => {\r\n            const deviceEntity = updatedDevice.id && updatedDevice.id.entityType ? updatedDevice.id : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n            return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() =>\r\n                getDiagnostickitDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                )\r\n              ),\r\n              widgetContext.rxjs.switchMap(() => {\r\n                if (updatedDevice.type === 'RESI' || updatedDevice.type === 'Gateway') {\r\n                  return getGatewaysGroup(newOwner).pipe(\r\n                    widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                  );\r\n                }\r\n                return widgetContext.rxjs.of(null);\r\n              }),\r\n              widgetContext.rxjs.switchMap(() => {\r\n                if (!hasProjectMeasurements) {\r\n                  return getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                    widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                  );\r\n                }\r\n                return widgetContext.rxjs.of(null);\r\n              }),\r\n\r\n              widgetContext.rxjs.switchMap(() =>\r\n                transferVrsForPhysicalDevice(deviceEntity.id, newOwner, hasProjectMeasurements)\r\n              )\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(deviceSave$);\r\n      });\r\n\r\n      widgetContext.rxjs.forkJoin(saveObservables).subscribe(\r\n        () => { widgetContext.updateAliases(); vm.dialogRef.close(formValue); },\r\n        err => { console.error('Error updating assets:', err); }\r\n      );\r\n    });\r\n  };\r\n\r\n  vm.cancel = function () { vm.dialogRef.close(null); };\r\n}\r\n\r\n\r\n\r\n/*let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet dialogs = injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\nlet customerId, customer;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet pageLink = {\r\n  pageSize: 100,\r\n  page: 0,\r\n  textSearch: '',\r\n  sortOrder: 'ASC',\r\n  sortProperty: 'title',\r\n  toQuery: function () {\r\n    let query = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) { query += '&textSearch=' + encodeURIComponent(this.textSearch); }\r\n    if (this.sortProperty) { query += '&sortProperty=' + encodeURIComponent(this.sortProperty); }\r\n    if (this.sortOrder) { query += '&sortOrder=' + encodeURIComponent(this.sortOrder); }\r\n    return query;\r\n  }\r\n};\r\n\r\nlet kits = [];\r\nlet customers = [];\r\nlet kitsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (kitsLoaded && customersLoaded) {\r\n    openTransferKitDialog(kits, customers);\r\n  }\r\n}\r\n\r\nlet kitSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id,\r\n    rootType: 'CUSTOMER',\r\n    direction: 'FROM',\r\n    relationTypeGroup: 'COMMON',\r\n    maxLevel: 10,\r\n    fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Diagnostickit']\r\n};\r\n\r\nassetService.findByQuery(kitSearchQuery).subscribe(\r\n  result => { kits = result; kitsLoaded = true; checkAndOpenDialog(); },\r\n  () => { kits = []; kitsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\nlet bearerToken = '';\r\nfetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n  method: 'POST',\r\n  headers: {\r\n    'Content-Type': 'application/json'\r\n  },\r\n  body: JSON.stringify({\r\n    \"username\": \"belimo.api@pke-iot.expert\",\r\n    \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n  })\r\n})\r\n  .then(resp => resp.json())\r\n  .then(loginData => {\r\n    bearerToken = loginData.token;\r\n    return fetch('https://cloud.pke-iot.expert/api/customers?pageSize=100&page=0', {\r\n      method: 'GET',\r\n      headers: {\r\n        'accept': 'application/json',\r\n        'X-Authorization': 'Bearer ' + bearerToken\r\n      }\r\n    });\r\n  })\r\n  .then(resp2 => resp2.json())\r\n  .then(customersList => {\r\n    // Process the customers data here.\r\n    customers = customersList.data;\r\n    if (customer) { customers = customers.filter(cust => cust.title !== customer); }\r\n    customersLoaded = true;\r\n    checkAndOpenDialog();\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching customers:\", error);\r\n    alert('Failed to fetch customers.');\r\n  });\r\n\r\n\r\nfunction openTransferKitDialog(kits, customers) {\r\n  customDialog.customDialog(htmlTemplate, TransferKitDialogController, {\r\n    kits: kits,\r\n    customers: customers\r\n  }).subscribe();\r\n}\r\n\r\nfunction TransferKitDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.kits = data.kits || [];\r\n  vm.customers = data.customers || [];\r\n\r\n  vm.transferKitFormGroup = vm.fb.group({\r\n    kit: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n  vm.transferKitFormGroup.addControl('transferredProject', vm.fb.control({ value: '', disabled: true }));\r\n\r\n  vm.allDevices = [];\r\n  vm.devicesWithMeasurements = [];\r\n  vm.foundProject = null;\r\n  vm.projectMeasurements = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n\r\n  vm.transferKitFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId,\r\n          rootType: 'CUSTOMER',\r\n          direction: 'FROM',\r\n          relationTypeGroup: 'COMMON',\r\n          maxLevel: 10,\r\n          fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { \r\n          vm.transferredProject = null; \r\n          vm.customerShortName = null; \r\n        }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null;\r\n      vm.customerShortName = null;\r\n      // Clear out the transferred measurements when no customer is selected.\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        if (vm.transferKitFormGroup.get('transferredMeasurement' + index)) {\r\n          vm.transferKitFormGroup.get('transferredMeasurement' + index).setValue('');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  vm.onKitSelected = function (event) {\r\n    let selectedKit = event.value;\r\n    vm.allDevices = [];\r\n    vm.devicesWithMeasurements = [];\r\n    vm.foundProject = null;\r\n    vm.projectMeasurements = [];\r\n\r\n    // Remove previous measurement and device controls.\r\n    Object.keys(vm.transferKitFormGroup.controls)\r\n      .filter(controlName => controlName.startsWith('measurement') ||\r\n                             controlName.startsWith('transferredMeasurement') ||\r\n                             controlName.startsWith('device') ||\r\n                             controlName.startsWith('transferredDevice'))\r\n      .forEach(controlName => {\r\n        vm.transferKitFormGroup.removeControl(controlName);\r\n      });\r\n    \r\n    let selectedCustomer = vm.transferKitFormGroup.get('customer').value;\r\n    if (!selectedKit || !selectedCustomer) {\r\n      console.warn(\"Kit or customer not selected yet.\");\r\n      return;\r\n    }\r\n    \r\n    let selectedKitId = selectedKit.id.id ? selectedKit.id.id : selectedKit.id;\r\n\r\n    let deviceSearchQuery = {\r\n      parameters: {\r\n        rootId: selectedKitId,\r\n        rootType: 'ASSET',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: true\r\n      },\r\n      relationType: 'Contains',\r\n      deviceTypes: [\r\n          'P-Flow D116',\r\n          'Room Sensor CO2',\r\n          'Temperature Sensor',\r\n          'RESI',\r\n          'Gateway',\r\n          'LTE Status'\r\n      ]\r\n    };\r\n    \r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n      devices => {\r\n        vm.allDevices = devices || [];\r\n        \r\n        if (vm.allDevices.length === 0) {\r\n          console.warn(\"No devices found in selected kit.\");\r\n          return;\r\n        }\r\n        // For each device, add two controls: one showing the original device name, and one for transferred device,\r\n        // which is automatically set to the same name as the found device.\r\n        vm.allDevices.forEach((device, index) => {\r\n          vm.transferKitFormGroup.addControl(\r\n            'device' + index,\r\n            vm.fb.control({ value: device.name, disabled: true })\r\n          );\r\n          vm.transferKitFormGroup.addControl(\r\n            'transferredDevice' + index,\r\n            vm.fb.control({ value: device.name, disabled: true })\r\n          );\r\n        });\r\n\r\n        let measurementChecks = vm.allDevices.map(device => {\r\n          let measurementQuery = {\r\n            parameters: {\r\n              rootId: (device.id.id ? device.id.id : device.id),\r\n              rootType: 'DEVICE',\r\n              direction: 'TO',\r\n              relationTypeGroup: 'COMMON',\r\n              maxLevel: 1073741824,\r\n              fetchLastLevelOnly: false\r\n            },\r\n            relationType: 'Measurement',\r\n            assetTypes: ['Measurement']\r\n          };\r\n          return assetService.findByQuery(measurementQuery).pipe(\r\n            widgetContext.rxjs.map(measurements => {\r\n              return { device: device, measurements: measurements || [] };\r\n            })\r\n          );\r\n        });\r\n        widgetContext.rxjs.forkJoin(measurementChecks).subscribe(\r\n          measurementResults => {\r\n            vm.devicesWithMeasurements = measurementResults.filter(r => r.measurements.length > 0);\r\n            let projectChecks = [];\r\n            vm.devicesWithMeasurements.forEach(item => {\r\n              item.measurements.forEach(meas => {\r\n                let projectQuery = {\r\n                  parameters: {\r\n                    rootId: (meas.id.id ? meas.id.id : meas.id),\r\n                    rootType: 'ASSET',\r\n                    direction: 'TO',\r\n                    relationTypeGroup: 'COMMON',\r\n                    maxLevel: 10,\r\n                    fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: 'Owns',\r\n                  assetTypes: ['Project']\r\n                };\r\n                projectChecks.push(\r\n                  assetService.findByQuery(projectQuery).pipe(\r\n                    widgetContext.rxjs.map(projects => {\r\n                      return { measurement: meas, projects: projects || [] };\r\n                    })\r\n                  )\r\n                );\r\n              });\r\n            });\r\n            if (projectChecks.length === 0) {\r\n              return;\r\n            }\r\n            widgetContext.rxjs.forkJoin(projectChecks).subscribe(\r\n              projectResults => {\r\n                let found = projectResults.find(r => r.projects.length > 0);\r\n                if (found) {\r\n                  vm.foundProject = found.projects[0];\r\n                  if (!vm.transferKitFormGroup.get('foundProject')) {\r\n                    vm.transferKitFormGroup.addControl(\r\n                      'foundProject',\r\n                      vm.fb.control({ value: vm.foundProject.name, disabled: true })\r\n                    );\r\n                  } else {\r\n                    vm.transferKitFormGroup.get('foundProject').setValue(vm.foundProject.name);\r\n                  }\r\n                  searchMeasurementsForProject(vm.foundProject);\r\n                }\r\n              },\r\n              err => {\r\n                console.error(\"Error during project queries:\", err);\r\n              }\r\n            );\r\n          },\r\n          err => {\r\n            console.error(\"Error in measurement checks:\", err);\r\n          }\r\n        );\r\n      },\r\n      err => {\r\n        console.error(\"Error finding devices for kit:\", err);\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.onCustomerSelected = function (event) {\r\n    let kit = vm.transferKitFormGroup.get('kit').value;\r\n    if (kit) {\r\n      vm.onKitSelected({ value: kit });\r\n    }\r\n  };\r\n\r\n  function updateFoundProjectName(customerShortName, existingProjects) {\r\n    if (!customerShortName) {\r\n      console.warn(\"Customer short name is not defined.\");\r\n      return;\r\n    }\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) {\r\n          maxNumericSuffix = parsedNum;\r\n        }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    vm.transferredProject = candidate;\r\n    vm.transferKitFormGroup.get('transferredProject').setValue(candidate);\r\n    // Device names remain as set.\r\n  }\r\n\r\n  function renameProjectMeasurements() {\r\n    if (!vm.customerShortName) {\r\n      console.warn(\"Customer short name not set. Skipping measurement rename.\");\r\n      return;\r\n    }\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n    let newProjectName = vm.transferKitFormGroup.get('transferredProject');\r\n      let oldName = measurement.name;\r\n      let parts = oldName.split('_');\r\n      let newName = newProjectName.value + '_' + parts[2];\r\n      let control = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n      if (control) {\r\n        control.setValue(newName);\r\n      }\r\n    });\r\n  }\r\n\r\n  function searchMeasurementsForProject(project) {\r\n    let projectId = project.id.id ? project.id.id : project.id;\r\n    let projectMeasurementQuery = {\r\n      parameters: {\r\n        rootId: projectId,\r\n        rootType: 'ASSET',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Measurement']\r\n    };\r\n    assetService.findByQuery(projectMeasurementQuery).subscribe(\r\n      measurements => {\r\n        vm.projectMeasurements = measurements || [];\r\n\r\n        // Remove old measurement controls.\r\n        Object.keys(vm.transferKitFormGroup.controls)\r\n          .filter(controlName => controlName.startsWith('measurement') ||\r\n                                 controlName.startsWith('transferredMeasurement'))\r\n          .forEach(controlName => {\r\n            vm.transferKitFormGroup.removeControl(controlName);\r\n          });\r\n\r\n        (measurements || []).forEach((measurement, index) => {\r\n          vm.transferKitFormGroup.addControl(\r\n            'measurement' + index,\r\n            vm.fb.control({ value: measurement.name, disabled: true })\r\n          );\r\n          // Create transferred measurement control as disabled.\r\n          vm.transferKitFormGroup.addControl(\r\n            'transferredMeasurement' + index,\r\n            vm.fb.control({ value: '', disabled: true })\r\n          );\r\n        });\r\n\r\n        renameProjectMeasurements();\r\n      },\r\n      err => {\r\n        console.error(\"Error finding measurements for project:\", err);\r\n      }\r\n    );\r\n  }\r\n\r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      })\r\n    );\r\n  }\r\n  \r\n  // --- Group helper functions ---\r\n    function getProjectsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let projectsGroup = groups.find(g => g.name === 'Projects');\r\n          if (projectsGroup) {\r\n            return widgetContext.rxjs.of(projectsGroup);\r\n          } else {\r\n            projectsGroup = { type: 'ASSET', name: 'Projects', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(projectsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getMeasurementsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let measurementsGroup = groups.find(g => g.name === 'Measurements');\r\n          if (measurementsGroup) {\r\n            return widgetContext.rxjs.of(measurementsGroup);\r\n          } else {\r\n            measurementsGroup = { type: 'ASSET', name: 'Measurements', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(measurementsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getDiagnostickitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let kitsGroup = groups.find(g => g.name === 'Diagnostickits');\r\n          if (kitsGroup) {\r\n            return widgetContext.rxjs.of(kitsGroup);\r\n          } else {\r\n            kitsGroup = { type: 'ASSET', name: 'Diagnostickits', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(kitsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    // Modified getGatewaysGroup: Removed the type check\r\n    function getGatewaysGroup(customerId, updatedDevice) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let devicesGroup = groups.find(g => g.name === 'Gateways');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = { type: 'DEVICE', name: 'Gateways', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n    \r\n    function getDiagnostickitDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let devicesGroup = groups.find(g => g.name === 'Diagnostickit Devices');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = { type: 'DEVICE', name: 'Diagnostickit Devices', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    \r\n    function getUnassignedMeasurementDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let unassignedGroup = groups.find(g => g.name === 'Unassigned Measurement Devices');\r\n          if (unassignedGroup) {\r\n            return widgetContext.rxjs.of(unassignedGroup);\r\n          } else {\r\n            unassignedGroup = { type: 'DEVICE', name: 'Unassigned Measurement Devices', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(unassignedGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n  vm.save = function () {\r\n    let formValue = vm.transferKitFormGroup.value;\r\n    let selectedCustomer = formValue.customer;\r\n    if (!selectedCustomer || !selectedCustomer.id) {\r\n      console.warn('No customer selected.');\r\n      return;\r\n    }\r\n\r\n    if (!vm.customerShortName) {\r\n      vm.customerShortName = selectedCustomer.title;\r\n    }\r\n    let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n    let newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n\r\n    let saveObservables = [];\r\n    \r\n    let hasProjectMeasurements = vm.foundProject || (vm.projectMeasurements && vm.projectMeasurements.length > 0);\r\n    \r\n    let selectedKit = formValue.kit;\r\n    if (!selectedKit.name) {\r\n      console.warn(\"Selected kit has no name. Aborting save.\");\r\n      return;\r\n    }\r\n    let kitSave$ = assetService.saveAsset(selectedKit).pipe(\r\n      widgetContext.rxjs.switchMap(updatedKit => {\r\n        let kitEntity = updatedKit.id && updatedKit.id.entityType \r\n                          ? updatedKit.id \r\n                          : { id: updatedKit.id, entityType: 'ASSET' };\r\n        return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n            widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, kitEntity)),\r\n            // Always assign to Diagnostickits group\r\n            widgetContext.rxjs.switchMap(() => \r\n              getDiagnostickitsGroup(newOwner).pipe(\r\n                widgetContext.rxjs.switchMap(group => \r\n                  entityGroupService.addEntitiesToEntityGroup(group.id.id, [kitEntity.id])\r\n                )\r\n              )\r\n            ),\r\n            // If no project/measurements, also add to Unassigned Kit Group\r\n         );\r\n      })\r\n    );\r\n    saveObservables.push(kitSave$);\r\n\r\n    if (vm.foundProject) {\r\n      let project = vm.foundProject;\r\n      let candidate = vm.transferredProject && vm.transferredProject.trim();\r\n      if (!candidate) {\r\n        console.warn(\"Transferred project name was empty.\");\r\n        candidate = (vm.customerShortName || selectedCustomer.title) + '_Project_1';\r\n        formValue.transferredProject = candidate;\r\n        console.warn(\"Using fallback: \" + candidate);\r\n      }\r\n      project.name = candidate;\r\n      if (!project.type || project.type.trim() === \"\") {\r\n        project.type = \"Project\";\r\n      }\r\n      let projectSave$ = assetService.saveAsset(project).pipe(\r\n        widgetContext.rxjs.switchMap(updatedProject => {\r\n          let projectEntity = updatedProject.id && updatedProject.id.entityType \r\n                              ? updatedProject.id \r\n                              : { id: updatedProject.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, projectEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, projectEntity)),\r\n              widgetContext.rxjs.switchMap(() => getProjectsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(projectsGroup =>\r\n                entityGroupService.addEntitiesToEntityGroup(projectsGroup.id.id, [projectEntity.id])\r\n              )\r\n            );\r\n        })\r\n      );\r\n      saveObservables.push(projectSave$);\r\n    }\r\n\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n      let newMeasurementName = vm.transferKitFormGroup.get('transferredMeasurement' + index).value;\r\n      if (!newMeasurementName || newMeasurementName.trim() === \"\") {\r\n        console.warn(`New name for measurement at index ${index} is empty. Skipping update.`);\r\n        return;\r\n      }\r\n      measurement.name = newMeasurementName.trim();\r\n      let measurementSave$ = assetService.saveAsset(measurement).pipe(\r\n        widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n          let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType \r\n                                  ? updatedMeasurement.id \r\n                                  : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, measurementEntity)),\r\n              widgetContext.rxjs.switchMap(() => getMeasurementsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(measurementsGroup =>\r\n                entityGroupService.addEntitiesToEntityGroup(measurementsGroup.id.id, [measurementEntity.id])\r\n              )\r\n            );\r\n        })\r\n      );\r\n      saveObservables.push(measurementSave$);\r\n    });\r\n\r\n    // For each device, update its name with the value from the transferred device control.\r\n    // In the vm.save function, within the device update chain:\r\n    vm.allDevices.forEach((device, index) => {\r\n      let newDeviceName = vm.transferKitFormGroup.get('transferredDevice' + index).value;\r\n      if (!newDeviceName || newDeviceName.trim() === \"\") {\r\n        console.warn(`New name for device at index ${index} is empty. Skipping update.`);\r\n        return;\r\n      }\r\n      device.name = newDeviceName.trim();\r\n      let deviceSave$ = deviceService.saveDevice(device).pipe(\r\n        widgetContext.rxjs.switchMap(updatedDevice => {\r\n          let deviceEntity = updatedDevice.id && updatedDevice.id.entityType \r\n                             ? updatedDevice.id \r\n                             : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n          return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n            // Always assign to Diagnostickit Devices group\r\n            widgetContext.rxjs.switchMap(() => {\r\n              return getDiagnostickitDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(devicesGroup =>\r\n                    entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n            }\r\n            ),\r\n            // Conditionally assign to Gateways group if updatedDevice.type is 'RESI' or 'Gateway'\r\n            widgetContext.rxjs.switchMap(() => {\r\n              if (updatedDevice.type === 'RESI' || updatedDevice.type === 'Gateway') {\r\n                return getGatewaysGroup(newOwner, updatedDevice).pipe(\r\n                  widgetContext.rxjs.switchMap(devicesGroup =>\r\n                    entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n              } else {\r\n                return widgetContext.rxjs.of(null);\r\n              }\r\n            }),\r\n            // Additionally, if no project/measurements exist, assign to Unassigned Measurement Devices\r\n            widgetContext.rxjs.switchMap(() => {\r\n              if (!hasProjectMeasurements) {\r\n                return getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(group =>\r\n                    entityGroupService.addEntitiesToEntityGroup(group.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n              } else {\r\n                return widgetContext.rxjs.of(null);\r\n              }\r\n            })\r\n          );\r\n        })\r\n      );\r\n      saveObservables.push(deviceSave$);\r\n    });\r\n\r\n\r\n    widgetContext.rxjs.forkJoin(saveObservables).subscribe(\r\n      () => {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(formValue);\r\n      },\r\n      err => {\r\n        console.error('Error updating assets:', err);\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n}\r\n*/",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "act-transfer-kit"
              }
            ]
          },
          "pageSize": 1024,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "borderRadius": "8"
        },
        "row": 0,
        "col": 0,
        "id": "c6b19443-5057-176b-d3f8-2eebb67fc35e",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "d6393653-ccec-edf8-4bd7-520334011adb": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": false,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Diagnostic Kits",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "false",
            "displayEntityName": false,
            "entityNameColumnTitle": "Doktorkit ID",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "Label",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "Diagnostic Kit ID",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Diagnostic Kits",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "0d59106c-3aec-67d1-e5c6-1bea2904541b",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Diagnostic Kit ID",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.5282490591409559,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "kitType",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostic-kits.diagnostic-kit-type}",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "if(value==='basis'){\n    return 'Diagnostics Basis Kit';\n}\nif(value==='extension'){\n    return 'Diagnostics Extension Kit';\n}\nif(value==='loraWan'){\n    return 'Diagnostics LoRaWAN Kit';\n}",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.69568544537813,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "ownerName",
                  "type": "entityField",
                  "label": "Customer",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.8215491341579185,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "assignedTo",
                  "type": "attribute",
                  "label": "Assigned To",
                  "color": "#9c27b0",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "if(!value || value === '') {\n    return '<span style=\"color: #94a3b8;\">—</span>';\n}\nreturn value;",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5830868363386521,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastActivityTime",
                  "type": "attribute",
                  "label": "Last Activity / Status",
                  "color": "#9c27b0",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "// value = lastActivityTime (direct access, no label dependency)\nif (!value) {\n  return '<div style=\"width:fit-content;padding:4px 8px;border-radius:8px;line-height:20px;font-size:14px;font-weight:500;letter-spacing:0.25px;color:#808080;background-color:rgba(128,128,128,0.1)\">N/A</div>';\n}\n\nvar activityMs = typeof value === 'string' ? new Date(value).getTime() : Number(value);\nvar now = Date.now();\nvar diffMinutes = (now - activityMs) / 1000 / 60;\nvar isActive = diffMinutes < 5;\n\n// Format timestamp\nvar date = new Date(activityMs);\nvar pad = function(n) { return n.toString().padStart(2, '0'); };\nvar timestamp = date.getFullYear() + '-' + pad(date.getMonth()+1) + '-' + pad(date.getDate()) + ' ' + pad(date.getHours()) + ':' + pad(date.getMinutes());\n\nvar color = isActive ? '#27AE60' : '#FF0000';\nvar bgColor = isActive ? 'rgba(39,174,96,0.1)' : 'rgba(255,0,0,0.1)';\nvar status = isActive ? 'Active' : 'Inactive';\n\nreturn '<div style=\"display:flex;flex-direction:column;gap:2px;\">' +\n  '<div style=\"font-size:12px;color:#64748b;\">' + timestamp + '</div>' +\n  '<div style=\"width:fit-content;padding:2px 6px;border-radius:6px;font-size:12px;font-weight:500;color:' + color + ';background-color:' + bgColor + '\">' + status + '</div>' +\n'</div>';",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.06071069090279668,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "{i18n:custom.diagnostic-kits.open-devices}",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "92ce5e29-82ad-9f6e-51be-7bf3e7ae613d"
              }
            ],
            "actionCellButton": [
              {
                "name": "{i18n:custom.diagnostic-kits.edit-diagnostic-kit}",
                "icon": "edit",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole || '';\nvar isTenantAdmin = widgetContext.currentUser.authority === 'TENANT_ADMIN';\nvar isEcoAdmin = userRole === 'ECO Administrator';\nreturn isTenantAdmin || isEcoAdmin;",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"editEntityFormGroup\"\r\n      (ngSubmit)=\"save()\" \r\n      class=\"edit-entity-form max-w-3xl mx-auto\">\r\n    \r\n   <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n         <h2 class=\"text-lg font-semibold\">{{'custom.diagnostic-kits.edit-diagnostic-kit' | translate}}</h2>\r\n        <span class=\"flex-1\"></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n            <mat-icon>close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n    <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n\r\n        <!-- First row: Name-->\r\n        <div class=\"flex w-full gap-2\">\r\n\r\n            <!-- Name (Top-level form control) -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Diagnostic Kit Id</mat-label>\r\n                <input matInput \r\n                       formControlName=\"entityName\" \r\n                       required readonly>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('entityName')?.hasError('required')\">\r\n                  {{'custom.diagnostic-kits.diagnostic-kit-id-is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n\r\n            <!-- Label -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Label</mat-label>\r\n                <input matInput formControlName=\"label\" required>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('label')?.hasError('required')\">\r\n                  {{'custom.diagnostic-kits.label-is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n        </div>\r\n\r\n        <!-- Second row: kitType -->\r\n         <div class=\"flex w-full\">\r\n            <!-- HIDE Installation Type if measurementType is 'loraWan' -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\"\r\n                            *ngIf=\"editEntityFormGroup.get('attributes.measurementType')?.value !== 'loraWan'\"\r\n                            [formGroup]=\"editEntityFormGroup.controls['attributes']\">\r\n                <mat-label>{{'custom.diagnostic-kits.installation-type' | translate}}</mat-label>\r\n                <mat-select formControlName=\"kitType\" required>\r\n                     <mat-option value=\"basis\">Diagnostics Basis Kit</mat-option>\r\n                     <mat-option value=\"extension\">Diagnostics Extension Kit</mat-option>\r\n                     <mat-option value=\"loraWan\">Diagnostics LoRaWAN Kit</mat-option>\r\n                </mat-select>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('attributes.installationType')?.hasError('required')\">\r\n                  {{'custom.diagnostic-kits.diagnostic-kit-type-is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n        </div>\r\n    </div>\r\n\r\n    <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n        <button mat-button\r\n                color=\"primary\"\r\n                type=\"button\"\r\n                [disabled]=\"(isLoading$ | async)\"\r\n                (click)=\"cancel()\"\r\n                cdkFocusInitial>\r\n             {{'action.cancel' | translate}}\r\n        </button>\r\n        <button mat-button\r\n                mat-raised-button\r\n                color=\"primary\"\r\n                type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid\">\r\n            {{'action.save' | translate}}\r\n        </button>\r\n    </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\n\r\nopenEditEntityDialog();\r\n\r\nfunction openEditEntityDialog() {\r\n    customDialog.customDialog(htmlTemplate, EditEntityDialogController).subscribe();\r\n}\r\n\r\nfunction EditEntityDialogController(instance) {\r\n    let vm = instance;\r\n    vm.entityName = entityName; \r\n    vm.label = entityLabel; \r\n    vm.attributes = {};\r\n    vm.entity = {};\r\n\r\n    // Build the form group with a nested 'attributes' group\r\n    vm.editEntityFormGroup = vm.fb.group({\r\n        entityName: ['', [vm.validators.required]],\r\n        label: ['', [vm.validators.required]],\r\n        attributes: vm.fb.group({\r\n            kitType: [null]\r\n        })\r\n    });\r\n\r\n    getEntityInfo();\r\n\r\n    vm.cancel = function() {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function() {\r\n        // Mark the form as pristine right before saving\r\n        vm.editEntityFormGroup.markAsPristine();\r\n\r\n        // Save both entity main fields and attributes\r\n        widgetContext.rxjs.forkJoin([\r\n            saveAttributes(entityId),\r\n            saveEntity()\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n    function getEntityInfo() {\r\n        // Retrieve attributes + entity info in parallel\r\n        widgetContext.rxjs.forkJoin([\r\n            attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE'),\r\n            entityService.getEntity(entityId.entityType, entityId.id)\r\n        ]).subscribe(([attrData, entityData]) => {\r\n            vm.attributes = {};\r\n            // Populate vm.attributes from server response\r\n            for (let i = 0; i < attrData.length; i++) {\r\n                vm.attributes[attrData[i].key] = attrData[i].value;\r\n            }\r\n\r\n            vm.entity = entityData;\r\n\r\n            // Patch form values. \r\n            // Note that 'attributes' is a nested form group, so we pass an object for it.\r\n            vm.editEntityFormGroup.patchValue({\r\n                entityName: vm.entity.name,\r\n                label: vm.entity.label,\r\n                attributes: {\r\n                    kitType: vm.attributes.kitType\r\n                }\r\n            }, { emitEvent: false });\r\n        });\r\n    }\r\n\r\n    function saveEntity() {\r\n        const formValues = vm.editEntityFormGroup.value;\r\n        \r\n        // Always update name & label (ensures \"Save\" works even if no change)\r\n        vm.entity.name = formValues.entityName;\r\n        vm.entity.label = formValues.label;\r\n        /*console.log(\"enitity\",vm.entity);*/\r\n        return assetService.saveAsset(vm.entity);\r\n        \r\n        // If some other type, or no changes, return an observable that completes.\r\n        return widgetContext.rxjs.of([]);\r\n    }\r\n\r\n    function saveAttributes(entityId) {\r\n        // Compare original vs. new values to only send changed attributes\r\n        const currentAttributes = vm.attributes;\r\n        const updatedAttributes = vm.editEntityFormGroup.value.attributes;\r\n        \r\n        let attributesArray = [];\r\n        for (let key in updatedAttributes) {\r\n            if (updatedAttributes.hasOwnProperty(key)) {\r\n                if (updatedAttributes[key] !== currentAttributes[key]) {\r\n                    attributesArray.push({ key: key, value: updatedAttributes[key] });\r\n                }\r\n            }\r\n        }\r\n\r\n        if (attributesArray.length > 0) {\r\n            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n        }\r\n        return widgetContext.rxjs.of([]);\r\n    }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "4ba82627-39fc-7ac8-015e-8bb5184d8c82"
              },
              {
                "name": "Kit Devices",
                "icon": "devices",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole || '';\nvar isTenantAdmin = widgetContext.currentUser.authority === 'TENANT_ADMIN';\nvar isEcoAdmin = userRole === 'ECO Administrator';\n// Also visible for Administrators, Engineers\nvar isAdmin = userRole.includes('Administrator');\nvar isEngineer = userRole.includes('Engineer');\nreturn isTenantAdmin || isEcoAdmin || isAdmin || isEngineer;",
                "type": "custom",
                "id": "71c478b6-a4b1-e569-e99a-85d5562cc721",
                "customFunction": {
                  "body": "const kitId = entityId;\nconst kitName = entityName;\nkitDevicesPopup.openKitDevicesDialog(widgetContext, kitId, kitName);",
                  "modules": {
                    "kitDevicesPopup": "tb-resource;/api/resource/js_module/tenant/ECO Kit Devices Popup.js"
                  }
                }
              },
              {
                "name": "{i18n:custom.diagnostic-kits.next-delete-diagnostic-kit}",
                "icon": "delete",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole || '';\nvar isTenantAdmin = widgetContext.currentUser.authority === 'TENANT_ADMIN';\nvar isEcoAdmin = userRole === 'ECO Administrator';\nreturn isTenantAdmin || isEcoAdmin;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteDiagnostickitDialog();\n\nfunction openDeleteDiagnostickitDialog() {\n  let titleTranslation = translationService.instant(\n    'custom.diagnostic-kits.delete.title',\n    { entityName: entityName }\n  );\n\n  let contentTranslation = translationService.instant(\n    'custom.diagnostic-kits.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteDiagnostickit();\n    }\n  });\n}\n\nfunction deleteDiagnostickit() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteDiagnostickitToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Diagnostickit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Diagnostickit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDiagnostickitToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "338d9fd7-c752-eb0e-4687-2c2e32ca1a32"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:action.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n//params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "86c3f72e-d682-b95b-e997-3167fc8c83cd"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.add-diagnostic-kit}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "/*var userRole = widgetContext.stateController.getStateParams().userRole;\nif(userRole === 'ECO Administrator'){\n    return true;\n}else{\n    return false;\n}*/\nreturn false;",
                "type": "customPretty",
                "customHtml": "<!-- HTML Template for the \"Add Diagnostickit\" Dialog -->\r\n<form\r\n  #addEntityForm=\"ngForm\"\r\n  [formGroup]=\"addDiagnostickitFormGroup\"\r\n  (ngSubmit)=\"save()\"\r\n  class=\"add-entity-form max-w-3xl mx-auto\"\r\n  style=\"width: 350px;\"\r\n>\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.diagnostic-kits.add-diagnostic-kit' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar\r\n    color=\"warn\"\r\n    mode=\"indeterminate\"\r\n    *ngIf=\"isLoading$ | async\"\r\n  ></mat-progress-bar>\r\n\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <div class=\"flex flex-col gap-0 sm:gap-2\">\r\n      \r\n      <!-- Diagnostickit Name / ID -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>Diagnostickit ID</mat-label>\r\n        <input matInput formControlName=\"name\" required/>\r\n        <mat-error *ngIf=\"addDiagnostickitFormGroup.get('name').hasError('required')\">\r\n          {{ 'custom.diagnostic-kits.diagnostic-kit-id-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Label -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>Label</mat-label>\r\n        <input matInput formControlName=\"label\"/>\r\n        <mat-error *ngIf=\"addDiagnostickitFormGroup.get('label').hasError('required')\">\r\n          {{ 'custom.diagnostic-kits.label-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Diagnostic Kit Type -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.diagnostic-kits.diagnostic-kit-type' | translate }}</mat-label>\r\n        <mat-select formControlName=\"kitType\" required>\r\n          <mat-option value=\"basis\">Diagnostics Basis Kit</mat-option>\r\n          <!--<mat-option value=\"extension\">Diagnostics Extension Kit</mat-option>-->\r\n          <mat-option value=\"loraWan\">Diagnostics LoRaWAN Kit</mat-option>\r\n        </mat-select>\r\n        <mat-error *ngIf=\"addDiagnostickitFormGroup.get('kitType')?.hasError('required')\">\r\n          {{ 'custom.diagnostic-kits.diagnostic-kit-type-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button\r\n      mat-button\r\n      color=\"primary\"\r\n      type=\"button\"\r\n      [disabled]=\"(isLoading$ | async)\"\r\n      (click)=\"cancel()\"\r\n      cdkFocusInitial\r\n    >\r\n      {{ 'action.cancel' | translate }}\r\n    </button>\r\n    <button\r\n      mat-button\r\n      mat-raised-button\r\n      color=\"primary\"\r\n      type=\"submit\"\r\n      [disabled]=\"(isLoading$ | async)\"\r\n    >\r\n      {{ 'custom.diagnostic-kits.add-diagnostic-kit' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "// JS/Typescript Code\r\n\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nconst rxjs = widgetContext.rxjs;\r\nlet customerId;\r\nlet diagnostickitsAll = []; // Will store all Diagnostickits across customers\r\n\r\n// Determine which customer ID to use\r\nlet customerName = widgetContext.stateController.getStateParams().entityName;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n    customerId = widgetContext.stateController.getStateParams().entityId;\r\n} else {\r\n    customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n}\r\n\r\n// Page link to fetch customers\r\nconst pageLink = widgetContext.pageLink(100, 0, null, null); // PageSize: 100, PageNumber: 0\r\n\r\n// Fetch all customers, then fetch all their Diagnostickits\r\n/*customerService.getCustomers(pageLink).subscribe(customers => {\r\n  //console.log(\"customers:\", customers);\r\n\r\n  // Track how many customer queries have completed\r\n  let processed = 0;\r\n  const totalCustomers = customers.data.length;\r\n\r\n  customers.data.map(customer => {\r\n    // Build our query for this specific customer's ID\r\n    const assetSearchQuery = {\r\n      parameters: {\r\n        rootId: customer.id.id,       \r\n        rootType: 'CUSTOMER',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Diagnostickit']\r\n    };\r\n\r\n    assetService.findByQuery(assetSearchQuery).subscribe(diagnostickits => {\r\n      //console.log(\"diagnostickits of customer:\", customer.name, diagnostickits);    \r\n      // Merge these Diagnostickits into our master array\r\n      diagnostickitsAll.push(...diagnostickits);\r\n\r\n      // Increment the processed counter\r\n      processed++;\r\n      // If we've processed all customers, open the dialog\r\n      if (processed === totalCustomers) {\r\n        //console.log('All Diagnostickits across all customers:', diagnostickitsAll);\r\n        openAddDiagnostickitDialog(diagnostickitsAll);\r\n      }\r\n    });\r\n  });\r\n});*/\r\nopenAddDiagnostickitDialog(diagnostickitsAll);\r\n// Opens the custom dialog, passing in the collected diagnostickitsAll\r\nfunction openAddDiagnostickitDialog(diagnostickitsAll) {\r\n  customDialog.customDialog(htmlTemplate, AddDiagnostickitDialogController, { diagnostickitsAll }).subscribe();\r\n}\r\n\r\n// The Dialog Controller\r\nfunction AddDiagnostickitDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  // We have access to diagnostickitsAll via instance.data\r\n  vm.diagnostickitsAll = instance.data.diagnostickitsAll || [];\r\n\r\n  // Reactive form definition\r\n  vm.addDiagnostickitFormGroup = vm.fb.group({\r\n    name: [null, [vm.validators.required]],\r\n    label: [null],\r\n    kitType: ['basis', [vm.validators.required]]\r\n  });\r\n\r\n /*function generateDiagnostickitName(kitType) {\r\n  // Current 2-digit year\r\n  const year = (new Date().getFullYear() % 100).toString().padStart(2, '0');\r\n\r\n  // Determine the prefix for the *new* kit\r\n  const prefix = kitType === 'basis' ? 'DBKIT' : 'DEKIT';\r\n\r\n  // Single pattern to match either DBKIT or DEKIT, ignoring the year for the counter\r\n  // Explanation:\r\n  //   ^D(B|E)KIT         => Must start with DBKIT or DEKIT\r\n  //   \\d{2}             => Then two digits (the year)\r\n  //   EU-               => Then 'EU-'\r\n  //   (\\d{4})           => Capture the 4-digit counter\r\n  const pattern = /^D(B|E)KIT\\d{2}EU-(\\d{4})$/;\r\n\r\n  let maxNumber = 0;\r\n\r\n  // Find the max counter among all kits that match DBKITyyEU-#### or DEKITyyEU-####\r\n  vm.diagnostickitsAll.forEach(d => {\r\n    const match = d.name.match(pattern);\r\n    if (match) {\r\n      // match[2] should contain the 4-digit counter\r\n      const currentNum = parseInt(match[2], 10);\r\n      if (currentNum > maxNumber) {\r\n        maxNumber = currentNum;\r\n      }\r\n    }\r\n  });\r\n\r\n  // Next counter (increment by 1)\r\n  const nextNumber = (maxNumber + 1).toString().padStart(4, '0');\r\n\r\n  // Construct new name with correct prefix, current year, and the incremented counter\r\n  return `${prefix}${year}EU-${nextNumber}`;\r\n}*/\r\n\r\n\r\n\r\n  // Whenever the kitType changes, regenerate the name\r\n  /*vm.addDiagnostickitFormGroup.get('kitType').valueChanges.subscribe((newKitType) => {\r\n    const newName = generateDiagnostickitName(newKitType);\r\n    vm.addDiagnostickitFormGroup.patchValue(\r\n      { name: newName },\r\n      { emitEvent: false } // avoid infinite loop\r\n    );\r\n  });*/\r\n\r\n  // Initialize the name based on the default kitType ('basis')\r\n  /*vm.addDiagnostickitFormGroup.patchValue({\r\n    name: generateDiagnostickitName(vm.addDiagnostickitFormGroup.get('kitType').value)\r\n  }, { emitEvent: false });*/\r\n\r\n  // Cancel / close the dialog\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  // Save action\r\n  vm.save = function () {\r\n    const stateParams = widgetContext.stateController.getStateParams();\r\n    var projectId, measurementId;\r\n\r\n    projectId = {\r\n      id: (stateParams.selectedProject && stateParams.selectedProject.entityId && stateParams.selectedProject.entityId.id)\r\n        ? stateParams.selectedProject.entityId.id\r\n        : '',\r\n      entityType: 'ASSET'\r\n    };\r\n\r\n    measurementId = {\r\n      id: (stateParams.selectedMeasurement && stateParams.selectedMeasurement.entityId && stateParams.selectedMeasurement.entityId.id)\r\n        ? stateParams.selectedMeasurement.entityId.id\r\n        : '',\r\n      entityType: 'ASSET'\r\n    };\r\n    \r\n    let localCustomerId;\r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        localCustomerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        localCustomerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n\r\n    vm.addDiagnostickitFormGroup.markAsPristine();\r\n\r\n    // Save the Diagnostickit asset, then link it\r\n    saveDiagnostickitObservable(localCustomerId).subscribe(\r\n      function (Diagnostickit) {\r\n        const observables = [\r\n          saveCustomerToDiagnostickitRelation(localCustomerId, Diagnostickit.id),\r\n          saveAttributes(Diagnostickit.id)\r\n        ];\r\n\r\n        // If there's a selected project, relate it\r\n        if(projectId.id !== \"\"){\r\n            observables.push(saveProjectToDiagnostickitRelation(projectId, Diagnostickit.id));\r\n        }\r\n        // If there's a selected measurement, relate it\r\n        if(measurementId.id !== \"\"){\r\n            observables.push(saveMeasurementToDiagnostickitRelation(measurementId, Diagnostickit.id));\r\n        }\r\n\r\n        widgetContext.rxjs.forkJoin(observables).subscribe(\r\n          function () {\r\n            var params = widgetContext.stateController.getStateParams();\r\n            // Update selectedDiagnostickit in state params\r\n            params['selectedDiagnostickit'] = {\r\n              entityId: Diagnostickit.id,\r\n              entityName: Diagnostickit.name\r\n            };\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n          }\r\n        );\r\n      }\r\n    );\r\n  };\r\n\r\n  // -------------- Helper Functions -------------- //\r\n\r\n  // Save Diagnostickit asset inside the 'Diagnostickits' group and also add it to 'Unassigned Kit' group\r\n  function saveDiagnostickitObservable(customerId) {\r\n    return getDiagnostickitsGroup(customerId).pipe(\r\n      widgetContext.rxjs.switchMap((DiagnostickitsGroup) => {\r\n        return getUnassignedKitGroup(customerId).pipe(\r\n          widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\r\n            const formValues = vm.addDiagnostickitFormGroup.value;\r\n            const Diagnostickit = {\r\n              name: formValues.name,\r\n              label: formValues.label,\r\n              type: 'Diagnostickit',\r\n              customerId: customerId\r\n            };\r\n\r\n            return assetService.saveAsset(Diagnostickit, DiagnostickitsGroup.id.id).pipe(\r\n              widgetContext.rxjs.switchMap((savedAsset) => {\r\n                // Add the new Diagnostickit to the \"Unassigned Kit\" group\r\n                return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, savedAsset.id.id).pipe(\r\n                  widgetContext.rxjs.map(() => {\r\n                    return savedAsset; \r\n                  })\r\n                );\r\n              })\r\n            );\r\n          })\r\n        );\r\n      })\r\n    );\r\n  }\r\n\r\n  // Get or create the \"Diagnostickits\" group\r\n  function getDiagnostickitsGroup(customerId) {\r\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n      widgetContext.rxjs.switchMap((entityGroups) => {\r\n        var DiagnostickitsGroup = entityGroups.find(group => group.name === 'Diagnostickits');\r\n        if (DiagnostickitsGroup) {\r\n          return widgetContext.rxjs.of(DiagnostickitsGroup);\r\n        } else {\r\n          DiagnostickitsGroup = {\r\n            type: 'ASSET',\r\n            name: 'Diagnostickits',\r\n            ownerId: customerId\r\n          };\r\n          return entityGroupService.saveEntityGroup(DiagnostickitsGroup);\r\n        }\r\n      })\r\n    );\r\n  }\r\n\r\n  // Get or create the \"Unassigned Kit\" group\r\n  function getUnassignedKitGroup(customerId) {\r\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n      widgetContext.rxjs.switchMap((entityGroups) => {\r\n        var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n        if (UnassignedKitGroup) {\r\n          return widgetContext.rxjs.of(UnassignedKitGroup);\r\n        } else {\r\n          UnassignedKitGroup = {\r\n            type: 'ASSET',\r\n            name: 'Unassigned Kit',\r\n            ownerId: customerId\r\n          };\r\n          return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n        }\r\n      })\r\n    );\r\n  }\r\n\r\n  // Create relation: Customer -> Diagnostickit\r\n  function saveCustomerToDiagnostickitRelation(customerId, DiagnostickitId) {\r\n    var relation = {\r\n      from: customerId,\r\n      to: DiagnostickitId,\r\n      typeGroup: 'COMMON',\r\n      type: 'Owns'\r\n    };\r\n    return entityRelationService.saveRelation(relation);\r\n  }\r\n\r\n  // Create relation: Project -> Diagnostickit\r\n  function saveProjectToDiagnostickitRelation(projectId, DiagnostickitId) {\r\n    var relation = {\r\n      from: projectId,\r\n      to: DiagnostickitId,\r\n      typeGroup: 'COMMON',\r\n      type: 'Owns'\r\n    };\r\n    return entityRelationService.saveRelation(relation);\r\n  }\r\n\r\n  // Create relation: Measurement -> Diagnostickit\r\n  function saveMeasurementToDiagnostickitRelation(measurementId, DiagnostickitId) {\r\n    var relation = {\r\n      from: measurementId,\r\n      to: DiagnostickitId,\r\n      typeGroup: 'COMMON',\r\n      type: 'Owns'\r\n    };\r\n    return entityRelationService.saveRelation(relation);\r\n  }\r\n\r\n  // Save attributes for the newly created Diagnostickit\r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n      {\r\n        key: 'state',\r\n        value: 'normal'\r\n      },\r\n      {\r\n        key: 'kitType',\r\n        value: vm.addDiagnostickitFormGroup.get('kitType').value\r\n      }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e965b8a1-a6ac-5ae4-fd79-2b7220b91ed1"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.transfer-kit}",
                "buttonType": "icon",
                "icon": "mdi:swap-horizontal",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "//var userRole = widgetContext.stateController.getStateParams().userRole;\n//return userRole === 'ECO Administrator';\nreturn false;",
                "type": "customPretty",
                "customHtml": "<form #transferKitForm=\"ngForm\" [formGroup]=\"transferKitFormGroup\" (ngSubmit)=\"save()\" class=\"transferKitFormGroup max-w-3xl mx-auto\" style=\"width: 800px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.diagnostic-kits.transfer-kit' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n   <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n      <mat-label>Kit</mat-label>\r\n      <mat-select formControlName=\"kit\" required (selectionChange)=\"onKitSelected($event)\">\r\n        <mat-option *ngFor=\"let kit of kits\" [value]=\"kit\">\r\n          {{ kit.name }}\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"transferKitFormGroup.get('kit')?.hasError('required')\">\r\n        {{ 'custom.diagnostic-kits.kit-is-required' | translate }}\r\n      </mat-error>\r\n    </mat-form-field>\r\n    \r\n    <div class=\"flex justify-center items-center\" style=\"padding-bottom: 10px;\">\r\n      <mat-icon>arrow_downward</mat-icon>\r\n    </div>\r\n\r\n   <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n      <mat-label>{{ 'custom.diagnostic-kits.customer' | translate }}</mat-label>\r\n      <mat-select formControlName=\"customer\" required (selectionChange)=\"onCustomerSelected($event)\">\r\n        <mat-option *ngFor=\"let cust of customers\" [value]=\"cust\">\r\n          {{ cust.title }}\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"transferKitFormGroup.get('customer')?.hasError('required')\">\r\n        {{ 'custom.diagnostic-kits.customer-is-required' | translate }}\r\n      </mat-error>\r\n    </mat-form-field>\r\n    \r\n    <div *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" class=\"flex justify-center items-center pb-5\">\r\n      <mat-icon>arrow_downward</mat-icon>\r\n    </div>\r\n      \r\n    <fieldset *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" class=\"fieldset\" style=\"margin-bottom: 16px;\">\r\n      <div class=\"flex flex-row justify-start items-center py-2.5\">\r\n        <div style=\"width: 40px; display: flex; justify-content: center; align-items: center;\">\r\n          <mat-icon>info</mat-icon>\r\n        </div>\r\n        <div class=\"flex-1\">\r\n          <p style=\"font-size: 15px; margin: 0;\">\r\n            {{ 'custom.diagnostic-kits.kit-has-assigned-measurement-warning' | translate }}\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </fieldset>\r\n    \r\n    <div *ngIf=\"foundProject\" class=\"flex justify-start items-center\" style=\"margin-top:10px;\">\r\n      <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n        <mat-label>{{ 'custom.diagnostic-kits.found-project' | translate }}</mat-label>\r\n        <input matInput formControlName=\"foundProject\" readonly>\r\n      </mat-form-field>\r\n      \r\n      <div style=\"padding: 0 10px;\">\r\n        <mat-icon>arrow_right_alt</mat-icon>\r\n      </div>\r\n      \r\n      <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n        <mat-label>{{ 'custom.diagnostic-kits.transferred-project' | translate }}Transferred Project</mat-label>\r\n        <input matInput formControlName=\"transferredProject\" readonly>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" style=\"margin-top:10px;\">\r\n      <div *ngFor=\"let measurement of projectMeasurements; let i = index\" class=\"flex flex-row justify-start items-center\" style=\"margin-bottom:8px;\">\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.found-measurement' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'measurement' + i\" readonly>\r\n        </mat-form-field>\r\n        <div style=\"padding: 0 10px;\">\r\n          <mat-icon>arrow_right_alt</mat-icon>\r\n        </div>\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.transferred-measurement' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'transferredMeasurement' + i\" readonly>\r\n        </mat-form-field>\r\n      </div>\r\n    </div>\r\n\r\n    <div *ngIf=\"allDevices && allDevices.length > 0\" style=\"margin-top:10px;\">\r\n      <div *ngFor=\"let device of allDevices; let i = index\" class=\"flex flex-row justify-start items-center\" style=\"margin-bottom:8px;\">\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.found-device' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'device' + i\" readonly>\r\n        </mat-form-field>\r\n        <div style=\"padding: 0 10px;\">\r\n          <mat-icon>arrow_right_alt</mat-icon>\r\n        </div>\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.transferred-device' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'transferredDevice' + i\" readonly>\r\n        </mat-form-field>\r\n      </div>\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">{{ 'action.cancel' | translate }}</button>\r\n    <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"transferKitFormGroup.invalid\">\r\n      {{ 'action.save' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.transferKitFormGroup .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.transferKitFormGroup .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.transferKitFormGroup\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.transferKitFormGroup\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet dialogs = injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\nlet customerId, customer;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet pageLink = {\r\n  pageSize: 100, page: 0, textSearch: '', sortOrder: 'ASC', sortProperty: 'title',\r\n  toQuery: function () {\r\n    let q = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) q += '&textSearch=' + encodeURIComponent(this.textSearch);\r\n    if (this.sortProperty) q += '&sortProperty=' + encodeURIComponent(this.sortProperty);\r\n    if (this.sortOrder) q += '&sortOrder=' + encodeURIComponent(this.sortOrder);\r\n    return q;\r\n  }\r\n};\r\n\r\nlet kits = [];\r\nlet customers = [];\r\nlet kitsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (kitsLoaded && customersLoaded) openTransferKitDialog(kits, customers);\r\n}\r\n\r\nlet kitSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id, rootType: 'CUSTOMER', direction: 'FROM',\r\n    relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Diagnostickit']\r\n};\r\n\r\nassetService.findByQuery(kitSearchQuery).subscribe(\r\n  result => { kits = result; kitsLoaded = true; checkAndOpenDialog(); },\r\n  () => { kits = []; kitsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\n// NOTE: credentials come from your original snippet\r\nlet bearerToken = '';\r\nfetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n  method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n  body: JSON.stringify({ \"username\": \"belimo.api@pke-iot.expert\", \"password\": \"vfx3cvr@VMJ3bxk3urg\" })\r\n})\r\n  .then(resp => resp.json())\r\n  .then(loginData => {\r\n    bearerToken = loginData.token;\r\n    return fetch('https://cloud.pke-iot.expert/api/customers?pageSize=100&page=0', {\r\n      method: 'GET',\r\n      headers: { 'accept': 'application/json', 'X-Authorization': 'Bearer ' + bearerToken }\r\n    });\r\n  })\r\n  .then(resp2 => resp2.json())\r\n  .then(customersList => {\r\n    customers = customersList.data;\r\n    if (customer) customers = customers.filter(cust => cust.title !== customer);\r\n    customersLoaded = true; checkAndOpenDialog();\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching customers:\", error);\r\n    alert('Failed to fetch customers.');\r\n  });\r\n\r\nfunction openTransferKitDialog(kits, customers) {\r\n  customDialog.customDialog(htmlTemplate, TransferKitDialogController, { kits, customers }).subscribe();\r\n}\r\n\r\nfunction TransferKitDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.kits = data.kits || [];\r\n  vm.customers = data.customers || [];\r\n\r\n  vm.transferKitFormGroup = vm.fb.group({\r\n    kit: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n  vm.transferKitFormGroup.addControl('transferredProject', vm.fb.control({ value: '', disabled: true }));\r\n\r\n  vm.allDevices = [];\r\n  vm.devicesWithMeasurements = [];\r\n  vm.foundProject = null;\r\n  vm.projectMeasurements = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n     vm.measurementRenameMap = new Map();\r\n\r\n\r\n  const groupCache = new Map(); // key: ownerId|scope|name -> Observable(group)\r\n  function ensureGroup(ownerIdObj, scopeType, name) {\r\n    const key = ownerIdObj.id + '|' + scopeType + '|' + name;\r\n    if (groupCache.has(key)) return groupCache.get(key);\r\n\r\n    const obs = entityGroupService.getEntityGroupsByOwnerId(ownerIdObj.entityType, ownerIdObj.id, scopeType).pipe(\r\n      widgetContext.rxjs.switchMap(groups => {\r\n        let g = (groups || []).find(x => x.name === name);\r\n        if (g) return widgetContext.rxjs.of(g);\r\n        const payload = { type: scopeType, name, ownerId: ownerIdObj };\r\n        return entityGroupService.saveEntityGroup(payload).pipe(\r\n          // If backend races and says \"already exists\", re-fetch once\r\n          widgetContext.rxjs.catchError(err => {\r\n            if (err && err.status === 400) {\r\n              return entityGroupService.getEntityGroupsByOwnerId(ownerIdObj.entityType, ownerIdObj.id, scopeType).pipe(\r\n                widgetContext.rxjs.map(gs => (gs || []).find(x => x.name === name))\r\n              );\r\n            }\r\n            return widgetContext.rxjs.throwError(err);\r\n          })\r\n        );\r\n      }),\r\n      widgetContext.rxjs.shareReplay(1)\r\n    );\r\n    groupCache.set(key, obs);\r\n    return obs;\r\n  }\r\n\r\n  function addToGroupSafe(groupId, entityId) {\r\n    return entityGroupService.addEntitiesToEntityGroup(groupId, [entityId]).pipe(\r\n      widgetContext.rxjs.catchError(err => {\r\n        // tolerate duplicate-membership/409/400 responses\r\n        return widgetContext.rxjs.of(null);\r\n      })\r\n    );\r\n  }\r\n\r\n  function getProjectsGroup(owner)                { return ensureGroup(owner, 'ASSET',  'Projects'); }\r\n  function getMeasurementsGroup(owner)            { return ensureGroup(owner, 'ASSET',  'Measurements'); }\r\n  function getDiagnostickitsGroup(owner)          { return ensureGroup(owner, 'ASSET',  'Diagnostickits'); }\r\n  function getGatewaysGroup(owner)                { return ensureGroup(owner, 'DEVICE', 'Gateways'); }\r\n  function getDiagnostickitDevicesGroup(owner)    { return ensureGroup(owner, 'DEVICE', 'Diagnostickit Devices'); }\r\n  function getUnassignedMeasurementDevicesGroup(owner) { return ensureGroup(owner, 'DEVICE', 'Unassigned Measurement Devices'); }\r\n\r\n  vm.transferKitFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId, rootType: 'CUSTOMER', direction: 'FROM',\r\n          relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { vm.transferredProject = null; vm.customerShortName = null; }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null; vm.customerShortName = null;\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        if (vm.transferKitFormGroup.get('transferredMeasurement' + index)) {\r\n          vm.transferKitFormGroup.get('transferredMeasurement' + index).setValue('');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  vm.onKitSelected = function (event) {\r\n    let selectedKit = event.value;\r\n    vm.allDevices = [];\r\n    vm.devicesWithMeasurements = [];\r\n    vm.foundProject = null;\r\n    vm.projectMeasurements = [];\r\n\r\n    Object.keys(vm.transferKitFormGroup.controls)\r\n      .filter(n => n.startsWith('measurement') || n.startsWith('transferredMeasurement') || n.startsWith('device') || n.startsWith('transferredDevice'))\r\n      .forEach(n => vm.transferKitFormGroup.removeControl(n));\r\n    \r\n    let selectedCustomer = vm.transferKitFormGroup.get('customer').value;\r\n    if (!selectedKit || !selectedCustomer) {\r\n      console.warn(\"Kit or customer not selected yet.\");\r\n      return;\r\n    }\r\n    \r\n    let selectedKitId = selectedKit.id.id ? selectedKit.id.id : selectedKit.id;\r\n\r\n    let deviceSearchQuery = {\r\n      parameters: {\r\n        rootId: selectedKitId, rootType: 'ASSET', direction: 'FROM',\r\n        relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: true\r\n      },\r\n      relationType: 'Contains',\r\n      deviceTypes: ['P-Flow D116','Room Sensor CO2','Temperature Sensor','RESI','Gateway','LTE Status']\r\n    };\r\n    \r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n      devices => {\r\n        vm.allDevices = devices || [];\r\n        if (vm.allDevices.length === 0) return;\r\n\r\n        vm.allDevices.forEach((device, index) => {\r\n          vm.transferKitFormGroup.addControl('device' + index, vm.fb.control({ value: device.name, disabled: true }));\r\n          vm.transferKitFormGroup.addControl('transferredDevice' + index, vm.fb.control({ value: device.name, disabled: true }));\r\n        });\r\n\r\n        let measurementChecks = vm.allDevices.map(device => {\r\n          let measurementQuery = {\r\n            parameters: {\r\n              rootId: (device.id.id ? device.id.id : device.id), rootType: 'DEVICE', direction: 'TO',\r\n              relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: false\r\n            },\r\n            relationType: 'Measurement',\r\n            assetTypes: ['Measurement']\r\n          };\r\n          return assetService.findByQuery(measurementQuery).pipe(\r\n            widgetContext.rxjs.map(measurements => ({ device, measurements: measurements || [] }))\r\n          );\r\n        });\r\n\r\n        widgetContext.rxjs.forkJoin(measurementChecks).subscribe(\r\n          measurementResults => {\r\n            vm.devicesWithMeasurements = measurementResults.filter(r => r.measurements.length > 0);\r\n            let projectChecks = [];\r\n            vm.devicesWithMeasurements.forEach(item => {\r\n              item.measurements.forEach(meas => {\r\n                let projectQuery = {\r\n                  parameters: {\r\n                    rootId: (meas.id.id ? meas.id.id : meas.id), rootType: 'ASSET', direction: 'TO',\r\n                    relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: 'Owns',\r\n                  assetTypes: ['Project']\r\n                };\r\n                projectChecks.push(assetService.findByQuery(projectQuery).pipe(\r\n                  widgetContext.rxjs.map(projects => ({ measurement: meas, projects: projects || [] }))\r\n                ));\r\n              });\r\n            });\r\n            if (projectChecks.length === 0) return;\r\n\r\n            widgetContext.rxjs.forkJoin(projectChecks).subscribe(\r\n              projectResults => {\r\n                let found = projectResults.find(r => r.projects.length > 0);\r\n                if (found) {\r\n                  vm.foundProject = found.projects[0];\r\n                  if (!vm.transferKitFormGroup.get('foundProject')) {\r\n                    vm.transferKitFormGroup.addControl('foundProject', vm.fb.control({ value: vm.foundProject.name, disabled: true }));\r\n                  } else {\r\n                    vm.transferKitFormGroup.get('foundProject').setValue(vm.foundProject.name);\r\n                  }\r\n                  searchMeasurementsForProject(vm.foundProject);\r\n                }\r\n              },\r\n              err => console.error(\"Error during project queries:\", err)\r\n            );\r\n          },\r\n          err => console.error(\"Error in measurement checks:\", err)\r\n        );\r\n      },\r\n      err => console.error(\"Error finding devices for kit:\", err)\r\n    );\r\n  };\r\n\r\n  vm.onCustomerSelected = function () {\r\n    let kit = vm.transferKitFormGroup.get('kit').value;\r\n    if (kit) vm.onKitSelected({ value: kit });\r\n  };\r\n\r\n  function updateFoundProjectName(customerShortName, existingProjects) {\r\n    if (!customerShortName) return;\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) { maxNumericSuffix = parsedNum; }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    vm.transferredProject = candidate;\r\n    vm.transferKitFormGroup.get('transferredProject').setValue(candidate);\r\n  }\r\n\r\n  function renameProjectMeasurements() {\r\n    if (!vm.customerShortName) return;\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n      let newProjectNameCtrl = vm.transferKitFormGroup.get('transferredProject');\r\n      let oldName = measurement.name;\r\n      let parts = oldName.split('_');\r\n      let newName = newProjectNameCtrl.value + '_' + parts[2];\r\n      let control = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n      if (control) control.setValue(newName);\r\n    });\r\n  }\r\n\r\n  function searchMeasurementsForProject(project) {\r\n    let projectId = project.id.id ? project.id.id : project.id;\r\n    let projectMeasurementQuery = {\r\n      parameters: {\r\n        rootId: projectId, rootType: 'ASSET', direction: 'FROM',\r\n        relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Measurement']\r\n    };\r\n    assetService.findByQuery(projectMeasurementQuery).subscribe(\r\n      measurements => {\r\n        vm.projectMeasurements = measurements || [];\r\n        Object.keys(vm.transferKitFormGroup.controls)\r\n          .filter(n => n.startsWith('measurement') || n.startsWith('transferredMeasurement'))\r\n          .forEach(n => vm.transferKitFormGroup.removeControl(n));\r\n        (measurements || []).forEach((measurement, index) => {\r\n          vm.transferKitFormGroup.addControl('measurement' + index, vm.fb.control({ value: measurement.name, disabled: true }));\r\n          vm.transferKitFormGroup.addControl('transferredMeasurement' + index, vm.fb.control({ value: '', disabled: true }));\r\n        });\r\n        renameProjectMeasurements();\r\n      },\r\n      err => console.error(\"Error finding measurements for project:\", err)\r\n    );\r\n  }\r\n\r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      }),\r\n      widgetContext.rxjs.catchError(() => widgetContext.rxjs.of(null)) // tolerate if old relation missing\r\n    );\r\n  }\r\n\r\n  function getVrDevicesForDevice(deviceId) {\r\n    return entityRelationService.findByTo({ id: deviceId, entityType: 'DEVICE' }).pipe(\r\n      widgetContext.rxjs.map(rels =>\r\n        (rels || [])\r\n          .filter(r => r.typeGroup === 'COMMON' && r.type === 'VR' && r.from?.entityType === 'DEVICE')\r\n          .map(r => (r.from.id.id ? r.from.id.id : r.from.id)) // return VR device UUIDs\r\n      )\r\n    );\r\n  }\r\n\r\n  function computeNewVrName(oldVrName) {\r\n      const original = (oldVrName || '').trim();\r\n      if (!original) { \r\n        console.debug('[VR Rename] Empty VR name; skip');\r\n        return null;\r\n      }\r\n    \r\n      // 1) Primary: precise map-based rename (oldMeasName or oldMeasName_)\r\n      if (vm.measurementRenameMap && vm.measurementRenameMap.size > 0) {\r\n        const entries = Array.from(vm.measurementRenameMap.entries())\r\n          .sort((a, b) => b[0].length - a[0].length); // longest first\r\n    \r\n        for (const [oldMeasNameRaw, newMeasNameRaw] of entries) {\r\n          const oldMeas = String(oldMeasNameRaw || '').trim();\r\n          const newMeas = String(newMeasNameRaw || '').trim();\r\n          if (!oldMeas || !newMeas) continue;\r\n    \r\n          // exact match\r\n          if (original === oldMeas) {\r\n            const renamed = newMeas;\r\n            console.debug('[VR Rename] Exact match:', { original, oldMeas, newMeas, renamed });\r\n            return renamed;\r\n          }\r\n          // prefix match \"<oldMeas>_<suffix>\"\r\n          const prefix = oldMeas + '_';\r\n          if (original.startsWith(prefix)) {\r\n            const suffix = original.substring(prefix.length);\r\n            const renamed = newMeas + '_' + suffix;\r\n            console.debug('[VR Rename] Prefix match:', { original, oldMeas, newMeas, suffix, renamed });\r\n            return renamed;\r\n          }\r\n        }\r\n      } else {\r\n        console.debug('[VR Rename] Empty measurementRenameMap; will try ECO fallback for', original);\r\n      }\r\n    \r\n      // 2) Fallback: if we can’t match the old measurement name, but there is exactly ONE new measurement name,\r\n      //    replace everything BEFORE \"_ECO_\" with that name.\r\n      //    This gives:  \"<anything>_ECO_...\" -> \"<singleNewMeas>_ECO_...\"\r\n      const newNames = vm.measurementRenameMap ? Array.from(vm.measurementRenameMap.values()).map(v => String(v || '').trim()).filter(Boolean) : [];\r\n      if (newNames.length === 1) {\r\n        const soleNew = newNames[0];\r\n        // Typical delimiter in your VR naming: \"_ECO_\"\r\n        const ecoIdx = original.indexOf('_ECO_');\r\n        if (ecoIdx > 0) {\r\n          const suffixFromEco = original.substring(ecoIdx + 1); // keep \"ECO_...\"\r\n          const renamed = soleNew + '_' + suffixFromEco;\r\n          console.debug('[VR Rename] Fallback via _ECO_:',\r\n            { original, soleNew, suffixFromEco, renamed });\r\n          return renamed;\r\n        }\r\n        // If \"_ECO_\" is not present, as a safer generic fallback: replace up to the 3rd underscore (common in \"X_Y_Z_...\")\r\n        const parts = original.split('_');\r\n        if (parts.length >= 3) {\r\n          const suffix = parts.slice(3).join('_'); // keep everything after first 3 segments\r\n          const renamed = suffix ? (soleNew + '_' + suffix) : soleNew;\r\n          console.debug('[VR Rename] Fallback via 3-seg prefix:',\r\n            { original, soleNew, suffix, renamed });\r\n          return renamed;\r\n        }\r\n      }\r\n    \r\n      console.debug('[VR Rename] No matching rule for', original);\r\n      return null; // no rename\r\n    }\r\n\r\n\r\n\r\n\r\n  function transferVrDevice(vrDeviceId, newOwner, hasProjectMeasurements) {\r\n    return deviceService.getDevice(vrDeviceId).pipe(\r\n      widgetContext.rxjs.switchMap(vr => {\r\n        const maybeNewName = computeNewVrName(vr.name);\r\n        if (maybeNewName && maybeNewName !== vr.name) vr.name = maybeNewName;\r\n        return deviceService.saveDevice(vr).pipe(\r\n          widgetContext.rxjs.switchMap(updatedVr => {\r\n            const vrEntity = updatedVr.id && updatedVr.id.entityType\r\n              ? updatedVr.id\r\n              : { id: updatedVr.id, entityType: 'DEVICE' };\r\n\r\n            return entityGroupService.changeEntityOwner(newOwner, vrEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() =>\r\n                (updatedVr.type === 'Gateway VR')\r\n                  ? getGatewaysGroup(newOwner).pipe(\r\n                      widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, vrEntity.id))\r\n                    )\r\n                  : widgetContext.rxjs.of(null)\r\n              ),\r\n              widgetContext.rxjs.switchMap(() =>\r\n                (!hasProjectMeasurements)\r\n                  ? getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                      widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, vrEntity.id))\r\n                    )\r\n                  : widgetContext.rxjs.of(null)\r\n              )\r\n            );\r\n\r\n          })\r\n        );\r\n      })\r\n    );\r\n  }\r\n\r\n  function transferVrsForPhysicalDevice(physicalDeviceId, newOwner, hasProjectMeasurements) {\r\n    return getVrDevicesForDevice(physicalDeviceId).pipe(\r\n      widgetContext.rxjs.switchMap(vrIds => {\r\n        if (!vrIds || vrIds.length === 0) return widgetContext.rxjs.of(null);\r\n        const ops = vrIds.map(vrId => transferVrDevice(vrId, newOwner, hasProjectMeasurements));\r\n        return widgetContext.rxjs.forkJoin(ops);\r\n      })\r\n    );\r\n  }\r\n\r\n  vm.save = function () {\r\n    const formValue = vm.transferKitFormGroup.value;\r\n    const selectedCustomer = formValue.customer;\r\n    if (!selectedCustomer || !selectedCustomer.id) { console.warn('No customer selected.'); return; }\r\n\r\n    if (!vm.customerShortName) vm.customerShortName = selectedCustomer.title;\r\n    const selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n    const newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n\r\n    const saveObservables = [];\r\n    const hasProjectMeasurements = vm.foundProject || (vm.projectMeasurements && vm.projectMeasurements.length > 0);\r\n    const selectedKit = formValue.kit;\r\n    if (!selectedKit.name) { console.warn(\"Selected kit has no name. Aborting save.\"); return; }\r\n    \r\n      vm.measurementRenameMap = new Map();\r\n      if (Array.isArray(vm.projectMeasurements) && vm.projectMeasurements.length > 0) {\r\n        vm.projectMeasurements.forEach((measurement, index) => {\r\n          const ctrl = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n          const newName = ctrl ? String(ctrl.value || '').trim() : '';\r\n          const oldName = String(measurement.name || '').trim();\r\n          if (oldName && newName) {\r\n            vm.measurementRenameMap.set(oldName, newName);\r\n            console.debug('[VR Rename] map:', oldName, '→', newName);\r\n          }\r\n        });\r\n      } else {\r\n        console.debug('[VR Rename] No project measurements; VR renames may be skipped.');\r\n      }\r\n\r\n\r\n    const preEnsure$ = widgetContext.rxjs.forkJoin([\r\n      getDiagnostickitsGroup(newOwner),\r\n      getDiagnostickitDevicesGroup(newOwner),\r\n      getGatewaysGroup(newOwner),\r\n      getUnassignedMeasurementDevicesGroup(newOwner),\r\n      getProjectsGroup(newOwner),\r\n      getMeasurementsGroup(newOwner)\r\n    ]).pipe(widgetContext.rxjs.catchError(() => widgetContext.rxjs.of(null)));\r\n\r\n\r\n    preEnsure$.subscribe(() => {\r\n      // KIT\r\n      let kitSave$ = assetService.saveAsset(selectedKit).pipe(\r\n        widgetContext.rxjs.switchMap(updatedKit => {\r\n          let kitEntity = updatedKit.id && updatedKit.id.entityType ? updatedKit.id : { id: updatedKit.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n            widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, kitEntity)),\r\n            widgetContext.rxjs.switchMap(() =>\r\n              getDiagnostickitsGroup(newOwner).pipe(\r\n                widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, kitEntity.id))\r\n              )\r\n            )\r\n          );\r\n        })\r\n      );\r\n      saveObservables.push(kitSave$);\r\n\r\n\r\n      if (vm.foundProject) {\r\n        let project = vm.foundProject;\r\n        let candidate = (vm.transferredProject && vm.transferredProject.trim()) || ((vm.customerShortName || selectedCustomer.title) + '_Project_1');\r\n        vm.transferredProject = candidate;\r\n        project.name = candidate;\r\n        if (!project.type || !project.type.trim()) project.type = \"Project\";\r\n\r\n        let projectSave$ = assetService.saveAsset(project).pipe(\r\n          widgetContext.rxjs.switchMap(updatedProject => {\r\n            let projectEntity = updatedProject.id && updatedProject.id.entityType ? updatedProject.id : { id: updatedProject.id, entityType: 'ASSET' };\r\n            return entityGroupService.changeEntityOwner(newOwner, projectEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, projectEntity)),\r\n              widgetContext.rxjs.switchMap(() => getProjectsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, projectEntity.id))\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(projectSave$);\r\n      }\r\n\r\n\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        let newMeasurementName = vm.transferKitFormGroup.get('transferredMeasurement' + index).value;\r\n        if (!newMeasurementName || !newMeasurementName.trim()) return;\r\n\r\n        measurement.name = newMeasurementName.trim();\r\n        let measurementSave$ = assetService.saveAsset(measurement).pipe(\r\n          widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n            let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType ? updatedMeasurement.id : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n            return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, measurementEntity)),\r\n              widgetContext.rxjs.switchMap(() => getMeasurementsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, measurementEntity.id))\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(measurementSave$);\r\n      });\r\n\r\n\r\n      vm.allDevices.forEach((device, index) => {\r\n        let newDeviceName = vm.transferKitFormGroup.get('transferredDevice' + index).value;\r\n        if (!newDeviceName || !newDeviceName.trim()) return;\r\n        device.name = newDeviceName.trim();\r\n\r\n        let deviceSave$ = deviceService.saveDevice(device).pipe(\r\n          widgetContext.rxjs.switchMap(updatedDevice => {\r\n            const deviceEntity = updatedDevice.id && updatedDevice.id.entityType ? updatedDevice.id : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n            return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() =>\r\n                getDiagnostickitDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                )\r\n              ),\r\n              widgetContext.rxjs.switchMap(() => {\r\n                if (updatedDevice.type === 'RESI' || updatedDevice.type === 'Gateway') {\r\n                  return getGatewaysGroup(newOwner).pipe(\r\n                    widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                  );\r\n                }\r\n                return widgetContext.rxjs.of(null);\r\n              }),\r\n              widgetContext.rxjs.switchMap(() => {\r\n                if (!hasProjectMeasurements) {\r\n                  return getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                    widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                  );\r\n                }\r\n                return widgetContext.rxjs.of(null);\r\n              }),\r\n\r\n              widgetContext.rxjs.switchMap(() =>\r\n                transferVrsForPhysicalDevice(deviceEntity.id, newOwner, hasProjectMeasurements)\r\n              )\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(deviceSave$);\r\n      });\r\n\r\n      widgetContext.rxjs.forkJoin(saveObservables).subscribe(\r\n        () => { widgetContext.updateAliases(); vm.dialogRef.close(formValue); },\r\n        err => { console.error('Error updating assets:', err); }\r\n      );\r\n    });\r\n  };\r\n\r\n  vm.cancel = function () { vm.dialogRef.close(null); };\r\n}\r\n\r\n\r\n\r\n/*let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet dialogs = injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\nlet customerId, customer;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet pageLink = {\r\n  pageSize: 100,\r\n  page: 0,\r\n  textSearch: '',\r\n  sortOrder: 'ASC',\r\n  sortProperty: 'title',\r\n  toQuery: function () {\r\n    let query = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) { query += '&textSearch=' + encodeURIComponent(this.textSearch); }\r\n    if (this.sortProperty) { query += '&sortProperty=' + encodeURIComponent(this.sortProperty); }\r\n    if (this.sortOrder) { query += '&sortOrder=' + encodeURIComponent(this.sortOrder); }\r\n    return query;\r\n  }\r\n};\r\n\r\nlet kits = [];\r\nlet customers = [];\r\nlet kitsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (kitsLoaded && customersLoaded) {\r\n    openTransferKitDialog(kits, customers);\r\n  }\r\n}\r\n\r\nlet kitSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id,\r\n    rootType: 'CUSTOMER',\r\n    direction: 'FROM',\r\n    relationTypeGroup: 'COMMON',\r\n    maxLevel: 10,\r\n    fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Diagnostickit']\r\n};\r\n\r\nassetService.findByQuery(kitSearchQuery).subscribe(\r\n  result => { kits = result; kitsLoaded = true; checkAndOpenDialog(); },\r\n  () => { kits = []; kitsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\nlet bearerToken = '';\r\nfetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n  method: 'POST',\r\n  headers: {\r\n    'Content-Type': 'application/json'\r\n  },\r\n  body: JSON.stringify({\r\n    \"username\": \"belimo.api@pke-iot.expert\",\r\n    \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n  })\r\n})\r\n  .then(resp => resp.json())\r\n  .then(loginData => {\r\n    bearerToken = loginData.token;\r\n    return fetch('https://cloud.pke-iot.expert/api/customers?pageSize=100&page=0', {\r\n      method: 'GET',\r\n      headers: {\r\n        'accept': 'application/json',\r\n        'X-Authorization': 'Bearer ' + bearerToken\r\n      }\r\n    });\r\n  })\r\n  .then(resp2 => resp2.json())\r\n  .then(customersList => {\r\n    // Process the customers data here.\r\n    customers = customersList.data;\r\n    if (customer) { customers = customers.filter(cust => cust.title !== customer); }\r\n    customersLoaded = true;\r\n    checkAndOpenDialog();\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching customers:\", error);\r\n    alert('Failed to fetch customers.');\r\n  });\r\n\r\n\r\nfunction openTransferKitDialog(kits, customers) {\r\n  customDialog.customDialog(htmlTemplate, TransferKitDialogController, {\r\n    kits: kits,\r\n    customers: customers\r\n  }).subscribe();\r\n}\r\n\r\nfunction TransferKitDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.kits = data.kits || [];\r\n  vm.customers = data.customers || [];\r\n\r\n  vm.transferKitFormGroup = vm.fb.group({\r\n    kit: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n  vm.transferKitFormGroup.addControl('transferredProject', vm.fb.control({ value: '', disabled: true }));\r\n\r\n  vm.allDevices = [];\r\n  vm.devicesWithMeasurements = [];\r\n  vm.foundProject = null;\r\n  vm.projectMeasurements = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n\r\n  vm.transferKitFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId,\r\n          rootType: 'CUSTOMER',\r\n          direction: 'FROM',\r\n          relationTypeGroup: 'COMMON',\r\n          maxLevel: 10,\r\n          fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { \r\n          vm.transferredProject = null; \r\n          vm.customerShortName = null; \r\n        }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null;\r\n      vm.customerShortName = null;\r\n      // Clear out the transferred measurements when no customer is selected.\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        if (vm.transferKitFormGroup.get('transferredMeasurement' + index)) {\r\n          vm.transferKitFormGroup.get('transferredMeasurement' + index).setValue('');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  vm.onKitSelected = function (event) {\r\n    let selectedKit = event.value;\r\n    vm.allDevices = [];\r\n    vm.devicesWithMeasurements = [];\r\n    vm.foundProject = null;\r\n    vm.projectMeasurements = [];\r\n\r\n    // Remove previous measurement and device controls.\r\n    Object.keys(vm.transferKitFormGroup.controls)\r\n      .filter(controlName => controlName.startsWith('measurement') ||\r\n                             controlName.startsWith('transferredMeasurement') ||\r\n                             controlName.startsWith('device') ||\r\n                             controlName.startsWith('transferredDevice'))\r\n      .forEach(controlName => {\r\n        vm.transferKitFormGroup.removeControl(controlName);\r\n      });\r\n    \r\n    let selectedCustomer = vm.transferKitFormGroup.get('customer').value;\r\n    if (!selectedKit || !selectedCustomer) {\r\n      console.warn(\"Kit or customer not selected yet.\");\r\n      return;\r\n    }\r\n    \r\n    let selectedKitId = selectedKit.id.id ? selectedKit.id.id : selectedKit.id;\r\n\r\n    let deviceSearchQuery = {\r\n      parameters: {\r\n        rootId: selectedKitId,\r\n        rootType: 'ASSET',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: true\r\n      },\r\n      relationType: 'Contains',\r\n      deviceTypes: [\r\n          'P-Flow D116',\r\n          'Room Sensor CO2',\r\n          'Temperature Sensor',\r\n          'RESI',\r\n          'Gateway',\r\n          'LTE Status'\r\n      ]\r\n    };\r\n    \r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n      devices => {\r\n        vm.allDevices = devices || [];\r\n        \r\n        if (vm.allDevices.length === 0) {\r\n          console.warn(\"No devices found in selected kit.\");\r\n          return;\r\n        }\r\n        // For each device, add two controls: one showing the original device name, and one for transferred device,\r\n        // which is automatically set to the same name as the found device.\r\n        vm.allDevices.forEach((device, index) => {\r\n          vm.transferKitFormGroup.addControl(\r\n            'device' + index,\r\n            vm.fb.control({ value: device.name, disabled: true })\r\n          );\r\n          vm.transferKitFormGroup.addControl(\r\n            'transferredDevice' + index,\r\n            vm.fb.control({ value: device.name, disabled: true })\r\n          );\r\n        });\r\n\r\n        let measurementChecks = vm.allDevices.map(device => {\r\n          let measurementQuery = {\r\n            parameters: {\r\n              rootId: (device.id.id ? device.id.id : device.id),\r\n              rootType: 'DEVICE',\r\n              direction: 'TO',\r\n              relationTypeGroup: 'COMMON',\r\n              maxLevel: 1073741824,\r\n              fetchLastLevelOnly: false\r\n            },\r\n            relationType: 'Measurement',\r\n            assetTypes: ['Measurement']\r\n          };\r\n          return assetService.findByQuery(measurementQuery).pipe(\r\n            widgetContext.rxjs.map(measurements => {\r\n              return { device: device, measurements: measurements || [] };\r\n            })\r\n          );\r\n        });\r\n        widgetContext.rxjs.forkJoin(measurementChecks).subscribe(\r\n          measurementResults => {\r\n            vm.devicesWithMeasurements = measurementResults.filter(r => r.measurements.length > 0);\r\n            let projectChecks = [];\r\n            vm.devicesWithMeasurements.forEach(item => {\r\n              item.measurements.forEach(meas => {\r\n                let projectQuery = {\r\n                  parameters: {\r\n                    rootId: (meas.id.id ? meas.id.id : meas.id),\r\n                    rootType: 'ASSET',\r\n                    direction: 'TO',\r\n                    relationTypeGroup: 'COMMON',\r\n                    maxLevel: 10,\r\n                    fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: 'Owns',\r\n                  assetTypes: ['Project']\r\n                };\r\n                projectChecks.push(\r\n                  assetService.findByQuery(projectQuery).pipe(\r\n                    widgetContext.rxjs.map(projects => {\r\n                      return { measurement: meas, projects: projects || [] };\r\n                    })\r\n                  )\r\n                );\r\n              });\r\n            });\r\n            if (projectChecks.length === 0) {\r\n              return;\r\n            }\r\n            widgetContext.rxjs.forkJoin(projectChecks).subscribe(\r\n              projectResults => {\r\n                let found = projectResults.find(r => r.projects.length > 0);\r\n                if (found) {\r\n                  vm.foundProject = found.projects[0];\r\n                  if (!vm.transferKitFormGroup.get('foundProject')) {\r\n                    vm.transferKitFormGroup.addControl(\r\n                      'foundProject',\r\n                      vm.fb.control({ value: vm.foundProject.name, disabled: true })\r\n                    );\r\n                  } else {\r\n                    vm.transferKitFormGroup.get('foundProject').setValue(vm.foundProject.name);\r\n                  }\r\n                  searchMeasurementsForProject(vm.foundProject);\r\n                }\r\n              },\r\n              err => {\r\n                console.error(\"Error during project queries:\", err);\r\n              }\r\n            );\r\n          },\r\n          err => {\r\n            console.error(\"Error in measurement checks:\", err);\r\n          }\r\n        );\r\n      },\r\n      err => {\r\n        console.error(\"Error finding devices for kit:\", err);\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.onCustomerSelected = function (event) {\r\n    let kit = vm.transferKitFormGroup.get('kit').value;\r\n    if (kit) {\r\n      vm.onKitSelected({ value: kit });\r\n    }\r\n  };\r\n\r\n  function updateFoundProjectName(customerShortName, existingProjects) {\r\n    if (!customerShortName) {\r\n      console.warn(\"Customer short name is not defined.\");\r\n      return;\r\n    }\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) {\r\n          maxNumericSuffix = parsedNum;\r\n        }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    vm.transferredProject = candidate;\r\n    vm.transferKitFormGroup.get('transferredProject').setValue(candidate);\r\n    // Device names remain as set.\r\n  }\r\n\r\n  function renameProjectMeasurements() {\r\n    if (!vm.customerShortName) {\r\n      console.warn(\"Customer short name not set. Skipping measurement rename.\");\r\n      return;\r\n    }\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n    let newProjectName = vm.transferKitFormGroup.get('transferredProject');\r\n      let oldName = measurement.name;\r\n      let parts = oldName.split('_');\r\n      let newName = newProjectName.value + '_' + parts[2];\r\n      let control = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n      if (control) {\r\n        control.setValue(newName);\r\n      }\r\n    });\r\n  }\r\n\r\n  function searchMeasurementsForProject(project) {\r\n    let projectId = project.id.id ? project.id.id : project.id;\r\n    let projectMeasurementQuery = {\r\n      parameters: {\r\n        rootId: projectId,\r\n        rootType: 'ASSET',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Measurement']\r\n    };\r\n    assetService.findByQuery(projectMeasurementQuery).subscribe(\r\n      measurements => {\r\n        vm.projectMeasurements = measurements || [];\r\n\r\n        // Remove old measurement controls.\r\n        Object.keys(vm.transferKitFormGroup.controls)\r\n          .filter(controlName => controlName.startsWith('measurement') ||\r\n                                 controlName.startsWith('transferredMeasurement'))\r\n          .forEach(controlName => {\r\n            vm.transferKitFormGroup.removeControl(controlName);\r\n          });\r\n\r\n        (measurements || []).forEach((measurement, index) => {\r\n          vm.transferKitFormGroup.addControl(\r\n            'measurement' + index,\r\n            vm.fb.control({ value: measurement.name, disabled: true })\r\n          );\r\n          // Create transferred measurement control as disabled.\r\n          vm.transferKitFormGroup.addControl(\r\n            'transferredMeasurement' + index,\r\n            vm.fb.control({ value: '', disabled: true })\r\n          );\r\n        });\r\n\r\n        renameProjectMeasurements();\r\n      },\r\n      err => {\r\n        console.error(\"Error finding measurements for project:\", err);\r\n      }\r\n    );\r\n  }\r\n\r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      })\r\n    );\r\n  }\r\n  \r\n  // --- Group helper functions ---\r\n    function getProjectsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let projectsGroup = groups.find(g => g.name === 'Projects');\r\n          if (projectsGroup) {\r\n            return widgetContext.rxjs.of(projectsGroup);\r\n          } else {\r\n            projectsGroup = { type: 'ASSET', name: 'Projects', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(projectsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getMeasurementsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let measurementsGroup = groups.find(g => g.name === 'Measurements');\r\n          if (measurementsGroup) {\r\n            return widgetContext.rxjs.of(measurementsGroup);\r\n          } else {\r\n            measurementsGroup = { type: 'ASSET', name: 'Measurements', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(measurementsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getDiagnostickitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let kitsGroup = groups.find(g => g.name === 'Diagnostickits');\r\n          if (kitsGroup) {\r\n            return widgetContext.rxjs.of(kitsGroup);\r\n          } else {\r\n            kitsGroup = { type: 'ASSET', name: 'Diagnostickits', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(kitsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    // Modified getGatewaysGroup: Removed the type check\r\n    function getGatewaysGroup(customerId, updatedDevice) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let devicesGroup = groups.find(g => g.name === 'Gateways');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = { type: 'DEVICE', name: 'Gateways', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n    \r\n    function getDiagnostickitDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let devicesGroup = groups.find(g => g.name === 'Diagnostickit Devices');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = { type: 'DEVICE', name: 'Diagnostickit Devices', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    \r\n    function getUnassignedMeasurementDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let unassignedGroup = groups.find(g => g.name === 'Unassigned Measurement Devices');\r\n          if (unassignedGroup) {\r\n            return widgetContext.rxjs.of(unassignedGroup);\r\n          } else {\r\n            unassignedGroup = { type: 'DEVICE', name: 'Unassigned Measurement Devices', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(unassignedGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n  vm.save = function () {\r\n    let formValue = vm.transferKitFormGroup.value;\r\n    let selectedCustomer = formValue.customer;\r\n    if (!selectedCustomer || !selectedCustomer.id) {\r\n      console.warn('No customer selected.');\r\n      return;\r\n    }\r\n\r\n    if (!vm.customerShortName) {\r\n      vm.customerShortName = selectedCustomer.title;\r\n    }\r\n    let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n    let newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n\r\n    let saveObservables = [];\r\n    \r\n    let hasProjectMeasurements = vm.foundProject || (vm.projectMeasurements && vm.projectMeasurements.length > 0);\r\n    \r\n    let selectedKit = formValue.kit;\r\n    if (!selectedKit.name) {\r\n      console.warn(\"Selected kit has no name. Aborting save.\");\r\n      return;\r\n    }\r\n    let kitSave$ = assetService.saveAsset(selectedKit).pipe(\r\n      widgetContext.rxjs.switchMap(updatedKit => {\r\n        let kitEntity = updatedKit.id && updatedKit.id.entityType \r\n                          ? updatedKit.id \r\n                          : { id: updatedKit.id, entityType: 'ASSET' };\r\n        return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n            widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, kitEntity)),\r\n            // Always assign to Diagnostickits group\r\n            widgetContext.rxjs.switchMap(() => \r\n              getDiagnostickitsGroup(newOwner).pipe(\r\n                widgetContext.rxjs.switchMap(group => \r\n                  entityGroupService.addEntitiesToEntityGroup(group.id.id, [kitEntity.id])\r\n                )\r\n              )\r\n            ),\r\n            // If no project/measurements, also add to Unassigned Kit Group\r\n         );\r\n      })\r\n    );\r\n    saveObservables.push(kitSave$);\r\n\r\n    if (vm.foundProject) {\r\n      let project = vm.foundProject;\r\n      let candidate = vm.transferredProject && vm.transferredProject.trim();\r\n      if (!candidate) {\r\n        console.warn(\"Transferred project name was empty.\");\r\n        candidate = (vm.customerShortName || selectedCustomer.title) + '_Project_1';\r\n        formValue.transferredProject = candidate;\r\n        console.warn(\"Using fallback: \" + candidate);\r\n      }\r\n      project.name = candidate;\r\n      if (!project.type || project.type.trim() === \"\") {\r\n        project.type = \"Project\";\r\n      }\r\n      let projectSave$ = assetService.saveAsset(project).pipe(\r\n        widgetContext.rxjs.switchMap(updatedProject => {\r\n          let projectEntity = updatedProject.id && updatedProject.id.entityType \r\n                              ? updatedProject.id \r\n                              : { id: updatedProject.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, projectEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, projectEntity)),\r\n              widgetContext.rxjs.switchMap(() => getProjectsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(projectsGroup =>\r\n                entityGroupService.addEntitiesToEntityGroup(projectsGroup.id.id, [projectEntity.id])\r\n              )\r\n            );\r\n        })\r\n      );\r\n      saveObservables.push(projectSave$);\r\n    }\r\n\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n      let newMeasurementName = vm.transferKitFormGroup.get('transferredMeasurement' + index).value;\r\n      if (!newMeasurementName || newMeasurementName.trim() === \"\") {\r\n        console.warn(`New name for measurement at index ${index} is empty. Skipping update.`);\r\n        return;\r\n      }\r\n      measurement.name = newMeasurementName.trim();\r\n      let measurementSave$ = assetService.saveAsset(measurement).pipe(\r\n        widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n          let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType \r\n                                  ? updatedMeasurement.id \r\n                                  : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, measurementEntity)),\r\n              widgetContext.rxjs.switchMap(() => getMeasurementsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(measurementsGroup =>\r\n                entityGroupService.addEntitiesToEntityGroup(measurementsGroup.id.id, [measurementEntity.id])\r\n              )\r\n            );\r\n        })\r\n      );\r\n      saveObservables.push(measurementSave$);\r\n    });\r\n\r\n    // For each device, update its name with the value from the transferred device control.\r\n    // In the vm.save function, within the device update chain:\r\n    vm.allDevices.forEach((device, index) => {\r\n      let newDeviceName = vm.transferKitFormGroup.get('transferredDevice' + index).value;\r\n      if (!newDeviceName || newDeviceName.trim() === \"\") {\r\n        console.warn(`New name for device at index ${index} is empty. Skipping update.`);\r\n        return;\r\n      }\r\n      device.name = newDeviceName.trim();\r\n      let deviceSave$ = deviceService.saveDevice(device).pipe(\r\n        widgetContext.rxjs.switchMap(updatedDevice => {\r\n          let deviceEntity = updatedDevice.id && updatedDevice.id.entityType \r\n                             ? updatedDevice.id \r\n                             : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n          return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n            // Always assign to Diagnostickit Devices group\r\n            widgetContext.rxjs.switchMap(() => {\r\n              return getDiagnostickitDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(devicesGroup =>\r\n                    entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n            }\r\n            ),\r\n            // Conditionally assign to Gateways group if updatedDevice.type is 'RESI' or 'Gateway'\r\n            widgetContext.rxjs.switchMap(() => {\r\n              if (updatedDevice.type === 'RESI' || updatedDevice.type === 'Gateway') {\r\n                return getGatewaysGroup(newOwner, updatedDevice).pipe(\r\n                  widgetContext.rxjs.switchMap(devicesGroup =>\r\n                    entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n              } else {\r\n                return widgetContext.rxjs.of(null);\r\n              }\r\n            }),\r\n            // Additionally, if no project/measurements exist, assign to Unassigned Measurement Devices\r\n            widgetContext.rxjs.switchMap(() => {\r\n              if (!hasProjectMeasurements) {\r\n                return getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(group =>\r\n                    entityGroupService.addEntitiesToEntityGroup(group.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n              } else {\r\n                return widgetContext.rxjs.of(null);\r\n              }\r\n            })\r\n          );\r\n        })\r\n      );\r\n      saveObservables.push(deviceSave$);\r\n    });\r\n\r\n\r\n    widgetContext.rxjs.forkJoin(saveObservables).subscribe(\r\n      () => {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(formValue);\r\n      },\r\n      err => {\r\n        console.error('Error updating assets:', err);\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n}\r\n*/",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "20030896-36ba-fa5d-814d-09bac156d398"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "d6393653-ccec-edf8-4bd7-520334011adb",
        "typeFullFqn": "system.cards.entities_table"
      }
    },
    "states": {
      "default": {
        "name": "Smart Diagnostic Administration",
        "root": true,
        "layouts": {
          "main": {
            "widgets": {
              "c2559a58-e82d-3250-7e35-f520ced0d916": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "gateways": {
        "name": "Gateways",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "0c7469aa-7b86-be27-5216-bc6cc702f8b1": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "doktorkit_table": {
        "name": "Diagnostic Kits table",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "3c990db9-ab04-d3a5-ae24-bc58de2fbc94": {
                "sizeX": 29,
                "sizeY": 14,
                "desktopHide": false,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "doktorkits_card_all": {
        "name": "Diagnostic Kits card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "d2cec1c0-f9bb-1c7c-25ae-ea8853bc3b7e": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "doktorkits_card_all_customer": {
        "name": "Diagnostic Kits card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "af8bd4a6-39c7-d8a5-2894-64840ac87fdd": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "user": {
        "name": "User",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "c12ec825-a7ef-cc4d-da3d-064fba7cc7d7": {
                "sizeX": 33,
                "sizeY": 48,
                "row": 3,
                "col": 0
              },
              "b687c65c-76de-dd49-b3b9-51eacf22114c": {
                "sizeX": 33,
                "sizeY": 48,
                "row": 3,
                "col": 66
              },
              "8a5a3b08-5990-7d43-feca-892f176bff4c": {
                "sizeX": 33,
                "sizeY": 48,
                "row": 3,
                "col": 33
              },
              "4f27f5c7-75b2-c14a-821f-ae5786bf1323": {
                "sizeX": 99,
                "sizeY": 3,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#eeeeee",
              "columns": 100,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "eco_administration": {
        "name": "ECO Administration",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "777ded27-e3b8-d901-ca42-3079a23f7a12": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "customer_administration": {
        "name": "Customer Administration",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "2131ced7-032b-7d7f-1c04-917bd7a89699": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": false,
              "layoutType": "default",
              "minColumns": 24,
              "viewFormat": "grid",
              "rowHeight": 70
            }
          }
        }
      },
      "manage_users": {
        "name": "manage_users",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "66d379dd-2e7b-4977-7e01-d183cac74835": {
                "sizeX": 33,
                "sizeY": 48,
                "row": 3,
                "col": 0
              },
              "244b2e44-0ee2-0751-5a29-0d9eaebe24ab": {
                "sizeX": 33,
                "sizeY": 48,
                "row": 3,
                "col": 66
              },
              "4b84e1ab-9b9c-6173-ae5b-51a78fafe48c": {
                "sizeX": 33,
                "sizeY": 48,
                "row": 3,
                "col": 33
              },
              "2433d7c8-6c4d-26d5-f123-adb09148fbec": {
                "sizeX": 99,
                "sizeY": 3,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#eeeeee",
              "columns": 100,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "manage_projects": {
        "name": "manage_projects",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "f5be3f90-8574-86fb-1e71-7381ecb6956d": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default",
              "minColumns": 24,
              "viewFormat": "grid",
              "rowHeight": 70
            }
          }
        }
      },
      "manage_diagnostickits": {
        "name": "manage_diagnostickits",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "c6b19443-5057-176b-d3f8-2eebb67fc35e": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "selected_project_header": {
        "name": "selected_project_header",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "65f06cd0-359d-d0bf-f7aa-8f4700ea7d44": {
                "sizeX": 24,
                "sizeY": 7,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "selected_project_map": {
        "name": "selected_project_map",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "03ceaaed-0eb5-4d4e-a3ef-0c4394cb2cb8": {
                "sizeX": 24,
                "sizeY": 14,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "project_measurements": {
        "name": "project_measurements",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "4ebd4327-6b2e-432c-9f12-5d87a6ca7e76": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "projects_map": {
        "name": "projects_map",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "40680065-1e6b-c6f8-af6a-23e82a99fad9": {
                "sizeX": 24,
                "sizeY": 14,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "projects_all": {
        "name": "projects_all",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "fb924e54-6e4b-2d41-5545-dab85e028210": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "manage_diagnostickits_admin": {
        "name": "manage_diagnostickits_admin",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "d6393653-ccec-edf8-4bd7-520334011adb": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": false,
              "layoutType": "default",
              "minColumns": 24,
              "viewFormat": "grid",
              "rowHeight": 70
            }
          }
        }
      },
      "manage_diagnostickits_customer": {
        "name": "manage_diagnostickits_customer",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "ed6cf40c-1c37-2fe9-4436-22c669817f3e": {
                "sizeX": 25,
                "sizeY": 12,
                "row": 0,
                "col": 0
              },
              "4cc2a279-fbae-dce8-0827-5a24057fe53e": {
                "sizeX": 25,
                "sizeY": 13,
                "row": 12,
                "col": 0,
                "mobileHide": true,
                "desktopHide": true
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      }
    },
    "entityAliases": {
      "1c348dad-e738-a4db-5e7e-4c0271790ab7": {
        "id": "1c348dad-e738-a4db-5e7e-4c0271790ab7",
        "alias": "Doktorkits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Doktorkit"
          ]
        }
      },
      "d13f6078-0d81-ec59-529c-64acbbcaf470": {
        "id": "d13f6078-0d81-ec59-529c-64acbbcaf470",
        "alias": "Doktorkit Devices",
        "filter": {
          "type": "deviceSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedDoktorkit",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "deviceTypes": [
            "P-Flow D116",
            "Room Sensor CO2",
            "Room Sensor T",
            "Temperature Sensor",
            "Gateway",
            "RESI",
            "LTE Status"
          ]
        }
      },
      "04917190-aea7-e407-e308-4598f1671a71": {
        "id": "04917190-aea7-e407-e308-4598f1671a71",
        "alias": "Retrofit Partner",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": false,
          "stateEntityParamName": "selectedCustomer",
          "groupType": "CUSTOMER",
          "entityGroupNameFilter": "Belimo Retrofit"
        }
      },
      "7add11d8-cbf7-fd15-6b12-d5df058f11fa": {
        "id": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
        "alias": "Selected Doktorkit",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedDoktorkit",
          "defaultStateEntity": null
        }
      },
      "984b0bbe-9a03-40ac-90f0-31db7e70dc8c": {
        "id": "984b0bbe-9a03-40ac-90f0-31db7e70dc8c",
        "alias": "Customer Doktorkit Devices",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Doktorkit Devices"
        }
      },
      "60f60877-be45-311d-9ee7-25b68c466d89": {
        "id": "60f60877-be45-311d-9ee7-25b68c466d89",
        "alias": "Customer Doktorkit Gateways",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Gateways"
        }
      },
      "fe796be3-ffda-37f5-f182-7fb7fcd53f31": {
        "id": "fe796be3-ffda-37f5-f182-7fb7fcd53f31",
        "alias": "Selected device",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedDevice",
          "defaultStateEntity": null
        }
      },
      "21d657b1-d301-fa72-ed75-6e2000eb5e51": {
        "id": "21d657b1-d301-fa72-ed75-6e2000eb5e51",
        "alias": "Retrofit Partner All",
        "filter": {
          "type": "entityType",
          "resolveMultiple": true,
          "entityType": "CUSTOMER"
        }
      },
      "df6ecbc0-0dae-bc9b-fbeb-96b5c11f9ebc": {
        "id": "df6ecbc0-0dae-bc9b-fbeb-96b5c11f9ebc",
        "alias": "{i18n:custom.diagnostics.projects.title}",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Project"
          ]
        }
      },
      "f765d469-eafe-c53b-d010-c75a39278cad": {
        "id": "f765d469-eafe-c53b-d010-c75a39278cad",
        "alias": "Measurements",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedProject",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Measurement"
          ]
        }
      },
      "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4": {
        "id": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
        "alias": "Selected Measurement",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null
        }
      },
      "faef915b-be60-5c6b-d62c-114957e80421": {
        "id": "faef915b-be60-5c6b-d62c-114957e80421",
        "alias": "Selected Project",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedProject",
          "defaultStateEntity": null
        }
      },
      "ab402d1e-d547-fc07-708c-2b7bb8306205": {
        "id": "ab402d1e-d547-fc07-708c-2b7bb8306205",
        "alias": "Selected Sensorkit",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedSensorkit",
          "defaultStateEntity": null
        }
      },
      "c81ac24b-34f8-946b-bf95-1609f607c82b": {
        "id": "c81ac24b-34f8-946b-bf95-1609f607c82b",
        "alias": "Sensorkits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Sensorkit"
          ]
        }
      },
      "f3353dc6-c514-fb37-dc74-73bbeb9d1921": {
        "id": "f3353dc6-c514-fb37-dc74-73bbeb9d1921",
        "alias": "Sensorkit Devices",
        "filter": {
          "type": "deviceSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedSensorkit",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "deviceTypes": [
            "Room Sensor CO2",
            "Room Sensor T"
          ]
        }
      },
      "950424d2-bccd-42c2-76a9-603429eed3f1": {
        "id": "950424d2-bccd-42c2-76a9-603429eed3f1",
        "alias": "Customer Sensorkit Devices",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Sensorkit Devices"
        }
      },
      "8c78ecdd-7a95-af08-137b-3cf7bc54edb4": {
        "id": "8c78ecdd-7a95-af08-137b-3cf7bc54edb4",
        "alias": "Customer Sensorkit Gateways",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": false,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Gateways"
        }
      },
      "62e540a9-69d4-98ce-afbc-1c3f7bc147a5": {
        "id": "62e540a9-69d4-98ce-afbc-1c3f7bc147a5",
        "alias": "Devices",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Diagnostickit Devices"
        }
      },
      "1a8c3475-c3d9-20d2-32e4-fa4dfc96c9a2": {
        "id": "1a8c3475-c3d9-20d2-32e4-fa4dfc96c9a2",
        "alias": "Measurement Doktorkit",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "assetTypes": [
            "Doktorkit"
          ]
        }
      },
      "95a1ca8c-a5d5-e4fd-98e0-d85640112887": {
        "id": "95a1ca8c-a5d5-e4fd-98e0-d85640112887",
        "alias": "Measurement Sensorkit",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "assetTypes": [
            "Sensorkit"
          ]
        }
      },
      "7a3ac371-a996-ee2e-8652-6fab5a79027c": {
        "id": "7a3ac371-a996-ee2e-8652-6fab5a79027c",
        "alias": "All Measurements",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Measurement"
          ]
        }
      },
      "2519c941-a1b9-45bd-9821-88acf22e10af": {
        "id": "2519c941-a1b9-45bd-9821-88acf22e10af",
        "alias": "All Diagnostic Kits",
        "filter": {
          "type": "assetType",
          "resolveMultiple": true,
          "assetTypes": [
            "Diagnostickit"
          ],
          "assetNameFilter": ""
        }
      },
      "88a32db8-5dd9-f8b4-28b9-5e18c7c86c68": {
        "id": "88a32db8-5dd9-f8b4-28b9-5e18c7c86c68",
        "alias": "All Sensorkits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Sensorkit"
          ]
        }
      },
      "80b77cd9-f10d-6774-e609-cdfced593359": {
        "id": "80b77cd9-f10d-6774-e609-cdfced593359",
        "alias": "Selected Kit",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedKit",
          "defaultStateEntity": null
        }
      },
      "89a624d9-5882-ac3f-5001-e709d73e75f1": {
        "id": "89a624d9-5882-ac3f-5001-e709d73e75f1",
        "alias": "All Kits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Sensorkit",
            "Doktorkit"
          ]
        }
      },
      "186b00f3-5c8d-7cab-7654-f96a15d58d64": {
        "id": "186b00f3-5c8d-7cab-7654-f96a15d58d64",
        "alias": "Devices All",
        "filter": {
          "type": "deviceSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedCustomer",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "deviceTypes": [
            "Gateway",
            "IoT Gateway",
            "IoT Gateway Device",
            "MUC",
            "P-Flow D116",
            "Room Sensor CO2",
            "Room Sensor T",
            "Temperature Sensor"
          ]
        }
      },
      "e76453a1-85ff-af7f-4d86-60a8dd65f0a3": {
        "id": "e76453a1-85ff-af7f-4d86-60a8dd65f0a3",
        "alias": "Customer",
        "filter": {
          "type": "entityGroup",
          "resolveMultiple": true,
          "groupStateEntity": false,
          "stateEntityParamName": null,
          "defaultStateGroupType": null,
          "defaultStateEntityGroup": null,
          "groupType": "CUSTOMER",
          "entityGroup": "0a9a8ea0-bfae-11ee-80de-5de32813ef75"
        }
      },
      "09a7d069-f810-fea9-8e3d-4309f4a424ae": {
        "id": "09a7d069-f810-fea9-8e3d-4309f4a424ae",
        "alias": "Current Customer",
        "filter": {
          "type": "stateEntityOwner",
          "resolveMultiple": false,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_CUSTOMER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          }
        }
      },
      "11f99ccd-3fff-0e24-7f43-355d961fffcb": {
        "id": "11f99ccd-3fff-0e24-7f43-355d961fffcb",
        "alias": "Measurement Devices",
        "filter": {
          "type": "deviceSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Measurement",
          "deviceTypes": [
            "P-Flow D116",
            "Temperature Sensor",
            "Room Sensor T",
            "Room Sensor CO2",
            "LoRaWAN Gateway",
            "RESI",
            "LTE Status"
          ]
        }
      },
      "fbfce281-668f-0ad0-d8f4-6870d3ef679f": {
        "id": "fbfce281-668f-0ad0-d8f4-6870d3ef679f",
        "alias": "Belimo Retrofit Users",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "USER",
          "entityGroupNameFilter": "Belimo Retrofit Users"
        }
      },
      "1cab31a1-6ad5-e39d-7798-e0dfee1cd61c": {
        "id": "1cab31a1-6ad5-e39d-7798-e0dfee1cd61c",
        "alias": "Belimo Retrofit Administrators",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "USER",
          "entityGroupNameFilter": "Belimo Retrofit Administrators"
        }
      },
      "4128d7f0-9e28-5c7d-cf9a-b43cfe893568": {
        "id": "4128d7f0-9e28-5c7d-cf9a-b43cfe893568",
        "alias": "Belimo Retrofit Engineer",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "USER",
          "entityGroupNameFilter": "Belimo Retrofit Engineer"
        }
      },
      "9c45e942-79a2-d41b-37dd-9e0d461a6c7c": {
        "id": "9c45e942-79a2-d41b-37dd-9e0d461a6c7c",
        "alias": "Location Areas",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedLocation",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": null,
          "assetTypes": [
            "Area"
          ]
        }
      },
      "1ba8ad72-6096-f5aa-d8ef-7d58e375fab2": {
        "id": "1ba8ad72-6096-f5aa-d8ef-7d58e375fab2",
        "alias": "Selected Location",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedLocation",
          "defaultStateEntity": null
        }
      },
      "203b0867-b867-ef98-1791-03046c133b7d": {
        "id": "203b0867-b867-ef98-1791-03046c133b7d",
        "alias": "Current User",
        "filter": {
          "type": "singleEntity",
          "resolveMultiple": false,
          "singleEntity": {
            "entityType": "CURRENT_USER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          }
        }
      },
      "d75c5b86-8b39-59e2-59f3-ae1c1ee40910": {
        "id": "d75c5b86-8b39-59e2-59f3-ae1c1ee40910",
        "alias": "Project",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Project"
          ]
        }
      },
      "c849d52c-a3c7-5008-a4c0-c2d0406fe515": {
        "id": "c849d52c-a3c7-5008-a4c0-c2d0406fe515",
        "alias": "Project Measurements",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedProject",
          "defaultStateEntity": null,
          "rootEntity": {
            "entityType": "CURRENT_CUSTOMER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Measurement"
          ]
        }
      },
      "a11b6c4c-e7f7-210b-79a7-2b5de01a5f87": {
        "id": "a11b6c4c-e7f7-210b-79a7-2b5de01a5f87",
        "alias": "All Users",
        "filter": {
          "type": "entityType",
          "resolveMultiple": true,
          "entityType": "USER"
        }
      },
      "b9cbe0a5-7efe-a173-4f8f-81c7c69ed24c": {
        "id": "b9cbe0a5-7efe-a173-4f8f-81c7c69ed24c",
        "alias": "All Projects",
        "filter": {
          "type": "assetType",
          "resolveMultiple": true,
          "assetTypes": [
            "Project"
          ],
          "assetNameFilter": ""
        }
      },
      "5756b066-5420-ac35-5dfd-ddb1eb93d63e": {
        "id": "5756b066-5420-ac35-5dfd-ddb1eb93d63e",
        "alias": "Current owner",
        "filter": {
          "type": "singleEntity",
          "resolveMultiple": false,
          "singleEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          }
        }
      },
      "4439d614-62ea-e55e-6214-25cffa4a7358": {
        "id": "4439d614-62ea-e55e-6214-25cffa4a7358",
        "alias": "Customer Projects",
        "filter": {
          "type": "relationsQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "filters": [
            {
              "relationType": "Owns",
              "entityTypes": [
                "ASSET"
              ],
              "negate": false
            }
          ]
        }
      },
      "0d59106c-3aec-67d1-e5c6-1bea2904541b": {
        "id": "0d59106c-3aec-67d1-e5c6-1bea2904541b",
        "alias": "Customer Diagnostic Kits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Diagnostickit"
          ]
        }
      }
    },
    "filters": {
      "6399251d-d843-e4ee-9b39-3a7096b8ef07": {
        "id": "6399251d-d843-e4ee-9b39-3a7096b8ef07",
        "filter": "Project",
        "keyFilters": [
          {
            "key": {
              "type": "ENTITY_FIELD",
              "key": "type"
            },
            "valueType": "STRING",
            "predicates": [
              {
                "keyFilterPredicate": {
                  "operation": "EQUAL",
                  "value": {
                    "defaultValue": "Project",
                    "dynamicValue": null
                  },
                  "ignoreCase": false,
                  "type": "STRING"
                },
                "userInfo": {
                  "editable": true,
                  "label": "",
                  "autogeneratedLabel": true,
                  "order": 0
                }
              }
            ]
          }
        ],
        "editable": true
      },
      "82f574c5-8303-0be1-01fa-b108c6097a90": {
        "id": "82f574c5-8303-0be1-01fa-b108c6097a90",
        "filter": "Devices",
        "keyFilters": [
          {
            "key": {
              "type": "ENTITY_FIELD",
              "key": "type"
            },
            "valueType": "STRING",
            "predicates": [
              {
                "keyFilterPredicate": {
                  "operation": "OR",
                  "predicates": [
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "Temperature Sensor",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "P-Flow D116",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "Room Sensor T",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "Room Sensor CO2",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "LTE Status",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    }
                  ],
                  "type": "COMPLEX"
                },
                "userInfo": {
                  "editable": true,
                  "label": "",
                  "autogeneratedLabel": true,
                  "order": 0
                }
              }
            ]
          }
        ],
        "editable": true
      },
      "3744b253-8d5c-7528-b178-0c8be5c3adca": {
        "id": "3744b253-8d5c-7528-b178-0c8be5c3adca",
        "filter": "Progress filter projects",
        "keyFilters": [
          {
            "key": {
              "type": "ATTRIBUTE",
              "key": "progress"
            },
            "valueType": "STRING",
            "predicates": [
              {
                "keyFilterPredicate": {
                  "operation": "OR",
                  "predicates": [
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "in preparation",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayPreparationMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "active",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayActiveMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "finished",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayFinishedMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "in preperation",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    }
                  ],
                  "type": "COMPLEX"
                },
                "userInfo": {
                  "editable": true,
                  "label": "",
                  "autogeneratedLabel": true,
                  "order": 0
                }
              }
            ]
          }
        ],
        "editable": false
      },
      "8366ab5b-1381-2841-d917-ec7a70bd8d7c": {
        "id": "8366ab5b-1381-2841-d917-ec7a70bd8d7c",
        "filter": "Progress filter",
        "keyFilters": [
          {
            "key": {
              "type": "ATTRIBUTE",
              "key": "progress"
            },
            "valueType": "STRING",
            "predicates": [
              {
                "keyFilterPredicate": {
                  "operation": "OR",
                  "predicates": [
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "in preparation",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayPreparationMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "active",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayActiveMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "finished",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayFinishedMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "aborted",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayAbortedMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "in preperation",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    }
                  ],
                  "type": "COMPLEX"
                },
                "userInfo": {
                  "editable": true,
                  "label": "",
                  "autogeneratedLabel": true,
                  "order": 0
                }
              }
            ]
          }
        ],
        "editable": false
      }
    },
    "timewindow": {
      "displayValue": "",
      "hideAggregation": false,
      "hideAggInterval": false,
      "hideTimezone": false,
      "selectedTab": 0,
      "realtime": {
        "realtimeType": 0,
        "interval": 1000,
        "timewindowMs": 60000,
        "quickInterval": "CURRENT_DAY"
      },
      "history": {
        "historyType": 0,
        "interval": 1000,
        "timewindowMs": 60000,
        "fixedTimewindow": {
          "startTimeMs": 1639908545606,
          "endTimeMs": 1639994945606
        },
        "quickInterval": "CURRENT_DAY"
      },
      "aggregation": {
        "type": "AVG",
        "limit": 25000
      }
    },
    "settings": {
      "stateControllerId": "entity",
      "showTitle": false,
      "showDashboardsSelect": true,
      "showEntitiesSelect": false,
      "showDashboardTimewindow": false,
      "showDashboardExport": true,
      "toolbarAlwaysOpen": true,
      "titleColor": "rgba(0,0,0,0.870588)",
      "showDashboardLogo": false,
      "dashboardLogoUrl": null,
      "hideToolbar": false,
      "showFilters": false,
      "showUpdateDashboardImage": false,
      "dashboardCss": ".tb-widget-container > .tb-widget {\n    border-radius: 8px;\n}\n\n.tb-widget-container {\n    border-radius: 8px;\n}\n\n\ngridster-item:not(.tb-noselect) > .tb-widget-container > .tb-widget {\n    cursor: default !important;\n}\n\n.tb-widget-container > .tb-widget .tb-table-widget .mat-mdc-row {\n    cursor: pointer;\n}\n\n.tb-widget-container > .tb-widget .tb-legend-keys {\n    cursor: pointer;\n}\n\n.tb-widget-container > .tb-widget .tb-markdown-view .tb-progress-cover, .tb-widget-container > .tb-widget .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-widget-container > .tb-widget .tb-markdown-view div, .tb-widget-container > .tb-widget .tb-markdown-view p {\n    line-height: normal;\n}\n\n"
    }
  },
  "name": "Administration",
  "resources": null,
  "id": {
    "entityType": "DASHBOARD",
    "id": "d0012340-f6be-11f0-9979-9f3434877bb4"
  },
  "createdTime": 1768995984244,
  "tenantId": {
    "entityType": "TENANT",
    "id": "efb63c10-b576-11ee-a6c2-a149ed03c64d"
  },
  "customerId": null,
  "assignedCustomers": null,
  "externalId": {
    "entityType": "DASHBOARD",
    "id": "d0012340-f6be-11f0-9979-9f3434877bb4"
  },
  "version": 332,
  "ownerId": {
    "entityType": "TENANT",
    "id": "efb63c10-b576-11ee-a6c2-a149ed03c64d"
  }
}