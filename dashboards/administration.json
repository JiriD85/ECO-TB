{
  "title": "Administration",
  "image": "tb-image;/api/images/tenant/belimo_retrofit_plus_padding.png",
  "mobileHide": false,
  "mobileOrder": 2,
  "configuration": {
    "description": "",
    "widgets": {
      "777ded27-e3b8-d901-ca42-3079a23f7a12": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "ECO Diagnostics Partner",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "false",
            "displayEntityName": true,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 15,
            "pageStepCount": 3,
            "pageStepIncrement": 15,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Retrofit companies",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "21d657b1-d301-fa72-ed75-6e2000eb5e51",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "{i18n:custom.retrofit-companies.address}",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "70%",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.1345774127559587,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "{i18n:custom.retrofit-companies.manage-projects}",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Projects",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "5e50c296-0eac-8841-a69a-1cbbfe04d1c5"
              }
            ],
            "actionCellButton": [
              {
                "name": "{i18n:custom.retrofit-companies.manage-projects}",
                "icon": "assignment",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "manage_projects",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "5f052715-0e89-d43b-60f4-83de99f5e2ac"
              },
              {
                "name": "{i18n:custom.retrofit-companies.manage-diagnostic-kits}",
                "icon": "medical_services",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "manage_diagnostickits",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "ef986bd4-8ab7-fde5-79e7-52b3bb257474"
              },
              {
                "name": "{i18n:custom.retrofit-companies.manage-users}",
                "icon": "people",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "manage_users",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "347536c1-e013-249a-c93e-acc1706de1bb"
              },
              {
                "name": "{i18n:custom.retrofit-companies.edit-company}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editCompanyFormGroup\"\r\n      (ngSubmit)=\"save()\"  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n     <h2 class=\"text-lg font-semibold\">{{ 'custom.retrofit-companies.edit-company' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-company-title' | translate }}</mat-label>\r\n        <input matInput formControlName=\"title\" required>\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('title').hasError('required')\">\r\n          {{ 'custom.retrofit-companies.add-company-company-title-is-required' | translate }}\r\n        </mat-error>\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('title').hasError('maxlength')\">\r\n          {{ 'customer.title-max-length' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- Existing contact component -->\r\n      <tb-contact [parentForm]=\"editCompanyFormGroup\" [isEdit]=\"true\"></tb-contact>\r\n      \r\n      <!-- New field: Shortname -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-short-name' | translate }}</mat-label>\r\n        <input matInput formControlName=\"shortName\" required minlength=\"3\" maxlength=\"4\">\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('shortName').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-short-name-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- New field: Deadline for Cancelations (days) -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-cancelation-deadline' | translate }}</mat-label>\r\n        <input matInput type=\"number\" formControlName=\"cancelDeadline\">\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('cancelDeadline').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-cancelation-deadline-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- New field: Deadline for Payments (days) -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-payment-deadline' | translate }}</mat-label>\r\n        <input matInput type=\"number\" formControlName=\"paymentDeadline\">\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('paymentDeadline').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-payment-deadline-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n  </div>\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button mat-button color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\" cdkFocusInitial>\r\n      {{ 'action.cancel' | translate }}\r\n    </button>\r\n    <button mat-button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(isLoading$ | async) || editCompanyFormGroup.invalid || !editCompanyFormGroup.dirty\">\r\n      {{ 'custom.retrofit-companies.add-company-save-company' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "const POSTAL_CODE_PATTERNS = {\r\n  'United States': '(\\\\d{5}([\\\\-]\\\\d{4})?)',\r\n  'Australia': '[0-9]{4}',\r\n  'Austria': '[0-9]{4}',\r\n  'Belgium': '[0-9]{4}',\r\n  'Brazil': '[0-9]{5}[\\\\-]?[0-9]{3}',\r\n  'Canada': '^(?!.*[DFIOQU])[A-VXY][0-9][A-Z][ -]?[0-9][A-Z][0-9]$',\r\n  'Denmark': '[0-9]{3,4}',\r\n  'Faroe Islands': '[0-9]{3,4}',\r\n  'Netherlands': '[1-9][0-9]{3}\\\\s?[a-zA-Z]{2}',\r\n  'Germany': '[0-9]{5}',\r\n  'Hungary': '[0-9]{4}',\r\n  'Italy': '[0-9]{5}',\r\n  'Japan': '\\\\d{3}-\\\\d{4}',\r\n  'Luxembourg': '(L\\\\s*(-|—|–))\\\\s*?[\\\\d]{4}',\r\n  'Poland': '[0-9]{2}\\\\-[0-9]{3}',\r\n  'Spain': '((0[1-9]|5[0-2])|[1-4][0-9])[0-9]{3}',\r\n  'Sweden': '\\\\d{3}\\\\s?\\\\d{2}',\r\n  'United Kingdom': '[A-Za-z]{1,2}[0-9Rr][0-9A-Za-z]? [0-9][ABD-HJLNP-UW-Zabd-hjlnp-uw-z]{2}'\r\n};\r\n\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\n\r\nopenEditCompanyDialog();\r\n\r\nfunction openEditCompanyDialog() {\r\n  customDialog.customDialog(htmlTemplate, EditCompanyDialogController).subscribe();\r\n}\r\n\r\nfunction EditCompanyDialogController(instance) {\r\n  let vm = instance;\r\n  \r\n  vm.customer = {};\r\n\r\n  vm.editCompanyFormGroup = vm.fb.group({\r\n    title: ['', [vm.validators.required, vm.validators.maxLength(255)]]\r\n  });\r\n  \r\n  // Add existing form controls\r\n  vm.editCompanyFormGroup.addControl('country', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('city', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('state', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('zip', vm.fb.control('', zipValidators('')));\r\n  vm.editCompanyFormGroup.addControl('address', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('address2', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('phone', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('email', vm.fb.control('', [vm.validators.email]));\r\n  \r\n  // Add new controls for deadline fields\r\n  vm.editCompanyFormGroup.addControl('cancelDeadline', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('paymentDeadline', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('shortName', vm.fb.control('', []));\r\n  \r\n  // Update zip validators on country change\r\n  vm.editCompanyFormGroup.get('country').valueChanges.subscribe((country) => {\r\n    vm.editCompanyFormGroup.get('zip').setValidators(zipValidators(country));\r\n    vm.editCompanyFormGroup.get('zip').updateValueAndValidity({ onlySelf: true });\r\n    vm.editCompanyFormGroup.get('zip').markAsTouched({ onlySelf: true });\r\n  });\r\n  \r\n  getCompany();\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    vm.editCompanyFormGroup.markAsPristine();\r\n    saveCompanyObservable().subscribe(function (customer) {\r\n      widgetContext.rxjs.forkJoin([\r\n          saveAttributes(customer)\r\n      ]).subscribe(function () {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n      });\r\n    });\r\n  };\r\n  \r\n  function getCompany() {\r\n    customerService.getCustomer(entityId.id).subscribe((customer) => {\r\n        attributeService.getEntityAttributes(customer.id, \"SERVER_SCOPE\", [\"cancelDeadline\",\"paymentDeadline\",\"shortName\"]).subscribe(attributes => {\r\n      const shortNameObj = attributes.find(item => item.key === \"shortName\");\r\n      const shortName = shortNameObj ? shortNameObj.value : \"\";\r\n      const paymentDeadlineObj = attributes.find(item => item.key === \"paymentDeadline\");\r\n      const paymentDeadline = paymentDeadlineObj ? paymentDeadlineObj.value : \"\";\r\n      const cancelDeadlineObj = attributes.find(item => item.key === \"cancelDeadline\");\r\n      const cancelDeadline = cancelDeadlineObj ? cancelDeadlineObj.value : \"\";\r\n      vm.customer = customer;\r\n      // Patch form with customer details including deadlines (if available)\r\n      vm.editCompanyFormGroup.patchValue({\r\n        title: vm.customer.title,\r\n        country: vm.customer.country,\r\n        city: vm.customer.city,\r\n        state: vm.customer.state,\r\n        zip: vm.customer.zip,\r\n        address: vm.customer.address,\r\n        address2: vm.customer.address2,\r\n        phone: vm.customer.phone,\r\n        email: vm.customer.email,\r\n        cancelDeadline: cancelDeadline || '',\r\n        paymentDeadline: paymentDeadline || '',\r\n        shortName: shortName || ''\r\n      }, { emitEvent: false });\r\n      vm.editCompanyFormGroup.get('zip').setValidators(zipValidators(vm.customer.country));\r\n      vm.editCompanyFormGroup.get('zip').updateValueAndValidity({ onlySelf: true });\r\n    });\r\n    });\r\n  }\r\n  \r\n  function zipValidators(country) {\r\n    const validators = [];\r\n    if (country && POSTAL_CODE_PATTERNS[country]) {\r\n      const postalCodePattern = POSTAL_CODE_PATTERNS[country];\r\n      validators.push(vm.validators.pattern(postalCodePattern));\r\n    }\r\n    return validators;\r\n  }\r\n\r\n  function saveCompanyObservable() {\r\n    const formValues = vm.editCompanyFormGroup.value;\r\n    vm.customer.title = formValues.title;\r\n    vm.customer.country = formValues.country;\r\n    vm.customer.city = formValues.city;\r\n    vm.customer.state = formValues.state;\r\n    vm.customer.zip = formValues.zip;\r\n    vm.customer.address = formValues.address;\r\n    vm.customer.address2 = formValues.address2;\r\n    vm.customer.phone = formValues.phone;\r\n    vm.customer.email = formValues.email;\r\n   /* // Optionally update deadlines in the customer object\r\n    vm.customer.cancelDeadline = formValues.cancelDeadline;\r\n    vm.customer.paymentDeadline = formValues.paymentDeadline;\r\n    vm.customer.shortName = formValues.shortName;*/\r\n    return customerService.saveCustomer(vm.customer);\r\n  }\r\n  \r\n  function saveAttributes(customer) {\r\n    const formValues = vm.editCompanyFormGroup.value;\r\n    let attributesArray = [\r\n      { key: 'type', value: 'retail' },\r\n      { key: 'address', value: getAddressValue(customer) },\r\n      { key: 'cancelDeadline', value: formValues.cancelDeadline },\r\n      { key: 'paymentDeadline', value: formValues.paymentDeadline },\r\n      { key: 'shortName', value: formValues.shortName }\r\n    ];\r\n    return attributeService.saveEntityAttributes(customer.id, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n  \r\n  function getAddressValue(customer) {\r\n    var address = '';\r\n    if (customer.address) {\r\n      address += customer.address;\r\n    }\r\n    if (customer.address2) {\r\n      address += (address ? ', ' : '') + customer.address2;\r\n    }\r\n    if (customer.city) {\r\n      address += (address ? ', ' : '') + customer.city;\r\n    }\r\n    if (customer.state) {\r\n      address += (address ? ', ' : '') + customer.state;\r\n    }\r\n    if (customer.zip) {\r\n      address += (customer.state ? ' ' : (address ? ', ' : '')) + customer.zip;\r\n    }\r\n    if (customer.country) {\r\n      address += (address ? ', ' : '') + customer.country;\r\n    }\r\n    return address;\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.retrofit-companies.delete-company}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\nopenDeleteCustomerDialog();\n\nfunction openDeleteCustomerDialog() {\n  let titleTranslation = translationService.instant(\n    'custom.retrofit-companies.delete-company-titel',\n    { entityName: entityName }\n  );\n\n  let contentTranslation = translationService.instant(\n    'custom.retrofit-companies.delete-company-content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteCustomer();\n    }\n  });\n}\n\n\nfunction deleteCustomer() {\n  customerService.deleteCustomer(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.retrofit-companies.add-company}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addCompanyFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 600px;\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>{{ 'custom.retrofit-companies.add-company' | translate }}</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-company-title' | translate }}</mat-label>\r\n        <input matInput formControlName=\"title\" required>\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('title').hasError('required')\">\r\n          {{ 'custom.retrofit-companies.add-company-company-title-is-required' | translate }}\r\n        </mat-error>\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('title').hasError('maxlength')\">\r\n          {{ 'customer.title-max-length' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- Existing contact component -->\r\n      <tb-contact [parentForm]=\"addCompanyFormGroup\" [isEdit]=\"true\"></tb-contact>\r\n      \r\n      <!-- New field: Shortname -->\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-short-name' | translate }}</mat-label>\r\n        <input matInput formControlName=\"shortName\" required minlength=\"3\" maxlength=\"4\">\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('shortName').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-short-name-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- New field: Deadline for Cancelations (days) -->\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-cancelation-deadline' | translate }}</mat-label>\r\n        <input matInput type=\"number\" formControlName=\"cancelDeadline\" required>\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('cancelDeadline').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-cancelation-deadline-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- New field: Deadline for Payments (days) -->\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-payment-deadline' | translate }}</mat-label>\r\n        <input matInput type=\"number\" formControlName=\"paymentDeadline\" required>\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('paymentDeadline').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-payment-deadline-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n  </div>\r\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n    <button mat-button color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\" cdkFocusInitial>\r\n      {{ 'action.cancel' | translate }}\r\n    </button>\r\n    <button mat-button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(isLoading$ | async) || addCompanyFormGroup.invalid || !addCompanyFormGroup.dirty\">\r\n      {{ 'custom.retrofit-companies.add-company' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "const POSTAL_CODE_PATTERNS = {\r\n  'United States': '(\\\\d{5}([\\\\-]\\\\d{4})?)',\r\n  'Australia': '[0-9]{4}',\r\n  'Austria': '[0-9]{4}',\r\n  'Belgium': '[0-9]{4}',\r\n  'Brazil': '[0-9]{5}[\\\\-]?[0-9]{3}',\r\n  'Canada': '^(?!.*[DFIOQU])[A-VXY][0-9][A-Z][ -]?[0-9][A-Z][0-9]$',\r\n  'Denmark': '[0-9]{3,4}',\r\n  'Faroe Islands': '[0-9]{3,4}',\r\n  'Netherlands': '[1-9][0-9]{3}\\\\s?[a-zA-Z]{2}',\r\n  'Germany': '[0-9]{5}',\r\n  'Hungary': '[0-9]{4}',\r\n  'Italy': '[0-9]{5}',\r\n  'Japan': '\\\\d{3}-\\\\d{4}',\r\n  'Luxembourg': '(L\\\\s*(-|—|–))\\\\s*?[\\\\d]{4}',\r\n  'Poland': '[0-9]{2}\\\\-[0-9]{3}',\r\n  'Spain': '((0[1-9]|5[0-2])|[1-4][0-9])[0-9]{3}',\r\n  'Sweden': '\\\\d{3}\\\\s?\\\\d{2}',\r\n  'United Kingdom': '[A-Za-z]{1,2}[0-9Rr][0-9A-Za-z]? [0-9][ABD-HJLNP-UW-Zabd-hjlnp-uw-z]{2}'\r\n};\r\n\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet roleService = $injector.get(widgetContext.servicesMap.get('roleService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\r\n/*let stripeKey;*/\r\n\r\n/*attributeService\r\n  .getEntityAttributes({ entityType: 'TENANT', id: tenantId }, \"SERVER_SCOPE\", ['stripeKey'])\r\n  .subscribe(key => {\r\n      stripeKey = key[0].value;\r\n      openAddCompanyDialog();\r\n  });*/\r\n  \r\nopenAddCompanyDialog();\r\n\r\nfunction openAddCompanyDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddCompanyDialogController).subscribe();\r\n}\r\n\r\nfunction AddCompanyDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  // Initialize form with company title control\r\n  vm.addCompanyFormGroup = vm.fb.group({\r\n    title: ['', [vm.validators.required, vm.validators.maxLength(255)]]\r\n  });\r\n  \r\n  // Existing form controls\r\n  vm.addCompanyFormGroup.addControl('country', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('city', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('state', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('zip', vm.fb.control('', zipValidators('')));\r\n  vm.addCompanyFormGroup.addControl('address', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('address2', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('phone', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('email', vm.fb.control('', [vm.validators.email]));\r\n\r\n  // New controls for deadline fields\r\n  vm.addCompanyFormGroup.addControl('cancelDeadline', vm.fb.control(90, []));\r\n  vm.addCompanyFormGroup.addControl('paymentDeadline', vm.fb.control(14, []));\r\n  vm.addCompanyFormGroup.addControl('shortName', vm.fb.control('', []));\r\n  \r\n  // Update zip validators when country value changes\r\n  vm.addCompanyFormGroup.get('country').valueChanges.subscribe((country) => {\r\n    vm.addCompanyFormGroup.get('zip').setValidators(zipValidators(country));\r\n    vm.addCompanyFormGroup.get('zip').updateValueAndValidity({ onlySelf: true });\r\n    vm.addCompanyFormGroup.get('zip').markAsTouched({ onlySelf: true });\r\n  });\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    vm.addCompanyFormGroup.markAsPristine();\r\n    saveCompanyObservable().subscribe(function (customer) {\r\n      widgetContext.rxjs.forkJoin([\r\n        saveAttributes(customer),\r\n        saveUserGroups(customer.id)\r\n      ]).subscribe(function () {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n      });\r\n    });\r\n  };\r\n  \r\n  function zipValidators(country) {\r\n    const zipValidators = [];\r\n    if (country && POSTAL_CODE_PATTERNS[country]) {\r\n      const postalCodePattern = POSTAL_CODE_PATTERNS[country];\r\n      zipValidators.push(vm.validators.pattern(postalCodePattern));\r\n    }\r\n    return zipValidators;\r\n  }\r\n\r\n  function saveCompanyObservable() {\r\n    return getOrCreateSmartRetailCustomerGroup().pipe(\r\n      widgetContext.rxjs.switchMap((smartRetail) => {\r\n        const formValues = vm.addCompanyFormGroup.value;\r\n        let customer = {\r\n          title: formValues.title,\r\n          country: formValues.country,\r\n          city: formValues.city,\r\n          state: formValues.state,\r\n          zip: formValues.zip,\r\n          address: formValues.address,\r\n          address2: formValues.address2,\r\n          phone: formValues.phone,\r\n          email: formValues.email\r\n        };\r\n        return customerService.saveCustomer(customer, smartRetail.id.id);\r\n      })\r\n    );\r\n  }\r\n  \r\n  function getOrCreateSmartRetailCustomerGroup() {\r\n    return getEntityGroupByName(\"Belimo Retrofit\", \"CUSTOMER\").pipe(\r\n      widgetContext.rxjs.switchMap((group) => {\r\n        if (group) {\r\n          return widgetContext.rxjs.of(group);\r\n        } else {\r\n          var smartRetail = {\r\n            type: 'CUSTOMER',\r\n            name: 'Belimo Retrofit'\r\n          };\r\n          return entityGroupService.saveEntityGroup(smartRetail);\r\n        }\r\n      })\r\n    );\r\n  }\r\n  \r\n  function saveUserGroups(customerId) {\r\n    return widgetContext.rxjs.forkJoin([\r\n      getRoleByName(\"Belimo Retrofit Read Only\", \"GROUP\"),\r\n      getRoleByName(\"Belimo Retrofit Users\", \"GENERIC\"),\r\n      getRoleByName(\"Belimo Retrofit Administrators\", \"GENERIC\"),\r\n      getRoleByName(\"Belimo Retrofit Engineer\", \"GENERIC\"),\r\n      getEntityGroupByName(\"Belimo Retrofit\", \"DASHBOARD\"),\r\n      getEntityGroupByName(\"Belimo Retrofit Administrators\", \"DASHBOARD\")\r\n    ]).pipe(widgetContext.rxjs.switchMap((data) => {\r\n      var smartRetailReadOnlyGroupRole = data[0];\r\n      var smartRetailUserGenericRole = data[1];\r\n      var smartRetailAdministratorGenericRole = data[2];\r\n      var smartRetailEngineerGenericRole = data[3];\r\n      var smartRetailSharedGroup = data[4];\r\n      var smartRetailGroup = data[5];\r\n      \r\n      var smartRetailUsers = {\r\n        type: 'USER',\r\n        name: 'Belimo Retrofit Users',\r\n        ownerId: customerId\r\n      };\r\n      \r\n      var smartRetailAdministrators = {\r\n        type: 'USER',\r\n        name: 'Belimo Retrofit Administrators',\r\n        ownerId: customerId\r\n      };\r\n      \r\n      var smartRetailEngineer = {\r\n        type: 'USER',\r\n        name: 'Belimo Retrofit Engineer',\r\n        ownerId: customerId\r\n      };\r\n\r\n      return widgetContext.rxjs.forkJoin([\r\n        entityGroupService.saveEntityGroup(smartRetailUsers),\r\n        entityGroupService.saveEntityGroup(smartRetailAdministrators),\r\n        entityGroupService.saveEntityGroup(smartRetailEngineer)\r\n      ]).pipe(widgetContext.rxjs.switchMap((data) => {\r\n        var smartRetailUsersGroup = data[0];\r\n        var smartRetailAdministratorsGroup = data[1];\r\n        var smartRetailEngineerGroup = data[2];\r\n\r\n        const tasks = [];\r\n\r\n        if (smartRetailReadOnlyGroupRole) {\r\n          if (smartRetailSharedGroup) {\r\n            let smartRetailSharedGroupPermissionForUsers = {\r\n              userGroupId: smartRetailUsersGroup.id,\r\n              roleId: smartRetailReadOnlyGroupRole.id,\r\n              entityGroupId: smartRetailSharedGroup.id,\r\n              entityGroupType: smartRetailSharedGroup.type\r\n            };\r\n            let smartRetailSharedGroupPermissionForAdmins = {\r\n              userGroupId: smartRetailAdministratorsGroup.id,\r\n              roleId: smartRetailReadOnlyGroupRole.id,\r\n              entityGroupId: smartRetailSharedGroup.id,\r\n              entityGroupType: smartRetailSharedGroup.type\r\n            };\r\n            let smartRetailSharedGroupPermissionForEngineer = {\r\n              userGroupId: smartRetailEngineerGroup.id,\r\n              roleId: smartRetailReadOnlyGroupRole.id,\r\n              entityGroupId: smartRetailSharedGroup.id,\r\n              entityGroupType: smartRetailSharedGroup.type\r\n            };\r\n            tasks.push(roleService.saveGroupPermission(smartRetailSharedGroupPermissionForUsers));\r\n            tasks.push(roleService.saveGroupPermission(smartRetailSharedGroupPermissionForAdmins));\r\n            tasks.push(roleService.saveGroupPermission(smartRetailSharedGroupPermissionForEngineer));\r\n          }\r\n          if (smartRetailGroup) {\r\n            let smartRetailGroupPermissionForAdmins = {\r\n              userGroupId: smartRetailAdministratorsGroup.id,\r\n              roleId: smartRetailReadOnlyGroupRole.id,\r\n              entityGroupId: smartRetailGroup.id,\r\n              entityGroupType: smartRetailGroup.type\r\n            };\r\n            tasks.push(roleService.saveGroupPermission(smartRetailGroupPermissionForAdmins));\r\n          }\r\n        }\r\n\r\n        if (smartRetailUserGenericRole) {\r\n          let smartRetailUserGenericPermission = {\r\n            userGroupId: smartRetailUsersGroup.id,\r\n            roleId: smartRetailUserGenericRole.id\r\n          };\r\n          tasks.push(roleService.saveGroupPermission(smartRetailUserGenericPermission));\r\n        }\r\n\r\n        if (smartRetailAdministratorGenericRole) {\r\n          let smartRetailAdminGenericPermission = {\r\n            userGroupId: smartRetailAdministratorsGroup.id,\r\n            roleId: smartRetailAdministratorGenericRole.id\r\n          };\r\n          tasks.push(roleService.saveGroupPermission(smartRetailAdminGenericPermission));\r\n        }\r\n        \r\n        if (smartRetailEngineerGenericRole) {\r\n          let smartRetailEngineerGenericPermission = {\r\n            userGroupId: smartRetailEngineerGroup.id,\r\n            roleId: smartRetailEngineerGenericRole.id\r\n          };\r\n          tasks.push(roleService.saveGroupPermission(smartRetailEngineerGenericPermission));\r\n        }\r\n        \r\n        if (tasks.length) {\r\n          return widgetContext.rxjs.forkJoin(tasks);\r\n        } else {\r\n          return widgetContext.rxjs.of(null);\r\n        }\r\n      }));\r\n    }));\r\n  }\r\n  \r\n  function getRoleByName(roleName, type) {\r\n    var rolesPageLink = widgetContext.pageLink(10, 0, roleName);\r\n    return roleService.getRoles(rolesPageLink, type, { ignoreLoading: true }).pipe(\r\n      widgetContext.rxjs.map((data) => {\r\n        if (data.data.length) {\r\n          return data.data.find((role) => role.name === roleName);\r\n        } else {\r\n          return null;\r\n        }\r\n      })\r\n    );\r\n  }\r\n  \r\n  function getEntityGroupByName(groupName, groupType) {\r\n    var entityGroupsPageLink = widgetContext.pageLink(10, 0, groupName);\r\n    return entityGroupService.getEntityGroupsByPageLink(entityGroupsPageLink, groupType, { ignoreLoading: true }).pipe(\r\n      widgetContext.rxjs.map((data) => {\r\n        if (data.data.length) {\r\n          return data.data.find((group) => group.name === groupName);\r\n        } else {\r\n          return null;\r\n        }\r\n      })\r\n    );\r\n  }\r\n  \r\n  function saveAttributes(customer) {\r\n    const formValues = vm.addCompanyFormGroup.value;\r\n    let attributesArray = [\r\n      { key: 'address', value: getAddressValue(customer) },\r\n/*      { key: 'stripeKey', value: stripeKey },*/\r\n      { key: 'weatherAPIToken', value: '587f1474e94ea6b52e6ce6e99d13d75a' },\r\n      { key: 'cancelDeadline', value: formValues.cancelDeadline },\r\n      { key: 'paymentDeadline', value: formValues.paymentDeadline },\r\n      { key: 'shortName', value: formValues.shortName }\r\n    ];\r\n    return attributeService.saveEntityAttributes(customer.id, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n  \r\n  function getAddressValue(customer) {\r\n    var address = '';\r\n    if (customer.address) {\r\n      address += customer.address;\r\n    }\r\n    if (customer.address2) {\r\n      address += (address ? ', ' : '') + customer.address2;\r\n    }\r\n    if (customer.city) {\r\n      address += (address ? ', ' : '') + customer.city;\r\n    }\r\n    if (customer.state) {\r\n      address += (address ? ', ' : '') + customer.state;\r\n    }\r\n    if (customer.zip) {\r\n      address += (customer.state ? ' ' : (address ? ', ' : '')) + customer.zip;\r\n    }\r\n    if (customer.country) {\r\n      address += (address ? ', ' : '') + customer.country;\r\n    }\r\n    return address;\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "777ded27-e3b8-d901-ca42-3079a23f7a12",
        "typeFullFqn": "system.cards.entities_table"
      },
      "c2559a58-e82d-3250-7e35-f520ced0d916": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "203b0867-b867-ef98-1791-03046c133b7d",
              "dataKeys": [
                {
                  "name": "role",
                  "type": "attribute",
                  "label": "role",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.7805336660172157
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div style=\"width: 100%; height: 100%; padding: 0;\">\n   <tb-dashboard-state *ngIf=\"ctx.currentUser.authority === 'TENANT_ADMIN'\" [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"eco_administration\"></tb-dashboard-state>\n   <tb-dashboard-state *ngIf=\"ctx.currentUser.authority === 'CUSTOMER_USER'\" [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"customer_administration\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "// 29.01.2026 - Updated to use role attribute\nvar userRole = data[0] && data[0].role ? data[0].role : '';\n\nvar stateParams = ctx.stateController.getStateParams();\nstateParams[\"userRole\"] = userRole;\nctx.stateController.updateState(null, stateParams);\n\n// Determine state based on user role\nvar stateId = 'customer_administration'; // default\nif (userRole === 'ECO Administrator') {\n  stateId = 'eco_administration';\n} else if (userRole === 'Administrator') {\n  stateId = 'customer_administration';\n}\n\nreturn '<div style=\"width: 100%; height: 100%; padding: 0;\">' +\n  '<tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"' + stateId + '\"></tb-dashboard-state>' +\n'</div>';",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ""
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "useDashboardTimewindow": true,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "c2559a58-e82d-3250-7e35-f520ced0d916",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "ed6cf40c-1c37-2fe9-4436-22c669817f3e": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "filterId": null,
              "dataKeys": []
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "var DoktorkitState;\r\nif (data && data.length && data[0]['entityId']) {\r\n    DoktorkitState = true;\r\n} else {\r\n    DoktorkitState = false;\r\n}\r\n\r\nvar typeSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24\" viewBox=\"0 -960 960 960\" width=\"24\"><path d=\"M160-80q-33 0-56.5-23.5T80-160v-480q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v480q0 33-23.5 56.5T800-80H160Zm240-640h160v-80H400v80Zm40 360v120h80v-120h120v-80H520v-120h-80v120H320v80h120Z\"/></svg>';\r\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\r\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\r\n\r\nvar header = '<div class=\"header\" fxLayout=\"column\" fxLayoutAlign=\"start stretch\" fxLayoutGap=\"8px\">' +\r\n                '<div fxLayout=\"row\" fxLayoutAlign=\"start stretch\">' +\r\n                  '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><button id=\"go-back\" matTooltip=\"Go back\" type=\"button\" mat-icon-button><mat-icon>arrow_back</mat-icon></button></div>' +\r\n                 /* '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><img style=\"vertical-align: middle;\" class=\"title-icon mat-icon\" src=\"'+ typeSvgUrl +'\"></div>' +*/\r\n                  '<div fxFlex fxLayout=\"column\" fxLayoutAlign=\"center\">' +\r\n                     '<div class=\"title\">Edit Doktorkit: {{ ctx.stateController.getStateParams().selectedDoktorkit?.entityName }}</div>' +\r\n                  '</div>' +\r\n                '</div>' +\r\n                '<div fxLayout=\"row\" fxLayoutAlign=\"stretch stretch\" fxLayoutGap=\"8px\">' +\r\n                  /*'<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"add-Kit\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">add_circle</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"Doktorkits\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">devices_other</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"Sensorkits\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">sensors</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +*/\r\n                  '<div fxFlex=\"50\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"get-location\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">location_on</mat-icon>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"50\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"delete-Doktorkit\" type=\"button\" mat-raised-button color=\"accent\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">delete</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                '</div>' +\r\n             '</div>';\r\n             \r\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\r\n          (DoktorkitState \r\n            ? (header +\r\n               '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"edit_Doktorkit_card\"></tb-dashboard-state>') \r\n            : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"doktorkits_card_all_customer\"></tb-dashboard-state>') +\r\n       '</div>';\r\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n.main-layout .header {\n    height: 100px;\n    margin: 6px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n.main-layout .tb-mat-20 {\n    width: 1px;\n    height: 2px;\n    margin: 2px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 12px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedDoktorkit'] = null;\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "116515c2-d9bd-80b6-7a34-97373a802806"
              },
              {
                "name": "Doktorkit-devices",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f921410a-47b7-5884-1c63-d010a39064a4"
              }
            ],
            "headerButton": []
          }
        },
        "row": 0,
        "col": 0,
        "id": "ed6cf40c-1c37-2fe9-4436-22c669817f3e",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "4cc2a279-fbae-dce8-0827-5a24057fe53e": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\n     <div fxLayout=\"row\" style=\"width: 100%; height: 60px;\" fxLayoutAlign=\"center start\">\n        <h5 fxFlex class=\"market-title\">Doktorkits</h5>\n        <button id=\"add-Doktorkit\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">add</mat-icon><span>Add Doktorkit</span></button>\n     </div>\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"doktorkits_map_all\"></tb-dashboard-state>\n    </div>\n</div>",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-container .tb-widget .tb-multiple-input {\n    background-color: #FAFAFA;\n    border-radius: 4px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .input-field {\n    padding-right: 30px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input mat-slide-toggle {\n    margin-top: 15px !important;\n    margin-bottom: 0 !important;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-slide-toggle-content {\n    width: 120px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-bar {\n    width: 42px;\n    height: 24px;\n    border-radius: 16px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb-container {\n    top: 2px;\n    left: 2px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-thumb-container {\n    transform: translate3d(18px, 0, 0);\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb {\n    background-color: #fafafa;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-bar {\n    background-color: #F2994A;\n}\n",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "add-Doktorkit",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDoktorkitFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 350px;\">\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\n    <h2>Add Doktorkit</h2>\n    <span fxFlex></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content fxLayout=\"column\">\n    <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">\n      <mat-form-field fxFlex class=\"mat-block\">\n        <mat-label>Doktorkit title</mat-label>\n        <input matInput formControlName=\"name\" required>\n        <mat-error *ngIf=\"addDoktorkitFormGroup.get('name').hasError('required')\">\n          Doktorkit title is required.\n        </mat-error>\n      </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      Cancel\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addDoktorkitFormGroup.invalid || !addDoktorkitFormGroup.dirty\">\n      Add Doktorkit\n    </button>\n  </div>\n</form>\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\n\r\nopenAddDoktorkitDialog();\r\n\r\nfunction openAddDoktorkitDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddDoktorkitDialogController).subscribe();\r\n}\r\n\r\nfunction AddDoktorkitDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.addDoktorkitFormGroup = vm.fb.group({\r\n    name: ['', [vm.validators.required]]\r\n  });\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    const stateParams = widgetContext.stateController.getStateParams();\r\n    var customerId;\r\n    var projectId;\r\n    var measurementId;\r\n    projectId = {id:(stateParams.selectedProject && stateParams.selectedProject.entityId && stateParams.selectedProject.entityId.id) ? stateParams.selectedProject.entityId.id : '',entityType: 'ASSET'}; \r\n    measurementId = {id:(stateParams.selectedMeasurement && stateParams.selectedMeasurement.entityId && stateParams.selectedMeasurement.entityId.id) ? stateParams.selectedMeasurement.entityId.id : '',entityType: 'ASSET'}; \r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        customerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n    vm.addDoktorkitFormGroup.markAsPristine();\r\n    saveDoktorkitObservable(customerId).subscribe(\r\n      function (Doktorkit) {\r\n        const observables = [\r\n        saveCustomerToDoktorkitRelation(customerId, Doktorkit.id),\r\n        saveAttributes(Doktorkit.id)\r\n        ];\r\n        // Add saveProjectToMeasurementRelation to observables if projectId is not empty\r\n        if(projectId.id !== \"\"){\r\n            observables.push(saveProjectToDoktorkitRelation(projectId, Doktorkit.id));\r\n        }\r\n        if(measurementId.id !== \"\"){\r\n            observables.push(saveMeasurementToDoktorkitRelation(measurementId, Doktorkit.id));\r\n        }\r\n          widgetContext.rxjs.forkJoin(observables).subscribe(\r\n              function () {\r\n                var params = widgetContext.stateController.getStateParams();\r\n                var selectedDoktorkit = params['selectedDoktorkit'];\r\n                params['selectedDoktorkit'] = { entityId: Doktorkit.id, entityName: Doktorkit.name, entityLabel: '' };\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              }\r\n        );\r\n      }\r\n    );\r\n  };\r\n\r\n  function saveDoktorkitObservable(customerId) {\r\n    return getDoktorkitsGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((DoktorkitsGroup) => {\r\n            return getUnassignedKitGroup(customerId).pipe(\r\n                widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\r\n                    const formValues = vm.addDoktorkitFormGroup.value;\r\n                    const Doktorkit = {\r\n                        name: formValues.name,\r\n                        type: 'Doktorkit',\r\n                        customerId: customerId\r\n                    };\r\n\r\n                    return assetService.saveAsset(Doktorkit, DoktorkitsGroup.id.id).pipe(\r\n                        widgetContext.rxjs.switchMap((savedAsset) => {\r\n                            // Ensure this line returns an observable\r\n                            return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, savedAsset.id.id).pipe(\r\n                                widgetContext.rxjs.map(() => {\r\n                                    return savedAsset; // Return the saved asset after adding to the entity group\r\n                                })\r\n                            );\r\n                        })\r\n                    );\r\n                })\r\n            );\r\n        })\r\n    );\r\n}\r\n\r\n\r\n  \r\n  function getDoktorkitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var DoktorkitsGroup = entityGroups.find(group => group.name === 'Doktorkits');\r\n              if (DoktorkitsGroup) {\r\n                  return widgetContext.rxjs.of(DoktorkitsGroup);\r\n              } else {\r\n                  DoktorkitsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Doktorkits',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(DoktorkitsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  function getUnassignedKitGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n              if (UnassignedKitGroup) {\r\n                  return widgetContext.rxjs.of(UnassignedKitGroup);\r\n              } else {\r\n                  UnassignedKitGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Unassigned Kit',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n\r\n  function saveCustomerToDoktorkitRelation(customerId, DoktorkitId) {\r\n      var relation = {\r\n          from: customerId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveProjectToDoktorkitRelation(projectId, DoktorkitId) {\r\n      var relation = {\r\n          from: projectId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveMeasurementToDoktorkitRelation(measurementId, DoktorkitId) {\r\n      var relation = {\r\n          from: measurementId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n        {\r\n            key: 'latitude',\r\n            value: 48.1406022\r\n        },\r\n        {\r\n            key: 'longitude',\r\n            value: 16.2932688\r\n        },\r\n        {\r\n            key: 'alias',\r\n            value: 'N/A'\r\n        },        \r\n        {\r\n            key: 'address',\r\n            value: 'N/A'\r\n        },\r\n        {\r\n            key: 'state',\r\n            value: 'normal'\r\n        },\r\n        {\r\n            key: 'units',\r\n            value: 'metric'\r\n        },\r\n        {\r\n            key: 'floorplan',\r\n            value: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCEtLSBDcmVhdGVkIHdpdGggSW5rc2NhcGUgKGh0dHA6Ly93d3cuaW5rc2NhcGUub3JnLykgLS0+Cjxzdmcgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc5LjM3NSA3OS4zNzUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiA8cmVjdCB4PSIyLjcwMTkiIHk9IjIuNzAxOSIgd2lkdGg9IjczLjk3MSIgaGVpZ2h0PSI3My45NzEiIGZpbGw9IiNmZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9Ii4xMTIxIiBzdHlsZT0icGFpbnQtb3JkZXI6bWFya2VycyBmaWxsIHN0cm9rZSIvPgogPGcgdHJhbnNmb3JtPSJtYXRyaXgoLjI2NDU4IDAgMCAuMjY0NTggMi42MzUgLTIuODgzNCkiIHN0cm9rZS13aWR0aD0iMXB4IiBzdHlsZT0ic2hhcGUtaW5zaWRlOnVybCgjcmVjdDQ4MzYpO3doaXRlLXNwYWNlOnByZSIgYXJpYS1sYWJlbD0iICAgTm8gcGxhbiBjb25maWd1cmVkIj4KICA8cGF0aCBkPSJtMTAxLjY3IDExOC4yOXYyOC40MzhoLTMuNzg5MWwtMTQuMzE2LTIxLjkzNHYyMS45MzRoLTMuNzY5NXYtMjguNDM4aDMuNzY5NWwxNC4zNzUgMjEuOTkydi0yMS45OTJ6Ii8+CiAgPHBhdGggZD0ibTEwNi44MyAxMzUuOTVxMC00LjU4OTggMi41NzgxLTcuNjU2MiAyLjU3ODEtMy4wODU5IDcuMDExNy0zLjA4NTl0Ny4wMTE3IDMuMDI3M3EyLjU3ODEgMy4wMDc4IDIuNjM2NyA3LjUxOTV2MC42NDQ1M3EwIDQuNTg5OC0yLjU5NzcgNy42NTYyLTIuNTc4MSAzLjA2NjQtNy4wMTE3IDMuMDY2NC00LjQ1MzEgMC03LjA1MDgtMy4wNjY0LTIuNTc4MS0zLjA2NjQtMi41NzgxLTcuNjU2MnptMy42MTMzIDAuNDQ5MjJxMCAzLjE0NDUgMS40ODQ0IDUuNDQ5MiAxLjUwMzkgMi4zMDQ3IDQuNTMxMiAyLjMwNDcgMi45NDkyIDAgNC40NTMxLTIuMjY1NiAxLjUwMzktMi4yODUyIDEuNTIzNC01LjQyOTd2LTAuNTA3ODFxMC0zLjEwNTUtMS41MDM5LTUuNDI5Ny0xLjUwMzktMi4zNDM4LTQuNTExNy0yLjM0MzgtMi45ODgzIDAtNC40OTIyIDIuMzQzOC0xLjQ4NDQgMi4zMjQyLTEuNDg0NCA1LjQyOTd6Ii8+CiAgPHBhdGggZD0ibTE1MC4xNyAxNDcuMTJxLTMuODA4NiAwLTYuMDM1Mi0yLjQ0MTR2MTAuMTc2aC0zLjYzMjh2LTI5LjI1OGgzLjMyMDNsMC4xNzU3OCAyLjMyNDJxMi4yMjY2LTIuNzE0OCA2LjExMzMtMi43MTQ4IDQuMDAzOSAwIDYuMTMyOCAyLjk2ODggMi4xMjg5IDIuOTY4OCAyLjEyODkgNy44MTI1djAuNDEwMTZxMCA0LjYyODktMi4xNDg0IDcuNjc1OC0yLjEyODkgMy4wNDY5LTYuMDU0NyAzLjA0Njl6bS0xLjExMzMtMTguODY3cS0zLjI4MTIgMC00LjkyMTkgMi45MTAydjEwLjExN3ExLjY2MDIgMi44NzExIDQuOTYwOSAyLjg3MTEgMi45Mjk3IDAgNC4yNzczLTIuMzA0NyAxLjM2NzItMi4zMDQ3IDEuMzY3Mi01LjQ0OTJ2LTAuNDEwMTZxMC0zLjE0NDUtMS4zNjcyLTUuNDI5Ny0xLjM0NzYtMi4zMDQ3LTQuMzE2NC0yLjMwNDd6Ii8+CiAgPHBhdGggZD0ibTE2Ni45MSAxMTYuNzN2MzBoLTMuNjMyOHYtMzB6Ii8+CiAgPHBhdGggZD0ibTE4NS43NSAxNDYuNzNxLTAuMzUxNTctMC43NjE3Mi0wLjUwNzgyLTIuMjI2Ni0xLjAxNTYgMS4wNzQyLTIuNTM5MSAxLjg1NTUtMS41MjM0IDAuNzYxNzItMy40NzY2IDAuNzYxNzItMy4yNDIyIDAtNS4xOTUzLTEuODE2NC0xLjk1MzEtMS44MTY0LTEuOTUzMS00LjQ1MzEgMC0zLjM5ODQgMi41NzgxLTUuMTU2MiAyLjU3ODEtMS43NzczIDYuOTMzNi0xLjc3NzNoMy41NzQydi0xLjY3OTdxMC0xLjg3NS0xLjEzMjgtMi45ODgzLTEuMTEzMy0xLjEzMjgtMy4zMjAzLTEuMTMyOC0yLjA1MDggMC0zLjMyMDMgMS4wMTU2LTEuMjUgMC45OTYxLTEuMjUgMi4zMjQyaC0zLjYxMzNxMC0yLjI2NTYgMi4yODUyLTQuMjU3OCAyLjI4NTItMS45OTIyIDYuMTEzMy0xLjk5MjIgMy40Mzc1IDAgNS42NDQ1IDEuNzU3OCAyLjIwNyAxLjc1NzggMi4yMDcgNS4zMTI1djkuNDkyMnEwIDIuOTI5NyAwLjc0MjE5IDQuNjQ4NHYwLjMxMjV6bS01Ljk5NjEtMi43NzM0cTEuOTUzMSAwIDMuMzc4OS0wLjk3NjU2IDEuNDQ1My0wLjk3NjU2IDIuMDMxMi0yLjE2OHYtNC4zNTU1aC0zLjM1OTRxLTYuMDkzOCAwLjExNzE5LTYuMDkzOCAzLjkwNjIgMCAxLjUwMzkgMS4wMTU2IDIuNTU4NiAxLjAxNTYgMS4wMzUyIDMuMDI3MyAxLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTIwMy4yMyAxMjguMjVxLTEuNzM4MyAwLTMuMDY2NCAwLjkzNzUtMS4zMjgxIDAuOTM3NS0yLjA4OTggMi40NDE0djE1LjA5OGgtMy42MTMzdi0yMS4xMzNoMy40MThsMC4xMTcxOSAyLjYzNjdxMi40MDIzLTMuMDI3MyA2LjMwODYtMy4wMjczIDMuMTA1NSAwIDQuOTIxOSAxLjczODMgMS44MzU5IDEuNzM4MyAxLjg1NTUgNS44Mzk4djEzLjk0NWgtMy42MzI4di0xMy44ODdxMC0yLjQ4MDUtMS4wOTM4LTMuNTM1Mi0xLjA3NDItMS4wNTQ3LTMuMTI1LTEuMDU0N3oiLz4KICA8cGF0aCBkPSJtNTcuOTQxIDE5NC4xNXExLjkzMzYgMCAzLjM3ODktMS4xNTIzIDEuNDY0OC0xLjE1MjMgMS42MDE2LTIuOTQ5MmgzLjQzNzVxLTAuMTM2NzIgMi44MzItMi41OTc3IDQuOTYwOS0yLjQ2MDkgMi4xMDk0LTUuODIwMyAyLjEwOTQtNC43NjU2IDAtNy4wODk4LTMuMTQ0NS0yLjMwNDctMy4xNDQ1LTIuMzA0Ny03LjQwMjN2LTAuODIwMzFxMC00LjI1NzggMi4zMDQ3LTcuNDAyNCAyLjMyNDItMy4xNDQ1IDcuMDg5OC0zLjE0NDUgMy43MTA5IDAgNS45OTYxIDIuMjA3IDIuMjg1MiAyLjE4NzUgMi40MjE5IDUuNDQ5MmgtMy40Mzc1cS0wLjEzNjcyLTEuOTUzMS0xLjQ4NDQtMy4zMjAzLTEuMzI4MS0xLjM2NzItMy40OTYxLTEuMzY3Mi0yLjIyNjYgMC0zLjQ5NjEgMS4xMzI4LTEuMjUgMS4xMzI4LTEuNzc3MyAyLjg3MTEtMC41MDc4MSAxLjczODMtMC41MDc4MSAzLjU3NDJ2MC44MjAzMXEwIDEuODU1NSAwLjUwNzgxIDMuNTkzOCAwLjUwNzgxIDEuNzM4MyAxLjc1NzggMi44NzExIDEuMjY5NSAxLjExMzMgMy41MTU2IDEuMTEzM3oiLz4KICA8cGF0aCBkPSJtNjkuNDY1IDE4NS45NXEwLTQuNTg5OCAyLjU3ODEtNy42NTYyIDIuNTc4MS0zLjA4NTkgNy4wMTE3LTMuMDg1OSA0LjQzMzYgMCA3LjAxMTcgMy4wMjczIDIuNTc4MSAzLjAwNzggMi42MzY3IDcuNTE5NXYwLjY0NDUzcTAgNC41ODk4LTIuNTk3NyA3LjY1NjItMi41NzgxIDMuMDY2NC03LjAxMTcgMy4wNjY0LTQuNDUzMSAwLTcuMDUwOC0zLjA2NjQtMi41NzgxLTMuMDY2NC0yLjU3ODEtNy42NTYyem0zLjYxMzMgMC40NDkyMnEwIDMuMTQ0NSAxLjQ4NDQgNS40NDkyIDEuNTAzOSAyLjMwNDcgNC41MzEyIDIuMzA0NyAyLjk0OTIgMCA0LjQ1MzEtMi4yNjU2IDEuNTAzOS0yLjI4NTIgMS41MjM0LTUuNDI5N3YtMC41MDc4MXEwLTMuMTA1NS0xLjUwMzktNS40Mjk3LTEuNTAzOS0yLjM0MzgtNC41MTE3LTIuMzQzOC0yLjk4ODMgMC00LjQ5MjIgMi4zNDM4LTEuNDg0NCAyLjMyNDItMS40ODQ0IDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTAyIDE3OC4yNXEtMS43MzgzIDAtMy4wNjY0IDAuOTM3NS0xLjMyODEgMC45Mzc1LTIuMDg5OCAyLjQ0MTR2MTUuMDk4aC0zLjYxMzN2LTIxLjEzM2gzLjQxOGwwLjExNzE5IDIuNjM2N3EyLjQwMjMtMy4wMjczIDYuMzA4Ni0zLjAyNzMgMy4xMDU1IDAgNC45MjE5IDEuNzM4MyAxLjgzNTkgMS43MzgzIDEuODU1NSA1LjgzOTh2MTMuOTQ1aC0zLjYzMjh2LTEzLjg4N3EwLTIuNDgwNS0xLjA5MzgtMy41MzUyLTEuMDc0Mi0xLjA1NDctMy4xMjUtMS4wNTQ3eiIvPgogIDxwYXRoIGQ9Im0xMjQuNDYgMTc4LjM3aC00LjMxNjR2MTguMzU5aC0zLjYxMzN2LTE4LjM1OWgtMy4zMzk4di0yLjc3MzRoMy4zMzk4di0xLjgzNTlxMC0zLjU5MzggMi4wNzAzLTUuNTA3OCAyLjA3MDMtMS45MzM2IDUuNjY0MS0xLjkzMzYgMi4xODc1IDAgNS41MjczIDEuMTkxNGwtMC42MDU0NiAzLjA0NjlxLTIuNTM5MS0wLjk5NjA5LTQuNjY4LTAuOTk2MDktMi4zMjQyIDAtMy4zNTk0IDEuMDU0Ny0xLjAxNTYgMS4wMzUyLTEuMDE1NiAzLjE0NDV2MS44MzU5aDQuMzE2NHptNy4xMDk0LTIuNzczNHYyMS4xMzNoLTMuNjEzM3YtMjEuMTMzeiIvPgogIDxwYXRoIGQ9Im0xNDUuNTIgMjA1LjA3cS0xLjY0MDYgMC00LjAyMzQtMC44MDA3OC0yLjM4MjgtMC44MDA3OC0zLjgwODYtMi44NzExbDEuODk0NS0yLjE0ODRxMi4zNDM4IDIuODUxNiA1LjY2NDEgMi44NTE2IDIuNTU4NiAwIDQuMDgyLTEuNDQ1MyAxLjUyMzQtMS40MjU4IDEuNTIzNC00LjE5OTJ2LTEuODU1NXEtMi4xNDg0IDIuNTE5NS01LjkxOCAyLjUxOTUtMy44MDg2IDAtNi4wNTQ3LTMuMDQ2OS0yLjI0NjEtMy4wNDY5LTIuMjQ2MS03LjY3NTh2LTAuNDEwMTZxMC00Ljg0MzggMi4yMjY2LTcuODEyNSAyLjI0NjEtMi45Njg4IDYuMTEzMy0yLjk2ODggMy44ODY3IDAgNi4wMzUyIDIuNzM0NGwwLjE3NTc4LTIuMzQzOGgzLjI4MTJ2MjAuNjg0cTAgNC4xOTkyLTIuNSA2LjQ4NDQtMi41IDIuMzA0Ny02LjQ0NTMgMi4zMDQ3em0tNS4yNzM0LTE4LjY3MnEwIDMuMTQ0NSAxLjMwODYgNS40MTAyIDEuMzI4MSAyLjI0NjEgNC4yNTc4IDIuMjQ2MSAzLjQzNzUgMCA1LjAzOTEtMy4xMjV2LTkuNjI4OXEtMC42ODM1OS0xLjMwODYtMS44OTQ1LTIuMTY4LTEuMjEwOS0wLjg3ODktMy4xMDU1LTAuODc4OS0yLjk0OTIgMC00LjI3NzMgMi4zMDQ3LTEuMzI4MSAyLjI4NTItMS4zMjgxIDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTczLjA2IDE5Ni43My0wLjA3ODEtMi4wODk4cS0yLjA3MDMgMi40ODA1LTYuMTcxOSAyLjQ4MDUtMy4xMDU1IDAtNS4wMTk1LTEuODM1OS0xLjkxNDEtMS44MzU5LTEuOTE0MS02LjA1NDd2LTEzLjYzM2gzLjYxMzN2MTMuNjcycTAgMi44NTE2IDEuMTkxNCAzLjgyODEgMS4yMTA5IDAuOTU3MDMgMi42OTUzIDAuOTU3MDMgNC4wODIgMCA1LjUwNzgtMy4wNjY0di0xNS4zOTFoMy42MzI4djIxLjEzM3oiLz4KICA8cGF0aCBkPSJtMTkwLjQ0IDE3OC42OHEtMy41MzUyIDAtNC44MjQyIDMuMDQ2OXYxNWgtMy42MTMzdi0yMS4xMzNoMy41MTU2bDAuMDc4MSAyLjQyMTlxMS43MzgzLTIuODEyNSA1LjAxOTUtMi44MTI1IDEuMDE1NiAwIDEuNjAxNiAwLjI3MzQ0bC0wLjAxOTUgMy4zNTk0cS0wLjgwMDc4LTAuMTU2MjUtMS43NTc4LTAuMTU2MjV6Ii8+CiAgPHBhdGggZD0ibTIxMS45MSAxOTMuMDRxLTEuMDM1MiAxLjU2MjUtMi45Mjk3IDIuODMyLTEuODk0NSAxLjI1LTUuMDE5NSAxLjI1LTQuNDE0MSAwLTcuMDcwMy0yLjg3MTEtMi42MzY3LTIuODcxMS0yLjYzNjctNy4zNDM4di0wLjgyMDMxcTAtMy40NTcgMS4zMDg2LTUuODc4OSAxLjMyODEtMi40NDE0IDMuNDM3NS0zLjcxMDkgMi4xMDk0LTEuMjg5MSA0LjQ5MjItMS4yODkxIDQuNTMxMiAwIDYuNjAxNiAyLjk2ODggMi4wODk4IDIuOTQ5MiAyLjA4OTggNy4zODI4djEuNjIxMWgtMTQuMjk3cTAuMDc4MSAyLjkxMDIgMS43MTg4IDQuOTYwOSAxLjY2MDIgMi4wMzEyIDQuNTUwOCAyLjAzMTIgMS45MTQxIDAgMy4yNDIyLTAuNzgxMjUgMS4zMjgxLTAuNzgxMjUgMi4zMjQyLTIuMDg5OHptLTguNDE4LTE0Ljg2M3EtMi4xNDg0IDAtMy42MzI4IDEuNTYyNS0xLjQ4NDQgMS41NjI1LTEuODU1NSA0LjQ5MjJoMTAuNTY2di0wLjI3MzQ0cS0wLjEzNjcyLTIuMTA5NC0xLjIzMDUtMy45NDUzLTEuMDc0Mi0xLjgzNTktMy44NDc3LTEuODM1OXoiLz4KICA8cGF0aCBkPSJtMjMwLjAzIDE5Ni43My0wLjE3NTc4LTIuMjY1NnEtMi4xNjggMi42NTYyLTYuMDM1MiAyLjY1NjItMy43MTA5IDAtNS45OTYxLTMuMDA3OC0yLjI4NTItMy4wMDc4LTIuMzI0Mi03LjU1ODZ2LTAuNTY2NDFxMC00Ljg0MzggMi4yODUyLTcuODEyNSAyLjMwNDctMi45Njg4IDYuMDc0Mi0yLjk2ODggMy43MzA1IDAgNS44NTk0IDIuNXYtMTAuOTc3aDMuNjMyOHYzMHptLTEwLjg5OC0xMC4zMzJxMCAzLjE0NDUgMS4zMjgxIDUuNDEwMiAxLjMyODEgMi4yNDYxIDQuMjU3OCAyLjI0NjEgMy4zNTk0IDAgNS0zLjA2NjR2LTkuNzI2NnEtMS42MjExLTMuMDA3OC00Ljk2MDktMy4wMDc4LTIuOTQ5MiAwLTQuMjk2OSAyLjMwNDctMS4zMjgxIDIuMjg1Mi0xLjMyODEgNS40Mjk3eiIvPgogPC9nPgo8L3N2Zz4K'\r\n        }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7cad1c71-0765-4277-32a8-c87808a0c689"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "4cc2a279-fbae-dce8-0827-5a24057fe53e",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "c12ec825-a7ef-cc4d-da3d-064fba7cc7d7": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1694019264779,
                "endTimeMs": 1694105664779
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Users",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "email",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Users",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "fbfce281-668f-0ad0-d8f4-6870d3ef679f",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "Email",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5669544029828533
                },
                {
                  "name": "firstName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.first-name}",
                  "color": "#4caf50",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.835575628975763,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.last-name}",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7276117794959098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [],
            "actionCellButton": [
              {
                "name": "{i18n:custom.user-management.edit-user}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editUserFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.user-management.edit-smart-retail-user' | translate }}</h2>\n     <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('required')\">\n            {{ 'custom.user-management.email-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('pattern')\">\n            {{ 'custom.user-management.invalid-value-format' | translate }}\n        </mat-error>\n    </mat-form-field>\n    <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.first-name' | translate }}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.last-name' | translate }}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editUserFormGroup.invalid || !editUserFormGroup.dirty\">\n      {{ 'custom.user-management.save-user' | translate }}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\n\nopenEditUserDialog();\n\nfunction openEditUserDialog() {\n  customDialog.customDialog(htmlTemplate, EditUserDialogController).subscribe();\n}\n\nfunction EditUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.user = {};\n  \n  vm.editUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null]\n  });\n  \n  getUser();\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    vm.editUserFormGroup.markAsPristine();\n    saveUserObservable().subscribe(\n      function () {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      }\n    );\n  };\n  \n  function getUser() {\n      userService.getUser(entityId.id).subscribe(\n          (user) => {\n                vm.user = user;          \n                vm.editUserFormGroup.patchValue({\n                  email: vm.user.email,\n                  firstName: vm.user.firstName,\n                  lastName: vm.user.lastName\n                }, {emitEvent: false});\n          }\n    );\n  }\n  \n  function saveUserObservable() {\n      const formValues = vm.editUserFormGroup.value;\n      vm.user.email = formValues.email;\n      vm.user.firstName = formValues.firstName;\n      vm.user.lastName = formValues.lastName;\n      return userService.saveUser(vm.user);\n  }\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.user-management.delete-user}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteUserDialog();\n\nfunction openDeleteUserDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.user-management.delete.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.user-management.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteUser();\n    }\n  });\n}\n\n\nfunction deleteUser() {\n  userService.deleteUser(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.user-management.add-user}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addUserFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.user-management.add-smart-retail-user' | translate }}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n            {{ 'custom.user-management.email-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n            {{ 'custom.user-management.invalid-value-format' | translate }}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.first-name' | translate }}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.last-name' | translate }}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>{{ 'custom.user-management.activation-method' | translate }}</mat-label>\n        <mat-select formControlName=\"userActivationMethod\">\n            <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n                {{ method.name }}\n            </mat-option>\n        </mat-select>\n    </mat-form-field>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      {{ 'custom.user-management.add-user' | translate }}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.activationMethods = [\n        {\n            value: 'displayActivationLink',\n            name: translationService.instant('custom.user-management.display-activation-link')\n        },\n        {\n            value: 'sendActivationMail',\n            name: translationService.instant('custom.user-management.send-activation-email')\n        }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    userActivationMethod: ['displayActivationLink']\n  });\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    var customerId;\n/*    var authority = widgetContext.currentUser.authority;\n    var stateParams = widgetContext.stateController.getStateParams();*/\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n    vm.addUserFormGroup.markAsPristine();\n/*    console.log(\"Customer ID: \" + customerId);\n    console.log(\"Authority: \" + authority);\n    console.log(\"State Params: \" + JSON.stringify(stateParams));*/\n    \n    const formValues = vm.addUserFormGroup.value;\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n    const sendActivationMail = (formValues.userActivationMethod === 'sendActivationMail');\n    \n    widgetContext.rxjs.forkJoin([\n        getTargetUserGroup(customerId), \n        getDashboardByName('Smart Diagnostics')\n    ]).pipe(\n        widgetContext.rxjs.switchMap((data) => {\n            var userGroup = data[0];\n            var defaultDashboard = data[1];\n            /*console.log(defaultDashboard);*/\n            if (defaultDashboard) {\n                user.additionalInfo = {\n                    defaultDashboardId: defaultDashboard.id.id,\n                    defaultDashboardFullscreen: true\n                };\n            }\n            /*console.log(\"user\", user);*/\n            return saveUserObservable(userGroup, user, sendActivationMail);\n        }),\n        // Added switchMap to save the 'role' attribute after the user is saved\n        widgetContext.rxjs.switchMap((savedUser) => {\n            // Define the attribute to be saved\n            const roleAttribute = {\n                key: 'role',\n                value: 'Belimo Retrofit Users'\n            };\n            \n            // Call the attributeService to save the attribute\n            return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n                // Pass the savedUser to the next operator\n                widgetContext.rxjs.map(() => savedUser)\n            );\n        })\n    ).subscribe((user) => {\n        widgetContext.updateAliases();\n        if (formValues.userActivationMethod === 'displayActivationLink') {\n            userService.getActivationLink(user.id.id).subscribe(\n                (activationLink) => {\n                    displayActivationLink(activationLink).subscribe(\n                        () => {\n                            vm.dialogRef.close(null);\n                        }\n                    );\n                }\n            );\n        } else {\n            vm.dialogRef.close(null);\n        }\n    });\n  };\n  \n  function saveUserObservable(userGroup, user, sendActivationMail) {\n      return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n  \n  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Users', customerId);\n          })\n      );\n  }\n  \n/*  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerAndType(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Users', customerId);\n          })\n      );\n  }*/\n  \n  function getOrCreateUserGroup(groups, groupName, customerId) {\n      var usersGroup = groups.find(group => group.name === groupName);\n      if (usersGroup) {\n          return widgetContext.rxjs.of(usersGroup);\n      } else {\n          usersGroup = {\n              type: 'USER',\n              name: groupName,\n              ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(usersGroup);\n      }\n  }\n  \n  function getDashboardByName(dashboardName) {\n      var dashboardsPageLink = widgetContext.pageLink(100, 0, dashboardName);\n      return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n          widgetContext.rxjs.map((data) => {\n            if (data.data.length) {\n                return data.data.find((dashboard) => dashboard.name === dashboardName);\n            } else {\n                return null;\n            }\n          })\n      );\n  }\n  \n    function displayActivationLink(activationLink) {\n        const template = '<form style=\"min-width: 400px;\">\\n' +\n            '  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\\n' +\n            '    <h2 translate>user.activation-link</h2>\\n' +\n            '        <span class=\"flex-1\"></span>\\n' +\n            '    <button mat-icon-button\\n' +\n            '            (click)=\"close()\"\\n' +\n            '            type=\"button\">\\n' +\n            '      <mat-icon class=\"material-icons\">close</mat-icon>\\n' +\n            '    </button>\\n' +\n            '  </mat-toolbar>\\n' +\n            '  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\\n' +\n            '  </mat-progress-bar>\\n' +\n            '  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\\n' +\n            '  <div mat-dialog-content tb-toast toastTarget=\"activationLinkDialogContent\">\\n' +\n            '    <div class=\"flex flex-col gap-0 sm:gap-2\">\\n' +\n            '      <span [innerHTML]=\"\\'user.activation-link-text\\' | translate: {activationLink: activationLink}\"></span>\\n' +\n            '      <div class=\"flex justify-center items-center\">\\n' +\n            '        <pre class=\"tb-highlight\" class=\"flex\"><code>{{ activationLink }}</code></pre>\\n' +\n            '        <button mat-icon-button\\n' +\n            '                color=\"primary\"\\n' +\n            '                ngxClipboard\\n' +\n            '                cbContent=\"{{ activationLink }}\"\\n' +\n            '                (cbOnSuccess)=\"onActivationLinkCopied()\"\\n' +\n            '                matTooltip=\"{{ \\'user.copy-activation-link\\' | translate }}\"\\n' +\n            '                matTooltipPosition=\"above\">\\n' +\n            '          <mat-icon svgIcon=\"mdi:clipboard-arrow-left\"></mat-icon>\\n' +\n            '        </button>\\n' +\n            '      </div>\\n' +\n            '    </div>\\n' +\n            '  </div>\\n' +\n            '  <div mat-dialog-actions class=\"flex justify-end gap-2\">\\n' +\n            '    <button mat-button color=\"primary\"\\n' +\n            '            type=\"button\"\\n' +\n            '            cdkFocusInitial\\n' +\n            '            [disabled]=\"(isLoading$ | async)\"\\n' +\n            '            (click)=\"close()\">\\n' +\n            '      {{ \\'action.ok\\' | translate }}\\n' +\n            '    </button>\\n' +\n            '  </div>\\n' +\n            '</form>';\n        return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink});\n    }\n\n    function ActivationLinkDialogController(instance) {\n        var vm = instance;\n\n        vm.activationLink = instance.data.activationLink;\n\n        vm.onActivationLinkCopied = onActivationLinkCopied;\n        vm.close = close;\n\n        function onActivationLinkCopied(){\n            widgetContext.showSuccessToast(translate.instant('user.activation-link-copied-message'), 1000, 'bottom', 'left', 'activationLinkDialogContent');\n        }\n\n        function close() {\n            vm.dialogRef.close(null);\n        }\n    }\n  \n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "c12ec825-a7ef-cc4d-da3d-064fba7cc7d7",
        "typeFullFqn": "system.cards.entities_table"
      },
      "2131ced7-032b-7d7f-1c04-917bd7a89699": {
        "typeFullFqn": "system.cards.markdown_card",
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "2519c941-a1b9-45bd-9821-88acf22e10af",
              "dataKeys": [
                {
                  "name": "assignedTo",
                  "type": "attribute",
                  "label": "assignedTo",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.21981810512762745
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "b9cbe0a5-7efe-a173-4f8f-81c7c69ed24c",
              "dataKeys": [
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "progress",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.3833688932754432
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "a11b6c4c-e7f7-210b-79a7-2b5de01a5f87",
              "dataKeys": [
                {
                  "name": "role",
                  "type": "attribute",
                  "label": "role",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.5214076894341932
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1765453220664,
                "endTimeMs": 1765539620664
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "### Markdown/HTML card\n - **Current entity**: ${entityName}.\n - **Current value**: ${Temperature}.",
            "markdownTextFunction": "\n// Count entities from datasources using aliasName\n// aliasName \"All Diagnostic Kits\" -> Kits\n// aliasName \"All Projects\" -> Projects\n// aliasName \"All Users\" -> Users\n\nvar kitsTotal = 0, kitsAssigned = 0, kitsAvailable = 0;\nvar projectsTotal = 0, projectsPlanned = 0, projectsActive = 0, projectsFinished = 0, projectsAborted = 0;\nvar usersTotal = 0, usersAdmin = 0, usersEngineer = 0, usersUser = 0;\n\ndata.forEach(function(item) {\n  var alias = item.aliasName || '';\n\n  if (alias === 'All Diagnostic Kits') {\n    // Diagnostic Kits\n    kitsTotal++;\n    if (item.assignedTo && item.assignedTo !== 'None' && item.assignedTo !== '') {\n      kitsAssigned++;\n    } else {\n      kitsAvailable++;\n    }\n  } else if (alias === 'All Projects') {\n    // Projects\n    projectsTotal++;\n    var progress = item.progress || '';\n    if (progress === 'in preparation' || progress === 'planned') {\n      projectsPlanned++;\n    } else if (progress === 'active') {\n      projectsActive++;\n    } else if (progress === 'finished') {\n      projectsFinished++;\n    } else if (progress === 'aborted') {\n      projectsAborted++;\n    }\n  } else if (alias === 'All Users') {\n    // Users\n    usersTotal++;\n    var role = (item.role || '').toLowerCase();\n    if (role.includes('administrator')) {\n      usersAdmin++;\n    } else if (role.includes('engineer')) {\n      usersEngineer++;\n    } else {\n      usersUser++;\n    }\n  }\n});\n\nreturn `\n<div class=\"tile-container\">\n\n  <!-- Diagnostic Kits -->\n  <div class=\"slider-card kits\">\n    <div class=\"card-header\">\n      <mat-icon class=\"card-icon\">medical_services</mat-icon>\n      <h2 class=\"card-title\">Diagnostic Kits</h2>\n    </div>\n    <div class=\"card-stats\">\n      <div class=\"stat-total\">${kitsTotal}</div>\n      <div class=\"stat-breakdown\">\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot assigned\"></span>Assigned</span>\n          <span class=\"stat-value\">${kitsAssigned}</span>\n        </div>\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot available\"></span>Available</span>\n          <span class=\"stat-value\">${kitsAvailable}</span>\n        </div>\n      </div>\n    </div>\n    <div class=\"card-divider\"></div>\n    <div class=\"card-footer\">\n      <a id=\"btn-manage-kits\" class=\"card-button\" role=\"button\">\n        <mat-icon>arrow_forward</mat-icon>\n        Manage Kits\n      </a>\n    </div>\n  </div>\n\n  <!-- Projects -->\n  <div class=\"slider-card projects\">\n    <div class=\"card-header\">\n      <mat-icon class=\"card-icon\">folder_open</mat-icon>\n      <h2 class=\"card-title\">Projects</h2>\n    </div>\n    <div class=\"card-stats\">\n      <div class=\"stat-total\">${projectsTotal}</div>\n      <div class=\"stat-breakdown\">\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot planned\"></span>Planned</span>\n          <span class=\"stat-value\">${projectsPlanned}</span>\n        </div>\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot active\"></span>Active</span>\n          <span class=\"stat-value\">${projectsActive}</span>\n        </div>\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot finished\"></span>Finished</span>\n          <span class=\"stat-value\">${projectsFinished}</span>\n        </div>\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot aborted\"></span>Aborted</span>\n          <span class=\"stat-value\">${projectsAborted}</span>\n        </div>\n      </div>\n    </div>\n    <div class=\"card-divider\"></div>\n    <div class=\"card-footer\">\n      <a id=\"btn-manage-projects\" class=\"card-button\" role=\"button\">\n        <mat-icon>arrow_forward</mat-icon>\n        Manage Projects\n      </a>\n    </div>\n  </div>\n\n  <!-- Users -->\n  <div class=\"slider-card users\">\n    <div class=\"card-header\">\n      <mat-icon class=\"card-icon\">group</mat-icon>\n      <h2 class=\"card-title\">Users</h2>\n    </div>\n    <div class=\"card-stats\">\n      <div class=\"stat-total\">${usersTotal}</div>\n      <div class=\"stat-breakdown\">\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot admin\"></span>Administrators</span>\n          <span class=\"stat-value\">${usersAdmin}</span>\n        </div>\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot engineer\"></span>Engineers</span>\n          <span class=\"stat-value\">${usersEngineer}</span>\n        </div>\n        <div class=\"stat-row\">\n          <span class=\"stat-label\"><span class=\"stat-dot user\"></span>Users</span>\n          <span class=\"stat-value\">${usersUser}</span>\n        </div>\n      </div>\n    </div>\n    <div class=\"card-divider\"></div>\n    <div class=\"card-footer\">\n      <a id=\"btn-manage-users\" class=\"card-button\" role=\"button\">\n        <mat-icon>arrow_forward</mat-icon>\n        Manage Users\n      </a>\n    </div>\n  </div>\n\n</div>\n`;\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": "/* === Root === */\n:host {\n    display: block;\n    height: 100%;\n}\n\n/* === Container === */\n.tile-container {\n    display: flex;\n    gap: 2rem;\n    width: 100%;\n    height: 100%;\n    justify-content: center;\n    align-items: stretch;\n    box-sizing: border-box;\n    padding: 1.5rem;\n}\n\n/* === Card === */\n.slider-card {\n    background: linear-gradient(135deg, var(--card-color) 0%, var(--card-color-dark) 100%);\n    border-radius: 12px;\n    display: flex;\n    flex-direction: column;\n    width: 100%;\n    max-width: 340px;\n    min-height: 280px;\n    padding: 1.5rem 1.75rem;\n    position: relative;\n    transition: transform 0.2s ease, box-shadow 0.2s ease;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n}\n\n.slider-card:hover {\n    transform: translateY(-4px);\n    box-shadow: 0 8px 24px rgba(0,0,0,0.15);\n}\n\n/* Card Colors */\n.slider-card.kits {\n    --card-color: #3a6a9e;\n    --card-color-dark: #2c5278;\n}\n.slider-card.projects {\n    --card-color: #26a69a;\n    --card-color-dark: #00897b;\n}\n.slider-card.users {\n    --card-color: #9c27b0;\n    --card-color-dark: #7b1fa2;\n}\n\n/* === Header === */\n.card-header {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n    margin-bottom: 1.25rem;\n}\n\n.card-icon {\n    font-size: 2.5rem !important;\n    width: 2.5rem !important;\n    height: 2.5rem !important;\n    color: rgba(255,255,255,0.9);\n}\n\n.card-title {\n    font-size: 1.1rem;\n    font-weight: 600;\n    color: #ffffff;\n    margin: 0;\n    letter-spacing: 0.02em;\n}\n\n/* === Stats === */\n.card-stats {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n}\n\n.stat-total {\n    font-size: 3.5rem;\n    font-weight: 700;\n    color: #ffffff;\n    line-height: 1;\n    margin-bottom: 1.25rem;\n}\n\n.stat-breakdown {\n    display: flex;\n    flex-direction: column;\n    gap: 0.6rem;\n}\n\n.stat-row {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    font-size: 0.9rem;\n    color: rgba(255,255,255,0.9);\n}\n\n.stat-label {\n    display: flex;\n    align-items: center;\n    gap: 0.6rem;\n}\n\n/* ECO Colors for stat dots */\n.stat-dot {\n    width: 10px;\n    height: 10px;\n    border-radius: 50%;\n    background-color: rgba(255,255,255,0.5);\n}\n\n/* Diagnostic Kits */\n.stat-dot.assigned { background-color: #EB5757; }  /* red */\n.stat-dot.available { background-color: #27AE60; } /* green */\n\n/* Projects */\n.stat-dot.planned { background-color: #F2994A; }   /* orange */\n.stat-dot.active { background-color: #27AE60; }    /* green */\n.stat-dot.finished { background-color: #2F80ED; }  /* blue */\n\n/* Users */\n.stat-dot.admin { background-color: #EB5757; }     /* red */\n.stat-dot.engineer { background-color: #2F80ED; }  /* blue */\n.stat-dot.user { background-color: #27AE60; }      /* green */\n\n.stat-value {\n    font-weight: 600;\n    font-size: 0.95rem;\n}\n\n/* === Divider === */\n.card-divider {\n    width: 100%;\n    height: 1px;\n    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);\n    margin: 1.25rem 0;\n}\n\n/* === Footer === */\n.card-footer {\n    margin-top: auto;\n}\n\n.card-button {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.7rem 1.4rem;\n    background: rgba(255,255,255,0.15);\n    border: 1px solid rgba(255,255,255,0.4);\n    border-radius: 6px;\n    color: #ffffff;\n    font-size: 0.875rem;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    text-decoration: none;\n}\n\n.card-button:hover {\n    background: rgba(255,255,255,0.95);\n    color: var(--card-color-dark);\n    border-color: transparent;\n}\n\n.card-button mat-icon {\n    font-size: 18px !important;\n    width: 18px !important;\n    height: 18px !important;\n}\n\n/* === Responsive === */\n@media (max-width: 1100px) {\n    .tile-container {\n        flex-wrap: wrap;\n        gap: 1.5rem;\n    }\n    .slider-card {\n        flex: 1 1 calc(50% - 1rem);\n        max-width: unset;\n    }\n}\n\n@media (max-width: 700px) {\n    .tile-container {\n        padding: 1rem;\n    }\n    .slider-card {\n        flex: 1 1 100%;\n    }\n}\n\n/* Aborted - red color */\n.stat-dot.aborted { background-color: #EB5757; }  /* red */\n"
          },
          "title": "Customer Overview",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "actions": {
            "elementClick": [
              {
                "name": "btn-manage-kits",
                "icon": "arrow_forward",
                "type": "custom",
                "customFunction": "\nconst $injector = widgetContext.$scope.$injector;\nconst entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nconst rxjs = widgetContext.rxjs;\nconst forkJoin = rxjs.forkJoin;\nconst of = rxjs.of;\nconst map = rxjs.map;\nconst switchMap = rxjs.switchMap;\nconst catchError = rxjs.catchError;\n\n// Create pageLink correctly\nconst pageLink = widgetContext.pageLink(1, 0, null, null, null);\n\n// Get current user info\nconst currentUser = widgetContext.currentUser;\nconst isTenantAdmin = currentUser.authority === 'TENANT_ADMIN';\n\n// Get owner ID based on user type\nlet ownerId;\nif (isTenantAdmin) {\n    ownerId = { id: currentUser.tenantId, entityType: 'TENANT' };\n} else {\n    ownerId = { id: currentUser.customerId, entityType: 'CUSTOMER' };\n}\n\n// Helper: get entity count from group by name\nfunction getGroupCount(groups, groupName) {\n    const group = groups.find(g => g.name === groupName);\n    if (!group) {\n        return of(0);\n    }\n    // Use correct pageLink\n    return entityGroupService.getEntityGroupEntities(group.id.id, pageLink).pipe(\n        map(response => response.totalElements || 0),\n        catchError((err) => {\n            console.error('Error getting group count for ' + groupName, err);\n            return of(0);\n        })\n    );\n}\n\n// Fetch all ASSET groups for this owner\nentityGroupService.getEntityGroupsByOwnerId(ownerId.entityType, ownerId.id, 'ASSET').pipe(\n    switchMap((groups) => {\n        return forkJoin({\n            total: getGroupCount(groups, 'Diagnostickits'),\n            assigned: getGroupCount(groups, 'Assigned Diagnostic Kits'),\n            unassigned: getGroupCount(groups, 'Unassigned Diagnostic Kits')\n        });\n    }),\n    catchError((err) => {\n        console.error('Error fetching kit counts:', err);\n        return of({ total: 0, assigned: 0, unassigned: 0 });\n    })\n).subscribe(counts => {\n    const params = widgetContext.stateController.getStateParams();\n\n    // Add customer info for Customer Users\n    if (!isTenantAdmin) {\n        params.entityId = { id: currentUser.customerId, entityType: 'CUSTOMER' };\n        params.entityName = currentUser.customerTitle || '';\n        params.entityLabel = currentUser.customerTitle || '';\n    }\n\n    params.kitsTotal = counts.total;\n    params.kitsAssigned = counts.assigned;\n    params.kitsAvailable = counts.unassigned;\n    widgetContext.stateController.openState('manage_diagnostickits', params);\n});\n",
                "id": "act-manage-kits"
              },
              {
                "name": "btn-manage-projects",
                "icon": "arrow_forward",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "act-manage-projects",
                "customFunction": "\n// Get current user info\nconst currentUser = widgetContext.currentUser;\nconst customerId = currentUser.customerId;\n\n// Build stateParams with customer info\nconst params = widgetContext.stateController.getStateParams();\nparams.entityId = { id: customerId, entityType: 'CUSTOMER' };\nparams.entityName = currentUser.customerTitle || '';\nparams.entityLabel = currentUser.customerTitle || '';\n\n// Open manage_projects state with customer context\nwidgetContext.stateController.openState('manage_projects', params);\n"
              },
              {
                "name": "btn-manage-users",
                "icon": "arrow_forward",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "act-manage-users",
                "customFunction": "\n// Get current user info\nconst currentUser = widgetContext.currentUser;\nconst customerId = currentUser.customerId;\n\n// Build stateParams with customer info\nconst params = widgetContext.stateController.getStateParams();\nparams.entityId = { id: customerId, entityType: 'CUSTOMER' };\nparams.entityName = currentUser.customerTitle || '';\nparams.entityLabel = currentUser.customerTitle || '';\n\n// Open manage_users state with customer context\nwidgetContext.stateController.openState('manage_users', params);\n"
              }
            ]
          },
          "enableDataExport": false,
          "borderRadius": "8px",
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": ""
        },
        "row": 0,
        "col": 0,
        "id": "2131ced7-032b-7d7f-1c04-917bd7a89699"
      },
      "f5be3f90-8574-86fb-1e71-7381ecb6956d": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "203b0867-b867-ef98-1791-03046c133b7d",
              "dataKeys": [
                {
                  "name": "role",
                  "type": "attribute",
                  "label": "role",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.8853142583803868
                },
                {
                  "name": "ownerName",
                  "type": "entityField",
                  "label": "customer",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.48497657295220475,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "d75c5b86-8b39-59e2-59f3-ae1c1ee40910",
              "dataKeys": [
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "projectProgress",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.6077801146000442,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Name",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.8167362021349891
                },
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "selectedProgress",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.04285551819508693,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "c849d52c-a3c7-5008-a4c0-c2d0406fe515",
              "dataKeys": [
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "measurementProgress",
                  "color": "#607d8b",
                  "settings": {},
                  "_hash": 0.3810102775224764,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678196817440,
                "endTimeMs": 1678283217440
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "\n// Check if project is selected\nvar stateParams = ctx.stateController.getStateParams();\nvar selectedProject = stateParams.selectedProject;\nvar projectState = selectedProject ? true : false;\n\nctx.stateController.updateState(null, stateParams);\n\n// Get project info directly from stateParams (not from datasource!)\nvar selectedProjectName = '';\nvar selectedProjectLabel = '';\nif (selectedProject) {\n  selectedProjectName = selectedProject.entityName || '';\n  selectedProjectLabel = selectedProject.entityLabel || '';\n}\n\n// Datasources:\n// \"Current User\" -> role, customer\n// \"Project\" -> projectProgress (all projects from state entity)\n// \"Selected Project\" -> selectedProgress\n// \"Project Measurements\" -> measurementProgress\n\nvar userRole = '';\nvar customerName = '';\nvar projectsTotal = 0, projectsPlanned = 0, projectsActive = 0, projectsFinished = 0, projectsAborted = 0;\nvar selectedProgress = '';\nvar measurementsTotal = 0;\n\ndata.forEach(function(item) {\n  var alias = item.aliasName || '';\n\n  if (alias === 'Current User') {\n    userRole = item.role || '';\n    customerName = item.customer || '';\n  } else if (alias === 'Project') {\n    // Changed from \"All Projects\" to \"Project\" to match actual datasource alias\n    projectsTotal++;\n    var progress = (item.projectProgress || '').toLowerCase();\n    if (progress === 'in preparation' || progress === 'planned') {\n      projectsPlanned++;\n    } else if (progress === 'active') {\n      projectsActive++;\n    } else if (progress === 'finished') {\n      projectsFinished++;\n    } else if (progress === 'aborted') {\n      projectsAborted++;\n    }\n  } else if (alias === 'Selected Project') {\n    selectedProgress = item.selectedProgress || 'in preparation';\n  } else if (alias === 'Project Measurements') {\n    measurementsTotal++;\n  }\n});\n\nvar isTenantAdmin = ctx.currentUser.authority === 'TENANT_ADMIN';\nvar isEcoAdmin = userRole === 'ECO Administrator';\nvar isRestrictedUser = userRole === 'Belimo Retrofit Users' || userRole === 'ECO Diagnostics Users' || userRole === 'Users' || userRole === 'User';\nvar canManage = isTenantAdmin || isEcoAdmin || !isRestrictedUser;\nstateParams['userRole'] = userRole;\nctx.stateController.updateState(null, stateParams);\n\nvar headerHtml = '';\nvar contentHtml = '';\n\nif (projectState) {\n  // === PROJECT DETAIL VIEW ===\n  var progressClass = (selectedProgress || 'in-preparation').toLowerCase().replace(' ', '-');\n  var progressLabel = selectedProgress || 'In Preparation';\n  if (progressLabel.toLowerCase() === 'in preparation') progressLabel = 'In Preparation';\n\n  // Title: entityName - entityLabel (or just entityName if no label)\n  var titleText = selectedProjectLabel ? (selectedProjectName + ' - ' + selectedProjectLabel) : selectedProjectName;\n\n  headerHtml = '<div class=\"manage-header projects\">' +\n      '<div class=\"header-left\">' +\n          '<a id=\"btn-go-back\" class=\"back-button\" role=\"button\" title=\"Go Back\">' +\n              '<mat-icon>arrow_back</mat-icon>' +\n          '</a>' +\n          '<div class=\"header-title\">' +\n              '<h1><mat-icon>folder_open</mat-icon>' + titleText + '</h1>' +\n              '<div class=\"header-stats\">' +\n                  '<span class=\"stat-item\"><span class=\"stat-dot ' + progressClass + '\"></span>' + progressLabel + '</span>' +\n                  '<span class=\"stat-item\"><span class=\"stat-value\">' + measurementsTotal + '</span> Measurements</span>' +\n              '</div>' +\n          '</div>' +\n      '</div>' +\n      '<div class=\"header-right\">' +\n          (canManage ? '<a id=\"btn-add-measurement\" class=\"header-action-btn\" role=\"button\" title=\"Add Measurement\"><mat-icon>add</mat-icon>Add Measurement</a>' : '') +\n          (canManage ? '<a id=\"btn-project-wizard\" class=\"header-action-btn wizard\" role=\"button\" title=\"Project Wizard\"><mat-icon>rocket_launch</mat-icon>Project Wizard</a>' : '') +\n      '</div>' +\n  '</div>';\n\n  contentHtml = '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"project_measurements\"></tb-dashboard-state>';\n\n} else {\n  // === PROJECT LIST VIEW ===\n  headerHtml = '<div class=\"manage-header projects\">' +\n      '<div class=\"header-left\">' +\n          '<a id=\"btn-go-back\" class=\"back-button\" role=\"button\" title=\"Go Back\">' +\n              '<mat-icon>arrow_back</mat-icon>' +\n          '</a>' +\n          '<div class=\"header-title\">' +\n              '<h1><mat-icon>folder_open</mat-icon>Projects</h1>' +\n              '<div class=\"header-stats\">' +\n                  '<span class=\"stat-item\"><span class=\"stat-dot total\"></span><span class=\"stat-value\">' + projectsTotal + '</span> Total</span>' +\n                  '<span class=\"stat-item\"><span class=\"stat-dot planned\"></span><span class=\"stat-value\">' + projectsPlanned + '</span> Planned</span>' +\n                  '<span class=\"stat-item\"><span class=\"stat-dot active\"></span><span class=\"stat-value\">' + projectsActive + '</span> Active</span>' +\n                  '<span class=\"stat-item\"><span class=\"stat-dot finished\"></span><span class=\"stat-value\">' + projectsFinished + '</span> Finished</span>' +\n                  '<span class=\"stat-item\"><span class=\"stat-dot aborted\"></span><span class=\"stat-value\">' + projectsAborted + '</span> Aborted</span>' +\n              '</div>' +\n          '</div>' +\n      '</div>' +\n      '<div class=\"header-right\">' +\n          (canManage ? '<a id=\"btn-add-project\" class=\"header-action-btn\" role=\"button\" title=\"Add Project\"><mat-icon>add</mat-icon>Add Project</a>' : '') +\n      '</div>' +\n  '</div>';\n\n  contentHtml = '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"projects_all\"></tb-dashboard-state>';\n}\n\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\n       headerHtml +\n       contentHtml +\n       '</div>';\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget {\n    border-radius: 0px;\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n/* === Reusable Manage Header === */\n.manage-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem;\n    border-radius: 8px;\n    color: #ffffff;\n    min-height: 70px;\n    margin-bottom: 1rem;\n}\n\n.manage-header.kits {\n    background: linear-gradient(135deg, #3a6a9e 0%, #2c5278 100%);\n}\n\n.manage-header.projects {\n    background: linear-gradient(135deg, #26a69a 0%, #00897b 100%);\n}\n\n.manage-header.users {\n    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);\n}\n\n.header-left {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n}\n\n.back-button {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    width: 40px;\n    height: 40px;\n    background: rgba(255,255,255,0.15);\n    border: 1px solid rgba(255,255,255,0.3);\n    border-radius: 8px;\n    color: #ffffff;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    text-decoration: none;\n}\n\n.back-button:hover {\n    background: rgba(255,255,255,0.25);\n}\n\n.back-button mat-icon {\n    font-size: 24px !important;\n    width: 24px !important;\n    height: 24px !important;\n}\n\n.header-title {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n}\n\n.header-title h1 {\n    font-size: 1.4rem;\n    font-weight: 600;\n    margin: 0;\n    display: flex;\n    align-items: center;\n    gap: 0.6rem;\n}\n\n.header-title h1 mat-icon {\n    font-size: 26px !important;\n    width: 26px !important;\n    height: 26px !important;\n    opacity: 0.9;\n}\n\n.header-stats {\n    display: flex;\n    gap: 1.25rem;\n    font-size: 0.85rem;\n    opacity: 0.9;\n}\n\n.stat-item {\n    display: flex;\n    align-items: center;\n    gap: 0.35rem;\n}\n\n.stat-dot {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n}\n\n.stat-dot.total { background-color: #ffffff; }\n.stat-dot.assigned { background-color: #EB5757; }\n.stat-dot.available { background-color: #27AE60; }\n.stat-dot.planned { background-color: #F2994A; }\n.stat-dot.in-preparation { background-color: #F2994A; }\n.stat-dot.active { background-color: #27AE60; }\n.stat-dot.finished { background-color: #2F80ED; }\n.stat-dot.aborted { background-color: #EB5757; }\n.stat-dot.admin { background-color: #EB5757; }\n.stat-dot.engineer { background-color: #2F80ED; }\n.stat-dot.user { background-color: #27AE60; }\n\n.stat-value {\n    font-weight: 600;\n}\n\n.header-right {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n}\n\n.header-action-btn {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.6rem 1.2rem;\n    background: rgba(255,255,255,0.15);\n    border: 1px solid rgba(255,255,255,0.4);\n    border-radius: 6px;\n    color: #ffffff !important;\n    font-size: 0.875rem;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    text-decoration: none;\n}\n\n.header-action-btn mat-icon {\n    color: #ffffff !important;\n}\n\n.header-action-btn:hover {\n    background: rgba(255,255,255,0.95);\n    color: #2c5278 !important;\n    border-color: transparent;\n}\n\n.header-action-btn:hover mat-icon {\n    color: #2c5278 !important;\n}\n\n/* Project Wizard Button - distinct styling */\n.header-action-btn.wizard {\n    background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);\n    border-color: transparent;\n}\n\n.header-action-btn.wizard:hover {\n    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);\n    color: #ffffff !important;\n    transform: translateY(-1px);\n    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);\n}\n\n.header-action-btn.wizard:hover mat-icon {\n    color: #ffffff !important;\n}\n\n/* Force white text in manage-header */\n.manage-header,\n.manage-header h1,\n.manage-header .header-title,\n.manage-header .header-stats,\n.manage-header .stat-item,\n.manage-header .stat-value,\n.manage-header mat-icon {\n    color: #ffffff !important;\n}\n\n.content-area {\n    flex: 1;\n    overflow: hidden;\n}\n\n.main-layout .header {\n    height: 60px;\n    margin: 4px;\n}\n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n/* Flexbox height fix - prevent scrolling */\n.main-layout {\n    display: flex;\n    flex-direction: column;\n    min-height: 0;\n    overflow: hidden;\n}\n\n.main-layout > .manage-header {\n    flex: 0 0 auto;\n}\n\n.main-layout > tb-dashboard-state {\n    flex: 1 1 auto;\n    min-height: 0;\n    height: 100%;\n    overflow: hidden;\n}\n\n/* Ensure parent containers also have proper height */\n.tb-markdown-view {\n    height: 100%;\n    overflow: hidden;\n}\n\n.tb-markdown-view > div {\n    height: 100%;\n    overflow: hidden;\n}\n"
          },
          "title": "Manage Projects Header",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow.no-padding {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 4px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "btn-go-back",
                "icon": "arrow_back",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nvar number = (widgetContext.stateController.getStateIndex())-1;\nwidgetContext.stateController.updateState(null, params);\nwidgetContext.stateController.navigatePrevState(number);",
                "id": "act-go-back"
              },
              {
                "name": "btn-add-project",
                "icon": "add",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addProjectFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 600px; max-width: 90vw;\">\n  <mat-toolbar class=\"flex items-center\" color=\"primary\">\n    <mat-icon style=\"margin-right: 12px;\">folder_open</mat-icon>\n    <h2 style=\"margin: 0; font-size: 18px;\">Add Project</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col gap-3 p-4\">\n\n    <!-- Customer Section -->\n    <fieldset *ngIf=\"isTenantAdmin\" class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">business</mat-icon>\n        Customer\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Customer</mat-label>\n        <mat-select formControlName=\"customer\" (selectionChange)=\"onCustomerChange()\" required>\n          <mat-option *ngFor=\"let c of customers\" [value]=\"c\">{{ c.name }}</mat-option>\n        </mat-select>\n        <mat-error *ngIf=\"addProjectFormGroup.get('customer')?.hasError('required')\">Customer is required.</mat-error>\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Project Info Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">folder</mat-icon>\n        Project Info\n      </legend>\n      <tb-image-input formControlName=\"projectPicture\" label=\"Project Picture\" noImageText=\"No picture selected\"></tb-image-input>\n      <mat-form-field appearance=\"fill\" class=\"w-full disabled-field\">\n        <mat-label>Project ID</mat-label>\n        <input matInput formControlName=\"name\" required readonly>\n        <mat-error *ngIf=\"addProjectFormGroup.get('name').hasError('required')\">Project title is required.</mat-error>\n      </mat-form-field>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Label</mat-label>\n        <input matInput formControlName=\"entityLabel\">\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Address Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">location_on</mat-icon>\n        Address\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Project address</mat-label>\n        <input matInput formControlName=\"address\" [matAutocomplete]=\"addrAuto\" autocomplete=\"off\">\n        <button mat-icon-button matSuffix type=\"button\" (click)=\"searchAddress()\" [disabled]=\"(addProjectFormGroup.get('address').value || '').length < 5\">\n          <mat-icon>search</mat-icon>\n        </button>\n        <mat-autocomplete #addrAuto=\"matAutocomplete\" [displayWith]=\"displayAddressOption\" (optionSelected)=\"onAddressSelected($event.option.value)\">\n          <mat-option *ngFor=\"let opt of addressOptions\" [value]=\"opt\">{{ opt.label }}</mat-option>\n        </mat-autocomplete>\n        <mat-hint *ngIf=\"(addProjectFormGroup.get('address').value || '').length < 5\">Enter at least 5 characters to search</mat-hint>\n      </mat-form-field>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Postal Code</mat-label>\n          <input matInput formControlName=\"postalCode\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 2;\">\n          <mat-label>City</mat-label>\n          <input matInput formControlName=\"city\">\n        </mat-form-field>\n      </div>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Latitude</mat-label>\n          <input matInput formControlName=\"latitude\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Longitude</mat-label>\n          <input matInput formControlName=\"longitude\">\n        </mat-form-field>\n      </div>\n    </fieldset>\n\n  </div>\n  <div class=\"flex justify-end items-center gap-2 p-4\" style=\"border-top: 1px solid #e0e0e0; background: #fafafa;\">\n    <button mat-button (click)=\"cancel()\" type=\"button\">Cancel</button>\n    <button mat-raised-button color=\"primary\" type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addProjectFormGroup.invalid || !addProjectFormGroup.dirty\">\n      <mat-icon style=\"font-size: 18px; width: 18px; height: 18px; margin-right: 4px;\">save</mat-icon>\n      Save\n    </button>\n  </div>\n</form>",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled,\n.edit-project-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form .mdc-text-field--filled:not(.mdc-text-field--disabled),\n.edit-project-form .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .disabled-field input,\n.edit-project-form .disabled-field input {\n  color: rgba(0, 0, 0, 0.6) !important;\n}\n\n.add-entity-form .disabled-field,\n.edit-project-form .disabled-field {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\nmat-icon {\n  vertical-align: middle;\n  margin-right: 4px;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\n//let $scope = widgetContext.$scope;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\n\r\nlet shortNameAttr;\r\nlet customerShortName;\r\nlet nextProjectId = 0;\r\n\r\nconst ctx = widgetContext;\r\nconst isTenantAdmin = ctx.currentUser.authority === 'TENANT_ADMIN';\r\n\r\nlet customers = [];\r\nlet customerId;\r\nlet customerName;\r\n\r\nconst pageLink = ctx.pageLink(1000, 0, null, null, null);\r\n\r\ncustomerService.getUserCustomers(pageLink).subscribe(pageData => {\r\n\r\n    customers = (pageData && pageData.data) ? pageData.data : [];\r\n\r\n    // Non-Tenant-Admin → genau ein Customer\r\n    if (!isTenantAdmin && customers.length === 1) {\r\n        const c = customers[0];\r\n        customerId = {\r\n            id: c.id.id,\r\n            entityType: 'CUSTOMER'\r\n        };\r\n        customerName = c.name;\r\n    }\r\n\r\n    openAddProjectDialog();\r\n});\r\n\r\nfunction getLastProjectId(projects) {\r\n    let maxNumber = 0;\r\n    projects.forEach(item => {\r\n        const name = item.name;\r\n        const parts = name.split('_');\r\n        if (parts.length === 2) {\r\n            const number = parseInt(parts[1], 10);\r\n            if (number > maxNumber) {\r\n                maxNumber = number;\r\n            }\r\n        }\r\n    });\r\n    const nextProjectId = maxNumber + 1;\r\n    return nextProjectId;\r\n}\r\n\r\nfunction openAddProjectDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddProjectDialogController).subscribe();\r\n}\r\n\r\nfunction AddProjectDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.isTenantAdmin = isTenantAdmin;\r\n  vm.customers = customers;\r\n\r\nvm.addProjectFormGroup = vm.fb.group({\r\n    customer: [{ value: null, disabled: !isTenantAdmin }, vm.validators.required],\r\n    name: [{ value: '', disabled: true }, vm.validators.required],\r\n    entityLabel: [''],\r\n    projectPicture: [null],\r\n    address: [''],\r\n    postalCode: [''],\r\n    city: [''],\r\n    latitude: [''],\r\n    longitude: ['']\r\n});\r\n\r\n  // --- Address search state ---\r\n  vm.addressOptions = [];\r\n  vm._lastSelectedAddressLabel = null;\r\n\r\n  vm.displayAddressOption = function (opt) {\r\n    // MatAutocomplete calls displayWith with object OR string\r\n    if (!opt) return '';\r\n    return (typeof opt === 'string') ? opt : (opt.label || '');\r\n  };\r\n\r\n  vm.searchAddress = function () {\r\n    const qRaw = vm.addProjectFormGroup.get('address').value || '';\r\n    const q = (typeof qRaw === 'string') ? qRaw.trim() : vm.displayAddressOption(qRaw).trim();\r\n\r\n    if (q.length < 5) {\r\n      vm.addressOptions = [];\r\n      return;\r\n    }\r\n\r\n    searchAddressViaPhoton(q);\r\n  };\r\n\r\n  vm.onAddressSelected = function (opt) {\r\n    if (!opt) return;\r\n\r\n    vm._lastSelectedAddressLabel = opt.label;\r\n\r\n    // Patch-Objekt vorbereiten\r\n    const patchData = {\r\n      address: opt.label,\r\n      latitude: opt.lat,\r\n      longitude: opt.lon\r\n    };\r\n\r\n    // Nur postalCode und city setzen, wenn sie im Formular NICHT bereits ausgefüllt sind\r\n    const currentPostalCode = (vm.addProjectFormGroup.get('postalCode').value || '').trim();\r\n    const currentCity = (vm.addProjectFormGroup.get('city').value || '').trim();\r\n\r\n    if (!currentPostalCode && opt.postcode) {\r\n      patchData.postalCode = opt.postcode;\r\n    }\r\n    if (!currentCity && opt.city) {\r\n      patchData.city = opt.city;\r\n    }\r\n\r\n    vm.addProjectFormGroup.patchValue(patchData);\r\n\r\n    vm.addProjectFormGroup.get('address').markAsDirty();\r\n    vm.addProjectFormGroup.get('latitude').markAsDirty();\r\n    vm.addProjectFormGroup.get('longitude').markAsDirty();\r\n\r\n    if (!currentPostalCode && opt.postcode) {\r\n      vm.addProjectFormGroup.get('postalCode').markAsDirty();\r\n    }\r\n    if (!currentCity && opt.city) {\r\n      vm.addProjectFormGroup.get('city').markAsDirty();\r\n    }\r\n\r\n    // optional: Ergebnisse leeren, damit Dropdown zugeht\r\n    vm.addressOptions = [];\r\n  };\r\n\r\n  // --- Debounced auto-search without rxjs operators ---\r\n  let addrTimer = null;\r\n  let lastQuery = '';\r\n\r\n  vm.addProjectFormGroup.get('address').valueChanges.subscribe(val => {\r\n    // Wenn eine Auswahl gerade gesetzt wurde, nicht sofort neu suchen\r\n    if (typeof val === 'string' && vm._lastSelectedAddressLabel && val === vm._lastSelectedAddressLabel) {\r\n      return;\r\n    }\r\n\r\n    const s = (typeof val === 'string')\r\n      ? val.trim()\r\n      : (vm.displayAddressOption(val) || '').trim();\r\n\r\n    // Reset results for short strings\r\n    if (s.length < 5) {\r\n      vm.addressOptions = [];\r\n      lastQuery = s;\r\n      if (addrTimer) {\r\n        clearTimeout(addrTimer);\r\n        addrTimer = null;\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Simple distinctUntilChanged\r\n    if (s === lastQuery) {\r\n      return;\r\n    }\r\n    lastQuery = s;\r\n\r\n    // Debounce\r\n    if (addrTimer) {\r\n      clearTimeout(addrTimer);\r\n    }\r\n    addrTimer = setTimeout(() => {\r\n      searchAddressViaPhoton(s);\r\n    }, 350);\r\n  });\r\n\r\n\r\n  function searchAddressViaPhoton(query) {\r\n    // Hole postalCode und city aus dem Formular\r\n    const postalCode = (vm.addProjectFormGroup.get('postalCode').value || '').trim();\r\n    const city = (vm.addProjectFormGroup.get('city').value || '').trim();\r\n\r\n    // Verfeinerte Query erstellen\r\n    let refinedQuery = query;\r\n    if (postalCode) {\r\n      refinedQuery += ' ' + postalCode;\r\n    }\r\n    if (city) {\r\n      refinedQuery += ' ' + city;\r\n    }\r\n\r\n    const url =\r\n      'https://photon.komoot.io/api' +\r\n      '?q=' + encodeURIComponent(refinedQuery) +\r\n      '&limit=5';\r\n\r\n    fetch(url)\r\n      .then(res => {\r\n        if (!res.ok) throw new Error('HTTP ' + res.status);\r\n        return res.json();\r\n      })\r\n      .then(data => {\r\n        const features = (data && data.features) ? data.features : [];\r\n\r\n        vm.addressOptions = features.map(f => {\r\n          const p = f.properties || {};\r\n          const coords = (f.geometry && f.geometry.coordinates) ? f.geometry.coordinates : [null, null];\r\n          const lon = coords[0];\r\n          const lat = coords[1];\r\n\r\n          // Bausteine\r\n          const street = p.street || p.name || '';\r\n          const house = p.housenumber ? (' ' + p.housenumber) : '';\r\n          const place = (street + house).trim() || (p.label || p.name || '').trim();\r\n\r\n          const cc = (p.countrycode || '').toUpperCase();\r\n          const postcode = p.postcode || '';\r\n          const cityFromResult = p.city || p.town || p.village || p.state || '';\r\n\r\n          // Ziel-Format: \"Adresse, CC-PLZ Ort\"\r\n          let tail = '';\r\n          if (cc || postcode || cityFromResult) {\r\n            tail = (cc ? cc : '');\r\n            if (cc && postcode) tail += '-' + postcode;\r\n            else if (!cc && postcode) tail += postcode;\r\n            if ((cc || postcode) && cityFromResult) tail += ' ' + cityFromResult;\r\n            else if (!cc && !postcode && cityFromResult) tail += cityFromResult;\r\n          }\r\n\r\n          const label = tail ? (place + ', ' + tail) : place;\r\n\r\n          return {\r\n            label,\r\n            lat: (typeof lat === 'number') ? lat : parseFloat(lat),\r\n            lon: (typeof lon === 'number') ? lon : parseFloat(lon),\r\n            postcode: postcode,\r\n            city: cityFromResult,\r\n            raw: f\r\n          };\r\n        });\r\n      })\r\n      .catch(err => {\r\n        console.error('Address search failed', err);\r\n        vm.addressOptions = [];\r\n      });\r\n  }\r\n\r\n\r\n  \r\nif (!isTenantAdmin && customerId) {\r\n    vm.addProjectFormGroup.patchValue({\r\n        customer: customers[0]\r\n    });\r\n    vm.addProjectFormGroup.get('customer').markAsDirty();\r\n    loadCustomerData(customerId);\r\n}\r\n\r\n  \r\nvm.onCustomerChange = function () {\r\n    const c = vm.addProjectFormGroup.value.customer;\r\n    if (!c) return;\r\n\r\n    customerId = {\r\n        id: c.id.id,\r\n        entityType: 'CUSTOMER'\r\n    };\r\n    customerName = c.name;\r\n\r\n    loadCustomerData(customerId);\r\n};\r\n\r\n  \r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    vm.addProjectFormGroup.markAsPristine();\r\n    saveProjectObservable(customerId).subscribe(\r\n      function (Project) {\r\n          widgetContext.rxjs.forkJoin([\r\n              saveCustomerToProjectRelation(customerId, Project.id),\r\n              saveAttributes(Project.id)\r\n          ]).subscribe(\r\n              function () {\r\n                var params = widgetContext.stateController.getStateParams();\r\n                var selectedProject = params['selectedProject'];\r\n                params['selectedProject'] = { entityId: Project.id, entityName: Project.name, entityLabel: '' };\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              }\r\n        );\r\n      }\r\n    );\r\n  };\r\n  \r\nfunction loadCustomerData(customerId) {\r\n\r\n    let assetSearchQuery = {\r\n        parameters: {\r\n            rootId: customerId.id,\r\n            rootType: 'CUSTOMER',\r\n            direction: 'FROM',\r\n            relationTypeGroup: 'COMMON',\r\n            maxLevel: 10,\r\n            fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n    };\r\n\r\n    assetService.findByQuery(assetSearchQuery).subscribe(projects => {\r\n\r\n        nextProjectId = getLastProjectId(projects);\r\n\r\n        attributeService\r\n            .getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName'])\r\n            .subscribe(attributes => {\r\n\r\n                const shortNameAttr = attributes.find(a => a.key === 'shortName');\r\n                customerShortName = shortNameAttr\r\n                    ? shortNameAttr.value\r\n                    : customerName;\r\n\r\n                vm.addProjectFormGroup.patchValue({\r\n                    name: customerShortName + '_' + nextProjectId\r\n                });\r\n\r\n                vm.addProjectFormGroup.get('name').markAsDirty();\r\n            });\r\n    });\r\n}\r\n\r\n  function saveProjectObservable(customerId) {\r\n    return getProjectsGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((ProjectsGroup) => {\r\n            const formValues = vm.addProjectFormGroup.getRawValue();\r\n            let Project = {\r\n              name: formValues.name,\r\n              type: 'Project',\r\n              label: formValues.entityLabel,\r\n              customerId: customerId\r\n            };\r\n            return assetService.saveAsset(Project, ProjectsGroup.id.id)\r\n        })\r\n    );\r\n  }\r\n  \r\n  function getProjectsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var ProjectsGroup = entityGroups.find(group => group.name === 'Projects');\r\n              if (ProjectsGroup) {\r\n                  return widgetContext.rxjs.of(ProjectsGroup);\r\n              } else {\r\n                  ProjectsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Projects',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(ProjectsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n\r\n  function saveCustomerToProjectRelation(customerId, ProjectId) {\r\n      var relation = {\r\n          from: customerId,\r\n          to: ProjectId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  \r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n        {\r\n            key: 'latitude',\r\n            value: vm.addProjectFormGroup.value.latitude || 48.1406022\r\n        },\r\n        {\r\n            key: 'longitude',\r\n            value: vm.addProjectFormGroup.value.longitude || 16.2932688\r\n        },\r\n        {\r\n            key: 'address',\r\n            value: vm.addProjectFormGroup.value.address\r\n        },        \r\n        {\r\n            key: 'progress',\r\n            value: 'in preparation'\r\n        },\r\n        {\n            key: 'units',\n            value: 'metric'\n        }\n    ];\n    // Add projectPicture if provided\n    if (vm.addProjectFormGroup.value.projectPicture) {\n        attributesArray.push({\n            key: 'projectPicture',\n            value: vm.addProjectFormGroup.value.projectPicture\n        });\n    }\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "act-add-project"
              },
              {
                "name": "btn-add-measurement",
                "icon": "add",
                "type": "custom",
                "customFunction": {
                  "body": "const stateParams = widgetContext.stateController.getStateParams();\nconst selectedProject = stateParams.selectedProject;\n\nif (!selectedProject || !selectedProject.entityId || !selectedProject.entityId.id) {\n    console.error('No project selected. Please select a project first.');\n    return;\n}\n\nconst projectId = { id: selectedProject.entityId.id, entityType: 'ASSET' };\nconst projectName = selectedProject.entityName;\n\n// Determine customerId\nconst NULL_UUID = '13814000-1dd2-11b2-8080-808080808080';\nfunction isValidCustomerId(id) {\n    return id && id !== NULL_UUID;\n}\n\nconst userRole = stateParams.userRole;\nconst stateEntityId = stateParams.entityId;\nlet customerId;\n\nif ((widgetContext.currentUser.authority === 'TENANT_ADMIN' || userRole === 'ECO Administrator') && stateEntityId && stateEntityId.id && isValidCustomerId(stateEntityId.id)) {\n    customerId = stateEntityId;\n    openDialog();\n} else if (isValidCustomerId(widgetContext.currentUser.customerId)) {\n    customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\n    openDialog();\n} else {\n    // Fetch customerId from project asset\n    const $injector = widgetContext.$scope.$injector;\n    const assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n    assetService.getAsset(projectId.id).subscribe(projectAsset => {\n        if (projectAsset && projectAsset.customerId && isValidCustomerId(projectAsset.customerId.id)) {\n            customerId = projectAsset.customerId;\n            openDialog();\n        } else {\n            console.error('Cannot determine customerId. Project has no valid customer assigned.');\n        }\n    });\n}\n\nfunction openDialog() {\n    projectWizard.openAddMeasurementDialog(widgetContext, projectId, projectName, customerId, function(result) {\n        // Update state params with new measurement\n        const params = widgetContext.stateController.getStateParams();\n        params['selectedMeasurement'] = {\n            entityId: result.id,\n            entityName: result.name,\n            entityLabel: result.label || ''\n        };\n        widgetContext.updateAliases();\n\n        // If connectKit checkbox was checked and it's ultrasonic, open connect dialog\n        if (result.connectKit && result.measurementType === 'ultrasonic') {\n            dataImporter.dataConnectorDialog(widgetContext, result.id, result.name);\n        }\n    });\n}",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                    "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "id": "act-add-measurement"
              },
              {
                "name": "btn-project-wizard",
                "icon": "rocket_launch",
                "type": "custom",
                "customFunction": {
                  "body": "const stateParams = widgetContext.stateController.getStateParams();\nconst selectedProject = stateParams.selectedProject;\n\nif (!selectedProject || !selectedProject.entityId || !selectedProject.entityId.id) {\n    console.error('No project selected. Please select a project first.');\n    return;\n}\n\nconst projectId = { id: selectedProject.entityId.id, entityType: 'ASSET' };\nconst projectName = selectedProject.entityName || '';\nconst projectLabel = selectedProject.entityLabel || '';\n\nprojectWizard.openProjectWizardDialog(widgetContext, projectId, projectName, projectLabel, function() {\n    widgetContext.updateAliases();\n}, { dataImporter: dataImporter });",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                    "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "id": "act-project-wizard"
              }
            ]
          },
          "pageSize": 1024,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "borderRadius": "8"
        },
        "row": 0,
        "col": 0,
        "id": "f5be3f90-8574-86fb-1e71-7381ecb6956d",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "03ceaaed-0eb5-4d4e-a3ef-0c4394cb2cb8": {
        "typeFullFqn": "system.map",
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1745755787013,
                "endTimeMs": 1745842187013
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": false,
          "backgroundColor": "rgba(0, 0, 0, 0)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "mapType": "geoMap",
            "layers": [
              {
                "label": "{i18n:widgets.maps.layer.roadmap}",
                "provider": "openstreet",
                "layerType": "CartoDB.Positron",
                "referenceLayer": null
              },
              {
                "label": "{i18n:widgets.maps.layer.satellite}",
                "provider": "openstreet",
                "layerType": "Esri.WorldImagery"
              },
              {
                "label": "{i18n:widgets.maps.layer.hybrid}",
                "provider": "openstreet",
                "layerType": "Esri.WorldImagery",
                "referenceLayer": "openstreetmap_hybrid"
              },
              {
                "label": "{i18n:widgets.maps.layer.topographic}",
                "provider": "openstreet",
                "layerType": "Esri.WorldTopoMap",
                "referenceLayer": null
              },
              {
                "label": null,
                "provider": "openstreet",
                "layerType": "OpenStreetMap.HOT",
                "referenceLayer": null
              },
              {
                "label": null,
                "provider": "openstreet",
                "layerType": "Esri.WorldStreetMap",
                "referenceLayer": null
              },
              {
                "provider": "openstreet",
                "layerType": "OpenStreetMap.Mapnik"
              }
            ],
            "imageSource": null,
            "markers": [
              {
                "dsType": "entity",
                "dsLabel": "",
                "dsDeviceId": null,
                "dsEntityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
                "dsFilterId": "3744b253-8d5c-7528-b178-0c8be5c3adca",
                "additionalDataSources": null,
                "additionalDataKeys": [
                  {
                    "name": "progress",
                    "type": "attribute",
                    "label": "progress",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.9725950885098493
                  },
                  {
                    "name": "name",
                    "type": "entityField",
                    "label": "name",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.2872987416504812,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  },
                  {
                    "name": "address",
                    "type": "attribute",
                    "label": "address",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8026110588871542
                  },
                  {
                    "name": "outsideTemp",
                    "type": "timeseries",
                    "label": "outsideTemp",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.759902282076257
                  },
                  {
                    "name": "outsideHumidity",
                    "type": "timeseries",
                    "label": "outsideHumidity",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.05821233805088244
                  },
                  {
                    "name": "label",
                    "type": "entityField",
                    "label": "label",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8646915284773707,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  }
                ],
                "label": {
                  "show": true,
                  "type": "function",
                  "pattern": "${entityName}",
                  "patternFunction": {
                    "body": "var color = utils.getProgressColor(data.progress).color;\r\n\r\nreturn '<span style=\"border: solid ' + color + '; border-radius: 10px; color: ' + color + '; background-color: #fff; padding: 3px 5px; font-size: 14px; position: relative; bottom: 6px;\">' + \r\n           '${entityName}' + \r\n        '</span>';",
                    "modules": {
                      "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js",
                      "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js"
                    }
                  }
                },
                "tooltip": {
                  "show": false,
                  "trigger": "hover",
                  "autoclose": true,
                  "type": "function",
                  "pattern": "<b>${entityName}</b><br/><br/><b>Latitude:</b> ${latitude:7}<br/><b>Longitude:</b> ${longitude:7}<br/><b>Temperature:</b> ${temperature} °C<br/><small>See tooltip settings for details</small>",
                  "offsetX": 0,
                  "offsetY": -1,
                  "patternFunction": {
                    "body": "const locationName = data.locationName || data.label || entityName;\nconst name = data.name || entityName;\nconst progress = data.progress;\nconst address = data.address || '';\n\nlet progressHtml = '';\nif (progress) {\n    let color, bgColor, label;\n    switch (progress) {\n        case 'active':\n            color = '#27AE60';\n            bgColor = 'rgba(39, 174, 96, 0.12)';\n            label = 'Active';\n            break;\n        case 'in preparation':\n            color = '#F2994A';\n            bgColor = 'rgba(242, 153, 74, 0.12)';\n            label = 'In Preparation';\n            break;\n        case 'finished':\n            color = '#2F80ED';\n            bgColor = 'rgba(47, 128, 237, 0.12)';\n            label = 'Finished';\n            break;\n        case 'aborted':\n            color = '#EB5757';\n            bgColor = 'rgba(235, 87, 87, 0.12)';\n            label = 'Aborted';\n            break;\n        default:\n            color = '#828282';\n            bgColor = 'rgba(130, 130, 130, 0.12)';\n            label = progress || 'Unknown';\n    }\n    progressHtml = '<span style=\"padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; color: ' + color + '; background-color: ' + bgColor + ';\">' + label + '</span>';\n}\n\nreturn '<div style=\"font-family: Roboto; font-size: 14px;\">' +\n    '<div style=\"font-weight: 600; margin-bottom: 4px;\">' + locationName + '</div>' +\n    '<div style=\"color: #666; font-size: 12px; margin-bottom: 4px;\">' + name + '</div>' +\n    (progressHtml ? '<div>' + progressHtml + '</div>' : '') +\n    '<div style=\"color: #999; font-size: 11px; margin-top: 8px;\">Click for details</div>' +\n    '</div>';",
                    "modules": {}
                  },
                  "tagActions": null
                },
                "click": {
                  "type": "customPretty",
                  "customHtml": "<form class=\"project-popup-form\">\n  <button class=\"popup-close\" mat-icon-button (click)=\"close()\" type=\"button\">\n    <mat-icon class=\"material-icons\">close</mat-icon>\n  </button>\n  <div mat-dialog-content>\n    <!-- Project Picture -->\n    <section *ngIf=\"project.picture\" class=\"flex flex-col items-center justify-center\" style=\"padding-bottom: 16px;\">\n      <img class=\"project-picture\" [src]=\"project.picture\"/>\n    </section>\n    \n    <!-- Project Name -->\n    <section class=\"flex flex-col items-center justify-center\" style=\"padding-bottom: 16px;\">\n      <div class=\"popup-title\">{{ project.locationName }}</div>\n      <div class=\"popup-subtitle\">{{ project.name }}</div>\n    </section>\n    \n    <mat-divider style=\"margin-bottom: 16px;\"></mat-divider>\n    \n    <!-- Project Details -->\n    <section class=\"flex flex-col gap-2\" style=\"padding-bottom: 16px;\">\n      <div class=\"flex flex-row items-baseline\">\n        <div class=\"popup-label\">Address</div>\n        <div class=\"popup-value\">{{ project.address }}</div>\n      </div>\n      <div class=\"flex flex-row items-center\">\n        <div class=\"popup-label\">Progress</div>\n        <div class=\"popup-badge\" [style.color]=\"project.progressStyle.color\" [style.background-color]=\"project.progressStyle.bgColor\">\n          {{ project.progressStyle.label }}\n        </div>\n      </div>\n      <div class=\"flex flex-row items-center\" *ngIf=\"project.measurementsCount !== null\">\n        <div class=\"popup-label\">Measurements</div>\n        <div class=\"popup-value\">{{ project.measurementsCount }}</div>\n      </div>\n    </section>\n    \n    <!-- Timestamps -->\n    <section *ngIf=\"project.startTime || project.endTime\" class=\"flex flex-row gap-2 flex-wrap\" style=\"padding-bottom: 16px;\">\n      <div *ngIf=\"project.startTime\" class=\"timestamp-badge\" [style.color]=\"project.startTime.color\" [style.background-color]=\"project.startTime.bgColor\">\n        <mat-icon style=\"font-size: 14px; width: 14px; height: 14px; margin-right: 4px;\">{{ project.startTime.icon }}</mat-icon>\n        <span>{{ project.startTime.label }}</span>\n      </div>\n      <div *ngIf=\"project.endTime\" class=\"timestamp-badge\" [style.color]=\"project.endTime.color\" [style.background-color]=\"project.endTime.bgColor\">\n        <mat-icon style=\"font-size: 14px; width: 14px; height: 14px; margin-right: 4px;\">{{ project.endTime.icon }}</mat-icon>\n        <span>{{ project.endTime.label }}</span>\n      </div>\n    </section>\n    \n    <!-- Buttons -->\n    <section class=\"flex flex-row gap-2 items-center justify-center flex-wrap\" style=\"padding-top: 8px;\">\n      <button *ngIf=\"showWizardButton\" type=\"button\" mat-flat-button color=\"primary\" class=\"popup-button wizard-button\" (click)=\"openProjectWizard()\">\n        <mat-icon>rocket_launch</mat-icon>\n        <span>Project Wizard</span>\n      </button>\n      <button type=\"button\" mat-stroked-button class=\"popup-button edit-button\" (click)=\"openEditProject()\">\n        <mat-icon>edit</mat-icon>\n        <span>Edit</span>\n      </button>\n    </section>\n  </div>\n</form>",
                  "customCss": ".project-popup-form {\n    width: 420px;\n    position: relative;\n    padding: 16px;\n}\n\n.project-popup-form .mat-mdc-dialog-content {\n    max-height: 95vh;\n    padding: 0;\n}\n\n.project-popup-form .popup-close {\n    position: absolute;\n    top: 8px;\n    right: 8px;\n    z-index: 1;\n}\n\n.project-popup-form .project-picture {\n    width: 160px;\n    height: 160px;\n    border-radius: 8px;\n    object-fit: cover;\n}\n\n.project-popup-form .popup-title {\n    font-weight: 600;\n    font-size: 18px;\n    line-height: 24px;\n    color: #29313C;\n    text-align: center;\n}\n\n.project-popup-form .popup-subtitle {\n    font-size: 14px;\n    color: #666;\n    text-align: center;\n}\n\n.project-popup-form .popup-label {\n    font-size: 13px;\n    line-height: 16px;\n    font-weight: 500;\n    color: rgba(0, 0, 0, 0.38);\n    width: 110px;\n    flex-shrink: 0;\n}\n\n.project-popup-form .popup-value {\n    font-size: 14px;\n    line-height: 20px;\n    font-weight: 500;\n    letter-spacing: 0.25px;\n    color: #29313C;\n}\n\n.project-popup-form .popup-badge {\n    display: inline-block;\n    padding: 4px 8px;\n    border-radius: 8px;\n    font-size: 12px;\n    font-weight: 500;\n    line-height: 16px;\n}\n\n.project-popup-form .timestamp-badge {\n    display: inline-flex;\n    align-items: center;\n    padding: 4px 8px;\n    border-radius: 4px;\n    font-size: 11px;\n    font-weight: 500;\n}\n\n.project-popup-form .popup-button {\n    display: flex;\n    align-items: center;\n    gap: 4px;\n}\n\n.project-popup-form .wizard-button {\n    background-color: #307FE5;\n}\n\n.project-popup-form .edit-button {\n    color: #F2994A;\n    border-color: #F2994A;\n}\n\n.project-popup-form .mat-mdc-outlined-button.mat-primary:not(:disabled),\n.project-popup-form .mat-mdc-stroked-button.mat-primary:not(:disabled) {\n    color: #307FE5;\n    border-color: #307FE5;\n}",
                  "customFunction": {
                    "body": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet rxjs = widgetContext.rxjs;\n\n// Load attributes and relations in parallel\nrxjs.forkJoin([\n    attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE', \n        ['locationName', 'address', 'progress', 'startTimeMs', 'endTimeMs', 'projectPicture']\n    ),\n    entityRelationService.findByFrom(entityId, 'Owns')\n]).subscribe(function(results) {\n    let attributes = results[0];\n    let relations = results[1];\n    \n    let attrMap = {};\n    attributes.forEach(function(attr) {\n        attrMap[attr.key] = attr.value;\n    });\n    \n    // Count measurements (relations with type Owns to ASSETs)\n    let measurementsCount = relations.filter(function(rel) {\n        return rel.to && rel.to.entityType === 'ASSET';\n    }).length;\n    \n    openProjectPopupDialog(attrMap, measurementsCount);\n});\n\nfunction openProjectPopupDialog(attrMap, measurementsCount) {\n    customDialog.customDialog(htmlTemplate, ProjectPopupController).subscribe();\n    \n    function ProjectPopupController(instance) {\n        let vm = instance;\n        \n        // Progress styling\n        let progressStyle = getProgressColor(attrMap.progress);\n        \n        // Timestamp styling\n        let startTime = getTimestampStyle(attrMap.startTimeMs, 'start');\n        let endTime = getTimestampStyle(attrMap.endTimeMs, 'end');\n        \n        vm.project = {\n            name: entityName,\n            locationName: attrMap.locationName || entityLabel || entityName,\n            address: attrMap.address || 'N/A',\n            progress: attrMap.progress,\n            progressStyle: progressStyle,\n            picture: attrMap.projectPicture || null,\n            startTime: startTime,\n            endTime: endTime,\n            measurementsCount: measurementsCount\n        };\n        \n        vm.showWizardButton = (attrMap.progress === 'in preparation' || attrMap.progress === 'active');\n        \n        vm.close = function() {\n            vm.dialogRef.close(null);\n        };\n        \n        vm.openProjectWizard = function() {\n            vm.dialogRef.close(null);\n            projectWizard.openProjectWizardDialog(widgetContext, entityId, entityName, entityLabel, function() {\n                widgetContext.updateAliases();\n            }, { dataImporter: dataImporter });\n        };\n        \n        vm.openMeasurements = function() {\n            vm.dialogRef.close(null);\n            var params = widgetContext.stateController.getStateParams();\n            var selectedProject = params['selectedProject'];\n            if (selectedProject && selectedProject.entityId.id === entityId.id) {\n                params['selectedProject'] = null;\n            } else {\n                params['selectedProject'] = { \n                    entityId: entityId, \n                    entityName: entityName, \n                    entityLabel: entityLabel \n                };\n            }\n            widgetContext.stateController.updateState(null, params);\n        };\n        vm.openEditProject = function() {\n            vm.dialogRef.close(null);\n            projectWizard.openEditProjectDialog(widgetContext, entityId, entityName, entityLabel, function() {\n                widgetContext.updateAliases();\n            });\n        };\n\n        \n        // Helper functions\n        function getProgressColor(progress) {\n            let color, bgColor, label;\n            switch (progress) {\n                case 'in preparation':\n                    color = '#F2994A';\n                    bgColor = 'rgba(242, 153, 74, 0.12)';\n                    label = 'In Preparation';\n                    break;\n                case 'planned':\n                    color = '#F2994A';\n                    bgColor = 'rgba(242, 153, 74, 0.12)';\n                    label = 'Planned';\n                    break;\n                case 'active':\n                    color = '#27AE60';\n                    bgColor = 'rgba(39, 174, 96, 0.12)';\n                    label = 'Active';\n                    break;\n                case 'finished':\n                    color = '#2F80ED';\n                    bgColor = 'rgba(47, 128, 237, 0.12)';\n                    label = 'Finished';\n                    break;\n                case 'aborted':\n                    color = '#EB5757';\n                    bgColor = 'rgba(235, 87, 87, 0.12)';\n                    label = 'Aborted';\n                    break;\n                default:\n                    color = '#828282';\n                    bgColor = 'rgba(130, 130, 130, 0.12)';\n                    label = progress || 'N/A';\n            }\n            return { color: color, bgColor: bgColor, label: label };\n        }\n        \n        function getTimestampStyle(timestampMs, type) {\n            if (timestampMs === null || timestampMs === undefined) {\n                return null;\n            }\n            var date = new Date(Number(timestampMs));\n            var pad = function(n) { return n.toString().padStart(2, '0'); };\n            var formattedTime = date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' + pad(date.getDate()) +\n                ' ' + pad(date.getHours()) + ':' + pad(date.getMinutes());\n            \n            var icon, color, bgColor, label;\n            if (type === 'start') {\n                icon = 'play_circle';\n                color = '#27AE60';\n                bgColor = 'rgba(39, 174, 96, 0.12)';\n                label = 'Start: ' + formattedTime;\n            } else {\n                icon = 'stop_circle';\n                color = '#2F80ED';\n                bgColor = 'rgba(47, 128, 237, 0.12)';\n                label = 'End: ' + formattedTime;\n            }\n            return { icon: icon, color: color, bgColor: bgColor, label: label };\n        }\n    }\n}",
                    "modules": {
                      "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                      "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                    }
                  },
                  "customResources": [],
                  "openInSeparateDialog": false,
                  "openInPopover": false
                },
                "groups": null,
                "edit": {
                  "enabledActions": [
                    "add",
                    "move"
                  ],
                  "attributeScope": "SERVER_SCOPE",
                  "snappable": false
                },
                "xKey": {
                  "name": "latitude",
                  "label": "latitude",
                  "type": "attribute",
                  "settings": {},
                  "color": "#2196f3"
                },
                "yKey": {
                  "name": "longitude",
                  "label": "longitude",
                  "type": "attribute",
                  "settings": {},
                  "color": "#2196f3"
                },
                "markerType": "icon",
                "markerShape": {
                  "shape": "markerShape1",
                  "size": 34,
                  "color": {
                    "type": "constant",
                    "color": "#307FE5"
                  }
                },
                "markerIcon": {
                  "size": 40,
                  "color": {
                    "type": "function",
                    "color": "#307FE5",
                    "rangeKey": null,
                    "range": null,
                    "colorFunction": {
                      "body": "return utils.getProgressColor(data.progress).color;",
                      "modules": {
                        "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                      }
                    }
                  },
                  "iconContainer": "iconContainer4",
                  "icon": "domain"
                },
                "markerImage": {
                  "type": "image",
                  "image": "/assets/markers/shape1.svg",
                  "imageSize": 34
                },
                "markerOffsetX": 0.5,
                "markerOffsetY": 1,
                "markerClustering": {
                  "enable": true,
                  "zoomOnClick": true,
                  "maxZoom": null,
                  "maxClusterRadius": 80,
                  "zoomAnimation": true,
                  "showCoverageOnHover": true,
                  "spiderfyOnMaxZoom": false,
                  "chunkedLoad": false,
                  "lazyLoad": true,
                  "useClusterMarkerColorFunction": false,
                  "clusterMarkerColorFunction": null
                }
              }
            ],
            "polygons": [],
            "circles": [],
            "additionalDataSources": [
              {
                "dsType": "entity",
                "dsLabel": "",
                "dataKeys": [
                  {
                    "name": "latitude",
                    "type": "attribute",
                    "label": "selectedProject",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.5634367819170003,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  }
                ],
                "dsEntityAliasId": "faef915b-be60-5c6b-d62c-114957e80421"
              },
              {
                "dsType": "entity",
                "dsLabel": "",
                "dataKeys": [
                  {
                    "name": "role",
                    "type": "attribute",
                    "label": "role",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.7014478669430672
                  },
                  {
                    "name": "displayAbortedMeasurement",
                    "type": "attribute",
                    "label": "displayAbortedMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8011587598224269
                  },
                  {
                    "name": "displayActiveMeasurement",
                    "type": "attribute",
                    "label": "displayActiveMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8205299052205228
                  },
                  {
                    "name": "displayFinishedMeasurement",
                    "type": "attribute",
                    "label": "displayFinishedMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.038665901375789624
                  },
                  {
                    "name": "displayPreparationMeasurement",
                    "type": "attribute",
                    "label": "displayPreparationMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.21373032656145663
                  }
                ],
                "dsEntityAliasId": "203b0867-b867-ef98-1791-03046c133b7d"
              }
            ],
            "controlsPosition": "topleft",
            "zoomActions": [
              "scroll",
              "doubleClick",
              "controlButtons"
            ],
            "scales": [
              "metric"
            ],
            "dragModeButton": true,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "defaultCenterPosition": "0,0",
            "defaultZoomLevel": null,
            "mapPageSize": 16384,
            "mapActionButtons": [
              {
                "label": "Filter",
                "icon": "filter_alt",
                "color": "#0000008A",
                "action": {
                  "type": "openDashboardState",
                  "targetDashboardStateId": "Measurement_state_filter",
                  "setEntityId": true,
                  "stateEntityParamName": null,
                  "openRightLayout": false,
                  "popoverPreferredPlacement": "top",
                  "popoverHideOnClickOutside": true,
                  "popoverHideDashboardToolbar": true,
                  "popoverWidth": "300px",
                  "popoverHeight": "250px",
                  "popoverStyle": {
                    "padding": "16px",
                    "borderRadius": "8px",
                    "boxShadow": "0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",
                    "background": "#ffffff"
                  },
                  "openInSeparateDialog": false,
                  "openInPopover": true
                }
              }
            ],
            "background": {
              "type": "color",
              "color": "#fff",
              "overlay": {
                "enabled": false,
                "color": "rgba(255,255,255,0.72)",
                "blur": 3
              }
            },
            "padding": "8px"
          },
          "title": "Map",
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "showTitleIcon": false,
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": true,
          "widgetStyle": {},
          "widgetCss": "",
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "configMode": "advanced",
          "titleFont": null,
          "titleColor": null,
          "margin": "0px",
          "borderRadius": "8px",
          "iconSize": "24px",
          "titleIcon": "map",
          "iconColor": "#1F6BDD",
          "actions": {
            "headerButton": []
          },
          "enableDataExport": false
        },
        "row": 0,
        "col": 0,
        "id": "03ceaaed-0eb5-4d4e-a3ef-0c4394cb2cb8"
      },
      "65f06cd0-359d-d0bf-f7aa-8f4700ea7d44": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "state",
                  "type": "attribute",
                  "label": "state",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.8057369620518648
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.49953012506084726
                },
                {
                  "name": "active",
                  "type": "attribute",
                  "label": "active",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.21088975870489435
                },
                {
                  "name": "type",
                  "type": "entityField",
                  "label": "Type",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.5157976480659352
                },
                {
                  "name": "batteryLevel",
                  "type": "timeseries",
                  "label": "batteryLevel",
                  "color": "#607d8b",
                  "settings": {},
                  "_hash": 0.1659349558331873
                },
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "progress",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.20684451568213258,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "locationName",
                  "type": "attribute",
                  "label": "locationName",
                  "color": "#8bc34a",
                  "settings": {},
                  "_hash": 0.5554495301365088
                },
                {
                  "name": "installationType",
                  "type": "attribute",
                  "label": "installationType",
                  "color": "#3f51b5",
                  "settings": {},
                  "_hash": 0.821480189837247
                },
                {
                  "name": "measurementType",
                  "type": "attribute",
                  "label": "measurementType",
                  "color": "#e91e63",
                  "settings": {},
                  "_hash": 0.31692184501390863
                },
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "address",
                  "color": "#ffeb3b",
                  "settings": {},
                  "_hash": 0.14141450952611212
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678196817440,
                "endTimeMs": 1678283217440
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "# Markdown/HTML card \\n - **Current entity**: **${entityName}**. \\n - **Current value**: **${Random}**.",
            "markdownTextFunction": {
              "body": "var name, label, address, progress;\nif (data && data.length) {\n    name = data[0]['entityName'] || 'N/A';\n    label = data[0]['Label'] || 'N/A';\n    address = data[0]['address'] || 'N/A';\n    progress = data[0]['progress'] || 'N/A';\n} else {\n    name = 'N/A';\n    label = 'N/A';\n    address = 'N/A';\n    progress = 'N/A';\n}\n\n// Project Wizard style header with Go Back and Project Wizard buttons\nvar header = '<div class=\"project-header\" style=\"display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px;\">' +\n  '<div style=\"display: flex; flex-direction: column; gap: 4px;\">' +\n    '<div style=\"display: flex; align-items: center; gap: 12px;\">' +\n      '<span style=\"font-weight: 600; font-size: 16px; color: #333;\">' + name + '</span>' +\n      '<span style=\"font-size: 13px; color: #666;\">' + label + '</span>' +\n    '</div>' +\n    '<div style=\"display: flex; align-items: center; gap: 12px; margin-top: 4px;\">' +\n      '<div style=\"display: flex; align-items: center; gap: 8px;\">' +\n        '<mat-icon style=\"font-size: 16px; width: 16px; height: 16px; color: #666;\">location_on</mat-icon>' +\n        '<span style=\"font-size: 12px; color: #666;\">' + address + '</span>' +\n      '</div>' +\n      '<div style=\"margin-left: 16px;\">' + utils.getProgressHtml(progress) + '</div>' +\n    '</div>' +\n  '</div>' +\n  '<div style=\"display: flex; align-items: center; gap: 8px;\">' +\n    '<button id=\"go-back\" type=\"button\" mat-raised-button class=\"header-btn-secondary\">' +\n      '<mat-icon>arrow_back</mat-icon>' +\n      '<span>{i18n:custom.diagnostics.action.go-back.title}</span>' +\n    '</button>' +\n    '<button id=\"open-project-wizard\" type=\"button\" mat-raised-button class=\"header-btn-primary\">' +\n      '<mat-icon>rocket_launch</mat-icon>' +\n      '<span>Project Wizard</span>' +\n    '</button>' +\n  '</div>' +\n'</div>';\n\nreturn header;\n",
              "modules": {
                "clientUtils": "tb-resource;/api/resource/js_module/tenant/client-utils.js",
                "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
              }
            },
            "applyDefaultMarkdownStyle": false,
            "markdownCss": ".project-header {\n    background: #fafafa !important;\n    border: 1px solid #e0e0e0 !important;\n    border-radius: 8px !important;\n}\n.project-header .header-btn-primary {\n    background-color: var(--tb-primary-500) !important;\n    color: white !important;\n}\n.project-header .header-btn-primary:hover {\n    background-color: var(--tb-primary-600) !important;\n}\n.project-header .header-btn-secondary {\n    background-color: var(--tb-primary-500) !important;\n    color: white !important;\n}\n.project-header .header-btn-secondary:hover {\n    background-color: var(--tb-primary-600) !important;\n}"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "37e5e007-da10-e64c-be1e-899094481e42",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\n\nparams['selectedProject'] = null;\nparams['targetStateParameter'] = null;\n\nparams = {\n    \"userRole\": params.userRole\n};\n\nwidgetContext.stateController.updateState(null, params);"
              },
              {
                "name": "settings",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "const targetElement = $($event.target).closest('#settings', widgetContext.$container[0]);\n\nvar type = decodeURIComponent($(targetElement).attr('data-device-type'));\n\nvar stateId = getSettingsState(type);\n\nvar params = {\n    selectedDevice: {\n        entityId: entityId,\n        entityName: entityName,\n        entityLabel: entityLabel,\n    },\n    targetEntityParamName: 'selectedDevice'\n};\n\nwidgetContext.actionsApi.openDashboardStateInPopover($event, stateId, params, true, 'bottomRight', true, '400px', getSettingsHeight(type));\n\nfunction getSettingsState(type) {\n    switch (type) {\n        case 'P-Flow D116':\n            return 'pflow_settings';\n        case 'Room Sensor T':            \n            return 'roomsensort_settings';\n        case 'Room Sensor CO2':            \n            return 'roomsensorco2_settings';                      \n        case 'Door Sensor':\n            return 'door_settings';\n        case 'Motion Sensor':\n            return 'motion_sensor_settings';\n        case 'Occupancy Sensor':\n            return 'occupancy_sensor_settings';\n        default:\n            return 'unknown_settings';\n    }\n}\n\nfunction getSettingsHeight(type) {\n    switch (type) {\n        case 'P-Flow D116':\n            return '800px';\n        case 'Room Sensor T':            \n            return '600px';\n        case 'Room Sensor CO2':            \n            return '800px';                  \n        case 'Door Sensor':\n            return '500px';\n        case 'Motion Sensor':\n            return '340px';\n        case 'Occupancy Sensor':\n            return '500px';\n        default:\n            return '35vh';\n    }\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "076da598-f2dc-6fda-6744-db268a4c6df7"
              },
              {
                "name": "battery-level",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "battery_level_details",
                "setEntityId": true,
                "stateEntityParamName": "selectedDevice",
                "openRightLayout": false,
                "popoverPreferredPlacement": "bottomRight",
                "popoverHideOnClickOutside": true,
                "popoverHideDashboardToolbar": true,
                "popoverWidth": "500px",
                "popoverHeight": "300px",
                "popoverStyle": {},
                "openInSeparateDialog": false,
                "openInPopover": true,
                "id": "44417062-4a4f-0479-0042-93952e15436a"
              },
              {
                "name": "details-full",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = {\n    selectedMeasurement: {\n        entityId: entityId,\n        entityName: entityName,\n        entityLabel: entityLabel,\n    },\n    targetEntityParamName: 'selectedMeasurement'\n};\n\n// Navigate to measurement_dashboard - the markdown widget there handles the conditional display\nwidgetContext.stateController.openState('measurement_dashboard', params, true);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1532b4d5-2d3c-872e-57ed-d477f9b2e502"
              },
              {
                "name": "details-day",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "const targetElement = $($event.target).closest('#details-day', widgetContext.$container[0]);\n\nvar type = decodeURIComponent($(targetElement).attr('data-device-type'));\n\nvar stateId = getDeviceState(type);\n\nvar params = {\n    selectedDevice: {\n        entityId: entityId,\n        entityName: entityName,\n        entityLabel: entityLabel,\n    },\n    targetEntityParamName: 'selectedDevice'\n};\n\nwidgetContext.actionsApi.openDashboardStateInPopover($event, stateId, params, true, 'bottomRight', true, '1600px', getDeviceHeight(type));\n\nfunction getDeviceState(type) {\n    switch (type) {\n        case 'P-Flow D116':\n            return 'pflow_details_full';\n        case 'Room Sensor T':            \n            return 'roomsensort_details_full';\n        case 'Room Sensor CO2':            \n            return 'roomsensorco2_details_full';                      \n        case 'Door Sensor':\n            return 'door_details_full';\n        case 'Motion Sensor':\n            return 'motion_details_full';\n        case 'Occupancy Sensor':\n            return 'occupancy_details_fulls';\n        default:\n            return 'unknown_settings';\n    }\n}\n\nfunction getDeviceHeight(type) {\n    switch (type) {\n        case 'P-Flow D116':\n            return '1000px';\n        case 'Room Sensor T':            \n            return '1000px';\n        case 'Room Sensor CO2':            \n            return '1000px';                  \n        case 'Door Sensor':\n            return '1000px';\n        case 'Motion Sensor':\n            return '1000px';\n        case 'Occupancy Sensor':\n            return '1000px';\n        default:\n            return '35vh';\n    }\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1831fd41-86a5-53ac-1e1b-ab4f23f60807"
              },
              {
                "name": "measurement-parameters",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "modules": {
                  "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js"
                },
                "customFunction": "const measurementId = widgetContext.stateController.getStateParams()?.selectedMeasurement?.entityId;\n\nif (!measurementId || !measurementId.id) {\n    console.error('No measurement selected');\n    return;\n}\n\nprojectWizard.openMeasurementParametersDialog(widgetContext, measurementId);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "a066a7c4-4bbb-d780-315e-af760f5b1e4e"
              },
              {
                "name": "sensor-data",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "sensor_data",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "301c8f82-5367-e4eb-a578-ca81965b5e9a"
              },
              {
                "name": "open-project-wizard",
                "icon": "assignment",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": {
                  "body": "var stateParams = widgetContext.stateController.getStateParams();\nvar selectedProject = stateParams ? stateParams.selectedProject : null;\n\nif (selectedProject && selectedProject.entityId) {\n    projectWizard.openProjectWizardDialog(widgetContext, selectedProject.entityId, selectedProject.entityName, selectedProject.entityLabel, function() { widgetContext.updateAliases(); }, { dataImporter: dataImporter });\n} else {\n    console.error('No project selected');\n}",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                    "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "project-wizard-action-1769529175158"
              }
            ],
            "headerButton": []
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "65f06cd0-359d-d0bf-f7aa-8f4700ea7d44",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "4ebd4327-6b2e-432c-9f12-5d87a6ca7e76": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678196817440,
                "endTimeMs": 1678283217440
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": false,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "entitiesTitle": "{i18n:custom.diagnostics.measurements.title}",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "false",
            "displayEntityName": true,
            "entityNameColumnTitle": "{i18n:custom.diagnostics.measurement-name.title}",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "pageStepCount": 3,
            "pageStepIncrement": 10,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "{i18n:custom.diagnostics.measurements.title}",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "c849d52c-a3c7-5008-a4c0-c2d0406fe515",
              "filterId": "8366ab5b-1381-2841-d917-ec7a70bd8d7c",
              "dataKeys": [
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.measurement-address.title}",
                  "color": "#ffc107",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "hidden",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5439377495268714,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.8686344328279582
                },
                {
                  "name": "state",
                  "type": "attribute",
                  "label": "{i18n:entity-field.state}",
                  "color": "#ffc107",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "20%",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var state = value;\n\nvar stateSvg = getStateSvg(state);\nvar encodedStateSvg = encodeURIComponent(stateSvg);\nvar stateSvgUrl = 'data:image/svg+xml,' + encodedStateSvg;\nvar stateLabel = getStateLabel(state);\n\nreturn '<span>'+\n           '<img style=\"vertical-align: middle;\" class=\"mat-icon\" src=\"'+ stateSvgUrl +'\">' +\n           '<span style=\"vertical-align: middle; padding-left: 8px;\">'+ stateLabel +'</span>' +\n       '</span>';\n            \nfunction getStateSvg(state) {\n    switch (state) {\n        case 'critical':\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#E64A19\"/>' +\n                   '</svg>';\n        case 'major':            \n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#D5C21B\"/>' +\n                   '</svg>';\n        case 'normal':            \n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#1F8B4D\"/>' +\n                   '</svg>';\n        default:\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#AAAAAA\"/>' +\n                   '</svg>';\n    }\n}\n\nfunction getStateLabel(state) {\n    switch(state) {\n        case 'critical':\n            return 'Critical';\n        case 'major':\n            return 'Major';\n        case 'normal':\n            return 'Normal';\n        default:\n            return state;\n    }\n}\n",
                    "defaultColumnVisibility": "hidden",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.2718881518921066,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.measurement-progress.title}",
                  "color": "#ffc107",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": {
                      "body": "return utils.getProgressHtml(value);",
                      "modules": {
                        "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                      }
                    },
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.6466565617082951,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "measurementType",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.measurement-type.title}",
                  "color": "#607d8b",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": {
                      "body": "return utils.getMeasurementTypeHtml(value);",
                      "modules": {
                        "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                      }
                    },
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.011120189088471788,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "div.tb-widget .tb-widget-title {\n    max-height: 100px !important;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "rowClick": [
              {
                "name": "Selected Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = {\n    selectedMeasurement: {\n        entityId: entityId,\n        entityName: entityName,\n        entityLabel: entityLabel,\n    },\n    targetEntityParamName: 'selectedMeasurement'\n};\n\n// Navigate to measurement_dashboard - the markdown widget there handles the conditional display\nwidgetContext.stateController.openState('measurement_dashboard', params, true);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "27b78a0c-3e2d-8d90-72dd-10f9f80351b5"
              }
            ],
            "actionCellButton": [
              {
                "id": "measurement-info-action",
                "name": "Live Data",
                "icon": "sensors",
                "type": "custom",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "customFunction": {
                  "body": "const measurementId = entityId;\nprojectWizard.openMeasurementInfoDialog(widgetContext, measurementId);",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false
              },
              {
                "name": "Connect Measurement",
                "icon": "add_chart",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var progress = data.Progress || data.progress;\nvar isUltrasonic = data['Measurement Type'] === 'ultrasonic';\nreturn isUltrasonic && (progress === 'in preparation' || progress === 'planned');",
                "type": "custom",
                "customFunction": {
                  "body": "utils.dataConnectorDialog(widgetContext, entityId, entityName);",
                  "modules": {
                    "utils": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "c020f915-da89-ba7e-5aaa-49066cf1451c"
              },
              {
                "name": "{i18n:custom.diagnostics.action.measurement-parameters}",
                "icon": "settings",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\r\n/*console.log(widgetContext.stateController.getStateParams());\r\nconsole.log(\"user role:\", userRole);*/\r\n        \r\nif (userRole !== 'Belimo Retrofit Users') {\r\n    return true;\r\n} else {\r\n    return false;\r\n}\r\n    \r\n    /*return (userRoleValue !== 'Belimo Retrofit Users');*/\r\n    \r\n\r\n   \r\n\r\n \r\n",
                "type": "custom",
                "customFunction": {
                  "body": "const measurementId = entityId;\n\nif (!measurementId || !measurementId.id) {\n    console.error(\"No measurement selected\");\n    return;\n}\n\nprojectWizard.openMeasurementParametersDialog(widgetContext, measurementId);",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e9d60eaa-56f8-bbfb-45db-110033a2739a"
              },
              {
                "id": "delete-measurement-1769460037673",
                "name": "Delete Measurement",
                "icon": "delete",
                "type": "custom",
                "customFunction": {
                  "body": "const measurementId = entityId;\nconst measurementName = entityName || entityLabel || 'this measurement';\n\nif (!measurementId || !measurementId.id) {\n    console.error(\"No measurement selected\");\n    return;\n}\n\nprojectWizard.deleteMeasurement(widgetContext, measurementId, measurementName);",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js"
                  }
                }
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.diagnostics.action.go-back.title}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\n/*var number = (widgetContext.stateController.getStateIndex())-1;*/\r\n\r\nparams['selectedProject'] = null;\r\nparams['targetStateParameter'] = null;\r\n\r\nparams = {\r\n    \"userRole\": params.userRole\r\n};\r\n\r\nwidgetContext.stateController.updateState(null,params);\r\n/*widgetContext.stateController.navigatePrevState(number);*/",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "3ef7bac7-ead3-49d4-a2aa-1b80aae1b476"
              },
              {
                "name": "Measurement",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": {
                  "body": "const stateParams = widgetContext.stateController.getStateParams();\nconst selectedProject = stateParams.selectedProject;\n\nif (!selectedProject || !selectedProject.entityId || !selectedProject.entityId.id) {\n    console.error('No project selected. Please select a project first.');\n    return;\n}\n\nconst projectId = { id: selectedProject.entityId.id, entityType: 'ASSET' };\nconst projectName = selectedProject.entityName;\n\n// Determine customerId\nconst NULL_UUID = '13814000-1dd2-11b2-8080-808080808080';\nfunction isValidCustomerId(id) {\n    return id && id !== NULL_UUID;\n}\n\nconst userRole = stateParams.userRole;\nconst stateEntityId = stateParams.entityId;\nlet customerId;\n\nif ((widgetContext.currentUser.authority === 'TENANT_ADMIN' || userRole === 'ECO Administrator') && stateEntityId && stateEntityId.id && isValidCustomerId(stateEntityId.id)) {\n    customerId = stateEntityId;\n    openDialog();\n} else if (isValidCustomerId(widgetContext.currentUser.customerId)) {\n    customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\n    openDialog();\n} else {\n    // Fetch customerId from project asset\n    const $injector = widgetContext.$scope.$injector;\n    const assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n    assetService.getAsset(projectId.id).subscribe(projectAsset => {\n        if (projectAsset && projectAsset.customerId && isValidCustomerId(projectAsset.customerId.id)) {\n            customerId = projectAsset.customerId;\n            openDialog();\n        } else {\n            console.error('Cannot determine customerId. Project has no valid customer assigned.');\n        }\n    });\n}\n\nfunction openDialog() {\n    projectWizard.openAddMeasurementDialog(widgetContext, projectId, projectName, customerId, function(result) {\n        // Update state params with new measurement\n        const params = widgetContext.stateController.getStateParams();\n        params['selectedMeasurement'] = {\n            entityId: result.id,\n            entityName: result.name,\n            entityLabel: result.label || ''\n        };\n        widgetContext.updateAliases();\n        \n        // If connectKit checkbox was checked and it's ultrasonic, open connect dialog\n        if (result.connectKit && result.measurementType === 'ultrasonic') {\n            dataImporter.dataConnectorDialog(widgetContext, result.id, result.name);\n        }\n    });\n}",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                    "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "6f6daae0-99ef-3112-baf1-9e8e6cc178b2"
              }
            ]
          },
          "titleIcon": "devices_other",
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "28px",
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "4ebd4327-6b2e-432c-9f12-5d87a6ca7e76",
        "typeFullFqn": "system.cards.entities_table"
      },
      "fb924e54-6e4b-2d41-5545-dab85e028210": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": false,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "{i18n:custom.diagnostics.projects.title}",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "false",
            "displayEntityName": true,
            "entityNameColumnTitle": "{i18n:custom.diagnostics.project-id.title}",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": false,
            "defaultPageSize": 10,
            "pageStepCount": 3,
            "pageStepIncrement": 10,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "{i18n:custom.diagnostics.projects.title}",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "d75c5b86-8b39-59e2-59f3-ae1c1ee40910",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "{i18n:custom.diagnostics.project-name.title}",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.23547368231999988,
                  "decimals": 0,
                  "aggregationType": null,
                  "units": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.project-address.title}",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "hidden",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.8348661406382081,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": false,
                  "postFuncBody": null
                },
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.project-progress.title}",
                  "color": "#f44336",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": {
                      "body": "return utils.getProgressHtml(value);",
                      "modules": {
                        "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                      }
                    },
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.15334267783981326,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "generalReport",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.project-report.title}",
                  "color": "#ffc107",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar description;\r\nvar generalReport = value;\r\nvar status;\r\nif (generalReport == 'true') { // all key values here are strings\r\n  color = '#27AE60';\r\n  status = 'paid';\r\n  description = '{i18n:custom.diagnostics.report-status.paid.title}';\r\n} else {\r\n  color = '#EB5757';\r\n  status = 'inactive';\r\n  description = '{i18n:custom.diagnostics.report-status.inactive.title}';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span>'+ ' ' + description;",
                    "defaultColumnVisibility": "hidden",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.47896411690699625,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "assignedKit",
                  "type": "attribute",
                  "label": "assignedKit",
                  "color": "#607d8b",
                  "settings": {},
                  "_hash": 0.6930228824112628
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "Select Project",
                "icon": "more_horiz",
                "type": "openDashboardState",
                "targetDashboardStateId": "manage_projects",
                "setEntityId": true,
                "stateEntityParamName": "selectedProject",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "a7ad4745-1f21-49fd-38f4-70825fe6875f"
              }
            ],
            "actionCellButton": [
              {
                "name": "Edit Project",
                "icon": "edit",
                "useShowWidgetActionFunction": false,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #editProjectForm=\"ngForm\" [formGroup]=\"editProjectFormGroup\"\n      (ngSubmit)=\"save()\" class=\"edit-project-form\" style=\"width: 600px; max-width: 90vw;\">\n  <mat-toolbar class=\"flex items-center\" color=\"primary\">\n    <mat-icon style=\"margin-right: 12px;\">edit</mat-icon>\n    <h2 style=\"margin: 0; font-size: 18px;\">Edit Project</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col gap-3 p-4\">\n\n    <!-- Customer Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">business</mat-icon>\n        Customer\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full disabled-field\">\n        <mat-label>Customer</mat-label>\n        <input matInput formControlName=\"customerName\" readonly>\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Project Info Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">folder</mat-icon>\n        Project Info\n      </legend>\n      <tb-image-input formControlName=\"projectPicture\" label=\"Project Picture\" noImageText=\"No picture selected\"></tb-image-input>\n      <mat-form-field appearance=\"fill\" class=\"w-full disabled-field\">\n        <mat-label>Project ID</mat-label>\n        <input matInput formControlName=\"name\" readonly>\n      </mat-form-field>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Label</mat-label>\n        <input matInput formControlName=\"entityLabel\">\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Address Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">location_on</mat-icon>\n        Address\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Project address</mat-label>\n        <input matInput formControlName=\"address\" [matAutocomplete]=\"addrAuto\" autocomplete=\"off\">\n        <button mat-icon-button matSuffix type=\"button\" (click)=\"searchAddress()\" [disabled]=\"(editProjectFormGroup.get('address').value || '').length < 5\">\n          <mat-icon>search</mat-icon>\n        </button>\n        <mat-autocomplete #addrAuto=\"matAutocomplete\" [displayWith]=\"displayAddressOption\" (optionSelected)=\"onAddressSelected($event.option.value)\">\n          <mat-option *ngFor=\"let opt of addressOptions\" [value]=\"opt\">{{ opt.label }}</mat-option>\n        </mat-autocomplete>\n        <mat-hint *ngIf=\"(editProjectFormGroup.get('address').value || '').length < 5\">Enter at least 5 characters to search</mat-hint>\n      </mat-form-field>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Postal Code</mat-label>\n          <input matInput formControlName=\"postalCode\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 2;\">\n          <mat-label>City</mat-label>\n          <input matInput formControlName=\"city\">\n        </mat-form-field>\n      </div>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Latitude</mat-label>\n          <input matInput formControlName=\"latitude\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Longitude</mat-label>\n          <input matInput formControlName=\"longitude\">\n        </mat-form-field>\n      </div>\n    </fieldset>\n\n    <!-- Status Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">timeline</mat-icon>\n        Status\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Progress</mat-label>\n        <mat-select formControlName=\"progress\">\n          <mat-option value=\"in preparation\">In Preparation</mat-option>\n          <mat-option value=\"active\">Active</mat-option>\n          <mat-option value=\"finished\">Finished</mat-option>\n          <mat-option value=\"aborted\">Aborted</mat-option>\n        </mat-select>\n      </mat-form-field>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1.5;\">\n          <mat-label>Start Date</mat-label>\n          <mat-datetimepicker-toggle [for]=\"startDatePicker\" matPrefix></mat-datetimepicker-toggle>\n          <mat-datetimepicker #startDatePicker type=\"date\" openOnFocus=\"true\"></mat-datetimepicker>\n          <input matInput formControlName=\"startDate\" [matDatetimepicker]=\"startDatePicker\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Start Time</mat-label>\n          <mat-datetimepicker-toggle [for]=\"startTimePicker\" matPrefix></mat-datetimepicker-toggle>\n          <mat-datetimepicker #startTimePicker type=\"time\" openOnFocus=\"true\"></mat-datetimepicker>\n          <input matInput formControlName=\"startTime\" [matDatetimepicker]=\"startTimePicker\">\n        </mat-form-field>\n      </div>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1.5;\">\n          <mat-label>End Date</mat-label>\n          <mat-datetimepicker-toggle [for]=\"endDatePicker\" matPrefix></mat-datetimepicker-toggle>\n          <mat-datetimepicker #endDatePicker type=\"date\" openOnFocus=\"true\"></mat-datetimepicker>\n          <input matInput formControlName=\"endDate\" [matDatetimepicker]=\"endDatePicker\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>End Time</mat-label>\n          <mat-datetimepicker-toggle [for]=\"endTimePicker\" matPrefix></mat-datetimepicker-toggle>\n          <mat-datetimepicker #endTimePicker type=\"time\" openOnFocus=\"true\"></mat-datetimepicker>\n          <input matInput formControlName=\"endTime\" [matDatetimepicker]=\"endTimePicker\">\n        </mat-form-field>\n      </div>\n    </fieldset>\n\n  </div>\n  <div class=\"flex justify-end items-center gap-2 p-4\" style=\"border-top: 1px solid #e0e0e0; background: #fafafa;\">\n    <button mat-button (click)=\"cancel()\" type=\"button\">Cancel</button>\n    <button mat-raised-button color=\"primary\" type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editProjectFormGroup.invalid || !editProjectFormGroup.dirty\">\n      <mat-icon style=\"font-size: 18px; width: 18px; height: 18px; margin-right: 4px;\">save</mat-icon>\n      Save\n    </button>\n  </div>\n</form>",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled,\n.edit-project-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form .mdc-text-field--filled:not(.mdc-text-field--disabled),\n.edit-project-form .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .disabled-field input,\n.edit-project-form .disabled-field input {\n  color: rgba(0, 0, 0, 0.6) !important;\n}\n\n.add-entity-form .disabled-field,\n.edit-project-form .disabled-field {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\nmat-icon {\n  vertical-align: middle;\n  margin-right: 4px;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\n\n// Load project data and open dialog\nassetService.getAsset(entityId.id).subscribe(project => {\n    // Load project attributes (including status fields)\n    attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE',\n        ['latitude', 'longitude', 'address', 'postalCode', 'city', 'projectPicture', 'progress', 'startTimeMs', 'endTimeMs']\n    ).subscribe(attributes => {\n        const attrMap = {};\n        attributes.forEach(a => { attrMap[a.key] = a.value; });\n\n        // Load customer name\n        if (project.customerId && project.customerId.id) {\n            customerService.getCustomer(project.customerId.id).subscribe(customer => {\n                openEditProjectDialog(project, attrMap, customer ? customer.name : 'Unknown');\n            });\n        } else {\n            openEditProjectDialog(project, attrMap, 'Unknown');\n        }\n    });\n});\n\nfunction openEditProjectDialog(project, attrMap, customerName) {\n    customDialog.customDialog(htmlTemplate, EditProjectDialogController).subscribe();\n\n    function EditProjectDialogController(instance) {\n        let vm = instance;\n\n        vm.project = project;\n        vm.attrMap = attrMap;\n\n        // Initialize date values from timestamps\n        let startDate = null;\n        let startTime = null;\n        let endDate = null;\n        let endTime = null;\n\n        if (attrMap.startTimeMs) {\n            const startDateTime = new Date(Number(attrMap.startTimeMs));\n            startDate = startDateTime;\n            startTime = startDateTime;\n        }\n        if (attrMap.endTimeMs) {\n            const endDateTime = new Date(Number(attrMap.endTimeMs));\n            endDate = endDateTime;\n            endTime = endDateTime;\n        }\n\n        vm.editProjectFormGroup = vm.fb.group({\n            customerName: [{ value: customerName, disabled: true }],\n            name: [{ value: project.name, disabled: true }],\n            entityLabel: [project.label || ''],\n            projectPicture: [attrMap.projectPicture || null],\n            // Status fields\n            progress: [attrMap.progress || 'in preparation'],\n            startDate: [startDate],\n            startTime: [startTime],\n            endDate: [endDate],\n            endTime: [endTime],\n            // Address fields\n            address: [attrMap.address || ''],\n            postalCode: [attrMap.postalCode || ''],\n            city: [attrMap.city || ''],\n            latitude: [attrMap.latitude || ''],\n            longitude: [attrMap.longitude || '']\n        });\n\n        // Auto-set start/end time when progress changes\n        vm.editProjectFormGroup.get('progress').valueChanges.subscribe(function(progress) {\n            const startDateControl = vm.editProjectFormGroup.get('startDate');\n            const startTimeControl = vm.editProjectFormGroup.get('startTime');\n            const endDateControl = vm.editProjectFormGroup.get('endDate');\n            const endTimeControl = vm.editProjectFormGroup.get('endTime');\n\n            if (progress === 'active' && !startDateControl.value && !startTimeControl.value) {\n                const now = new Date();\n                startDateControl.setValue(now);\n                startTimeControl.setValue(now);\n                startDateControl.markAsDirty();\n                startTimeControl.markAsDirty();\n            }\n\n            if ((progress === 'finished' || progress === 'aborted') && !endDateControl.value && !endTimeControl.value) {\n                const now = new Date();\n                endDateControl.setValue(now);\n                endTimeControl.setValue(now);\n                endDateControl.markAsDirty();\n                endTimeControl.markAsDirty();\n            }\n        });\n\n        // --- Address search state ---\n        vm.addressOptions = [];\n        vm._lastSelectedAddressLabel = null;\n\n        vm.displayAddressOption = function(opt) {\n            if (!opt) return '';\n            return (typeof opt === 'string') ? opt : (opt.label || '');\n        };\n\n        vm.searchAddress = function() {\n            const qRaw = vm.editProjectFormGroup.get('address').value || '';\n            const q = (typeof qRaw === 'string') ? qRaw.trim() : vm.displayAddressOption(qRaw).trim();\n            if (q.length < 5) {\n                vm.addressOptions = [];\n                return;\n            }\n            searchAddressViaPhoton(q);\n        };\n\n        vm.onAddressSelected = function(opt) {\n            if (!opt) return;\n            vm._lastSelectedAddressLabel = opt.label;\n\n            const patchData = {\n                address: opt.label,\n                latitude: opt.lat,\n                longitude: opt.lon\n            };\n\n            const currentPostalCode = (vm.editProjectFormGroup.get('postalCode').value || '').trim();\n            const currentCity = (vm.editProjectFormGroup.get('city').value || '').trim();\n\n            if (!currentPostalCode && opt.postcode) {\n                patchData.postalCode = opt.postcode;\n            }\n            if (!currentCity && opt.city) {\n                patchData.city = opt.city;\n            }\n\n            vm.editProjectFormGroup.patchValue(patchData);\n            vm.editProjectFormGroup.get('address').markAsDirty();\n            vm.editProjectFormGroup.get('latitude').markAsDirty();\n            vm.editProjectFormGroup.get('longitude').markAsDirty();\n\n            if (!currentPostalCode && opt.postcode) {\n                vm.editProjectFormGroup.get('postalCode').markAsDirty();\n            }\n            if (!currentCity && opt.city) {\n                vm.editProjectFormGroup.get('city').markAsDirty();\n            }\n\n            vm.addressOptions = [];\n        };\n\n        // --- Debounced auto-search ---\n        let addrTimer = null;\n        let lastQuery = '';\n\n        vm.editProjectFormGroup.get('address').valueChanges.subscribe(val => {\n            if (typeof val === 'string' && vm._lastSelectedAddressLabel && val === vm._lastSelectedAddressLabel) {\n                return;\n            }\n\n            const s = (typeof val === 'string')\n                ? val.trim()\n                : (vm.displayAddressOption(val) || '').trim();\n\n            if (s.length < 5) {\n                vm.addressOptions = [];\n                lastQuery = s;\n                if (addrTimer) {\n                    clearTimeout(addrTimer);\n                    addrTimer = null;\n                }\n                return;\n            }\n\n            if (s === lastQuery) return;\n            lastQuery = s;\n\n            if (addrTimer) clearTimeout(addrTimer);\n            addrTimer = setTimeout(() => {\n                searchAddressViaPhoton(s);\n            }, 350);\n        });\n\n        function searchAddressViaPhoton(query) {\n            const postalCode = (vm.editProjectFormGroup.get('postalCode').value || '').trim();\n            const city = (vm.editProjectFormGroup.get('city').value || '').trim();\n\n            let refinedQuery = query;\n            if (postalCode) refinedQuery += ' ' + postalCode;\n            if (city) refinedQuery += ' ' + city;\n\n            const url = 'https://photon.komoot.io/api?q=' + encodeURIComponent(refinedQuery) + '&limit=5';\n\n            fetch(url)\n                .then(res => {\n                    if (!res.ok) throw new Error('HTTP ' + res.status);\n                    return res.json();\n                })\n                .then(data => {\n                    const features = (data && data.features) ? data.features : [];\n                    vm.addressOptions = features.map(f => {\n                        const p = f.properties || {};\n                        const coords = (f.geometry && f.geometry.coordinates) ? f.geometry.coordinates : [null, null];\n                        const lon = coords[0];\n                        const lat = coords[1];\n\n                        const street = p.street || p.name || '';\n                        const house = p.housenumber ? (' ' + p.housenumber) : '';\n                        const place = (street + house).trim() || (p.label || p.name || '').trim();\n\n                        const cc = (p.countrycode || '').toUpperCase();\n                        const postcode = p.postcode || '';\n                        const cityFromResult = p.city || p.town || p.village || p.state || '';\n\n                        let tail = '';\n                        if (cc || postcode || cityFromResult) {\n                            tail = (cc ? cc : '');\n                            if (cc && postcode) tail += '-' + postcode;\n                            else if (!cc && postcode) tail += postcode;\n                            if ((cc || postcode) && cityFromResult) tail += ' ' + cityFromResult;\n                            else if (!cc && !postcode && cityFromResult) tail += cityFromResult;\n                        }\n\n                        const label = tail ? (place + ', ' + tail) : place;\n\n                        return {\n                            label,\n                            lat: (typeof lat === 'number') ? lat : parseFloat(lat),\n                            lon: (typeof lon === 'number') ? lon : parseFloat(lon),\n                            postcode: postcode,\n                            city: cityFromResult,\n                            raw: f\n                        };\n                    });\n                })\n                .catch(err => {\n                    console.error('Address search failed', err);\n                    vm.addressOptions = [];\n                });\n        }\n\n        vm.cancel = function() {\n            vm.dialogRef.close(null);\n        };\n\n        vm.save = function() {\n            vm.editProjectFormGroup.markAsPristine();\n\n            // Update asset label\n            const formValues = vm.editProjectFormGroup.getRawValue();\n            const updatedProject = {\n                ...vm.project,\n                label: formValues.entityLabel\n            };\n\n            assetService.saveAsset(updatedProject).subscribe(() => {\n                // Build startTimeMs and endTimeMs from date/time pickers\n                let startTimeMs = null;\n                let endTimeMs = null;\n\n                if (formValues.startDate) {\n                    const startDateObj = new Date(formValues.startDate);\n                    if (formValues.startTime) {\n                        const startTimeObj = new Date(formValues.startTime);\n                        startDateObj.setHours(startTimeObj.getHours(), startTimeObj.getMinutes(), startTimeObj.getSeconds());\n                    }\n                    startTimeMs = startDateObj.getTime();\n                }\n\n                if (formValues.endDate) {\n                    const endDateObj = new Date(formValues.endDate);\n                    if (formValues.endTime) {\n                        const endTimeObj = new Date(formValues.endTime);\n                        endDateObj.setHours(endTimeObj.getHours(), endTimeObj.getMinutes(), endTimeObj.getSeconds());\n                    }\n                    endTimeMs = endDateObj.getTime();\n                }\n\n                // Save attributes\n                const attributesArray = [\n                    { key: 'latitude', value: formValues.latitude || vm.attrMap.latitude || 48.1406022 },\n                    { key: 'longitude', value: formValues.longitude || vm.attrMap.longitude || 16.2932688 },\n                    { key: 'address', value: formValues.address || '' },\n                    { key: 'postalCode', value: formValues.postalCode || '' },\n                    { key: 'city', value: formValues.city || '' },\n                    { key: 'progress', value: formValues.progress || 'in preparation' }\n                ];\n\n                if (startTimeMs !== null) {\n                    attributesArray.push({ key: 'startTimeMs', value: startTimeMs });\n                }\n                if (endTimeMs !== null) {\n                    attributesArray.push({ key: 'endTimeMs', value: endTimeMs });\n                }\n\n                if (formValues.projectPicture) {\n                    attributesArray.push({ key: 'projectPicture', value: formValues.projectPicture });\n                }\n\n                attributeService.saveEntityAttributes(entityId, 'SERVER_SCOPE', attributesArray).subscribe(() => {\n                    widgetContext.updateAliases();\n                    vm.dialogRef.close(null);\n                });\n            });\n        };\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e8f12b3a-4c5d-9e7f-a1b2-3c4d5e6f7890"
              },
              {
                "name": "Project Wizard",
                "icon": "rocket_launch",
                "useShowWidgetActionFunction": false,
                "showWidgetActionFunction": "return data.progress === 'in preparation' || data.progress === 'active';",
                "type": "customPretty",
                "customHtml": "",
                "customCss": "",
                "customFunction": {
                  "body": "// Use the Project Wizard library with dataImporter for device assignment\nprojectWizard.openProjectWizardDialog(widgetContext, entityId, entityName, entityLabel, function() {\n    widgetContext.updateAliases();\n}, { dataImporter: dataImporter });\n",
                  "modules": {
                    "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                    "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "9848fd08-5b93-6f97-dc69-65e325748065"
              },
              {
                "name": "Delete Project",
                "icon": "delete",
                "type": "custom",
                "customFunction": {
                  "body": "const projectId = entityId;\nconst projectName = entityName;\nutils.deleteProject(widgetContext, projectId, projectName, function() {\n  widgetContext.updateAliases();\n});",
                  "modules": {
                    "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                  }
                },
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole || '';\nvar isTenantAdmin = widgetContext.currentUser.authority === 'TENANT_ADMIN';\nvar isEcoAdmin = userRole === 'ECO Administrator';\nvar isBelimoAdmin = userRole === 'Belimo Retrofit Administrators';\nvar isEcoDiagAdmin = userRole === 'ECO Diagnostics Administrators';\nvar isAdmin = userRole === 'Administrators';\nreturn isTenantAdmin || isEcoAdmin || isBelimoAdmin || isEcoDiagAdmin || isAdmin;",
                "id": "act-delete-project"
              }
            ],
            "headerButton": [
              {
                "name": "Go Back",
                "buttonType": "raised",
                "showIcon": true,
                "icon": "arrow_back",
                "buttonColor": "#ffffff",
                "buttonFillColor": "var(--tb-primary-500)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n/*params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten*/\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "715d95c5-edd0-8a23-af00-6074f1a5717f"
              },
              {
                "name": "Connect",
                "buttonType": "raised",
                "showIcon": true,
                "icon": "addchart",
                "buttonColor": "#ffffff",
                "buttonFillColor": "var(--tb-accent-500)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": {
                  "body": "utils.dataConnectorDialog(widgetContext, entityId, entityName);",
                  "modules": {
                    "utils": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "3c824487-b796-a41c-5d9e-7eca11e18a04"
              },
              {
                "name": "Project",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addProjectFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 600px; max-width: 90vw;\">\n  <mat-toolbar class=\"flex items-center\" color=\"primary\">\n    <mat-icon style=\"margin-right: 12px;\">folder_open</mat-icon>\n    <h2 style=\"margin: 0; font-size: 18px;\">Add Project</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col gap-3 p-4\">\n\n    <!-- Customer Section -->\n    <fieldset *ngIf=\"isTenantAdmin\" class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">business</mat-icon>\n        Customer\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Customer</mat-label>\n        <mat-select formControlName=\"customer\" (selectionChange)=\"onCustomerChange()\" required>\n          <mat-option *ngFor=\"let c of customers\" [value]=\"c\">{{ c.name }}</mat-option>\n        </mat-select>\n        <mat-error *ngIf=\"addProjectFormGroup.get('customer')?.hasError('required')\">Customer is required.</mat-error>\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Project Info Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">folder</mat-icon>\n        Project Info\n      </legend>\n      <tb-image-input formControlName=\"projectPicture\" label=\"Project Picture\" noImageText=\"No picture selected\"></tb-image-input>\n      <mat-form-field appearance=\"fill\" class=\"w-full disabled-field\">\n        <mat-label>Project ID</mat-label>\n        <input matInput formControlName=\"name\" required readonly>\n        <mat-error *ngIf=\"addProjectFormGroup.get('name').hasError('required')\">Project title is required.</mat-error>\n      </mat-form-field>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Label</mat-label>\n        <input matInput formControlName=\"entityLabel\">\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Address Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">location_on</mat-icon>\n        Address\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Project address</mat-label>\n        <input matInput formControlName=\"address\" [matAutocomplete]=\"addrAuto\" autocomplete=\"off\">\n        <button mat-icon-button matSuffix type=\"button\" (click)=\"searchAddress()\" [disabled]=\"(addProjectFormGroup.get('address').value || '').length < 5\">\n          <mat-icon>search</mat-icon>\n        </button>\n        <mat-autocomplete #addrAuto=\"matAutocomplete\" [displayWith]=\"displayAddressOption\" (optionSelected)=\"onAddressSelected($event.option.value)\">\n          <mat-option *ngFor=\"let opt of addressOptions\" [value]=\"opt\">{{ opt.label }}</mat-option>\n        </mat-autocomplete>\n        <mat-hint *ngIf=\"(addProjectFormGroup.get('address').value || '').length < 5\">Enter at least 5 characters to search</mat-hint>\n      </mat-form-field>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Postal Code</mat-label>\n          <input matInput formControlName=\"postalCode\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 2;\">\n          <mat-label>City</mat-label>\n          <input matInput formControlName=\"city\">\n        </mat-form-field>\n      </div>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Latitude</mat-label>\n          <input matInput formControlName=\"latitude\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Longitude</mat-label>\n          <input matInput formControlName=\"longitude\">\n        </mat-form-field>\n      </div>\n    </fieldset>\n\n  </div>\n  <div class=\"flex justify-end items-center gap-2 p-4\" style=\"border-top: 1px solid #e0e0e0; background: #fafafa;\">\n    <button mat-button (click)=\"cancel()\" type=\"button\">Cancel</button>\n    <button mat-raised-button color=\"primary\" type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addProjectFormGroup.invalid || !addProjectFormGroup.dirty\">\n      <mat-icon style=\"font-size: 18px; width: 18px; height: 18px; margin-right: 4px;\">save</mat-icon>\n      Save\n    </button>\n  </div>\n</form>",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled,\n.edit-project-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form .mdc-text-field--filled:not(.mdc-text-field--disabled),\n.edit-project-form .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .disabled-field input,\n.edit-project-form .disabled-field input {\n  color: rgba(0, 0, 0, 0.6) !important;\n}\n\n.add-entity-form .disabled-field,\n.edit-project-form .disabled-field {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\nmat-icon {\n  vertical-align: middle;\n  margin-right: 4px;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\n//let $scope = widgetContext.$scope;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\n\r\nlet shortNameAttr;\r\nlet customerShortName;\r\nlet nextProjectId = 0;\r\n\r\nconst ctx = widgetContext;\r\nconst isTenantAdmin = ctx.currentUser.authority === 'TENANT_ADMIN';\r\n\r\nlet customers = [];\r\nlet customerId;\r\nlet customerName;\r\n\r\nconst pageLink = ctx.pageLink(1000, 0, null, null, null);\r\n\r\ncustomerService.getUserCustomers(pageLink).subscribe(pageData => {\r\n\r\n    customers = (pageData && pageData.data) ? pageData.data : [];\r\n\r\n    // Non-Tenant-Admin → genau ein Customer\r\n    if (!isTenantAdmin && customers.length === 1) {\r\n        const c = customers[0];\r\n        customerId = {\r\n            id: c.id.id,\r\n            entityType: 'CUSTOMER'\r\n        };\r\n        customerName = c.name;\r\n    }\r\n\r\n    openAddProjectDialog();\r\n});\r\n\r\nfunction getLastProjectId(projects) {\r\n    let maxNumber = 0;\r\n    projects.forEach(item => {\r\n        const name = item.name;\r\n        const parts = name.split('_');\r\n        if (parts.length === 2) {\r\n            const number = parseInt(parts[1], 10);\r\n            if (number > maxNumber) {\r\n                maxNumber = number;\r\n            }\r\n        }\r\n    });\r\n    const nextProjectId = maxNumber + 1;\r\n    return nextProjectId;\r\n}\r\n\r\nfunction openAddProjectDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddProjectDialogController).subscribe();\r\n}\r\n\r\nfunction AddProjectDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.isTenantAdmin = isTenantAdmin;\r\n  vm.customers = customers;\r\n\r\nvm.addProjectFormGroup = vm.fb.group({\r\n    customer: [{ value: null, disabled: !isTenantAdmin }, vm.validators.required],\r\n    name: [{ value: '', disabled: true }, vm.validators.required],\r\n    entityLabel: [''],\r\n    projectPicture: [null],\r\n    address: [''],\r\n    postalCode: [''],\r\n    city: [''],\r\n    latitude: [''],\r\n    longitude: ['']\r\n});\r\n\r\n  // --- Address search state ---\r\n  vm.addressOptions = [];\r\n  vm._lastSelectedAddressLabel = null;\r\n\r\n  vm.displayAddressOption = function (opt) {\r\n    // MatAutocomplete calls displayWith with object OR string\r\n    if (!opt) return '';\r\n    return (typeof opt === 'string') ? opt : (opt.label || '');\r\n  };\r\n\r\n  vm.searchAddress = function () {\r\n    const qRaw = vm.addProjectFormGroup.get('address').value || '';\r\n    const q = (typeof qRaw === 'string') ? qRaw.trim() : vm.displayAddressOption(qRaw).trim();\r\n\r\n    if (q.length < 5) {\r\n      vm.addressOptions = [];\r\n      return;\r\n    }\r\n\r\n    searchAddressViaPhoton(q);\r\n  };\r\n\r\n  vm.onAddressSelected = function (opt) {\r\n    if (!opt) return;\r\n\r\n    vm._lastSelectedAddressLabel = opt.label;\r\n\r\n    // Patch-Objekt vorbereiten\r\n    const patchData = {\r\n      address: opt.label,\r\n      latitude: opt.lat,\r\n      longitude: opt.lon\r\n    };\r\n\r\n    // Nur postalCode und city setzen, wenn sie im Formular NICHT bereits ausgefüllt sind\r\n    const currentPostalCode = (vm.addProjectFormGroup.get('postalCode').value || '').trim();\r\n    const currentCity = (vm.addProjectFormGroup.get('city').value || '').trim();\r\n\r\n    if (!currentPostalCode && opt.postcode) {\r\n      patchData.postalCode = opt.postcode;\r\n    }\r\n    if (!currentCity && opt.city) {\r\n      patchData.city = opt.city;\r\n    }\r\n\r\n    vm.addProjectFormGroup.patchValue(patchData);\r\n\r\n    vm.addProjectFormGroup.get('address').markAsDirty();\r\n    vm.addProjectFormGroup.get('latitude').markAsDirty();\r\n    vm.addProjectFormGroup.get('longitude').markAsDirty();\r\n\r\n    if (!currentPostalCode && opt.postcode) {\r\n      vm.addProjectFormGroup.get('postalCode').markAsDirty();\r\n    }\r\n    if (!currentCity && opt.city) {\r\n      vm.addProjectFormGroup.get('city').markAsDirty();\r\n    }\r\n\r\n    // optional: Ergebnisse leeren, damit Dropdown zugeht\r\n    vm.addressOptions = [];\r\n  };\r\n\r\n  // --- Debounced auto-search without rxjs operators ---\r\n  let addrTimer = null;\r\n  let lastQuery = '';\r\n\r\n  vm.addProjectFormGroup.get('address').valueChanges.subscribe(val => {\r\n    // Wenn eine Auswahl gerade gesetzt wurde, nicht sofort neu suchen\r\n    if (typeof val === 'string' && vm._lastSelectedAddressLabel && val === vm._lastSelectedAddressLabel) {\r\n      return;\r\n    }\r\n\r\n    const s = (typeof val === 'string')\r\n      ? val.trim()\r\n      : (vm.displayAddressOption(val) || '').trim();\r\n\r\n    // Reset results for short strings\r\n    if (s.length < 5) {\r\n      vm.addressOptions = [];\r\n      lastQuery = s;\r\n      if (addrTimer) {\r\n        clearTimeout(addrTimer);\r\n        addrTimer = null;\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Simple distinctUntilChanged\r\n    if (s === lastQuery) {\r\n      return;\r\n    }\r\n    lastQuery = s;\r\n\r\n    // Debounce\r\n    if (addrTimer) {\r\n      clearTimeout(addrTimer);\r\n    }\r\n    addrTimer = setTimeout(() => {\r\n      searchAddressViaPhoton(s);\r\n    }, 350);\r\n  });\r\n\r\n\r\n  function searchAddressViaPhoton(query) {\r\n    // Hole postalCode und city aus dem Formular\r\n    const postalCode = (vm.addProjectFormGroup.get('postalCode').value || '').trim();\r\n    const city = (vm.addProjectFormGroup.get('city').value || '').trim();\r\n\r\n    // Verfeinerte Query erstellen\r\n    let refinedQuery = query;\r\n    if (postalCode) {\r\n      refinedQuery += ' ' + postalCode;\r\n    }\r\n    if (city) {\r\n      refinedQuery += ' ' + city;\r\n    }\r\n\r\n    const url =\r\n      'https://photon.komoot.io/api' +\r\n      '?q=' + encodeURIComponent(refinedQuery) +\r\n      '&limit=5';\r\n\r\n    fetch(url)\r\n      .then(res => {\r\n        if (!res.ok) throw new Error('HTTP ' + res.status);\r\n        return res.json();\r\n      })\r\n      .then(data => {\r\n        const features = (data && data.features) ? data.features : [];\r\n\r\n        vm.addressOptions = features.map(f => {\r\n          const p = f.properties || {};\r\n          const coords = (f.geometry && f.geometry.coordinates) ? f.geometry.coordinates : [null, null];\r\n          const lon = coords[0];\r\n          const lat = coords[1];\r\n\r\n          // Bausteine\r\n          const street = p.street || p.name || '';\r\n          const house = p.housenumber ? (' ' + p.housenumber) : '';\r\n          const place = (street + house).trim() || (p.label || p.name || '').trim();\r\n\r\n          const cc = (p.countrycode || '').toUpperCase();\r\n          const postcode = p.postcode || '';\r\n          const cityFromResult = p.city || p.town || p.village || p.state || '';\r\n\r\n          // Ziel-Format: \"Adresse, CC-PLZ Ort\"\r\n          let tail = '';\r\n          if (cc || postcode || cityFromResult) {\r\n            tail = (cc ? cc : '');\r\n            if (cc && postcode) tail += '-' + postcode;\r\n            else if (!cc && postcode) tail += postcode;\r\n            if ((cc || postcode) && cityFromResult) tail += ' ' + cityFromResult;\r\n            else if (!cc && !postcode && cityFromResult) tail += cityFromResult;\r\n          }\r\n\r\n          const label = tail ? (place + ', ' + tail) : place;\r\n\r\n          return {\r\n            label,\r\n            lat: (typeof lat === 'number') ? lat : parseFloat(lat),\r\n            lon: (typeof lon === 'number') ? lon : parseFloat(lon),\r\n            postcode: postcode,\r\n            city: cityFromResult,\r\n            raw: f\r\n          };\r\n        });\r\n      })\r\n      .catch(err => {\r\n        console.error('Address search failed', err);\r\n        vm.addressOptions = [];\r\n      });\r\n  }\r\n\r\n\r\n  \r\nif (!isTenantAdmin && customerId) {\r\n    vm.addProjectFormGroup.patchValue({\r\n        customer: customers[0]\r\n    });\r\n    vm.addProjectFormGroup.get('customer').markAsDirty();\r\n    loadCustomerData(customerId);\r\n}\r\n\r\n  \r\nvm.onCustomerChange = function () {\r\n    const c = vm.addProjectFormGroup.value.customer;\r\n    if (!c) return;\r\n\r\n    customerId = {\r\n        id: c.id.id,\r\n        entityType: 'CUSTOMER'\r\n    };\r\n    customerName = c.name;\r\n\r\n    loadCustomerData(customerId);\r\n};\r\n\r\n  \r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    vm.addProjectFormGroup.markAsPristine();\r\n    saveProjectObservable(customerId).subscribe(\r\n      function (Project) {\r\n          widgetContext.rxjs.forkJoin([\r\n              saveCustomerToProjectRelation(customerId, Project.id),\r\n              saveAttributes(Project.id)\r\n          ]).subscribe(\r\n              function () {\r\n                var params = widgetContext.stateController.getStateParams();\r\n                var selectedProject = params['selectedProject'];\r\n                params['selectedProject'] = { entityId: Project.id, entityName: Project.name, entityLabel: '' };\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              }\r\n        );\r\n      }\r\n    );\r\n  };\r\n  \r\nfunction loadCustomerData(customerId) {\r\n\r\n    let assetSearchQuery = {\r\n        parameters: {\r\n            rootId: customerId.id,\r\n            rootType: 'CUSTOMER',\r\n            direction: 'FROM',\r\n            relationTypeGroup: 'COMMON',\r\n            maxLevel: 10,\r\n            fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n    };\r\n\r\n    assetService.findByQuery(assetSearchQuery).subscribe(projects => {\r\n\r\n        nextProjectId = getLastProjectId(projects);\r\n\r\n        attributeService\r\n            .getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName'])\r\n            .subscribe(attributes => {\r\n\r\n                const shortNameAttr = attributes.find(a => a.key === 'shortName');\r\n                customerShortName = shortNameAttr\r\n                    ? shortNameAttr.value\r\n                    : customerName;\r\n\r\n                vm.addProjectFormGroup.patchValue({\r\n                    name: customerShortName + '_' + nextProjectId\r\n                });\r\n\r\n                vm.addProjectFormGroup.get('name').markAsDirty();\r\n            });\r\n    });\r\n}\r\n\r\n  function saveProjectObservable(customerId) {\r\n    return getProjectsGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((ProjectsGroup) => {\r\n            const formValues = vm.addProjectFormGroup.getRawValue();\r\n            let Project = {\r\n              name: formValues.name,\r\n              type: 'Project',\r\n              label: formValues.entityLabel,\r\n              customerId: customerId\r\n            };\r\n            return assetService.saveAsset(Project, ProjectsGroup.id.id)\r\n        })\r\n    );\r\n  }\r\n  \r\n  function getProjectsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var ProjectsGroup = entityGroups.find(group => group.name === 'Projects');\r\n              if (ProjectsGroup) {\r\n                  return widgetContext.rxjs.of(ProjectsGroup);\r\n              } else {\r\n                  ProjectsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Projects',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(ProjectsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n\r\n  function saveCustomerToProjectRelation(customerId, ProjectId) {\r\n      var relation = {\r\n          from: customerId,\r\n          to: ProjectId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  \r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n        {\r\n            key: 'latitude',\r\n            value: vm.addProjectFormGroup.value.latitude || 48.1406022\r\n        },\r\n        {\r\n            key: 'longitude',\r\n            value: vm.addProjectFormGroup.value.longitude || 16.2932688\r\n        },\r\n        {\r\n            key: 'address',\r\n            value: vm.addProjectFormGroup.value.address\r\n        },        \r\n        {\r\n            key: 'progress',\r\n            value: 'in preparation'\r\n        },\r\n        {\n            key: 'units',\n            value: 'metric'\n        }\n    ];\n    // Add projectPicture if provided\n    if (vm.addProjectFormGroup.value.projectPicture) {\n        attributesArray.push({\n            key: 'projectPicture',\n            value: vm.addProjectFormGroup.value.projectPicture\n        });\n    }\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "2c6e09e8-98b9-f1ca-0a64-7cce095767a2"
              }
            ],
            "rowDoubleClick": []
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "pageSize": 1024,
          "configMode": "advanced",
          "titleFont": null,
          "titleColor": null,
          "titleIcon": null,
          "iconColor": null,
          "borderRadius": "0px"
        },
        "row": 0,
        "col": 0,
        "id": "fb924e54-6e4b-2d41-5545-dab85e028210",
        "typeFullFqn": "system.cards.entities_table"
      },
      "40680065-1e6b-c6f8-af6a-23e82a99fad9": {
        "typeFullFqn": "system.map",
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1745755787013,
                "endTimeMs": 1745842187013
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": false,
          "backgroundColor": "rgba(0, 0, 0, 0)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "mapType": "geoMap",
            "layers": [
              {
                "label": "{i18n:widgets.maps.layer.roadmap}",
                "provider": "openstreet",
                "layerType": "CartoDB.Positron",
                "referenceLayer": null
              },
              {
                "label": "{i18n:widgets.maps.layer.satellite}",
                "provider": "openstreet",
                "layerType": "Esri.WorldImagery"
              },
              {
                "label": "{i18n:widgets.maps.layer.hybrid}",
                "provider": "openstreet",
                "layerType": "Esri.WorldImagery",
                "referenceLayer": "openstreetmap_hybrid"
              },
              {
                "label": "{i18n:widgets.maps.layer.topographic}",
                "provider": "openstreet",
                "layerType": "Esri.WorldTopoMap",
                "referenceLayer": null
              },
              {
                "label": null,
                "provider": "openstreet",
                "layerType": "OpenStreetMap.HOT",
                "referenceLayer": null
              },
              {
                "label": null,
                "provider": "openstreet",
                "layerType": "Esri.WorldStreetMap",
                "referenceLayer": null
              },
              {
                "provider": "openstreet",
                "layerType": "OpenStreetMap.Mapnik"
              }
            ],
            "imageSource": null,
            "markers": [
              {
                "dsType": "entity",
                "dsLabel": "",
                "dsDeviceId": null,
                "dsEntityAliasId": "d75c5b86-8b39-59e2-59f3-ae1c1ee40910",
                "dsFilterId": "3744b253-8d5c-7528-b178-0c8be5c3adca",
                "additionalDataSources": null,
                "additionalDataKeys": [
                  {
                    "name": "progress",
                    "type": "attribute",
                    "label": "progress",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.9725950885098493
                  },
                  {
                    "name": "name",
                    "type": "entityField",
                    "label": "name",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.2872987416504812,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  },
                  {
                    "name": "address",
                    "type": "attribute",
                    "label": "address",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8026110588871542
                  },
                  {
                    "name": "outsideTemp",
                    "type": "timeseries",
                    "label": "outsideTemp",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.759902282076257
                  },
                  {
                    "name": "outsideHumidity",
                    "type": "timeseries",
                    "label": "outsideHumidity",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.05821233805088244
                  },
                  {
                    "name": "label",
                    "type": "entityField",
                    "label": "label",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8646915284773707,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  }
                ],
                "label": {
                  "show": true,
                  "type": "function",
                  "pattern": "${entityName}",
                  "patternFunction": {
                    "body": "var color = utils.getProgressColor(data.progress).color;\r\n\r\nreturn '<span style=\"border: solid ' + color + '; border-radius: 10px; color: ' + color + '; background-color: #fff; padding: 3px 5px; font-size: 14px; position: relative; bottom: 6px;\">' + \r\n           '${entityName}' + \r\n        '</span>';",
                    "modules": {
                      "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                    }
                  }
                },
                "tooltip": {
                  "show": false,
                  "type": "function",
                  "pattern": "<b>${entityName}</b><br/><br/><b>Latitude:</b> ${latitude:7}<br/><b>Longitude:</b> ${longitude:7}<br/><b>Temperature:</b> ${temperature} °C<br/><small>See tooltip settings for details</small>",
                  "patternFunction": {
                    "body": "const locationName = data.locationName || data.label || entityName;\nconst name = data.name || entityName;\nconst progress = data.progress;\nconst address = data.address || '';\n\nlet progressHtml = '';\nif (progress) {\n    let color, bgColor, label;\n    switch (progress) {\n        case 'active':\n            color = '#27AE60';\n            bgColor = 'rgba(39, 174, 96, 0.12)';\n            label = 'Active';\n            break;\n        case 'in preparation':\n            color = '#F2994A';\n            bgColor = 'rgba(242, 153, 74, 0.12)';\n            label = 'In Preparation';\n            break;\n        case 'finished':\n            color = '#2F80ED';\n            bgColor = 'rgba(47, 128, 237, 0.12)';\n            label = 'Finished';\n            break;\n        case 'aborted':\n            color = '#EB5757';\n            bgColor = 'rgba(235, 87, 87, 0.12)';\n            label = 'Aborted';\n            break;\n        default:\n            color = '#828282';\n            bgColor = 'rgba(130, 130, 130, 0.12)';\n            label = progress || 'Unknown';\n    }\n    progressHtml = '<span style=\"padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; color: ' + color + '; background-color: ' + bgColor + ';\">' + label + '</span>';\n}\n\nreturn '<div style=\"font-family: Roboto; font-size: 14px;\">' +\n    '<div style=\"font-weight: 600; margin-bottom: 4px;\">' + locationName + '</div>' +\n    '<div style=\"color: #666; font-size: 12px; margin-bottom: 4px;\">' + name + '</div>' +\n    (progressHtml ? '<div>' + progressHtml + '</div>' : '') +\n    '<div style=\"color: #999; font-size: 11px; margin-top: 8px;\">Click for details</div>' +\n    '</div>';",
                    "modules": {}
                  },
                  "trigger": "hover",
                  "autoclose": true,
                  "offsetX": 0,
                  "offsetY": -1,
                  "tagActions": null
                },
                "click": {
                  "type": "customPretty",
                  "customHtml": "<form class=\"project-popup-form\">\n  <button class=\"popup-close\" mat-icon-button (click)=\"close()\" type=\"button\">\n    <mat-icon class=\"material-icons\">close</mat-icon>\n  </button>\n  <div mat-dialog-content>\n    <!-- Project Picture -->\n    <section *ngIf=\"project.picture\" class=\"flex flex-col items-center justify-center\" style=\"padding-bottom: 16px;\">\n      <img class=\"project-picture\" [src]=\"project.picture\"/>\n    </section>\n    \n    <!-- Project Name -->\n    <section class=\"flex flex-col items-center justify-center\" style=\"padding-bottom: 16px;\">\n      <div class=\"popup-title\">{{ project.locationName }}</div>\n      <div class=\"popup-subtitle\">{{ project.name }}</div>\n    </section>\n    \n    <mat-divider style=\"margin-bottom: 16px;\"></mat-divider>\n    \n    <!-- Project Details -->\n    <section class=\"flex flex-col gap-2\" style=\"padding-bottom: 16px;\">\n      <div class=\"flex flex-row items-baseline\">\n        <div class=\"popup-label\">Address</div>\n        <div class=\"popup-value\">{{ project.address }}</div>\n      </div>\n      <div class=\"flex flex-row items-center\">\n        <div class=\"popup-label\">Progress</div>\n        <div class=\"popup-badge\" [style.color]=\"project.progressStyle.color\" [style.background-color]=\"project.progressStyle.bgColor\">\n          {{ project.progressStyle.label }}\n        </div>\n      </div>\n      <div class=\"flex flex-row items-center\" *ngIf=\"project.measurementsCount !== null\">\n        <div class=\"popup-label\">Measurements</div>\n        <div class=\"popup-value\">{{ project.measurementsCount }}</div>\n      </div>\n    </section>\n    \n    <!-- Timestamps -->\n    <section *ngIf=\"project.startTime || project.endTime\" class=\"flex flex-row gap-2 flex-wrap\" style=\"padding-bottom: 16px;\">\n      <div *ngIf=\"project.startTime\" class=\"timestamp-badge\" [style.color]=\"project.startTime.color\" [style.background-color]=\"project.startTime.bgColor\">\n        <mat-icon style=\"font-size: 14px; width: 14px; height: 14px; margin-right: 4px;\">{{ project.startTime.icon }}</mat-icon>\n        <span>{{ project.startTime.label }}</span>\n      </div>\n      <div *ngIf=\"project.endTime\" class=\"timestamp-badge\" [style.color]=\"project.endTime.color\" [style.background-color]=\"project.endTime.bgColor\">\n        <mat-icon style=\"font-size: 14px; width: 14px; height: 14px; margin-right: 4px;\">{{ project.endTime.icon }}</mat-icon>\n        <span>{{ project.endTime.label }}</span>\n      </div>\n    </section>\n    \n    <!-- Buttons -->\n    <section class=\"flex flex-row gap-2 items-center justify-center flex-wrap\" style=\"padding-top: 8px;\">\n      <button *ngIf=\"showWizardButton\" type=\"button\" mat-flat-button color=\"primary\" class=\"popup-button wizard-button\" (click)=\"openProjectWizard()\">\n        <mat-icon>rocket_launch</mat-icon>\n        <span>Project Wizard</span>\n      </button>\n      <button type=\"button\" mat-stroked-button color=\"primary\" class=\"popup-button\" (click)=\"openMeasurements()\">\n        <mat-icon>assignment</mat-icon>\n        <span>Measurements</span>\n      </button>\n      <button type=\"button\" mat-stroked-button class=\"popup-button edit-button\" (click)=\"openEditProject()\">\n        <mat-icon>edit</mat-icon>\n        <span>Edit</span>\n      </button>\n    </section>\n  </div>\n</form>",
                  "customCss": ".project-popup-form {\n    width: 420px;\n    position: relative;\n    padding: 16px;\n}\n\n.project-popup-form .mat-mdc-dialog-content {\n    max-height: 95vh;\n    padding: 0;\n}\n\n.project-popup-form .popup-close {\n    position: absolute;\n    top: 8px;\n    right: 8px;\n    z-index: 1;\n}\n\n.project-popup-form .project-picture {\n    width: 160px;\n    height: 160px;\n    border-radius: 8px;\n    object-fit: cover;\n}\n\n.project-popup-form .popup-title {\n    font-weight: 600;\n    font-size: 18px;\n    line-height: 24px;\n    color: #29313C;\n    text-align: center;\n}\n\n.project-popup-form .popup-subtitle {\n    font-size: 14px;\n    color: #666;\n    text-align: center;\n}\n\n.project-popup-form .popup-label {\n    font-size: 13px;\n    line-height: 16px;\n    font-weight: 500;\n    color: rgba(0, 0, 0, 0.38);\n    width: 110px;\n    flex-shrink: 0;\n}\n\n.project-popup-form .popup-value {\n    font-size: 14px;\n    line-height: 20px;\n    font-weight: 500;\n    letter-spacing: 0.25px;\n    color: #29313C;\n}\n\n.project-popup-form .popup-badge {\n    display: inline-block;\n    padding: 4px 8px;\n    border-radius: 8px;\n    font-size: 12px;\n    font-weight: 500;\n    line-height: 16px;\n}\n\n.project-popup-form .timestamp-badge {\n    display: inline-flex;\n    align-items: center;\n    padding: 4px 8px;\n    border-radius: 4px;\n    font-size: 11px;\n    font-weight: 500;\n}\n\n.project-popup-form .popup-button {\n    display: flex;\n    align-items: center;\n    gap: 4px;\n}\n\n.project-popup-form .wizard-button {\n    background-color: #307FE5;\n}\n\n.project-popup-form .edit-button {\n    color: #F2994A;\n    border-color: #F2994A;\n}\n\n.project-popup-form .mat-mdc-outlined-button.mat-primary:not(:disabled),\n.project-popup-form .mat-mdc-stroked-button.mat-primary:not(:disabled) {\n    color: #307FE5;\n    border-color: #307FE5;\n}",
                  "customFunction": {
                    "body": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet rxjs = widgetContext.rxjs;\n\n// Load attributes and relations in parallel\nrxjs.forkJoin([\n    attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE', \n        ['locationName', 'address', 'progress', 'startTimeMs', 'endTimeMs', 'projectPicture']\n    ),\n    entityRelationService.findByFrom(entityId, 'Owns')\n]).subscribe(function(results) {\n    let attributes = results[0];\n    let relations = results[1];\n    \n    let attrMap = {};\n    attributes.forEach(function(attr) {\n        attrMap[attr.key] = attr.value;\n    });\n    \n    // Count measurements (relations with type Owns to ASSETs)\n    let measurementsCount = relations.filter(function(rel) {\n        return rel.to && rel.to.entityType === 'ASSET';\n    }).length;\n    \n    openProjectPopupDialog(attrMap, measurementsCount);\n});\n\nfunction openProjectPopupDialog(attrMap, measurementsCount) {\n    customDialog.customDialog(htmlTemplate, ProjectPopupController).subscribe();\n    \n    function ProjectPopupController(instance) {\n        let vm = instance;\n        \n        // Progress styling\n        let progressStyle = getProgressColor(attrMap.progress);\n        \n        // Timestamp styling\n        let startTime = getTimestampStyle(attrMap.startTimeMs, 'start');\n        let endTime = getTimestampStyle(attrMap.endTimeMs, 'end');\n        \n        vm.project = {\n            name: entityName,\n            locationName: attrMap.locationName || entityLabel || entityName,\n            address: attrMap.address || 'N/A',\n            progress: attrMap.progress,\n            progressStyle: progressStyle,\n            picture: attrMap.projectPicture || null,\n            startTime: startTime,\n            endTime: endTime,\n            measurementsCount: measurementsCount\n        };\n        \n        vm.showWizardButton = (attrMap.progress === 'in preparation' || attrMap.progress === 'active');\n        \n        vm.close = function() {\n            vm.dialogRef.close(null);\n        };\n        \n        vm.openProjectWizard = function() {\n            vm.dialogRef.close(null);\n            projectWizard.openProjectWizardDialog(widgetContext, entityId, entityName, entityLabel, function() {\n                widgetContext.updateAliases();\n            }, { dataImporter: dataImporter });\n        };\n        \n        vm.openMeasurements = function() {\n            vm.dialogRef.close(null);\n            var params = widgetContext.stateController.getStateParams();\n            var selectedProject = params['selectedProject'];\n            if (selectedProject && selectedProject.entityId.id === entityId.id) {\n                params['selectedProject'] = null;\n            } else {\n                params['selectedProject'] = { \n                    entityId: entityId, \n                    entityName: entityName, \n                    entityLabel: entityLabel \n                };\n            }\n            widgetContext.stateController.updateState(null, params);\n        };\n        vm.openEditProject = function() {\n            vm.dialogRef.close(null);\n            projectWizard.openEditProjectDialog(widgetContext, entityId, entityName, entityLabel, function() {\n                widgetContext.updateAliases();\n            });\n        };\n\n        \n        // Helper functions\n        function getProgressColor(progress) {\n            let color, bgColor, label;\n            switch (progress) {\n                case 'in preparation':\n                    color = '#F2994A';\n                    bgColor = 'rgba(242, 153, 74, 0.12)';\n                    label = 'In Preparation';\n                    break;\n                case 'planned':\n                    color = '#F2994A';\n                    bgColor = 'rgba(242, 153, 74, 0.12)';\n                    label = 'Planned';\n                    break;\n                case 'active':\n                    color = '#27AE60';\n                    bgColor = 'rgba(39, 174, 96, 0.12)';\n                    label = 'Active';\n                    break;\n                case 'finished':\n                    color = '#2F80ED';\n                    bgColor = 'rgba(47, 128, 237, 0.12)';\n                    label = 'Finished';\n                    break;\n                case 'aborted':\n                    color = '#EB5757';\n                    bgColor = 'rgba(235, 87, 87, 0.12)';\n                    label = 'Aborted';\n                    break;\n                default:\n                    color = '#828282';\n                    bgColor = 'rgba(130, 130, 130, 0.12)';\n                    label = progress || 'N/A';\n            }\n            return { color: color, bgColor: bgColor, label: label };\n        }\n        \n        function getTimestampStyle(timestampMs, type) {\n            if (timestampMs === null || timestampMs === undefined) {\n                return null;\n            }\n            var date = new Date(Number(timestampMs));\n            var pad = function(n) { return n.toString().padStart(2, '0'); };\n            var formattedTime = date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' + pad(date.getDate()) +\n                ' ' + pad(date.getHours()) + ':' + pad(date.getMinutes());\n            \n            var icon, color, bgColor, label;\n            if (type === 'start') {\n                icon = 'play_circle';\n                color = '#27AE60';\n                bgColor = 'rgba(39, 174, 96, 0.12)';\n                label = 'Start: ' + formattedTime;\n            } else {\n                icon = 'stop_circle';\n                color = '#2F80ED';\n                bgColor = 'rgba(47, 128, 237, 0.12)';\n                label = 'End: ' + formattedTime;\n            }\n            return { icon: icon, color: color, bgColor: bgColor, label: label };\n        }\n    }\n}",
                    "modules": {
                      "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js",
                      "dataImporter": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                    }
                  },
                  "customResources": [],
                  "openInSeparateDialog": false,
                  "openInPopover": false
                },
                "groups": null,
                "edit": {
                  "enabledActions": [
                    "add",
                    "move"
                  ],
                  "attributeScope": "SERVER_SCOPE",
                  "snappable": false
                },
                "xKey": {
                  "name": "latitude",
                  "label": "latitude",
                  "type": "attribute",
                  "settings": {},
                  "color": "#2196f3"
                },
                "yKey": {
                  "name": "longitude",
                  "label": "longitude",
                  "type": "attribute",
                  "settings": {},
                  "color": "#2196f3"
                },
                "markerType": "icon",
                "markerShape": {
                  "shape": "markerShape1",
                  "size": 34,
                  "color": {
                    "type": "constant",
                    "color": "#307FE5"
                  }
                },
                "markerIcon": {
                  "iconContainer": "iconContainer4",
                  "icon": "domain",
                  "size": 40,
                  "color": {
                    "type": "function",
                    "color": "#307FE5",
                    "rangeKey": null,
                    "range": null,
                    "colorFunction": {
                      "body": "return utils.getProgressColor(data.progress).color;",
                      "modules": {
                        "utils": "tb-resource;/api/resource/js_module/tenant/ECO Diagnostics Utils JS.js"
                      }
                    }
                  }
                },
                "markerImage": {
                  "type": "image",
                  "image": "/assets/markers/shape1.svg",
                  "imageSize": 34
                },
                "markerOffsetX": 0.5,
                "markerOffsetY": 1,
                "markerClustering": {
                  "enable": true,
                  "zoomOnClick": true,
                  "maxZoom": null,
                  "maxClusterRadius": 80,
                  "zoomAnimation": true,
                  "showCoverageOnHover": true,
                  "spiderfyOnMaxZoom": false,
                  "chunkedLoad": false,
                  "lazyLoad": true,
                  "useClusterMarkerColorFunction": false,
                  "clusterMarkerColorFunction": null
                }
              }
            ],
            "polygons": [],
            "circles": [],
            "additionalDataSources": [
              {
                "dsType": "entity",
                "dsLabel": "",
                "dataKeys": [
                  {
                    "name": "latitude",
                    "type": "attribute",
                    "label": "selectedProject",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.5634367819170003,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  }
                ],
                "dsEntityAliasId": "faef915b-be60-5c6b-d62c-114957e80421"
              },
              {
                "dsType": "entity",
                "dsLabel": "",
                "dataKeys": [
                  {
                    "name": "role",
                    "type": "attribute",
                    "label": "role",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.7014478669430672
                  },
                  {
                    "name": "displayAbortedMeasurement",
                    "type": "attribute",
                    "label": "displayAbortedMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8011587598224269
                  },
                  {
                    "name": "displayActiveMeasurement",
                    "type": "attribute",
                    "label": "displayActiveMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8205299052205228
                  },
                  {
                    "name": "displayFinishedMeasurement",
                    "type": "attribute",
                    "label": "displayFinishedMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.038665901375789624
                  },
                  {
                    "name": "displayPreparationMeasurement",
                    "type": "attribute",
                    "label": "displayPreparationMeasurement",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.21373032656145663
                  }
                ],
                "dsEntityAliasId": "203b0867-b867-ef98-1791-03046c133b7d"
              }
            ],
            "controlsPosition": "topleft",
            "zoomActions": [
              "scroll",
              "doubleClick",
              "controlButtons"
            ],
            "scales": [
              "metric"
            ],
            "dragModeButton": true,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "defaultCenterPosition": "0,0",
            "defaultZoomLevel": null,
            "mapPageSize": 16384,
            "mapActionButtons": [
              {
                "label": "Filter",
                "icon": "filter_alt",
                "color": "#0000008A",
                "action": {
                  "type": "openDashboardState",
                  "targetDashboardStateId": "Measurement_state_filter",
                  "setEntityId": true,
                  "stateEntityParamName": null,
                  "openRightLayout": false,
                  "popoverPreferredPlacement": "top",
                  "popoverHideOnClickOutside": true,
                  "popoverHideDashboardToolbar": true,
                  "popoverWidth": "300px",
                  "popoverHeight": "250px",
                  "popoverStyle": {
                    "padding": "16px",
                    "borderRadius": "8px",
                    "boxShadow": "0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",
                    "background": "#ffffff"
                  },
                  "openInSeparateDialog": false,
                  "openInPopover": true
                }
              },
              {
                "label": "Add Project",
                "icon": "add",
                "color": "#0000008a",
                "action": {
                  "type": "placeMapItem",
                  "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addProjectFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 600px; max-width: 90vw;\">\n  <mat-toolbar class=\"flex items-center\" color=\"primary\">\n    <mat-icon style=\"margin-right: 12px;\">folder_open</mat-icon>\n    <h2 style=\"margin: 0; font-size: 18px;\">Add Project</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col gap-3 p-4\">\n\n    <!-- Customer Section -->\n    <fieldset *ngIf=\"isTenantAdmin\" class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">business</mat-icon>\n        Customer\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Customer</mat-label>\n        <mat-select formControlName=\"customer\" (selectionChange)=\"onCustomerChange()\" required>\n          <mat-option *ngFor=\"let c of customers\" [value]=\"c\">{{ c.name }}</mat-option>\n        </mat-select>\n        <mat-error *ngIf=\"addProjectFormGroup.get('customer')?.hasError('required')\">Customer is required.</mat-error>\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Project Info Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">folder</mat-icon>\n        Project Info\n      </legend>\n      <tb-image-input formControlName=\"projectPicture\" label=\"Project Picture\" noImageText=\"No picture selected\"></tb-image-input>\n      <mat-form-field appearance=\"fill\" class=\"w-full disabled-field\">\n        <mat-label>Project ID</mat-label>\n        <input matInput formControlName=\"name\" required readonly>\n        <mat-error *ngIf=\"addProjectFormGroup.get('name').hasError('required')\">Project title is required.</mat-error>\n      </mat-form-field>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Label</mat-label>\n        <input matInput formControlName=\"entityLabel\">\n      </mat-form-field>\n    </fieldset>\n\n    <!-- Address Section -->\n    <fieldset class=\"fieldset\" style=\"border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 0;\">\n      <legend class=\"flex items-center gap-2\" style=\"font-weight: 600; color: #305680; padding: 0 8px;\">\n        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px;\">location_on</mat-icon>\n        Address\n      </legend>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>Project address</mat-label>\n        <input matInput formControlName=\"address\" [matAutocomplete]=\"addrAuto\" autocomplete=\"off\">\n        <button mat-icon-button matSuffix type=\"button\" (click)=\"searchAddress()\" [disabled]=\"(addProjectFormGroup.get('address').value || '').length < 5\">\n          <mat-icon>search</mat-icon>\n        </button>\n        <mat-autocomplete #addrAuto=\"matAutocomplete\" [displayWith]=\"displayAddressOption\" (optionSelected)=\"onAddressSelected($event.option.value)\">\n          <mat-option *ngFor=\"let opt of addressOptions\" [value]=\"opt\">{{ opt.label }}</mat-option>\n        </mat-autocomplete>\n        <mat-hint *ngIf=\"(addProjectFormGroup.get('address').value || '').length < 5\">Enter at least 5 characters to search</mat-hint>\n      </mat-form-field>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Postal Code</mat-label>\n          <input matInput formControlName=\"postalCode\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 2;\">\n          <mat-label>City</mat-label>\n          <input matInput formControlName=\"city\">\n        </mat-form-field>\n      </div>\n      <div class=\"flex gap-2\">\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Latitude</mat-label>\n          <input matInput formControlName=\"latitude\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\n          <mat-label>Longitude</mat-label>\n          <input matInput formControlName=\"longitude\">\n        </mat-form-field>\n      </div>\n    </fieldset>\n\n  </div>\n  <div class=\"flex justify-end items-center gap-2 p-4\" style=\"border-top: 1px solid #e0e0e0; background: #fafafa;\">\n    <button mat-button (click)=\"cancel()\" type=\"button\">Cancel</button>\n    <button mat-raised-button color=\"primary\" type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addProjectFormGroup.invalid || !addProjectFormGroup.dirty\">\n      <mat-icon style=\"font-size: 18px; width: 18px; height: 18px; margin-right: 4px;\">save</mat-icon>\n      Save\n    </button>\n  </div>\n</form>",
                  "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled,\n.edit-project-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form .mdc-text-field--filled:not(.mdc-text-field--disabled),\n.edit-project-form .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .mat-mdc-form-field-focus-overlay,\n.edit-project-form .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form .disabled-field input,\n.edit-project-form .disabled-field input {\n  color: rgba(0, 0, 0, 0.6) !important;\n}\n\n.add-entity-form .disabled-field,\n.edit-project-form .disabled-field {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\nmat-icon {\n  vertical-align: middle;\n  margin-right: 4px;\n}",
                  "customFunction": "/*========================================================================*/\n/*========  Add Project with Customer Selection & Reverse Geocoding  =====*/\n/*========================================================================*/\n\nlet $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\nlet $http = $injector.get(widgetContext.servicesMap.get('http'));\n\n// Get marker coordinates\nconst markerLat = additionalParams.coordinates.x;\nconst markerLon = additionalParams.coordinates.y;\n\nconsole.log(\"Marker Coordinates: \", markerLat, markerLon);\n\n// Check if Tenant Admin\nconst isTenantAdmin = widgetContext.currentUser.authority === 'TENANT_ADMIN';\nconst pageLink = widgetContext.pageLink(1000, 0, null, null, null);\n\n// Shared variables for async operations\nlet customers = [];\nlet selectedCustomerId = null;\nlet selectedCustomerName = null;\nlet addressData = null;\nlet nextProjectId = 0;\nlet customerShortName = '';\n\n// Step 1: Reverse Geocoding\nreverseGeocode(markerLat, markerLon)\n  .then(data => {\n    addressData = data;\n    console.log('Reverse geocoding result:', addressData);\n\n    // Step 2: Fetch customers\n    return fetchCustomers();\n  })\n  .then(() => {\n    console.log('Customers fetched:', customers);\n\n    // Step 3: Open dialog with customer selection\n    openAddProjectDialog();\n  })\n  .catch(error => {\n    console.error('Error in Add Project workflow:', error);\n  });\n\n/**\n * Reverse Geocoding: Converts lat/lon to address using Photon API\n * Address format: Straßenname Hausnummer, CC-Postleitzahl Ort\n */\nfunction reverseGeocode(lat, lon) {\n  return new Promise((resolve, reject) => {\n    const url = `https://photon.komoot.io/reverse?lat=${lat}&lon=${lon}&limit=1`;\n\n    $http.get(url).subscribe(\n      response => {\n        if (response && response.features && response.features.length > 0) {\n          const feature = response.features[0];\n          const props = feature.properties;\n\n          // Build address in format: Straßenname Hausnummer, CC-Postleitzahl Ort\n          let street = props.street || props.name || '';\n          let housenumber = props.housenumber || '';\n          let postcode = props.postcode || '';\n          let city = props.city || props.town || props.village || '';\n          let countryCode = props.countrycode ? props.countrycode.toUpperCase() : '';\n\n          // Street + Housenumber part\n          let addressLine = street;\n          if (housenumber) {\n            addressLine += ' ' + housenumber;\n          }\n\n          // CC-Postcode + City part\n          let locationLine = '';\n          if (countryCode && postcode) {\n            locationLine = countryCode + '-' + postcode;\n          } else if (postcode) {\n            locationLine = postcode;\n          }\n          if (city) {\n            locationLine += (locationLine ? ' ' : '') + city;\n          }\n\n          // Combined format: \"Street Number, CC-Postcode City\"\n          let fullAddress = addressLine;\n          if (locationLine) {\n            fullAddress += ', ' + locationLine;\n          }\n\n          const result = {\n            address: fullAddress,\n            postalCode: postcode,\n            city: city,\n            latitude: lat,\n            longitude: lon\n          };\n\n          resolve(result);\n        } else {\n          resolve({\n            address: '',\n            postalCode: '',\n            city: '',\n            latitude: lat,\n            longitude: lon\n          });\n        }\n      },\n      error => {\n        console.error('Photon API error:', error);\n        reject(error);\n      }\n    );\n  });\n}\n\n/**\n * Fetch customers based on user role\n */\nfunction fetchCustomers() {\n  return new Promise((resolve, reject) => {\n    customerService.getUserCustomers(pageLink).subscribe(\n      pageData => {\n        customers = (pageData && pageData.data) ? pageData.data : [];\n\n        // Non-Tenant-Admin → automatically select the single customer\n        if (!isTenantAdmin && customers.length === 1) {\n          const c = customers[0];\n          selectedCustomerId = {\n            id: c.id.id,\n            entityType: 'CUSTOMER'\n          };\n          selectedCustomerName = c.name;\n        }\n\n        resolve();\n      },\n      error => {\n        console.error('Error fetching customers:', error);\n        reject(error);\n      }\n    );\n  });\n}\n\nfunction openAddProjectDialog() {\n  customDialog.customDialog(htmlTemplate, AddProjectDialogController).subscribe();\n}\n\nfunction AddProjectDialogController(instance) {\n  let vm = instance;\n\n  vm.isTenantAdmin = isTenantAdmin;\n  vm.customers = customers;\n\n  // FormGroup erstellen\n  vm.addProjectFormGroup = vm.fb.group({\n    customer: [{ value: null, disabled: !isTenantAdmin }, vm.validators.required],\n    name: [{ value: '', disabled: true }, vm.validators.required],\n    entityLabel: [''],\n    projectPicture: [''],\n    address: [addressData ? addressData.address : ''],\n    postalCode: [addressData ? addressData.postalCode : ''],\n    city: [addressData ? addressData.city : ''],\n    latitude: [addressData ? addressData.latitude.toFixed(6) : markerLat.toFixed(6)],\n    longitude: [addressData ? addressData.longitude.toFixed(6) : markerLon.toFixed(6)]\n  });\n\n  // Customer vorausfüllen (Non-Tenant-Admin)\n  if (!isTenantAdmin && selectedCustomerId) {\n    vm.addProjectFormGroup.patchValue({\n      customer: customers[0]\n    });\n    vm.addProjectFormGroup.get('customer').markAsDirty();\n    loadCustomerData(selectedCustomerId, selectedCustomerName);\n  }\n\n  // Customer Change Handler\n  vm.onCustomerChange = function () {\n    const c = vm.addProjectFormGroup.getRawValue().customer;\n    if (!c) return;\n\n    selectedCustomerId = {\n      id: c.id.id,\n      entityType: 'CUSTOMER'\n    };\n    selectedCustomerName = c.name;\n\n    loadCustomerData(selectedCustomerId, selectedCustomerName);\n  };\n\n  // Load customer-specific data (projects + shortName)\n  function loadCustomerData(customerId, customerName) {\n    const assetSearchQuery = {\n      \"parameters\": {\n        \"rootId\": customerId.id,\n        \"rootType\": \"CUSTOMER\",\n        \"direction\": \"FROM\",\n        \"relationTypeGroup\": \"COMMON\",\n        \"maxLevel\": 10,\n        \"fetchLastLevelOnly\": false\n      },\n      \"relationType\": \"Owns\",\n      \"assetTypes\": [\"Project\"]\n    };\n\n    assetService.findByQuery(assetSearchQuery).subscribe(projects => {\n      nextProjectId = getLastProjectId(projects);\n\n      attributeService\n        .getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName'])\n        .subscribe(attributes => {\n          const shortNameAttr = attributes.find(a => a.key === 'shortName');\n          customerShortName = shortNameAttr ? shortNameAttr.value : customerName;\n\n          vm.addProjectFormGroup.patchValue({\n            name: customerShortName + '_' + nextProjectId\n          });\n\n          vm.addProjectFormGroup.get('name').markAsDirty();\n        });\n    });\n  }\n\n  function getLastProjectId(projects) {\n    let maxNumber = 0;\n    projects.forEach(item => {\n      const name = item.name;\n      const parts = name.split('_');\n      if (parts.length === 2) {\n        const number = parseInt(parts[1], 10);\n        if (number > maxNumber) {\n          maxNumber = number;\n        }\n      }\n    });\n    return maxNumber + 1;\n  }\n\n  vm.cancel = function() {\n    vm.dialogRef.close(null);\n  };\n\n  vm.save = function () {\n    if (!selectedCustomerId) {\n      console.error('No customer selected');\n      return;\n    }\n\n    // Validate that name is set\n    const formValues = vm.addProjectFormGroup.getRawValue();\n    if (!formValues.name || formValues.name === '') {\n      console.error('Project name is not set. Please select a customer first.');\n      return;\n    }\n\n    vm.addProjectFormGroup.markAsPristine();\n    saveProjectObservable(selectedCustomerId).subscribe(\n      function (Project) {\n        widgetContext.rxjs.forkJoin([\n          saveCustomerToProjectRelation(selectedCustomerId, Project.id),\n          saveAttributes(Project.id)\n        ]).subscribe(\n          function () {\n            var params = widgetContext.stateController.getStateParams();\n            params['selectedProject'] = {\n              entityId: Project.id,\n              entityName: Project.name,\n              entityLabel: ''\n            };\n            widgetContext.updateAliases();\n            vm.dialogRef.close(null);\n          }\n        );\n      }\n    );\n  };\n\n  function saveProjectObservable(customerId) {\n    return getProjectsGroup(customerId).pipe(\n      widgetContext.rxjs.switchMap((ProjectsGroup) => {\n        const formValues = vm.addProjectFormGroup.getRawValue();\n        let Project = {\n          name: formValues.name,\n          type: 'Project',\n          label: formValues.entityLabel,\n          customerId: customerId\n        };\n        return assetService.saveAsset(Project, ProjectsGroup.id.id)\n      })\n    );\n  }\n\n  function saveAttributes(entityId) {\n    let attributesArray = getMapItemLocationAttributes();\n    const formValues = vm.addProjectFormGroup.getRawValue();\n\n    attributesArray.push({key: 'address', value: formValues.address});\n    attributesArray.push({key: 'postalCode', value: formValues.postalCode});\n    attributesArray.push({key: 'city', value: formValues.city});\n    attributesArray.push({key: 'progress', value: 'in preparation'});\n    attributesArray.push({key: 'units', value: 'metric'});\n    attributesArray.push({key: 'projectPicture', value: formValues.projectPicture || ''});\n\n    if (attributesArray.length > 0) {\n      return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n    }\n    return widgetContext.rxjs.of([]);\n  }\n\n  function getProjectsGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\n      widgetContext.rxjs.switchMap((entityGroups) => {\n        var ProjectsGroup = entityGroups.find(group => group.name === 'Projects');\n        if (ProjectsGroup) {\n          return widgetContext.rxjs.of(ProjectsGroup);\n        } else {\n          ProjectsGroup = {\n            type: 'ASSET',\n            name: 'Projects',\n            ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(ProjectsGroup);\n        }\n      })\n    );\n  }\n\n  function saveCustomerToProjectRelation(customerId, ProjectId) {\n    var relation = {\n      from: customerId,\n      to: ProjectId,\n      typeGroup: 'COMMON',\n      type: 'Owns'\n    };\n    return entityRelationService.saveRelation(relation);\n  }\n\n  function getMapItemLocationAttributes() {\n    const attributes = [];\n    const mapItemType = $event.shape;\n    if (mapItemType === 'Marker') {\n      const mapType = widgetContext.mapInstance.type();\n      attributes.push({key: mapType === 'image' ? 'xPos' : 'latitude', value: additionalParams.coordinates.x});\n      attributes.push({key: mapType === 'image' ? 'yPos' : 'longitude', value: additionalParams.coordinates.y});\n    } else if (mapItemType === 'Rectangle' || mapItemType === 'Polygon') {\n      attributes.push({key: 'perimeter', value: additionalParams.coordinates});\n    } else if (mapItemType === 'Circle') {\n      attributes.push({key: 'circle', value: additionalParams.coordinates});\n    }\n    return attributes;\n  }\n}\n",
                  "customResources": [],
                  "mapItemType": "marker",
                  "mapItemTooltips": {},
                  "openInSeparateDialog": false,
                  "openInPopover": false
                }
              }
            ],
            "background": {
              "type": "color",
              "color": "#fff",
              "overlay": {
                "enabled": false,
                "color": "rgba(255,255,255,0.72)",
                "blur": 3
              }
            },
            "padding": "8px"
          },
          "title": "Map",
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "showTitleIcon": false,
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": true,
          "widgetStyle": {},
          "widgetCss": "",
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "configMode": "advanced",
          "titleFont": null,
          "titleColor": null,
          "margin": "0px",
          "borderRadius": "8px",
          "iconSize": "24px",
          "titleIcon": "map",
          "iconColor": "#1F6BDD",
          "actions": {
            "headerButton": []
          },
          "enableDataExport": false
        },
        "row": 0,
        "col": 0,
        "id": "40680065-1e6b-c6f8-af6a-23e82a99fad9"
      },
      "c6b19443-5057-176b-d3f8-2eebb67fc35e": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "203b0867-b867-ef98-1791-03046c133b7d",
              "dataKeys": [
                {
                  "name": "role",
                  "type": "attribute",
                  "label": "role",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.8853142583803868
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "0d59106c-3aec-67d1-e5c6-1bea2904541b",
              "dataKeys": [
                {
                  "name": "assignedTo",
                  "type": "attribute",
                  "label": "assignedTo",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.7564806610383635
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678196817440,
                "endTimeMs": 1678283217440
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "\n// Datasources:\n// \"Current User\" -> user role\n// \"Customer Diagnostic Kits\" -> kits (changed from \"All Diagnostic Kits\")\n\nvar userRole = '';\nvar kitsTotal = 0, kitsAssigned = 0, kitsAvailable = 0;\n\ndata.forEach(function(item) {\n  var alias = item.aliasName || '';\n\n  if (alias === 'Current User') {\n    // Current User\n    userRole = item.role || '';\n  } else if (alias === 'Customer Diagnostic Kits') {\n    // Changed from \"All Diagnostic Kits\" to match actual datasource alias\n    kitsTotal++;\n    if (item.assignedTo && item.assignedTo !== 'None' && item.assignedTo !== '') {\n      kitsAssigned++;\n    } else {\n      kitsAvailable++;\n    }\n  }\n});\n\nvar stateParams = ctx.stateController.getStateParams();\nvar isTenantAdmin = ctx.currentUser.authority === 'TENANT_ADMIN';\nvar isEcoAdmin = userRole === 'ECO Administrator';\nvar isAdmin = isTenantAdmin || isEcoAdmin;\nstateParams['userRole'] = userRole;\nctx.stateController.updateState(null, stateParams);\n\n// Header HTML with Go Back, Transfer Kit (ECO Admin only), and Add Kit (ECO/Tenant Admin) buttons\nvar headerHtml = '<div class=\"manage-header kits\">' +\n    '<div class=\"header-left\">' +\n        '<a id=\"btn-go-back\" class=\"back-button\" role=\"button\" title=\"Go Back\">' +\n            '<mat-icon>arrow_back</mat-icon>' +\n        '</a>' +\n        '<div class=\"header-title\">' +\n            '<h1><mat-icon>medical_services</mat-icon>Diagnostic Kits</h1>' +\n            '<div class=\"header-stats\">' +\n                '<span class=\"stat-item\"><span class=\"stat-dot total\"></span><span class=\"stat-value\">' + kitsTotal + '</span> Total</span>' +\n                '<span class=\"stat-item\"><span class=\"stat-dot assigned\"></span><span class=\"stat-value\">' + kitsAssigned + '</span> Assigned</span>' +\n                '<span class=\"stat-item\"><span class=\"stat-dot available\"></span><span class=\"stat-value\">' + kitsAvailable + '</span> Available</span>' +\n            '</div>' +\n        '</div>' +\n    '</div>' +\n    '<div class=\"header-right\">' +\n        (isEcoAdmin ? '<a id=\"btn-transfer-kit\" class=\"header-action-btn transfer\" role=\"button\" title=\"Transfer Kit\"><mat-icon>swap_horiz</mat-icon>Transfer Kit</a>' : '') +\n        (isAdmin ? '<a id=\"btn-add-kit\" class=\"header-action-btn\" role=\"button\" title=\"Add Kit\"><mat-icon>add</mat-icon>Add Kit</a>' : '') +\n    '</div>' +\n'</div>';\n\n// Content - fxFlex directly on tb-dashboard-state\nvar contentHtml = isAdmin\n    ? '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"manage_diagnostickits_admin\"></tb-dashboard-state>'\n    : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"manage_diagnostickits_admin\"></tb-dashboard-state>';\n\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\n       headerHtml +\n       contentHtml +\n       '</div>';\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget {\n    border-radius: 0px;\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n/* === Reusable Manage Header === */\n.manage-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem;\n    border-radius: 8px;\n    color: #ffffff;\n    min-height: 70px;\n    margin-bottom: 1rem;\n}\n\n.manage-header.kits {\n    background: linear-gradient(135deg, #3a6a9e 0%, #2c5278 100%);\n}\n\n.manage-header.projects {\n    background: linear-gradient(135deg, #26a69a 0%, #00897b 100%);\n}\n\n.manage-header.users {\n    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);\n}\n\n.header-left {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n}\n\n.back-button {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    width: 40px;\n    height: 40px;\n    background: rgba(255,255,255,0.15);\n    border: 1px solid rgba(255,255,255,0.3);\n    border-radius: 8px;\n    color: #ffffff;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    text-decoration: none;\n}\n\n.back-button:hover {\n    background: rgba(255,255,255,0.25);\n}\n\n.back-button mat-icon {\n    font-size: 24px !important;\n    width: 24px !important;\n    height: 24px !important;\n}\n\n.header-title {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n}\n\n.header-title h1 {\n    font-size: 1.4rem;\n    font-weight: 600;\n    margin: 0;\n    display: flex;\n    align-items: center;\n    gap: 0.6rem;\n}\n\n.header-title h1 mat-icon {\n    font-size: 26px !important;\n    width: 26px !important;\n    height: 26px !important;\n    opacity: 0.9;\n}\n\n.header-stats {\n    display: flex;\n    gap: 1.25rem;\n    font-size: 0.85rem;\n    opacity: 0.9;\n}\n\n.stat-item {\n    display: flex;\n    align-items: center;\n    gap: 0.35rem;\n}\n\n.stat-dot {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n}\n\n.stat-dot.total { background-color: #ffffff; }\n.stat-dot.assigned { background-color: #EB5757; }\n.stat-dot.available { background-color: #27AE60; }\n.stat-dot.planned { background-color: #F2994A; }\n.stat-dot.active { background-color: #27AE60; }\n.stat-dot.finished { background-color: #2F80ED; }\n.stat-dot.admin { background-color: #EB5757; }\n.stat-dot.engineer { background-color: #2F80ED; }\n.stat-dot.user { background-color: #27AE60; }\n\n.stat-value {\n    font-weight: 600;\n}\n\n.header-right {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n}\n\n.header-action-btn {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.6rem 1.2rem;\n    background: rgba(255,255,255,0.15);\n    border: 1px solid rgba(255,255,255,0.4);\n    border-radius: 6px;\n    color: #ffffff !important;\n    font-size: 0.875rem;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    text-decoration: none;\n}\n\n.header-action-btn mat-icon {\n    color: #ffffff !important;\n}\n\n.header-action-btn:hover {\n    background: rgba(255,255,255,0.95);\n    color: #2c5278 !important;\n    border-color: transparent;\n}\n\n.header-action-btn:hover mat-icon {\n    color: #2c5278 !important;\n}\n\n\n/* Force white text in manage-header */\n.manage-header,\n.manage-header h1,\n.manage-header .header-title,\n.manage-header .header-stats,\n.manage-header .stat-item,\n.manage-header .stat-value,\n.manage-header mat-icon {\n    color: #ffffff !important;\n}\n\n.content-area {\n    flex: 1;\n    overflow: hidden;\n}\n\n.main-layout .header {\n    height: 60px;\n    margin: 4px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n/* Flexbox height fix - prevent scrolling */\n.main-layout {\n    display: flex;\n    flex-direction: column;\n    min-height: 0;\n    overflow: hidden;\n}\n\n.main-layout > .manage-header {\n    flex: 0 0 auto;\n}\n\n.main-layout > tb-dashboard-state {\n    flex: 1 1 auto;\n    min-height: 0;\n    height: 100%;\n    overflow: hidden;\n}\n\n/* Ensure parent containers also have proper height */\n.tb-markdown-view {\n    height: 100%;\n    overflow: hidden;\n}\n\n.tb-markdown-view > div {\n    height: 100%;\n    overflow: hidden;\n}\n\n/* Transfer Kit Button - distinct styling */\n.header-action-btn.transfer {\n    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);\n    margin-right: 8px;\n}\n\n.header-action-btn.transfer:hover {\n    background: linear-gradient(135deg, #d97706 0%, #b45309 100%);\n    transform: translateY(-1px);\n    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);\n}\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow.no-padding {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 4px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "btn-go-back",
                "icon": "arrow_back",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nvar number = (widgetContext.stateController.getStateIndex())-1;\nwidgetContext.stateController.updateState(null, params);\nwidgetContext.stateController.navigatePrevState(number);",
                "id": "act-go-back"
              },
              {
                "name": "btn-add-kit",
                "icon": "add",
                "type": "customPretty",
                "customHtml": "<form\n  #addKitForm=\"ngForm\"\n  [formGroup]=\"addKitFormGroup\"\n  (ngSubmit)=\"save()\"\n  class=\"add-kit-dialog\"\n>\n  <!-- Header -->\n  <div class=\"dialog-header\">\n    <mat-icon>medical_services</mat-icon>\n    <h2>Add Diagnostic Kit</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\" class=\"close-btn\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </div>\n\n  <mat-progress-bar color=\"accent\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\n\n  <div class=\"dialog-body\">\n    <!-- Customer Selection Card -->\n    <div class=\"section-card customer-card\">\n      <div class=\"card-header-mini\">\n        <mat-icon>business</mat-icon>\n        <span>Customer</span>\n      </div>\n      <mat-form-field appearance=\"outline\" class=\"w-full\">\n        <mat-label>Select Customer</mat-label>\n        <mat-select formControlName=\"customerId\" (selectionChange)=\"onCustomerChange($event)\" required>\n          <mat-option *ngFor=\"let customer of customers\" [value]=\"customer.id.id\">\n            {{ customer.name }}\n          </mat-option>\n        </mat-select>\n        <mat-icon matPrefix>person</mat-icon>\n        <mat-error *ngIf=\"addKitFormGroup.get('customerId').hasError('required')\">\n          Please select a customer\n        </mat-error>\n      </mat-form-field>\n    </div>\n\n    <!-- Stepper -->\n    <mat-stepper #stepper [linear]=\"true\" [formGroup]=\"addKitFormGroup\" (selectionChange)=\"onStepChange($event)\" class=\"kit-stepper\">\n\n      <!-- Step 1: Kit & Gateway Details -->\n      <mat-step [stepControl]=\"addKitFormGroup.get('kitDetails')\">\n        <ng-template matStepLabel>Kit & Gateway</ng-template>\n\n        <div [formGroup]=\"addKitFormGroup.get('kitDetails')\" class=\"step-content\">\n\n          <div class=\"form-row\">\n            <!-- Kit Type Card -->\n            <div class=\"form-col\">\n              <div class=\"input-group\">\n                <label class=\"input-label\">Kit Type</label>\n                <mat-form-field appearance=\"outline\" class=\"w-full\">\n                  <mat-select formControlName=\"kitType\" (selectionChange)=\"onKitTypeChange($event)\" required>\n                    <mat-select-trigger>\n                      <div class=\"flex items-center gap-2\">\n                        <mat-icon *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis'\" style=\"font-size: 18px; width: 18px; height: 18px; color: #3b82f6;\">router</mat-icon>\n                        <mat-icon *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'lorawan'\" style=\"font-size: 18px; width: 18px; height: 18px; color: #8b5cf6;\">cell_tower</mat-icon>\n                        <span *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis'\">Base Kit (RESI)</span>\n                        <span *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'lorawan'\">Room Kit (LoRaWAN)</span>\n                      </div>\n                    </mat-select-trigger>\n                    <mat-option value=\"basis\">\n                      <div class=\"flex items-center gap-2\">\n                        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px; color: #3b82f6;\">router</mat-icon>\n                        <span>Base Kit (RESI)</span>\n                      </div>\n                    </mat-option>\n                    <mat-option value=\"lorawan\">\n                      <div class=\"flex items-center gap-2\">\n                        <mat-icon style=\"font-size: 18px; width: 18px; height: 18px; color: #8b5cf6;\">cell_tower</mat-icon>\n                        <span>Room Kit (LoRaWAN)</span>\n                      </div>\n                    </mat-option>\n                  </mat-select>\n                  <mat-icon matPrefix>category</mat-icon>\n                </mat-form-field>\n              </div>\n            </div>\n\n            <!-- Kit Name -->\n            <div class=\"form-col\">\n              <div class=\"input-group\">\n                <label class=\"input-label\">Kit Name</label>\n                <mat-form-field appearance=\"outline\" class=\"w-full\">\n                  <input matInput formControlName=\"kitName\" required\n                         [placeholder]=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis' ? 'DBKIT001' : 'DRKIT001'\" />\n                  <mat-icon matPrefix>label</mat-icon>\n                  <mat-hint>{{ addKitFormGroup.get('kitDetails').get('kitType').value === 'basis' ? 'Format: DBKIT...' : 'Format: DRKIT...' }}</mat-hint>\n                  <mat-error *ngIf=\"addKitFormGroup.get('kitDetails').get('kitName').hasError('required')\">\n                    Kit name is required\n                  </mat-error>\n                  <mat-error *ngIf=\"addKitFormGroup.get('kitDetails').get('kitName').hasError('pattern')\">\n                    Use {{ addKitFormGroup.get('kitDetails').get('kitType').value === 'basis' ? 'DBKIT...' : 'DRKIT...' }} format\n                  </mat-error>\n                </mat-form-field>\n              </div>\n            </div>\n          </div>\n\n          <!-- Gateway Section -->\n          <div class=\"section-card gateway-card\">\n            <div class=\"card-header-mini\">\n              <mat-icon>settings_input_antenna</mat-icon>\n              <span>Gateway Configuration</span>\n              <span class=\"badge\" [class.badge-blue]=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis'\"\n                                  [class.badge-purple]=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'lorawan'\">\n                {{ addKitFormGroup.get('kitDetails').get('kitType').value === 'basis' ? 'RESI' : 'LoRaWAN' }}\n              </span>\n            </div>\n\n            <div *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis'\" class=\"gateway-form\">\n              <mat-form-field appearance=\"outline\" class=\"w-full\">\n                <mat-label>Gateway Serial Number</mat-label>\n                <input matInput formControlName=\"gatewaySerial\" placeholder=\"Enter serial number\" />\n                <mat-icon matPrefix>qr_code</mat-icon>\n                <mat-icon matSuffix *ngIf=\"addKitFormGroup.get('kitDetails').get('gatewaySerial').value?.length > 0\"\n                          [class.valid-icon]=\"addKitFormGroup.get('kitDetails').get('gatewaySerial').valid\"\n                          [class.invalid-icon]=\"addKitFormGroup.get('kitDetails').get('gatewaySerial').invalid\">\n                  {{ addKitFormGroup.get('kitDetails').get('gatewaySerial').valid ? 'check_circle' : 'error' }}\n                </mat-icon>\n                <mat-hint>Serial number from the RESI gateway label</mat-hint>\n                <mat-error>Gateway Serial Number is required</mat-error>\n              </mat-form-field>\n            </div>\n\n            <div *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'lorawan'\" class=\"gateway-form\">\n              <mat-form-field appearance=\"outline\" class=\"w-full\">\n                <mat-label>Gateway ID</mat-label>\n                <input matInput formControlName=\"gatewayId\" placeholder=\"16-character ID\" maxlength=\"16\" />\n                <mat-icon matPrefix>vpn_key</mat-icon>\n                <mat-icon matSuffix *ngIf=\"addKitFormGroup.get('kitDetails').get('gatewayId').value?.length > 0\"\n                          [class.valid-icon]=\"isGatewayIdValid()\"\n                          [class.invalid-icon]=\"!isGatewayIdValid()\">\n                  {{ isGatewayIdValid() ? 'check_circle' : 'error' }}\n                </mat-icon>\n                <mat-hint>\n                  <span class=\"char-counter\" [class.complete]=\"addKitFormGroup.get('kitDetails').get('gatewayId').value?.length === 16\">\n                    {{ addKitFormGroup.get('kitDetails').get('gatewayId').value?.length || 0 }}/16 characters\n                  </span>\n                </mat-hint>\n                <mat-error>Must be exactly 16 alphanumeric characters</mat-error>\n              </mat-form-field>\n            </div>\n          </div>\n\n          <!-- Step Actions -->\n          <div class=\"step-actions\">\n            <span></span>\n            <button mat-flat-button color=\"primary\" matStepperNext type=\"button\"\n                    [disabled]=\"addKitFormGroup.get('kitDetails').invalid || addKitFormGroup.get('customerId').invalid\"\n                    class=\"next-btn\">\n              Continue <mat-icon>arrow_forward</mat-icon>\n            </button>\n          </div>\n        </div>\n      </mat-step>\n\n      <!-- Step 2: Devices -->\n      <mat-step [stepControl]=\"addKitFormGroup.get('devices')\">\n        <ng-template matStepLabel>Devices</ng-template>\n\n        <div [formGroup]=\"addKitFormGroup.get('devices')\" class=\"step-content\">\n\n          <!-- Base Kit Devices -->\n          <div *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis'\">\n            <div class=\"info-banner\">\n              <mat-icon>lightbulb</mat-icon>\n              <span>Device names are auto-generated based on gateway serial number.</span>\n            </div>\n\n            <!-- P-Flow Devices -->\n            <div class=\"section-card devices-card\">\n              <div class=\"card-header-mini\">\n                <mat-icon>sensors</mat-icon>\n                <span>P-Flow D116 Devices</span>\n                <span class=\"device-count\">{{ pflowDevicesArray.length }}</span>\n              </div>\n              <div formArrayName=\"pflowDevices\" class=\"devices-list\">\n                <div *ngFor=\"let device of pflowDevicesArray.controls; let i = index\" [formGroupName]=\"i\" class=\"device-item\">\n                  <div class=\"device-icon pflow\">\n                    <mat-icon>speed</mat-icon>\n                  </div>\n                  <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                    <input matInput formControlName=\"name\" readonly />\n                  </mat-form-field>\n                  <button mat-icon-button type=\"button\" (click)=\"removePflowDevice(i)\" [disabled]=\"!canRemoveDevice('pflow', i)\" class=\"delete-btn\">\n                    <mat-icon>close</mat-icon>\n                  </button>\n                </div>\n                <div *ngIf=\"pflowDevicesArray.length === 0\" class=\"empty-state\">\n                  <span>No P-Flow devices added yet</span>\n                </div>\n              </div>\n              <button mat-stroked-button type=\"button\" (click)=\"addPflowDevice()\" class=\"add-device-btn\">\n                <mat-icon>add_circle_outline</mat-icon> Add P-Flow D116\n              </button>\n            </div>\n\n            <!-- Temperature Sensors -->\n            <div class=\"section-card devices-card\">\n              <div class=\"card-header-mini\">\n                <mat-icon>thermostat</mat-icon>\n                <span>Temperature Sensors</span>\n                <span class=\"device-count\">{{ tempSensorsArray.length }}</span>\n              </div>\n              <div formArrayName=\"tempSensors\" class=\"devices-list\">\n                <div *ngFor=\"let sensor of tempSensorsArray.controls; let i = index\" [formGroupName]=\"i\" class=\"device-item\">\n                  <div class=\"device-icon temp\">\n                    <mat-icon>thermostat</mat-icon>\n                  </div>\n                  <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                    <input matInput formControlName=\"name\" readonly />\n                  </mat-form-field>\n                  <button mat-icon-button type=\"button\" (click)=\"removeTempSensor(i)\" [disabled]=\"!canRemoveDevice('temp', i)\" class=\"delete-btn\">\n                    <mat-icon>close</mat-icon>\n                  </button>\n                </div>\n                <div *ngIf=\"tempSensorsArray.length === 0\" class=\"empty-state\">\n                  <span>No temperature sensors added yet</span>\n                </div>\n              </div>\n              <button mat-stroked-button type=\"button\" (click)=\"addTempSensor()\" class=\"add-device-btn\">\n                <mat-icon>add_circle_outline</mat-icon> Add Temperature Sensor\n              </button>\n            </div>\n          </div>\n\n          <!-- Room Kit Devices -->\n          <div *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'lorawan'\">\n            <div class=\"info-banner\">\n              <mat-icon>lightbulb</mat-icon>\n              <span>Enter DevEUI and AppKey for each CO2 sensor. Names are auto-generated.</span>\n            </div>\n\n            <div class=\"section-card devices-card\">\n              <div class=\"card-header-mini\">\n                <mat-icon>co2</mat-icon>\n                <span>Room Sensor CO2</span>\n                <span class=\"device-count\">{{ roomSensorsArray.length }}</span>\n              </div>\n              <div formArrayName=\"roomSensors\" class=\"devices-list\">\n                <div *ngFor=\"let sensor of roomSensorsArray.controls; let i = index\" [formGroupName]=\"i\" class=\"device-item-card\">\n                  <div class=\"device-item-header\">\n                    <div class=\"device-icon co2\">\n                      <mat-icon>co2</mat-icon>\n                    </div>\n                    <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                      <input matInput formControlName=\"name\" readonly />\n                    </mat-form-field>\n                    <button mat-icon-button type=\"button\" (click)=\"removeRoomSensor(i)\" [disabled]=\"!canRemoveDevice('room', i)\" class=\"delete-btn\">\n                      <mat-icon>close</mat-icon>\n                    </button>\n                  </div>\n                  <div class=\"credentials-row\">\n                    <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                      <mat-label>DevEUI</mat-label>\n                      <input matInput formControlName=\"devEUI\" required maxlength=\"16\" placeholder=\"16 characters\" />\n                      <mat-icon matPrefix>fingerprint</mat-icon>\n                      <mat-icon matSuffix *ngIf=\"sensor.get('devEUI').value?.length > 0\"\n                                [class.valid-icon]=\"isDevEUIValid(sensor)\"\n                                [class.invalid-icon]=\"!isDevEUIValid(sensor)\">\n                        {{ isDevEUIValid(sensor) ? 'check_circle' : 'error' }}\n                      </mat-icon>\n                      <mat-hint>\n                        <span class=\"char-counter\" [class.complete]=\"sensor.get('devEUI').value?.length === 16\">\n                          {{ sensor.get('devEUI').value?.length || 0 }}/16\n                        </span>\n                      </mat-hint>\n                    </mat-form-field>\n                    <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                      <mat-label>AppKey</mat-label>\n                      <input matInput formControlName=\"appKey\" required maxlength=\"32\" placeholder=\"32 characters\" />\n                      <mat-icon matPrefix>key</mat-icon>\n                      <mat-icon matSuffix *ngIf=\"sensor.get('appKey').value?.length > 0\"\n                                [class.valid-icon]=\"isAppKeyValid(sensor)\"\n                                [class.invalid-icon]=\"!isAppKeyValid(sensor)\">\n                        {{ isAppKeyValid(sensor) ? 'check_circle' : 'error' }}\n                      </mat-icon>\n                      <mat-hint>\n                        <span class=\"char-counter\" [class.complete]=\"sensor.get('appKey').value?.length === 32\">\n                          {{ sensor.get('appKey').value?.length || 0 }}/32\n                        </span>\n                      </mat-hint>\n                    </mat-form-field>\n                  </div>\n                </div>\n                <div *ngIf=\"roomSensorsArray.length === 0\" class=\"empty-state\">\n                  <span>No CO2 sensors added yet</span>\n                </div>\n              </div>\n              <button mat-stroked-button type=\"button\" (click)=\"addRoomSensor()\" class=\"add-device-btn\">\n                <mat-icon>add_circle_outline</mat-icon> Add Room Sensor CO2\n              </button>\n            </div>\n          </div>\n\n          <!-- Step Actions -->\n          <div class=\"step-actions\">\n            <button mat-button matStepperPrevious type=\"button\" class=\"back-btn\">\n              <mat-icon>arrow_back</mat-icon> Back\n            </button>\n            <button mat-flat-button color=\"primary\" matStepperNext type=\"button\" class=\"next-btn\">\n              Continue <mat-icon>arrow_forward</mat-icon>\n            </button>\n          </div>\n        </div>\n      </mat-step>\n\n      <!-- Step 3: Credentials (only for Base Kit / RESI Gateway) -->\n      <mat-step *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'basis'\">\n        <ng-template matStepLabel>Credentials & Summary</ng-template>\n\n        <div class=\"step-content\">\n          <div class=\"info-banner\">\n            <mat-icon>security</mat-icon>\n            <span>Configure MQTT credentials for the RESI gateway connection.</span>\n          </div>\n\n          <!-- Credentials Card -->\n          <div class=\"section-card credentials-card\">\n            <div class=\"card-header-mini\">\n              <mat-icon>vpn_key</mat-icon>\n              <span>MQTT Credentials</span>\n            </div>\n            <div [formGroup]=\"addKitFormGroup.get('credentials')\" class=\"credentials-form\">\n              <mat-form-field appearance=\"outline\" class=\"w-full\">\n                <mat-label>Client ID</mat-label>\n                <input matInput formControlName=\"clientId\" required readonly />\n                <mat-icon matPrefix>badge</mat-icon>\n              </mat-form-field>\n              <div class=\"credentials-row\">\n                <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                  <mat-label>Username</mat-label>\n                  <input matInput formControlName=\"userName\" required />\n                  <mat-icon matPrefix>person</mat-icon>\n                </mat-form-field>\n                <mat-form-field appearance=\"outline\" class=\"flex-1\">\n                  <mat-label>Password</mat-label>\n                  <input matInput formControlName=\"password\" required />\n                  <mat-icon matPrefix>lock</mat-icon>\n                  <button mat-icon-button matSuffix type=\"button\" (click)=\"regeneratePassword()\" matTooltip=\"Generate new password\">\n                    <mat-icon>refresh</mat-icon>\n                  </button>\n                </mat-form-field>\n              </div>\n            </div>\n          </div>\n\n          <!-- Summary Card -->\n          <div class=\"section-card summary-card\">\n            <div class=\"card-header-mini\">\n              <mat-icon>summarize</mat-icon>\n              <span>Kit Summary</span>\n            </div>\n            <div class=\"summary-grid\">\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>business</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Customer</span>\n                  <span class=\"summary-value\">{{ getSelectedCustomerName() }}</span>\n                </div>\n              </div>\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>medical_services</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Kit</span>\n                  <span class=\"summary-value\">{{ addKitFormGroup.get('kitDetails').get('kitName').value }}</span>\n                  <span class=\"summary-badge\">Base Kit</span>\n                </div>\n              </div>\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>router</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Gateway</span>\n                  <span class=\"summary-value\">{{ getGatewayName() }}</span>\n                </div>\n              </div>\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>devices</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Devices</span>\n                  <span class=\"summary-value\">{{ getTotalDeviceCount() }} device(s)</span>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <!-- Step Actions -->\n          <div class=\"step-actions\">\n            <button mat-button matStepperPrevious type=\"button\" class=\"back-btn\">\n              <mat-icon>arrow_back</mat-icon> Back\n            </button>\n            <button mat-flat-button color=\"primary\" type=\"submit\" [disabled]=\"addKitFormGroup.invalid || (isLoading$ | async)\" class=\"submit-btn\">\n              <mat-icon>check_circle</mat-icon> Create Kit\n            </button>\n          </div>\n        </div>\n      </mat-step>\n\n      <!-- Step 3 for Room Kit: Summary (no credentials needed) -->\n      <mat-step *ngIf=\"addKitFormGroup.get('kitDetails').get('kitType').value === 'lorawan'\">\n        <ng-template matStepLabel>Summary</ng-template>\n\n        <div class=\"step-content\">\n          <!-- Summary Card -->\n          <div class=\"section-card summary-card\">\n            <div class=\"card-header-mini\">\n              <mat-icon>summarize</mat-icon>\n              <span>Kit Summary</span>\n            </div>\n            <div class=\"summary-grid\">\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>business</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Customer</span>\n                  <span class=\"summary-value\">{{ getSelectedCustomerName() }}</span>\n                </div>\n              </div>\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>medical_services</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Kit</span>\n                  <span class=\"summary-value\">{{ addKitFormGroup.get('kitDetails').get('kitName').value }}</span>\n                  <span class=\"summary-badge purple\">Room Kit</span>\n                </div>\n              </div>\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>wifi_tethering</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">Gateway</span>\n                  <span class=\"summary-value\">{{ getGatewayName() }}</span>\n                </div>\n              </div>\n              <div class=\"summary-row\">\n                <div class=\"summary-icon\"><mat-icon>co2</mat-icon></div>\n                <div class=\"summary-content\">\n                  <span class=\"summary-label\">CO2 Sensors</span>\n                  <span class=\"summary-value\">{{ getTotalDeviceCount() }} device(s)</span>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <!-- Step Actions -->\n          <div class=\"step-actions\">\n            <button mat-button matStepperPrevious type=\"button\" class=\"back-btn\">\n              <mat-icon>arrow_back</mat-icon> Back\n            </button>\n            <button mat-flat-button color=\"primary\" type=\"submit\" [disabled]=\"addKitFormGroup.invalid || (isLoading$ | async)\" class=\"submit-btn\">\n              <mat-icon>check_circle</mat-icon> Create Kit\n            </button>\n          </div>\n        </div>\n      </mat-step>\n\n    </mat-stepper>\n  </div>\n</form>",
                "customCss": "\n/* ============================================\n   ADD KIT DIALOG - PROFESSIONAL DESIGN\n   ============================================ */\n\n.add-kit-dialog {\n  width: 780px;\n  max-height: 85vh;\n  display: flex;\n  flex-direction: column;\n  background: #f8fafc;\n  border-radius: 12px;\n  overflow: hidden;\n}\n\n/* Header */\n/* Header - compact */\n.dialog-header {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  padding: 14px 20px;\n  background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);\n  color: white;\n}\n.dialog-header mat-icon {\n  font-size: 24px;\n  width: 24px;\n  height: 24px;\n}\n.dialog-header h2 {\n  margin: 0;\n  font-size: 18px;\n  font-weight: 600;\n}\n.close-btn {\n  color: rgba(255,255,255,0.8) !important;\n}\n.close-btn:hover {\n  color: white !important;\n  background: rgba(255,255,255,0.1) !important;\n}\n\n/* Dialog Body - reduced padding */\n.dialog-body {\n  flex: 1;\n  overflow-y: auto;\n  padding: 16px;\n}\n\n/* Section Cards - compact */\n.section-card {\n  background: white;\n  border-radius: 8px;\n  border: 1px solid #e2e8f0;\n  margin-bottom: 12px;\n  overflow: hidden;\n}\n\n.card-header-mini {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  padding: 10px 14px;\n  background: #f8fafc;\n  border-bottom: 1px solid #e2e8f0;\n  font-weight: 600;\n  font-size: 14px;\n  color: #334155;\n}\n.card-header-mini mat-icon {\n  font-size: 18px;\n  width: 18px;\n  height: 18px;\n  color: #64748b;\n}\n\n/* Customer Card */\n.customer-card {\n  padding: 14px;\n}\n.customer-card .card-header-mini {\n  padding: 0;\n  background: transparent;\n  border: none;\n  margin-bottom: 10px;\n}\n\n/* Gateway Card */\n.gateway-card {\n  border-left: 3px solid #3b82f6;\n}\n.gateway-form {\n  padding: 14px;\n}\n\n/* Badge Styles */\n.badge {\n  font-size: 11px;\n  font-weight: 600;\n  padding: 3px 8px;\n  border-radius: 12px;\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n  margin-left: auto;\n}\n.badge-blue {\n  background: #dbeafe;\n  color: #1d4ed8;\n}\n.badge-purple {\n  background: #ede9fe;\n  color: #7c3aed;\n}\n\n/* Form Styling - compact */\n.step-content {\n  padding-top: 8px;\n}\n\n.form-row {\n  display: flex;\n  gap: 12px;\n  margin-bottom: 4px;\n}\n.form-col {\n  flex: 1;\n}\n\n.input-group {\n  margin-bottom: 4px;\n}\n.input-label {\n  font-size: 12px;\n  font-weight: 600;\n  color: #64748b;\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n  margin-bottom: 6px;\n  display: block;\n}\n\n/* Mat Form Field Overrides */\n.add-kit-dialog .mat-mdc-form-field-subscript-wrapper {\n  margin-top: 4px;\n}\n\n.option-content {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n}\n.option-content mat-icon {\n  color: #64748b;\n}\n.option-content small {\n  color: #94a3b8;\n  font-size: 12px;\n  margin-left: auto;\n}\n\n/* Validation Icons */\n.valid-icon {\n  color: #10b981 !important;\n}\n.invalid-icon {\n  color: #ef4444 !important;\n}\n\n/* Character Counter */\n.char-counter {\n  font-family: 'SF Mono', Monaco, monospace;\n  font-size: 12px;\n  color: #94a3b8;\n}\n.char-counter.complete {\n  color: #10b981;\n  font-weight: 600;\n}\n\n/* Info Banner - compact */\n.info-banner {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  padding: 10px 14px;\n  background: #eff6ff;\n  border: 1px solid #bfdbfe;\n  border-radius: 6px;\n  margin-bottom: 12px;\n  font-size: 13px;\n  color: #1e40af;\n}\n.info-banner mat-icon {\n  color: #3b82f6;\n  font-size: 18px;\n  width: 18px;\n  height: 18px;\n  flex-shrink: 0;\n}\n\n/* Devices Card - compact */\n.devices-card {\n  border-left: 3px solid #8b5cf6;\n}\n.devices-list {\n  padding: 8px 14px;\n}\n\n.device-count {\n  margin-left: auto;\n  background: #e2e8f0;\n  color: #475569;\n  font-size: 12px;\n  font-weight: 700;\n  padding: 2px 8px;\n  border-radius: 10px;\n}\n\n/* Device Item - aligned */\n.device-item {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  padding: 6px 0;\n  border-bottom: 1px solid #f1f5f9;\n}\n.device-item:last-child {\n  border-bottom: none;\n}\n.device-item .mat-mdc-form-field {\n  margin-bottom: 0;\n}\n\n/* Room Sensor Card */\n.device-item-card {\n  background: #f8fafc;\n  border: 1px solid #e2e8f0;\n  border-radius: 6px;\n  padding: 10px;\n  margin-bottom: 8px;\n}\n.device-item-header {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  margin-bottom: 8px;\n}\n\n/* Device Icon - white icons, centered */\n.device-icon {\n  width: 32px;\n  height: 32px;\n  min-width: 32px;\n  border-radius: 6px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  flex-shrink: 0;\n}\n.device-icon mat-icon {\n  font-size: 18px;\n  width: 18px;\n  height: 18px;\n  color: white !important;\n}\n.device-icon.pflow {\n  background: #3b82f6;\n}\n.device-icon.temp {\n  background: #f59e0b;\n}\n.device-icon.co2 {\n  background: #10b981;\n}\n\n.credentials-row {\n  display: flex;\n  gap: 10px;\n}\n\n.empty-state {\n  text-align: center;\n  padding: 12px;\n  color: #94a3b8;\n  font-size: 14px;\n}\n\n.delete-btn {\n  color: #94a3b8 !important;\n  flex-shrink: 0;\n}\n.delete-btn:hover:not([disabled]) {\n  color: #ef4444 !important;\n  background: #fef2f2 !important;\n}\n.delete-btn[disabled] {\n  opacity: 0.3;\n}\n\n.add-device-btn {\n  margin: 6px 14px 10px;\n  border-color: #cbd5e1 !important;\n  color: #475569 !important;\n  font-size: 14px !important;\n}\n.add-device-btn mat-icon {\n  margin-right: 4px;\n  font-size: 18px;\n}\n.add-device-btn:hover {\n  background: #f1f5f9 !important;\n}\n\n/* Credentials Card - compact */\n.credentials-card {\n  border-left: 3px solid #f59e0b;\n}\n.credentials-form {\n  padding: 12px 14px;\n}\n\n/* Summary Card - compact */\n.summary-card {\n  border-left: 3px solid #10b981;\n}\n.summary-grid {\n  padding: 4px 14px 10px;\n}\n.summary-row {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  padding: 6px 0;\n  border-bottom: 1px solid #f1f5f9;\n}\n.summary-row:last-child {\n  border-bottom: none;\n}\n.summary-icon {\n  width: 32px;\n  height: 32px;\n  background: #f1f5f9;\n  border-radius: 8px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  flex-shrink: 0;\n}\n.summary-icon mat-icon {\n  color: #64748b;\n  font-size: 18px;\n  width: 18px;\n  height: 18px;\n}\n.summary-content {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  gap: 2px;\n}\n.summary-label {\n  font-size: 13px;\n  color: #94a3b8;\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n}\n.summary-value {\n  font-size: 16px;\n  font-weight: 600;\n  color: #1e293b;\n}\n.summary-badge {\n  font-size: 12px;\n  font-weight: 600;\n  padding: 3px 10px;\n  border-radius: 12px;\n  background: #dbeafe;\n  color: #1d4ed8;\n  margin-left: auto;\n  align-self: center;\n}\n.summary-badge.purple {\n  background: #ede9fe;\n  color: #7c3aed;\n}\n\n/* Step Actions - compact */\n.step-actions {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-top: 16px;\n  padding-top: 12px;\n  border-top: 1px solid #e2e8f0;\n}\n\n.back-btn {\n  color: #64748b !important;\n}\n.back-btn mat-icon {\n  margin-right: 4px;\n}\n\n.next-btn, .submit-btn {\n  font-weight: 600 !important;\n  padding: 0 24px !important;\n  height: 44px !important;\n  border-radius: 8px !important;\n}\n.next-btn mat-icon, .submit-btn mat-icon {\n  margin-left: 6px;\n}\n.submit-btn mat-icon {\n  margin-left: 0;\n  margin-right: 6px;\n}\n\n/* Stepper Styling - compact */\n.kit-stepper {\n  background: transparent !important;\n}\n.kit-stepper .mat-horizontal-stepper-header-container {\n  background: white;\n  border-radius: 8px;\n  border: 1px solid #e2e8f0;\n  padding: 4px 10px;\n  margin-bottom: 12px;\n}\n.kit-stepper .mat-step-header {\n  border-radius: 8px;\n}\n.kit-stepper .mat-step-header:hover {\n  background: #f8fafc;\n}\n.kit-stepper .mat-step-icon-selected {\n  background: #1e3a5f !important;\n}\n",
                "customFunction": "\nlet $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\nconst rxjs = widgetContext.rxjs;\nconst pageLink = widgetContext.pageLink(1000, 0, null, null, null);\n\n// Load customers first, then open dialog\ncustomerService.getCustomers(pageLink).subscribe(\n  function(result) {\n    openAddKitDialog(result.data || []);\n  },\n  function(error) {\n    console.error('Failed to load customers:', error);\n    openAddKitDialog([]);\n  }\n);\n\nfunction openAddKitDialog(customers) {\n  customDialog.customDialog(htmlTemplate, AddKitDialogController, { customers: customers }).subscribe();\n}\n\nfunction generateRandomPassword() {\n  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';\n  let password = '';\n  for (let i = 0; i < 20; i++) {\n    password += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return password;\n}\n\nfunction AddKitDialogController(instance) {\n  let vm = instance;\n  vm.customers = instance.data.customers || [];\n\n  // Form group - gatewaySerial has validators since default kit type is 'basis'\n  vm.addKitFormGroup = vm.fb.group({\n    customerId: [null, [vm.validators.required]],\n    kitDetails: vm.fb.group({\n      kitType: ['basis', [vm.validators.required]],\n      kitName: ['', [vm.validators.required, vm.validators.pattern(/^DBKIT.*$/)]],\n      gatewaySerial: ['', [vm.validators.required]],\n      gatewayId: ['']\n    }),\n    devices: vm.fb.group({\n      pflowDevices: vm.fb.array([]),\n      tempSensors: vm.fb.array([]),\n      roomSensors: vm.fb.array([])\n    }),\n    credentials: vm.fb.group({\n      clientId: ['', [vm.validators.required]],\n      userName: ['pke', [vm.validators.required]],\n      password: [generateRandomPassword(), [vm.validators.required]]\n    })\n  });\n\n  // Form array getters\n  vm.pflowDevicesArray = vm.addKitFormGroup.get('devices').get('pflowDevices');\n  vm.tempSensorsArray = vm.addKitFormGroup.get('devices').get('tempSensors');\n  vm.roomSensorsArray = vm.addKitFormGroup.get('devices').get('roomSensors');\n\n  // Pre-select customer if available from state params\n  let stateParams = widgetContext.stateController.getStateParams();\n  if (stateParams.entityId && stateParams.entityId.id) {\n    vm.addKitFormGroup.get('customerId').setValue(stateParams.entityId.id);\n  }\n\n  // ========== NAME CONSTRUCTION ==========\n  function constructPflowName(gatewayIdentifier, index) {\n    return 'ECO_' + gatewayIdentifier + '_PF' + index;\n  }\n\n  function constructTempSensorName(gatewayIdentifier, index) {\n    return 'ECO_' + gatewayIdentifier + '_TS' + index;\n  }\n\n  function constructRoomSensorName(gatewayIdentifier, index) {\n    return 'ECO_' + gatewayIdentifier + '_CO2_' + index;\n  }\n\n  function getGatewayIdentifier() {\n    const kitType = vm.addKitFormGroup.get('kitDetails').get('kitType').value;\n    if (kitType === 'basis') {\n      return vm.addKitFormGroup.get('kitDetails').get('gatewaySerial').value || '';\n    } else {\n      return vm.addKitFormGroup.get('kitDetails').get('gatewayId').value || '';\n    }\n  }\n\n  function updateAllDeviceNames() {\n    const gwId = getGatewayIdentifier();\n\n    // Update P-Flow names\n    for (let i = 0; i < vm.pflowDevicesArray.length; i++) {\n      vm.pflowDevicesArray.at(i).get('name').setValue(constructPflowName(gwId, i + 1));\n    }\n\n    // Update Temperature Sensor names\n    for (let i = 0; i < vm.tempSensorsArray.length; i++) {\n      vm.tempSensorsArray.at(i).get('name').setValue(constructTempSensorName(gwId, i + 1));\n    }\n\n    // Update Room Sensor names\n    for (let i = 0; i < vm.roomSensorsArray.length; i++) {\n      vm.roomSensorsArray.at(i).get('name').setValue(constructRoomSensorName(gwId, i + 1));\n    }\n  }\n\n  // Watch gateway identifier changes\n  vm.addKitFormGroup.get('kitDetails').get('gatewaySerial').valueChanges.subscribe(function() {\n    updateAllDeviceNames();\n    updateClientId();\n  });\n\n  vm.addKitFormGroup.get('kitDetails').get('gatewayId').valueChanges.subscribe(function() {\n    updateAllDeviceNames();\n    updateClientId();\n  });\n\n  // Customer change handler\n  vm.onCustomerChange = function(event) {\n    vm.addKitFormGroup.get('kitDetails').get('kitName').updateValueAndValidity();\n  };\n\n  // Gateway ID validation helper (for Room Kit LoRaWAN)\n  vm.isGatewayIdValid = function() {\n    const gatewayId = vm.addKitFormGroup.get('kitDetails').get('gatewayId').value || '';\n    return /^[a-zA-Z0-9]{16}$/.test(gatewayId);\n  };\n\n  // DevEUI validation helper (16 alphanumeric chars)\n  vm.isDevEUIValid = function(sensorGroup) {\n    const devEUI = sensorGroup.get('devEUI').value || '';\n    return /^[a-zA-Z0-9]{16}$/.test(devEUI);\n  };\n\n  // AppKey validation helper (32 alphanumeric chars)\n  vm.isAppKeyValid = function(sensorGroup) {\n    const appKey = sensorGroup.get('appKey').value || '';\n    return /^[a-zA-Z0-9]{32}$/.test(appKey);\n  };\n\n  // Kit type change handler\n  vm.onKitTypeChange = function(event) {\n    const kitType = event.value;\n    const kitNameControl = vm.addKitFormGroup.get('kitDetails').get('kitName');\n    const gatewaySerialControl = vm.addKitFormGroup.get('kitDetails').get('gatewaySerial');\n    const gatewayIdControl = vm.addKitFormGroup.get('kitDetails').get('gatewayId');\n\n    const credentialsGroup = vm.addKitFormGroup.get('credentials');\n\n    if (kitType === 'basis') {\n      // Base Kit: DBKIT pattern, gatewaySerial required, gatewayId no validators, credentials required\n      kitNameControl.setValidators([vm.validators.required, vm.validators.pattern(/^DBKIT.*$/)]);\n      gatewaySerialControl.setValidators([vm.validators.required]);\n      gatewayIdControl.clearValidators();\n      gatewayIdControl.setValue('');\n      // Set credentials validators\n      credentialsGroup.get('clientId').setValidators([vm.validators.required]);\n      credentialsGroup.get('userName').setValidators([vm.validators.required]);\n      credentialsGroup.get('password').setValidators([vm.validators.required]);\n    } else {\n      // Room Kit: DRKIT pattern, gatewayId required with pattern, gatewaySerial no validators, no credentials\n      kitNameControl.setValidators([vm.validators.required, vm.validators.pattern(/^DRKIT.*$/)]);\n      gatewaySerialControl.clearValidators();\n      gatewaySerialControl.setValue('');\n      gatewayIdControl.setValidators([vm.validators.required, vm.validators.pattern(/^[a-zA-Z0-9]{16}$/)]);\n      // Clear credentials validators\n      credentialsGroup.get('clientId').clearValidators();\n      credentialsGroup.get('userName').clearValidators();\n      credentialsGroup.get('password').clearValidators();\n    }\n    kitNameControl.updateValueAndValidity();\n    gatewaySerialControl.updateValueAndValidity();\n    gatewayIdControl.updateValueAndValidity();\n    credentialsGroup.get('clientId').updateValueAndValidity();\n    credentialsGroup.get('userName').updateValueAndValidity();\n    credentialsGroup.get('password').updateValueAndValidity();\n\n    // Clear device arrays when kit type changes\n    while (vm.pflowDevicesArray.length) vm.pflowDevicesArray.removeAt(0);\n    while (vm.tempSensorsArray.length) vm.tempSensorsArray.removeAt(0);\n    while (vm.roomSensorsArray.length) vm.roomSensorsArray.removeAt(0);\n\n    updateClientId();\n  };\n\n  // Step change handler\n  vm.onStepChange = function(event) {\n    if (event.selectedIndex === 1) {\n      // Entering devices step - update device names\n      updateAllDeviceNames();\n    }\n    if (event.selectedIndex === 2) {\n      // Entering credentials step - update client ID\n      updateClientId();\n    }\n  };\n\n  function updateClientId() {\n    const gwId = getGatewayIdentifier();\n    // Client ID matches gateway name format: ECO_{identifier}_GW\n    const clientId = 'ECO_' + gwId + '_GW';\n    vm.addKitFormGroup.get('credentials').get('clientId').setValue(clientId);\n  }\n\n  // ========== DEVICE ARRAY METHODS ==========\n  vm.addPflowDevice = function() {\n    const gwId = getGatewayIdentifier();\n    const index = vm.pflowDevicesArray.length + 1;\n    vm.pflowDevicesArray.push(vm.fb.group({\n      name: [constructPflowName(gwId, index)]\n    }));\n  };\n\n  vm.removePflowDevice = function(index) {\n    if (vm.pflowDevicesArray.length > 0 && index === vm.pflowDevicesArray.length - 1) {\n      vm.pflowDevicesArray.removeAt(index);\n    }\n  };\n\n  vm.addTempSensor = function() {\n    const gwId = getGatewayIdentifier();\n    const index = vm.tempSensorsArray.length + 1;\n    vm.tempSensorsArray.push(vm.fb.group({\n      name: [constructTempSensorName(gwId, index)]\n    }));\n  };\n\n  vm.removeTempSensor = function(index) {\n    if (vm.tempSensorsArray.length > 0 && index === vm.tempSensorsArray.length - 1) {\n      vm.tempSensorsArray.removeAt(index);\n    }\n  };\n\n  vm.addRoomSensor = function() {\n    const gwId = getGatewayIdentifier();\n    const index = vm.roomSensorsArray.length + 1;\n    vm.roomSensorsArray.push(vm.fb.group({\n      name: [constructRoomSensorName(gwId, index)],\n      devEUI: ['', [vm.validators.required, vm.validators.pattern('[a-zA-Z0-9]{16}')]],\n      appKey: ['', [vm.validators.required, vm.validators.pattern('[a-zA-Z0-9]{32}')]]\n    }));\n  };\n\n  vm.removeRoomSensor = function(index) {\n    if (vm.roomSensorsArray.length > 0 && index === vm.roomSensorsArray.length - 1) {\n      vm.roomSensorsArray.removeAt(index);\n    }\n  };\n\n  vm.canRemoveDevice = function(type, index) {\n    if (type === 'pflow') {\n      return vm.pflowDevicesArray.length > 0 && index === vm.pflowDevicesArray.length - 1;\n    } else if (type === 'temp') {\n      return vm.tempSensorsArray.length > 0 && index === vm.tempSensorsArray.length - 1;\n    } else if (type === 'room') {\n      return vm.roomSensorsArray.length > 0 && index === vm.roomSensorsArray.length - 1;\n    }\n    return false;\n  };\n\n  vm.regeneratePassword = function() {\n    vm.addKitFormGroup.get('credentials').get('password').setValue(generateRandomPassword());\n  };\n\n  // ========== HELPER FUNCTIONS FOR SUMMARY ==========\n  vm.getSelectedCustomerName = function() {\n    const customerId = vm.addKitFormGroup.get('customerId').value;\n    const customer = vm.customers.find(function(c) { return c.id.id === customerId; });\n    return customer ? customer.name : '-';\n  };\n\n  vm.getGatewayName = function() {\n    const kitType = vm.addKitFormGroup.get('kitDetails').get('kitType').value;\n    if (kitType === 'basis') {\n      const serial = vm.addKitFormGroup.get('kitDetails').get('gatewaySerial').value;\n      return 'ECO_' + serial + '_GW';\n    } else {\n      const gwId = vm.addKitFormGroup.get('kitDetails').get('gatewayId').value;\n      return 'ECO_' + gwId + '_GW';\n    }\n  };\n\n  vm.getTotalDeviceCount = function() {\n    const kitType = vm.addKitFormGroup.get('kitDetails').get('kitType').value;\n    if (kitType === 'basis') {\n      return vm.pflowDevicesArray.length + vm.tempSensorsArray.length;\n    } else {\n      return vm.roomSensorsArray.length;\n    }\n  };\n\n  vm.cancel = function() {\n    vm.dialogRef.close(null);\n  };\n\n  // ========== SAVE LOGIC ==========\n  vm.save = function() {\n    vm.addKitFormGroup.markAsPristine();\n\n    const customerId = { id: vm.addKitFormGroup.get('customerId').value, entityType: 'CUSTOMER' };\n    const kitDetails = vm.addKitFormGroup.get('kitDetails').value;\n    const credentials = vm.addKitFormGroup.get('credentials').value;\n    const devices = vm.addKitFormGroup.get('devices').value;\n\n    // 1. Create Kit\n    createKit(customerId, kitDetails).pipe(\n      rxjs.switchMap(function(kit) {\n        // 2. Create Gateway and link to Kit\n        return createGateway(customerId, kitDetails, credentials).pipe(\n          rxjs.switchMap(function(gateway) {\n            // Link gateway to kit\n            return saveDeviceToKitRelation(kit.id, gateway.id).pipe(\n              rxjs.map(function() { return { kit: kit, gateway: gateway }; })\n            );\n          })\n        );\n      }),\n      rxjs.switchMap(function(result) {\n        // 3. Create Devices and link to Kit\n        return createDevices(customerId, kitDetails, devices).pipe(\n          rxjs.switchMap(function(createdDevices) {\n            if (createdDevices.length === 0) {\n              return rxjs.of(result);\n            }\n            // Link each device to kit\n            const relationObservables = createdDevices.map(function(device) {\n              return saveDeviceToKitRelation(result.kit.id, device.id);\n            });\n            return rxjs.forkJoin(relationObservables).pipe(\n              rxjs.map(function() { return result; })\n            );\n          })\n        );\n      })\n    ).subscribe(\n      function(result) {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      },\n      function(error) {\n        console.error('Error creating kit:', error);\n        widgetContext.dialogs.alert('Error', 'Failed to create kit: ' + (error.message || error));\n      }\n    );\n  };\n\n  // ========== ENTITY CREATION FUNCTIONS ==========\n\n  function createKit(customerId, kitDetails) {\n    return getOrCreateEntityGroup(customerId, 'ASSET', 'Diagnostickits').pipe(\n      rxjs.switchMap(function(diagnostickitsGroup) {\n        return getOrCreateEntityGroup(customerId, 'ASSET', 'Unassigned Diagnostic Kits').pipe(\n          rxjs.switchMap(function(unassignedGroup) {\n            const kit = {\n              name: kitDetails.kitName,\n              label: kitDetails.kitName,\n              type: 'Diagnostickit',\n              customerId: customerId\n            };\n\n            return assetService.saveAsset(kit, diagnostickitsGroup.id.id).pipe(\n              rxjs.switchMap(function(savedKit) {\n                return entityGroupService.addEntityToEntityGroup(unassignedGroup.id.id, savedKit.id.id).pipe(\n                  rxjs.switchMap(function() {\n                    const attributes = [{ key: 'kitType', value: kitDetails.kitType }];\n                    return attributeService.saveEntityAttributes(savedKit.id, 'SERVER_SCOPE', attributes).pipe(\n                      rxjs.switchMap(function() {\n                        return saveRelation(customerId, savedKit.id, 'Owns').pipe(\n                          rxjs.map(function() { return savedKit; })\n                        );\n                      })\n                    );\n                  })\n                );\n              })\n            );\n          })\n        );\n      })\n    );\n  }\n\n  function createGateway(customerId, kitDetails, credentials) {\n    return getOrCreateEntityGroup(customerId, 'DEVICE', 'Diagnostickit Devices').pipe(\n      rxjs.switchMap(function(devicesGroup) {\n        return getOrCreateEntityGroup(customerId, 'DEVICE', 'Unassigned Measurement Devices').pipe(\n          rxjs.switchMap(function(unassignedGroup) {\n            let gatewayName, gatewayType, gatewayAttributes;\n\n            if (kitDetails.kitType === 'basis') {\n              gatewayName = 'ECO_' + kitDetails.gatewaySerial + '_GW';\n              gatewayType = 'RESI';\n              gatewayAttributes = [\n                { key: 'isGateway', value: true },\n                { key: 'serialNumber', value: kitDetails.gatewaySerial },\n                { key: 'inactivityTimeout', value: 60 }\n              ];\n            } else {\n              gatewayName = 'ECO_' + kitDetails.gatewayId + '_GW';\n              gatewayType = 'Gateway';\n              gatewayAttributes = [\n                { key: 'isGateway', value: true },\n                { key: 'gatewayID', value: kitDetails.gatewayId },\n                { key: 'inactivityTimeout', value: 60 }\n              ];\n            }\n\n            const gateway = {\n              name: gatewayName,\n              label: kitDetails.kitName,\n              type: gatewayType,\n              customerId: customerId\n            };\n\n            return deviceService.saveDevice(gateway, devicesGroup.id.id).pipe(\n              rxjs.switchMap(function(savedGateway) {\n                return entityGroupService.addEntityToEntityGroup(unassignedGroup.id.id, savedGateway.id.id).pipe(\n                  rxjs.switchMap(function() {\n                    return attributeService.saveEntityAttributes(savedGateway.id, 'SERVER_SCOPE', gatewayAttributes).pipe(\n                      rxjs.switchMap(function() {\n                        // Update credentials only for Base Kit (RESI gateway)\n                        if (kitDetails.kitType === 'basis') {\n                          return updateDeviceCredentials(savedGateway.id, credentials).pipe(\n                            rxjs.switchMap(function() {\n                              return saveRelation(customerId, savedGateway.id, 'Owns').pipe(\n                                rxjs.map(function() { return savedGateway; })\n                              );\n                            })\n                          );\n                        } else {\n                          // Room Kit (LoRaWAN) - no credentials needed\n                          return saveRelation(customerId, savedGateway.id, 'Owns').pipe(\n                            rxjs.map(function() { return savedGateway; })\n                          );\n                        }\n                      })\n                    );\n                  })\n                );\n              })\n            );\n          })\n        );\n      })\n    );\n  }\n\n  function updateDeviceCredentials(deviceId, credentials) {\n    return deviceService.getDeviceCredentials(deviceId.id).pipe(\n      rxjs.switchMap(function(existingCredentials) {\n        const deviceCredentials = {\n          id: existingCredentials.id,\n          deviceId: existingCredentials.deviceId,\n          credentialsType: 'MQTT_BASIC',\n          credentialsValue: JSON.stringify({\n            clientId: credentials.clientId,\n            userName: credentials.userName,\n            password: credentials.password\n          })\n        };\n        return deviceService.saveDeviceCredentials(deviceCredentials);\n      })\n    );\n  }\n\n  function createDevices(customerId, kitDetails, devices) {\n    let devicesToCreate = [];\n\n    if (kitDetails.kitType === 'basis') {\n      devices.pflowDevices.forEach(function(d) {\n        devicesToCreate.push({ name: d.name, type: 'P-Flow D116' });\n      });\n      devices.tempSensors.forEach(function(d) {\n        devicesToCreate.push({ name: d.name, type: 'Temperature Sensor' });\n      });\n    } else {\n      devices.roomSensors.forEach(function(d) {\n        devicesToCreate.push({\n          name: d.name,\n          type: 'Room Sensor CO2',\n          devEUI: d.devEUI,\n          appKey: d.appKey\n        });\n      });\n    }\n\n    if (devicesToCreate.length === 0) {\n      return rxjs.of([]);\n    }\n\n    return getOrCreateEntityGroup(customerId, 'DEVICE', 'Diagnostickit Devices').pipe(\n      rxjs.switchMap(function(devicesGroup) {\n        return getOrCreateEntityGroup(customerId, 'DEVICE', 'Unassigned Measurement Devices').pipe(\n          rxjs.switchMap(function(unassignedGroup) {\n            const observables = devicesToCreate.map(function(deviceInfo) {\n              const device = {\n                name: deviceInfo.name,\n                label: kitDetails.kitName,\n                type: deviceInfo.type,\n                customerId: customerId\n              };\n\n              return deviceService.saveDevice(device, devicesGroup.id.id).pipe(\n                rxjs.switchMap(function(savedDevice) {\n                  return entityGroupService.addEntityToEntityGroup(unassignedGroup.id.id, savedDevice.id.id).pipe(\n                    rxjs.switchMap(function() {\n                      if (deviceInfo.type === 'Room Sensor CO2') {\n                        const attributes = [\n                          { key: 'devEui', value: deviceInfo.devEUI },\n                          { key: 'appKey', value: deviceInfo.appKey }\n                        ];\n                        return attributeService.saveEntityAttributes(savedDevice.id, 'SERVER_SCOPE', attributes).pipe(\n                          rxjs.switchMap(function() {\n                            return saveRelation(customerId, savedDevice.id, 'Owns').pipe(\n                              rxjs.map(function() { return savedDevice; })\n                            );\n                          })\n                        );\n                      }\n                      return saveRelation(customerId, savedDevice.id, 'Owns').pipe(\n                        rxjs.map(function() { return savedDevice; })\n                      );\n                    })\n                  );\n                })\n              );\n            });\n\n            return rxjs.forkJoin(observables);\n          })\n        );\n      })\n    );\n  }\n\n  function getOrCreateEntityGroup(ownerId, entityType, groupName) {\n    return entityGroupService.getEntityGroupsByOwnerId(ownerId.entityType, ownerId.id, entityType).pipe(\n      rxjs.switchMap(function(groups) {\n        const existingGroup = groups.find(function(g) { return g.name === groupName; });\n        if (existingGroup) {\n          return rxjs.of(existingGroup);\n        }\n        const newGroup = {\n          type: entityType,\n          name: groupName,\n          ownerId: ownerId\n        };\n        return entityGroupService.saveEntityGroup(newGroup);\n      })\n    );\n  }\n\n  function saveRelation(fromId, toId, relationType) {\n    const relation = {\n      from: fromId,\n      to: toId,\n      typeGroup: 'COMMON',\n      type: relationType\n    };\n    return entityRelationService.saveRelation(relation);\n  }\n\n  function saveDeviceToKitRelation(kitId, deviceId) {\n    const relation = {\n      from: kitId,\n      to: deviceId,\n      typeGroup: 'COMMON',\n      type: 'Contains'\n    };\n    return entityRelationService.saveRelation(relation);\n  }\n}\n",
                "customResources": [],
                "id": "act-add-kit"
              },
              {
                "name": "btn-transfer-kit",
                "buttonType": "icon",
                "icon": "mdi:swap-horizontal",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\nreturn userRole === 'ECO Administrator';",
                "type": "customPretty",
                "customHtml": "<form #transferKitForm=\"ngForm\" [formGroup]=\"transferKitFormGroup\" (ngSubmit)=\"save()\" class=\"transfer-kit-dialog\">\n  <!-- Header -->\n  <div class=\"dialog-header\">\n    <mat-icon>swap_horiz</mat-icon>\n    <h2>{{ 'custom.diagnostic-kits.transfer-kit' | translate }}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\" class=\"close-btn\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </div>\n\n  <div class=\"dialog-body\">\n    <!-- Kit Selection Card -->\n    <div class=\"section-card kit-card\">\n      <div class=\"card-header-mini\">\n        <span>{{ 'custom.diagnostic-kits.select-kit' | translate }}</span>\n      </div>\n      <div class=\"card-content\">\n        <mat-form-field appearance=\"fill\" class=\"full-width\">\n          <mat-label>Kit</mat-label>\n          <mat-select formControlName=\"kit\" required (selectionChange)=\"onKitSelected($event)\">\n            <mat-option *ngFor=\"let kit of kits\" [value]=\"kit\">\n              {{ kit.name }}\n            </mat-option>\n          </mat-select>\n          <mat-error *ngIf=\"transferKitFormGroup.get('kit')?.hasError('required')\">\n            {{ 'custom.diagnostic-kits.kit-is-required' | translate }}\n          </mat-error>\n        </mat-form-field>\n      </div>\n    </div>\n\n    <!-- Transfer Arrow -->\n    <div class=\"transfer-arrow-simple\">\n      <mat-icon>arrow_downward</mat-icon>\n    </div>\n\n    <!-- Customer Selection Card -->\n    <div class=\"section-card customer-card\">\n      <div class=\"card-header-mini\">\n        <span>{{ 'custom.diagnostic-kits.target-customer' | translate }}</span>\n      </div>\n      <div class=\"card-content\">\n        <mat-form-field appearance=\"fill\" class=\"full-width\">\n          <mat-label>{{ 'custom.diagnostic-kits.customer' | translate }}</mat-label>\n          <mat-select formControlName=\"customer\" required (selectionChange)=\"onCustomerSelected($event)\">\n            <mat-option *ngFor=\"let cust of customers\" [value]=\"cust\">\n              {{ cust.title }}\n            </mat-option>\n          </mat-select>\n          <mat-error *ngIf=\"transferKitFormGroup.get('customer')?.hasError('required')\">\n            {{ 'custom.diagnostic-kits.customer-is-required' | translate }}\n          </mat-error>\n        </mat-form-field>\n      </div>\n    </div>\n\n    <!-- Warning Banner (if kit has measurements) -->\n    <div *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" class=\"warning-banner\">\n      <mat-icon>warning</mat-icon>\n      <span>{{ 'custom.diagnostic-kits.kit-has-assigned-measurement-warning' | translate }}</span>\n    </div>\n\n    <!-- Transfer Preview (if customer selected) -->\n    <div *ngIf=\"foundProject\" class=\"section-card transfer-card\">\n      <div class=\"card-header-mini\">\n        <span>{{ 'custom.diagnostic-kits.transfer-details' | translate }}</span>\n        <span class=\"badge badge-orange\">{{ 'custom.diagnostic-kits.preview' | translate }}</span>\n      </div>\n      <div class=\"card-content\">\n        <!-- Project Transfer -->\n        <div class=\"transfer-row\">\n          <mat-form-field appearance=\"fill\" class=\"transfer-field\">\n            <mat-label>{{ 'custom.diagnostic-kits.found-project' | translate }}</mat-label>\n            <input matInput formControlName=\"foundProject\" readonly>\n          </mat-form-field>\n          <mat-icon class=\"arrow-icon\">arrow_forward</mat-icon>\n          <mat-form-field appearance=\"fill\" class=\"transfer-field\">\n            <mat-label>{{ 'custom.diagnostic-kits.transferred-project' | translate }}</mat-label>\n            <input matInput formControlName=\"transferredProject\" readonly>\n          </mat-form-field>\n        </div>\n\n        <!-- Measurements Transfer -->\n        <div *ngFor=\"let measurement of projectMeasurements; let i = index\" class=\"transfer-row\">\n          <mat-form-field appearance=\"fill\" class=\"transfer-field\">\n            <mat-label>{{ 'custom.diagnostic-kits.found-measurement' | translate }}</mat-label>\n            <input matInput [formControlName]=\"'measurement' + i\" readonly>\n          </mat-form-field>\n          <mat-icon class=\"arrow-icon\">arrow_forward</mat-icon>\n          <mat-form-field appearance=\"fill\" class=\"transfer-field\">\n            <mat-label>{{ 'custom.diagnostic-kits.transferred-measurement' | translate }}</mat-label>\n            <input matInput [formControlName]=\"'transferredMeasurement' + i\" readonly>\n          </mat-form-field>\n        </div>\n\n        <!-- Devices Transfer -->\n        <div *ngFor=\"let device of allDevices; let i = index\" class=\"transfer-row\">\n          <mat-form-field appearance=\"fill\" class=\"transfer-field\">\n            <mat-label>{{ 'custom.diagnostic-kits.found-device' | translate }}</mat-label>\n            <input matInput [formControlName]=\"'device' + i\" readonly>\n          </mat-form-field>\n          <mat-icon class=\"arrow-icon\">arrow_forward</mat-icon>\n          <mat-form-field appearance=\"fill\" class=\"transfer-field\">\n            <mat-label>{{ 'custom.diagnostic-kits.transferred-device' | translate }}</mat-label>\n            <input matInput [formControlName]=\"'transferredDevice' + i\" readonly>\n          </mat-form-field>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <!-- Footer -->\n  <div class=\"dialog-footer\">\n    <button mat-button type=\"button\" (click)=\"cancel()\" class=\"cancel-btn\">\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"transferKitFormGroup.invalid\" class=\"submit-btn\">\n      <mat-icon>swap_horiz</mat-icon>\n      {{ 'custom.diagnostic-kits.transfer' | translate }}\n    </button>\n  </div>\n</form>",
                "customCss": "/* Transfer Kit Dialog */\n.transfer-kit-dialog {\n  width: 700px;\n  max-height: 85vh;\n  display: flex;\n  flex-direction: column;\n  background: #f8fafc;\n}\n\n/* Header */\n.dialog-header {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  padding: 14px 20px;\n  background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);\n  color: white;\n}\n.dialog-header mat-icon {\n  font-size: 24px;\n  width: 24px;\n  height: 24px;\n}\n.dialog-header h2 {\n  margin: 0;\n  font-size: 18px;\n  font-weight: 600;\n}\n.close-btn {\n  color: rgba(255,255,255,0.8) !important;\n}\n.close-btn:hover {\n  color: white !important;\n  background: rgba(255,255,255,0.1) !important;\n}\n\n/* Body */\n.dialog-body {\n  flex: 1;\n  overflow-y: auto;\n  padding: 16px;\n}\n\n/* Section Cards */\n.section-card {\n  background: white;\n  border-radius: 8px;\n  border: 1px solid #e2e8f0;\n  margin-bottom: 12px;\n  overflow: hidden;\n}\n\n.card-header-mini {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  padding: 10px 14px;\n  background: #f8fafc;\n  border-bottom: 1px solid #e2e8f0;\n  font-weight: 600;\n  font-size: 14px;\n  color: #334155;\n}\n\n.card-content {\n  padding: 14px;\n}\n\n/* Card border colors */\n.kit-card {\n  border-left: 3px solid #8b5cf6;\n}\n.customer-card {\n  border-left: 3px solid #3b82f6;\n}\n.transfer-card {\n  border-left: 3px solid #f59e0b;\n}\n\n/* Form Fields */\n.full-width {\n  width: 100%;\n}\n\n.transfer-kit-dialog .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n.transfer-kit-dialog .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n/* Simple Arrow */\n.transfer-arrow-simple {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 8px 0;\n}\n.transfer-arrow-simple mat-icon {\n  color: #f59e0b;\n  font-size: 28px;\n  width: 28px;\n  height: 28px;\n}\n\n/* Warning Banner */\n.warning-banner {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  padding: 12px 16px;\n  background: #fef3c7;\n  border: 1px solid #fcd34d;\n  border-radius: 8px;\n  margin-bottom: 12px;\n  color: #92400e;\n  font-size: 14px;\n}\n.warning-banner mat-icon {\n  color: #d97706;\n  font-size: 22px;\n  width: 22px;\n  height: 22px;\n}\n\n/* Badge */\n.badge {\n  font-size: 11px;\n  font-weight: 600;\n  padding: 3px 8px;\n  border-radius: 12px;\n  text-transform: uppercase;\n  margin-left: auto;\n}\n.badge-orange {\n  background: #ffedd5;\n  color: #c2410c;\n}\n\n/* Transfer Rows */\n.transfer-row {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  margin-bottom: 12px;\n}\n.transfer-row:last-child {\n  margin-bottom: 0;\n}\n.transfer-field {\n  flex: 1;\n}\n.arrow-icon {\n  color: #f59e0b !important;\n  flex-shrink: 0;\n}\n\n/* Footer */\n.dialog-footer {\n  display: flex;\n  justify-content: flex-end;\n  align-items: center;\n  gap: 12px;\n  padding: 12px 20px;\n  background: white;\n  border-top: 1px solid #e2e8f0;\n}\n\n.cancel-btn {\n  color: #64748b !important;\n}\n\n.submit-btn {\n  font-weight: 600 !important;\n  padding: 0 20px !important;\n  height: 42px !important;\n  border-radius: 8px !important;\n  background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%) !important;\n}\n.submit-btn mat-icon {\n  margin-right: 6px;\n}\n.submit-btn:hover:not([disabled]) {\n  background: linear-gradient(135deg, #b45309 0%, #d97706 100%) !important;\n}\n.submit-btn[disabled] {\n  background: #e2e8f0 !important;\n  color: #94a3b8 !important;\n}",
                "customFunction": "let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet dialogs = injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\nlet customerId, customer;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet pageLink = {\r\n  pageSize: 100, page: 0, textSearch: '', sortOrder: 'ASC', sortProperty: 'title',\r\n  toQuery: function () {\r\n    let q = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) q += '&textSearch=' + encodeURIComponent(this.textSearch);\r\n    if (this.sortProperty) q += '&sortProperty=' + encodeURIComponent(this.sortProperty);\r\n    if (this.sortOrder) q += '&sortOrder=' + encodeURIComponent(this.sortOrder);\r\n    return q;\r\n  }\r\n};\r\n\r\nlet kits = [];\r\nlet customers = [];\r\nlet kitsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (kitsLoaded && customersLoaded) openTransferKitDialog(kits, customers);\r\n}\r\n\r\nlet kitSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id, rootType: 'CUSTOMER', direction: 'FROM',\r\n    relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Diagnostickit']\r\n};\r\n\r\nassetService.findByQuery(kitSearchQuery).subscribe(\r\n  result => { kits = result; kitsLoaded = true; checkAndOpenDialog(); },\r\n  () => { kits = []; kitsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\n// NOTE: credentials come from your original snippet\r\nlet bearerToken = '';\r\nfetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n  method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n  body: JSON.stringify({ \"username\": \"belimo.api@pke-iot.expert\", \"password\": \"vfx3cvr@VMJ3bxk3urg\" })\r\n})\r\n  .then(resp => resp.json())\r\n  .then(loginData => {\r\n    bearerToken = loginData.token;\r\n    return fetch('https://cloud.pke-iot.expert/api/customers?pageSize=100&page=0', {\r\n      method: 'GET',\r\n      headers: { 'accept': 'application/json', 'X-Authorization': 'Bearer ' + bearerToken }\r\n    });\r\n  })\r\n  .then(resp2 => resp2.json())\r\n  .then(customersList => {\r\n    customers = customersList.data;\r\n    if (customer) customers = customers.filter(cust => cust.title !== customer);\r\n    customersLoaded = true; checkAndOpenDialog();\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching customers:\", error);\r\n    alert('Failed to fetch customers.');\r\n  });\r\n\r\nfunction openTransferKitDialog(kits, customers) {\r\n  customDialog.customDialog(htmlTemplate, TransferKitDialogController, { kits, customers }).subscribe();\r\n}\r\n\r\nfunction TransferKitDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.kits = data.kits || [];\r\n  vm.customers = data.customers || [];\r\n\r\n  vm.transferKitFormGroup = vm.fb.group({\r\n    kit: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n  vm.transferKitFormGroup.addControl('transferredProject', vm.fb.control({ value: '', disabled: true }));\r\n\r\n  vm.allDevices = [];\r\n  vm.devicesWithMeasurements = [];\r\n  vm.foundProject = null;\r\n  vm.projectMeasurements = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n     vm.measurementRenameMap = new Map();\r\n\r\n\r\n  const groupCache = new Map(); // key: ownerId|scope|name -> Observable(group)\r\n  function ensureGroup(ownerIdObj, scopeType, name) {\r\n    const key = ownerIdObj.id + '|' + scopeType + '|' + name;\r\n    if (groupCache.has(key)) return groupCache.get(key);\r\n\r\n    const obs = entityGroupService.getEntityGroupsByOwnerId(ownerIdObj.entityType, ownerIdObj.id, scopeType).pipe(\r\n      widgetContext.rxjs.switchMap(groups => {\r\n        let g = (groups || []).find(x => x.name === name);\r\n        if (g) return widgetContext.rxjs.of(g);\r\n        const payload = { type: scopeType, name, ownerId: ownerIdObj };\r\n        return entityGroupService.saveEntityGroup(payload).pipe(\r\n          // If backend races and says \"already exists\", re-fetch once\r\n          widgetContext.rxjs.catchError(err => {\r\n            if (err && err.status === 400) {\r\n              return entityGroupService.getEntityGroupsByOwnerId(ownerIdObj.entityType, ownerIdObj.id, scopeType).pipe(\r\n                widgetContext.rxjs.map(gs => (gs || []).find(x => x.name === name))\r\n              );\r\n            }\r\n            return widgetContext.rxjs.throwError(err);\r\n          })\r\n        );\r\n      }),\r\n      widgetContext.rxjs.shareReplay(1)\r\n    );\r\n    groupCache.set(key, obs);\r\n    return obs;\r\n  }\r\n\r\n  function addToGroupSafe(groupId, entityId) {\r\n    return entityGroupService.addEntitiesToEntityGroup(groupId, [entityId]).pipe(\r\n      widgetContext.rxjs.catchError(err => {\r\n        // tolerate duplicate-membership/409/400 responses\r\n        return widgetContext.rxjs.of(null);\r\n      })\r\n    );\r\n  }\r\n\r\n  function getProjectsGroup(owner)                { return ensureGroup(owner, 'ASSET',  'Projects'); }\r\n  function getMeasurementsGroup(owner)            { return ensureGroup(owner, 'ASSET',  'Measurements'); }\r\n  function getDiagnostickitsGroup(owner)          { return ensureGroup(owner, 'ASSET',  'Diagnostickits'); }\r\n  function getGatewaysGroup(owner)                { return ensureGroup(owner, 'DEVICE', 'Gateways'); }\r\n  function getDiagnostickitDevicesGroup(owner)    { return ensureGroup(owner, 'DEVICE', 'Diagnostickit Devices'); }\r\n  function getUnassignedMeasurementDevicesGroup(owner) { return ensureGroup(owner, 'DEVICE', 'Unassigned Measurement Devices'); }\r\n\r\n  vm.transferKitFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId, rootType: 'CUSTOMER', direction: 'FROM',\r\n          relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { vm.transferredProject = null; vm.customerShortName = null; }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null; vm.customerShortName = null;\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        if (vm.transferKitFormGroup.get('transferredMeasurement' + index)) {\r\n          vm.transferKitFormGroup.get('transferredMeasurement' + index).setValue('');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  vm.onKitSelected = function (event) {\r\n    let selectedKit = event.value;\r\n    vm.allDevices = [];\r\n    vm.devicesWithMeasurements = [];\r\n    vm.foundProject = null;\r\n    vm.projectMeasurements = [];\r\n\r\n    Object.keys(vm.transferKitFormGroup.controls)\r\n      .filter(n => n.startsWith('measurement') || n.startsWith('transferredMeasurement') || n.startsWith('device') || n.startsWith('transferredDevice'))\r\n      .forEach(n => vm.transferKitFormGroup.removeControl(n));\r\n    \r\n    let selectedCustomer = vm.transferKitFormGroup.get('customer').value;\r\n    if (!selectedKit || !selectedCustomer) {\r\n      console.warn(\"Kit or customer not selected yet.\");\r\n      return;\r\n    }\r\n    \r\n    let selectedKitId = selectedKit.id.id ? selectedKit.id.id : selectedKit.id;\r\n\r\n    let deviceSearchQuery = {\r\n      parameters: {\r\n        rootId: selectedKitId, rootType: 'ASSET', direction: 'FROM',\r\n        relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: true\r\n      },\r\n      relationType: 'Contains',\r\n      deviceTypes: ['P-Flow D116','Room Sensor CO2','Temperature Sensor','RESI','Gateway','LTE Status']\r\n    };\r\n    \r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n      devices => {\r\n        vm.allDevices = devices || [];\r\n        if (vm.allDevices.length === 0) return;\r\n\r\n        vm.allDevices.forEach((device, index) => {\r\n          vm.transferKitFormGroup.addControl('device' + index, vm.fb.control({ value: device.name, disabled: true }));\r\n          vm.transferKitFormGroup.addControl('transferredDevice' + index, vm.fb.control({ value: device.name, disabled: true }));\r\n        });\r\n\r\n        let measurementChecks = vm.allDevices.map(device => {\r\n          let measurementQuery = {\r\n            parameters: {\r\n              rootId: (device.id.id ? device.id.id : device.id), rootType: 'DEVICE', direction: 'TO',\r\n              relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: false\r\n            },\r\n            relationType: 'Measurement',\r\n            assetTypes: ['Measurement']\r\n          };\r\n          return assetService.findByQuery(measurementQuery).pipe(\r\n            widgetContext.rxjs.map(measurements => ({ device, measurements: measurements || [] }))\r\n          );\r\n        });\r\n\r\n        widgetContext.rxjs.forkJoin(measurementChecks).subscribe(\r\n          measurementResults => {\r\n            vm.devicesWithMeasurements = measurementResults.filter(r => r.measurements.length > 0);\r\n            let projectChecks = [];\r\n            vm.devicesWithMeasurements.forEach(item => {\r\n              item.measurements.forEach(meas => {\r\n                let projectQuery = {\r\n                  parameters: {\r\n                    rootId: (meas.id.id ? meas.id.id : meas.id), rootType: 'ASSET', direction: 'TO',\r\n                    relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: 'Owns',\r\n                  assetTypes: ['Project']\r\n                };\r\n                projectChecks.push(assetService.findByQuery(projectQuery).pipe(\r\n                  widgetContext.rxjs.map(projects => ({ measurement: meas, projects: projects || [] }))\r\n                ));\r\n              });\r\n            });\r\n            if (projectChecks.length === 0) return;\r\n\r\n            widgetContext.rxjs.forkJoin(projectChecks).subscribe(\r\n              projectResults => {\r\n                let found = projectResults.find(r => r.projects.length > 0);\r\n                if (found) {\r\n                  vm.foundProject = found.projects[0];\r\n                  if (!vm.transferKitFormGroup.get('foundProject')) {\r\n                    vm.transferKitFormGroup.addControl('foundProject', vm.fb.control({ value: vm.foundProject.name, disabled: true }));\r\n                  } else {\r\n                    vm.transferKitFormGroup.get('foundProject').setValue(vm.foundProject.name);\r\n                  }\r\n                  searchMeasurementsForProject(vm.foundProject);\r\n                }\r\n              },\r\n              err => console.error(\"Error during project queries:\", err)\r\n            );\r\n          },\r\n          err => console.error(\"Error in measurement checks:\", err)\r\n        );\r\n      },\r\n      err => console.error(\"Error finding devices for kit:\", err)\r\n    );\r\n  };\r\n\r\n  vm.onCustomerSelected = function () {\r\n    let kit = vm.transferKitFormGroup.get('kit').value;\r\n    if (kit) vm.onKitSelected({ value: kit });\r\n  };\r\n\r\n  function updateFoundProjectName(customerShortName, existingProjects) {\r\n    if (!customerShortName) return;\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) { maxNumericSuffix = parsedNum; }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    vm.transferredProject = candidate;\r\n    vm.transferKitFormGroup.get('transferredProject').setValue(candidate);\r\n  }\r\n\r\n  function renameProjectMeasurements() {\r\n    if (!vm.customerShortName) return;\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n      let newProjectNameCtrl = vm.transferKitFormGroup.get('transferredProject');\r\n      let oldName = measurement.name;\r\n      let parts = oldName.split('_');\r\n      let newName = newProjectNameCtrl.value + '_' + parts[2];\r\n      let control = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n      if (control) control.setValue(newName);\r\n    });\r\n  }\r\n\r\n  function searchMeasurementsForProject(project) {\r\n    let projectId = project.id.id ? project.id.id : project.id;\r\n    let projectMeasurementQuery = {\r\n      parameters: {\r\n        rootId: projectId, rootType: 'ASSET', direction: 'FROM',\r\n        relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Measurement']\r\n    };\r\n    assetService.findByQuery(projectMeasurementQuery).subscribe(\r\n      measurements => {\r\n        vm.projectMeasurements = measurements || [];\r\n        Object.keys(vm.transferKitFormGroup.controls)\r\n          .filter(n => n.startsWith('measurement') || n.startsWith('transferredMeasurement'))\r\n          .forEach(n => vm.transferKitFormGroup.removeControl(n));\r\n        (measurements || []).forEach((measurement, index) => {\r\n          vm.transferKitFormGroup.addControl('measurement' + index, vm.fb.control({ value: measurement.name, disabled: true }));\r\n          vm.transferKitFormGroup.addControl('transferredMeasurement' + index, vm.fb.control({ value: '', disabled: true }));\r\n        });\r\n        renameProjectMeasurements();\r\n      },\r\n      err => console.error(\"Error finding measurements for project:\", err)\r\n    );\r\n  }\r\n\r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      }),\r\n      widgetContext.rxjs.catchError(() => widgetContext.rxjs.of(null)) // tolerate if old relation missing\r\n    );\r\n  }\r\n\r\n  function getVrDevicesForDevice(deviceId) {\r\n    return entityRelationService.findByTo({ id: deviceId, entityType: 'DEVICE' }).pipe(\r\n      widgetContext.rxjs.map(rels =>\r\n        (rels || [])\r\n          .filter(r => r.typeGroup === 'COMMON' && r.type === 'VR' && r.from?.entityType === 'DEVICE')\r\n          .map(r => (r.from.id.id ? r.from.id.id : r.from.id)) // return VR device UUIDs\r\n      )\r\n    );\r\n  }\r\n\r\n  function computeNewVrName(oldVrName) {\r\n      const original = (oldVrName || '').trim();\r\n      if (!original) { \r\n        console.debug('[VR Rename] Empty VR name; skip');\r\n        return null;\r\n      }\r\n    \r\n      // 1) Primary: precise map-based rename (oldMeasName or oldMeasName_)\r\n      if (vm.measurementRenameMap && vm.measurementRenameMap.size > 0) {\r\n        const entries = Array.from(vm.measurementRenameMap.entries())\r\n          .sort((a, b) => b[0].length - a[0].length); // longest first\r\n    \r\n        for (const [oldMeasNameRaw, newMeasNameRaw] of entries) {\r\n          const oldMeas = String(oldMeasNameRaw || '').trim();\r\n          const newMeas = String(newMeasNameRaw || '').trim();\r\n          if (!oldMeas || !newMeas) continue;\r\n    \r\n          // exact match\r\n          if (original === oldMeas) {\r\n            const renamed = newMeas;\r\n            console.debug('[VR Rename] Exact match:', { original, oldMeas, newMeas, renamed });\r\n            return renamed;\r\n          }\r\n          // prefix match \"<oldMeas>_<suffix>\"\r\n          const prefix = oldMeas + '_';\r\n          if (original.startsWith(prefix)) {\r\n            const suffix = original.substring(prefix.length);\r\n            const renamed = newMeas + '_' + suffix;\r\n            console.debug('[VR Rename] Prefix match:', { original, oldMeas, newMeas, suffix, renamed });\r\n            return renamed;\r\n          }\r\n        }\r\n      } else {\r\n        console.debug('[VR Rename] Empty measurementRenameMap; will try ECO fallback for', original);\r\n      }\r\n    \r\n      // 2) Fallback: if we can’t match the old measurement name, but there is exactly ONE new measurement name,\r\n      //    replace everything BEFORE \"_ECO_\" with that name.\r\n      //    This gives:  \"<anything>_ECO_...\" -> \"<singleNewMeas>_ECO_...\"\r\n      const newNames = vm.measurementRenameMap ? Array.from(vm.measurementRenameMap.values()).map(v => String(v || '').trim()).filter(Boolean) : [];\r\n      if (newNames.length === 1) {\r\n        const soleNew = newNames[0];\r\n        // Typical delimiter in your VR naming: \"_ECO_\"\r\n        const ecoIdx = original.indexOf('_ECO_');\r\n        if (ecoIdx > 0) {\r\n          const suffixFromEco = original.substring(ecoIdx + 1); // keep \"ECO_...\"\r\n          const renamed = soleNew + '_' + suffixFromEco;\r\n          console.debug('[VR Rename] Fallback via _ECO_:',\r\n            { original, soleNew, suffixFromEco, renamed });\r\n          return renamed;\r\n        }\r\n        // If \"_ECO_\" is not present, as a safer generic fallback: replace up to the 3rd underscore (common in \"X_Y_Z_...\")\r\n        const parts = original.split('_');\r\n        if (parts.length >= 3) {\r\n          const suffix = parts.slice(3).join('_'); // keep everything after first 3 segments\r\n          const renamed = suffix ? (soleNew + '_' + suffix) : soleNew;\r\n          console.debug('[VR Rename] Fallback via 3-seg prefix:',\r\n            { original, soleNew, suffix, renamed });\r\n          return renamed;\r\n        }\r\n      }\r\n    \r\n      console.debug('[VR Rename] No matching rule for', original);\r\n      return null; // no rename\r\n    }\r\n\r\n\r\n\r\n\r\n  function transferVrDevice(vrDeviceId, newOwner, hasProjectMeasurements) {\r\n    return deviceService.getDevice(vrDeviceId).pipe(\r\n      widgetContext.rxjs.switchMap(vr => {\r\n        const maybeNewName = computeNewVrName(vr.name);\r\n        if (maybeNewName && maybeNewName !== vr.name) vr.name = maybeNewName;\r\n        return deviceService.saveDevice(vr).pipe(\r\n          widgetContext.rxjs.switchMap(updatedVr => {\r\n            const vrEntity = updatedVr.id && updatedVr.id.entityType\r\n              ? updatedVr.id\r\n              : { id: updatedVr.id, entityType: 'DEVICE' };\r\n\r\n            return entityGroupService.changeEntityOwner(newOwner, vrEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() =>\r\n                (updatedVr.type === 'Gateway VR')\r\n                  ? getGatewaysGroup(newOwner).pipe(\r\n                      widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, vrEntity.id))\r\n                    )\r\n                  : widgetContext.rxjs.of(null)\r\n              ),\r\n              widgetContext.rxjs.switchMap(() =>\r\n                (!hasProjectMeasurements)\r\n                  ? getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                      widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, vrEntity.id))\r\n                    )\r\n                  : widgetContext.rxjs.of(null)\r\n              )\r\n            );\r\n\r\n          })\r\n        );\r\n      })\r\n    );\r\n  }\r\n\r\n  function transferVrsForPhysicalDevice(physicalDeviceId, newOwner, hasProjectMeasurements) {\r\n    return getVrDevicesForDevice(physicalDeviceId).pipe(\r\n      widgetContext.rxjs.switchMap(vrIds => {\r\n        if (!vrIds || vrIds.length === 0) return widgetContext.rxjs.of(null);\r\n        const ops = vrIds.map(vrId => transferVrDevice(vrId, newOwner, hasProjectMeasurements));\r\n        return widgetContext.rxjs.forkJoin(ops);\r\n      })\r\n    );\r\n  }\r\n\r\n  vm.save = function () {\r\n    const formValue = vm.transferKitFormGroup.value;\r\n    const selectedCustomer = formValue.customer;\r\n    if (!selectedCustomer || !selectedCustomer.id) { console.warn('No customer selected.'); return; }\r\n\r\n    if (!vm.customerShortName) vm.customerShortName = selectedCustomer.title;\r\n    const selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n    const newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n\r\n    const saveObservables = [];\r\n    const hasProjectMeasurements = vm.foundProject || (vm.projectMeasurements && vm.projectMeasurements.length > 0);\r\n    const selectedKit = formValue.kit;\r\n    if (!selectedKit.name) { console.warn(\"Selected kit has no name. Aborting save.\"); return; }\r\n    \r\n      vm.measurementRenameMap = new Map();\r\n      if (Array.isArray(vm.projectMeasurements) && vm.projectMeasurements.length > 0) {\r\n        vm.projectMeasurements.forEach((measurement, index) => {\r\n          const ctrl = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n          const newName = ctrl ? String(ctrl.value || '').trim() : '';\r\n          const oldName = String(measurement.name || '').trim();\r\n          if (oldName && newName) {\r\n            vm.measurementRenameMap.set(oldName, newName);\r\n            console.debug('[VR Rename] map:', oldName, '→', newName);\r\n          }\r\n        });\r\n      } else {\r\n        console.debug('[VR Rename] No project measurements; VR renames may be skipped.');\r\n      }\r\n\r\n\r\n    const preEnsure$ = widgetContext.rxjs.forkJoin([\r\n      getDiagnostickitsGroup(newOwner),\r\n      getDiagnostickitDevicesGroup(newOwner),\r\n      getGatewaysGroup(newOwner),\r\n      getUnassignedMeasurementDevicesGroup(newOwner),\r\n      getProjectsGroup(newOwner),\r\n      getMeasurementsGroup(newOwner)\r\n    ]).pipe(widgetContext.rxjs.catchError(() => widgetContext.rxjs.of(null)));\r\n\r\n\r\n    preEnsure$.subscribe(() => {\r\n      // KIT\r\n      let kitSave$ = assetService.saveAsset(selectedKit).pipe(\r\n        widgetContext.rxjs.switchMap(updatedKit => {\r\n          let kitEntity = updatedKit.id && updatedKit.id.entityType ? updatedKit.id : { id: updatedKit.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n            widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, kitEntity)),\r\n            widgetContext.rxjs.switchMap(() =>\r\n              getDiagnostickitsGroup(newOwner).pipe(\r\n                widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, kitEntity.id))\r\n              )\r\n            )\r\n          );\r\n        })\r\n      );\r\n      saveObservables.push(kitSave$);\r\n\r\n\r\n      if (vm.foundProject) {\r\n        let project = vm.foundProject;\r\n        let candidate = (vm.transferredProject && vm.transferredProject.trim()) || ((vm.customerShortName || selectedCustomer.title) + '_Project_1');\r\n        vm.transferredProject = candidate;\r\n        project.name = candidate;\r\n        if (!project.type || !project.type.trim()) project.type = \"Project\";\r\n\r\n        let projectSave$ = assetService.saveAsset(project).pipe(\r\n          widgetContext.rxjs.switchMap(updatedProject => {\r\n            let projectEntity = updatedProject.id && updatedProject.id.entityType ? updatedProject.id : { id: updatedProject.id, entityType: 'ASSET' };\r\n            return entityGroupService.changeEntityOwner(newOwner, projectEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, projectEntity)),\r\n              widgetContext.rxjs.switchMap(() => getProjectsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, projectEntity.id))\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(projectSave$);\r\n      }\r\n\r\n\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        let newMeasurementName = vm.transferKitFormGroup.get('transferredMeasurement' + index).value;\r\n        if (!newMeasurementName || !newMeasurementName.trim()) return;\r\n\r\n        measurement.name = newMeasurementName.trim();\r\n        let measurementSave$ = assetService.saveAsset(measurement).pipe(\r\n          widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n            let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType ? updatedMeasurement.id : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n            return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, measurementEntity)),\r\n              widgetContext.rxjs.switchMap(() => getMeasurementsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, measurementEntity.id))\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(measurementSave$);\r\n      });\r\n\r\n\r\n      vm.allDevices.forEach((device, index) => {\r\n        let newDeviceName = vm.transferKitFormGroup.get('transferredDevice' + index).value;\r\n        if (!newDeviceName || !newDeviceName.trim()) return;\r\n        device.name = newDeviceName.trim();\r\n\r\n        let deviceSave$ = deviceService.saveDevice(device).pipe(\r\n          widgetContext.rxjs.switchMap(updatedDevice => {\r\n            const deviceEntity = updatedDevice.id && updatedDevice.id.entityType ? updatedDevice.id : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n            return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() =>\r\n                getDiagnostickitDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                )\r\n              ),\r\n              widgetContext.rxjs.switchMap(() => {\r\n                if (updatedDevice.type === 'RESI' || updatedDevice.type === 'Gateway') {\r\n                  return getGatewaysGroup(newOwner).pipe(\r\n                    widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                  );\r\n                }\r\n                return widgetContext.rxjs.of(null);\r\n              }),\r\n              widgetContext.rxjs.switchMap(() => {\r\n                if (!hasProjectMeasurements) {\r\n                  return getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                    widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                  );\r\n                }\r\n                return widgetContext.rxjs.of(null);\r\n              }),\r\n\r\n              widgetContext.rxjs.switchMap(() =>\r\n                transferVrsForPhysicalDevice(deviceEntity.id, newOwner, hasProjectMeasurements)\r\n              )\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(deviceSave$);\r\n      });\r\n\r\n      widgetContext.rxjs.forkJoin(saveObservables).subscribe(\r\n        () => { widgetContext.updateAliases(); vm.dialogRef.close(formValue); },\r\n        err => { console.error('Error updating assets:', err); }\r\n      );\r\n    });\r\n  };\r\n\r\n  vm.cancel = function () { vm.dialogRef.close(null); };\r\n}\r\n\r\n\r\n\r\n/*let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet dialogs = injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\nlet customerId, customer;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet pageLink = {\r\n  pageSize: 100,\r\n  page: 0,\r\n  textSearch: '',\r\n  sortOrder: 'ASC',\r\n  sortProperty: 'title',\r\n  toQuery: function () {\r\n    let query = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) { query += '&textSearch=' + encodeURIComponent(this.textSearch); }\r\n    if (this.sortProperty) { query += '&sortProperty=' + encodeURIComponent(this.sortProperty); }\r\n    if (this.sortOrder) { query += '&sortOrder=' + encodeURIComponent(this.sortOrder); }\r\n    return query;\r\n  }\r\n};\r\n\r\nlet kits = [];\r\nlet customers = [];\r\nlet kitsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (kitsLoaded && customersLoaded) {\r\n    openTransferKitDialog(kits, customers);\r\n  }\r\n}\r\n\r\nlet kitSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id,\r\n    rootType: 'CUSTOMER',\r\n    direction: 'FROM',\r\n    relationTypeGroup: 'COMMON',\r\n    maxLevel: 10,\r\n    fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Diagnostickit']\r\n};\r\n\r\nassetService.findByQuery(kitSearchQuery).subscribe(\r\n  result => { kits = result; kitsLoaded = true; checkAndOpenDialog(); },\r\n  () => { kits = []; kitsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\nlet bearerToken = '';\r\nfetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n  method: 'POST',\r\n  headers: {\r\n    'Content-Type': 'application/json'\r\n  },\r\n  body: JSON.stringify({\r\n    \"username\": \"belimo.api@pke-iot.expert\",\r\n    \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n  })\r\n})\r\n  .then(resp => resp.json())\r\n  .then(loginData => {\r\n    bearerToken = loginData.token;\r\n    return fetch('https://cloud.pke-iot.expert/api/customers?pageSize=100&page=0', {\r\n      method: 'GET',\r\n      headers: {\r\n        'accept': 'application/json',\r\n        'X-Authorization': 'Bearer ' + bearerToken\r\n      }\r\n    });\r\n  })\r\n  .then(resp2 => resp2.json())\r\n  .then(customersList => {\r\n    // Process the customers data here.\r\n    customers = customersList.data;\r\n    if (customer) { customers = customers.filter(cust => cust.title !== customer); }\r\n    customersLoaded = true;\r\n    checkAndOpenDialog();\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching customers:\", error);\r\n    alert('Failed to fetch customers.');\r\n  });\r\n\r\n\r\nfunction openTransferKitDialog(kits, customers) {\r\n  customDialog.customDialog(htmlTemplate, TransferKitDialogController, {\r\n    kits: kits,\r\n    customers: customers\r\n  }).subscribe();\r\n}\r\n\r\nfunction TransferKitDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.kits = data.kits || [];\r\n  vm.customers = data.customers || [];\r\n\r\n  vm.transferKitFormGroup = vm.fb.group({\r\n    kit: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n  vm.transferKitFormGroup.addControl('transferredProject', vm.fb.control({ value: '', disabled: true }));\r\n\r\n  vm.allDevices = [];\r\n  vm.devicesWithMeasurements = [];\r\n  vm.foundProject = null;\r\n  vm.projectMeasurements = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n\r\n  vm.transferKitFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId,\r\n          rootType: 'CUSTOMER',\r\n          direction: 'FROM',\r\n          relationTypeGroup: 'COMMON',\r\n          maxLevel: 10,\r\n          fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { \r\n          vm.transferredProject = null; \r\n          vm.customerShortName = null; \r\n        }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null;\r\n      vm.customerShortName = null;\r\n      // Clear out the transferred measurements when no customer is selected.\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        if (vm.transferKitFormGroup.get('transferredMeasurement' + index)) {\r\n          vm.transferKitFormGroup.get('transferredMeasurement' + index).setValue('');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  vm.onKitSelected = function (event) {\r\n    let selectedKit = event.value;\r\n    vm.allDevices = [];\r\n    vm.devicesWithMeasurements = [];\r\n    vm.foundProject = null;\r\n    vm.projectMeasurements = [];\r\n\r\n    // Remove previous measurement and device controls.\r\n    Object.keys(vm.transferKitFormGroup.controls)\r\n      .filter(controlName => controlName.startsWith('measurement') ||\r\n                             controlName.startsWith('transferredMeasurement') ||\r\n                             controlName.startsWith('device') ||\r\n                             controlName.startsWith('transferredDevice'))\r\n      .forEach(controlName => {\r\n        vm.transferKitFormGroup.removeControl(controlName);\r\n      });\r\n    \r\n    let selectedCustomer = vm.transferKitFormGroup.get('customer').value;\r\n    if (!selectedKit || !selectedCustomer) {\r\n      console.warn(\"Kit or customer not selected yet.\");\r\n      return;\r\n    }\r\n    \r\n    let selectedKitId = selectedKit.id.id ? selectedKit.id.id : selectedKit.id;\r\n\r\n    let deviceSearchQuery = {\r\n      parameters: {\r\n        rootId: selectedKitId,\r\n        rootType: 'ASSET',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: true\r\n      },\r\n      relationType: 'Contains',\r\n      deviceTypes: [\r\n          'P-Flow D116',\r\n          'Room Sensor CO2',\r\n          'Temperature Sensor',\r\n          'RESI',\r\n          'Gateway',\r\n          'LTE Status'\r\n      ]\r\n    };\r\n    \r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n      devices => {\r\n        vm.allDevices = devices || [];\r\n        \r\n        if (vm.allDevices.length === 0) {\r\n          console.warn(\"No devices found in selected kit.\");\r\n          return;\r\n        }\r\n        // For each device, add two controls: one showing the original device name, and one for transferred device,\r\n        // which is automatically set to the same name as the found device.\r\n        vm.allDevices.forEach((device, index) => {\r\n          vm.transferKitFormGroup.addControl(\r\n            'device' + index,\r\n            vm.fb.control({ value: device.name, disabled: true })\r\n          );\r\n          vm.transferKitFormGroup.addControl(\r\n            'transferredDevice' + index,\r\n            vm.fb.control({ value: device.name, disabled: true })\r\n          );\r\n        });\r\n\r\n        let measurementChecks = vm.allDevices.map(device => {\r\n          let measurementQuery = {\r\n            parameters: {\r\n              rootId: (device.id.id ? device.id.id : device.id),\r\n              rootType: 'DEVICE',\r\n              direction: 'TO',\r\n              relationTypeGroup: 'COMMON',\r\n              maxLevel: 1073741824,\r\n              fetchLastLevelOnly: false\r\n            },\r\n            relationType: 'Measurement',\r\n            assetTypes: ['Measurement']\r\n          };\r\n          return assetService.findByQuery(measurementQuery).pipe(\r\n            widgetContext.rxjs.map(measurements => {\r\n              return { device: device, measurements: measurements || [] };\r\n            })\r\n          );\r\n        });\r\n        widgetContext.rxjs.forkJoin(measurementChecks).subscribe(\r\n          measurementResults => {\r\n            vm.devicesWithMeasurements = measurementResults.filter(r => r.measurements.length > 0);\r\n            let projectChecks = [];\r\n            vm.devicesWithMeasurements.forEach(item => {\r\n              item.measurements.forEach(meas => {\r\n                let projectQuery = {\r\n                  parameters: {\r\n                    rootId: (meas.id.id ? meas.id.id : meas.id),\r\n                    rootType: 'ASSET',\r\n                    direction: 'TO',\r\n                    relationTypeGroup: 'COMMON',\r\n                    maxLevel: 10,\r\n                    fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: 'Owns',\r\n                  assetTypes: ['Project']\r\n                };\r\n                projectChecks.push(\r\n                  assetService.findByQuery(projectQuery).pipe(\r\n                    widgetContext.rxjs.map(projects => {\r\n                      return { measurement: meas, projects: projects || [] };\r\n                    })\r\n                  )\r\n                );\r\n              });\r\n            });\r\n            if (projectChecks.length === 0) {\r\n              return;\r\n            }\r\n            widgetContext.rxjs.forkJoin(projectChecks).subscribe(\r\n              projectResults => {\r\n                let found = projectResults.find(r => r.projects.length > 0);\r\n                if (found) {\r\n                  vm.foundProject = found.projects[0];\r\n                  if (!vm.transferKitFormGroup.get('foundProject')) {\r\n                    vm.transferKitFormGroup.addControl(\r\n                      'foundProject',\r\n                      vm.fb.control({ value: vm.foundProject.name, disabled: true })\r\n                    );\r\n                  } else {\r\n                    vm.transferKitFormGroup.get('foundProject').setValue(vm.foundProject.name);\r\n                  }\r\n                  searchMeasurementsForProject(vm.foundProject);\r\n                }\r\n              },\r\n              err => {\r\n                console.error(\"Error during project queries:\", err);\r\n              }\r\n            );\r\n          },\r\n          err => {\r\n            console.error(\"Error in measurement checks:\", err);\r\n          }\r\n        );\r\n      },\r\n      err => {\r\n        console.error(\"Error finding devices for kit:\", err);\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.onCustomerSelected = function (event) {\r\n    let kit = vm.transferKitFormGroup.get('kit').value;\r\n    if (kit) {\r\n      vm.onKitSelected({ value: kit });\r\n    }\r\n  };\r\n\r\n  function updateFoundProjectName(customerShortName, existingProjects) {\r\n    if (!customerShortName) {\r\n      console.warn(\"Customer short name is not defined.\");\r\n      return;\r\n    }\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) {\r\n          maxNumericSuffix = parsedNum;\r\n        }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    vm.transferredProject = candidate;\r\n    vm.transferKitFormGroup.get('transferredProject').setValue(candidate);\r\n    // Device names remain as set.\r\n  }\r\n\r\n  function renameProjectMeasurements() {\r\n    if (!vm.customerShortName) {\r\n      console.warn(\"Customer short name not set. Skipping measurement rename.\");\r\n      return;\r\n    }\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n    let newProjectName = vm.transferKitFormGroup.get('transferredProject');\r\n      let oldName = measurement.name;\r\n      let parts = oldName.split('_');\r\n      let newName = newProjectName.value + '_' + parts[2];\r\n      let control = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n      if (control) {\r\n        control.setValue(newName);\r\n      }\r\n    });\r\n  }\r\n\r\n  function searchMeasurementsForProject(project) {\r\n    let projectId = project.id.id ? project.id.id : project.id;\r\n    let projectMeasurementQuery = {\r\n      parameters: {\r\n        rootId: projectId,\r\n        rootType: 'ASSET',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Measurement']\r\n    };\r\n    assetService.findByQuery(projectMeasurementQuery).subscribe(\r\n      measurements => {\r\n        vm.projectMeasurements = measurements || [];\r\n\r\n        // Remove old measurement controls.\r\n        Object.keys(vm.transferKitFormGroup.controls)\r\n          .filter(controlName => controlName.startsWith('measurement') ||\r\n                                 controlName.startsWith('transferredMeasurement'))\r\n          .forEach(controlName => {\r\n            vm.transferKitFormGroup.removeControl(controlName);\r\n          });\r\n\r\n        (measurements || []).forEach((measurement, index) => {\r\n          vm.transferKitFormGroup.addControl(\r\n            'measurement' + index,\r\n            vm.fb.control({ value: measurement.name, disabled: true })\r\n          );\r\n          // Create transferred measurement control as disabled.\r\n          vm.transferKitFormGroup.addControl(\r\n            'transferredMeasurement' + index,\r\n            vm.fb.control({ value: '', disabled: true })\r\n          );\r\n        });\r\n\r\n        renameProjectMeasurements();\r\n      },\r\n      err => {\r\n        console.error(\"Error finding measurements for project:\", err);\r\n      }\r\n    );\r\n  }\r\n\r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      })\r\n    );\r\n  }\r\n  \r\n  // --- Group helper functions ---\r\n    function getProjectsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let projectsGroup = groups.find(g => g.name === 'Projects');\r\n          if (projectsGroup) {\r\n            return widgetContext.rxjs.of(projectsGroup);\r\n          } else {\r\n            projectsGroup = { type: 'ASSET', name: 'Projects', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(projectsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getMeasurementsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let measurementsGroup = groups.find(g => g.name === 'Measurements');\r\n          if (measurementsGroup) {\r\n            return widgetContext.rxjs.of(measurementsGroup);\r\n          } else {\r\n            measurementsGroup = { type: 'ASSET', name: 'Measurements', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(measurementsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getDiagnostickitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let kitsGroup = groups.find(g => g.name === 'Diagnostickits');\r\n          if (kitsGroup) {\r\n            return widgetContext.rxjs.of(kitsGroup);\r\n          } else {\r\n            kitsGroup = { type: 'ASSET', name: 'Diagnostickits', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(kitsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    // Modified getGatewaysGroup: Removed the type check\r\n    function getGatewaysGroup(customerId, updatedDevice) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let devicesGroup = groups.find(g => g.name === 'Gateways');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = { type: 'DEVICE', name: 'Gateways', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n    \r\n    function getDiagnostickitDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let devicesGroup = groups.find(g => g.name === 'Diagnostickit Devices');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = { type: 'DEVICE', name: 'Diagnostickit Devices', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    \r\n    function getUnassignedMeasurementDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let unassignedGroup = groups.find(g => g.name === 'Unassigned Measurement Devices');\r\n          if (unassignedGroup) {\r\n            return widgetContext.rxjs.of(unassignedGroup);\r\n          } else {\r\n            unassignedGroup = { type: 'DEVICE', name: 'Unassigned Measurement Devices', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(unassignedGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n  vm.save = function () {\r\n    let formValue = vm.transferKitFormGroup.value;\r\n    let selectedCustomer = formValue.customer;\r\n    if (!selectedCustomer || !selectedCustomer.id) {\r\n      console.warn('No customer selected.');\r\n      return;\r\n    }\r\n\r\n    if (!vm.customerShortName) {\r\n      vm.customerShortName = selectedCustomer.title;\r\n    }\r\n    let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n    let newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n\r\n    let saveObservables = [];\r\n    \r\n    let hasProjectMeasurements = vm.foundProject || (vm.projectMeasurements && vm.projectMeasurements.length > 0);\r\n    \r\n    let selectedKit = formValue.kit;\r\n    if (!selectedKit.name) {\r\n      console.warn(\"Selected kit has no name. Aborting save.\");\r\n      return;\r\n    }\r\n    let kitSave$ = assetService.saveAsset(selectedKit).pipe(\r\n      widgetContext.rxjs.switchMap(updatedKit => {\r\n        let kitEntity = updatedKit.id && updatedKit.id.entityType \r\n                          ? updatedKit.id \r\n                          : { id: updatedKit.id, entityType: 'ASSET' };\r\n        return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n            widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, kitEntity)),\r\n            // Always assign to Diagnostickits group\r\n            widgetContext.rxjs.switchMap(() => \r\n              getDiagnostickitsGroup(newOwner).pipe(\r\n                widgetContext.rxjs.switchMap(group => \r\n                  entityGroupService.addEntitiesToEntityGroup(group.id.id, [kitEntity.id])\r\n                )\r\n              )\r\n            ),\r\n            // If no project/measurements, also add to Unassigned Kit Group\r\n         );\r\n      })\r\n    );\r\n    saveObservables.push(kitSave$);\r\n\r\n    if (vm.foundProject) {\r\n      let project = vm.foundProject;\r\n      let candidate = vm.transferredProject && vm.transferredProject.trim();\r\n      if (!candidate) {\r\n        console.warn(\"Transferred project name was empty.\");\r\n        candidate = (vm.customerShortName || selectedCustomer.title) + '_Project_1';\r\n        formValue.transferredProject = candidate;\r\n        console.warn(\"Using fallback: \" + candidate);\r\n      }\r\n      project.name = candidate;\r\n      if (!project.type || project.type.trim() === \"\") {\r\n        project.type = \"Project\";\r\n      }\r\n      let projectSave$ = assetService.saveAsset(project).pipe(\r\n        widgetContext.rxjs.switchMap(updatedProject => {\r\n          let projectEntity = updatedProject.id && updatedProject.id.entityType \r\n                              ? updatedProject.id \r\n                              : { id: updatedProject.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, projectEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, projectEntity)),\r\n              widgetContext.rxjs.switchMap(() => getProjectsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(projectsGroup =>\r\n                entityGroupService.addEntitiesToEntityGroup(projectsGroup.id.id, [projectEntity.id])\r\n              )\r\n            );\r\n        })\r\n      );\r\n      saveObservables.push(projectSave$);\r\n    }\r\n\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n      let newMeasurementName = vm.transferKitFormGroup.get('transferredMeasurement' + index).value;\r\n      if (!newMeasurementName || newMeasurementName.trim() === \"\") {\r\n        console.warn(`New name for measurement at index ${index} is empty. Skipping update.`);\r\n        return;\r\n      }\r\n      measurement.name = newMeasurementName.trim();\r\n      let measurementSave$ = assetService.saveAsset(measurement).pipe(\r\n        widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n          let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType \r\n                                  ? updatedMeasurement.id \r\n                                  : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, measurementEntity)),\r\n              widgetContext.rxjs.switchMap(() => getMeasurementsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(measurementsGroup =>\r\n                entityGroupService.addEntitiesToEntityGroup(measurementsGroup.id.id, [measurementEntity.id])\r\n              )\r\n            );\r\n        })\r\n      );\r\n      saveObservables.push(measurementSave$);\r\n    });\r\n\r\n    // For each device, update its name with the value from the transferred device control.\r\n    // In the vm.save function, within the device update chain:\r\n    vm.allDevices.forEach((device, index) => {\r\n      let newDeviceName = vm.transferKitFormGroup.get('transferredDevice' + index).value;\r\n      if (!newDeviceName || newDeviceName.trim() === \"\") {\r\n        console.warn(`New name for device at index ${index} is empty. Skipping update.`);\r\n        return;\r\n      }\r\n      device.name = newDeviceName.trim();\r\n      let deviceSave$ = deviceService.saveDevice(device).pipe(\r\n        widgetContext.rxjs.switchMap(updatedDevice => {\r\n          let deviceEntity = updatedDevice.id && updatedDevice.id.entityType \r\n                             ? updatedDevice.id \r\n                             : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n          return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n            // Always assign to Diagnostickit Devices group\r\n            widgetContext.rxjs.switchMap(() => {\r\n              return getDiagnostickitDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(devicesGroup =>\r\n                    entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n            }\r\n            ),\r\n            // Conditionally assign to Gateways group if updatedDevice.type is 'RESI' or 'Gateway'\r\n            widgetContext.rxjs.switchMap(() => {\r\n              if (updatedDevice.type === 'RESI' || updatedDevice.type === 'Gateway') {\r\n                return getGatewaysGroup(newOwner, updatedDevice).pipe(\r\n                  widgetContext.rxjs.switchMap(devicesGroup =>\r\n                    entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n              } else {\r\n                return widgetContext.rxjs.of(null);\r\n              }\r\n            }),\r\n            // Additionally, if no project/measurements exist, assign to Unassigned Measurement Devices\r\n            widgetContext.rxjs.switchMap(() => {\r\n              if (!hasProjectMeasurements) {\r\n                return getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(group =>\r\n                    entityGroupService.addEntitiesToEntityGroup(group.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n              } else {\r\n                return widgetContext.rxjs.of(null);\r\n              }\r\n            })\r\n          );\r\n        })\r\n      );\r\n      saveObservables.push(deviceSave$);\r\n    });\r\n\r\n\r\n    widgetContext.rxjs.forkJoin(saveObservables).subscribe(\r\n      () => {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(formValue);\r\n      },\r\n      err => {\r\n        console.error('Error updating assets:', err);\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n}\r\n*/",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "act-transfer-kit"
              }
            ]
          },
          "pageSize": 1024,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "borderRadius": "8"
        },
        "row": 0,
        "col": 0,
        "id": "c6b19443-5057-176b-d3f8-2eebb67fc35e",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "d6393653-ccec-edf8-4bd7-520334011adb": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": false,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Diagnostic Kits",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "false",
            "displayEntityName": false,
            "entityNameColumnTitle": "Doktorkit ID",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "Label",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "Diagnostic Kit ID",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Diagnostic Kits",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "0d59106c-3aec-67d1-e5c6-1bea2904541b",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Diagnostic Kit ID",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.5282490591409559,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "kitType",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostic-kits.diagnostic-kit-type}",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "if(value==='basis'){\n    return 'Diagnostics Basis Kit';\n}\nif(value==='extension'){\n    return 'Diagnostics Extension Kit';\n}\nif(value==='loraWan'){\n    return 'Diagnostics LoRaWAN Kit';\n}",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.69568544537813,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "ownerName",
                  "type": "entityField",
                  "label": "Customer",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.8215491341579185,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "assignedTo",
                  "type": "attribute",
                  "label": "Assigned To",
                  "color": "#9c27b0",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "if(!value || value === '') {\n    return '<span style=\"color: #94a3b8;\">—</span>';\n}\nreturn value;",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5830868363386521,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastActivityTime",
                  "type": "attribute",
                  "label": "Last Activity / Status",
                  "color": "#9c27b0",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "// value = lastActivityTime (direct access, no label dependency)\nif (!value) {\n  return '<div style=\"width:fit-content;padding:4px 8px;border-radius:8px;line-height:20px;font-size:14px;font-weight:500;letter-spacing:0.25px;color:#808080;background-color:rgba(128,128,128,0.1)\">N/A</div>';\n}\n\nvar activityMs = typeof value === 'string' ? new Date(value).getTime() : Number(value);\nvar now = Date.now();\nvar diffMinutes = (now - activityMs) / 1000 / 60;\nvar isActive = diffMinutes < 5;\n\n// Format timestamp\nvar date = new Date(activityMs);\nvar pad = function(n) { return n.toString().padStart(2, '0'); };\nvar timestamp = date.getFullYear() + '-' + pad(date.getMonth()+1) + '-' + pad(date.getDate()) + ' ' + pad(date.getHours()) + ':' + pad(date.getMinutes());\n\nvar color = isActive ? '#27AE60' : '#FF0000';\nvar bgColor = isActive ? 'rgba(39,174,96,0.1)' : 'rgba(255,0,0,0.1)';\nvar status = isActive ? 'Active' : 'Inactive';\n\nreturn '<div style=\"display:flex;flex-direction:column;gap:2px;\">' +\n  '<div style=\"font-size:12px;color:#64748b;\">' + timestamp + '</div>' +\n  '<div style=\"width:fit-content;padding:2px 6px;border-radius:6px;font-size:12px;font-weight:500;color:' + color + ';background-color:' + bgColor + '\">' + status + '</div>' +\n'</div>';",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.06071069090279668,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "{i18n:custom.diagnostic-kits.open-devices}",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "92ce5e29-82ad-9f6e-51be-7bf3e7ae613d"
              }
            ],
            "actionCellButton": [
              {
                "name": "{i18n:custom.diagnostic-kits.edit-diagnostic-kit}",
                "icon": "edit",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole || '';\nvar isTenantAdmin = widgetContext.currentUser.authority === 'TENANT_ADMIN';\nvar isEcoAdmin = userRole === 'ECO Administrator';\nreturn isTenantAdmin || isEcoAdmin;",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"editEntityFormGroup\"\r\n      (ngSubmit)=\"save()\" \r\n      class=\"edit-entity-form max-w-3xl mx-auto\">\r\n    \r\n   <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n         <h2 class=\"text-lg font-semibold\">{{'custom.diagnostic-kits.edit-diagnostic-kit' | translate}}</h2>\r\n        <span class=\"flex-1\"></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n            <mat-icon>close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n    <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n\r\n        <!-- First row: Name-->\r\n        <div class=\"flex w-full gap-2\">\r\n\r\n            <!-- Name (Top-level form control) -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Diagnostic Kit Id</mat-label>\r\n                <input matInput \r\n                       formControlName=\"entityName\" \r\n                       required readonly>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('entityName')?.hasError('required')\">\r\n                  {{'custom.diagnostic-kits.diagnostic-kit-id-is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n\r\n            <!-- Label -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Label</mat-label>\r\n                <input matInput formControlName=\"label\" required>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('label')?.hasError('required')\">\r\n                  {{'custom.diagnostic-kits.label-is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n        </div>\r\n\r\n        <!-- Second row: kitType -->\r\n         <div class=\"flex w-full\">\r\n            <!-- HIDE Installation Type if measurementType is 'loraWan' -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\"\r\n                            *ngIf=\"editEntityFormGroup.get('attributes.measurementType')?.value !== 'loraWan'\"\r\n                            [formGroup]=\"editEntityFormGroup.controls['attributes']\">\r\n                <mat-label>{{'custom.diagnostic-kits.installation-type' | translate}}</mat-label>\r\n                <mat-select formControlName=\"kitType\" required>\r\n                     <mat-option value=\"basis\">Diagnostics Basis Kit</mat-option>\r\n                     <mat-option value=\"extension\">Diagnostics Extension Kit</mat-option>\r\n                     <mat-option value=\"loraWan\">Diagnostics LoRaWAN Kit</mat-option>\r\n                </mat-select>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('attributes.installationType')?.hasError('required')\">\r\n                  {{'custom.diagnostic-kits.diagnostic-kit-type-is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n        </div>\r\n    </div>\r\n\r\n    <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n        <button mat-button\r\n                color=\"primary\"\r\n                type=\"button\"\r\n                [disabled]=\"(isLoading$ | async)\"\r\n                (click)=\"cancel()\"\r\n                cdkFocusInitial>\r\n             {{'action.cancel' | translate}}\r\n        </button>\r\n        <button mat-button\r\n                mat-raised-button\r\n                color=\"primary\"\r\n                type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid\">\r\n            {{'action.save' | translate}}\r\n        </button>\r\n    </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\n\r\nopenEditEntityDialog();\r\n\r\nfunction openEditEntityDialog() {\r\n    customDialog.customDialog(htmlTemplate, EditEntityDialogController).subscribe();\r\n}\r\n\r\nfunction EditEntityDialogController(instance) {\r\n    let vm = instance;\r\n    vm.entityName = entityName; \r\n    vm.label = entityLabel; \r\n    vm.attributes = {};\r\n    vm.entity = {};\r\n\r\n    // Build the form group with a nested 'attributes' group\r\n    vm.editEntityFormGroup = vm.fb.group({\r\n        entityName: ['', [vm.validators.required]],\r\n        label: ['', [vm.validators.required]],\r\n        attributes: vm.fb.group({\r\n            kitType: [null]\r\n        })\r\n    });\r\n\r\n    getEntityInfo();\r\n\r\n    vm.cancel = function() {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function() {\r\n        // Mark the form as pristine right before saving\r\n        vm.editEntityFormGroup.markAsPristine();\r\n\r\n        // Save both entity main fields and attributes\r\n        widgetContext.rxjs.forkJoin([\r\n            saveAttributes(entityId),\r\n            saveEntity()\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n    function getEntityInfo() {\r\n        // Retrieve attributes + entity info in parallel\r\n        widgetContext.rxjs.forkJoin([\r\n            attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE'),\r\n            entityService.getEntity(entityId.entityType, entityId.id)\r\n        ]).subscribe(([attrData, entityData]) => {\r\n            vm.attributes = {};\r\n            // Populate vm.attributes from server response\r\n            for (let i = 0; i < attrData.length; i++) {\r\n                vm.attributes[attrData[i].key] = attrData[i].value;\r\n            }\r\n\r\n            vm.entity = entityData;\r\n\r\n            // Patch form values. \r\n            // Note that 'attributes' is a nested form group, so we pass an object for it.\r\n            vm.editEntityFormGroup.patchValue({\r\n                entityName: vm.entity.name,\r\n                label: vm.entity.label,\r\n                attributes: {\r\n                    kitType: vm.attributes.kitType\r\n                }\r\n            }, { emitEvent: false });\r\n        });\r\n    }\r\n\r\n    function saveEntity() {\r\n        const formValues = vm.editEntityFormGroup.value;\r\n        \r\n        // Always update name & label (ensures \"Save\" works even if no change)\r\n        vm.entity.name = formValues.entityName;\r\n        vm.entity.label = formValues.label;\r\n        /*console.log(\"enitity\",vm.entity);*/\r\n        return assetService.saveAsset(vm.entity);\r\n        \r\n        // If some other type, or no changes, return an observable that completes.\r\n        return widgetContext.rxjs.of([]);\r\n    }\r\n\r\n    function saveAttributes(entityId) {\r\n        // Compare original vs. new values to only send changed attributes\r\n        const currentAttributes = vm.attributes;\r\n        const updatedAttributes = vm.editEntityFormGroup.value.attributes;\r\n        \r\n        let attributesArray = [];\r\n        for (let key in updatedAttributes) {\r\n            if (updatedAttributes.hasOwnProperty(key)) {\r\n                if (updatedAttributes[key] !== currentAttributes[key]) {\r\n                    attributesArray.push({ key: key, value: updatedAttributes[key] });\r\n                }\r\n            }\r\n        }\r\n\r\n        if (attributesArray.length > 0) {\r\n            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n        }\r\n        return widgetContext.rxjs.of([]);\r\n    }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "4ba82627-39fc-7ac8-015e-8bb5184d8c82"
              },
              {
                "name": "Kit Devices",
                "icon": "devices",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole || '';\nvar isTenantAdmin = widgetContext.currentUser.authority === 'TENANT_ADMIN';\nvar isEcoAdmin = userRole === 'ECO Administrator';\n// Also visible for Administrators, Engineers\nvar isAdmin = userRole.includes('Administrator');\nvar isEngineer = userRole.includes('Engineer');\nreturn isTenantAdmin || isEcoAdmin || isAdmin || isEngineer;",
                "type": "custom",
                "id": "71c478b6-a4b1-e569-e99a-85d5562cc721",
                "customFunction": {
                  "body": "const kitId = entityId;\nconst kitName = entityName;\nkitDevicesPopup.openKitDevicesDialog(widgetContext, kitId, kitName);",
                  "modules": {
                    "kitDevicesPopup": "tb-resource;/api/resource/js_module/tenant/ECO Kit Devices Popup.js"
                  }
                }
              },
              {
                "name": "{i18n:custom.diagnostic-kits.next-delete-diagnostic-kit}",
                "icon": "delete",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole || '';\nvar isTenantAdmin = widgetContext.currentUser.authority === 'TENANT_ADMIN';\nvar isEcoAdmin = userRole === 'ECO Administrator';\nreturn isTenantAdmin || isEcoAdmin;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteDiagnostickitDialog();\n\nfunction openDeleteDiagnostickitDialog() {\n  let titleTranslation = translationService.instant(\n    'custom.diagnostic-kits.delete.title',\n    { entityName: entityName }\n  );\n\n  let contentTranslation = translationService.instant(\n    'custom.diagnostic-kits.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteDiagnostickit();\n    }\n  });\n}\n\nfunction deleteDiagnostickit() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteDiagnostickitToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Diagnostickit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Diagnostickit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDiagnostickitToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "338d9fd7-c752-eb0e-4687-2c2e32ca1a32"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:action.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n//params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "86c3f72e-d682-b95b-e997-3167fc8c83cd"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.add-diagnostic-kit}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "/*var userRole = widgetContext.stateController.getStateParams().userRole;\nif(userRole === 'ECO Administrator'){\n    return true;\n}else{\n    return false;\n}*/\nreturn false;",
                "type": "customPretty",
                "customHtml": "<!-- HTML Template for the \"Add Diagnostickit\" Dialog -->\r\n<form\r\n  #addEntityForm=\"ngForm\"\r\n  [formGroup]=\"addDiagnostickitFormGroup\"\r\n  (ngSubmit)=\"save()\"\r\n  class=\"add-entity-form max-w-3xl mx-auto\"\r\n  style=\"width: 350px;\"\r\n>\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.diagnostic-kits.add-diagnostic-kit' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar\r\n    color=\"warn\"\r\n    mode=\"indeterminate\"\r\n    *ngIf=\"isLoading$ | async\"\r\n  ></mat-progress-bar>\r\n\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <div class=\"flex flex-col gap-0 sm:gap-2\">\r\n      \r\n      <!-- Diagnostickit Name / ID -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>Diagnostickit ID</mat-label>\r\n        <input matInput formControlName=\"name\" required/>\r\n        <mat-error *ngIf=\"addDiagnostickitFormGroup.get('name').hasError('required')\">\r\n          {{ 'custom.diagnostic-kits.diagnostic-kit-id-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Label -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>Label</mat-label>\r\n        <input matInput formControlName=\"label\"/>\r\n        <mat-error *ngIf=\"addDiagnostickitFormGroup.get('label').hasError('required')\">\r\n          {{ 'custom.diagnostic-kits.label-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Diagnostic Kit Type -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.diagnostic-kits.diagnostic-kit-type' | translate }}</mat-label>\r\n        <mat-select formControlName=\"kitType\" required>\r\n          <mat-option value=\"basis\">Diagnostics Basis Kit</mat-option>\r\n          <!--<mat-option value=\"extension\">Diagnostics Extension Kit</mat-option>-->\r\n          <mat-option value=\"loraWan\">Diagnostics LoRaWAN Kit</mat-option>\r\n        </mat-select>\r\n        <mat-error *ngIf=\"addDiagnostickitFormGroup.get('kitType')?.hasError('required')\">\r\n          {{ 'custom.diagnostic-kits.diagnostic-kit-type-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button\r\n      mat-button\r\n      color=\"primary\"\r\n      type=\"button\"\r\n      [disabled]=\"(isLoading$ | async)\"\r\n      (click)=\"cancel()\"\r\n      cdkFocusInitial\r\n    >\r\n      {{ 'action.cancel' | translate }}\r\n    </button>\r\n    <button\r\n      mat-button\r\n      mat-raised-button\r\n      color=\"primary\"\r\n      type=\"submit\"\r\n      [disabled]=\"(isLoading$ | async)\"\r\n    >\r\n      {{ 'custom.diagnostic-kits.add-diagnostic-kit' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "// JS/Typescript Code\r\n\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nconst rxjs = widgetContext.rxjs;\r\nlet customerId;\r\nlet diagnostickitsAll = []; // Will store all Diagnostickits across customers\r\n\r\n// Determine which customer ID to use\r\nlet customerName = widgetContext.stateController.getStateParams().entityName;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n    customerId = widgetContext.stateController.getStateParams().entityId;\r\n} else {\r\n    customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n}\r\n\r\n// Page link to fetch customers\r\nconst pageLink = widgetContext.pageLink(100, 0, null, null); // PageSize: 100, PageNumber: 0\r\n\r\n// Fetch all customers, then fetch all their Diagnostickits\r\n/*customerService.getCustomers(pageLink).subscribe(customers => {\r\n  //console.log(\"customers:\", customers);\r\n\r\n  // Track how many customer queries have completed\r\n  let processed = 0;\r\n  const totalCustomers = customers.data.length;\r\n\r\n  customers.data.map(customer => {\r\n    // Build our query for this specific customer's ID\r\n    const assetSearchQuery = {\r\n      parameters: {\r\n        rootId: customer.id.id,       \r\n        rootType: 'CUSTOMER',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Diagnostickit']\r\n    };\r\n\r\n    assetService.findByQuery(assetSearchQuery).subscribe(diagnostickits => {\r\n      //console.log(\"diagnostickits of customer:\", customer.name, diagnostickits);    \r\n      // Merge these Diagnostickits into our master array\r\n      diagnostickitsAll.push(...diagnostickits);\r\n\r\n      // Increment the processed counter\r\n      processed++;\r\n      // If we've processed all customers, open the dialog\r\n      if (processed === totalCustomers) {\r\n        //console.log('All Diagnostickits across all customers:', diagnostickitsAll);\r\n        openAddDiagnostickitDialog(diagnostickitsAll);\r\n      }\r\n    });\r\n  });\r\n});*/\r\nopenAddDiagnostickitDialog(diagnostickitsAll);\r\n// Opens the custom dialog, passing in the collected diagnostickitsAll\r\nfunction openAddDiagnostickitDialog(diagnostickitsAll) {\r\n  customDialog.customDialog(htmlTemplate, AddDiagnostickitDialogController, { diagnostickitsAll }).subscribe();\r\n}\r\n\r\n// The Dialog Controller\r\nfunction AddDiagnostickitDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  // We have access to diagnostickitsAll via instance.data\r\n  vm.diagnostickitsAll = instance.data.diagnostickitsAll || [];\r\n\r\n  // Reactive form definition\r\n  vm.addDiagnostickitFormGroup = vm.fb.group({\r\n    name: [null, [vm.validators.required]],\r\n    label: [null],\r\n    kitType: ['basis', [vm.validators.required]]\r\n  });\r\n\r\n /*function generateDiagnostickitName(kitType) {\r\n  // Current 2-digit year\r\n  const year = (new Date().getFullYear() % 100).toString().padStart(2, '0');\r\n\r\n  // Determine the prefix for the *new* kit\r\n  const prefix = kitType === 'basis' ? 'DBKIT' : 'DEKIT';\r\n\r\n  // Single pattern to match either DBKIT or DEKIT, ignoring the year for the counter\r\n  // Explanation:\r\n  //   ^D(B|E)KIT         => Must start with DBKIT or DEKIT\r\n  //   \\d{2}             => Then two digits (the year)\r\n  //   EU-               => Then 'EU-'\r\n  //   (\\d{4})           => Capture the 4-digit counter\r\n  const pattern = /^D(B|E)KIT\\d{2}EU-(\\d{4})$/;\r\n\r\n  let maxNumber = 0;\r\n\r\n  // Find the max counter among all kits that match DBKITyyEU-#### or DEKITyyEU-####\r\n  vm.diagnostickitsAll.forEach(d => {\r\n    const match = d.name.match(pattern);\r\n    if (match) {\r\n      // match[2] should contain the 4-digit counter\r\n      const currentNum = parseInt(match[2], 10);\r\n      if (currentNum > maxNumber) {\r\n        maxNumber = currentNum;\r\n      }\r\n    }\r\n  });\r\n\r\n  // Next counter (increment by 1)\r\n  const nextNumber = (maxNumber + 1).toString().padStart(4, '0');\r\n\r\n  // Construct new name with correct prefix, current year, and the incremented counter\r\n  return `${prefix}${year}EU-${nextNumber}`;\r\n}*/\r\n\r\n\r\n\r\n  // Whenever the kitType changes, regenerate the name\r\n  /*vm.addDiagnostickitFormGroup.get('kitType').valueChanges.subscribe((newKitType) => {\r\n    const newName = generateDiagnostickitName(newKitType);\r\n    vm.addDiagnostickitFormGroup.patchValue(\r\n      { name: newName },\r\n      { emitEvent: false } // avoid infinite loop\r\n    );\r\n  });*/\r\n\r\n  // Initialize the name based on the default kitType ('basis')\r\n  /*vm.addDiagnostickitFormGroup.patchValue({\r\n    name: generateDiagnostickitName(vm.addDiagnostickitFormGroup.get('kitType').value)\r\n  }, { emitEvent: false });*/\r\n\r\n  // Cancel / close the dialog\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  // Save action\r\n  vm.save = function () {\r\n    const stateParams = widgetContext.stateController.getStateParams();\r\n    var projectId, measurementId;\r\n\r\n    projectId = {\r\n      id: (stateParams.selectedProject && stateParams.selectedProject.entityId && stateParams.selectedProject.entityId.id)\r\n        ? stateParams.selectedProject.entityId.id\r\n        : '',\r\n      entityType: 'ASSET'\r\n    };\r\n\r\n    measurementId = {\r\n      id: (stateParams.selectedMeasurement && stateParams.selectedMeasurement.entityId && stateParams.selectedMeasurement.entityId.id)\r\n        ? stateParams.selectedMeasurement.entityId.id\r\n        : '',\r\n      entityType: 'ASSET'\r\n    };\r\n    \r\n    let localCustomerId;\r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        localCustomerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        localCustomerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n\r\n    vm.addDiagnostickitFormGroup.markAsPristine();\r\n\r\n    // Save the Diagnostickit asset, then link it\r\n    saveDiagnostickitObservable(localCustomerId).subscribe(\r\n      function (Diagnostickit) {\r\n        const observables = [\r\n          saveCustomerToDiagnostickitRelation(localCustomerId, Diagnostickit.id),\r\n          saveAttributes(Diagnostickit.id)\r\n        ];\r\n\r\n        // If there's a selected project, relate it\r\n        if(projectId.id !== \"\"){\r\n            observables.push(saveProjectToDiagnostickitRelation(projectId, Diagnostickit.id));\r\n        }\r\n        // If there's a selected measurement, relate it\r\n        if(measurementId.id !== \"\"){\r\n            observables.push(saveMeasurementToDiagnostickitRelation(measurementId, Diagnostickit.id));\r\n        }\r\n\r\n        widgetContext.rxjs.forkJoin(observables).subscribe(\r\n          function () {\r\n            var params = widgetContext.stateController.getStateParams();\r\n            // Update selectedDiagnostickit in state params\r\n            params['selectedDiagnostickit'] = {\r\n              entityId: Diagnostickit.id,\r\n              entityName: Diagnostickit.name\r\n            };\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n          }\r\n        );\r\n      }\r\n    );\r\n  };\r\n\r\n  // -------------- Helper Functions -------------- //\r\n\r\n  // Save Diagnostickit asset inside the 'Diagnostickits' group and also add it to 'Unassigned Kit' group\r\n  function saveDiagnostickitObservable(customerId) {\r\n    return getDiagnostickitsGroup(customerId).pipe(\r\n      widgetContext.rxjs.switchMap((DiagnostickitsGroup) => {\r\n        return getUnassignedKitGroup(customerId).pipe(\r\n          widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\r\n            const formValues = vm.addDiagnostickitFormGroup.value;\r\n            const Diagnostickit = {\r\n              name: formValues.name,\r\n              label: formValues.label,\r\n              type: 'Diagnostickit',\r\n              customerId: customerId\r\n            };\r\n\r\n            return assetService.saveAsset(Diagnostickit, DiagnostickitsGroup.id.id).pipe(\r\n              widgetContext.rxjs.switchMap((savedAsset) => {\r\n                // Add the new Diagnostickit to the \"Unassigned Kit\" group\r\n                return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, savedAsset.id.id).pipe(\r\n                  widgetContext.rxjs.map(() => {\r\n                    return savedAsset; \r\n                  })\r\n                );\r\n              })\r\n            );\r\n          })\r\n        );\r\n      })\r\n    );\r\n  }\r\n\r\n  // Get or create the \"Diagnostickits\" group\r\n  function getDiagnostickitsGroup(customerId) {\r\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n      widgetContext.rxjs.switchMap((entityGroups) => {\r\n        var DiagnostickitsGroup = entityGroups.find(group => group.name === 'Diagnostickits');\r\n        if (DiagnostickitsGroup) {\r\n          return widgetContext.rxjs.of(DiagnostickitsGroup);\r\n        } else {\r\n          DiagnostickitsGroup = {\r\n            type: 'ASSET',\r\n            name: 'Diagnostickits',\r\n            ownerId: customerId\r\n          };\r\n          return entityGroupService.saveEntityGroup(DiagnostickitsGroup);\r\n        }\r\n      })\r\n    );\r\n  }\r\n\r\n  // Get or create the \"Unassigned Kit\" group\r\n  function getUnassignedKitGroup(customerId) {\r\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n      widgetContext.rxjs.switchMap((entityGroups) => {\r\n        var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n        if (UnassignedKitGroup) {\r\n          return widgetContext.rxjs.of(UnassignedKitGroup);\r\n        } else {\r\n          UnassignedKitGroup = {\r\n            type: 'ASSET',\r\n            name: 'Unassigned Kit',\r\n            ownerId: customerId\r\n          };\r\n          return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n        }\r\n      })\r\n    );\r\n  }\r\n\r\n  // Create relation: Customer -> Diagnostickit\r\n  function saveCustomerToDiagnostickitRelation(customerId, DiagnostickitId) {\r\n    var relation = {\r\n      from: customerId,\r\n      to: DiagnostickitId,\r\n      typeGroup: 'COMMON',\r\n      type: 'Owns'\r\n    };\r\n    return entityRelationService.saveRelation(relation);\r\n  }\r\n\r\n  // Create relation: Project -> Diagnostickit\r\n  function saveProjectToDiagnostickitRelation(projectId, DiagnostickitId) {\r\n    var relation = {\r\n      from: projectId,\r\n      to: DiagnostickitId,\r\n      typeGroup: 'COMMON',\r\n      type: 'Owns'\r\n    };\r\n    return entityRelationService.saveRelation(relation);\r\n  }\r\n\r\n  // Create relation: Measurement -> Diagnostickit\r\n  function saveMeasurementToDiagnostickitRelation(measurementId, DiagnostickitId) {\r\n    var relation = {\r\n      from: measurementId,\r\n      to: DiagnostickitId,\r\n      typeGroup: 'COMMON',\r\n      type: 'Owns'\r\n    };\r\n    return entityRelationService.saveRelation(relation);\r\n  }\r\n\r\n  // Save attributes for the newly created Diagnostickit\r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n      {\r\n        key: 'state',\r\n        value: 'normal'\r\n      },\r\n      {\r\n        key: 'kitType',\r\n        value: vm.addDiagnostickitFormGroup.get('kitType').value\r\n      }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e965b8a1-a6ac-5ae4-fd79-2b7220b91ed1"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.transfer-kit}",
                "buttonType": "icon",
                "icon": "mdi:swap-horizontal",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "//var userRole = widgetContext.stateController.getStateParams().userRole;\n//return userRole === 'ECO Administrator';\nreturn false;",
                "type": "customPretty",
                "customHtml": "<form #transferKitForm=\"ngForm\" [formGroup]=\"transferKitFormGroup\" (ngSubmit)=\"save()\" class=\"transferKitFormGroup max-w-3xl mx-auto\" style=\"width: 800px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.diagnostic-kits.transfer-kit' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n   <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n      <mat-label>Kit</mat-label>\r\n      <mat-select formControlName=\"kit\" required (selectionChange)=\"onKitSelected($event)\">\r\n        <mat-option *ngFor=\"let kit of kits\" [value]=\"kit\">\r\n          {{ kit.name }}\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"transferKitFormGroup.get('kit')?.hasError('required')\">\r\n        {{ 'custom.diagnostic-kits.kit-is-required' | translate }}\r\n      </mat-error>\r\n    </mat-form-field>\r\n    \r\n    <div class=\"flex justify-center items-center\" style=\"padding-bottom: 10px;\">\r\n      <mat-icon>arrow_downward</mat-icon>\r\n    </div>\r\n\r\n   <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n      <mat-label>{{ 'custom.diagnostic-kits.customer' | translate }}</mat-label>\r\n      <mat-select formControlName=\"customer\" required (selectionChange)=\"onCustomerSelected($event)\">\r\n        <mat-option *ngFor=\"let cust of customers\" [value]=\"cust\">\r\n          {{ cust.title }}\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"transferKitFormGroup.get('customer')?.hasError('required')\">\r\n        {{ 'custom.diagnostic-kits.customer-is-required' | translate }}\r\n      </mat-error>\r\n    </mat-form-field>\r\n    \r\n    <div *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" class=\"flex justify-center items-center pb-5\">\r\n      <mat-icon>arrow_downward</mat-icon>\r\n    </div>\r\n      \r\n    <fieldset *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" class=\"fieldset\" style=\"margin-bottom: 16px;\">\r\n      <div class=\"flex flex-row justify-start items-center py-2.5\">\r\n        <div style=\"width: 40px; display: flex; justify-content: center; align-items: center;\">\r\n          <mat-icon>info</mat-icon>\r\n        </div>\r\n        <div class=\"flex-1\">\r\n          <p style=\"font-size: 15px; margin: 0;\">\r\n            {{ 'custom.diagnostic-kits.kit-has-assigned-measurement-warning' | translate }}\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </fieldset>\r\n    \r\n    <div *ngIf=\"foundProject\" class=\"flex justify-start items-center\" style=\"margin-top:10px;\">\r\n      <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n        <mat-label>{{ 'custom.diagnostic-kits.found-project' | translate }}</mat-label>\r\n        <input matInput formControlName=\"foundProject\" readonly>\r\n      </mat-form-field>\r\n      \r\n      <div style=\"padding: 0 10px;\">\r\n        <mat-icon>arrow_right_alt</mat-icon>\r\n      </div>\r\n      \r\n      <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n        <mat-label>{{ 'custom.diagnostic-kits.transferred-project' | translate }}Transferred Project</mat-label>\r\n        <input matInput formControlName=\"transferredProject\" readonly>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" style=\"margin-top:10px;\">\r\n      <div *ngFor=\"let measurement of projectMeasurements; let i = index\" class=\"flex flex-row justify-start items-center\" style=\"margin-bottom:8px;\">\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.found-measurement' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'measurement' + i\" readonly>\r\n        </mat-form-field>\r\n        <div style=\"padding: 0 10px;\">\r\n          <mat-icon>arrow_right_alt</mat-icon>\r\n        </div>\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.transferred-measurement' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'transferredMeasurement' + i\" readonly>\r\n        </mat-form-field>\r\n      </div>\r\n    </div>\r\n\r\n    <div *ngIf=\"allDevices && allDevices.length > 0\" style=\"margin-top:10px;\">\r\n      <div *ngFor=\"let device of allDevices; let i = index\" class=\"flex flex-row justify-start items-center\" style=\"margin-bottom:8px;\">\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.found-device' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'device' + i\" readonly>\r\n        </mat-form-field>\r\n        <div style=\"padding: 0 10px;\">\r\n          <mat-icon>arrow_right_alt</mat-icon>\r\n        </div>\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.transferred-device' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'transferredDevice' + i\" readonly>\r\n        </mat-form-field>\r\n      </div>\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">{{ 'action.cancel' | translate }}</button>\r\n    <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"transferKitFormGroup.invalid\">\r\n      {{ 'action.save' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.transferKitFormGroup .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.transferKitFormGroup .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.transferKitFormGroup\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.transferKitFormGroup\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet dialogs = injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\nlet customerId, customer;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet pageLink = {\r\n  pageSize: 100, page: 0, textSearch: '', sortOrder: 'ASC', sortProperty: 'title',\r\n  toQuery: function () {\r\n    let q = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) q += '&textSearch=' + encodeURIComponent(this.textSearch);\r\n    if (this.sortProperty) q += '&sortProperty=' + encodeURIComponent(this.sortProperty);\r\n    if (this.sortOrder) q += '&sortOrder=' + encodeURIComponent(this.sortOrder);\r\n    return q;\r\n  }\r\n};\r\n\r\nlet kits = [];\r\nlet customers = [];\r\nlet kitsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (kitsLoaded && customersLoaded) openTransferKitDialog(kits, customers);\r\n}\r\n\r\nlet kitSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id, rootType: 'CUSTOMER', direction: 'FROM',\r\n    relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Diagnostickit']\r\n};\r\n\r\nassetService.findByQuery(kitSearchQuery).subscribe(\r\n  result => { kits = result; kitsLoaded = true; checkAndOpenDialog(); },\r\n  () => { kits = []; kitsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\n// NOTE: credentials come from your original snippet\r\nlet bearerToken = '';\r\nfetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n  method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n  body: JSON.stringify({ \"username\": \"belimo.api@pke-iot.expert\", \"password\": \"vfx3cvr@VMJ3bxk3urg\" })\r\n})\r\n  .then(resp => resp.json())\r\n  .then(loginData => {\r\n    bearerToken = loginData.token;\r\n    return fetch('https://cloud.pke-iot.expert/api/customers?pageSize=100&page=0', {\r\n      method: 'GET',\r\n      headers: { 'accept': 'application/json', 'X-Authorization': 'Bearer ' + bearerToken }\r\n    });\r\n  })\r\n  .then(resp2 => resp2.json())\r\n  .then(customersList => {\r\n    customers = customersList.data;\r\n    if (customer) customers = customers.filter(cust => cust.title !== customer);\r\n    customersLoaded = true; checkAndOpenDialog();\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching customers:\", error);\r\n    alert('Failed to fetch customers.');\r\n  });\r\n\r\nfunction openTransferKitDialog(kits, customers) {\r\n  customDialog.customDialog(htmlTemplate, TransferKitDialogController, { kits, customers }).subscribe();\r\n}\r\n\r\nfunction TransferKitDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.kits = data.kits || [];\r\n  vm.customers = data.customers || [];\r\n\r\n  vm.transferKitFormGroup = vm.fb.group({\r\n    kit: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n  vm.transferKitFormGroup.addControl('transferredProject', vm.fb.control({ value: '', disabled: true }));\r\n\r\n  vm.allDevices = [];\r\n  vm.devicesWithMeasurements = [];\r\n  vm.foundProject = null;\r\n  vm.projectMeasurements = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n     vm.measurementRenameMap = new Map();\r\n\r\n\r\n  const groupCache = new Map(); // key: ownerId|scope|name -> Observable(group)\r\n  function ensureGroup(ownerIdObj, scopeType, name) {\r\n    const key = ownerIdObj.id + '|' + scopeType + '|' + name;\r\n    if (groupCache.has(key)) return groupCache.get(key);\r\n\r\n    const obs = entityGroupService.getEntityGroupsByOwnerId(ownerIdObj.entityType, ownerIdObj.id, scopeType).pipe(\r\n      widgetContext.rxjs.switchMap(groups => {\r\n        let g = (groups || []).find(x => x.name === name);\r\n        if (g) return widgetContext.rxjs.of(g);\r\n        const payload = { type: scopeType, name, ownerId: ownerIdObj };\r\n        return entityGroupService.saveEntityGroup(payload).pipe(\r\n          // If backend races and says \"already exists\", re-fetch once\r\n          widgetContext.rxjs.catchError(err => {\r\n            if (err && err.status === 400) {\r\n              return entityGroupService.getEntityGroupsByOwnerId(ownerIdObj.entityType, ownerIdObj.id, scopeType).pipe(\r\n                widgetContext.rxjs.map(gs => (gs || []).find(x => x.name === name))\r\n              );\r\n            }\r\n            return widgetContext.rxjs.throwError(err);\r\n          })\r\n        );\r\n      }),\r\n      widgetContext.rxjs.shareReplay(1)\r\n    );\r\n    groupCache.set(key, obs);\r\n    return obs;\r\n  }\r\n\r\n  function addToGroupSafe(groupId, entityId) {\r\n    return entityGroupService.addEntitiesToEntityGroup(groupId, [entityId]).pipe(\r\n      widgetContext.rxjs.catchError(err => {\r\n        // tolerate duplicate-membership/409/400 responses\r\n        return widgetContext.rxjs.of(null);\r\n      })\r\n    );\r\n  }\r\n\r\n  function getProjectsGroup(owner)                { return ensureGroup(owner, 'ASSET',  'Projects'); }\r\n  function getMeasurementsGroup(owner)            { return ensureGroup(owner, 'ASSET',  'Measurements'); }\r\n  function getDiagnostickitsGroup(owner)          { return ensureGroup(owner, 'ASSET',  'Diagnostickits'); }\r\n  function getGatewaysGroup(owner)                { return ensureGroup(owner, 'DEVICE', 'Gateways'); }\r\n  function getDiagnostickitDevicesGroup(owner)    { return ensureGroup(owner, 'DEVICE', 'Diagnostickit Devices'); }\r\n  function getUnassignedMeasurementDevicesGroup(owner) { return ensureGroup(owner, 'DEVICE', 'Unassigned Measurement Devices'); }\r\n\r\n  vm.transferKitFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId, rootType: 'CUSTOMER', direction: 'FROM',\r\n          relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { vm.transferredProject = null; vm.customerShortName = null; }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null; vm.customerShortName = null;\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        if (vm.transferKitFormGroup.get('transferredMeasurement' + index)) {\r\n          vm.transferKitFormGroup.get('transferredMeasurement' + index).setValue('');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  vm.onKitSelected = function (event) {\r\n    let selectedKit = event.value;\r\n    vm.allDevices = [];\r\n    vm.devicesWithMeasurements = [];\r\n    vm.foundProject = null;\r\n    vm.projectMeasurements = [];\r\n\r\n    Object.keys(vm.transferKitFormGroup.controls)\r\n      .filter(n => n.startsWith('measurement') || n.startsWith('transferredMeasurement') || n.startsWith('device') || n.startsWith('transferredDevice'))\r\n      .forEach(n => vm.transferKitFormGroup.removeControl(n));\r\n    \r\n    let selectedCustomer = vm.transferKitFormGroup.get('customer').value;\r\n    if (!selectedKit || !selectedCustomer) {\r\n      console.warn(\"Kit or customer not selected yet.\");\r\n      return;\r\n    }\r\n    \r\n    let selectedKitId = selectedKit.id.id ? selectedKit.id.id : selectedKit.id;\r\n\r\n    let deviceSearchQuery = {\r\n      parameters: {\r\n        rootId: selectedKitId, rootType: 'ASSET', direction: 'FROM',\r\n        relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: true\r\n      },\r\n      relationType: 'Contains',\r\n      deviceTypes: ['P-Flow D116','Room Sensor CO2','Temperature Sensor','RESI','Gateway','LTE Status']\r\n    };\r\n    \r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n      devices => {\r\n        vm.allDevices = devices || [];\r\n        if (vm.allDevices.length === 0) return;\r\n\r\n        vm.allDevices.forEach((device, index) => {\r\n          vm.transferKitFormGroup.addControl('device' + index, vm.fb.control({ value: device.name, disabled: true }));\r\n          vm.transferKitFormGroup.addControl('transferredDevice' + index, vm.fb.control({ value: device.name, disabled: true }));\r\n        });\r\n\r\n        let measurementChecks = vm.allDevices.map(device => {\r\n          let measurementQuery = {\r\n            parameters: {\r\n              rootId: (device.id.id ? device.id.id : device.id), rootType: 'DEVICE', direction: 'TO',\r\n              relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: false\r\n            },\r\n            relationType: 'Measurement',\r\n            assetTypes: ['Measurement']\r\n          };\r\n          return assetService.findByQuery(measurementQuery).pipe(\r\n            widgetContext.rxjs.map(measurements => ({ device, measurements: measurements || [] }))\r\n          );\r\n        });\r\n\r\n        widgetContext.rxjs.forkJoin(measurementChecks).subscribe(\r\n          measurementResults => {\r\n            vm.devicesWithMeasurements = measurementResults.filter(r => r.measurements.length > 0);\r\n            let projectChecks = [];\r\n            vm.devicesWithMeasurements.forEach(item => {\r\n              item.measurements.forEach(meas => {\r\n                let projectQuery = {\r\n                  parameters: {\r\n                    rootId: (meas.id.id ? meas.id.id : meas.id), rootType: 'ASSET', direction: 'TO',\r\n                    relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: 'Owns',\r\n                  assetTypes: ['Project']\r\n                };\r\n                projectChecks.push(assetService.findByQuery(projectQuery).pipe(\r\n                  widgetContext.rxjs.map(projects => ({ measurement: meas, projects: projects || [] }))\r\n                ));\r\n              });\r\n            });\r\n            if (projectChecks.length === 0) return;\r\n\r\n            widgetContext.rxjs.forkJoin(projectChecks).subscribe(\r\n              projectResults => {\r\n                let found = projectResults.find(r => r.projects.length > 0);\r\n                if (found) {\r\n                  vm.foundProject = found.projects[0];\r\n                  if (!vm.transferKitFormGroup.get('foundProject')) {\r\n                    vm.transferKitFormGroup.addControl('foundProject', vm.fb.control({ value: vm.foundProject.name, disabled: true }));\r\n                  } else {\r\n                    vm.transferKitFormGroup.get('foundProject').setValue(vm.foundProject.name);\r\n                  }\r\n                  searchMeasurementsForProject(vm.foundProject);\r\n                }\r\n              },\r\n              err => console.error(\"Error during project queries:\", err)\r\n            );\r\n          },\r\n          err => console.error(\"Error in measurement checks:\", err)\r\n        );\r\n      },\r\n      err => console.error(\"Error finding devices for kit:\", err)\r\n    );\r\n  };\r\n\r\n  vm.onCustomerSelected = function () {\r\n    let kit = vm.transferKitFormGroup.get('kit').value;\r\n    if (kit) vm.onKitSelected({ value: kit });\r\n  };\r\n\r\n  function updateFoundProjectName(customerShortName, existingProjects) {\r\n    if (!customerShortName) return;\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) { maxNumericSuffix = parsedNum; }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    vm.transferredProject = candidate;\r\n    vm.transferKitFormGroup.get('transferredProject').setValue(candidate);\r\n  }\r\n\r\n  function renameProjectMeasurements() {\r\n    if (!vm.customerShortName) return;\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n      let newProjectNameCtrl = vm.transferKitFormGroup.get('transferredProject');\r\n      let oldName = measurement.name;\r\n      let parts = oldName.split('_');\r\n      let newName = newProjectNameCtrl.value + '_' + parts[2];\r\n      let control = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n      if (control) control.setValue(newName);\r\n    });\r\n  }\r\n\r\n  function searchMeasurementsForProject(project) {\r\n    let projectId = project.id.id ? project.id.id : project.id;\r\n    let projectMeasurementQuery = {\r\n      parameters: {\r\n        rootId: projectId, rootType: 'ASSET', direction: 'FROM',\r\n        relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Measurement']\r\n    };\r\n    assetService.findByQuery(projectMeasurementQuery).subscribe(\r\n      measurements => {\r\n        vm.projectMeasurements = measurements || [];\r\n        Object.keys(vm.transferKitFormGroup.controls)\r\n          .filter(n => n.startsWith('measurement') || n.startsWith('transferredMeasurement'))\r\n          .forEach(n => vm.transferKitFormGroup.removeControl(n));\r\n        (measurements || []).forEach((measurement, index) => {\r\n          vm.transferKitFormGroup.addControl('measurement' + index, vm.fb.control({ value: measurement.name, disabled: true }));\r\n          vm.transferKitFormGroup.addControl('transferredMeasurement' + index, vm.fb.control({ value: '', disabled: true }));\r\n        });\r\n        renameProjectMeasurements();\r\n      },\r\n      err => console.error(\"Error finding measurements for project:\", err)\r\n    );\r\n  }\r\n\r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      }),\r\n      widgetContext.rxjs.catchError(() => widgetContext.rxjs.of(null)) // tolerate if old relation missing\r\n    );\r\n  }\r\n\r\n  function getVrDevicesForDevice(deviceId) {\r\n    return entityRelationService.findByTo({ id: deviceId, entityType: 'DEVICE' }).pipe(\r\n      widgetContext.rxjs.map(rels =>\r\n        (rels || [])\r\n          .filter(r => r.typeGroup === 'COMMON' && r.type === 'VR' && r.from?.entityType === 'DEVICE')\r\n          .map(r => (r.from.id.id ? r.from.id.id : r.from.id)) // return VR device UUIDs\r\n      )\r\n    );\r\n  }\r\n\r\n  function computeNewVrName(oldVrName) {\r\n      const original = (oldVrName || '').trim();\r\n      if (!original) { \r\n        console.debug('[VR Rename] Empty VR name; skip');\r\n        return null;\r\n      }\r\n    \r\n      // 1) Primary: precise map-based rename (oldMeasName or oldMeasName_)\r\n      if (vm.measurementRenameMap && vm.measurementRenameMap.size > 0) {\r\n        const entries = Array.from(vm.measurementRenameMap.entries())\r\n          .sort((a, b) => b[0].length - a[0].length); // longest first\r\n    \r\n        for (const [oldMeasNameRaw, newMeasNameRaw] of entries) {\r\n          const oldMeas = String(oldMeasNameRaw || '').trim();\r\n          const newMeas = String(newMeasNameRaw || '').trim();\r\n          if (!oldMeas || !newMeas) continue;\r\n    \r\n          // exact match\r\n          if (original === oldMeas) {\r\n            const renamed = newMeas;\r\n            console.debug('[VR Rename] Exact match:', { original, oldMeas, newMeas, renamed });\r\n            return renamed;\r\n          }\r\n          // prefix match \"<oldMeas>_<suffix>\"\r\n          const prefix = oldMeas + '_';\r\n          if (original.startsWith(prefix)) {\r\n            const suffix = original.substring(prefix.length);\r\n            const renamed = newMeas + '_' + suffix;\r\n            console.debug('[VR Rename] Prefix match:', { original, oldMeas, newMeas, suffix, renamed });\r\n            return renamed;\r\n          }\r\n        }\r\n      } else {\r\n        console.debug('[VR Rename] Empty measurementRenameMap; will try ECO fallback for', original);\r\n      }\r\n    \r\n      // 2) Fallback: if we can’t match the old measurement name, but there is exactly ONE new measurement name,\r\n      //    replace everything BEFORE \"_ECO_\" with that name.\r\n      //    This gives:  \"<anything>_ECO_...\" -> \"<singleNewMeas>_ECO_...\"\r\n      const newNames = vm.measurementRenameMap ? Array.from(vm.measurementRenameMap.values()).map(v => String(v || '').trim()).filter(Boolean) : [];\r\n      if (newNames.length === 1) {\r\n        const soleNew = newNames[0];\r\n        // Typical delimiter in your VR naming: \"_ECO_\"\r\n        const ecoIdx = original.indexOf('_ECO_');\r\n        if (ecoIdx > 0) {\r\n          const suffixFromEco = original.substring(ecoIdx + 1); // keep \"ECO_...\"\r\n          const renamed = soleNew + '_' + suffixFromEco;\r\n          console.debug('[VR Rename] Fallback via _ECO_:',\r\n            { original, soleNew, suffixFromEco, renamed });\r\n          return renamed;\r\n        }\r\n        // If \"_ECO_\" is not present, as a safer generic fallback: replace up to the 3rd underscore (common in \"X_Y_Z_...\")\r\n        const parts = original.split('_');\r\n        if (parts.length >= 3) {\r\n          const suffix = parts.slice(3).join('_'); // keep everything after first 3 segments\r\n          const renamed = suffix ? (soleNew + '_' + suffix) : soleNew;\r\n          console.debug('[VR Rename] Fallback via 3-seg prefix:',\r\n            { original, soleNew, suffix, renamed });\r\n          return renamed;\r\n        }\r\n      }\r\n    \r\n      console.debug('[VR Rename] No matching rule for', original);\r\n      return null; // no rename\r\n    }\r\n\r\n\r\n\r\n\r\n  function transferVrDevice(vrDeviceId, newOwner, hasProjectMeasurements) {\r\n    return deviceService.getDevice(vrDeviceId).pipe(\r\n      widgetContext.rxjs.switchMap(vr => {\r\n        const maybeNewName = computeNewVrName(vr.name);\r\n        if (maybeNewName && maybeNewName !== vr.name) vr.name = maybeNewName;\r\n        return deviceService.saveDevice(vr).pipe(\r\n          widgetContext.rxjs.switchMap(updatedVr => {\r\n            const vrEntity = updatedVr.id && updatedVr.id.entityType\r\n              ? updatedVr.id\r\n              : { id: updatedVr.id, entityType: 'DEVICE' };\r\n\r\n            return entityGroupService.changeEntityOwner(newOwner, vrEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() =>\r\n                (updatedVr.type === 'Gateway VR')\r\n                  ? getGatewaysGroup(newOwner).pipe(\r\n                      widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, vrEntity.id))\r\n                    )\r\n                  : widgetContext.rxjs.of(null)\r\n              ),\r\n              widgetContext.rxjs.switchMap(() =>\r\n                (!hasProjectMeasurements)\r\n                  ? getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                      widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, vrEntity.id))\r\n                    )\r\n                  : widgetContext.rxjs.of(null)\r\n              )\r\n            );\r\n\r\n          })\r\n        );\r\n      })\r\n    );\r\n  }\r\n\r\n  function transferVrsForPhysicalDevice(physicalDeviceId, newOwner, hasProjectMeasurements) {\r\n    return getVrDevicesForDevice(physicalDeviceId).pipe(\r\n      widgetContext.rxjs.switchMap(vrIds => {\r\n        if (!vrIds || vrIds.length === 0) return widgetContext.rxjs.of(null);\r\n        const ops = vrIds.map(vrId => transferVrDevice(vrId, newOwner, hasProjectMeasurements));\r\n        return widgetContext.rxjs.forkJoin(ops);\r\n      })\r\n    );\r\n  }\r\n\r\n  vm.save = function () {\r\n    const formValue = vm.transferKitFormGroup.value;\r\n    const selectedCustomer = formValue.customer;\r\n    if (!selectedCustomer || !selectedCustomer.id) { console.warn('No customer selected.'); return; }\r\n\r\n    if (!vm.customerShortName) vm.customerShortName = selectedCustomer.title;\r\n    const selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n    const newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n\r\n    const saveObservables = [];\r\n    const hasProjectMeasurements = vm.foundProject || (vm.projectMeasurements && vm.projectMeasurements.length > 0);\r\n    const selectedKit = formValue.kit;\r\n    if (!selectedKit.name) { console.warn(\"Selected kit has no name. Aborting save.\"); return; }\r\n    \r\n      vm.measurementRenameMap = new Map();\r\n      if (Array.isArray(vm.projectMeasurements) && vm.projectMeasurements.length > 0) {\r\n        vm.projectMeasurements.forEach((measurement, index) => {\r\n          const ctrl = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n          const newName = ctrl ? String(ctrl.value || '').trim() : '';\r\n          const oldName = String(measurement.name || '').trim();\r\n          if (oldName && newName) {\r\n            vm.measurementRenameMap.set(oldName, newName);\r\n            console.debug('[VR Rename] map:', oldName, '→', newName);\r\n          }\r\n        });\r\n      } else {\r\n        console.debug('[VR Rename] No project measurements; VR renames may be skipped.');\r\n      }\r\n\r\n\r\n    const preEnsure$ = widgetContext.rxjs.forkJoin([\r\n      getDiagnostickitsGroup(newOwner),\r\n      getDiagnostickitDevicesGroup(newOwner),\r\n      getGatewaysGroup(newOwner),\r\n      getUnassignedMeasurementDevicesGroup(newOwner),\r\n      getProjectsGroup(newOwner),\r\n      getMeasurementsGroup(newOwner)\r\n    ]).pipe(widgetContext.rxjs.catchError(() => widgetContext.rxjs.of(null)));\r\n\r\n\r\n    preEnsure$.subscribe(() => {\r\n      // KIT\r\n      let kitSave$ = assetService.saveAsset(selectedKit).pipe(\r\n        widgetContext.rxjs.switchMap(updatedKit => {\r\n          let kitEntity = updatedKit.id && updatedKit.id.entityType ? updatedKit.id : { id: updatedKit.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n            widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, kitEntity)),\r\n            widgetContext.rxjs.switchMap(() =>\r\n              getDiagnostickitsGroup(newOwner).pipe(\r\n                widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, kitEntity.id))\r\n              )\r\n            )\r\n          );\r\n        })\r\n      );\r\n      saveObservables.push(kitSave$);\r\n\r\n\r\n      if (vm.foundProject) {\r\n        let project = vm.foundProject;\r\n        let candidate = (vm.transferredProject && vm.transferredProject.trim()) || ((vm.customerShortName || selectedCustomer.title) + '_Project_1');\r\n        vm.transferredProject = candidate;\r\n        project.name = candidate;\r\n        if (!project.type || !project.type.trim()) project.type = \"Project\";\r\n\r\n        let projectSave$ = assetService.saveAsset(project).pipe(\r\n          widgetContext.rxjs.switchMap(updatedProject => {\r\n            let projectEntity = updatedProject.id && updatedProject.id.entityType ? updatedProject.id : { id: updatedProject.id, entityType: 'ASSET' };\r\n            return entityGroupService.changeEntityOwner(newOwner, projectEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, projectEntity)),\r\n              widgetContext.rxjs.switchMap(() => getProjectsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, projectEntity.id))\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(projectSave$);\r\n      }\r\n\r\n\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        let newMeasurementName = vm.transferKitFormGroup.get('transferredMeasurement' + index).value;\r\n        if (!newMeasurementName || !newMeasurementName.trim()) return;\r\n\r\n        measurement.name = newMeasurementName.trim();\r\n        let measurementSave$ = assetService.saveAsset(measurement).pipe(\r\n          widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n            let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType ? updatedMeasurement.id : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n            return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, measurementEntity)),\r\n              widgetContext.rxjs.switchMap(() => getMeasurementsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, measurementEntity.id))\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(measurementSave$);\r\n      });\r\n\r\n\r\n      vm.allDevices.forEach((device, index) => {\r\n        let newDeviceName = vm.transferKitFormGroup.get('transferredDevice' + index).value;\r\n        if (!newDeviceName || !newDeviceName.trim()) return;\r\n        device.name = newDeviceName.trim();\r\n\r\n        let deviceSave$ = deviceService.saveDevice(device).pipe(\r\n          widgetContext.rxjs.switchMap(updatedDevice => {\r\n            const deviceEntity = updatedDevice.id && updatedDevice.id.entityType ? updatedDevice.id : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n            return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() =>\r\n                getDiagnostickitDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                )\r\n              ),\r\n              widgetContext.rxjs.switchMap(() => {\r\n                if (updatedDevice.type === 'RESI' || updatedDevice.type === 'Gateway') {\r\n                  return getGatewaysGroup(newOwner).pipe(\r\n                    widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                  );\r\n                }\r\n                return widgetContext.rxjs.of(null);\r\n              }),\r\n              widgetContext.rxjs.switchMap(() => {\r\n                if (!hasProjectMeasurements) {\r\n                  return getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                    widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                  );\r\n                }\r\n                return widgetContext.rxjs.of(null);\r\n              }),\r\n\r\n              widgetContext.rxjs.switchMap(() =>\r\n                transferVrsForPhysicalDevice(deviceEntity.id, newOwner, hasProjectMeasurements)\r\n              )\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(deviceSave$);\r\n      });\r\n\r\n      widgetContext.rxjs.forkJoin(saveObservables).subscribe(\r\n        () => { widgetContext.updateAliases(); vm.dialogRef.close(formValue); },\r\n        err => { console.error('Error updating assets:', err); }\r\n      );\r\n    });\r\n  };\r\n\r\n  vm.cancel = function () { vm.dialogRef.close(null); };\r\n}\r\n\r\n\r\n\r\n/*let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet dialogs = injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\nlet customerId, customer;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet pageLink = {\r\n  pageSize: 100,\r\n  page: 0,\r\n  textSearch: '',\r\n  sortOrder: 'ASC',\r\n  sortProperty: 'title',\r\n  toQuery: function () {\r\n    let query = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) { query += '&textSearch=' + encodeURIComponent(this.textSearch); }\r\n    if (this.sortProperty) { query += '&sortProperty=' + encodeURIComponent(this.sortProperty); }\r\n    if (this.sortOrder) { query += '&sortOrder=' + encodeURIComponent(this.sortOrder); }\r\n    return query;\r\n  }\r\n};\r\n\r\nlet kits = [];\r\nlet customers = [];\r\nlet kitsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (kitsLoaded && customersLoaded) {\r\n    openTransferKitDialog(kits, customers);\r\n  }\r\n}\r\n\r\nlet kitSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id,\r\n    rootType: 'CUSTOMER',\r\n    direction: 'FROM',\r\n    relationTypeGroup: 'COMMON',\r\n    maxLevel: 10,\r\n    fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Diagnostickit']\r\n};\r\n\r\nassetService.findByQuery(kitSearchQuery).subscribe(\r\n  result => { kits = result; kitsLoaded = true; checkAndOpenDialog(); },\r\n  () => { kits = []; kitsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\nlet bearerToken = '';\r\nfetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n  method: 'POST',\r\n  headers: {\r\n    'Content-Type': 'application/json'\r\n  },\r\n  body: JSON.stringify({\r\n    \"username\": \"belimo.api@pke-iot.expert\",\r\n    \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n  })\r\n})\r\n  .then(resp => resp.json())\r\n  .then(loginData => {\r\n    bearerToken = loginData.token;\r\n    return fetch('https://cloud.pke-iot.expert/api/customers?pageSize=100&page=0', {\r\n      method: 'GET',\r\n      headers: {\r\n        'accept': 'application/json',\r\n        'X-Authorization': 'Bearer ' + bearerToken\r\n      }\r\n    });\r\n  })\r\n  .then(resp2 => resp2.json())\r\n  .then(customersList => {\r\n    // Process the customers data here.\r\n    customers = customersList.data;\r\n    if (customer) { customers = customers.filter(cust => cust.title !== customer); }\r\n    customersLoaded = true;\r\n    checkAndOpenDialog();\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching customers:\", error);\r\n    alert('Failed to fetch customers.');\r\n  });\r\n\r\n\r\nfunction openTransferKitDialog(kits, customers) {\r\n  customDialog.customDialog(htmlTemplate, TransferKitDialogController, {\r\n    kits: kits,\r\n    customers: customers\r\n  }).subscribe();\r\n}\r\n\r\nfunction TransferKitDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.kits = data.kits || [];\r\n  vm.customers = data.customers || [];\r\n\r\n  vm.transferKitFormGroup = vm.fb.group({\r\n    kit: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n  vm.transferKitFormGroup.addControl('transferredProject', vm.fb.control({ value: '', disabled: true }));\r\n\r\n  vm.allDevices = [];\r\n  vm.devicesWithMeasurements = [];\r\n  vm.foundProject = null;\r\n  vm.projectMeasurements = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n\r\n  vm.transferKitFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId,\r\n          rootType: 'CUSTOMER',\r\n          direction: 'FROM',\r\n          relationTypeGroup: 'COMMON',\r\n          maxLevel: 10,\r\n          fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { \r\n          vm.transferredProject = null; \r\n          vm.customerShortName = null; \r\n        }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null;\r\n      vm.customerShortName = null;\r\n      // Clear out the transferred measurements when no customer is selected.\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        if (vm.transferKitFormGroup.get('transferredMeasurement' + index)) {\r\n          vm.transferKitFormGroup.get('transferredMeasurement' + index).setValue('');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  vm.onKitSelected = function (event) {\r\n    let selectedKit = event.value;\r\n    vm.allDevices = [];\r\n    vm.devicesWithMeasurements = [];\r\n    vm.foundProject = null;\r\n    vm.projectMeasurements = [];\r\n\r\n    // Remove previous measurement and device controls.\r\n    Object.keys(vm.transferKitFormGroup.controls)\r\n      .filter(controlName => controlName.startsWith('measurement') ||\r\n                             controlName.startsWith('transferredMeasurement') ||\r\n                             controlName.startsWith('device') ||\r\n                             controlName.startsWith('transferredDevice'))\r\n      .forEach(controlName => {\r\n        vm.transferKitFormGroup.removeControl(controlName);\r\n      });\r\n    \r\n    let selectedCustomer = vm.transferKitFormGroup.get('customer').value;\r\n    if (!selectedKit || !selectedCustomer) {\r\n      console.warn(\"Kit or customer not selected yet.\");\r\n      return;\r\n    }\r\n    \r\n    let selectedKitId = selectedKit.id.id ? selectedKit.id.id : selectedKit.id;\r\n\r\n    let deviceSearchQuery = {\r\n      parameters: {\r\n        rootId: selectedKitId,\r\n        rootType: 'ASSET',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: true\r\n      },\r\n      relationType: 'Contains',\r\n      deviceTypes: [\r\n          'P-Flow D116',\r\n          'Room Sensor CO2',\r\n          'Temperature Sensor',\r\n          'RESI',\r\n          'Gateway',\r\n          'LTE Status'\r\n      ]\r\n    };\r\n    \r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n      devices => {\r\n        vm.allDevices = devices || [];\r\n        \r\n        if (vm.allDevices.length === 0) {\r\n          console.warn(\"No devices found in selected kit.\");\r\n          return;\r\n        }\r\n        // For each device, add two controls: one showing the original device name, and one for transferred device,\r\n        // which is automatically set to the same name as the found device.\r\n        vm.allDevices.forEach((device, index) => {\r\n          vm.transferKitFormGroup.addControl(\r\n            'device' + index,\r\n            vm.fb.control({ value: device.name, disabled: true })\r\n          );\r\n          vm.transferKitFormGroup.addControl(\r\n            'transferredDevice' + index,\r\n            vm.fb.control({ value: device.name, disabled: true })\r\n          );\r\n        });\r\n\r\n        let measurementChecks = vm.allDevices.map(device => {\r\n          let measurementQuery = {\r\n            parameters: {\r\n              rootId: (device.id.id ? device.id.id : device.id),\r\n              rootType: 'DEVICE',\r\n              direction: 'TO',\r\n              relationTypeGroup: 'COMMON',\r\n              maxLevel: 1073741824,\r\n              fetchLastLevelOnly: false\r\n            },\r\n            relationType: 'Measurement',\r\n            assetTypes: ['Measurement']\r\n          };\r\n          return assetService.findByQuery(measurementQuery).pipe(\r\n            widgetContext.rxjs.map(measurements => {\r\n              return { device: device, measurements: measurements || [] };\r\n            })\r\n          );\r\n        });\r\n        widgetContext.rxjs.forkJoin(measurementChecks).subscribe(\r\n          measurementResults => {\r\n            vm.devicesWithMeasurements = measurementResults.filter(r => r.measurements.length > 0);\r\n            let projectChecks = [];\r\n            vm.devicesWithMeasurements.forEach(item => {\r\n              item.measurements.forEach(meas => {\r\n                let projectQuery = {\r\n                  parameters: {\r\n                    rootId: (meas.id.id ? meas.id.id : meas.id),\r\n                    rootType: 'ASSET',\r\n                    direction: 'TO',\r\n                    relationTypeGroup: 'COMMON',\r\n                    maxLevel: 10,\r\n                    fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: 'Owns',\r\n                  assetTypes: ['Project']\r\n                };\r\n                projectChecks.push(\r\n                  assetService.findByQuery(projectQuery).pipe(\r\n                    widgetContext.rxjs.map(projects => {\r\n                      return { measurement: meas, projects: projects || [] };\r\n                    })\r\n                  )\r\n                );\r\n              });\r\n            });\r\n            if (projectChecks.length === 0) {\r\n              return;\r\n            }\r\n            widgetContext.rxjs.forkJoin(projectChecks).subscribe(\r\n              projectResults => {\r\n                let found = projectResults.find(r => r.projects.length > 0);\r\n                if (found) {\r\n                  vm.foundProject = found.projects[0];\r\n                  if (!vm.transferKitFormGroup.get('foundProject')) {\r\n                    vm.transferKitFormGroup.addControl(\r\n                      'foundProject',\r\n                      vm.fb.control({ value: vm.foundProject.name, disabled: true })\r\n                    );\r\n                  } else {\r\n                    vm.transferKitFormGroup.get('foundProject').setValue(vm.foundProject.name);\r\n                  }\r\n                  searchMeasurementsForProject(vm.foundProject);\r\n                }\r\n              },\r\n              err => {\r\n                console.error(\"Error during project queries:\", err);\r\n              }\r\n            );\r\n          },\r\n          err => {\r\n            console.error(\"Error in measurement checks:\", err);\r\n          }\r\n        );\r\n      },\r\n      err => {\r\n        console.error(\"Error finding devices for kit:\", err);\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.onCustomerSelected = function (event) {\r\n    let kit = vm.transferKitFormGroup.get('kit').value;\r\n    if (kit) {\r\n      vm.onKitSelected({ value: kit });\r\n    }\r\n  };\r\n\r\n  function updateFoundProjectName(customerShortName, existingProjects) {\r\n    if (!customerShortName) {\r\n      console.warn(\"Customer short name is not defined.\");\r\n      return;\r\n    }\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) {\r\n          maxNumericSuffix = parsedNum;\r\n        }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    vm.transferredProject = candidate;\r\n    vm.transferKitFormGroup.get('transferredProject').setValue(candidate);\r\n    // Device names remain as set.\r\n  }\r\n\r\n  function renameProjectMeasurements() {\r\n    if (!vm.customerShortName) {\r\n      console.warn(\"Customer short name not set. Skipping measurement rename.\");\r\n      return;\r\n    }\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n    let newProjectName = vm.transferKitFormGroup.get('transferredProject');\r\n      let oldName = measurement.name;\r\n      let parts = oldName.split('_');\r\n      let newName = newProjectName.value + '_' + parts[2];\r\n      let control = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n      if (control) {\r\n        control.setValue(newName);\r\n      }\r\n    });\r\n  }\r\n\r\n  function searchMeasurementsForProject(project) {\r\n    let projectId = project.id.id ? project.id.id : project.id;\r\n    let projectMeasurementQuery = {\r\n      parameters: {\r\n        rootId: projectId,\r\n        rootType: 'ASSET',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Measurement']\r\n    };\r\n    assetService.findByQuery(projectMeasurementQuery).subscribe(\r\n      measurements => {\r\n        vm.projectMeasurements = measurements || [];\r\n\r\n        // Remove old measurement controls.\r\n        Object.keys(vm.transferKitFormGroup.controls)\r\n          .filter(controlName => controlName.startsWith('measurement') ||\r\n                                 controlName.startsWith('transferredMeasurement'))\r\n          .forEach(controlName => {\r\n            vm.transferKitFormGroup.removeControl(controlName);\r\n          });\r\n\r\n        (measurements || []).forEach((measurement, index) => {\r\n          vm.transferKitFormGroup.addControl(\r\n            'measurement' + index,\r\n            vm.fb.control({ value: measurement.name, disabled: true })\r\n          );\r\n          // Create transferred measurement control as disabled.\r\n          vm.transferKitFormGroup.addControl(\r\n            'transferredMeasurement' + index,\r\n            vm.fb.control({ value: '', disabled: true })\r\n          );\r\n        });\r\n\r\n        renameProjectMeasurements();\r\n      },\r\n      err => {\r\n        console.error(\"Error finding measurements for project:\", err);\r\n      }\r\n    );\r\n  }\r\n\r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      })\r\n    );\r\n  }\r\n  \r\n  // --- Group helper functions ---\r\n    function getProjectsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let projectsGroup = groups.find(g => g.name === 'Projects');\r\n          if (projectsGroup) {\r\n            return widgetContext.rxjs.of(projectsGroup);\r\n          } else {\r\n            projectsGroup = { type: 'ASSET', name: 'Projects', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(projectsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getMeasurementsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let measurementsGroup = groups.find(g => g.name === 'Measurements');\r\n          if (measurementsGroup) {\r\n            return widgetContext.rxjs.of(measurementsGroup);\r\n          } else {\r\n            measurementsGroup = { type: 'ASSET', name: 'Measurements', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(measurementsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getDiagnostickitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let kitsGroup = groups.find(g => g.name === 'Diagnostickits');\r\n          if (kitsGroup) {\r\n            return widgetContext.rxjs.of(kitsGroup);\r\n          } else {\r\n            kitsGroup = { type: 'ASSET', name: 'Diagnostickits', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(kitsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    // Modified getGatewaysGroup: Removed the type check\r\n    function getGatewaysGroup(customerId, updatedDevice) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let devicesGroup = groups.find(g => g.name === 'Gateways');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = { type: 'DEVICE', name: 'Gateways', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n    \r\n    function getDiagnostickitDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let devicesGroup = groups.find(g => g.name === 'Diagnostickit Devices');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = { type: 'DEVICE', name: 'Diagnostickit Devices', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    \r\n    function getUnassignedMeasurementDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let unassignedGroup = groups.find(g => g.name === 'Unassigned Measurement Devices');\r\n          if (unassignedGroup) {\r\n            return widgetContext.rxjs.of(unassignedGroup);\r\n          } else {\r\n            unassignedGroup = { type: 'DEVICE', name: 'Unassigned Measurement Devices', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(unassignedGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n  vm.save = function () {\r\n    let formValue = vm.transferKitFormGroup.value;\r\n    let selectedCustomer = formValue.customer;\r\n    if (!selectedCustomer || !selectedCustomer.id) {\r\n      console.warn('No customer selected.');\r\n      return;\r\n    }\r\n\r\n    if (!vm.customerShortName) {\r\n      vm.customerShortName = selectedCustomer.title;\r\n    }\r\n    let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n    let newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n\r\n    let saveObservables = [];\r\n    \r\n    let hasProjectMeasurements = vm.foundProject || (vm.projectMeasurements && vm.projectMeasurements.length > 0);\r\n    \r\n    let selectedKit = formValue.kit;\r\n    if (!selectedKit.name) {\r\n      console.warn(\"Selected kit has no name. Aborting save.\");\r\n      return;\r\n    }\r\n    let kitSave$ = assetService.saveAsset(selectedKit).pipe(\r\n      widgetContext.rxjs.switchMap(updatedKit => {\r\n        let kitEntity = updatedKit.id && updatedKit.id.entityType \r\n                          ? updatedKit.id \r\n                          : { id: updatedKit.id, entityType: 'ASSET' };\r\n        return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n            widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, kitEntity)),\r\n            // Always assign to Diagnostickits group\r\n            widgetContext.rxjs.switchMap(() => \r\n              getDiagnostickitsGroup(newOwner).pipe(\r\n                widgetContext.rxjs.switchMap(group => \r\n                  entityGroupService.addEntitiesToEntityGroup(group.id.id, [kitEntity.id])\r\n                )\r\n              )\r\n            ),\r\n            // If no project/measurements, also add to Unassigned Kit Group\r\n         );\r\n      })\r\n    );\r\n    saveObservables.push(kitSave$);\r\n\r\n    if (vm.foundProject) {\r\n      let project = vm.foundProject;\r\n      let candidate = vm.transferredProject && vm.transferredProject.trim();\r\n      if (!candidate) {\r\n        console.warn(\"Transferred project name was empty.\");\r\n        candidate = (vm.customerShortName || selectedCustomer.title) + '_Project_1';\r\n        formValue.transferredProject = candidate;\r\n        console.warn(\"Using fallback: \" + candidate);\r\n      }\r\n      project.name = candidate;\r\n      if (!project.type || project.type.trim() === \"\") {\r\n        project.type = \"Project\";\r\n      }\r\n      let projectSave$ = assetService.saveAsset(project).pipe(\r\n        widgetContext.rxjs.switchMap(updatedProject => {\r\n          let projectEntity = updatedProject.id && updatedProject.id.entityType \r\n                              ? updatedProject.id \r\n                              : { id: updatedProject.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, projectEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, projectEntity)),\r\n              widgetContext.rxjs.switchMap(() => getProjectsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(projectsGroup =>\r\n                entityGroupService.addEntitiesToEntityGroup(projectsGroup.id.id, [projectEntity.id])\r\n              )\r\n            );\r\n        })\r\n      );\r\n      saveObservables.push(projectSave$);\r\n    }\r\n\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n      let newMeasurementName = vm.transferKitFormGroup.get('transferredMeasurement' + index).value;\r\n      if (!newMeasurementName || newMeasurementName.trim() === \"\") {\r\n        console.warn(`New name for measurement at index ${index} is empty. Skipping update.`);\r\n        return;\r\n      }\r\n      measurement.name = newMeasurementName.trim();\r\n      let measurementSave$ = assetService.saveAsset(measurement).pipe(\r\n        widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n          let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType \r\n                                  ? updatedMeasurement.id \r\n                                  : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, measurementEntity)),\r\n              widgetContext.rxjs.switchMap(() => getMeasurementsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(measurementsGroup =>\r\n                entityGroupService.addEntitiesToEntityGroup(measurementsGroup.id.id, [measurementEntity.id])\r\n              )\r\n            );\r\n        })\r\n      );\r\n      saveObservables.push(measurementSave$);\r\n    });\r\n\r\n    // For each device, update its name with the value from the transferred device control.\r\n    // In the vm.save function, within the device update chain:\r\n    vm.allDevices.forEach((device, index) => {\r\n      let newDeviceName = vm.transferKitFormGroup.get('transferredDevice' + index).value;\r\n      if (!newDeviceName || newDeviceName.trim() === \"\") {\r\n        console.warn(`New name for device at index ${index} is empty. Skipping update.`);\r\n        return;\r\n      }\r\n      device.name = newDeviceName.trim();\r\n      let deviceSave$ = deviceService.saveDevice(device).pipe(\r\n        widgetContext.rxjs.switchMap(updatedDevice => {\r\n          let deviceEntity = updatedDevice.id && updatedDevice.id.entityType \r\n                             ? updatedDevice.id \r\n                             : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n          return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n            // Always assign to Diagnostickit Devices group\r\n            widgetContext.rxjs.switchMap(() => {\r\n              return getDiagnostickitDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(devicesGroup =>\r\n                    entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n            }\r\n            ),\r\n            // Conditionally assign to Gateways group if updatedDevice.type is 'RESI' or 'Gateway'\r\n            widgetContext.rxjs.switchMap(() => {\r\n              if (updatedDevice.type === 'RESI' || updatedDevice.type === 'Gateway') {\r\n                return getGatewaysGroup(newOwner, updatedDevice).pipe(\r\n                  widgetContext.rxjs.switchMap(devicesGroup =>\r\n                    entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n              } else {\r\n                return widgetContext.rxjs.of(null);\r\n              }\r\n            }),\r\n            // Additionally, if no project/measurements exist, assign to Unassigned Measurement Devices\r\n            widgetContext.rxjs.switchMap(() => {\r\n              if (!hasProjectMeasurements) {\r\n                return getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(group =>\r\n                    entityGroupService.addEntitiesToEntityGroup(group.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n              } else {\r\n                return widgetContext.rxjs.of(null);\r\n              }\r\n            })\r\n          );\r\n        })\r\n      );\r\n      saveObservables.push(deviceSave$);\r\n    });\r\n\r\n\r\n    widgetContext.rxjs.forkJoin(saveObservables).subscribe(\r\n      () => {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(formValue);\r\n      },\r\n      err => {\r\n        console.error('Error updating assets:', err);\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n}\r\n*/",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "20030896-36ba-fa5d-814d-09bac156d398"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "d6393653-ccec-edf8-4bd7-520334011adb",
        "typeFullFqn": "system.cards.entities_table"
      },
      "aeae7803-eac3-1b63-938e-06dde5857ced": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "203b0867-b867-ef98-1791-03046c133b7d",
              "dataKeys": [
                {
                  "name": "role",
                  "type": "attribute",
                  "label": "role",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.8853142583803868
                },
                {
                  "name": "ownerName",
                  "type": "entityField",
                  "label": "customer",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.48497657295220475
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "fbfce281-668f-0ad0-d8f4-6870d3ef679f",
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "readonlyEmail",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.111
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "4128d7f0-9e28-5c7d-cf9a-b43cfe893568",
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "engineerEmail",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.222
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "1cab31a1-6ad5-e39d-7798-e0dfee1cd61c",
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "adminEmail",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.333
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678196817440,
                "endTimeMs": 1678283217440
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "\n// State params\nvar stateParams = ctx.stateController.getStateParams();\nctx.stateController.updateState(null, stateParams);\n\n// Datasources:\n// \"Current User\" -> role, customer\n// \"Belimo Retrofit Users\" -> readonlyEmail (count by rows)\n// \"Belimo Retrofit Engineer\" -> engineerEmail (count by rows)\n// \"Belimo Retrofit Administrators\" -> adminEmail (count by rows)\n\nvar userRole = '';\nvar customerName = '';\nvar usersReadonly = 0, usersEngineers = 0, usersAdmins = 0;\n\ndata.forEach(function(item) {\n  var alias = item.aliasName || '';\n\n  if (alias === 'Current User') {\n    userRole = item.role || '';\n    customerName = item.customer || '';\n  } else if (alias === 'Belimo Retrofit Users') {\n    usersReadonly++;\n  } else if (alias === 'Belimo Retrofit Engineer') {\n    usersEngineers++;\n  } else if (alias === 'Belimo Retrofit Administrators') {\n    usersAdmins++;\n  }\n});\n\nvar usersTotal = usersReadonly + usersEngineers + usersAdmins;\n\n// Check if current user can manage users (add new users)\nvar isTenantAdmin = ctx.currentUser.authority === 'TENANT_ADMIN';\nvar adminRoles = [\n  'ECO Administrator',\n  'ECO Diagnostics Administrator',\n  'Belimo Retrofit Administrator',\n  'Administrator'\n];\nvar isAdminRole = adminRoles.some(function(role) {\n  return userRole === role || userRole.toLowerCase() === role.toLowerCase();\n});\nvar canManageUsers = isTenantAdmin || isAdminRole;\n\nstateParams['userRole'] = userRole;\nctx.stateController.updateState(null, stateParams);\n\n// === USER MANAGEMENT VIEW with Tab Navigation ===\n\n// Tab configuration\nvar tabs = [\n    { id: 'readonly', label: 'Read-Only Users', icon: 'person', stateId: 'user_readonly', count: usersReadonly },\n    { id: 'engineers', label: 'Engineers', icon: 'engineering', stateId: 'user_engineers', count: usersEngineers },\n    { id: 'admins', label: 'Administrators', icon: 'admin_panel_settings', stateId: 'user_admininistrators', count: usersAdmins }\n];\n\n// Get active tab from stateParams\nvar activeTabId = (stateParams.userNavTab && stateParams.userNavTab.active) || 'readonly';\nvar selectedIndex = 0;\nfor (var i = 0; i < tabs.length; i++) {\n    if (tabs[i].id === activeTabId) {\n        selectedIndex = i;\n        break;\n    }\n}\n\n// Set up tab change handler on ctx\nctx.userNavIndex = selectedIndex;\nctx.userNavChange = function(ev) {\n    try {\n        var idx = (ev && typeof ev.index === 'number') ? ev.index : 0;\n        var tab = tabs[idx] || tabs[0];\n        ctx.userNavIndex = idx;\n\n        var currentParams = ctx.stateController.getStateParams() || {};\n        currentParams.userNavTab = { active: tab.id };\n        ctx.stateController.updateState(null, currentParams);\n\n        if (ctx.$scope && typeof ctx.$scope.$applyAsync === 'function') {\n            ctx.$scope.$applyAsync();\n        }\n    } catch (e) {\n        console.error('userNavChange error', e);\n    }\n};\n\n// Inject styles for tabs\n(function injectTabStyles() {\n    var styleId = 'user-nav-tabs-style';\n    if (document.getElementById(styleId)) return;\n\n    var css = `\n        .user-tabs-container {\n            display: flex;\n            flex-direction: column;\n            height: 100%;\n            min-height: 0;\n        }\n        .user-tabs-container mat-tab-group {\n            flex: 1 1 auto;\n            min-height: 0;\n            height: 100%;\n        }\n        .user-tabs-container .mat-mdc-tab-body-wrapper {\n            flex: 1 1 auto;\n            min-height: 0;\n            height: 100%;\n        }\n        .user-tabs-container .mat-mdc-tab-body {\n            height: 100%;\n            min-height: 0;\n        }\n        .user-tabs-container .mat-mdc-tab-body-content {\n            height: 100%;\n            min-height: 0;\n            overflow: hidden;\n        }\n        .user-tab-label {\n            display: inline-flex;\n            align-items: center;\n            gap: 8px;\n        }\n        .user-tab-label mat-icon {\n            font-size: 20px;\n            width: 20px;\n            height: 20px;\n        }\n        .user-tab-label .tab-count {\n            background: rgba(0,0,0,0.1);\n            padding: 2px 8px;\n            border-radius: 12px;\n            font-size: 12px;\n            font-weight: 500;\n        }\n        .user-tab-body {\n            width: 100%;\n            height: 100%;\n            display: block;\n        }\n    `;\n\n    var styleEl = document.createElement('style');\n    styleEl.id = styleId;\n    styleEl.type = 'text/css';\n    styleEl.appendChild(document.createTextNode(css));\n    document.head.appendChild(styleEl);\n})();\n\n// Header HTML - only show Add User button for admin roles\nvar headerHtml = '<div class=\"manage-header users\">' +\n    '<div class=\"header-left\">' +\n        '<a id=\"btn-go-back\" class=\"back-button\" role=\"button\" title=\"Go Back\">' +\n            '<mat-icon>arrow_back</mat-icon>' +\n        '</a>' +\n        '<div class=\"header-title\">' +\n            '<h1><mat-icon>group</mat-icon>User Management</h1>' +\n            '<div class=\"header-stats\">' +\n                '<span class=\"stat-item\"><span class=\"stat-dot total\"></span><span class=\"stat-value\">' + usersTotal + '</span> Total</span>' +\n                '<span class=\"stat-item\"><span class=\"stat-dot user\"></span><span class=\"stat-value\">' + usersReadonly + '</span> Read-Only</span>' +\n                '<span class=\"stat-item\"><span class=\"stat-dot engineer\"></span><span class=\"stat-value\">' + usersEngineers + '</span> Engineers</span>' +\n                '<span class=\"stat-item\"><span class=\"stat-dot admin\"></span><span class=\"stat-value\">' + usersAdmins + '</span> Admins</span>' +\n            '</div>' +\n        '</div>' +\n    '</div>' +\n    '<div class=\"header-right\">' +\n        (canManageUsers ? '<a id=\"btn-add-user\" class=\"header-action-btn\" role=\"button\" title=\"Add User\"><mat-icon>person_add</mat-icon>Add User</a>' : '') +\n    '</div>' +\n'</div>';\n\n// Build tabs HTML\nvar tabsHtml = '';\nfor (var j = 0; j < tabs.length; j++) {\n    var t = tabs[j];\n    tabsHtml += '<mat-tab>' +\n        '<ng-template mat-tab-label>' +\n            '<span class=\"user-tab-label\">' +\n                '<mat-icon>' + t.icon + '</mat-icon>' +\n                '<span>' + t.label + '</span>' +\n                '<span class=\"tab-count\">' + t.count + '</span>' +\n            '</span>' +\n        '</ng-template>' +\n        '<ng-template matTabContent>' +\n            '<tb-dashboard-state class=\"user-tab-body\" [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"' + t.stateId + '\"></tb-dashboard-state>' +\n        '</ng-template>' +\n    '</mat-tab>';\n}\n\nvar tabGroupHtml = '<div class=\"user-tabs-container\">' +\n    '<mat-tab-group mat-stretch-tabs=\"false\" mat-align-tabs=\"start\"' +\n        ' [selectedIndex]=\"ctx.userNavIndex\"' +\n        ' (selectedTabChange)=\"ctx.userNavChange($event)\">' +\n        tabsHtml +\n    '</mat-tab-group>' +\n'</div>';\n\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\n       headerHtml +\n       '<div class=\"content-area\" style=\"flex: 1; min-height: 0;\">' + tabGroupHtml + '</div>' +\n       '</div>';\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget {\n    border-radius: 0px;\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n/* === Reusable Manage Header === */\n.manage-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem;\n    border-radius: 8px;\n    color: #ffffff;\n    min-height: 70px;\n    margin-bottom: 1rem;\n}\n\n.manage-header.kits {\n    background: linear-gradient(135deg, #3a6a9e 0%, #2c5278 100%);\n}\n\n.manage-header.projects {\n    background: linear-gradient(135deg, #26a69a 0%, #00897b 100%);\n}\n\n.manage-header.users {\n    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);\n}\n\n.header-left {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n}\n\n.back-button {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    width: 40px;\n    height: 40px;\n    background: rgba(255,255,255,0.15);\n    border: 1px solid rgba(255,255,255,0.3);\n    border-radius: 8px;\n    color: #ffffff;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    text-decoration: none;\n}\n\n.back-button:hover {\n    background: rgba(255,255,255,0.25);\n}\n\n.back-button mat-icon {\n    font-size: 24px !important;\n    width: 24px !important;\n    height: 24px !important;\n}\n\n.header-title {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n}\n\n.header-title h1 {\n    font-size: 1.4rem;\n    font-weight: 600;\n    margin: 0;\n    display: flex;\n    align-items: center;\n    gap: 0.6rem;\n}\n\n.header-title h1 mat-icon {\n    font-size: 26px !important;\n    width: 26px !important;\n    height: 26px !important;\n    opacity: 0.9;\n}\n\n.header-stats {\n    display: flex;\n    gap: 1.25rem;\n    font-size: 0.85rem;\n    opacity: 0.9;\n}\n\n.stat-item {\n    display: flex;\n    align-items: center;\n    gap: 0.35rem;\n}\n\n.stat-dot {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n}\n\n.stat-dot.total { background-color: #ffffff; }\n.stat-dot.assigned { background-color: #EB5757; }\n.stat-dot.available { background-color: #27AE60; }\n.stat-dot.planned { background-color: #F2994A; }\n.stat-dot.in-preparation { background-color: #F2994A; }\n.stat-dot.active { background-color: #27AE60; }\n.stat-dot.finished { background-color: #2F80ED; }\n.stat-dot.aborted { background-color: #EB5757; }\n.stat-dot.admin { background-color: #EB5757; }\n.stat-dot.engineer { background-color: #2F80ED; }\n.stat-dot.user { background-color: #27AE60; }\n\n.stat-value {\n    font-weight: 600;\n}\n\n.header-right {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n}\n\n.header-action-btn {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.6rem 1.2rem;\n    background: rgba(255,255,255,0.15);\n    border: 1px solid rgba(255,255,255,0.4);\n    border-radius: 6px;\n    color: #ffffff !important;\n    font-size: 0.875rem;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    text-decoration: none;\n}\n\n.header-action-btn mat-icon {\n    color: #ffffff !important;\n}\n\n.header-action-btn:hover {\n    background: rgba(255,255,255,0.95);\n    color: #2c5278 !important;\n    border-color: transparent;\n}\n\n.header-action-btn:hover mat-icon {\n    color: #2c5278 !important;\n}\n\n/* Project Wizard Button - distinct styling */\n.header-action-btn.wizard {\n    background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);\n    border-color: transparent;\n}\n\n.header-action-btn.wizard:hover {\n    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);\n    color: #ffffff !important;\n    transform: translateY(-1px);\n    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);\n}\n\n.header-action-btn.wizard:hover mat-icon {\n    color: #ffffff !important;\n}\n\n/* Force white text in manage-header */\n.manage-header,\n.manage-header h1,\n.manage-header .header-title,\n.manage-header .header-stats,\n.manage-header .stat-item,\n.manage-header .stat-value,\n.manage-header mat-icon {\n    color: #ffffff !important;\n}\n\n.content-area {\n    flex: 1;\n    overflow: hidden;\n}\n\n.main-layout .header {\n    height: 60px;\n    margin: 4px;\n}\n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n/* Flexbox height fix - prevent scrolling */\n.main-layout {\n    display: flex;\n    flex-direction: column;\n    min-height: 0;\n    overflow: hidden;\n}\n\n.main-layout > .manage-header {\n    flex: 0 0 auto;\n}\n\n.main-layout > tb-dashboard-state {\n    flex: 1 1 auto;\n    min-height: 0;\n    height: 100%;\n    overflow: hidden;\n}\n\n/* Ensure parent containers also have proper height */\n.tb-markdown-view {\n    height: 100%;\n    overflow: hidden;\n}\n\n.tb-markdown-view > div {\n    height: 100%;\n    overflow: hidden;\n}\n"
          },
          "title": "Manage Users Header",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow.no-padding {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 4px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "btn-go-back",
                "icon": "arrow_back",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nvar number = (widgetContext.stateController.getStateIndex())-1;\nwidgetContext.stateController.updateState(null, params);\nwidgetContext.stateController.navigatePrevState(number);",
                "id": "act-go-back-users"
              },
              {
                "name": "btn-add-user",
                "icon": "person_add",
                "type": "customPretty",
                "customHtml": "<form\n  #addUserForm=\"ngForm\"\n  [formGroup]=\"addUserFormGroup\"\n  (ngSubmit)=\"save()\"\n  class=\"add-user-dialog\"\n>\n  <!-- Header -->\n  <div class=\"dialog-header\">\n    <mat-icon>person_add</mat-icon>\n    <h2>Add User</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\" class=\"close-btn\">\n      <mat-icon>close</mat-icon>\n    </button>\n  </div>\n\n  <mat-progress-bar color=\"accent\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n\n  <div class=\"dialog-body\">\n    <!-- User Role Selection Card -->\n    <div class=\"section-card role-card\">\n      <div class=\"card-header-mini\">\n        <mat-icon>badge</mat-icon>\n        <span>User Role</span>\n      </div>\n      <mat-form-field appearance=\"outline\" class=\"w-full\">\n        <mat-label>Select Role</mat-label>\n        <mat-select formControlName=\"userRole\" required>\n          <mat-option *ngFor=\"let role of userRoles\" [value]=\"role.value\">\n            <mat-icon style=\"vertical-align: middle; margin-right: 8px;\">{{ role.icon }}</mat-icon>\n            {{ role.name }}\n          </mat-option>\n        </mat-select>\n        <mat-icon matPrefix>security</mat-icon>\n        <mat-error *ngIf=\"addUserFormGroup.get('userRole').hasError('required')\">\n          Please select a user role\n        </mat-error>\n      </mat-form-field>\n    </div>\n\n    <!-- User Details Card -->\n    <div class=\"section-card user-card\">\n      <div class=\"card-header-mini\">\n        <mat-icon>account_circle</mat-icon>\n        <span>User Details</span>\n      </div>\n\n      <mat-form-field appearance=\"outline\" class=\"w-full\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-icon matPrefix>email</mat-icon>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n          Email is required\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n          Invalid email format\n        </mat-error>\n      </mat-form-field>\n\n      <div class=\"flex gap-3\">\n        <mat-form-field appearance=\"outline\" class=\"flex-1\">\n          <mat-label>First Name</mat-label>\n          <input matInput formControlName=\"firstName\">\n          <mat-icon matPrefix>person</mat-icon>\n        </mat-form-field>\n        <mat-form-field appearance=\"outline\" class=\"flex-1\">\n          <mat-label>Last Name</mat-label>\n          <input matInput formControlName=\"lastName\">\n          <mat-icon matPrefix>person_outline</mat-icon>\n        </mat-form-field>\n      </div>\n    </div>\n\n    <!-- Activation Method Card -->\n    <div class=\"section-card activation-card\">\n      <div class=\"card-header-mini\">\n        <mat-icon>vpn_key</mat-icon>\n        <span>Activation</span>\n      </div>\n      <mat-form-field appearance=\"outline\" class=\"w-full\">\n        <mat-label>Activation Method</mat-label>\n        <mat-select formControlName=\"activationMethod\">\n          <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n            {{ method.name }}\n          </mat-option>\n        </mat-select>\n        <mat-icon matPrefix>send</mat-icon>\n      </mat-form-field>\n    </div>\n  </div>\n\n  <!-- Footer -->\n  <div class=\"dialog-footer\">\n    <button mat-button type=\"button\" (click)=\"cancel()\">Cancel</button>\n    <button mat-raised-button color=\"primary\" type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      <mat-icon>person_add</mat-icon>\n      Add User\n    </button>\n  </div>\n</form>",
                "customCss": ".add-user-dialog {\n  width: 500px;\n  max-width: 95vw;\n  display: flex;\n  flex-direction: column;\n  font-family: Roboto, sans-serif;\n  border-radius: 0;\n  overflow: hidden;\n  background: #fff;\n}\n\n.dialog-header {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  padding: 16px 20px;\n  background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);\n  color: white;\n}\n\n.dialog-header mat-icon {\n  font-size: 24px;\n  width: 24px;\n  height: 24px;\n}\n\n.dialog-header h2 {\n  margin: 0;\n  font-size: 18px;\n  font-weight: 500;\n}\n\n.dialog-header .close-btn {\n  color: white;\n}\n\n.dialog-body {\n  padding: 20px;\n  display: flex;\n  flex-direction: column;\n  gap: 16px;\n  max-height: 60vh;\n  overflow-y: auto;\n}\n\n.section-card {\n  background: #fafafa;\n  border: 1px solid #e0e0e0;\n  border-radius: 8px;\n  padding: 16px;\n}\n\n.section-card.role-card {\n  background: linear-gradient(135deg, rgba(156, 39, 176, 0.05) 0%, rgba(123, 31, 162, 0.08) 100%);\n  border-color: rgba(156, 39, 176, 0.2);\n}\n\n.card-header-mini {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  margin-bottom: 12px;\n  font-weight: 500;\n  color: #555;\n}\n\n.card-header-mini mat-icon {\n  font-size: 18px;\n  width: 18px;\n  height: 18px;\n  color: #9c27b0;\n}\n\n.dialog-footer {\n  display: flex;\n  justify-content: flex-end;\n  gap: 12px;\n  padding: 16px 20px;\n  border-top: 1px solid #e0e0e0;\n  background: #fafafa;\n}\n\n.dialog-footer button[mat-raised-button] mat-icon {\n  margin-right: 8px;\n}\n\n/* Form field styling */\n.add-user-dialog .mat-mdc-form-field {\n  width: 100%;\n}\n\n.add-user-dialog .mdc-text-field--outlined {\n  background-color: #fff !important;\n}\n\n.flex {\n  display: flex;\n}\n\n.flex-1 {\n  flex: 1;\n}\n\n.gap-3 {\n  gap: 12px;\n}\n\n.w-full {\n  width: 100%;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n\n  // User role options with icons\n  vm.userRoles = [\n    {\n      value: 'readonly',\n      name: 'Read-Only User',\n      icon: 'person',\n      groupName: 'Belimo Retrofit User',\n      roleAttribute: 'Belimo Retrofit Users'\n    },\n    {\n      value: 'engineer',\n      name: 'Engineer',\n      icon: 'engineering',\n      groupName: 'Belimo Retrofit Engineer',\n      roleAttribute: 'Belimo Retrofit Engineer'\n    },\n    {\n      value: 'administrator',\n      name: 'Administrator',\n      icon: 'admin_panel_settings',\n      groupName: 'Belimo Retrofit Administrators',\n      roleAttribute: 'Belimo Retrofit Administrator'\n    }\n  ];\n\n  vm.activationMethods = [\n    {\n      value: 'displayActivationLink',\n      name: 'Display Activation Link'\n    },\n    {\n      value: 'sendActivationMail',\n      name: 'Send Activation Email'\n    }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    userRole: ['readonly', vm.validators.required],\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    activationMethod: ['displayActivationLink']\n  });\n\n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n\n  vm.save = function () {\n    var customerId;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n      customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n      customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\n    }\n\n    vm.addUserFormGroup.markAsPristine();\n\n    const formValues = vm.addUserFormGroup.value;\n    const selectedRole = vm.userRoles.find(r => r.value === formValues.userRole);\n\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n\n    const sendActivationMail = (formValues.activationMethod === 'sendActivationMail');\n\n    widgetContext.rxjs.forkJoin([\n      getTargetUserGroup(customerId, selectedRole.groupName),\n      getDashboardByName('Smart Diagnostics')\n    ]).pipe(\n      widgetContext.rxjs.switchMap((data) => {\n        var userGroup = data[0];\n        var defaultDashboard = data[1];\n        if (defaultDashboard) {\n          user.additionalInfo = {\n            defaultDashboardId: defaultDashboard.id.id,\n            defaultDashboardFullscreen: true\n          };\n        }\n        return saveUserObservable(userGroup, user, sendActivationMail);\n      }),\n      widgetContext.rxjs.switchMap((savedUser) => {\n        const roleAttribute = {\n          key: 'role',\n          value: selectedRole.roleAttribute\n        };\n        return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n          widgetContext.rxjs.map(() => savedUser)\n        );\n      })\n    ).subscribe((user) => {\n      widgetContext.updateAliases();\n      if (formValues.activationMethod === 'displayActivationLink') {\n        userService.getActivationLink(user.id.id).subscribe(\n          (activationLink) => {\n            displayActivationLink(activationLink, formValues.email).subscribe(\n              () => {\n                vm.dialogRef.close(null);\n              }\n            );\n          }\n        );\n      } else {\n        vm.dialogRef.close(null);\n      }\n    });\n  };\n\n  function saveUserObservable(userGroup, user, sendActivationMail) {\n    return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n\n  function getTargetUserGroup(customerId, groupName) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n      widgetContext.rxjs.switchMap((groups) => {\n        return getOrCreateUserGroup(groups, groupName, customerId);\n      })\n    );\n  }\n\n  function getOrCreateUserGroup(groups, groupName, customerId) {\n    var usersGroup = groups.find(group => group.name === groupName);\n    if (usersGroup) {\n      return widgetContext.rxjs.of(usersGroup);\n    } else {\n      usersGroup = {\n        type: 'USER',\n        name: groupName,\n        ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(usersGroup);\n    }\n  }\n\n  function getDashboardByName(dashboardName) {\n    var dashboardsPageLink = widgetContext.pageLink(100, 0, dashboardName);\n    return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n      widgetContext.rxjs.map((data) => {\n        if (data.data.length) {\n          return data.data.find((dashboard) => dashboard.name === dashboardName);\n        } else {\n          return null;\n        }\n      })\n    );\n  }\n\n  function displayActivationLink(activationLink, userEmail) {\n    // Use Angular binding for email instead of string interpolation to avoid @ symbol issues\n    const template =\n'<div class=\"activation-dialog\">' +\n'  <div class=\"activation-header\">' +\n'    <mat-icon>check_circle</mat-icon>' +\n'    <h2>User Created Successfully</h2>' +\n'    <span class=\"flex-1\"></span>' +\n'    <button mat-icon-button (click)=\"close()\" type=\"button\" class=\"close-btn\">' +\n'      <mat-icon>close</mat-icon>' +\n'    </button>' +\n'  </div>' +\n'  <div class=\"activation-body\">' +\n'    <div class=\"success-icon\">' +\n'      <mat-icon>person_add</mat-icon>' +\n'    </div>' +\n'    <p class=\"activation-info\">' +\n'      The user <strong>{{ userEmail }}</strong> has been created.<br>' +\n'      Share the activation link below to allow them to set their password.' +\n'    </p>' +\n'    <div class=\"link-container\">' +\n'      <div class=\"link-label\">' +\n'        <mat-icon>link</mat-icon>' +\n'        <span>Activation Link</span>' +\n'      </div>' +\n'      <div class=\"link-box\">' +\n'        <code class=\"link-text\">{{ activationLink }}</code>' +\n'        <button mat-icon-button' +\n'                color=\"primary\"' +\n'                ngxClipboard' +\n'                cbContent=\"{{ activationLink }}\"' +\n'                (cbOnSuccess)=\"onCopied()\"' +\n'                matTooltip=\"Copy to clipboard\"' +\n'                matTooltipPosition=\"above\"' +\n'                class=\"copy-btn\">' +\n'          <mat-icon>content_copy</mat-icon>' +\n'        </button>' +\n'      </div>' +\n'      <div class=\"copy-hint\" *ngIf=\"copied\">' +\n'        <mat-icon>check</mat-icon>' +\n'        <span>Copied to clipboard!</span>' +\n'      </div>' +\n'    </div>' +\n'    <div class=\"expiry-note\">' +\n'      <mat-icon>schedule</mat-icon>' +\n'      <span>This link will expire in 72 hours</span>' +\n'    </div>' +\n'  </div>' +\n'  <div class=\"activation-footer\">' +\n'    <button mat-raised-button color=\"primary\" (click)=\"close()\">' +\n'      <mat-icon>done</mat-icon>' +\n'      Done' +\n'    </button>' +\n'  </div>' +\n'</div>';\n\n    // Inject CSS\n    const css =\n'.activation-dialog {' +\n'  width: 480px;' +\n'  max-width: 95vw;' +\n'  font-family: Roboto, sans-serif;' +\n'  border-radius: 0;' +\n'  overflow: hidden;' +\n'  background: #fff;' +\n'}' +\n'.activation-header {' +\n'  display: flex;' +\n'  align-items: center;' +\n'  gap: 12px;' +\n'  padding: 16px 20px;' +\n'  background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);' +\n'  color: white;' +\n'}' +\n'.activation-header mat-icon {' +\n'  font-size: 24px;' +\n'  width: 24px;' +\n'  height: 24px;' +\n'}' +\n'.activation-header h2 {' +\n'  margin: 0;' +\n'  font-size: 18px;' +\n'  font-weight: 500;' +\n'}' +\n'.activation-header .close-btn {' +\n'  color: white;' +\n'}' +\n'.activation-body {' +\n'  padding: 24px;' +\n'  text-align: center;' +\n'}' +\n'.success-icon {' +\n'  width: 64px;' +\n'  height: 64px;' +\n'  margin: 0 auto 16px;' +\n'  background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(56, 142, 60, 0.15) 100%);' +\n'  border-radius: 50%;' +\n'  display: flex;' +\n'  align-items: center;' +\n'  justify-content: center;' +\n'}' +\n'.success-icon mat-icon {' +\n'  font-size: 32px;' +\n'  width: 32px;' +\n'  height: 32px;' +\n'  color: #4caf50;' +\n'}' +\n'.activation-info {' +\n'  color: #555;' +\n'  font-size: 14px;' +\n'  line-height: 1.6;' +\n'  margin-bottom: 20px;' +\n'}' +\n'.activation-info strong {' +\n'  color: #333;' +\n'}' +\n'.link-container {' +\n'  background: #f5f5f5;' +\n'  border: 1px solid #e0e0e0;' +\n'  border-radius: 8px;' +\n'  padding: 16px;' +\n'  text-align: left;' +\n'}' +\n'.link-label {' +\n'  display: flex;' +\n'  align-items: center;' +\n'  gap: 8px;' +\n'  color: #666;' +\n'  font-size: 12px;' +\n'  font-weight: 500;' +\n'  text-transform: uppercase;' +\n'  margin-bottom: 8px;' +\n'}' +\n'.link-label mat-icon {' +\n'  font-size: 16px;' +\n'  width: 16px;' +\n'  height: 16px;' +\n'}' +\n'.link-box {' +\n'  display: flex;' +\n'  align-items: center;' +\n'  gap: 8px;' +\n'  background: #fff;' +\n'  border: 1px solid #ddd;' +\n'  border-radius: 6px;' +\n'  padding: 8px 12px;' +\n'}' +\n'.link-text {' +\n'  flex: 1;' +\n'  font-size: 12px;' +\n'  color: #1976d2;' +\n'  word-break: break-all;' +\n'  font-family: monospace;' +\n'}' +\n'.copy-btn {' +\n'  flex-shrink: 0;' +\n'}' +\n'.copy-hint {' +\n'  display: flex;' +\n'  align-items: center;' +\n'  justify-content: center;' +\n'  gap: 6px;' +\n'  margin-top: 8px;' +\n'  color: #4caf50;' +\n'  font-size: 13px;' +\n'  font-weight: 500;' +\n'}' +\n'.copy-hint mat-icon {' +\n'  font-size: 16px;' +\n'  width: 16px;' +\n'  height: 16px;' +\n'}' +\n'.expiry-note {' +\n'  display: flex;' +\n'  align-items: center;' +\n'  justify-content: center;' +\n'  gap: 8px;' +\n'  margin-top: 16px;' +\n'  color: #888;' +\n'  font-size: 12px;' +\n'}' +\n'.expiry-note mat-icon {' +\n'  font-size: 16px;' +\n'  width: 16px;' +\n'  height: 16px;' +\n'}' +\n'.activation-footer {' +\n'  display: flex;' +\n'  justify-content: center;' +\n'  padding: 16px 20px;' +\n'  border-top: 1px solid #e0e0e0;' +\n'  background: #fafafa;' +\n'}' +\n'.activation-footer button mat-icon {' +\n'  margin-right: 8px;' +\n'}' +\n'.flex-1 {' +\n'  flex: 1;' +\n'}';\n\n    const styleId = 'activation-dialog-style';\n    if (!document.getElementById(styleId)) {\n      const styleEl = document.createElement('style');\n      styleEl.id = styleId;\n      styleEl.textContent = css;\n      document.head.appendChild(styleEl);\n    }\n\n    return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink, userEmail: userEmail});\n  }\n\n  function ActivationLinkDialogController(instance) {\n    var vm = instance;\n    vm.activationLink = instance.data.activationLink;\n    vm.userEmail = instance.data.userEmail;\n    vm.copied = false;\n\n    vm.onCopied = function() {\n      vm.copied = true;\n      setTimeout(function() {\n        vm.copied = false;\n      }, 3000);\n    };\n\n    vm.close = function() {\n      vm.dialogRef.close(null);\n    };\n  }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "act-add-user"
              }
            ]
          },
          "pageSize": 1024,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "borderRadius": "8"
        },
        "row": 0,
        "col": 0,
        "id": "aeae7803-eac3-1b63-938e-06dde5857ced",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "194af3d8-2a39-6523-a8b6-b6d3ad1da122": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1694019264779,
                "endTimeMs": 1694105664779
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Engineer",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "email",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Engineers",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "4128d7f0-9e28-5c7d-cf9a-b43cfe893568",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "Email",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5669544029828533
                },
                {
                  "name": "firstName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.first-name}",
                  "color": "#4caf50",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.835575628975763,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.last-name}",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7276117794959098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [],
            "actionCellButton": [
              {
                "name": "{i18n:custom.user-management.edit-user}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editUserFormGroup\"\n      (ngSubmit)=\"save()\"   class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{'custom.user-management.edit-smart-retail-engineer' | translate}}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('required')\">\n            {{'custom.user-management.email-is-required' | translate}}\n        </mat-error>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('pattern')\">\n            {{'custom.user-management.invalid-value-format' | translate}}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.first-name' | translate}}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.last-name' | translate}}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{'action.cancel' | translate}}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editUserFormGroup.invalid || !editUserFormGroup.dirty\">\n      {{'custom.user-management.save-user' | translate}}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\n\nopenEditUserDialog();\n\nfunction openEditUserDialog() {\n  customDialog.customDialog(htmlTemplate, EditUserDialogController).subscribe();\n}\n\nfunction EditUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.user = {};\n  \n  vm.editUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null]\n  });\n  \n  getUser();\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    vm.editUserFormGroup.markAsPristine();\n    saveUserObservable().subscribe(\n      function () {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      }\n    );\n  };\n  \n  function getUser() {\n      userService.getUser(entityId.id).subscribe(\n          (user) => {\n                vm.user = user;          \n                vm.editUserFormGroup.patchValue({\n                  email: vm.user.email,\n                  firstName: vm.user.firstName,\n                  lastName: vm.user.lastName\n                }, {emitEvent: false});\n          }\n    );\n  }\n  \n  function saveUserObservable() {\n      const formValues = vm.editUserFormGroup.value;\n      vm.user.email = formValues.email;\n      vm.user.firstName = formValues.firstName;\n      vm.user.lastName = formValues.lastName;\n      return userService.saveUser(vm.user);\n  }\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.user-management.delete-user}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteUserDialog();\n\nfunction openDeleteUserDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.user-management.delete.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.user-management.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteUser();\n    }\n  });\n}\n\nfunction deleteUser() {\n  userService.deleteUser(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.user-management.add-engineer}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addUserFormGroup\"\n      (ngSubmit)=\"save()\"   class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{'custom.user-management.add-smart-retail-engineer' | translate}}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n            {{'custom.user-management.email-is-required' | translate}}\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n            {{'custom.user-management.invalid-value-format' | translate}}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.first-name' | translate}}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.last-name' | translate}}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>{{'custom.user-management.activation-method' | translate}}</mat-label>\n        <mat-select formControlName=\"userActivationMethod\">\n            <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n                {{ method.name }}\n            </mat-option>\n        </mat-select>\n    </mat-form-field>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{'action.cancel' | translate}}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      {{'custom.user-management.save-user' | translate}}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.activationMethods = [\n        {\n            value: 'displayActivationLink',\n            name: translationService.instant('custom.user-management.display-activation-link')\n        },\n        {\n            value: 'sendActivationMail',\n            name: translationService.instant('custom.user-management.send-activation-email')\n        }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    userActivationMethod: ['displayActivationLink']\n  });\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    var customerId;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n    vm.addUserFormGroup.markAsPristine();\n    \n    const formValues = vm.addUserFormGroup.value;\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n    const sendActivationMail = (formValues.userActivationMethod === 'sendActivationMail');\n    \n    widgetContext.rxjs.forkJoin([\n        getTargetUserGroup(customerId), \n        getDashboardByName('Smart Diagnostics')\n    ]).pipe(\n        widgetContext.rxjs.switchMap((data) => {\n            /*console.log(data[1]);*/\n            var userGroup = data[0];\n            var defaultDashboard = data[1];\n            if (defaultDashboard) {\n                user.additionalInfo = {\n                    defaultDashboardId: defaultDashboard.id.id,\n                    defaultDashboardFullscreen: true\n                };\n            }\n            /*console.log(\"user\", user);*/\n            return saveUserObservable(userGroup, user, sendActivationMail);\n        }),\n        // Added switchMap to save the 'role' attribute after the user is saved\n        widgetContext.rxjs.switchMap((savedUser) => {\n            // Define the attribute to be saved\n            const roleAttribute = {\n                key: 'role',\n                value: 'Belimo Retrofit Engineer'\n            };\n            \n            // Call the attributeService to save the attribute\n            return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n                // Pass the savedUser to the next operator\n                widgetContext.rxjs.map(() => savedUser)\n            );\n        })\n    ).subscribe((user) => {\n        widgetContext.updateAliases();\n        if (formValues.userActivationMethod === 'displayActivationLink') {\n            userService.getActivationLink(user.id.id).subscribe(\n                (activationLink) => {\n                    displayActivationLink(activationLink).subscribe(\n                        () => {\n                            vm.dialogRef.close(null);\n                        }\n                    );\n                }\n            );\n        } else {\n            vm.dialogRef.close(null);\n        }\n    });\n  };\n  \n  function saveUserObservable(userGroup, user, sendActivationMail) {\n      return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n  \n  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Engineer', customerId);\n          })\n      );\n  }\n  \n  function getOrCreateUserGroup(groups, groupName, customerId) {\n      var usersGroup = groups.find(group => group.name === groupName);\n      if (usersGroup) {\n          return widgetContext.rxjs.of(usersGroup);\n      } else {\n          usersGroup = {\n              type: 'USER',\n              name: groupName,\n              ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(usersGroup);\n      }\n  }\n  \n  function getDashboardByName(dashboardName) {\n      var dashboardsPageLink = widgetContext.pageLink(10, 0, dashboardName);\n      return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n          widgetContext.rxjs.map((data) => {\n            if (data.data.length) {\n                return data.data.find((dashboard) => dashboard.name === dashboardName);\n            } else {\n                return null;\n            }\n          })\n      );\n  }\n  \n    function displayActivationLink(activationLink) {\n        const template = '<form style=\"min-width: 400px;\">\\n' +\n            '  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\\n' +\n            '    <h2 translate>user.activation-link</h2>\\n' +\n            '        <span class=\"flex-1\"></span>\\n' +\n            '    <button mat-icon-button\\n' +\n            '            (click)=\"close()\"\\n' +\n            '            type=\"button\">\\n' +\n            '      <mat-icon class=\"material-icons\">close</mat-icon>\\n' +\n            '    </button>\\n' +\n            '  </mat-toolbar>\\n' +\n            '  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\\n' +\n            '  </mat-progress-bar>\\n' +\n            '  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\\n' +\n            '  <div mat-dialog-content tb-toast toastTarget=\"activationLinkDialogContent\">\\n' +\n            '    <div class=\"flex flex-col gap-0 sm:gap-2\">\\n' +\n            '      <span [innerHTML]=\"\\'user.activation-link-text\\' | translate: {activationLink: activationLink}\"></span>\\n' +\n            '      <div class=\"flex justify-center items-center\">\\n' +\n            '        <pre class=\"tb-highlight\" class=\"flex\"><code>{{ activationLink }}</code></pre>\\n' +\n            '        <button mat-icon-button\\n' +\n            '                color=\"primary\"\\n' +\n            '                ngxClipboard\\n' +\n            '                cbContent=\"{{ activationLink }}\"\\n' +\n            '                (cbOnSuccess)=\"onActivationLinkCopied()\"\\n' +\n            '                matTooltip=\"{{ \\'user.copy-activation-link\\' | translate }}\"\\n' +\n            '                matTooltipPosition=\"above\">\\n' +\n            '          <mat-icon svgIcon=\"mdi:clipboard-arrow-left\"></mat-icon>\\n' +\n            '        </button>\\n' +\n            '      </div>\\n' +\n            '    </div>\\n' +\n            '  </div>\\n' +\n            '  <div mat-dialog-actions class=\"flex justify-end gap-2\">\\n' +\n            '    <button mat-button color=\"primary\"\\n' +\n            '            type=\"button\"\\n' +\n            '            cdkFocusInitial\\n' +\n            '            [disabled]=\"(isLoading$ | async)\"\\n' +\n            '            (click)=\"close()\">\\n' +\n            '      {{ \\'action.ok\\' | translate }}\\n' +\n            '    </button>\\n' +\n            '  </div>\\n' +\n            '</form>';\n        return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink});\n    }\n\n    function ActivationLinkDialogController(instance) {\n        var vm = instance;\n\n        vm.activationLink = instance.data.activationLink;\n\n        vm.onActivationLinkCopied = onActivationLinkCopied;\n        vm.close = close;\n\n        function onActivationLinkCopied(){\n            widgetContext.showSuccessToast(translate.instant('user.activation-link-copied-message'), 1000, 'bottom', 'left', 'activationLinkDialogContent');\n        }\n\n        function close() {\n            vm.dialogRef.close(null);\n        }\n    }\n  \n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "194af3d8-2a39-6523-a8b6-b6d3ad1da122",
        "typeFullFqn": "system.cards.entities_table"
      },
      "b3c998fc-8be3-ce73-5aae-106175ea0bb9": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1694019264779,
                "endTimeMs": 1694105664779
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Administrators",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "email",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Administrators",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "1cab31a1-6ad5-e39d-7798-e0dfee1cd61c",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "Email",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5669544029828533
                },
                {
                  "name": "firstName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.first-name}",
                  "color": "#4caf50",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.835575628975763,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.last-name}",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7276117794959098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [],
            "actionCellButton": [
              {
                "name": "{i18n:custom.user-management.edit-user}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editUserFormGroup\"\n      (ngSubmit)=\"save()\"  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n     <h2 class=\"text-lg font-semibold\">{{'custom.user-management.edit-smart-retail-administrator' | translate}}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('required')\">\n            {{'custom.user-management.email-is-required' | translate}}\n        </mat-error>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('pattern')\">\n            {{'custom.user-management.invalid-value-format' | translate}}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.first-name' | translate}}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.last-name' | translate}}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{'action.cancel' | translate}}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editUserFormGroup.invalid || !editUserFormGroup.dirty\">\n      {{'custom.user-management.save-user' | translate}}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\n\nopenEditUserDialog();\n\nfunction openEditUserDialog() {\n  customDialog.customDialog(htmlTemplate, EditUserDialogController).subscribe();\n}\n\nfunction EditUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.user = {};\n  \n  vm.editUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null]\n  });\n  \n  getUser();\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    vm.editUserFormGroup.markAsPristine();\n    saveUserObservable().subscribe(\n      function () {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      }\n    );\n  };\n  \n  function getUser() {\n      userService.getUser(entityId.id).subscribe(\n          (user) => {\n                vm.user = user;          \n                vm.editUserFormGroup.patchValue({\n                  email: vm.user.email,\n                  firstName: vm.user.firstName,\n                  lastName: vm.user.lastName\n                }, {emitEvent: false});\n          }\n    );\n  }\n  \n  function saveUserObservable() {\n      const formValues = vm.editUserFormGroup.value;\n      vm.user.email = formValues.email;\n      vm.user.firstName = formValues.firstName;\n      vm.user.lastName = formValues.lastName;\n      return userService.saveUser(vm.user);\n  }\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.user-management.delete-user}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteUserDialog();\n\nfunction openDeleteUserDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.user-management.delete.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.user-management.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteUser();\n    }\n  });\n}\n\nfunction deleteUser() {\n  userService.deleteUser(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.user-management.add-administrator}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addUserFormGroup\"\n      (ngSubmit)=\"save()\"  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.user-management.add-smart-retail-administrator' | translate }}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n            {{ 'custom.user-management.email-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n            {{ 'custom.user-management.invalid-value-format' | translate }}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.first-name' | translate }}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.last-name' | translate }}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>{{ 'custom.user-management.activation-method' | translate }}</mat-label>\n        <mat-select formControlName=\"userActivationMethod\">\n            <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n                {{ method.name }}\n            </mat-option>\n        </mat-select>\n    </mat-form-field>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      {{ 'custom.user-management.add-user' | translate }}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.activationMethods = [\n        {\n            value: 'displayActivationLink',\n            name: translationService.instant('custom.user-management.display-activation-link')\n        },\n        {\n            value: 'sendActivationMail',\n            name: translationService.instant('custom.user-management.send-activation-email')\n        }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    userActivationMethod: ['displayActivationLink']\n  });\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    var customerId;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n    vm.addUserFormGroup.markAsPristine();\n    \n    const formValues = vm.addUserFormGroup.value;\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n    const sendActivationMail = (formValues.userActivationMethod === 'sendActivationMail');\n    \n    widgetContext.rxjs.forkJoin([\n        getTargetUserGroup(customerId), \n        getDashboardByName('Smart Diagnostic Administration')\n    ]).pipe(\n        widgetContext.rxjs.switchMap((data) => {\n            /*console.log(data[1]);*/\n            var userGroup = data[0];\n            var defaultDashboard = data[1];\n            if (defaultDashboard) {\n                user.additionalInfo = {\n                    defaultDashboardId: defaultDashboard.id.id,\n                    defaultDashboardFullscreen: true\n                };\n            }\n            /*console.log(\"user\", user);*/\n            return saveUserObservable(userGroup, user, sendActivationMail);\n        }),\n        // Added switchMap to save the 'role' attribute after the user is saved\n        widgetContext.rxjs.switchMap((savedUser) => {\n            // Define the attribute to be saved\n            const roleAttribute = {\n                key: 'role',\n                value: 'Belimo Retrofit Administrators'\n            };\n            \n            // Call the attributeService to save the attribute\n            return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n                // Pass the savedUser to the next operator\n                widgetContext.rxjs.map(() => savedUser)\n            );\n        })\n    ).subscribe((user) => {\n        widgetContext.updateAliases();\n        if (formValues.userActivationMethod === 'displayActivationLink') {\n            userService.getActivationLink(user.id.id).subscribe(\n                (activationLink) => {\n                    displayActivationLink(activationLink).subscribe(\n                        () => {\n                            vm.dialogRef.close(null);\n                        }\n                    );\n                }\n            );\n        } else {\n            vm.dialogRef.close(null);\n        }\n    });\n  };\n  \n  function saveUserObservable(userGroup, user, sendActivationMail) {\n      return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n  \n  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Administrators', customerId);\n          })\n      );\n  }\n  \n  function getOrCreateUserGroup(groups, groupName, customerId) {\n      var usersGroup = groups.find(group => group.name === groupName);\n      if (usersGroup) {\n          return widgetContext.rxjs.of(usersGroup);\n      } else {\n          usersGroup = {\n              type: 'USER',\n              name: groupName,\n              ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(usersGroup);\n      }\n  }\n  \n  function getDashboardByName(dashboardName) {\n      var dashboardsPageLink = widgetContext.pageLink(10, 0, dashboardName);\n      return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n          widgetContext.rxjs.map((data) => {\n            if (data.data.length) {\n                return data.data.find((dashboard) => dashboard.name === dashboardName);\n            } else {\n                return null;\n            }\n          })\n      );\n  }\n  \n    function displayActivationLink(activationLink) {\n        const template = '<form style=\"min-width: 400px;\">\\n' +\n            '  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\\n' +\n            '    <h2 translate>user.activation-link</h2>\\n' +\n            '        <span class=\"flex-1\"></span>\\n' +\n            '    <button mat-icon-button\\n' +\n            '            (click)=\"close()\"\\n' +\n            '            type=\"button\">\\n' +\n            '      <mat-icon class=\"material-icons\">close</mat-icon>\\n' +\n            '    </button>\\n' +\n            '  </mat-toolbar>\\n' +\n            '  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\\n' +\n            '  </mat-progress-bar>\\n' +\n            '  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\\n' +\n            '  <div mat-dialog-content tb-toast toastTarget=\"activationLinkDialogContent\">\\n' +\n            '    <div class=\"flex flex-col gap-0 sm:gap-2\">\\n' +\n            '      <span [innerHTML]=\"\\'user.activation-link-text\\' | translate: {activationLink: activationLink}\"></span>\\n' +\n            '      <div class=\"flex justify-center items-center\">\\n' +\n            '        <pre class=\"tb-highlight\" class=\"flex\"><code>{{ activationLink }}</code></pre>\\n' +\n            '        <button mat-icon-button\\n' +\n            '                color=\"primary\"\\n' +\n            '                ngxClipboard\\n' +\n            '                cbContent=\"{{ activationLink }}\"\\n' +\n            '                (cbOnSuccess)=\"onActivationLinkCopied()\"\\n' +\n            '                matTooltip=\"{{ \\'user.copy-activation-link\\' | translate }}\"\\n' +\n            '                matTooltipPosition=\"above\">\\n' +\n            '          <mat-icon svgIcon=\"mdi:clipboard-arrow-left\"></mat-icon>\\n' +\n            '        </button>\\n' +\n            '      </div>\\n' +\n            '    </div>\\n' +\n            '  </div>\\n' +\n            '  <div mat-dialog-actions class=\"flex justify-end gap-2\">\\n' +\n            '    <button mat-button color=\"primary\"\\n' +\n            '            type=\"button\"\\n' +\n            '            cdkFocusInitial\\n' +\n            '            [disabled]=\"(isLoading$ | async)\"\\n' +\n            '            (click)=\"close()\">\\n' +\n            '      {{ \\'action.ok\\' | translate }}\\n' +\n            '    </button>\\n' +\n            '  </div>\\n' +\n            '</form>';\n        return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink});\n    }\n\n    function ActivationLinkDialogController(instance) {\n        var vm = instance;\n\n        vm.activationLink = instance.data.activationLink;\n\n        vm.onActivationLinkCopied = onActivationLinkCopied;\n        vm.close = close;\n\n        function onActivationLinkCopied(){\n            widgetContext.showSuccessToast(translate.instant('user.activation-link-copied-message'), 1000, 'bottom', 'left', 'activationLinkDialogContent');\n        }\n\n        function close() {\n            vm.dialogRef.close(null);\n        }\n    }\n  \n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "b3c998fc-8be3-ce73-5aae-106175ea0bb9",
        "typeFullFqn": "system.cards.entities_table"
      }
    },
    "states": {
      "default": {
        "name": "Smart Diagnostic Administration",
        "root": true,
        "layouts": {
          "main": {
            "widgets": {
              "c2559a58-e82d-3250-7e35-f520ced0d916": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "eco_administration": {
        "name": "ECO Administration",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "777ded27-e3b8-d901-ca42-3079a23f7a12": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "customer_administration": {
        "name": "Customer Administration",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "2131ced7-032b-7d7f-1c04-917bd7a89699": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": false,
              "layoutType": "default",
              "minColumns": 24,
              "viewFormat": "grid",
              "rowHeight": 70
            }
          }
        }
      },
      "manage_users": {
        "name": "manage_users",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "aeae7803-eac3-1b63-938e-06dde5857ced": {
                "sizeX": 100,
                "sizeY": 45,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#eeeeee",
              "columns": 100,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "manage_projects": {
        "name": "manage_projects",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "f5be3f90-8574-86fb-1e71-7381ecb6956d": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default",
              "minColumns": 24,
              "viewFormat": "grid",
              "rowHeight": 70
            }
          }
        }
      },
      "manage_diagnostickits": {
        "name": "manage_diagnostickits",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "c6b19443-5057-176b-d3f8-2eebb67fc35e": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "selected_project_header": {
        "name": "selected_project_header",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "65f06cd0-359d-d0bf-f7aa-8f4700ea7d44": {
                "sizeX": 24,
                "sizeY": 7,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "selected_project_map": {
        "name": "selected_project_map",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "03ceaaed-0eb5-4d4e-a3ef-0c4394cb2cb8": {
                "sizeX": 24,
                "sizeY": 14,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "project_measurements": {
        "name": "project_measurements",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "4ebd4327-6b2e-432c-9f12-5d87a6ca7e76": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "projects_map": {
        "name": "projects_map",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "40680065-1e6b-c6f8-af6a-23e82a99fad9": {
                "sizeX": 24,
                "sizeY": 14,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "projects_all": {
        "name": "projects_all",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "fb924e54-6e4b-2d41-5545-dab85e028210": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "manage_diagnostickits_admin": {
        "name": "manage_diagnostickits_admin",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "d6393653-ccec-edf8-4bd7-520334011adb": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": false,
              "layoutType": "default",
              "minColumns": 24,
              "viewFormat": "grid",
              "rowHeight": 70
            }
          }
        }
      },
      "manage_diagnostickits_customer": {
        "name": "manage_diagnostickits_customer",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "ed6cf40c-1c37-2fe9-4436-22c669817f3e": {
                "sizeX": 25,
                "sizeY": 12,
                "row": 0,
                "col": 0
              },
              "4cc2a279-fbae-dce8-0827-5a24057fe53e": {
                "sizeX": 25,
                "sizeY": 13,
                "row": 12,
                "col": 0,
                "mobileHide": true,
                "desktopHide": true
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "user_readonly": {
        "name": "User Read only",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "c12ec825-a7ef-cc4d-da3d-064fba7cc7d7": {
                "sizeX": 33,
                "sizeY": 48,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 100,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "user_engineers": {
        "name": "User Engineers",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "194af3d8-2a39-6523-a8b6-b6d3ad1da122": {
                "sizeX": 33,
                "sizeY": 48,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 100,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "user_admininistrators": {
        "name": "User Administrators",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "b3c998fc-8be3-ce73-5aae-106175ea0bb9": {
                "sizeX": 33,
                "sizeY": 48,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 100,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      }
    },
    "entityAliases": {
      "1c348dad-e738-a4db-5e7e-4c0271790ab7": {
        "id": "1c348dad-e738-a4db-5e7e-4c0271790ab7",
        "alias": "Doktorkits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Doktorkit"
          ]
        }
      },
      "d13f6078-0d81-ec59-529c-64acbbcaf470": {
        "id": "d13f6078-0d81-ec59-529c-64acbbcaf470",
        "alias": "Doktorkit Devices",
        "filter": {
          "type": "deviceSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedDoktorkit",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "deviceTypes": [
            "P-Flow D116",
            "Room Sensor CO2",
            "Room Sensor T",
            "Temperature Sensor",
            "Gateway",
            "RESI",
            "LTE Status"
          ]
        }
      },
      "04917190-aea7-e407-e308-4598f1671a71": {
        "id": "04917190-aea7-e407-e308-4598f1671a71",
        "alias": "Retrofit Partner",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": false,
          "stateEntityParamName": "selectedCustomer",
          "groupType": "CUSTOMER",
          "entityGroupNameFilter": "Belimo Retrofit"
        }
      },
      "7add11d8-cbf7-fd15-6b12-d5df058f11fa": {
        "id": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
        "alias": "Selected Doktorkit",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedDoktorkit",
          "defaultStateEntity": null
        }
      },
      "984b0bbe-9a03-40ac-90f0-31db7e70dc8c": {
        "id": "984b0bbe-9a03-40ac-90f0-31db7e70dc8c",
        "alias": "Customer Doktorkit Devices",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Doktorkit Devices"
        }
      },
      "60f60877-be45-311d-9ee7-25b68c466d89": {
        "id": "60f60877-be45-311d-9ee7-25b68c466d89",
        "alias": "Customer Doktorkit Gateways",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Gateways"
        }
      },
      "fe796be3-ffda-37f5-f182-7fb7fcd53f31": {
        "id": "fe796be3-ffda-37f5-f182-7fb7fcd53f31",
        "alias": "Selected device",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedDevice",
          "defaultStateEntity": null
        }
      },
      "21d657b1-d301-fa72-ed75-6e2000eb5e51": {
        "id": "21d657b1-d301-fa72-ed75-6e2000eb5e51",
        "alias": "Retrofit Partner All",
        "filter": {
          "type": "entityType",
          "resolveMultiple": true,
          "entityType": "CUSTOMER"
        }
      },
      "df6ecbc0-0dae-bc9b-fbeb-96b5c11f9ebc": {
        "id": "df6ecbc0-0dae-bc9b-fbeb-96b5c11f9ebc",
        "alias": "{i18n:custom.diagnostics.projects.title}",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Project"
          ]
        }
      },
      "f765d469-eafe-c53b-d010-c75a39278cad": {
        "id": "f765d469-eafe-c53b-d010-c75a39278cad",
        "alias": "Measurements",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedProject",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Measurement"
          ]
        }
      },
      "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4": {
        "id": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
        "alias": "Selected Measurement",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null
        }
      },
      "faef915b-be60-5c6b-d62c-114957e80421": {
        "id": "faef915b-be60-5c6b-d62c-114957e80421",
        "alias": "Selected Project",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedProject",
          "defaultStateEntity": null
        }
      },
      "ab402d1e-d547-fc07-708c-2b7bb8306205": {
        "id": "ab402d1e-d547-fc07-708c-2b7bb8306205",
        "alias": "Selected Sensorkit",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedSensorkit",
          "defaultStateEntity": null
        }
      },
      "c81ac24b-34f8-946b-bf95-1609f607c82b": {
        "id": "c81ac24b-34f8-946b-bf95-1609f607c82b",
        "alias": "Sensorkits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Sensorkit"
          ]
        }
      },
      "f3353dc6-c514-fb37-dc74-73bbeb9d1921": {
        "id": "f3353dc6-c514-fb37-dc74-73bbeb9d1921",
        "alias": "Sensorkit Devices",
        "filter": {
          "type": "deviceSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedSensorkit",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "deviceTypes": [
            "Room Sensor CO2",
            "Room Sensor T"
          ]
        }
      },
      "950424d2-bccd-42c2-76a9-603429eed3f1": {
        "id": "950424d2-bccd-42c2-76a9-603429eed3f1",
        "alias": "Customer Sensorkit Devices",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Sensorkit Devices"
        }
      },
      "8c78ecdd-7a95-af08-137b-3cf7bc54edb4": {
        "id": "8c78ecdd-7a95-af08-137b-3cf7bc54edb4",
        "alias": "Customer Sensorkit Gateways",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": false,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Gateways"
        }
      },
      "62e540a9-69d4-98ce-afbc-1c3f7bc147a5": {
        "id": "62e540a9-69d4-98ce-afbc-1c3f7bc147a5",
        "alias": "Devices",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Diagnostickit Devices"
        }
      },
      "1a8c3475-c3d9-20d2-32e4-fa4dfc96c9a2": {
        "id": "1a8c3475-c3d9-20d2-32e4-fa4dfc96c9a2",
        "alias": "Measurement Doktorkit",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "assetTypes": [
            "Doktorkit"
          ]
        }
      },
      "95a1ca8c-a5d5-e4fd-98e0-d85640112887": {
        "id": "95a1ca8c-a5d5-e4fd-98e0-d85640112887",
        "alias": "Measurement Sensorkit",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "assetTypes": [
            "Sensorkit"
          ]
        }
      },
      "7a3ac371-a996-ee2e-8652-6fab5a79027c": {
        "id": "7a3ac371-a996-ee2e-8652-6fab5a79027c",
        "alias": "All Measurements",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Measurement"
          ]
        }
      },
      "2519c941-a1b9-45bd-9821-88acf22e10af": {
        "id": "2519c941-a1b9-45bd-9821-88acf22e10af",
        "alias": "All Diagnostic Kits",
        "filter": {
          "type": "assetType",
          "resolveMultiple": true,
          "assetTypes": [
            "Diagnostickit"
          ],
          "assetNameFilter": ""
        }
      },
      "88a32db8-5dd9-f8b4-28b9-5e18c7c86c68": {
        "id": "88a32db8-5dd9-f8b4-28b9-5e18c7c86c68",
        "alias": "All Sensorkits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Sensorkit"
          ]
        }
      },
      "80b77cd9-f10d-6774-e609-cdfced593359": {
        "id": "80b77cd9-f10d-6774-e609-cdfced593359",
        "alias": "Selected Kit",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedKit",
          "defaultStateEntity": null
        }
      },
      "89a624d9-5882-ac3f-5001-e709d73e75f1": {
        "id": "89a624d9-5882-ac3f-5001-e709d73e75f1",
        "alias": "All Kits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Sensorkit",
            "Doktorkit"
          ]
        }
      },
      "186b00f3-5c8d-7cab-7654-f96a15d58d64": {
        "id": "186b00f3-5c8d-7cab-7654-f96a15d58d64",
        "alias": "Devices All",
        "filter": {
          "type": "deviceSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedCustomer",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "deviceTypes": [
            "Gateway",
            "IoT Gateway",
            "IoT Gateway Device",
            "MUC",
            "P-Flow D116",
            "Room Sensor CO2",
            "Room Sensor T",
            "Temperature Sensor"
          ]
        }
      },
      "e76453a1-85ff-af7f-4d86-60a8dd65f0a3": {
        "id": "e76453a1-85ff-af7f-4d86-60a8dd65f0a3",
        "alias": "Customer",
        "filter": {
          "type": "entityGroup",
          "resolveMultiple": true,
          "groupStateEntity": false,
          "stateEntityParamName": null,
          "defaultStateGroupType": null,
          "defaultStateEntityGroup": null,
          "groupType": "CUSTOMER",
          "entityGroup": "0a9a8ea0-bfae-11ee-80de-5de32813ef75"
        }
      },
      "09a7d069-f810-fea9-8e3d-4309f4a424ae": {
        "id": "09a7d069-f810-fea9-8e3d-4309f4a424ae",
        "alias": "Current Customer",
        "filter": {
          "type": "stateEntityOwner",
          "resolveMultiple": false,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_CUSTOMER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          }
        }
      },
      "11f99ccd-3fff-0e24-7f43-355d961fffcb": {
        "id": "11f99ccd-3fff-0e24-7f43-355d961fffcb",
        "alias": "Measurement Devices",
        "filter": {
          "type": "deviceSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Measurement",
          "deviceTypes": [
            "P-Flow D116",
            "Temperature Sensor",
            "Room Sensor T",
            "Room Sensor CO2",
            "LoRaWAN Gateway",
            "RESI",
            "LTE Status"
          ]
        }
      },
      "fbfce281-668f-0ad0-d8f4-6870d3ef679f": {
        "id": "fbfce281-668f-0ad0-d8f4-6870d3ef679f",
        "alias": "Belimo Retrofit Users",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "USER",
          "entityGroupNameFilter": "Belimo Retrofit User"
        }
      },
      "1cab31a1-6ad5-e39d-7798-e0dfee1cd61c": {
        "id": "1cab31a1-6ad5-e39d-7798-e0dfee1cd61c",
        "alias": "Belimo Retrofit Administrators",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "USER",
          "entityGroupNameFilter": "Belimo Retrofit Administrators"
        }
      },
      "4128d7f0-9e28-5c7d-cf9a-b43cfe893568": {
        "id": "4128d7f0-9e28-5c7d-cf9a-b43cfe893568",
        "alias": "Belimo Retrofit Engineer",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "USER",
          "entityGroupNameFilter": "Belimo Retrofit Engineer"
        }
      },
      "9c45e942-79a2-d41b-37dd-9e0d461a6c7c": {
        "id": "9c45e942-79a2-d41b-37dd-9e0d461a6c7c",
        "alias": "Location Areas",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedLocation",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": null,
          "assetTypes": [
            "Area"
          ]
        }
      },
      "1ba8ad72-6096-f5aa-d8ef-7d58e375fab2": {
        "id": "1ba8ad72-6096-f5aa-d8ef-7d58e375fab2",
        "alias": "Selected Location",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedLocation",
          "defaultStateEntity": null
        }
      },
      "203b0867-b867-ef98-1791-03046c133b7d": {
        "id": "203b0867-b867-ef98-1791-03046c133b7d",
        "alias": "Current User",
        "filter": {
          "type": "singleEntity",
          "resolveMultiple": false,
          "singleEntity": {
            "entityType": "CURRENT_USER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          }
        }
      },
      "d75c5b86-8b39-59e2-59f3-ae1c1ee40910": {
        "id": "d75c5b86-8b39-59e2-59f3-ae1c1ee40910",
        "alias": "Project",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Project"
          ]
        }
      },
      "c849d52c-a3c7-5008-a4c0-c2d0406fe515": {
        "id": "c849d52c-a3c7-5008-a4c0-c2d0406fe515",
        "alias": "Project Measurements",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedProject",
          "defaultStateEntity": null,
          "rootEntity": {
            "entityType": "CURRENT_CUSTOMER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Measurement"
          ]
        }
      },
      "a11b6c4c-e7f7-210b-79a7-2b5de01a5f87": {
        "id": "a11b6c4c-e7f7-210b-79a7-2b5de01a5f87",
        "alias": "All Users",
        "filter": {
          "type": "entityType",
          "resolveMultiple": true,
          "entityType": "USER"
        }
      },
      "b9cbe0a5-7efe-a173-4f8f-81c7c69ed24c": {
        "id": "b9cbe0a5-7efe-a173-4f8f-81c7c69ed24c",
        "alias": "All Projects",
        "filter": {
          "type": "assetType",
          "resolveMultiple": true,
          "assetTypes": [
            "Project"
          ],
          "assetNameFilter": ""
        }
      },
      "5756b066-5420-ac35-5dfd-ddb1eb93d63e": {
        "id": "5756b066-5420-ac35-5dfd-ddb1eb93d63e",
        "alias": "Current owner",
        "filter": {
          "type": "singleEntity",
          "resolveMultiple": false,
          "singleEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          }
        }
      },
      "4439d614-62ea-e55e-6214-25cffa4a7358": {
        "id": "4439d614-62ea-e55e-6214-25cffa4a7358",
        "alias": "Customer Projects",
        "filter": {
          "type": "relationsQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "filters": [
            {
              "relationType": "Owns",
              "entityTypes": [
                "ASSET"
              ],
              "negate": false
            }
          ]
        }
      },
      "0d59106c-3aec-67d1-e5c6-1bea2904541b": {
        "id": "0d59106c-3aec-67d1-e5c6-1bea2904541b",
        "alias": "Customer Diagnostic Kits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Diagnostickit"
          ]
        }
      }
    },
    "filters": {
      "6399251d-d843-e4ee-9b39-3a7096b8ef07": {
        "id": "6399251d-d843-e4ee-9b39-3a7096b8ef07",
        "filter": "Project",
        "keyFilters": [
          {
            "key": {
              "type": "ENTITY_FIELD",
              "key": "type"
            },
            "valueType": "STRING",
            "predicates": [
              {
                "keyFilterPredicate": {
                  "operation": "EQUAL",
                  "value": {
                    "defaultValue": "Project",
                    "dynamicValue": null
                  },
                  "ignoreCase": false,
                  "type": "STRING"
                },
                "userInfo": {
                  "editable": true,
                  "label": "",
                  "autogeneratedLabel": true,
                  "order": 0
                }
              }
            ]
          }
        ],
        "editable": true
      },
      "82f574c5-8303-0be1-01fa-b108c6097a90": {
        "id": "82f574c5-8303-0be1-01fa-b108c6097a90",
        "filter": "Devices",
        "keyFilters": [
          {
            "key": {
              "type": "ENTITY_FIELD",
              "key": "type"
            },
            "valueType": "STRING",
            "predicates": [
              {
                "keyFilterPredicate": {
                  "operation": "OR",
                  "predicates": [
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "Temperature Sensor",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "P-Flow D116",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "Room Sensor T",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "Room Sensor CO2",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "LTE Status",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    }
                  ],
                  "type": "COMPLEX"
                },
                "userInfo": {
                  "editable": true,
                  "label": "",
                  "autogeneratedLabel": true,
                  "order": 0
                }
              }
            ]
          }
        ],
        "editable": true
      },
      "3744b253-8d5c-7528-b178-0c8be5c3adca": {
        "id": "3744b253-8d5c-7528-b178-0c8be5c3adca",
        "filter": "Progress filter projects",
        "keyFilters": [
          {
            "key": {
              "type": "ATTRIBUTE",
              "key": "progress"
            },
            "valueType": "STRING",
            "predicates": [
              {
                "keyFilterPredicate": {
                  "operation": "OR",
                  "predicates": [
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "in preparation",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayPreparationMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "active",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayActiveMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "finished",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayFinishedMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "in preperation",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    }
                  ],
                  "type": "COMPLEX"
                },
                "userInfo": {
                  "editable": true,
                  "label": "",
                  "autogeneratedLabel": true,
                  "order": 0
                }
              }
            ]
          }
        ],
        "editable": false
      },
      "8366ab5b-1381-2841-d917-ec7a70bd8d7c": {
        "id": "8366ab5b-1381-2841-d917-ec7a70bd8d7c",
        "filter": "Progress filter",
        "keyFilters": [
          {
            "key": {
              "type": "ATTRIBUTE",
              "key": "progress"
            },
            "valueType": "STRING",
            "predicates": [
              {
                "keyFilterPredicate": {
                  "operation": "OR",
                  "predicates": [
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "in preparation",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayPreparationMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "active",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayActiveMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "finished",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayFinishedMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "aborted",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayAbortedMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "in preperation",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    }
                  ],
                  "type": "COMPLEX"
                },
                "userInfo": {
                  "editable": true,
                  "label": "",
                  "autogeneratedLabel": true,
                  "order": 0
                }
              }
            ]
          }
        ],
        "editable": false
      }
    },
    "timewindow": {
      "displayValue": "",
      "hideAggregation": false,
      "hideAggInterval": false,
      "hideTimezone": false,
      "selectedTab": 0,
      "realtime": {
        "realtimeType": 0,
        "interval": 1000,
        "timewindowMs": 60000,
        "quickInterval": "CURRENT_DAY"
      },
      "history": {
        "historyType": 0,
        "interval": 1000,
        "timewindowMs": 60000,
        "fixedTimewindow": {
          "startTimeMs": 1639908545606,
          "endTimeMs": 1639994945606
        },
        "quickInterval": "CURRENT_DAY"
      },
      "aggregation": {
        "type": "AVG",
        "limit": 25000
      }
    },
    "settings": {
      "stateControllerId": "entity",
      "showTitle": false,
      "showDashboardsSelect": true,
      "showEntitiesSelect": false,
      "showDashboardTimewindow": false,
      "showDashboardExport": true,
      "toolbarAlwaysOpen": true,
      "titleColor": "rgba(0,0,0,0.870588)",
      "showDashboardLogo": false,
      "dashboardLogoUrl": null,
      "hideToolbar": false,
      "showFilters": false,
      "showUpdateDashboardImage": false,
      "dashboardCss": ".tb-widget-container > .tb-widget {\n    border-radius: 8px;\n}\n\n.tb-widget-container {\n    border-radius: 8px;\n}\n\n\ngridster-item:not(.tb-noselect) > .tb-widget-container > .tb-widget {\n    cursor: default !important;\n}\n\n.tb-widget-container > .tb-widget .tb-table-widget .mat-mdc-row {\n    cursor: pointer;\n}\n\n.tb-widget-container > .tb-widget .tb-legend-keys {\n    cursor: pointer;\n}\n\n.tb-widget-container > .tb-widget .tb-markdown-view .tb-progress-cover, .tb-widget-container > .tb-widget .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-widget-container > .tb-widget .tb-markdown-view div, .tb-widget-container > .tb-widget .tb-markdown-view p {\n    line-height: normal;\n}\n\n"
    }
  },
  "name": "Administration",
  "resources": null,
  "id": {
    "entityType": "DASHBOARD",
    "id": "d0012340-f6be-11f0-9979-9f3434877bb4"
  },
  "createdTime": 1768995984244,
  "tenantId": {
    "entityType": "TENANT",
    "id": "efb63c10-b576-11ee-a6c2-a149ed03c64d"
  },
  "customerId": null,
  "assignedCustomers": null,
  "externalId": {
    "entityType": "DASHBOARD",
    "id": "d0012340-f6be-11f0-9979-9f3434877bb4"
  },
  "version": 339,
  "ownerId": {
    "entityType": "TENANT",
    "id": "efb63c10-b576-11ee-a6c2-a149ed03c64d"
  }
}