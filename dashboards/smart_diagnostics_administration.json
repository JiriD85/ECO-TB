{
  "title": "Smart Diagnostic Administration",
  "image": "tb-image;/api/images/tenant/belimo_retrofit_plus_padding.png",
  "mobileHide": false,
  "mobileOrder": 2,
  "configuration": {
    "description": "",
    "widgets": {
      "777ded27-e3b8-d901-ca42-3079a23f7a12": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Retrofit Partner",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "false",
            "displayEntityName": true,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 15,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Retrofit companies",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "21d657b1-d301-fa72-ed75-6e2000eb5e51",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "{i18n:custom.retrofit-companies.address}",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "70%",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.1345774127559587,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "{i18n:custom.retrofit-companies.manage-projects}",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Projects",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "5e50c296-0eac-8841-a69a-1cbbfe04d1c5"
              }
            ],
            "actionCellButton": [
              {
                "name": "{i18n:custom.retrofit-companies.manage-gateways}",
                "icon": "router",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "gateways",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "2bb38f25-6b60-0a00-6ef8-8b8656ac8d0d"
              },
              {
                "name": "{i18n:custom.retrofit-companies.manage-devices}",
                "icon": "devices_other",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "devices",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1ff495e4-f4af-3172-63c3-14c96faf3307"
              },
              {
                "name": "{i18n:custom.retrofit-companies.manage-projects}",
                "icon": "assignment",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Projects",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "5f052715-0e89-d43b-60f4-83de99f5e2ac"
              },
              {
                "name": "{i18n:custom.retrofit-companies.manage-diagnostic-kits}",
                "icon": "medical_services",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "doktorkits_all",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "ef986bd4-8ab7-fde5-79e7-52b3bb257474"
              },
              {
                "name": "{i18n:custom.retrofit-companies.manage-users}",
                "icon": "people",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "user",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "347536c1-e013-249a-c93e-acc1706de1bb"
              },
              {
                "name": "{i18n:custom.retrofit-companies.manage-payments}",
                "icon": "payments",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "updateDashboardState",
                "targetDashboardStateId": "payments",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "37fa425f-244c-591f-9f5e-33e396f7d1a7"
              },
              {
                "name": "{i18n:custom.retrofit-companies.edit-company}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editCompanyFormGroup\"\r\n      (ngSubmit)=\"save()\"  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n     <h2 class=\"text-lg font-semibold\">{{ 'custom.retrofit-companies.edit-company' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-company-title' | translate }}</mat-label>\r\n        <input matInput formControlName=\"title\" required>\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('title').hasError('required')\">\r\n          {{ 'custom.retrofit-companies.add-company-company-title-is-required' | translate }}\r\n        </mat-error>\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('title').hasError('maxlength')\">\r\n          {{ 'customer.title-max-length' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- Existing contact component -->\r\n      <tb-contact [parentForm]=\"editCompanyFormGroup\" [isEdit]=\"true\"></tb-contact>\r\n      \r\n      <!-- New field: Shortname -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-short-name' | translate }}</mat-label>\r\n        <input matInput formControlName=\"shortName\" required minlength=\"3\" maxlength=\"4\">\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('shortName').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-short-name-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- New field: Deadline for Cancelations (days) -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-cancelation-deadline' | translate }}</mat-label>\r\n        <input matInput type=\"number\" formControlName=\"cancelDeadline\">\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('cancelDeadline').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-cancelation-deadline-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- New field: Deadline for Payments (days) -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-payment-deadline' | translate }}</mat-label>\r\n        <input matInput type=\"number\" formControlName=\"paymentDeadline\">\r\n        <mat-error *ngIf=\"editCompanyFormGroup.get('paymentDeadline').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-payment-deadline-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n  </div>\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button mat-button color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\" cdkFocusInitial>\r\n      {{ 'action.cancel' | translate }}\r\n    </button>\r\n    <button mat-button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(isLoading$ | async) || editCompanyFormGroup.invalid || !editCompanyFormGroup.dirty\">\r\n      {{ 'custom.retrofit-companies.add-company-save-company' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "const POSTAL_CODE_PATTERNS = {\r\n  'United States': '(\\\\d{5}([\\\\-]\\\\d{4})?)',\r\n  'Australia': '[0-9]{4}',\r\n  'Austria': '[0-9]{4}',\r\n  'Belgium': '[0-9]{4}',\r\n  'Brazil': '[0-9]{5}[\\\\-]?[0-9]{3}',\r\n  'Canada': '^(?!.*[DFIOQU])[A-VXY][0-9][A-Z][ -]?[0-9][A-Z][0-9]$',\r\n  'Denmark': '[0-9]{3,4}',\r\n  'Faroe Islands': '[0-9]{3,4}',\r\n  'Netherlands': '[1-9][0-9]{3}\\\\s?[a-zA-Z]{2}',\r\n  'Germany': '[0-9]{5}',\r\n  'Hungary': '[0-9]{4}',\r\n  'Italy': '[0-9]{5}',\r\n  'Japan': '\\\\d{3}-\\\\d{4}',\r\n  'Luxembourg': '(L\\\\s*(-|—|–))\\\\s*?[\\\\d]{4}',\r\n  'Poland': '[0-9]{2}\\\\-[0-9]{3}',\r\n  'Spain': '((0[1-9]|5[0-2])|[1-4][0-9])[0-9]{3}',\r\n  'Sweden': '\\\\d{3}\\\\s?\\\\d{2}',\r\n  'United Kingdom': '[A-Za-z]{1,2}[0-9Rr][0-9A-Za-z]? [0-9][ABD-HJLNP-UW-Zabd-hjlnp-uw-z]{2}'\r\n};\r\n\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\n\r\nopenEditCompanyDialog();\r\n\r\nfunction openEditCompanyDialog() {\r\n  customDialog.customDialog(htmlTemplate, EditCompanyDialogController).subscribe();\r\n}\r\n\r\nfunction EditCompanyDialogController(instance) {\r\n  let vm = instance;\r\n  \r\n  vm.customer = {};\r\n\r\n  vm.editCompanyFormGroup = vm.fb.group({\r\n    title: ['', [vm.validators.required, vm.validators.maxLength(255)]]\r\n  });\r\n  \r\n  // Add existing form controls\r\n  vm.editCompanyFormGroup.addControl('country', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('city', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('state', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('zip', vm.fb.control('', zipValidators('')));\r\n  vm.editCompanyFormGroup.addControl('address', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('address2', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('phone', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('email', vm.fb.control('', [vm.validators.email]));\r\n  \r\n  // Add new controls for deadline fields\r\n  vm.editCompanyFormGroup.addControl('cancelDeadline', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('paymentDeadline', vm.fb.control('', []));\r\n  vm.editCompanyFormGroup.addControl('shortName', vm.fb.control('', []));\r\n  \r\n  // Update zip validators on country change\r\n  vm.editCompanyFormGroup.get('country').valueChanges.subscribe((country) => {\r\n    vm.editCompanyFormGroup.get('zip').setValidators(zipValidators(country));\r\n    vm.editCompanyFormGroup.get('zip').updateValueAndValidity({ onlySelf: true });\r\n    vm.editCompanyFormGroup.get('zip').markAsTouched({ onlySelf: true });\r\n  });\r\n  \r\n  getCompany();\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    vm.editCompanyFormGroup.markAsPristine();\r\n    saveCompanyObservable().subscribe(function (customer) {\r\n      widgetContext.rxjs.forkJoin([\r\n          saveAttributes(customer)\r\n      ]).subscribe(function () {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n      });\r\n    });\r\n  };\r\n  \r\n  function getCompany() {\r\n    customerService.getCustomer(entityId.id).subscribe((customer) => {\r\n        attributeService.getEntityAttributes(customer.id, \"SERVER_SCOPE\", [\"cancelDeadline\",\"paymentDeadline\",\"shortName\"]).subscribe(attributes => {\r\n      const shortNameObj = attributes.find(item => item.key === \"shortName\");\r\n      const shortName = shortNameObj ? shortNameObj.value : \"\";\r\n      const paymentDeadlineObj = attributes.find(item => item.key === \"paymentDeadline\");\r\n      const paymentDeadline = paymentDeadlineObj ? paymentDeadlineObj.value : \"\";\r\n      const cancelDeadlineObj = attributes.find(item => item.key === \"cancelDeadline\");\r\n      const cancelDeadline = cancelDeadlineObj ? cancelDeadlineObj.value : \"\";\r\n      vm.customer = customer;\r\n      // Patch form with customer details including deadlines (if available)\r\n      vm.editCompanyFormGroup.patchValue({\r\n        title: vm.customer.title,\r\n        country: vm.customer.country,\r\n        city: vm.customer.city,\r\n        state: vm.customer.state,\r\n        zip: vm.customer.zip,\r\n        address: vm.customer.address,\r\n        address2: vm.customer.address2,\r\n        phone: vm.customer.phone,\r\n        email: vm.customer.email,\r\n        cancelDeadline: cancelDeadline || '',\r\n        paymentDeadline: paymentDeadline || '',\r\n        shortName: shortName || ''\r\n      }, { emitEvent: false });\r\n      vm.editCompanyFormGroup.get('zip').setValidators(zipValidators(vm.customer.country));\r\n      vm.editCompanyFormGroup.get('zip').updateValueAndValidity({ onlySelf: true });\r\n    });\r\n    });\r\n  }\r\n  \r\n  function zipValidators(country) {\r\n    const validators = [];\r\n    if (country && POSTAL_CODE_PATTERNS[country]) {\r\n      const postalCodePattern = POSTAL_CODE_PATTERNS[country];\r\n      validators.push(vm.validators.pattern(postalCodePattern));\r\n    }\r\n    return validators;\r\n  }\r\n\r\n  function saveCompanyObservable() {\r\n    const formValues = vm.editCompanyFormGroup.value;\r\n    vm.customer.title = formValues.title;\r\n    vm.customer.country = formValues.country;\r\n    vm.customer.city = formValues.city;\r\n    vm.customer.state = formValues.state;\r\n    vm.customer.zip = formValues.zip;\r\n    vm.customer.address = formValues.address;\r\n    vm.customer.address2 = formValues.address2;\r\n    vm.customer.phone = formValues.phone;\r\n    vm.customer.email = formValues.email;\r\n   /* // Optionally update deadlines in the customer object\r\n    vm.customer.cancelDeadline = formValues.cancelDeadline;\r\n    vm.customer.paymentDeadline = formValues.paymentDeadline;\r\n    vm.customer.shortName = formValues.shortName;*/\r\n    return customerService.saveCustomer(vm.customer);\r\n  }\r\n  \r\n  function saveAttributes(customer) {\r\n    const formValues = vm.editCompanyFormGroup.value;\r\n    let attributesArray = [\r\n      { key: 'type', value: 'retail' },\r\n      { key: 'address', value: getAddressValue(customer) },\r\n      { key: 'cancelDeadline', value: formValues.cancelDeadline },\r\n      { key: 'paymentDeadline', value: formValues.paymentDeadline },\r\n      { key: 'shortName', value: formValues.shortName }\r\n    ];\r\n    return attributeService.saveEntityAttributes(customer.id, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n  \r\n  function getAddressValue(customer) {\r\n    var address = '';\r\n    if (customer.address) {\r\n      address += customer.address;\r\n    }\r\n    if (customer.address2) {\r\n      address += (address ? ', ' : '') + customer.address2;\r\n    }\r\n    if (customer.city) {\r\n      address += (address ? ', ' : '') + customer.city;\r\n    }\r\n    if (customer.state) {\r\n      address += (address ? ', ' : '') + customer.state;\r\n    }\r\n    if (customer.zip) {\r\n      address += (customer.state ? ' ' : (address ? ', ' : '')) + customer.zip;\r\n    }\r\n    if (customer.country) {\r\n      address += (address ? ', ' : '') + customer.country;\r\n    }\r\n    return address;\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.retrofit-companies.delete-company}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\nopenDeleteCustomerDialog();\n\nfunction openDeleteCustomerDialog() {\n  let titleTranslation = translationService.instant(\n    'custom.retrofit-companies.delete-company-titel',\n    { entityName: entityName }\n  );\n\n  let contentTranslation = translationService.instant(\n    'custom.retrofit-companies.delete-company-content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteCustomer();\n    }\n  });\n}\n\n\nfunction deleteCustomer() {\n  customerService.deleteCustomer(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.retrofit-companies.add-company}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addCompanyFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 600px;\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>{{ 'custom.retrofit-companies.add-company' | translate }}</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-company-title' | translate }}</mat-label>\r\n        <input matInput formControlName=\"title\" required>\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('title').hasError('required')\">\r\n          {{ 'custom.retrofit-companies.add-company-company-title-is-required' | translate }}\r\n        </mat-error>\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('title').hasError('maxlength')\">\r\n          {{ 'customer.title-max-length' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- Existing contact component -->\r\n      <tb-contact [parentForm]=\"addCompanyFormGroup\" [isEdit]=\"true\"></tb-contact>\r\n      \r\n      <!-- New field: Shortname -->\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-short-name' | translate }}</mat-label>\r\n        <input matInput formControlName=\"shortName\" required minlength=\"3\" maxlength=\"4\">\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('shortName').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-short-name-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- New field: Deadline for Cancelations (days) -->\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-cancelation-deadline' | translate }}</mat-label>\r\n        <input matInput type=\"number\" formControlName=\"cancelDeadline\" required>\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('cancelDeadline').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-cancelation-deadline-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      \r\n      <!-- New field: Deadline for Payments (days) -->\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>{{ 'custom.retrofit-companies.add-company-payment-deadline' | translate }}</mat-label>\r\n        <input matInput type=\"number\" formControlName=\"paymentDeadline\" required>\r\n        <mat-error *ngIf=\"addCompanyFormGroup.get('paymentDeadline').hasError('pattern')\">\r\n          {{ 'custom.retrofit-companies.add-company-payment-deadline-validation' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n  </div>\r\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n    <button mat-button color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\" cdkFocusInitial>\r\n      {{ 'action.cancel' | translate }}\r\n    </button>\r\n    <button mat-button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(isLoading$ | async) || addCompanyFormGroup.invalid || !addCompanyFormGroup.dirty\">\r\n      {{ 'custom.retrofit-companies.add-company' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "const POSTAL_CODE_PATTERNS = {\r\n  'United States': '(\\\\d{5}([\\\\-]\\\\d{4})?)',\r\n  'Australia': '[0-9]{4}',\r\n  'Austria': '[0-9]{4}',\r\n  'Belgium': '[0-9]{4}',\r\n  'Brazil': '[0-9]{5}[\\\\-]?[0-9]{3}',\r\n  'Canada': '^(?!.*[DFIOQU])[A-VXY][0-9][A-Z][ -]?[0-9][A-Z][0-9]$',\r\n  'Denmark': '[0-9]{3,4}',\r\n  'Faroe Islands': '[0-9]{3,4}',\r\n  'Netherlands': '[1-9][0-9]{3}\\\\s?[a-zA-Z]{2}',\r\n  'Germany': '[0-9]{5}',\r\n  'Hungary': '[0-9]{4}',\r\n  'Italy': '[0-9]{5}',\r\n  'Japan': '\\\\d{3}-\\\\d{4}',\r\n  'Luxembourg': '(L\\\\s*(-|—|–))\\\\s*?[\\\\d]{4}',\r\n  'Poland': '[0-9]{2}\\\\-[0-9]{3}',\r\n  'Spain': '((0[1-9]|5[0-2])|[1-4][0-9])[0-9]{3}',\r\n  'Sweden': '\\\\d{3}\\\\s?\\\\d{2}',\r\n  'United Kingdom': '[A-Za-z]{1,2}[0-9Rr][0-9A-Za-z]? [0-9][ABD-HJLNP-UW-Zabd-hjlnp-uw-z]{2}'\r\n};\r\n\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet roleService = $injector.get(widgetContext.servicesMap.get('roleService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\r\n/*let stripeKey;*/\r\n\r\n/*attributeService\r\n  .getEntityAttributes({ entityType: 'TENANT', id: tenantId }, \"SERVER_SCOPE\", ['stripeKey'])\r\n  .subscribe(key => {\r\n      stripeKey = key[0].value;\r\n      openAddCompanyDialog();\r\n  });*/\r\n  \r\nopenAddCompanyDialog();\r\n\r\nfunction openAddCompanyDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddCompanyDialogController).subscribe();\r\n}\r\n\r\nfunction AddCompanyDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  // Initialize form with company title control\r\n  vm.addCompanyFormGroup = vm.fb.group({\r\n    title: ['', [vm.validators.required, vm.validators.maxLength(255)]]\r\n  });\r\n  \r\n  // Existing form controls\r\n  vm.addCompanyFormGroup.addControl('country', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('city', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('state', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('zip', vm.fb.control('', zipValidators('')));\r\n  vm.addCompanyFormGroup.addControl('address', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('address2', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('phone', vm.fb.control('', []));\r\n  vm.addCompanyFormGroup.addControl('email', vm.fb.control('', [vm.validators.email]));\r\n\r\n  // New controls for deadline fields\r\n  vm.addCompanyFormGroup.addControl('cancelDeadline', vm.fb.control(90, []));\r\n  vm.addCompanyFormGroup.addControl('paymentDeadline', vm.fb.control(14, []));\r\n  vm.addCompanyFormGroup.addControl('shortName', vm.fb.control('', []));\r\n  \r\n  // Update zip validators when country value changes\r\n  vm.addCompanyFormGroup.get('country').valueChanges.subscribe((country) => {\r\n    vm.addCompanyFormGroup.get('zip').setValidators(zipValidators(country));\r\n    vm.addCompanyFormGroup.get('zip').updateValueAndValidity({ onlySelf: true });\r\n    vm.addCompanyFormGroup.get('zip').markAsTouched({ onlySelf: true });\r\n  });\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    vm.addCompanyFormGroup.markAsPristine();\r\n    saveCompanyObservable().subscribe(function (customer) {\r\n      widgetContext.rxjs.forkJoin([\r\n        saveAttributes(customer),\r\n        saveUserGroups(customer.id)\r\n      ]).subscribe(function () {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n      });\r\n    });\r\n  };\r\n  \r\n  function zipValidators(country) {\r\n    const zipValidators = [];\r\n    if (country && POSTAL_CODE_PATTERNS[country]) {\r\n      const postalCodePattern = POSTAL_CODE_PATTERNS[country];\r\n      zipValidators.push(vm.validators.pattern(postalCodePattern));\r\n    }\r\n    return zipValidators;\r\n  }\r\n\r\n  function saveCompanyObservable() {\r\n    return getOrCreateSmartRetailCustomerGroup().pipe(\r\n      widgetContext.rxjs.switchMap((smartRetail) => {\r\n        const formValues = vm.addCompanyFormGroup.value;\r\n        let customer = {\r\n          title: formValues.title,\r\n          country: formValues.country,\r\n          city: formValues.city,\r\n          state: formValues.state,\r\n          zip: formValues.zip,\r\n          address: formValues.address,\r\n          address2: formValues.address2,\r\n          phone: formValues.phone,\r\n          email: formValues.email\r\n        };\r\n        return customerService.saveCustomer(customer, smartRetail.id.id);\r\n      })\r\n    );\r\n  }\r\n  \r\n  function getOrCreateSmartRetailCustomerGroup() {\r\n    return getEntityGroupByName(\"Belimo Retrofit\", \"CUSTOMER\").pipe(\r\n      widgetContext.rxjs.switchMap((group) => {\r\n        if (group) {\r\n          return widgetContext.rxjs.of(group);\r\n        } else {\r\n          var smartRetail = {\r\n            type: 'CUSTOMER',\r\n            name: 'Belimo Retrofit'\r\n          };\r\n          return entityGroupService.saveEntityGroup(smartRetail);\r\n        }\r\n      })\r\n    );\r\n  }\r\n  \r\n  function saveUserGroups(customerId) {\r\n    return widgetContext.rxjs.forkJoin([\r\n      getRoleByName(\"Belimo Retrofit Read Only\", \"GROUP\"),\r\n      getRoleByName(\"Belimo Retrofit Users\", \"GENERIC\"),\r\n      getRoleByName(\"Belimo Retrofit Administrators\", \"GENERIC\"),\r\n      getRoleByName(\"Belimo Retrofit Engineer\", \"GENERIC\"),\r\n      getEntityGroupByName(\"Belimo Retrofit\", \"DASHBOARD\"),\r\n      getEntityGroupByName(\"Belimo Retrofit Administrators\", \"DASHBOARD\")\r\n    ]).pipe(widgetContext.rxjs.switchMap((data) => {\r\n      var smartRetailReadOnlyGroupRole = data[0];\r\n      var smartRetailUserGenericRole = data[1];\r\n      var smartRetailAdministratorGenericRole = data[2];\r\n      var smartRetailEngineerGenericRole = data[3];\r\n      var smartRetailSharedGroup = data[4];\r\n      var smartRetailGroup = data[5];\r\n      \r\n      var smartRetailUsers = {\r\n        type: 'USER',\r\n        name: 'Belimo Retrofit Users',\r\n        ownerId: customerId\r\n      };\r\n      \r\n      var smartRetailAdministrators = {\r\n        type: 'USER',\r\n        name: 'Belimo Retrofit Administrators',\r\n        ownerId: customerId\r\n      };\r\n      \r\n      var smartRetailEngineer = {\r\n        type: 'USER',\r\n        name: 'Belimo Retrofit Engineer',\r\n        ownerId: customerId\r\n      };\r\n\r\n      return widgetContext.rxjs.forkJoin([\r\n        entityGroupService.saveEntityGroup(smartRetailUsers),\r\n        entityGroupService.saveEntityGroup(smartRetailAdministrators),\r\n        entityGroupService.saveEntityGroup(smartRetailEngineer)\r\n      ]).pipe(widgetContext.rxjs.switchMap((data) => {\r\n        var smartRetailUsersGroup = data[0];\r\n        var smartRetailAdministratorsGroup = data[1];\r\n        var smartRetailEngineerGroup = data[2];\r\n\r\n        const tasks = [];\r\n\r\n        if (smartRetailReadOnlyGroupRole) {\r\n          if (smartRetailSharedGroup) {\r\n            let smartRetailSharedGroupPermissionForUsers = {\r\n              userGroupId: smartRetailUsersGroup.id,\r\n              roleId: smartRetailReadOnlyGroupRole.id,\r\n              entityGroupId: smartRetailSharedGroup.id,\r\n              entityGroupType: smartRetailSharedGroup.type\r\n            };\r\n            let smartRetailSharedGroupPermissionForAdmins = {\r\n              userGroupId: smartRetailAdministratorsGroup.id,\r\n              roleId: smartRetailReadOnlyGroupRole.id,\r\n              entityGroupId: smartRetailSharedGroup.id,\r\n              entityGroupType: smartRetailSharedGroup.type\r\n            };\r\n            let smartRetailSharedGroupPermissionForEngineer = {\r\n              userGroupId: smartRetailEngineerGroup.id,\r\n              roleId: smartRetailReadOnlyGroupRole.id,\r\n              entityGroupId: smartRetailSharedGroup.id,\r\n              entityGroupType: smartRetailSharedGroup.type\r\n            };\r\n            tasks.push(roleService.saveGroupPermission(smartRetailSharedGroupPermissionForUsers));\r\n            tasks.push(roleService.saveGroupPermission(smartRetailSharedGroupPermissionForAdmins));\r\n            tasks.push(roleService.saveGroupPermission(smartRetailSharedGroupPermissionForEngineer));\r\n          }\r\n          if (smartRetailGroup) {\r\n            let smartRetailGroupPermissionForAdmins = {\r\n              userGroupId: smartRetailAdministratorsGroup.id,\r\n              roleId: smartRetailReadOnlyGroupRole.id,\r\n              entityGroupId: smartRetailGroup.id,\r\n              entityGroupType: smartRetailGroup.type\r\n            };\r\n            tasks.push(roleService.saveGroupPermission(smartRetailGroupPermissionForAdmins));\r\n          }\r\n        }\r\n\r\n        if (smartRetailUserGenericRole) {\r\n          let smartRetailUserGenericPermission = {\r\n            userGroupId: smartRetailUsersGroup.id,\r\n            roleId: smartRetailUserGenericRole.id\r\n          };\r\n          tasks.push(roleService.saveGroupPermission(smartRetailUserGenericPermission));\r\n        }\r\n\r\n        if (smartRetailAdministratorGenericRole) {\r\n          let smartRetailAdminGenericPermission = {\r\n            userGroupId: smartRetailAdministratorsGroup.id,\r\n            roleId: smartRetailAdministratorGenericRole.id\r\n          };\r\n          tasks.push(roleService.saveGroupPermission(smartRetailAdminGenericPermission));\r\n        }\r\n        \r\n        if (smartRetailEngineerGenericRole) {\r\n          let smartRetailEngineerGenericPermission = {\r\n            userGroupId: smartRetailEngineerGroup.id,\r\n            roleId: smartRetailEngineerGenericRole.id\r\n          };\r\n          tasks.push(roleService.saveGroupPermission(smartRetailEngineerGenericPermission));\r\n        }\r\n        \r\n        if (tasks.length) {\r\n          return widgetContext.rxjs.forkJoin(tasks);\r\n        } else {\r\n          return widgetContext.rxjs.of(null);\r\n        }\r\n      }));\r\n    }));\r\n  }\r\n  \r\n  function getRoleByName(roleName, type) {\r\n    var rolesPageLink = widgetContext.pageLink(10, 0, roleName);\r\n    return roleService.getRoles(rolesPageLink, type, { ignoreLoading: true }).pipe(\r\n      widgetContext.rxjs.map((data) => {\r\n        if (data.data.length) {\r\n          return data.data.find((role) => role.name === roleName);\r\n        } else {\r\n          return null;\r\n        }\r\n      })\r\n    );\r\n  }\r\n  \r\n  function getEntityGroupByName(groupName, groupType) {\r\n    var entityGroupsPageLink = widgetContext.pageLink(10, 0, groupName);\r\n    return entityGroupService.getEntityGroupsByPageLink(entityGroupsPageLink, groupType, { ignoreLoading: true }).pipe(\r\n      widgetContext.rxjs.map((data) => {\r\n        if (data.data.length) {\r\n          return data.data.find((group) => group.name === groupName);\r\n        } else {\r\n          return null;\r\n        }\r\n      })\r\n    );\r\n  }\r\n  \r\n  function saveAttributes(customer) {\r\n    const formValues = vm.addCompanyFormGroup.value;\r\n    let attributesArray = [\r\n      { key: 'address', value: getAddressValue(customer) },\r\n/*      { key: 'stripeKey', value: stripeKey },*/\r\n      { key: 'weatherAPIToken', value: '587f1474e94ea6b52e6ce6e99d13d75a' },\r\n      { key: 'cancelDeadline', value: formValues.cancelDeadline },\r\n      { key: 'paymentDeadline', value: formValues.paymentDeadline },\r\n      { key: 'shortName', value: formValues.shortName }\r\n    ];\r\n    return attributeService.saveEntityAttributes(customer.id, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n  \r\n  function getAddressValue(customer) {\r\n    var address = '';\r\n    if (customer.address) {\r\n      address += customer.address;\r\n    }\r\n    if (customer.address2) {\r\n      address += (address ? ', ' : '') + customer.address2;\r\n    }\r\n    if (customer.city) {\r\n      address += (address ? ', ' : '') + customer.city;\r\n    }\r\n    if (customer.state) {\r\n      address += (address ? ', ' : '') + customer.state;\r\n    }\r\n    if (customer.zip) {\r\n      address += (customer.state ? ' ' : (address ? ', ' : '')) + customer.zip;\r\n    }\r\n    if (customer.country) {\r\n      address += (address ? ', ' : '') + customer.country;\r\n    }\r\n    return address;\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "777ded27-e3b8-d901-ca42-3079a23f7a12",
        "typeFullFqn": "system.cards.entities_table"
      },
      "c2559a58-e82d-3250-7e35-f520ced0d916": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "203b0867-b867-ef98-1791-03046c133b7d",
              "dataKeys": [
                {
                  "name": "role",
                  "type": "attribute",
                  "label": "role",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.7805336660172157
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div style=\"width: 100%; height: 100%; padding: 0;\">\n   <tb-dashboard-state *ngIf=\"ctx.currentUser.authority === 'TENANT_ADMIN'\" [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"retail_companies\"></tb-dashboard-state>\n   <tb-dashboard-state *ngIf=\"ctx.currentUser.authority === 'CUSTOMER_USER'\" [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"customer_companies\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "// 20.03.2025 DOJ\nvar userRole = data[0].role;\n\nvar stateParams = ctx.stateController.getStateParams();\nvar currentUser = ctx.currentUser.authority === 'TENANT_ADMIN' || userRole === 'ECO Administrator';\nstateParams[\"userRole\"] = userRole;\n/*console.log(\"par:\", stateParams);*/\nctx.stateController.updateState(null, stateParams);\n\nreturn `<div style=\"width: 100%; height: 100%; padding: 0;\">`+\n   (currentUser?('<tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"retail_companies\"></tb-dashboard-state>'):\n   ('<tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"customer_companies\"></tb-dashboard-state>'))+\n'</div>';",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ""
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "useDashboardTimewindow": true,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "c2559a58-e82d-3250-7e35-f520ced0d916",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "28303a0b-d427-6d9e-0ee1-ae2c3f344769": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "filterId": null,
              "dataKeys": []
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <div fxLayout=\"row\">\n        <tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex style=\"height: 430px;\" stateId='edit_Doktorkit_alias'></tb-dashboard-state>\n    </div>\n    <div fxLayout=\"row\">\n        <!--<tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex style=\"height: 200px;\" stateId='edit_Doktorkit_floorplan'></tb-dashboard-state>\n    </div>-->\n    <!--<tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex stateId='edit_Doktorkit_location'></tb-dashboard-state>\n</div>-->",
            "markdownTextFunction": "return '# Some title\\\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": false,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "save-title",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "const targetElement = $($event.target).closest('#save-title', widgetContext.$container[0]);\n\nvar title = $(targetElement).attr('data-title');\n\nwidgetContext.assetService.getAsset(entityId.id, {ignoreLoading: true}).subscribe((Doktorkit) => {\n    Doktorkit.name = title;\n    widgetContext.assetService.saveAsset(Doktorkit, null, {ignoreLoading: true}).subscribe(() => {\n       var stateParams = widgetContext.stateController.getStateParams();\n       stateParams.selectedDoktorkit.entityName = title;\n       widgetContext.stateController.updateState(null, stateParams);\n       /*if (widgetContext.parentDashboard) {\n           widgetContext.parentDashboard.aliasController.updateAliases();\n       }\n       widgetContext.updateAliases();*/\n    });\n});\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "088a4799-8551-7ab4-892f-2a08d6d40a7c"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "28303a0b-d427-6d9e-0ee1-ae2c3f344769",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "4a524a3c-2b87-903c-6256-47a5df398ba5": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Doktorkits",
            "enableSearch": true,
            "enableSelectColumnDisplay": true,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "false",
            "displayEntityName": true,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Doktorkits",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "1c348dad-e738-a4db-5e7e-4c0271790ab7",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "ownerName",
                  "type": "entityField",
                  "label": "Owner name",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.5315555237306622
                },
                {
                  "name": "state",
                  "type": "attribute",
                  "label": "State",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar active = value;\r\nif (active == 'true') { // all key values here are strings\r\n  color = '#27AE60';\r\n} else {\r\n  color = '#EB5757';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span>';\r\n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.9505541495044312,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "Select Doktorkit",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "updateDashboardState",
                "targetDashboardStateId": null,
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "5e50c296-0eac-8841-a69a-1cbbfe04d1c5"
              }
            ],
            "actionCellButton": [
              {
                "name": "Open Doktorkit devices",
                "icon": "devices_other",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "71c478b6-a4b1-e569-e99a-85d5562cc721"
              },
              {
                "name": "Delete Doktorkit",
                "icon": "delete",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenDeleteDoktorkitDialog();\n\nfunction openDeleteDoktorkitDialog() {\n  var title = 'Are you sure you want to delete the Doktorkit ' + entityName + '?';\n  var content = 'Be careful, after the confirmation, the Doktorkit will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteDoktorkit();\n      }\n    }\n  );\n}\n\nfunction deleteDoktorkit() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteDoktorkitToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Doktorkit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Doktorkit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDoktorkitToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "338d9fd7-c752-eb0e-4687-2c2e32ca1a32"
              },
              {
                "name": "Unassign Doktorkit",
                "icon": "remove_circle",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenUnassignDoktorkitDialog();\n\nfunction openUnassignDoktorkitDialog() {\n  var title = 'Are you sure you want to unassign the doktorkit ' + entityName + '?';\n  var content = 'After the confirmation, the doktorkit will be unassigned from the current Measurement!';\n  dialogs.confirm(title, content, 'Cancel', 'Unassign from Measurement').subscribe(\n    function(result) {\n      if (result) {\n        doUnassignDoktorkit();\n      }\n    }\n  );\n}\n\nfunction doUnassignDoktorkit() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var MeasurementId = widgetContext.stateController.getStateParams().selectedMeasurement.entityId;\n  unassignDoktorkit(entityId, MeasurementId, customerId).subscribe(() => {\n      widgetContext.updateAliases();\n  });\n}\n\nfunction unassignDoktorkit(doktorkitId, MeasurementId, customerId) {\n    return getUnassignedDoktorkitsGroup(customerId).pipe(\n        widgetContext.rxjs.switchMap((unassignedDoktorkitsGroup) => {\n            return widgetContext.rxjs.forkJoin([\n                entityGroupService.addEntityToEntityGroup(unassignedDoktorkitsGroup.id.id, doktorkitId.id),\n                deleteMeasurementToDoktorkitRelation(MeasurementId, doktorkitId),\n                removePositionAttributes(doktorkitId)\n            ]);\n        })\n    );\n}\n\nfunction getUnassignedDoktorkitsGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDoktorkitsGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDoktorkitsGroup(customerId, groups) {\n  var unassignedDoktorkitsGroup = groups.find(group => group.name === 'Unassigned Kit');\n  if (unassignedDoktorkitsGroup) {\n      return widgetContext.rxjs.of(unassignedDoktorkitsGroup);\n  } else {\n      unassignedDoktorkitsGroup = {\n          type: 'ASSET',\n          name: 'Unassigned Kit',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDoktorkitsGroup);\n  }\n}\n\nfunction deleteMeasurementToDoktorkitRelation(MeasurementId, doktorkitId) {\n    return entityRelationService.deleteRelation(MeasurementId, 'Owns', doktorkitId);\n}\n\nfunction removePositionAttributes(doktorkitId) {\n    return attributeService.deleteEntityAttributes(doktorkitId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "739315aa-0e23-7502-a6a3-f99e77781776"
              }
            ],
            "headerButton": [
              {
                "name": "Add Doktorkit",
                "icon": "add",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDoktorkitFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 350px;\">\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\n    <h2>Add Doktorkit</h2>\n    <span fxFlex></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content fxLayout=\"column\">\n    <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">\n      <mat-form-field fxFlex class=\"mat-block\">\n        <mat-label>Doktorkit title</mat-label>\n        <input matInput formControlName=\"name\" readonly>\n        <!--<mat-error *ngIf=\"addDoktorkitFormGroup.get('name').hasError('required')\">\n          Doktorkit title is required.\n        </mat-error>-->\n      </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      Cancel\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async)\">\n      Add Doktorkit\n    </button>\n  </div>\n</form>\n\n<!--<button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addDoktorkitFormGroup.invalid || !addDoktorkitFormGroup.dirty\">\n      Add Doktorkit\n    </button>-->",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\n\r\nlet customerId;\r\nlet shortNameAttr;\r\nlet customerShortName;\r\nlet nextDoktorkitId = 0;\r\n\r\nlet customerName = widgetContext.stateController.getStateParams().entityName;\r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        customerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n/*console.log(customerId);\r\nconsole.log(customerId.id);*/\r\n\r\nlet assetSearchQuery = {\r\n  \"parameters\": {\r\n    \"rootId\": customerId.id,\r\n    \"rootType\": \"CUSTOMER\",\r\n    \"direction\": \"FROM\",\r\n    \"relationTypeGroup\": \"COMMON\",\r\n    \"maxLevel\": 100,\r\n    \"fetchLastLevelOnly\": false\r\n  },\r\n  \"relationType\": \"Owns\",\r\n  \"assetTypes\": [\r\n    \"Doktorkit\"\r\n  ]\r\n};\r\n\r\nassetService.findByQuery(assetSearchQuery).subscribe(doktorkits => {\r\n    /*console.log(doktorkits);*/\r\n    nextDoktorkitId = getLastId(doktorkits);\r\n    /*console.log(nextDoktorkitId);*/\r\n    attributeService.getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName']).subscribe(attributes => {\r\n        shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n        customerShortName = shortNameAttr ? shortNameAttr.value : customerName;\r\n        openAddDoktorkitDialog();\r\n    });\r\n});\r\n\r\nfunction getLastId(doktorkits) {\r\n    let maxNumber = 0;\r\n    doktorkits.forEach(item => {\r\n        const name = item.name;\r\n        const parts = name.split('_');\r\n        if (parts.length === 3) {\r\n            const number = parseInt(parts[2], 10);\r\n            if (number > maxNumber) {\r\n                maxNumber = number;\r\n            }\r\n        }\r\n    });\r\n    const nextProjectId = maxNumber + 1;\r\n    return nextProjectId;\r\n}\r\n\r\nfunction openAddDoktorkitDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddDoktorkitDialogController).subscribe();\r\n}\r\n\r\nfunction AddDoktorkitDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.addDoktorkitFormGroup = vm.fb.group({\r\n    name: [customerShortName + '_kit_' + nextDoktorkitId, [vm.validators.required]],\r\n    entityLabel: ['']\r\n  });\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    const stateParams = widgetContext.stateController.getStateParams();\r\n    var customerId;\r\n    var projectId;\r\n    var measurementId;\r\n    projectId = {id:(stateParams.selectedProject && stateParams.selectedProject.entityId && stateParams.selectedProject.entityId.id) ? stateParams.selectedProject.entityId.id : '',entityType: 'ASSET'}; \r\n    measurementId = {id:(stateParams.selectedMeasurement && stateParams.selectedMeasurement.entityId && stateParams.selectedMeasurement.entityId.id) ? stateParams.selectedMeasurement.entityId.id : '',entityType: 'ASSET'};\r\n    \r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        customerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n    vm.addDoktorkitFormGroup.markAsPristine();\r\n    saveDoktorkitObservable(customerId).subscribe(\r\n      function (Doktorkit) {\r\n        const observables = [\r\n        saveCustomerToDoktorkitRelation(customerId, Doktorkit.id),\r\n        saveAttributes(Doktorkit.id)\r\n        ];\r\n        // Add saveProjectToMeasurementRelation to observables if projectId is not empty\r\n        /*if(projectId.id !== \"\"){\r\n            observables.push(saveProjectToDoktorkitRelation(projectId, Doktorkit.id));\r\n        }*/\r\n        if(measurementId.id !== \"\"){\r\n            observables.push(saveMeasurementToDoktorkitRelation(measurementId, Doktorkit.id));\r\n        }\r\n          widgetContext.rxjs.forkJoin(observables).subscribe(\r\n              function () {\r\n                var params = widgetContext.stateController.getStateParams();\r\n                var selectedDoktorkit = params['selectedDoktorkit'];\r\n                params['selectedDoktorkit'] = { entityId: Doktorkit.id, entityName: Doktorkit.name, entityLabel: '' };\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              }\r\n        );\r\n      }\r\n    );\r\n  };\r\n\r\n  function saveDoktorkitObservable(customerId) {\r\n    return getDoktorkitsGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((DoktorkitsGroup) => {\r\n            return getUnassignedKitGroup(customerId).pipe(\r\n                widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\r\n                    const formValues = vm.addDoktorkitFormGroup.value;\r\n                    const Doktorkit = {\r\n                        name: formValues.name,\r\n                        type: 'Doktorkit',\r\n                        label: formValues.entityLabel,\r\n                        customerId: customerId\r\n                    };\r\n\r\n                    return assetService.saveAsset(Doktorkit, DoktorkitsGroup.id.id).pipe(\r\n                        widgetContext.rxjs.switchMap((savedAsset) => {\r\n                            // Ensure this line returns an observable\r\n                            return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, savedAsset.id.id).pipe(\r\n                                widgetContext.rxjs.map(() => {\r\n                                    return savedAsset; // Return the saved asset after adding to the entity group\r\n                                })\r\n                            );\r\n                        })\r\n                    );\r\n                })\r\n            );\r\n        })\r\n    );\r\n}\r\n\r\n\r\n  \r\n  function getDoktorkitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var DoktorkitsGroup = entityGroups.find(group => group.name === 'Doktorkits');\r\n              if (DoktorkitsGroup) {\r\n                  return widgetContext.rxjs.of(DoktorkitsGroup);\r\n              } else {\r\n                  DoktorkitsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Doktorkits',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(DoktorkitsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  function getUnassignedKitGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n              if (UnassignedKitGroup) {\r\n                  return widgetContext.rxjs.of(UnassignedKitGroup);\r\n              } else {\r\n                  UnassignedKitGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Unassigned Kit',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n\r\n  function saveCustomerToDoktorkitRelation(customerId, DoktorkitId) {\r\n      var relation = {\r\n          from: customerId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveProjectToDoktorkitRelation(projectId, DoktorkitId) {\r\n      var relation = {\r\n          from: projectId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveMeasurementToDoktorkitRelation(measurementId, DoktorkitId) {\r\n      var relation = {\r\n          from: measurementId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n        {\r\n            key: 'state',\r\n            value: 'normal'\r\n        }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e965b8a1-a6ac-5ae4-fd79-2b7220b91ed1"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "4a524a3c-2b87-903c-6256-47a5df398ba5",
        "typeFullFqn": "system.cards.entities_table"
      },
      "ab845ee8-ff10-b684-3652-cb49e2d9acbe": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "filterId": null,
              "dataKeys": []
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "var DoktorkitState;\r\nif (data && data.length && data[0]['entityId']) {\r\n    DoktorkitState = true;\r\n} else {\r\n    DoktorkitState = false;\r\n}\r\n\r\nvar typeSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24\" viewBox=\"0 -960 960 960\" width=\"24\"><path d=\"M160-80q-33 0-56.5-23.5T80-160v-480q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v480q0 33-23.5 56.5T800-80H160Zm240-640h160v-80H400v80Zm40 360v120h80v-120h120v-80H520v-120h-80v120H320v80h120Z\"/></svg>';\r\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\r\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\r\n\r\nvar header = '<div class=\"header\" fxLayout=\"row\" fxLayoutAlign=\"start stretch\" fxLayoutGap=\"8px\">' +\r\n                '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><button id=\"go-back\" matTooltip=\"Go back\" type=\"button\" mat-icon-button><mat-icon>arrow_back</mat-icon></button></div>' +\r\n                '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><img style=\"vertical-align: middle;\" class=\"title-icon mat-icon\" src=\"'+ typeSvgUrl +'\"></div>' +\r\n                '<div fxFlex fxLayout=\"column\" fxLayoutAlign=\"center\">' +\r\n                   '<div class=\"title\">Edit Doktorkit: {{ ctx.stateController.getStateParams().selectedDoktorkit?.entityName }}</div>' +\r\n                '</div>' +\r\n                '<div fxLayout=\"column\" fxLayoutAlign=\"start\"><button id=\"Doktorkit-devices\" type=\"button\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">devices_other</mat-icon><span>Doktorkit devices</span></button></div>' +\r\n                '<div fxLayout=\"column\" fxLayoutAlign=\"start\"><button id=\"get-location\" type=\"button\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">location_on</mat-icon></button></div>' +\r\n                '<div fxLayout=\"column\" fxLayoutAlign=\"start\" style=\"padding-right: 24px;\"><button id=\"delete-Doktorkit\" type=\"button\" mat-raised-button color=\"accent\"><mat-icon class=\"tb-mat-20\">delete</mat-icon><span>Delete</span></button></div>' +\r\n             '</div>';\r\n             \r\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\r\n          (DoktorkitState \r\n            ? (header +\r\n               '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"edit_Doktorkit_card\"></tb-dashboard-state>') \r\n            : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkits_card\"></tb-dashboard-state>') +\r\n       '</div>';\r\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n.main-layout .header {\n    height: 60px;\n    margin: 4px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 12px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedDoktorkit'] = null;\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "116515c2-d9bd-80b6-7a34-97373a802806"
              },
              {
                "name": "Doktorkit-devices",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f921410a-47b7-5884-1c63-d010a39064a4"
              },
              {
                "name": "delete-Doktorkit",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenDeleteDoktorkitDialog();\n\nfunction openDeleteDoktorkitDialog() {\n  var title = 'Are you sure you want to delete the Doktorkit ' + entityName + '?';\n  var content = 'Be careful, after the confirmation, the Doktorkit will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteDoktorkit();\n      }\n    }\n  );\n}\n\nfunction deleteDoktorkit() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteDoktorkitToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Doktorkit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Doktorkit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDoktorkitToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1af63269-0a95-b82e-0703-86bd8daf9356"
              },
              {
                "name": "get-location",
                "icon": "location_on",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "getLocation",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Get location action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to get phone location', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processLocationFunction": "// Function body to process current location of the phone. \n// - latitude - phone location latitude\n// - longitude - phone location longitude\nlet $injector = widgetContext.$scope.$injector;\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\n//showLocationDialog('Location', latitude, longitude);\nsaveEntityLocationAttributes('latitude', 'longitude', latitude, longitude);\nfunction getSelectedKitId() {\n    let stateParams = widgetContext.stateController.getStateParams();\n    return stateParams.selectedDoktorkit.entityId;\n}\n\nfunction saveEntityLocationAttributes(latitudeAttributeName, longitudeAttributeName, latitude, longitude) {\n    let entityId = getSelectedKitId();\n    if (entityId) {\n        let attributes = [\n            { key: \"latitude\", value: latitude },\n            { key: \"longitude\", value: longitude }\n        ];\n        attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributes).subscribe(\n        widgetContext.dialogs.alert('Location attributes saved!\\nLatitude: ' + latitude + '\\nLongitude: ' + longitude),\n           function() {\n               widgetContext.showSuccessToast('Location attributes saved!');\n           },\n           function(error) {\n               widgetContext.dialogs.alert('Location attributes save failed', JSON.stringify(error));\n           }\n        );\n    }\n}\n\n\nfunction showLocationDialog(title, latitude, longitude) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Latitude: '+latitude+'<br>Longitude: ' + longitude).subscribe();\n    }, 100);\n}"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "94c2e448-3356-0d9d-d976-d11a0ac2165c"
              }
            ],
            "headerButton": []
          }
        },
        "row": 0,
        "col": 0,
        "id": "ab845ee8-ff10-b684-3652-cb49e2d9acbe",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "980bd0c3-44e9-a1f9-c8f9-3dc533011fde": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "address",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.7546586070710162
                }
              ]
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "showResultMessage": false,
            "showLabel": true,
            "isRequired": true,
            "labelValue": "Address",
            "requiredErrorMessage": "Address is required"
          },
          "title": "New Update server string attribute",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "actions": {},
          "showTitleIcon": false,
          "titleTooltip": "",
          "widgetCss": "",
          "noDataDisplayMessage": ""
        },
        "row": 0,
        "col": 0,
        "id": "980bd0c3-44e9-a1f9-c8f9-3dc533011fde",
        "typeFullFqn": "system.input_widgets.update_server_string_attribute"
      },
      "00041a85-d8fe-09f2-4aab-1c86d8a7444d": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "filterId": null,
              "dataKeys": []
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div style=\"width: 100%; height: 100%;\" fxLayout=\"row\" class=\"attribute-update-form\" style=\"padding: 0 8px;\">\n    <div fxFlex fxLayout=\"column\">\n        <mat-form-field class=\"mat-block\" style=\"width: 100%;\">\n              <mat-label>Title</mat-label>\n              <input #titleInput #titleInputCtrl=\"ngModel\" required matInput [(ngModel)]=\"titleInput.value\"\n                     value=\"${entityName}\" (keyUp.enter)=\"titleInput.value !== '${entityName}' ? saveTitleButton._elementRef.nativeElement.click() : return;\"\n                     (keyUp.escape)=\"titleInput.value = '${entityName}';\"/>\n              <mat-error *ngIf=\"!titleInputCtrl.valid\">Title is required</mat-error>         \n        </mat-form-field>\n    </div>\n    <div class=\"input-buttons\">\n        <button #saveTitleButton id=\"save-title\" [disabled]=\"titleInput.value === '${entityName}' || !titleInputCtrl.valid\" [attr.data-title]=\"titleInput.value\" type=\"button\" mat-icon-button>\n            <mat-icon>check</mat-icon>\n        </button> \n        <button [disabled]=\"titleInput.value === '${entityName}'\" type=\"button\" mat-icon-button (click)=\"titleInput.value = '${entityName}';\">\n            <mat-icon>close</mat-icon>\n        </button>\n    </div>\n</div>\n",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view  .grid__element:last-child {\n    margin-top: 19px;\n    margin-left: 7px;\n}\n\n.tb-markdown-view  .attribute-update-form .mat-icon-button {\n    width: 32px;\n    min-width: 32px;\n    height: 32px;\n    min-height: 32px;\n    padding: 0 !important;\n    margin: 0 !important;\n    line-height: 20px;\n}\n\n.tb-markdown-view  .attribute-update-form .mat-icon-button mat-icon {\n    width: 20px;\n    min-width: 20px;\n    height: 20px;\n    min-height: 20px;\n    font-size: 20px;\n}\n\n.tb-markdown-view .attribute-update-form .input-buttons {\n    margin-top: 19px;\n    margin-left: 7px;\n    display: flex;\n}"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "save-title",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "const targetElement = $($event.target).closest('#save-title', widgetContext.$container[0]);\n\nvar title = $(targetElement).attr('data-title');\n\nwidgetContext.assetService.getAsset(entityId.id, {ignoreLoading: true}).subscribe((Doktorkit) => {\n    Doktorkit.name = title;\n    widgetContext.assetService.saveAsset(Doktorkit, null, {ignoreLoading: true}).subscribe(() => {\n       widgetContext.stateController.getStateParams().selectedDoktorkit.entityName = title;\n       widgetContext.updateAliases();\n    });\n});\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "088a4799-8551-7ab4-892f-2a08d6d40a7c"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "00041a85-d8fe-09f2-4aab-1c86d8a7444d",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "1d0b53f4-7805-fbfd-1cc6-e91d0df3d4bf": {
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "latitude",
                  "type": "attribute",
                  "label": "latitude",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.862061599769905
                },
                {
                  "name": "longitude",
                  "type": "attribute",
                  "label": "longitude",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.017864596400994026
                }
              ]
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "provider": "openstreet-map",
            "gmApiKey": "AIzaSyDoEx2kaGz3PxwbI9T7ccTSg5xjdw8Nw8Q",
            "gmDefaultMapType": "roadmap",
            "mapProvider": "CartoDB.Positron",
            "useCustomProvider": false,
            "customProviderTileUrl": "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            "mapProviderHere": "HERE.normalDay",
            "credentials": {
              "app_id": "AhM6TzD9ThyK78CT3ptx",
              "app_code": "p6NPiITB3Vv0GMUFnkLOOg"
            },
            "mapImageUrl": "tb-image;/api/images/system/here_map_system_widget_map_image.svg",
            "tmApiKey": "84d6d83e0e51e481e50454ccbe8986b",
            "tmDefaultMapType": "roadmap",
            "latKeyName": "latitude",
            "lngKeyName": "longitude",
            "xPosKeyName": "xPos",
            "yPosKeyName": "yPos",
            "defaultZoomLevel": 14,
            "defaultCenterPosition": "0,0",
            "disableScrollZooming": false,
            "disableDoubleClickZooming": false,
            "disableZoomControl": false,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "mapPageSize": 16384,
            "markerOffsetX": 0.5,
            "markerOffsetY": 1,
            "posFunction": "return {x: origXPos, y: origYPos};",
            "draggableMarker": true,
            "showLabel": true,
            "useLabelFunction": false,
            "label": "${entityName}",
            "labelFunction": "var deviceType = dsData[dsIndex]['Type'];\r\nif (typeof deviceType !== undefined) {\r\n    if (deviceType == \"energy meter\") {\r\n        return '<span style=\"color:orange;\">${entityName}, ${energy:2} kWt</span>';\r\n    } else if (deviceType == \"thermometer\") {\r\n        return '<span style=\"color:blue;\">${entityName}, ${temperature:2} °C</span>';\r\n    }\r\n}",
            "showTooltip": false,
            "showTooltipAction": "click",
            "autocloseTooltip": true,
            "useTooltipFunction": false,
            "tooltipPattern": "<b>${entityName}</b><br/><br/><link-act name='Doktorkit-devices'>Doktorkit devices</link-act>",
            "tooltipFunction": "var deviceType = dsData[dsIndex]['Type'];\r\nif (typeof deviceType !== undefined) {\r\n    if (deviceType == \"energy meter\") {\r\n        return '<b>${entityName}</b><br/><b>Energy:</b> ${energy:2} kWt<br/>';\r\n    } else if (deviceType == \"thermometer\") {\r\n        return '<b>${entityName}</b><br/><b>Temperature:</b> ${temperature:2} °C<br/>';\r\n    }\r\n}",
            "tooltipOffsetX": 0,
            "tooltipOffsetY": -1,
            "color": "#fe7569",
            "useColorFunction": false,
            "useMarkerImageFunction": true,
            "markerImageSize": 34,
            "markerImageFunction": "var width = 30;\nvar svgStr = getDoktorkitSvg(width);\nvar encodedSvg = encodeURIComponent(svgStr);\nvar svgUrl = 'data:image/svg+xml,' + encodedSvg;\n\nreturn {\n    url: svgUrl,\n    size: width,\n    markerOffset: [width / 2, width / 2],\n    tooltipOffset: [width * 0.5 - width / 2, - (width / 2)]\n};\n\nfunction getDoktorkitSvg(width, isSelected) {\n    var shape = '<path d=\"m18.636 15.8c0.59978 0 1.1276-0.32788 1.3995-0.82369l2.8629-5.1901c0.29589-0.5278-0.08796-1.1836-0.69574-1.1836h-11.836l-0.75172-1.5994h-2.615v1.5994h1.5994l2.8789 6.0697-1.0796 1.9513c-0.58378 1.0716 0.18393 2.3751 1.3995 2.3751h9.5964v-1.5994h-9.5964l0.87967-1.5994zm-7.5092-5.5979h9.7164l-2.2072 3.9985h-5.6139zm0.67175 9.5964c-0.87967 0-1.5914 0.71973-1.5914 1.5994s0.71174 1.5994 1.5914 1.5994 1.5994-0.71973 1.5994-1.5994-0.71973-1.5994-1.5994-1.5994zm7.997 0c-0.87967 0-1.5914 0.71973-1.5914 1.5994s0.71174 1.5994 1.5914 1.5994c0.87967 0 1.5994-0.71973 1.5994-1.5994s-0.71973-1.5994-1.5994-1.5994z\" fill=\"white\" stroke-width=\".7997\"/>';\n    var color = '#1F8B4D';\n    var background = getBackground(color);\n    var svgWidth = width;\n    var svgHeight = 30;\n    \n    var opacity = 1;\n    \n    var DoktorkitSvg = '<svg opacity=\"' + opacity + '\" width=\"' + svgWidth + '\" height=\"' + svgHeight + '\" viewBox=\"0 0 ' + svgWidth + ' ' + svgHeight + '\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                    background + shape;\n    DoktorkitSvg += '</svg>';\n    return DoktorkitSvg;    \n}\n\nfunction getBackground(color) {\n     return '<circle cx=\"15\" cy=\"15\" r=\"15\" fill=\"'+ color +'\"/>';\n}\n",
            "markerImages": [],
            "showPolygon": false,
            "polygonKeyName": "perimeter",
            "editablePolygon": false,
            "showPolygonLabel": false,
            "usePolygonLabelFunction": false,
            "polygonLabel": "${entityName}",
            "showPolygonTooltip": false,
            "showPolygonTooltipAction": "click",
            "autoClosePolygonTooltip": true,
            "usePolygonTooltipFunction": false,
            "polygonTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "polygonColor": "#3388ff",
            "polygonOpacity": 0.2,
            "usePolygonColorFunction": false,
            "polygonStrokeColor": "#3388ff",
            "polygonStrokeOpacity": 1,
            "polygonStrokeWeight": 3,
            "usePolygonStrokeColorFunction": false,
            "showCircle": false,
            "circleKeyName": "perimeter",
            "editableCircle": false,
            "showCircleLabel": false,
            "useCircleLabelFunction": false,
            "circleLabel": "${entityName}",
            "showCircleTooltip": false,
            "showCircleTooltipAction": "click",
            "autoCloseCircleTooltip": true,
            "useCircleTooltipFunction": false,
            "circleTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "circleFillColor": "#3388ff",
            "circleFillColorOpacity": 0.2,
            "useCircleFillColorFunction": false,
            "circleStrokeColor": "#3388ff",
            "circleStrokeOpacity": 1,
            "circleStrokeWeight": 3,
            "useCircleStrokeColorFunction": false,
            "snappable": false,
            "initDragMode": true,
            "hideAllControlButton": true,
            "useClusterMarkers": false,
            "zoomOnClick": true,
            "maxClusterRadius": 80,
            "animate": true,
            "spiderfyOnMaxZoom": false,
            "showCoverageOnHover": true,
            "chunkedLoading": false,
            "removeOutsideVisibleBounds": true,
            "useIconCreateFunction": false
          },
          "title": "Edit Doktorkit location",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "widgetStyle": {},
          "actions": {
            "markerClick": [],
            "tooltipAction": []
          },
          "showTitleIcon": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "titleTooltip": ""
        },
        "row": 0,
        "col": 0,
        "id": "1d0b53f4-7805-fbfd-1cc6-e91d0df3d4bf",
        "typeFullFqn": "system.maps_v2.openstreetmap"
      },
      "59df0b6f-17dd-3c4c-a484-69c0836246da": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "floorplan",
                  "type": "attribute",
                  "label": "floorplan",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.5234606901361916
                }
              ]
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": true,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "showResultMessage": false,
            "displayPreview": true,
            "displayClearButton": false,
            "widgetTitle": "Floor plan",
            "displayApplyButton": false,
            "displayDiscardButton": true
          },
          "title": "Floor plan",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "actions": {},
          "showTitleIcon": false,
          "titleTooltip": "",
          "widgetCss": "",
          "noDataDisplayMessage": ""
        },
        "row": 0,
        "col": 0,
        "id": "59df0b6f-17dd-3c4c-a484-69c0836246da",
        "typeFullFqn": "system.input_widgets.update_server_image_attribute"
      },
      "eac6e38e-62f2-1f91-754b-299d11e87c19": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "entitiesTitle": "Devices",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 15,
            "defaultSortOrder": "Name",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Devices",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "62e540a9-69d4-98ce-afbc-1c3f7bc147a5",
              "filterId": "82f574c5-8303-0be1-01fa-b108c6097a90",
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Name",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.46096251592014714
                },
                {
                  "name": "type",
                  "type": "entityField",
                  "label": "{i18n:custom.gateways.type}",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var type = value;\n\nvar typeSvg = getTypeSvg(type);\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\n\nreturn '<span>'+\n           '<img style=\"vertical-align: middle;\" class=\"mat-icon\" src=\"'+ typeSvgUrl +'\">' +\n           '<span style=\"vertical-align: middle; padding-left: 8px;\">'+ type +'</span>' +\n       '</span>';\n            \nfunction getTypeSvg(type) {\n    var typeSvg;\n    switch (type) {\n        case 'Smart Shelf':\n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M2.5 2C2.22386 2 2 2.22386 2 2.5V17.5C2 17.7761 2.22386 18 2.5 18C2.77614 18 3 17.7761 3 17.5V17H17V17.5C17 17.7761 17.2239 18 17.5 ' +\n                      '18C17.7761 18 18 17.7761 18 17.5V2.5C18 2.22386 17.7761 2 17.5 2C17.2239 2 17 2.22386 17 2.5V8H14C14.5523 8 15 7.55228 15 7V4C15 3.44772 14.5523 3 14 3H11C10.4477 3 10 3.44772 10 4V7C10 ' +\n                      '7.55228 10.4477 8 11 8H7C7.55228 8 8 7.55228 8 7V6C8 5.44772 7.55228 5 7 5H6C5.44772 5 5 5.44772 5 6V7C5 7.55228 5.44772 8 6 8H3V2.5C3 2.22386 2.77614 2 2.5 2ZM17 16V9H3V16H6C5.44772 16 ' +\n                      '5 15.5523 5 15V12C5 11.4477 5.44772 11 6 11H9C9.55228 11 10 11.4477 10 12V15C10 15.5523 9.55228 16 9 16H12C11.4477 16 11 15.5523 11 15V13C11 12.4477 11.4477 12 12 12H14C14.5523 12 15 ' +\n                      '12.4477 15 13V15C15 15.5523 14.5523 16 14 16H17Z\" fill=\"#212121\"/>';\n            break;\n        case 'Freezer':            \n            typeSvg = '<rect x=\"9\" y=\"2\" width=\"2\" height=\"16\" rx=\"1\" fill=\"#212121\"/>' +\n                      '<path d=\"M12.5 3.5L10 6L7.5 3.5M12.5 16.5L10 14L7.5 16.5\" stroke=\"#212121\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>' +\n                      '<path d=\"M16.8792 8.91509L13.4641 8.00002L14.3792 4.58496M5.62082 15.4151L6.53588 12L3.12082 11.085\" stroke=\"#212121\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>' +\n                      '<path d=\"M5.62085 4.58491L6.53591 7.99998L3.12085 8.91504M16.8792 11.0849L13.4641 12L14.3792 15.415\" stroke=\"#212121\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>' +\n                      '<rect x=\"16.4282\" y=\"5.13379\" width=\"2\" height=\"16\" rx=\"1\" transform=\"rotate(60 16.4282 5.13379)\" fill=\"#212121\"/>' +\n                      '<rect x=\"2.57178\" y=\"6.86621\" width=\"2\" height=\"16\" rx=\"1\" transform=\"rotate(-60 2.57178 6.86621)\" fill=\"#212121\"/>';\n            break;\n        case 'Chiller':            \n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M13.0001 7.49994C13.0001 8.53714 12.2661 9.2516 11.4454 9.64333C11.2807 9.72191 11.1185 9.75061 10.9657 9.73874C10.9881 9.82201 ' +\n                      '11.0001 9.90957 11.0001 9.99994C11.0001 10.0304 10.9988 10.0605 10.9961 10.0902C11.1511 10.0322 11.322 9.99993 11.5001 9.99993L12.5001 9.99994L13.5 9.99993C14.3285 9.99992 15.0003 ' +\n                      '10.6975 14.6435 11.4452C14.2517 12.2658 13.5373 12.9999 12.5001 12.9999C11.4629 12.9999 10.7484 12.2658 10.3567 11.4452C10.2781 11.2805 10.2494 11.1184 10.2613 10.9655C10.178 10.988 ' +\n                      '10.0905 10.9999 10.0001 10.9999C9.96965 10.9999 9.93949 10.9986 9.90971 10.9959C9.96779 11.1509 10 11.3218 10 11.5L10 12.4999L10 13.4999C10.0001 14.3284 9.30246 15.0002 8.55482 ' +\n                      '14.6433C7.73413 14.2516 7.00006 13.5371 7.00006 12.4999C7.00006 11.4627 7.73413 10.7483 8.55482 10.3566C8.71948 10.278 8.8817 10.2493 9.03459 10.2611C9.01212 10.1779 9.00013 10.0903 ' +\n                      '9.00013 9.99994C9.00013 9.9695 9.00149 9.93938 9.00416 9.90963C8.84921 9.96766 8.67837 9.9999 8.50029 9.99989L7.50031 9.99988L6.50033 9.99989C5.67189 9.9999 5.00006 9.3023 5.35692 ' +\n                      '8.55467C5.74865 7.73397 6.46311 6.99991 7.50031 6.99991C8.5375 6.99991 9.25197 7.73397 9.6437 8.55467C9.72227 8.71929 9.75098 8.88149 9.73911 9.03435C9.82232 9.01191 9.90983 8.99994 ' +\n                      '10.0001 8.99994C10.0306 8.99994 10.0607 9.0013 10.0905 9.00397C10.0324 8.84898 10.0002 8.67807 10.0002 8.49992L10.0002 7.49994L10.0002 6.49996C10.0001 5.67153 10.6977 4.99969 11.4454 ' +\n                      '5.35655C12.2661 5.74828 13.0001 6.46274 13.0001 7.49994Z\" fill=\"#212121\"/>' +\n                      '<circle cx=\"10\" cy=\"10\" r=\"8\" stroke=\"#212121\" stroke-width=\"2\"/>';\n            break;                      \n        case 'Smart Bin':\n            typeSvg = '<path d=\"M6.71849 14C5.15241 14 4.19394 12.2816 5.01686 10.9491L5.09816 10.8175C5.17797 10.8327 5.26094 10.8383 5.34575 10.8332C5.89704 10.8001 6.31713 10.3264 6.28404 9.77509L6.21705 8.65906C6.19838 8.34795 6.03571 8.06333 5.77714 7.88933C5.51856 7.71533 5.19363 7.67184 4.8984 7.77171L3.93237 8.09851C3.40921 8.27549 3.12858 8.84306 3.30556 9.36622C3.34237 9.47504 3.39608 9.57337 3.46278 9.65927L3.31523 9.89818C1.66939 12.5631 3.58633 16 6.71849 16H7.83485C8.38714 16 8.83485 15.5523 8.83485 15C8.83485 14.4478 8.38714 14 7.83485 14L6.71849 14Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M13.3135 13.8409C14.8789 13.8873 15.8879 12.198 15.1048 10.8418L14.5467 9.87495C14.2705 9.39666 14.4344 8.78507 14.9127 8.50893C15.391 8.23279 16.0026 8.39666 16.2787 8.87495L16.8369 9.84175C18.403 12.5543 16.3849 15.9329 13.2542 15.84L12.9735 15.8317C12.9324 15.9324 12.8741 16.0281 12.7983 16.1143C12.4337 16.5292 11.8019 16.5699 11.387 16.2054L10.621 15.5322C10.3869 15.3264 10.2621 15.0233 10.2835 14.7123C10.3049 14.4014 10.47 14.1182 10.7301 13.9465L11.6632 13.3305C12.124 13.0262 12.7444 13.1531 13.0487 13.614C13.0955 13.6849 13.1321 13.7596 13.1588 13.8363L13.3135 13.8409Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M11.6696 5.21002C10.9272 3.83113 8.95968 3.80195 8.17664 5.15821L7.61846 6.12501C7.34232 6.6033 6.73073 6.76718 6.25244 6.49104C5.77414 6.21489 5.61027 5.6033 5.88641 5.12501L6.44459 4.15821C8.01067 1.44568 11.9456 1.50404 13.4306 4.26183L13.5637 4.50907C13.6715 4.49425 13.7835 4.4969 13.8961 4.51943C14.4377 4.62774 14.7889 5.15457 14.6806 5.69613L14.4806 6.69613C14.4195 7.00175 14.2193 7.26139 13.9393 7.39833C13.6594 7.53526 13.3315 7.53382 13.0528 7.39444L12.0528 6.89444C11.5588 6.64745 11.3586 6.04678 11.6056 5.5528C11.6436 5.47681 11.6899 5.40777 11.743 5.34624L11.6696 5.21002Z\" fill=\"#212121\"/>';\n            break;          \n        case 'Door Sensor':\n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M14 4H6V16H14V4ZM8 12C8.55228 12 9 11.5523 9 11C9 10.4477 8.55228 10 8 10C7.44772 10 7 10.4477 7 11C7 11.5523 7.44772 12 8 12Z\" fill=\"#212121\"/>' +\n                      '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M16 17V3C16 2.44772 15.5523 2 15 2H5C4.44772 2 4 2.44772 4 3V17H3.5C3.22386 17 3 17.2239 3 17.5C3 17.7761 3.22386 18 3.5 18H16.5C16.7761 18 17 17.7761 17 17.5C17 17.2239 16.7761 17 16.5 17H16ZM15 3H5L5 17H15V3Z\" fill=\"#212121\"/>';\n            break;\n        case 'Liquid Level Sensor':\n            typeSvg = '<path d=\"M14.6363 0.453212C14.8228 0.210257 15.1772 0.210257 15.3637 0.453213C15.9404 1.2044 17 2.73057 17 3.80373C17 5.02723 16.1143 5.99982 15 5.99982C13.8857 5.99982 13 5.02723 13 3.80373C13 2.73057 14.0596 1.2044 14.6363 0.453212Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M8.3017 2.76073C8.67788 2.33798 9.32212 2.33798 9.6983 2.76073C11.2801 4.53832 15 9.0479 15 12.1437C15 15.4064 12.3427 18 9 18C5.65725 18 3 15.4064 3 12.1437C3 9.0479 6.71994 4.53832 8.3017 2.76073Z\" fill=\"#212121\"/>';\n            break;\n        case 'Motion Sensor':\n            typeSvg = '<path d=\"M2.5 5C2.22386 5 2 5.22386 2 5.5C2 5.77614 2.22386 6 2.5 6H4C4 6.55228 4.44772 7 5 7H15C15.5523 7 16 6.55228 16 6H17.5C17.7761 6 18 5.77614 18 5.5C18 5.22386 17.7761 5 17.5 5H2.5Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M12.0001 12C12.5524 12 13.0001 11.5523 13.0001 11C13.0001 10.4477 12.5524 10 12.0001 10C11.4478 10 11.0001 10.4477 11.0001 11C11.0001 11.5523 11.4478 12 12.0001 12Z\" fill=\"#212121\"/>' +\n                      '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M10.0001 16C14.0804 16 17.4472 12.9453 17.9384 8.99801C18.0066 8.44996 17.5524 8 17.0001 8H3.00009C2.4478 8 1.99353 8.44996 2.06173 8.99801C2.55295 12.9453 5.91978 16 10.0001 16ZM12.0001 13C13.1047 13 14.0001 12.1046 14.0001 11C14.0001 9.89543 13.1047 9 12.0001 9C10.8955 9 10.0001 9.89543 10.0001 11C10.0001 12.1046 10.8955 13 12.0001 13Z\" fill=\"#212121\"/>';\n            break;\n        case 'Occupancy Sensor':\n            typeSvg = '<path d=\"M7 3.5C7 4.32843 6.32843 5 5.5 5C4.67157 5 4 4.32843 4 3.5C4 2.67157 4.67157 2 5.5 2C6.32843 2 7 2.67157 7 3.5Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M3 12C2.44772 12 2 11.5523 2 11L2 7.88652C2 6.84462 2.84462 6 3.88652 6C3.90535 6 3.92403 6.00055 3.94255 6.00162C3.96157 6.00055 3.98072 6 4 6H7C7.01928 6 7.03843 6.00055 7.05745 6.00162C7.07597 6.00055 7.09465 6 7.11348 6C8.15538 6 9 6.84462 9 7.88652V11C9 11.5523 8.55229 12 8 12V17C8 17.5523 7.55228 18 7 18C6.44772 18 6 17.5523 6 17L6 14H5V17C5 17.5523 4.55228 18 4 18C3.44772 18 3 17.5523 3 17V12Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M16 18C15.4477 18 15 17.5523 15 17V14H14V17C14 17.5523 13.5523 18 13 18C12.4477 18 12 17.5523 12 17V14H10.7215C10.3724 14 10.1308 13.6513 10.2533 13.3244L12.4733 7.40449C12.7901 6.55968 13.5977 6 14.5 6C15.4023 6 16.2099 6.55968 16.5267 7.40449L18.7467 13.3244C18.8692 13.6513 18.6276 14 18.2785 14H17V17C17 17.5523 16.5523 18 16 18Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M14.5 5C15.3284 5 16 4.32843 16 3.5C16 2.67157 15.3284 2 14.5 2C13.6716 2 13 2.67157 13 3.5C13 4.32843 13.6716 5 14.5 5Z\" fill=\"#212121\"/>';\n            break;\n        case 'Smoke Sensor':\n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M9.64491 2.08319C9.48444 1.9888 9.28482 1.99138 9.12685 2.08988C8.96887 2.18839 8.87871 2.3665 8.89285 2.55213C8.98169 3.71876 8.78795 4.5943 8.45363 5.30483C8.11607 6.02225 7.62209 6.60008 7.06387 7.157C6.88401 7.33644 6.69008 7.52013 6.49214 7.70763C6.10197 8.07721 5.69618 8.46158 5.35189 8.85718C4.81113 9.47853 4.35082 10.1982 4.15741 11.131C3.35478 15.0023 6.43952 18.1649 10.361 17.9822C10.41 17.9806 10.4592 17.9779 10.5088 17.9741L10.55 17.9708L10.5673 17.9695C10.6635 17.9622 10.7585 17.9532 10.8523 17.9427C10.897 17.9427 10.9422 17.9409 10.9878 17.9375C11.1369 17.9261 11.2735 17.9002 11.3976 17.8614C12.9028 17.5787 14.0571 16.8581 14.836 15.8302C15.7453 14.6303 16.1036 13.0646 15.9781 11.4151C15.7275 8.1215 13.5473 4.37866 9.64491 2.08319ZM12.1372 15.5326C12.1487 15.5269 12.1601 15.521 12.1714 15.5152C12.2227 15.2706 12.2393 15.0003 12.2172 14.7101C12.1353 13.6344 11.5243 12.3752 10.3912 11.4298C10.3443 11.6743 10.2711 11.8979 10.1767 12.1045C9.97248 12.5515 9.68116 12.8915 9.40451 13.1748C9.2918 13.2902 9.1897 13.3891 9.09461 13.4812C8.93666 13.6341 8.79804 13.7684 8.66241 13.9284C8.46694 14.1591 8.33595 14.3839 8.28119 14.6575C8.20904 15.018 8.23357 15.3634 8.33595 15.6725C8.69526 15.8186 9.08844 15.9185 9.50948 15.9633C9.62655 15.764 9.79981 15.6036 9.97777 15.4389C10.3505 15.0938 10.7439 14.7297 10.6844 13.949C11.3929 14.3558 11.8813 14.938 12.1372 15.5326ZM13.2143 14.6343L13.2159 14.6563L13.2421 14.6222C13.7907 13.8983 14.0816 12.8503 13.9839 11.5668C13.8301 9.5445 12.7138 7.15459 10.6097 5.25541C10.5143 5.57021 10.3981 5.86993 10.2634 6.15628C9.78098 7.18157 9.09869 7.9521 8.47652 8.57282C8.20885 8.83986 7.97694 9.05847 7.76612 9.25719C7.43058 9.57348 7.14846 9.83941 6.86065 10.1701C6.45742 10.6334 6.21678 11.0502 6.11585 11.537C5.83546 12.8894 6.29313 14.1616 7.23945 14.9971C7.24423 14.8222 7.26422 14.6432 7.30064 14.4613C7.39921 13.9687 7.63564 13.5933 7.89951 13.2819C8.06367 13.0882 8.26661 12.8908 8.44919 12.7131C8.53584 12.6288 8.61792 12.549 8.68907 12.4761C8.93347 12.2258 9.13295 11.9826 9.26713 11.689C9.39844 11.4016 9.47964 11.0379 9.44124 10.5337C9.42702 10.347 9.51835 10.168 9.67788 10.0698C9.83741 9.97174 10.0384 9.97101 10.1986 10.068C12.0451 11.1851 13.0906 13.0082 13.2143 14.6343Z\" fill=\"#212121\"/>';\n            break;\n        default:\n            typeSvg = '<circle cx=\"10\" cy=\"10\" r=\"10\" fill=\"#AAAAAA\"/>';\n    }\n    \n    return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' + \n           typeSvg +\n           '</svg>';\n} \n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.8077097060074172,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.4057433451983201
                },
                {
                  "name": "state",
                  "type": "attribute",
                  "label": "{i18n:custom.gateways.state}",
                  "color": "#ffc107",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var state = value;\nvar active = entity.active;\nif (active === 'false') {\n    state = '{i18n:custom.gateways.state-disconnected}';\n}\n\nvar stateSvg = getStateSvg(state);\nvar encodedStateSvg = encodeURIComponent(stateSvg);\nvar stateSvgUrl = 'data:image/svg+xml,' + encodedStateSvg;\nvar stateLabel = getStateLabel(state);\n\nreturn '<span>'+\n           '<img style=\"vertical-align: middle;\" class=\"mat-icon\" src=\"'+ stateSvgUrl +'\">' +\n           '<span style=\"vertical-align: middle; padding-left: 8px;\">'+ stateLabel +'</span>' +\n       '</span>';\n            \nfunction getStateSvg(state) {\n    switch (state) {\n        case 'critical':\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#E64A19\"/>' +\n                   '</svg>';\n        case 'major':            \n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#D5C21B\"/>' +\n                   '</svg>';\n        case 'normal':            \n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#1F8B4D\"/>' +\n                   '</svg>';\n        case 'disconnected':\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<g clip-path=\"url(#clip0_2839_52564)\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#CAC1D2\"/>' +\n                   '<path d=\"M1.92896 16.728L16.0711 2.58589L17.4853 4.00011L3.34317 18.1422L1.92896 16.728Z\" fill=\"#CAC1D2\"/>' +\n                   '<path d=\"M2.10692 16.3171C1.81393 16.0241 1.81393 15.5491 2.10692 15.2561L15.1852 2.17788C15.4781 1.88489 15.9532 1.88489 16.2462 2.17788C16.5392 2.47088 16.5392 2.94591 16.2462 3.2389L3.16794 16.3171C2.87495 16.6101 2.39991 16.6101 2.10692 16.3171Z\" fill=\"white\"/>' +\n                   '</g>' +\n                   '<defs>' +\n                   '<clipPath id=\"clip0_2839_52564\">' +\n                   '<rect width=\"20\" height=\"20\" fill=\"white\"/>' +\n                   '</clipPath>' +\n                   '</defs>' +\n                   '</svg>';\n        default:\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#AAAAAA\"/>' +\n                   '</svg>';\n    }\n}\n\nfunction getStateLabel(state) {\n    switch(state) {\n        case 'critical':\n            return '{i18n:custom.gateways.state-critical}';\n        case 'major':\n            return '{i18n:custom.gateways.state-major}';\n        case 'normal':\n            return '{i18n:custom.gateways.state-normal}';\n        case 'disconnected':\n            return '{i18n:custom.gateways.state-disconnected}';\n        default:\n            return state;\n    }\n}\n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.2718881518921066,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "active",
                  "type": "attribute",
                  "label": "{i18n:custom.gateways.active}",
                  "color": "#607d8b",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "hidden",
                    "columnSelectionToDisplay": "disabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.04680501891139488,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "project",
                  "type": "attribute",
                  "label": "{i18n:custom.gateways.project}",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.2617792188724928,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "measurement",
                  "type": "attribute",
                  "label": "{i18n:custom.gateways.measurement}",
                  "color": "#8bc34a",
                  "settings": {},
                  "_hash": 0.9181385907135764,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "div.tb-widget .tb-widget-title {\n    max-height: 100px !important;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "rowClick": [],
            "headerButton": [
              {
                "name": "{i18n:action.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n\r\n//params['selectedCustomer'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "66f53718-bc29-30d8-1502-fe32699c77ca"
              },
              {
                "name": "{i18n:custom.devices.add-device-manually}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDeviceFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 350px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.device.add-device' | translate }}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field class=\"mat-block\">\n      <mat-label>{{ 'custom.devices.device-type' | translate }}</mat-label>\n      <mat-select formControlName=\"type\" (selectionChange)=\"onDeviceTypeChange($event.value)\" required>\n        <mat-option *ngFor=\"let type of deviceTypes\" [value]=\"type\">\n          {{ type }}\n        </mat-option>\n      </mat-select>\n      <mat-error *ngIf=\"addDeviceFormGroup.get('type').hasError('required')\">\n        {{ 'custom.devices.device-type-is-required' | translate }}\n      </mat-error>\n    </mat-form-field>\n    <mat-form-field appearance=\"fill\" class=\"w-full\">\n      <mat-label>{{ 'custom.devices.device-name' | translate }}</mat-label>\n      <input matInput formControlName=\"name\" required>\n      <mat-error *ngIf=\"addDeviceFormGroup.get('name').hasError('required')\">\n        {{ 'custom.devices.device-name-is-required' | translate }}\n      </mat-error>\n    </mat-form-field>\n\n    <!-- Serial Number field for Doktorkit (P-Flow D116) and Temperature Sensor -->\n    <div *ngIf=\"selectedDeviceType === 'P-Flow D116' || selectedDeviceType === 'Temperature Sensor'\">\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>{{ 'custom.gateways.add-gateway-serial-number' | translate }}</mat-label>\n        <input matInput formControlName=\"serialNumber\" required>\n        <mat-error *ngIf=\"addDeviceFormGroup.get('serialNumber').hasError('required')\">\n          {{ 'custom.devices.serial-number-is-required' | translate }}\n        </mat-error>\n      </mat-form-field>\n    </div>\n\n    <!-- devEUI field for Room Sensor T, Room Sensor CO2, and other Sensor Kits -->\n    <div *ngIf=\"selectedDeviceType === 'Room Sensor T' || selectedDeviceType === 'Room Sensor CO2'\">\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>devEUI</mat-label>\n        <input matInput formControlName=\"devEUI\" required pattern=\"[a-zA-Z0-9]{16}\">\n        <mat-error *ngIf=\"addDeviceFormGroup.get('devEUI').hasError('required')\">\n          {{ 'custom.devices.deveui-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"addDeviceFormGroup.get('devEUI').hasError('pattern')\">\n          {{ 'custom.devices.deveui-must-be-16-alphanummeric-characters' | translate }}\n        </mat-error>\n      </mat-form-field>\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\n        <mat-label>appKey</mat-label>\n        <input matInput formControlName=\"appKey\" required pattern=\"[a-zA-Z0-9]{32}\">\n        <mat-error *ngIf=\"addDeviceFormGroup.get('appKey').hasError('required')\">\n          {{ 'custom.devices.appkey-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"addDeviceFormGroup.get('appKey').hasError('pattern')\">\n          {{ 'custom.devices.appkey-must-be-32-alphanummeric-characters' | translate }}\n        </mat-error>\n      </mat-form-field>\n    </div>\n\n    <mat-form-field appearance=\"fill\" class=\"w-full\">\n      <mat-label>{{ 'custom.devices.device-label' | translate }}</mat-label>\n      <input matInput formControlName=\"label\">\n    </mat-form-field>\n  </div>\n\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'custom.devices.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addDeviceFormGroup.invalid || !addDeviceFormGroup.dirty\">\n      {{ 'custom.device.add-device' | translate }}\n    </button>\n  </div>\n</form>",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*.mat-form-field input[disabled] {\n  background-color: #f5f5f5;\n  cursor: not-allowed; \n  color: #9e9e9e;\n  \n}*/",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet PageLink = widgetContext.servicesMap.get('PageLink');\r\n\r\nopenAddDeviceDialog();\r\n\r\nfunction openAddDeviceDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddDeviceDialogController).subscribe();\r\n}\r\n\r\nfunction AddDeviceDialogController(instance) {\r\n  let vm = instance;\r\n  let customerID = widgetContext.stateController.getStateParams().entityId.id;\r\n  let customerName = widgetContext.stateController.getStateParams().entityName;\r\n  let customerShortName;\r\n\r\n  vm.deviceTypes = [\r\n    'P-Flow D116',\r\n    'Temperature Sensor',\r\n    /*'Room Sensor T',*/\r\n    'Room Sensor CO2',\r\n    /*'LTE Status'*/\r\n  ];\r\n\r\n  vm.deviceTypeShortNames = {\r\n    'P-Flow D116': 'PF',\r\n    'Temperature Sensor': 'TS',\r\n    /*'Room Sensor T': 'RT',*/\r\n    'Room Sensor CO2': 'RSCO2'\r\n  };\r\n\r\n  vm.selectedDeviceType = '';\r\n\r\n  vm.addDeviceFormGroup = vm.fb.group({\r\n    name: [''], // leave it editable\r\n    type: ['', [vm.validators.required]],\r\n    label: [''],\r\n    serialNumber: [''],\r\n    devEUI: ['', [vm.validators.pattern('[a-zA-Z0-9]{16}')]],\r\n    appKey: ['']\r\n  });\r\n\r\n  attributeService.getEntityAttributes(\r\n    { entityType: 'CUSTOMER', id: customerID },\r\n    'SERVER_SCOPE',\r\n    ['shortName']\r\n  ).subscribe(attributes => {\r\n    let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n    customerShortName = shortNameAttr\r\n      ? shortNameAttr.value\r\n      : generateCustomerShortName(customerName);\r\n\r\n    // Update the name only if it has not been manually modified.\r\n    vm.addDeviceFormGroup.get('serialNumber').valueChanges.subscribe(() => {\r\n      setTimeout(() => {\r\n        let nameControl = vm.addDeviceFormGroup.get('name');\r\n        if (nameControl.pristine) {\r\n          nameControl.setValue(constructDeviceName(customerShortName, vm.deviceTypeShortNames, vm.addDeviceFormGroup.value));\r\n        }\r\n      }, 0);\r\n    });\r\n\r\n    vm.addDeviceFormGroup.get('devEUI').valueChanges.subscribe(() => {\r\n      setTimeout(() => {\r\n        let nameControl = vm.addDeviceFormGroup.get('name');\r\n        if (nameControl.pristine) {\r\n          nameControl.setValue(constructDeviceName(customerShortName, vm.deviceTypeShortNames, vm.addDeviceFormGroup.value));\r\n        }\r\n      }, 0);\r\n    });\r\n\r\n    vm.addDeviceFormGroup.get('type').valueChanges.subscribe(() => {\r\n      let nameControl = vm.addDeviceFormGroup.get('name');\r\n      if (nameControl.pristine) {\r\n        nameControl.setValue(constructDeviceName(customerShortName, vm.deviceTypeShortNames, vm.addDeviceFormGroup.value));\r\n      }\r\n    });\r\n  });\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  vm.save = function () {\r\n    // Do not override the name here so that manual edits remain.\r\n    let customerId = widgetContext.stateController.getStateParams().entityId;\r\n    let formValues = vm.addDeviceFormGroup.value;\r\n    vm.addDeviceFormGroup.markAsPristine();\r\n\r\n    getTargetDeviceGroups(customerId).pipe(\r\n      widgetContext.rxjs.switchMap(([doktorkitGroup, unassignedDoktorkitGroup, unassignedMeasurementGroup]) => {\r\n        return saveDeviceObservable(\r\n          customerId,\r\n          doktorkitGroup,\r\n          unassignedDoktorkitGroup,\r\n          unassignedMeasurementGroup\r\n        );\r\n      })\r\n    ).subscribe(device => {\r\n      saveAttributes(device.id).subscribe(() => {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n      });\r\n    });\r\n  };\r\n\r\n  function constructDeviceName(customerShortName, deviceTypeShortNames, formValues) {\r\n    let identifier = formValues.serialNumber || formValues.devEUI;\r\n    let typeShortName = deviceTypeShortNames[formValues.type] || '';\r\n    return 'ECO' + '_' + identifier + '_' + typeShortName;\r\n  }\r\n\r\n  function saveDeviceObservable(\r\n    customerId,\r\n    doktorkitGroup,\r\n    unassignedDoktorkitGroup,\r\n    unassignedMeasurementGroup\r\n  ) {\r\n    const formValues = vm.addDeviceFormGroup.value;\r\n    let device = {\r\n      name: formValues.name,\r\n      type: formValues.type,\r\n      label: formValues.label,\r\n      customerId: customerId,\r\n      serialNumber: formValues.serialNumber,\r\n      devEUI: formValues.devEUI,\r\n      appKey: formValues.appKey\r\n    };\r\n\r\n    return deviceService.saveDevice(device, unassignedDoktorkitGroup.id.id).pipe(\r\n      widgetContext.rxjs.switchMap(savedDevice => {\r\n        return widgetContext.rxjs.forkJoin([\r\n          entityGroupService.addEntityToEntityGroup(doktorkitGroup.id.id, savedDevice.id.id),\r\n          entityGroupService.addEntityToEntityGroup(unassignedMeasurementGroup.id.id, savedDevice.id.id)\r\n        ]).pipe(\r\n          widgetContext.rxjs.map(() => savedDevice)\r\n        );\r\n      })\r\n    );\r\n  }\r\n\r\n  function getTargetDeviceGroups(customerId) {\r\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n      widgetContext.rxjs.switchMap(groups => {\r\n        return widgetContext.rxjs.forkJoin([\r\n          getOrCreateDevicesGroup(groups, 'Diagnostickit Devices', customerId),\r\n          getOrCreateDevicesGroup(groups, 'Unassigned Diagnostickit Devices', customerId),\r\n          getOrCreateDevicesGroup(groups, 'Unassigned Measurement Devices', customerId)\r\n        ]);\r\n      })\r\n    );\r\n  }\r\n\r\n  function getOrCreateDevicesGroup(groups, groupName, customerId) {\r\n    let devicesGroup = groups.find(group => group.name === groupName);\r\n    if (devicesGroup) {\r\n      return widgetContext.rxjs.of(devicesGroup);\r\n    } else {\r\n      devicesGroup = {\r\n        type: 'DEVICE',\r\n        name: groupName,\r\n        ownerId: customerId\r\n      };\r\n      return entityGroupService.saveEntityGroup(devicesGroup);\r\n    }\r\n  }\r\n\r\n  function saveAttributes(entityId) {\r\n    let formValues = vm.addDeviceFormGroup.value;\r\n    let attributesArray = [\r\n      { key: 'state', value: 'normal' },\r\n      { key: 'inactivityTimeout', value: '3700000' }\r\n    ];\r\n\r\n    if (formValues.type === 'Room Sensor CO2' || formValues.type === 'Room Sensor T') {\r\n      attributesArray.push(\r\n        { key: 'devEui', value: formValues.devEUI },\r\n        { key: 'appKey', value: formValues.appKey }\r\n      );\r\n    }\r\n\r\n    return attributeService.saveEntityAttributes(entityId, 'SERVER_SCOPE', attributesArray);\r\n  }\r\n\r\n  vm.onDeviceTypeChange = function (selectedType) {\r\n    vm.selectedDeviceType = selectedType;\r\n    if (selectedType === 'P-Flow D116' || selectedType === 'Temperature Sensor') {\r\n      vm.addDeviceFormGroup.get('serialNumber').setValidators([vm.validators.required]);\r\n      vm.addDeviceFormGroup.get('devEUI').clearValidators();\r\n    } else if (selectedType === 'Room Sensor T' || selectedType === 'Room Sensor CO2') {\r\n      vm.addDeviceFormGroup.get('serialNumber').clearValidators();\r\n      vm.addDeviceFormGroup.get('devEUI').setValidators([\r\n        vm.validators.required,\r\n        vm.validators.pattern('[a-zA-Z0-9]{16}')\r\n      ]);\r\n    }\r\n    vm.addDeviceFormGroup.get('serialNumber').updateValueAndValidity();\r\n    vm.addDeviceFormGroup.get('devEUI').updateValueAndValidity();\r\n  };\r\n}\r\n\r\nfunction generateCustomerShortName(fullName) {\r\n  return fullName\r\n    .split(/\\s+/)\r\n    .map(word => word.charAt(0).toUpperCase())\r\n    .join('');\r\n}\r\n\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "3b5d65e6-84b8-d3b1-6d05-4172d2d15c48"
              },
              {
                "name": "Import Devices",
                "icon": "mdi:file-upload-outline",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"addEntityFormGroup\" (ngSubmit)=\"import()\" style=\"width:640px\">\r\n    <mat-toolbar color=\"primary\">\r\n        <h2>Register devices</h2>\r\n        <span fxFlex></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n            <mat-icon class=\"material-icons\">close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n    <div mat-dialog-content fxLayout=\"column\" style=\"position:relative\">\r\n        <div fxLayout=\"row\" fxLayoutAlign=\"start center\">\r\n            <div fxLayout=\"column\" fxLayoutAlign=\"center\" style=\"margin-right: 10px;\">\r\n                <button id=\"lorawan-dashboard\" type=\"button\" mat-button color=\"primary\"\r\n                        (click)=\"switchCard('lorawan')\" [class.selected]=\"selectedCard === 'lorawan'\">\r\n                    <mat-icon class=\"tb-mat-18\">wifi</mat-icon>\r\n                    <span>LoRaWAN</span>\r\n                </button>\r\n            </div>\r\n            <div fxLayout=\"column\" fxLayoutAlign=\"center\">\r\n                <button id=\"muc-settings\" type=\"button\" mat-button color=\"primary\"\r\n                        (click)=\"switchCard('muc')\" [class.selected]=\"selectedCard === 'muc'\">\r\n                    <mat-icon class=\"tb-mat-18\">cable</mat-icon>\r\n                    <span>MUC</span>\r\n                </button>\r\n            </div>\r\n        </div>\r\n        <fieldset [disabled]=\"isLoading$ | async\" tb-toast toastTarget=\"importSensorsTarget\">\r\n            <tb-file-input formControlName=\"importData\"\r\n                           required\r\n                           label=\"Devices file\"\r\n                           [allowedExtensions]=\"'csv,txt'\"\r\n                           [accept]=\"'.csv,application/csv,text/csv,.txt,text/plain'\"\r\n                           dropLabel=\"{{'import.drop-file-csv-or' | translate}}\">\r\n            </tb-file-input>\r\n            <mat-form-field class=\"mat-block\" style=\"margin-top:12px\">\r\n                <mat-label translate>import.csv-delimiter</mat-label>\r\n                <mat-select required formControlName=\"delim\">\r\n                    <mat-option *ngFor=\"let delimiter of delimiters\" [value]=\"delimiter.key\">\r\n                        {{ delimiter.value }}\r\n                    </mat-option>\r\n                </mat-select>\r\n            </mat-form-field>\r\n        </fieldset>\r\n        <div class=\"import-info-section\">\r\n            <div class=\"import-info-header\">CSV file must contain columns:</div>\r\n            <div class=\"import-info-text\" *ngIf=\"selectedCard === 'lorawan'\">\r\n                <div>1. Name</div>\r\n                <div>2. Type</div>\r\n                <div>3. Label</div>\r\n                <div>4. location</div>\r\n                <div>5. displayName</div>\r\n                <div>6. meterType</div>\r\n                <div>7. customer</div>\r\n                <div>8. forwardTo</div>\r\n                <div>9. devEui</div>\r\n                <div>10. appKey</div>\r\n                <div>11. isDisabled</div>\r\n                <div>12. meterId</div>\r\n            </div>\r\n            <div class=\"import-info-text\" *ngIf=\"selectedCard === 'muc'\">\r\n                <div>1. Name</div>\r\n                <div>2. Type</div>\r\n                <div>3. Label</div>\r\n                <div>4. location</div>\r\n                <div>5. displayName</div>\r\n                <div>6. meterType</div>\r\n                <div>7. customer</div>\r\n                <div>8. forwardTo</div>\r\n                <div>9. meterId</div>\r\n            </div>\r\n            <div class=\"import-info-header\" style=\"margin-top:12px;margin-bottom:6px\">Example:</div>\r\n            <div [innerHTML]=\"exampleContent\" class=\"example-content\"></div>\r\n        </div>\r\n    </div>\r\n    <div mat-dialog-actions fxLayoutAlign=\"end center\">\r\n        <button mat-button color=\"primary\"\r\n                type=\"button\"\r\n                [disabled]=\"(isLoading$ | async)\"\r\n                (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n        </button>\r\n        <button mat-button mat-raised-button color=\"primary\"\r\n                type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || addEntityFormGroup.invalid || !addEntityFormGroup.dirty\">\r\n            Import\r\n        </button>\r\n    </div>\r\n</form>\r\n",
                "customCss": ".import-info-section {\r\n    display: flex;\r\n    flex-direction: column;\r\n    padding: 12px 16px;\r\n    background-color: rgba(0, 0, 0, 0.04);\r\n    border-radius: 4px;\r\n}\r\n\r\n.import-info-header,\r\n.import-info-text {\r\n    font-size: 14px;\r\n    line-height: 20px;\r\n    letter-spacing: 0.2px;\r\n    color: rgba(0, 0, 0, 0.54);\r\n}\r\n\r\n.import-info-header {\r\n    font-weight: 700;\r\n}\r\n\r\n.delim-value {\r\n    color: rgba(0, 0, 0, 0.87);\r\n    font-weight: 700;\r\n}\r\n\r\n.example-content {\r\n    padding: 12px;\r\n    border: 1px solid rgba(0, 0, 0, 0.12);\r\n    border-radius: 6px;\r\n    background-color: rgba(255, 255, 255, 0.08);\r\n}\r\n\r\n.example-content .import-info-text {\r\n    font-size: 10px;\r\n    color: rgba(0, 0, 0, 0.38);\r\n}\r\n\r\n\r\nbutton.selected {\r\n    background-color: var(--tb-primary-500) !important;\r\n    color: var(--tb-primary-contrast-500) !important;\r\n}\r\n\r\nbutton.selected mat-icon.tb-mat-18 {\r\n    color: var(--tb-primary-contrast-500) !important;\r\n}\r\n\r\nbutton mat-icon.tb-mat-18 {\r\n    font-size: 18px;\r\n    margin-right: 4px;\r\n}\r\n",
                "customFunction": "const $injector = widgetContext.$scope.$injector;\r\nconst customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nconst entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nconst importExportService = $injector.get(widgetContext.servicesMap.get('importExport'));\r\nconst rxjs = widgetContext.rxjs;\r\n\r\nopenAddEntityDialog();\r\n\r\nfunction openAddEntityDialog() {\r\n    customDialog.customDialog(htmlTemplate, AddEntityDialogController).subscribe();\r\n}\r\n\r\nfunction AddEntityDialogController(instance) {\r\n    const vm = instance;\r\n    vm.selectedCard = 'lorawan'; // Default selection\r\n\r\n    vm.delimiters = [{\r\n        key: ',',\r\n        value: ','\r\n    }, {\r\n        key: ';',\r\n        value: ';'\r\n    }, {\r\n        key: '|',\r\n        value: '|'\r\n    }];\r\n\r\n    vm.lorawanExampleData = [\r\n        ['pke_AT1100_cs6_EG_ELZ', 'Eastron SDM230', 'PKE', 'pke_AT1100_cs6', 'ELZ Gesamt', 'E', 'PKE', 'Energy Expert', '94193A010C003795', 'D20E3D28BE5823B73D9222348BD258CA', 'False', '41157775']\r\n    ];\r\n\r\n    vm.lorawanColumns = [\r\n        { type: 'NAME' },\r\n        { type: 'TYPE' },\r\n        { type: 'LABEL' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'location' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'displayName' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'meterType' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'customer' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'forwardTo' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'devEui' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'appKey' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'isDisabled' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'meterId' }\r\n    ];\r\n\r\n    vm.mucExampleData = [\r\n        ['pke_AT1100_cs6_test1_muc', 'MUC ELZ', 'PKE', 'pke_AT1100_cs6', 'MUC Test1', 'E', 'PKE Oesterreich', 'Energy Expert', '41159550']\r\n    ];\r\n\r\n    vm.mucColumns = [\r\n        { type: 'NAME' },\r\n        { type: 'TYPE' },\r\n        { type: 'LABEL' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'location' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'displayName' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'meterType' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'customer' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'forwardTo' },\r\n        { type: 'SERVER_ATTRIBUTE', key: 'meterId' }\r\n    ];\r\n\r\n    vm.addEntityFormGroup = vm.fb.group({\r\n        importData: [null, [vm.validators.required]],\r\n        delim: [';', [vm.validators.required]]\r\n    });\r\n\r\n    vm.exampleContent = buildExampleContent(vm.addEntityFormGroup.get('delim').value);\r\n\r\n    vm.addEntityFormGroup.get('delim').valueChanges.subscribe(value => {\r\n        vm.exampleContent = buildExampleContent(value);\r\n    });\r\n\r\n    vm.switchCard = (card) => {\r\n        vm.selectedCard = card;\r\n        reloadCardData(card);\r\n        vm.exampleContent = buildExampleContent(vm.addEntityFormGroup.get('delim').value);\r\n    };\r\n\r\n    vm.import = () => {\r\n        const origFile = vm.addEntityFormGroup.get('importData').value;\r\n        const delim = vm.addEntityFormGroup.get('delim').value;\r\n        const parseData = parseCSV(origFile);\r\n\r\n        if (parseData === -1) {\r\n            vm.addEntityFormGroup.get('importData').setValue(null);\r\n            widgetContext.showErrorToast(\"Failed to parse CSV data.\", 'top', 'left', 'importError');\r\n            return;\r\n        }\r\n\r\n        const groupName = vm.selectedCard === 'lorawan' ? 'LoRaWAN Devices' : 'MUC Devices';\r\n        getEntityGroupByName(groupName, 'DEVICE').subscribe(group => {\r\n            if (group) {\r\n                const columns = vm.selectedCard === 'lorawan' ? vm.lorawanColumns : vm.mucColumns;\r\n\r\n                const entitiesData = {\r\n                    file: origFile,\r\n                    entityGroupId: group.id.id,\r\n                    mapping: {\r\n                        columns: columns,\r\n                        delimiter: delim,\r\n                        header: true,\r\n                        update: true\r\n                    }\r\n                };\r\n                importExportService.bulkImportEntities(entitiesData, 'DEVICE', {ignoreErrors: true}).subscribe(result => {\r\n                    if (result.created > 0) {\r\n                        setTimeout(() => {\r\n                            widgetContext.updateAliases();\r\n                            widgetContext.showSuccessToast(result.created + (result.created === 1 ? ' device was' : ' devices were') + ' successfully added!', 2000, 'top', 'left');\r\n                        }, 1000);\r\n                        vm.dialogRef.close(null);\r\n                    } else {\r\n                        widgetContext.showErrorToast(\"No devices were added. Please check the CSV file.\", 'top', 'left', 'importError');\r\n                    }\r\n                }, error => {\r\n                    widgetContext.showErrorToast('Failed to import devices. ' + error.message, 'top', 'left', 'importError');\r\n                });\r\n            } else {\r\n                widgetContext.showErrorToast(\"Target sensors-group doesn't exist!\", 'top', 'left', 'importSensorsTarget');\r\n            }\r\n        }, error => {\r\n            widgetContext.showErrorToast('Error fetching entity group: ' + error.message, 'top', 'left', 'entityGroupError');\r\n        });\r\n    };\r\n\r\n    vm.cancel = function() {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    function getEntityGroupByName(groupName, groupType) {\r\n        const entityGroupsPageLink = widgetContext.pageLink(10, 0, groupName);\r\n        return entityGroupService.getEntityGroupsByPageLink(entityGroupsPageLink, groupType).pipe(\r\n            rxjs.map((data) => {\r\n                if (data.data.length) {\r\n                    return data.data.find((group) => group.name === groupName);\r\n                } else {\r\n                    return null;\r\n                }\r\n            })\r\n        );\r\n    }\r\n\r\n    function buildExampleContent(delim) {\r\n        let content = '';\r\n        const exampleData = vm.selectedCard === 'lorawan' ? vm.lorawanExampleData : vm.mucExampleData;\r\n        exampleData.forEach(dataArray => {\r\n            let result = '<div class=\"import-info-text\">';\r\n            dataArray.forEach((value, index) => {\r\n                result += value;\r\n                if (index !== dataArray.length - 1) {\r\n                    result += ('<span class=\"delim-value\">' + delim + '</span>');\r\n                }\r\n            });\r\n            result += '</div>';\r\n            content += result;\r\n        });\r\n        return content;\r\n    }\r\n\r\n    function parseCSV(importData) {\r\n        const config = {\r\n            delim: vm.addEntityFormGroup.get('delim').value,\r\n            header: true // Set header to true to skip the first row\r\n        };\r\n        return convertCSVToJson(importData, config, (messageId, params) => {\r\n            widgetContext.showErrorToast(widgetContext.translate.instant(messageId, params), 'top', 'left', 'importSensorsTarget');\r\n        });\r\n    }\r\n\r\n    function convertCSVToJson(csvdata, config, onError) {\r\n        config = config || {};\r\n        const delim = config.delim || ',';\r\n        const header = config.header || false;\r\n        const result = {};\r\n        const csvlines = csvdata.split(/[\\r\\n]+/);\r\n        const csvheaders = splitCSV(csvlines[0], delim);\r\n        if (csvheaders.length < 2) {\r\n            onError('import.import-csv-number-columns-error');\r\n            return -1;\r\n        }\r\n        const csvrows = csvlines.slice(1); // Skip the first row\r\n        result.headers = csvheaders;\r\n        result.rows = [];\r\n        for (const row of csvrows) {\r\n            if (row.length === 0) {\r\n                break;\r\n            }\r\n            const rowitems = splitCSV(row, delim);\r\n            if (rowitems.length !== result.headers.length) {\r\n                onError('import.import-csv-invalid-format-error', {line: result.rows.length + 2});\r\n                return -1;\r\n            }\r\n            for (let i = 0; i < rowitems.length; i++) {\r\n                rowitems[i] = convertStringToJSType(rowitems[i]);\r\n            }\r\n            result.rows.push(rowitems);\r\n        }\r\n        return result;\r\n    }\r\n\r\n    function splitCSV(str, sep) {\r\n        let foo, x, tl;\r\n        for (foo = str.split(sep = sep || ','), x = foo.length - 1, tl; x >= 0; x--) {\r\n            if (foo[x].replace(/\"\\s+$/, '\"').charAt(foo[x].length - 1) === '\"') {\r\n                if ((tl = foo[x].replace(/^\\s+\"/, '\"')).length > 1 && tl.charAt(0) === '\"') {\r\n                    foo[x] = foo[x].replace(/^\\s*\"|\"\\s*$/g, '').replace(/\"\"/g, '\"');\r\n                } else if (x) {\r\n                    foo.splice(x - 1, 2, [foo[x - 1], foo[x]].join(sep));\r\n                } else {\r\n                    foo = foo.shift().split(sep).concat(foo);\r\n                }\r\n            } else {\r\n                foo[x].replace(/\"\"/g, '\"');\r\n            }\r\n        }\r\n        return foo;\r\n    }\r\n\r\n    function convertStringToJSType(str) {\r\n        if (isNumeric(str.replace(',', '.'))) {\r\n            return parseFloat(str.replace(',', '.'));\r\n        }\r\n        if (str.search(/^(true|false)$/im) === 0) {\r\n            return str.toLowerCase() === 'true';\r\n        }\r\n        if (str === '') {\r\n            return null;\r\n        }\r\n        return str;\r\n    }\r\n\r\n    function isNumeric(str) {\r\n        str = str.replace(',', '.');\r\n        return (str - parseFloat(str) + 1) >= 0 && Number(str).toString() === str;\r\n    }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1c7c2297-0f78-e396-fa35-5f362bae07f7"
              }
            ],
            "actionCellButton": [
              {
                "name": "{i18n:custom.devices.edit-device}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editDeviceFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 350px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.devices.edit-device' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n        <mat-label>{{ 'custom.devices.device-name' | translate }}</mat-label>\r\n        <input matInput formControlName=\"name\" required readonly>\r\n        <mat-error *ngIf=\"editDeviceFormGroup.get('name').hasError('required')\">\r\n          {{ 'custom.devices.device-name-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n     <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n        <mat-label>{{ 'custom.devices.device-type' | translate }}</mat-label>\r\n        <input matInput formControlName=\"type\" required readonly>\r\n        <mat-error *ngIf=\"editDeviceFormGroup.get('type').hasError('required')\">\r\n          {{ 'custom.devices.device-type-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n        <mat-label>{{ 'custom.devices.device-label' | translate }}</mat-label>\r\n        <input matInput formControlName=\"label\">\r\n      </mat-form-field>\r\n\r\n      <ng-container *ngIf=\"showExtraFields\">\r\n        <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n        <mat-label>devEUI</mat-label>\r\n        <input matInput formControlName=\"devEui\" required pattern=\"[a-zA-Z0-9]{16}\">\r\n        <mat-error *ngIf=\"editDeviceFormGroup.get('devEui').hasError('required')\">\r\n          {{ 'custom.devices.deveui-is-required' | translate }}\r\n        </mat-error>\r\n        <mat-error *ngIf=\"editDeviceFormGroup.get('devEui').hasError('pattern')\">\r\n          {{ 'custom.devices.deveui-must-be-16-alphanummeric-characters' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n        <mat-label>appKey</mat-label>\r\n        <input matInput formControlName=\"appKey\" required pattern=\"[a-zA-Z0-9]{32}\">\r\n        <mat-error *ngIf=\"editDeviceFormGroup.get('appKey').hasError('required')\">\r\n          {{ 'custom.devices.appkey-is-required' | translate }}\r\n        </mat-error>\r\n        <mat-error *ngIf=\"editDeviceFormGroup.get('appKey').hasError('pattern')\">\r\n          {{ 'custom.devices.appkey-must-be-32-alphanummeric-characters' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n      </ng-container>\r\n  </div>\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button mat-button color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\" cdkFocusInitial>\r\n      {{ 'custom.devices.cancel' | translate }}\r\n    </button>\r\n    <button mat-button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(isLoading$ | async) || editDeviceFormGroup.invalid || !editDeviceFormGroup.dirty\">\r\n      {{ 'custom.devices.save-device' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*.mat-form-field input[disabled] {\n  background-color: #f5f5f5;\n  cursor: not-allowed; \n  color: #9e9e9e;\n  \n}*/",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\n\r\nopenEditDeviceDialog();\r\n\r\nfunction openEditDeviceDialog() {\r\n  customDialog.customDialog(htmlTemplate, EditDeviceDialogController).subscribe();\r\n}\r\n\r\nfunction EditDeviceDialogController(instance) {\r\n  let vm = instance;\r\n  \r\n  vm.device = {};\r\n\r\n  vm.editDeviceFormGroup = vm.fb.group({\r\n    name: ['', [vm.validators.required]],\r\n    type: ['', [vm.validators.required]],\r\n    label: [''],\r\n    devEui: ['', [vm.validators.pattern('[a-zA-Z0-9]{16}')]],\r\n    appKey: ['']\r\n  });\r\n\r\n  getDevice();\r\n\r\n  vm.cancel = function() {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  vm.save = function() {\r\n      vm.editDeviceFormGroup.markAsPristine();\r\n      saveDevice().subscribe(function() {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n      });\r\n    };\r\n\r\n\r\n  function getDevice() {\r\n    deviceService.getDevice(entityId.id).subscribe(function (device) {\r\n      vm.device = device;\r\n      vm.editDeviceFormGroup.patchValue({\r\n        name: vm.device.name,\r\n        type: vm.device.type,\r\n        label: vm.device.label\r\n      }, { emitEvent: false });\r\n\r\n      vm.showExtraFields = (vm.device.type === 'Room Sensor CO2');\r\n\r\n      if (vm.showExtraFields) {\r\n        loadDeviceAttributes(vm.device.id);\r\n      } else {\r\n        vm.editDeviceFormGroup.get('devEui').clearValidators();\r\n        vm.editDeviceFormGroup.get('appKey').clearValidators();\r\n        vm.editDeviceFormGroup.get('devEui').updateValueAndValidity();\r\n        vm.editDeviceFormGroup.get('appKey').updateValueAndValidity();\r\n      }\r\n    });\r\n  }\r\n\r\n  function loadDeviceAttributes(deviceId) {\r\n    attributeService.getEntityAttributes(deviceId, \"SERVER_SCOPE\", [\"devEui\", \"appKey\"]).subscribe(attributes => {\r\n      const devEuiAttr = attributes.find(item => item.key === \"devEui\");\r\n      const devEui = devEuiAttr ? devEuiAttr.value : \"\";\r\n      const appKeyAttr = attributes.find(item => item.key === \"appKey\");\r\n      const appKey = appKeyAttr ? appKeyAttr.value : \"\";\r\n      \r\n      const devEUIControl = vm.editDeviceFormGroup.get('devEui');\r\n      if (devEUIControl) {\r\n        devEUIControl.setValue(devEui);\r\n      } else {\r\n        console.error(\"Form control 'devEui' not found\");\r\n      }\r\n        \r\n      const appKeyControl = vm.editDeviceFormGroup.get('appKey');\r\n      if (appKeyControl) {\r\n        appKeyControl.setValue(appKey);\r\n      } else {\r\n        console.error(\"Form control 'appKey' not found\");\r\n      }\r\n    });\r\n  }\r\n\r\n  function saveDevice() {\r\n      const formValues = vm.editDeviceFormGroup.value;\r\n      vm.device.name = formValues.name;\r\n      vm.device.label = formValues.label;\r\n\r\n      let saveCalls = [ deviceService.saveDevice(vm.device) ];\r\n    \r\n      if (vm.showExtraFields) {\r\n        const attributesArray = [\r\n          { key: 'devEui', value: formValues.devEui },\r\n          { key: 'appKey', value: formValues.appKey }\r\n        ];\r\n        \r\n        saveCalls.push(attributeService.saveEntityAttributes(vm.device.id, 'SERVER_SCOPE', attributesArray));\r\n      } else {\r\n\r\n        saveCalls.push(widgetContext.rxjs.of([]));\r\n      }\r\n    \r\n      return widgetContext.rxjs.forkJoin(saveCalls);\r\n    }\r\n\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7e870fd2-9559-9a6e-d847-beefc971ecaa"
              },
              {
                "name": "{i18n:device.delete}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteDeviceDialog();\n\nfunction openDeleteDeviceDialog() {\n  let titleTranslation = translationService.instant(\n    'custom.devices.delete.title',\n    { entityName: entityName }\n  );\n\n  let contentTranslation = translationService.instant(\n    'custom.devices.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteDevice();\n    }\n  });\n}\nfunction deleteDevice() {\n  deviceService.deleteDevice(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "70f87b5b-3dbc-91e6-0e59-80511b0be772"
              }
            ]
          },
          "titleIcon": "devices_other",
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "28px",
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "eac6e38e-62f2-1f91-754b-299d11e87c19",
        "typeFullFqn": "system.cards.entities_table"
      },
      "0c48ee70-d617-faa5-2418-d9766c6ff378": {
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "11f99ccd-3fff-0e24-7f43-355d961fffcb",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Name",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.8768256363159095
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.7481769686268884
                },
                {
                  "name": "xPos",
                  "type": "attribute",
                  "label": "xPos",
                  "color": "#607d8b",
                  "settings": {},
                  "_hash": 0.1947251343876919
                },
                {
                  "name": "yPos",
                  "type": "attribute",
                  "label": "yPos",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.8911555639185675
                },
                {
                  "name": "type",
                  "type": "entityField",
                  "label": "Type",
                  "color": "#8bc34a",
                  "settings": {},
                  "_hash": 0.8300505638957978
                },
                {
                  "name": "floorplan",
                  "type": "attribute",
                  "label": "floorplan",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.4327832227267234
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": true,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "provider": "image-map",
            "gmApiKey": "AIzaSyDoEx2kaGz3PxwbI9T7ccTSg5xjdw8Nw8Q",
            "gmDefaultMapType": "roadmap",
            "mapProvider": "OpenStreetMap.Mapnik",
            "useCustomProvider": false,
            "customProviderTileUrl": "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            "mapProviderHere": "HERE.normalDay",
            "credentials": {
              "useV3": true,
              "app_id": "AhM6TzD9ThyK78CT3ptx",
              "app_code": "p6NPiITB3Vv0GMUFnkLOOg",
              "apiKey": "kVXykxAfZ6LS4EbCTO02soFVfjA7HoBzNVVH9u7nzoE"
            },
            "mapImageUrl": "tb-image;/api/images/system/here_map_system_widget_map_image.svg",
            "imageEntityAlias": "Selected Measurement",
            "imageUrlAttribute": "floorplan",
            "tmApiKey": "84d6d83e0e51e481e50454ccbe8986b",
            "tmDefaultMapType": "roadmap",
            "latKeyName": "latitude",
            "lngKeyName": "longitude",
            "xPosKeyName": "xPos",
            "yPosKeyName": "yPos",
            "defaultZoomLevel": null,
            "defaultCenterPosition": "0,0",
            "disableScrollZooming": false,
            "disableDoubleClickZooming": false,
            "disableZoomControl": false,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "mapPageSize": 16384,
            "markerOffsetX": 0.5,
            "markerOffsetY": 0.5,
            "posFunction": "return {x: origXPos, y: origYPos};",
            "draggableMarker": true,
            "showLabel": true,
            "useLabelFunction": false,
            "label": "<div style=\"position: relative; white-space: nowrap; text-align: center; font-size: 12px; top: -5px;\"><span style=\"margin-left: -500%;\"></span><span style=\"border-radius: 10px; color: #fff; background-color: #666; padding-left: 5px; padding-right: 5px; padding-top: 3px; padding-bottom: 3px;\">${entityLabel}</span><span style=\"margin-right: -500%;\"></span></div>",
            "labelFunction": null,
            "showTooltip": true,
            "showTooltipAction": "click",
            "autocloseTooltip": true,
            "useTooltipFunction": false,
            "tooltipPattern": "<b>${entityLabel}</b><br/><span>${entityName}</span><br/><br/><link-act name='update-label'>Update label</link-act><br/><br/><link-act name='remove-device'>Remove device</link-act>",
            "tooltipFunction": null,
            "tooltipOffsetX": 0,
            "tooltipOffsetY": -0.5,
            "color": "#FE7569",
            "useColorFunction": false,
            "colorFunction": null,
            "useMarkerImageFunction": true,
            "markerImage": null,
            "markerImageSize": 34,
            "markerImageFunction": "var selectedMeasurement = data['selectedMeasurement'] === true;\nvar selectedMode = dsData.filter(function (data) { return data['selectedMeasurement'] === true; }).length > 0;\n\nvar width = 30;\nvar svgStr = getMeasurementSvg(width, selectedMeasurement);\nvar encodedSvg = encodeURIComponent(svgStr);\nvar svgUrl = 'data:image/svg+xml,' + encodedSvg;\n\nif (selectedMeasurement) {\n    width += 8;\n}\n\nreturn {\n    url: svgUrl,\n    size: width,\n    markerOffset: [width / 2, width / 2],\n    tooltipOffset: [width * 0.5 - width / 2, - (width / 2)]\n};\n\nfunction getMeasurementSvg(width, isSelected) {\n    var shape = '<path d=\"M3.75 15.75L4.5 16.5L19.5 16.5L20.25 15.75V8.25L19.5 7.5H4.5L3.75 8.25V15.75ZM18.75 15L5.25 15L5.25 9H6.375L6.375 11.625H7.875L7.875 9L9.375 9V12.375H10.875L10.875 9L12.375 9V11.625H13.875V9L15.375 9V11.625H16.875V9L18.75 9V15Z\" fill=\"white\" stroke-width=\".7997\"/>';\n    var color = '#1F8B4D';\n    var background = getBackground(color);\n    var svgWidth = isSelected ? (width + 8) : width;\n    var svgHeight = isSelected ? 38 : 30;\n    \n    var opacity = selectedMode && !isSelected ? 0.4 : 1;\n    \n    var MeasurementSvg = '<svg opacity=\"' + opacity + '\" width=\"' + svgWidth + '\" height=\"' + svgHeight + '\" viewBox=\"0 0' + svgWidth + ' ' + svgHeight + '\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                    wrapIfSelected(background + shape, isSelected);\n    if (isSelected) {\n        MeasurementSvg += getMeasurementSelectionStroke();\n    }\n    MeasurementSvg += '</svg>';\n    return MeasurementSvg;    \n}\n\nfunction wrapIfSelected(svg, isSelected) {\n    if (isSelected) {\n        return '<g transform=\"translate(7 7)\">' + svg + '</g>';\n    } else {\n        return '<g transform=\"translate(3 3)\">' + svg + '</g>';\n    }\n}\n\nfunction getBackground(color) {\n     return '<circle cx=\"12\" cy=\"12\" r=\"15\" fill=\"'+ color +'\"/>';\n}\n\nfunction getMeasurementSelectionStroke() {\n     return '<circle cx=\"19\" cy=\"19\" r=\"18\" stroke=\"#D5C21B\" stroke-width=\"2\"/>';\n}",
            "markerImages": [],
            "showPolygon": false,
            "polygonKeyName": "coordinates",
            "editablePolygon": true,
            "showPolygonLabel": false,
            "usePolygonLabelFunction": false,
            "polygonLabel": "${entityName}",
            "polygonLabelFunction": null,
            "showPolygonTooltip": false,
            "showPolygonTooltipAction": "click",
            "autoClosePolygonTooltip": true,
            "usePolygonTooltipFunction": false,
            "polygonTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "polygonTooltipFunction": null,
            "polygonColor": "#3c897f",
            "polygonOpacity": 0.3,
            "usePolygonColorFunction": true,
            "polygonColorFunction": "var deviceType = data['Type'];\r\nvar status = 'normal';\r\nreturn getColor(status);\r\n\r\nfunction getColor(status) {\r\n    switch(status) {\r\n        case 'major':\r\n            return '#D5C21B';\r\n        case 'critical':   \r\n            return '#E64A19';\r\n        case 'off':\r\n        case 'disconnected':\r\n            return '#CAC1D2';\r\n        case 'normal':\r\n        default:    \r\n            return '#817889';\r\n    }\r\n}",
            "polygonStrokeColor": "#817889",
            "polygonStrokeOpacity": 1,
            "polygonStrokeWeight": 1,
            "usePolygonStrokeColorFunction": false,
            "polygonStrokeColorFunction": null,
            "showCircle": false,
            "circleKeyName": "perimeter",
            "editableCircle": false,
            "showCircleLabel": false,
            "useCircleLabelFunction": false,
            "circleLabel": "${entityName}",
            "circleLabelFunction": null,
            "showCircleTooltip": false,
            "showCircleTooltipAction": "click",
            "autoCloseCircleTooltip": true,
            "useCircleTooltipFunction": false,
            "circleTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "circleTooltipFunction": null,
            "circleFillColor": "#3388ff",
            "circleFillColorOpacity": 0.2,
            "useCircleFillColorFunction": false,
            "circleFillColorFunction": null,
            "circleStrokeColor": "#3388ff",
            "circleStrokeOpacity": 1,
            "circleStrokeWeight": 3,
            "useCircleStrokeColorFunction": false,
            "circleStrokeColorFunction": null,
            "snappable": false,
            "initDragMode": true,
            "hideAllControlButton": true,
            "hideDrawControlButton": false,
            "hideEditControlButton": false,
            "hideRemoveControlButton": false
          },
          "title": "{i18n:custom.projects.measurements.floor-plan.edit.edit-floor-plan}",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "widgetStyle": {},
          "actions": {
            "markerClick": [],
            "tooltipAction": [
              {
                "name": "remove-device",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\n/*openRemoveDeviceDialog();*/\n\nfunction openRemoveDeviceDialog() {\n  var title = 'Are you sure you want to remove the device ' + entityName + '?';\n  var content = 'After the confirmation, the device will be unassigned from the current Doktorkit!';\n  dialogs.confirm(title, content, 'Cancel', 'Remove from Doktorkit').subscribe(\n    function(result) {\n      if (result) {\n        doRemoveDevice();\n      }\n    }\n  );\n}\n\nfunction doRemoveDevice() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var DoktorkitId = widgetContext.stateController.getStateParams().selectedDoktorkit.entityId;\n  removeDevice(entityId, DoktorkitId, customerId).subscribe(() => {\n      widgetContext.updateAliases();\n  });\n}\n\nfunction removeDevice(deviceId, DoktorkitId, customerId) {\n    return getUnassignedDevicesGroup(customerId).pipe(\n        widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n            return widgetContext.rxjs.forkJoin([\n                entityGroupService.addEntityToEntityGroup(unassignedDevicesGroup.id.id, deviceId.id),\n                deleteDoktorkitToDeviceRelation(DoktorkitId, deviceId),\n                removePositionAttributes(deviceId)\n            ]);\n        })\n    );\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Doktorkit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Doktorkit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDoktorkitToDeviceRelation(DoktorkitId, deviceId) {\n    return entityRelationService.deleteRelation(DoktorkitId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(deviceId) {\n    return attributeService.deleteEntityAttributes(deviceId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7035bc33-31d7-515b-3428-b7e43d840422"
              },
              {
                "name": "update-label",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #editEntityForm=\"ngForm\" [formGroup]=\"editEntityFormGroup\" (ngSubmit)=\"save()\" class=\"edit-entity-form\">\r\n    <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n        <h2>Edit {{entityType.toLowerCase()}} {{entityName}}</h2>\r\n        <span fxFlex></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n            <mat-icon class=\"material-icons\">close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n    <div mat-dialog-content fxLayout=\"column\">\r\n        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\" fxLayoutGap.xs=\"0\">\r\n            <mat-form-field fxFlex class=\"mat-block\">\r\n                <mat-label>{{'custom.projects.measurements.floor-plan.edit.entity-name' | translate}}</mat-label>\r\n                <input matInput formControlName=\"entityName\" required readonly=\"\">\r\n            </mat-form-field>\r\n            <mat-form-field fxFlex class=\"mat-block\">\r\n                <mat-label>{{'custom.projects.measurements.floor-plan.edit.entity-label' | translate}}</mat-label>\r\n                <input matInput formControlName=\"entityLabel\">\r\n            </mat-form-field>\r\n        </div>\r\n        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\" fxLayoutGap.xs=\"0\">\r\n            <mat-form-field fxFlex class=\"mat-block\">\r\n                <mat-label>{{'custom.projects.measurements.floor-plan.edit.entity-type' | translate}}</mat-label>\r\n                <input matInput formControlName=\"entityType\" readonly>\r\n            </mat-form-field>\r\n            <mat-form-field fxFlex class=\"mat-block\">\r\n                <mat-label>{{'custom.projects.measurements.floor-plan.edit.type' | translate}}</mat-label>\r\n                <input matInput formControlName=\"type\" readonly>\r\n            </mat-form-field>\r\n        </div>\r\n        <div formGroupName=\"attributes\" fxLayout=\"column\">\r\n            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\" fxLayoutGap.xs=\"0\">\r\n                <mat-form-field fxFlex class=\"mat-block\">\r\n                    <mat-label>{{'custom.projects.measurements.floor-plan.edit.location-name' | translate}}</mat-label>\r\n                    <input type=\"string\" step=\"any\" matInput formControlName=\"locationName\">\r\n                </mat-form-field>\r\n                <mat-form-field fxFlex class=\"mat-block\">\r\n                    <mat-label>{{'custom.projects.measurements.floor-plan.edit.installation-type' | translate}}</mat-label>\r\n                    <input type=\"string\" step=\"any\" matInput formControlName=\"installationType\" readonly>\r\n                </mat-form-field>\r\n                <mat-form-field fxFlex class=\"mat-block\">\r\n                    <mat-label>{{'custom.projects.measurements.floor-plan.edit.installation-type-specific' | translate}}</mat-label>\r\n                    <input type=\"string\" step=\"any\" matInput formControlName=\"installationTypeOptions\" readonly>\r\n                </mat-form-field>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n        <button mat-button color=\"primary\" type=\"button\" [disabled]=\"(isLoading$ | async)\" (click)=\"cancel()\" cdkFocusInitial>\r\n            {{'action.cancel' | translate}}\r\n        </button>\r\n        <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"(isLoading$ | async) || editEntityForm.invalid || !editEntityForm.dirty\">\r\n            {{'action.save' | translate}}\r\n        </button>\r\n    </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n\nlet $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet instance = widgetContext.stateController.getStateParams();\n\nopenEditEntityDialog();\n\nfunction openEditEntityDialog() {\n    customDialog.customDialog(htmlTemplate, EditEntityDialogController).subscribe();\n}\n\nfunction EditEntityDialogController(instance) {\n    let vm = instance;\n\n    vm.entityName = entityName;\n    vm.entityType = entityId.entityType;\n    vm.attributes = {};\n    vm.entity = {};\n\n    vm.editEntityFormGroup = vm.fb.group({\n        entityName: ['', [vm.validators.required]],\n        entityType: [null],\n        entityLabel: [null],\n        type: ['', [vm.validators.required]],\n        attributes: vm.fb.group({\n            locationName: [null],\n            installationType: [null],\n            installationTypeOptions: [null]\n        })\n    });\n\n    getEntityInfo();\n\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n\n    vm.save = function() {\n        vm.editEntityFormGroup.markAsPristine();\n        widgetContext.rxjs.forkJoin([\n            saveAttributes(entityId),\n            saveEntity()\n        ]).subscribe(\n            function () {\n                widgetContext.updateAliases();\n                vm.dialogRef.close(null);\n            }\n        );\n    };\n\n    function getEntityAttributes(attributes) {\n        for (var i = 0; i < attributes.length; i++) {\n            vm.attributes[attributes[i].key] = attributes[i].value;\n        }\n    }\n\n\n    function getEntityInfo() {\n         widgetContext.rxjs.forkJoin([\n             attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE'),\n             entityService.getEntity(entityId.entityType, entityId.id)\n         ]).subscribe(\n             function (data) {\n                 getEntityAttributes(data[0]);\n                 vm.entity = data[1];\n                 vm.editEntityFormGroup.patchValue({\n                     entityName: vm.entity.name,\n                     entityType: vm.entityType,\n                     entityLabel: vm.entity.label,\n                     type: vm.entity.type,\n                     attributes: vm.attributes\n                 }, {emitEvent: false});\n             }\n         );\n     }\n\n    function saveEntity() {\n        const formValues = vm.editEntityFormGroup.value;\n        if (vm.entity.label !== formValues.entityLabel){\n            vm.entity.label = formValues.entityLabel;\n            if (formValues.entityType == 'ASSET') {\n                return assetService.saveAsset(vm.entity);\n            } else if (formValues.entityType == 'DEVICE') {\n                return deviceService.saveDevice(vm.entity);\n            }\n        }\n        return widgetContext.rxjs.of([]);\n    }\n\n    function saveAttributes(entityId) {\n        let attributes = vm.editEntityFormGroup.get('attributes').value;\n        let attributesArray = [];\n        for (let key in attributes) {\n            if (attributes[key] !== vm.attributes[key]) {\n                attributesArray.push({key: key, value: attributes[key]});\n            }\n        }\n        if (attributesArray.length > 0) {\n            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n        }\n        return widgetContext.rxjs.of([]);\n    }\n\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "329ab697-39e3-be73-f633-9f3ce6b26dcf"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:action.back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1bbf9eb3-9b2c-3a19-2cab-1200a930823b"
              },
              {
                "name": "{i18n:custom.projects.measurements.edit-floorplan}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "add_plan",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "popoverPreferredPlacement": "top",
                "popoverHideOnClickOutside": true,
                "popoverHideDashboardToolbar": true,
                "popoverWidth": "600px",
                "popoverHeight": "300px",
                "popoverStyle": {},
                "openInSeparateDialog": false,
                "openInPopover": true,
                "id": "cfa86082-4f4f-8fec-357a-4cee0b5f1335"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "noDataDisplayMessage": "",
          "widgetCss": "",
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "0c48ee70-d617-faa5-2418-d9766c6ff378",
        "typeFullFqn": "system.maps_v2.image_map"
      },
      "2f3d74ea-ed1f-a52a-03c1-9dfb2f956dd8": {
        "typeFullFqn": "system.input_widgets.update_multiple_attributes",
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Kit ID",
                  "color": "#f44336",
                  "settings": {
                    "dataKeyHidden": false,
                    "dataKeyType": "server",
                    "dataKeyValueType": "string",
                    "required": false,
                    "isEditable": "readonly",
                    "disabledOnDataKey": "",
                    "appearance": "outline",
                    "subscriptSizing": "fixed",
                    "slideToggleLabelPosition": "after",
                    "selectOptions": [],
                    "step": 1,
                    "minValue": null,
                    "maxValue": null,
                    "requiredErrorMessage": "",
                    "minValueErrorMessage": "",
                    "maxValueErrorMessage": "",
                    "invalidDateErrorMessage": "",
                    "invalidJsonErrorMessage": "",
                    "dialogTitle": "",
                    "saveButtonLabel": "",
                    "cancelButtonLabel": "",
                    "useCustomIcon": false,
                    "icon": "",
                    "customIcon": "",
                    "useGetValueFunction": false,
                    "getValueFunctionBody": "",
                    "useSetValueFunction": false,
                    "setValueFunctionBody": ""
                  },
                  "_hash": 0.7261262741197994,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "installationLocation",
                  "type": "attribute",
                  "label": "Installation Location",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.9713428384988825,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "measurementID",
                  "type": "attribute",
                  "label": "Measurement ID",
                  "color": "#607d8b",
                  "settings": {
                    "dataKeyHidden": false,
                    "dataKeyType": "server",
                    "dataKeyValueType": "string",
                    "required": false,
                    "isEditable": "readonly",
                    "disabledOnDataKey": "",
                    "appearance": "outline",
                    "subscriptSizing": "fixed",
                    "slideToggleLabelPosition": "after",
                    "selectOptions": [],
                    "step": 1,
                    "minValue": null,
                    "maxValue": null,
                    "requiredErrorMessage": "",
                    "minValueErrorMessage": "",
                    "maxValueErrorMessage": "",
                    "invalidDateErrorMessage": "",
                    "invalidJsonErrorMessage": "",
                    "dialogTitle": "",
                    "saveButtonLabel": "",
                    "cancelButtonLabel": "",
                    "useCustomIcon": false,
                    "icon": "",
                    "customIcon": "",
                    "useGetValueFunction": false,
                    "getValueFunctionBody": "",
                    "useSetValueFunction": false,
                    "setValueFunctionBody": ""
                  },
                  "_hash": 0.11964468670304629,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1707571374578,
                "endTimeMs": 1707657774578
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": null,
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "40",
          "settings": {
            "widgetTitle": "Doktorkit Attributes",
            "showResultMessage": true,
            "showActionButtons": true,
            "updateAllValues": true,
            "saveButtonLabel": "Save",
            "resetButtonLabel": "Undo",
            "showGroupTitle": false,
            "groupTitle": "${entityName}",
            "fieldsAlignment": "row",
            "fieldsInRow": 1,
            "rowGap": 5,
            "columnGap": 10
          },
          "title": "Update Multiple Attributes",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "actions": {
            "headerButton": []
          },
          "displayTimewindow": true,
          "showTitleIcon": false,
          "titleTooltip": "",
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "titleIcon": null,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px"
        },
        "row": 0,
        "col": 0,
        "id": "2f3d74ea-ed1f-a52a-03c1-9dfb2f956dd8"
      },
      "0c7469aa-7b86-be27-5216-bc6cc702f8b1": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "entitiesTitle": "Gateways",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "Label",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 15,
            "defaultSortOrder": "Label",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Devices",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "60f60877-be45-311d-9ee7-25b68c466d89",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.08471582519880028
                },
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Name",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.46096251592014714
                },
                {
                  "name": "type",
                  "type": "entityField",
                  "label": "{i18n:custom.gateways.type}",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "useCellContentFunctionOnExport": false,
                    "cellContentFunction": "var type = value;\n\nvar typeSvg = getTypeSvg(type);\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\n\nreturn '<span>'+\n           '<img style=\"vertical-align: middle;\" class=\"mat-icon\" src=\"'+ typeSvgUrl +'\">' +\n           '<span style=\"vertical-align: middle; padding-left: 8px;\">'+ type +'</span>' +\n       '</span>';\n            \nfunction getTypeSvg(type) {\n    var typeSvg;\n    switch (type) {\n        case 'Smart Shelf':\n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M2.5 2C2.22386 2 2 2.22386 2 2.5V17.5C2 17.7761 2.22386 18 2.5 18C2.77614 18 3 17.7761 3 17.5V17H17V17.5C17 17.7761 17.2239 18 17.5 ' +\n                      '18C17.7761 18 18 17.7761 18 17.5V2.5C18 2.22386 17.7761 2 17.5 2C17.2239 2 17 2.22386 17 2.5V8H14C14.5523 8 15 7.55228 15 7V4C15 3.44772 14.5523 3 14 3H11C10.4477 3 10 3.44772 10 4V7C10 ' +\n                      '7.55228 10.4477 8 11 8H7C7.55228 8 8 7.55228 8 7V6C8 5.44772 7.55228 5 7 5H6C5.44772 5 5 5.44772 5 6V7C5 7.55228 5.44772 8 6 8H3V2.5C3 2.22386 2.77614 2 2.5 2ZM17 16V9H3V16H6C5.44772 16 ' +\n                      '5 15.5523 5 15V12C5 11.4477 5.44772 11 6 11H9C9.55228 11 10 11.4477 10 12V15C10 15.5523 9.55228 16 9 16H12C11.4477 16 11 15.5523 11 15V13C11 12.4477 11.4477 12 12 12H14C14.5523 12 15 ' +\n                      '12.4477 15 13V15C15 15.5523 14.5523 16 14 16H17Z\" fill=\"#212121\"/>';\n            break;\n        case 'Freezer':            \n            typeSvg = '<rect x=\"9\" y=\"2\" width=\"2\" height=\"16\" rx=\"1\" fill=\"#212121\"/>' +\n                      '<path d=\"M12.5 3.5L10 6L7.5 3.5M12.5 16.5L10 14L7.5 16.5\" stroke=\"#212121\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>' +\n                      '<path d=\"M16.8792 8.91509L13.4641 8.00002L14.3792 4.58496M5.62082 15.4151L6.53588 12L3.12082 11.085\" stroke=\"#212121\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>' +\n                      '<path d=\"M5.62085 4.58491L6.53591 7.99998L3.12085 8.91504M16.8792 11.0849L13.4641 12L14.3792 15.415\" stroke=\"#212121\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>' +\n                      '<rect x=\"16.4282\" y=\"5.13379\" width=\"2\" height=\"16\" rx=\"1\" transform=\"rotate(60 16.4282 5.13379)\" fill=\"#212121\"/>' +\n                      '<rect x=\"2.57178\" y=\"6.86621\" width=\"2\" height=\"16\" rx=\"1\" transform=\"rotate(-60 2.57178 6.86621)\" fill=\"#212121\"/>';\n            break;\n        case 'Chiller':            \n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M13.0001 7.49994C13.0001 8.53714 12.2661 9.2516 11.4454 9.64333C11.2807 9.72191 11.1185 9.75061 10.9657 9.73874C10.9881 9.82201 ' +\n                      '11.0001 9.90957 11.0001 9.99994C11.0001 10.0304 10.9988 10.0605 10.9961 10.0902C11.1511 10.0322 11.322 9.99993 11.5001 9.99993L12.5001 9.99994L13.5 9.99993C14.3285 9.99992 15.0003 ' +\n                      '10.6975 14.6435 11.4452C14.2517 12.2658 13.5373 12.9999 12.5001 12.9999C11.4629 12.9999 10.7484 12.2658 10.3567 11.4452C10.2781 11.2805 10.2494 11.1184 10.2613 10.9655C10.178 10.988 ' +\n                      '10.0905 10.9999 10.0001 10.9999C9.96965 10.9999 9.93949 10.9986 9.90971 10.9959C9.96779 11.1509 10 11.3218 10 11.5L10 12.4999L10 13.4999C10.0001 14.3284 9.30246 15.0002 8.55482 ' +\n                      '14.6433C7.73413 14.2516 7.00006 13.5371 7.00006 12.4999C7.00006 11.4627 7.73413 10.7483 8.55482 10.3566C8.71948 10.278 8.8817 10.2493 9.03459 10.2611C9.01212 10.1779 9.00013 10.0903 ' +\n                      '9.00013 9.99994C9.00013 9.9695 9.00149 9.93938 9.00416 9.90963C8.84921 9.96766 8.67837 9.9999 8.50029 9.99989L7.50031 9.99988L6.50033 9.99989C5.67189 9.9999 5.00006 9.3023 5.35692 ' +\n                      '8.55467C5.74865 7.73397 6.46311 6.99991 7.50031 6.99991C8.5375 6.99991 9.25197 7.73397 9.6437 8.55467C9.72227 8.71929 9.75098 8.88149 9.73911 9.03435C9.82232 9.01191 9.90983 8.99994 ' +\n                      '10.0001 8.99994C10.0306 8.99994 10.0607 9.0013 10.0905 9.00397C10.0324 8.84898 10.0002 8.67807 10.0002 8.49992L10.0002 7.49994L10.0002 6.49996C10.0001 5.67153 10.6977 4.99969 11.4454 ' +\n                      '5.35655C12.2661 5.74828 13.0001 6.46274 13.0001 7.49994Z\" fill=\"#212121\"/>' +\n                      '<circle cx=\"10\" cy=\"10\" r=\"8\" stroke=\"#212121\" stroke-width=\"2\"/>';\n            break;                      \n        case 'Smart Bin':\n            typeSvg = '<path d=\"M6.71849 14C5.15241 14 4.19394 12.2816 5.01686 10.9491L5.09816 10.8175C5.17797 10.8327 5.26094 10.8383 5.34575 10.8332C5.89704 10.8001 6.31713 10.3264 6.28404 9.77509L6.21705 8.65906C6.19838 8.34795 6.03571 8.06333 5.77714 7.88933C5.51856 7.71533 5.19363 7.67184 4.8984 7.77171L3.93237 8.09851C3.40921 8.27549 3.12858 8.84306 3.30556 9.36622C3.34237 9.47504 3.39608 9.57337 3.46278 9.65927L3.31523 9.89818C1.66939 12.5631 3.58633 16 6.71849 16H7.83485C8.38714 16 8.83485 15.5523 8.83485 15C8.83485 14.4478 8.38714 14 7.83485 14L6.71849 14Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M13.3135 13.8409C14.8789 13.8873 15.8879 12.198 15.1048 10.8418L14.5467 9.87495C14.2705 9.39666 14.4344 8.78507 14.9127 8.50893C15.391 8.23279 16.0026 8.39666 16.2787 8.87495L16.8369 9.84175C18.403 12.5543 16.3849 15.9329 13.2542 15.84L12.9735 15.8317C12.9324 15.9324 12.8741 16.0281 12.7983 16.1143C12.4337 16.5292 11.8019 16.5699 11.387 16.2054L10.621 15.5322C10.3869 15.3264 10.2621 15.0233 10.2835 14.7123C10.3049 14.4014 10.47 14.1182 10.7301 13.9465L11.6632 13.3305C12.124 13.0262 12.7444 13.1531 13.0487 13.614C13.0955 13.6849 13.1321 13.7596 13.1588 13.8363L13.3135 13.8409Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M11.6696 5.21002C10.9272 3.83113 8.95968 3.80195 8.17664 5.15821L7.61846 6.12501C7.34232 6.6033 6.73073 6.76718 6.25244 6.49104C5.77414 6.21489 5.61027 5.6033 5.88641 5.12501L6.44459 4.15821C8.01067 1.44568 11.9456 1.50404 13.4306 4.26183L13.5637 4.50907C13.6715 4.49425 13.7835 4.4969 13.8961 4.51943C14.4377 4.62774 14.7889 5.15457 14.6806 5.69613L14.4806 6.69613C14.4195 7.00175 14.2193 7.26139 13.9393 7.39833C13.6594 7.53526 13.3315 7.53382 13.0528 7.39444L12.0528 6.89444C11.5588 6.64745 11.3586 6.04678 11.6056 5.5528C11.6436 5.47681 11.6899 5.40777 11.743 5.34624L11.6696 5.21002Z\" fill=\"#212121\"/>';\n            break;          \n        case 'Door Sensor':\n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M14 4H6V16H14V4ZM8 12C8.55228 12 9 11.5523 9 11C9 10.4477 8.55228 10 8 10C7.44772 10 7 10.4477 7 11C7 11.5523 7.44772 12 8 12Z\" fill=\"#212121\"/>' +\n                      '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M16 17V3C16 2.44772 15.5523 2 15 2H5C4.44772 2 4 2.44772 4 3V17H3.5C3.22386 17 3 17.2239 3 17.5C3 17.7761 3.22386 18 3.5 18H16.5C16.7761 18 17 17.7761 17 17.5C17 17.2239 16.7761 17 16.5 17H16ZM15 3H5L5 17H15V3Z\" fill=\"#212121\"/>';\n            break;\n        case 'Liquid Level Sensor':\n            typeSvg = '<path d=\"M14.6363 0.453212C14.8228 0.210257 15.1772 0.210257 15.3637 0.453213C15.9404 1.2044 17 2.73057 17 3.80373C17 5.02723 16.1143 5.99982 15 5.99982C13.8857 5.99982 13 5.02723 13 3.80373C13 2.73057 14.0596 1.2044 14.6363 0.453212Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M8.3017 2.76073C8.67788 2.33798 9.32212 2.33798 9.6983 2.76073C11.2801 4.53832 15 9.0479 15 12.1437C15 15.4064 12.3427 18 9 18C5.65725 18 3 15.4064 3 12.1437C3 9.0479 6.71994 4.53832 8.3017 2.76073Z\" fill=\"#212121\"/>';\n            break;\n        case 'Motion Sensor':\n            typeSvg = '<path d=\"M2.5 5C2.22386 5 2 5.22386 2 5.5C2 5.77614 2.22386 6 2.5 6H4C4 6.55228 4.44772 7 5 7H15C15.5523 7 16 6.55228 16 6H17.5C17.7761 6 18 5.77614 18 5.5C18 5.22386 17.7761 5 17.5 5H2.5Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M12.0001 12C12.5524 12 13.0001 11.5523 13.0001 11C13.0001 10.4477 12.5524 10 12.0001 10C11.4478 10 11.0001 10.4477 11.0001 11C11.0001 11.5523 11.4478 12 12.0001 12Z\" fill=\"#212121\"/>' +\n                      '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M10.0001 16C14.0804 16 17.4472 12.9453 17.9384 8.99801C18.0066 8.44996 17.5524 8 17.0001 8H3.00009C2.4478 8 1.99353 8.44996 2.06173 8.99801C2.55295 12.9453 5.91978 16 10.0001 16ZM12.0001 13C13.1047 13 14.0001 12.1046 14.0001 11C14.0001 9.89543 13.1047 9 12.0001 9C10.8955 9 10.0001 9.89543 10.0001 11C10.0001 12.1046 10.8955 13 12.0001 13Z\" fill=\"#212121\"/>';\n            break;\n        case 'Occupancy Sensor':\n            typeSvg = '<path d=\"M7 3.5C7 4.32843 6.32843 5 5.5 5C4.67157 5 4 4.32843 4 3.5C4 2.67157 4.67157 2 5.5 2C6.32843 2 7 2.67157 7 3.5Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M3 12C2.44772 12 2 11.5523 2 11L2 7.88652C2 6.84462 2.84462 6 3.88652 6C3.90535 6 3.92403 6.00055 3.94255 6.00162C3.96157 6.00055 3.98072 6 4 6H7C7.01928 6 7.03843 6.00055 7.05745 6.00162C7.07597 6.00055 7.09465 6 7.11348 6C8.15538 6 9 6.84462 9 7.88652V11C9 11.5523 8.55229 12 8 12V17C8 17.5523 7.55228 18 7 18C6.44772 18 6 17.5523 6 17L6 14H5V17C5 17.5523 4.55228 18 4 18C3.44772 18 3 17.5523 3 17V12Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M16 18C15.4477 18 15 17.5523 15 17V14H14V17C14 17.5523 13.5523 18 13 18C12.4477 18 12 17.5523 12 17V14H10.7215C10.3724 14 10.1308 13.6513 10.2533 13.3244L12.4733 7.40449C12.7901 6.55968 13.5977 6 14.5 6C15.4023 6 16.2099 6.55968 16.5267 7.40449L18.7467 13.3244C18.8692 13.6513 18.6276 14 18.2785 14H17V17C17 17.5523 16.5523 18 16 18Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M14.5 5C15.3284 5 16 4.32843 16 3.5C16 2.67157 15.3284 2 14.5 2C13.6716 2 13 2.67157 13 3.5C13 4.32843 13.6716 5 14.5 5Z\" fill=\"#212121\"/>';\n            break;\n        case 'Smoke Sensor':\n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M9.64491 2.08319C9.48444 1.9888 9.28482 1.99138 9.12685 2.08988C8.96887 2.18839 8.87871 2.3665 8.89285 2.55213C8.98169 3.71876 8.78795 4.5943 8.45363 5.30483C8.11607 6.02225 7.62209 6.60008 7.06387 7.157C6.88401 7.33644 6.69008 7.52013 6.49214 7.70763C6.10197 8.07721 5.69618 8.46158 5.35189 8.85718C4.81113 9.47853 4.35082 10.1982 4.15741 11.131C3.35478 15.0023 6.43952 18.1649 10.361 17.9822C10.41 17.9806 10.4592 17.9779 10.5088 17.9741L10.55 17.9708L10.5673 17.9695C10.6635 17.9622 10.7585 17.9532 10.8523 17.9427C10.897 17.9427 10.9422 17.9409 10.9878 17.9375C11.1369 17.9261 11.2735 17.9002 11.3976 17.8614C12.9028 17.5787 14.0571 16.8581 14.836 15.8302C15.7453 14.6303 16.1036 13.0646 15.9781 11.4151C15.7275 8.1215 13.5473 4.37866 9.64491 2.08319ZM12.1372 15.5326C12.1487 15.5269 12.1601 15.521 12.1714 15.5152C12.2227 15.2706 12.2393 15.0003 12.2172 14.7101C12.1353 13.6344 11.5243 12.3752 10.3912 11.4298C10.3443 11.6743 10.2711 11.8979 10.1767 12.1045C9.97248 12.5515 9.68116 12.8915 9.40451 13.1748C9.2918 13.2902 9.1897 13.3891 9.09461 13.4812C8.93666 13.6341 8.79804 13.7684 8.66241 13.9284C8.46694 14.1591 8.33595 14.3839 8.28119 14.6575C8.20904 15.018 8.23357 15.3634 8.33595 15.6725C8.69526 15.8186 9.08844 15.9185 9.50948 15.9633C9.62655 15.764 9.79981 15.6036 9.97777 15.4389C10.3505 15.0938 10.7439 14.7297 10.6844 13.949C11.3929 14.3558 11.8813 14.938 12.1372 15.5326ZM13.2143 14.6343L13.2159 14.6563L13.2421 14.6222C13.7907 13.8983 14.0816 12.8503 13.9839 11.5668C13.8301 9.5445 12.7138 7.15459 10.6097 5.25541C10.5143 5.57021 10.3981 5.86993 10.2634 6.15628C9.78098 7.18157 9.09869 7.9521 8.47652 8.57282C8.20885 8.83986 7.97694 9.05847 7.76612 9.25719C7.43058 9.57348 7.14846 9.83941 6.86065 10.1701C6.45742 10.6334 6.21678 11.0502 6.11585 11.537C5.83546 12.8894 6.29313 14.1616 7.23945 14.9971C7.24423 14.8222 7.26422 14.6432 7.30064 14.4613C7.39921 13.9687 7.63564 13.5933 7.89951 13.2819C8.06367 13.0882 8.26661 12.8908 8.44919 12.7131C8.53584 12.6288 8.61792 12.549 8.68907 12.4761C8.93347 12.2258 9.13295 11.9826 9.26713 11.689C9.39844 11.4016 9.47964 11.0379 9.44124 10.5337C9.42702 10.347 9.51835 10.168 9.67788 10.0698C9.83741 9.97174 10.0384 9.97101 10.1986 10.068C12.0451 11.1851 13.0906 13.0082 13.2143 14.6343Z\" fill=\"#212121\"/>';\n            break;\n        default:\n            typeSvg = '<circle cx=\"10\" cy=\"10\" r=\"10\" fill=\"#AAAAAA\"/>';\n    }\n    \n    return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' + \n           typeSvg +\n           '</svg>';\n} \n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.8077097060074172,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "state",
                  "type": "attribute",
                  "label": "{i18n:custom.gateways.state}",
                  "color": "#ffc107",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "cellContentFunction": "var state = value;\nvar active = entity.active;\nif (active === 'false') {\n    state = 'disconnected';\n}\n\nvar stateSvg = getStateSvg(state);\nvar encodedStateSvg = encodeURIComponent(stateSvg);\nvar stateSvgUrl = 'data:image/svg+xml,' + encodedStateSvg;\nvar stateLabel = getStateLabel(state);\n\nreturn '<span>'+\n           '<img style=\"vertical-align: middle;\" class=\"mat-icon\" src=\"'+ stateSvgUrl +'\">' +\n           '<span style=\"vertical-align: middle; padding-left: 8px;\">'+ stateLabel +'</span>' +\n       '</span>';\n            \nfunction getStateSvg(state) {\n    switch (state) {\n        case 'critical':\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#E64A19\"/>' +\n                   '</svg>';\n        case 'major':            \n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#D5C21B\"/>' +\n                   '</svg>';\n        case 'normal':            \n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#1F8B4D\"/>' +\n                   '</svg>';\n        case 'disconnected':\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<g clip-path=\"url(#clip0_2839_52564)\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#CAC1D2\"/>' +\n                   '<path d=\"M1.92896 16.728L16.0711 2.58589L17.4853 4.00011L3.34317 18.1422L1.92896 16.728Z\" fill=\"#CAC1D2\"/>' +\n                   '<path d=\"M2.10692 16.3171C1.81393 16.0241 1.81393 15.5491 2.10692 15.2561L15.1852 2.17788C15.4781 1.88489 15.9532 1.88489 16.2462 2.17788C16.5392 2.47088 16.5392 2.94591 16.2462 3.2389L3.16794 16.3171C2.87495 16.6101 2.39991 16.6101 2.10692 16.3171Z\" fill=\"white\"/>' +\n                   '</g>' +\n                   '<defs>' +\n                   '<clipPath id=\"clip0_2839_52564\">' +\n                   '<rect width=\"20\" height=\"20\" fill=\"white\"/>' +\n                   '</clipPath>' +\n                   '</defs>' +\n                   '</svg>';\n        default:\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#AAAAAA\"/>' +\n                   '</svg>';\n    }\n}\n\nfunction getStateLabel(state) {\n    switch(state) {\n        case 'critical':\n            return 'Critical';\n        case 'major':\n            return 'Major';\n        case 'normal':\n            return 'Normal';\n        case 'disconnected':\n            return 'Disconnected';\n        default:\n            return state;\n    }\n}\n"
                  },
                  "_hash": 0.2718881518921066,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "active",
                  "type": "attribute",
                  "label": "{i18n:custom.gateways.active}",
                  "color": "#607d8b",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "hidden",
                    "columnSelectionToDisplay": "disabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.04680501891139488,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "project",
                  "type": "attribute",
                  "label": "{i18n:custom.gateways.project}",
                  "color": "#8bc34a",
                  "settings": {},
                  "_hash": 0.8763152471849911,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "measurement",
                  "type": "attribute",
                  "label": "{i18n:custom.gateways.measurement}",
                  "color": "#3f51b5",
                  "settings": {},
                  "_hash": 0.35624237678584225,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "div.tb-widget .tb-widget-title {\n    max-height: 100px !important;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "rowClick": [],
            "headerButton": [
              {
                "name": "{i18n:custom.gateways.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n/*params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten*/\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7d1a4c6c-81a8-efc8-e7aa-46a5d330d301"
              },
              {
                "name": "{i18n:custom.gateways.add-gateway}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form\r\n  #editEntityForm=\"ngForm\"\r\n  [formGroup]=\"editEntityFormGroup\"\r\n  (ngSubmit)=\"save()\"\r\n  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width:600px;\"\r\n>\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.gateways.add-gateway' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar\r\n    color=\"warn\"\r\n    mode=\"indeterminate\"\r\n    *ngIf=\"isLoading$ | async\"\r\n  ></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <mat-stepper\r\n      *ngIf=\"editEntityFormGroup\"\r\n      #stepper\r\n      [linear]=\"true\"\r\n      animationDuration=\"500ms\"\r\n      style=\"flex-grow: 1;\"\r\n    >\r\n      <!-- Step 1: Gateway details -->\r\n      <mat-step [stepControl]=\"editEntityFormGroup.get('general')\">\r\n        <ng-template matStepLabel>{{ 'custom.gateways.add-gateway-gateway-details' | translate }}</ng-template>\r\n\r\n        <div\r\n          class=\"flex flex-col justify-start items-stretch flex-grow\"\r\n          [formGroup]=\"editEntityFormGroup.get('general')\"\r\n        >\r\n          <!-- Device Type -->\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>{{ 'custom.gateways.add-gateway-device-type' | translate }}</mat-label>\r\n            <mat-select\r\n              formControlName=\"type\"\r\n              placeholder=\"Select Type\"\r\n              (selectionChange)=\"onDeviceTypeChange()\"\r\n            >\r\n              <mat-option value=\"RESI\">RESI</mat-option>\r\n              <mat-option value=\"Gateway\">LoRaWAN Gateway</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n\r\n          <!-- Non-Gateway fields -->\r\n          <div *ngIf=\"editEntityFormGroup.get('general').get('type').value !== 'Gateway'\">\r\n            <!--<div class=\"flex flex-col gap-0 sm:flex-row sm:gap-2\">-->\r\n             <div class=\"flex w-full gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Name</mat-label>\r\n                <input matInput formControlName=\"entityName\" required />\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('general').get('entityName').hasError('required')\">\r\n                  {{ 'custom.gateways.add-gateway-entity-name-required' | translate }}\r\n                </mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Label</mat-label>\r\n                <input matInput formControlName=\"entityLabel\" />\r\n              </mat-form-field>\r\n            </div>\r\n            <div formGroupName=\"attributes\" class=\"flex flex-col\">\r\n               <div class=\"flex w-full gap-2\">\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>{{ 'custom.gateways.add-gateway-display-name' | translate }}</mat-label>\r\n                  <input matInput formControlName=\"displayName\" />\r\n                </mat-form-field>\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>{{ 'custom.gateways.add-gateway-customer' | translate }}</mat-label>\r\n                  <input matInput formControlName=\"customer\" required readonly />\r\n                </mat-form-field>\r\n              </div>\r\n              <div class=\"flex flex-col gap-0 sm:flex-row sm:gap-2\">\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>{{ 'custom.gateways.add-gateway-serial-number' | translate }}</mat-label>\r\n                  <input matInput formControlName=\"serialNumber\" required />\r\n                </mat-form-field>\r\n              </div>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.gateways.add-gateway-inactivity-timeout' | translate }}</mat-label>\r\n                <input type=\"number\" matInput formControlName=\"inactivityTimeout\" required />\r\n              </mat-form-field>\r\n            </div>\r\n          </div>\r\n\r\n          <!-- Gateway-specific fields -->\r\n          <div *ngIf=\"editEntityFormGroup.get('general').get('type').value === 'Gateway'\">\r\n            <div class=\"flex w-full gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Name</mat-label>\r\n                <input matInput formControlName=\"entityName\" required />\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('general').get('entityName').hasError('required')\">\r\n                  {{ 'custom-gateways-add-gateway-entity-name-required' | translate }}\r\n                </mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Label</mat-label>\r\n                <input matInput formControlName=\"entityLabel\" />\r\n              </mat-form-field>\r\n            </div>\r\n            <div formGroupName=\"attributes\" fxLayout=\"column\">\r\n               <div class=\"flex w-full gap-2\">\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>{{ 'custom.gateways.add-gateway-display-name' | translate }}</mat-label>\r\n                  <input matInput formControlName=\"displayName\" />\r\n                </mat-form-field>\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>{{ 'custom.gateways.add-gateway-customer' | translate }}</mat-label>\r\n                  <input matInput formControlName=\"customer\" required readonly />\r\n                </mat-form-field>\r\n              </div>\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>Gateway ID</mat-label>\r\n                <input matInput formControlName=\"gatewayID\" required pattern=\"[a-zA-Z0-9]{16}\" />\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>{{ 'custom.gateways.add-gateway-inactivity-timeout' | translate }}</mat-label>\r\n                <input type=\"number\" matInput formControlName=\"inactivityTimeout\" required />\r\n              </mat-form-field>\r\n            </div>\r\n          </div>\r\n\r\n          <!-- Further Actions -->\r\n          <fieldset class=\"fieldset\" style=\"margin-bottom: 15px;\">\r\n            <legend>{{ 'custom.gateways.add-gateway-select-further-actions' | translate }}\r\n            </legend>\r\n            <div\r\n              style=\"display: flex; flex-direction: column; align-items: flex-start; margin-top: 5px; margin-bottom: 15px;\"\r\n            >\r\n              <div\r\n                class=\"flex justify-between items-center flex-auto w-full h-full\"\r\n                style=\"margin-top: 5px; margin-bottom: 15px;\"\r\n              >\r\n                <mat-checkbox\r\n                  formControlName=\"createKit\"\r\n                  (change)=\"onCreateKitChange($event)\"\r\n                  style=\"flex: 0 0 50%;\"\r\n                >\r\n                  {{ 'custom.gateways.add-gateway-create-kit' | translate }}\r\n                </mat-checkbox>\r\n                <mat-checkbox\r\n                  *ngIf=\"editEntityFormGroup.get('general').get('createKit').value\"\r\n                  formControlName=\"addDevices\"\r\n                  (change)=\"onAddDevicesChange($event)\"\r\n                  style=\"flex: 0 0 50%;\"\r\n                >\r\n                  {{ 'custom.gateways.add-gateway-add-devices' | translate }}\r\n                </mat-checkbox>\r\n              </div>\r\n              <mat-form-field\r\n                class=\"flex-1 block\"\r\n                *ngIf=\"editEntityFormGroup.get('general').get('createKit').value\"\r\n                style=\"width: 100%;\"\r\n              >\r\n                <mat-label>{{ 'custom.gateways.add-gateway-new-kit' | translate }}</mat-label>\r\n                <input matInput formControlName=\"newKit\" required />\r\n              </mat-form-field>\r\n              <mat-checkbox formControlName=\"activateSIM\" style=\"width:auto;\">{{ 'custom.gateways.add-gateway-activate-sim' | translate }}</mat-checkbox>\r\n              <div\r\n                *ngIf=\"editEntityFormGroup.get('general').get('activateSIM').value\"\r\n                formGroupName=\"connectivity\" class=\"w-full\"\r\n              >\r\n                <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                  <mat-label>ICCID</mat-label>\r\n                  <input matInput formControlName=\"ICCID\" required />\r\n                  <mat-error\r\n                    *ngIf=\"\r\n                      editEntityFormGroup.get('general').get('connectivity').get('ICCID').hasError(\r\n                        'required'\r\n                      )\r\n                    \"\r\n                  >\r\n                    {{ 'custom-gateways-add-gateway-iccid-required' | translate }}\r\n                  </mat-error>\r\n                </mat-form-field>\r\n                <div class=\"flex w-full gap-2\">\r\n                  <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                    <mat-label>Carrier</mat-label>\r\n                    <mat-select formControlName=\"carrierSIM\" placeholder=\"Select Carrier\" required>\r\n                      <mat-option value=\"tech+\">wherever SIM tech+</mat-option>\r\n                      <mat-option value=\"link+\">wherever SIM link+</mat-option>\r\n                    </mat-select>\r\n                    <mat-error\r\n                      *ngIf=\"\r\n                        editEntityFormGroup.get('general').get('connectivity').get('carrierSIM').hasError(\r\n                          'required'\r\n                        )\r\n                      \"\r\n                    >\r\n                      {{ 'custom-gateways-add-gateway-carrier-required' | translate }}\r\n                    </mat-error>\r\n                  </mat-form-field>\r\n                  <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                    <mat-label>SIM Status</mat-label>\r\n                    <mat-select formControlName=\"statusSIM\" placeholder=\"Select SIM-Status\" required>\r\n                      <mat-option value=\"2\">{{ 'custom.gateways.add-gateway-activate' | translate }}</mat-option>\r\n                      <mat-option value=\"5\">{{ 'custom.gateways.add-gateway-deactivate' | translate }}</mat-option>\r\n                    </mat-select>\r\n                    <mat-error\r\n                      *ngIf=\"\r\n                        editEntityFormGroup.get('general').get('connectivity').get('statusSIM').hasError(\r\n                          'required'\r\n                        )\r\n                      \"\r\n                    >\r\n                      {{ 'custom-gateways-add-gateway-status-required' | translate }}\r\n                    </mat-error>\r\n                  </mat-form-field>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </fieldset>\r\n        </div>\r\n\r\n        <!-- Step 1 Footer -->\r\n        <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n          <button\r\n            mat-button\r\n            color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\"\r\n            cdkFocusInitial\r\n          >\r\n            {{ 'action.cancel' | translate }}\r\n          </button>\r\n          <button\r\n            mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            matStepperNext\r\n            type=\"button\"\r\n            *ngIf=\"\r\n              editEntityFormGroup.get('general').get('type').value !== 'Gateway' ||\r\n              editEntityFormGroup.get('general').get('addDevices').value === true\r\n            \"\r\n            [disabled]=\"\r\n              (isLoading$ | async) ||\r\n              editEntityFormGroup.get('general').invalid ||\r\n              !editEntityFormGroup.get('general').dirty\r\n            \"\r\n          >\r\n            {{ 'custom.gateways.edit-gateway-next' | translate }}\r\n          </button>\r\n          <button\r\n            mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            type=\"submit\"\r\n            *ngIf=\"\r\n              editEntityFormGroup.get('general').get('type').value === 'Gateway' &&\r\n              editEntityFormGroup.get('general').get('addDevices').value === false\r\n            \"\r\n            [disabled]=\"\r\n              (isLoading$ | async) ||\r\n              editEntityFormGroup.invalid ||\r\n              !editEntityFormGroup.dirty\r\n            \"\r\n          >\r\n            {{ 'custom.gateways.add-gateway-create' | translate }}\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <!-- Step 2: Credentials -->\r\n      <mat-step\r\n        [stepControl]=\"editEntityFormGroup.get('credentials')\"\r\n        *ngIf=\"editEntityFormGroup.get('general').get('type').value !== 'Gateway'\"\r\n      >\r\n        <ng-template matStepLabel>Credentials</ng-template>\r\n        <div\r\n          class=\"flex flex-col justify-start items-stretch\"\r\n          style=\"margin-top: 30px;\"\r\n          [formGroup]=\"editEntityFormGroup.get('credentials')\"\r\n        >\r\n          <mat-form-field class=\"w-full\">\r\n            <mat-label>{{ 'custom.gateways.add-gateway-credentials-type' | translate }}</mat-label>\r\n            <input matInput formControlName=\"credentialsType\" readonly />\r\n          </mat-form-field>\r\n          <mat-form-field class=\"w-full\">\r\n            <mat-label>Client ID</mat-label>\r\n            <input matInput formControlName=\"clientId\" required />\r\n            <button\r\n              mat-icon-button\r\n              type=\"button\"\r\n              matSuffix\r\n              matTooltip=\"{{ 'custom.gateways.edit-gateway-copy-client-id' | translate }}\"\r\n              (click)=\"copyToClipboard($event, 'credentials.clientId')\"\r\n            >\r\n              <mat-icon>content_copy</mat-icon>\r\n            </button>\r\n            <mat-error\r\n              *ngIf=\"editEntityFormGroup.get('credentials').get('clientId').hasError('required')\"\r\n            >\r\n              {{ 'custom-gateways-add-gateway-client-id-required' | translate }}\r\n            </mat-error>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"w-full\">\r\n            <mat-label>{{ 'custom-gateways-add-gateway-user-name' | translate }}</mat-label>\r\n            <input matInput formControlName=\"userName\" required />\r\n            <button\r\n              mat-icon-button\r\n              type=\"button\"\r\n              matSuffix\r\n              matTooltip=\"{{ 'custom.gateways.edit-gateway-copy-user-name' | translate }}\"\r\n              (click)=\"copyToClipboard($event, 'credentials.userName')\"\r\n            >\r\n              <mat-icon>content_copy</mat-icon>\r\n            </button>\r\n            <mat-error\r\n              *ngIf=\"editEntityFormGroup.get('credentials').get('userName').hasError('required')\"\r\n            >\r\n              {{ 'custom-gateways-add-gateway-user-name-required' | translate }}\r\n            </mat-error>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"w-full\">\r\n            <mat-label>{{ 'custom-gateways-add-gateway-password' | translate }}</mat-label>\r\n            <input\r\n              matInput\r\n              [type]=\"hidePassword ? 'password' : 'text'\"\r\n              formControlName=\"password\"\r\n              required\r\n            />\r\n            <button\r\n              mat-icon-button\r\n              type=\"button\"\r\n              matSuffix\r\n              matTooltip=\"{{ hidePassword ? ('custom.gateways.edit-gateway-show-password' | translate) : 'Hide Password' }}\"\r\n              (click)=\"togglePasswordVisibility()\"\r\n            >\r\n              <mat-icon>{{ hidePassword ? 'visibility' : 'visibility_off' }}</mat-icon>\r\n            </button>\r\n            <button\r\n              mat-icon-button\r\n              type=\"button\"\r\n              matSuffix\r\n              matTooltip=\"{{'custom.gateways.edit-gateway-copy-password' | translate}}\"\r\n              (click)=\"copyToClipboard($event, 'credentials.password')\"\r\n            >\r\n              <mat-icon>content_copy</mat-icon>\r\n            </button>\r\n            <mat-error\r\n              *ngIf=\"editEntityFormGroup.get('credentials').get('password').hasError('required')\"\r\n            >\r\n              {{ 'custom-gateways-add-gateway-password-required' | translate }}\r\n            </mat-error>\r\n          </mat-form-field>\r\n        </div>\r\n        <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n          <button\r\n            mat-button\r\n            color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\"\r\n            cdkFocusInitial\r\n          >\r\n            {{ 'action.cancel' | translate }}\r\n          </button>\r\n          <button\r\n            mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            matStepperNext\r\n            type=\"button\"\r\n            *ngIf=\"editEntityFormGroup.get('general').get('addDevices').value === true\"\r\n          >\r\n            {{ 'custom.gateways.edit-gateway-next' | translate }}\r\n          </button>\r\n          <button\r\n            mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            type=\"submit\"\r\n            *ngIf=\"editEntityFormGroup.get('general').get('addDevices').value === false\"\r\n            [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid || !editEntityFormGroup.dirty\"\r\n          >\r\n            {{ 'custom.gateways.add-gateway-create' | translate }}\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <!-- Step 3: Devices -->\r\n      <mat-step label=\"Devices\" *ngIf=\"showDevicesStep\">\r\n        <ng-template matStepLabel>{{ 'custom.gateways.add-gateway-devices' | translate }}</ng-template>\r\n        <div\r\n          class=\"flex flex-col justify-start items-stretch\"\r\n          style=\"margin-top: 5px;\"\r\n          [formGroup]=\"editEntityFormGroup.get('devices')\"\r\n        >\r\n          <div style=\"padding-top: 10px;\">\r\n            <mat-tab-group (selectedIndexChange)=\"onTabChange($event)\">\r\n              <!-- Create Tab -->\r\n              <mat-tab label=\"{{'action.create' | translate}}\">\r\n                <ng-template matTabContent>\r\n                  <div style=\"margin-top: 10px;\">\r\n                    <div class=\"flex gap-2\" style=\"margin-bottom: 10px;\">\r\n                      <button\r\n                        mat-stroked-button\r\n                        type=\"button\"\r\n                        style=\"flex: 1; background-color: #f0f0f0; color: black;\"\r\n                        (click)=\"addPflow()\"\r\n                        *ngIf=\"editEntityFormGroup.get('general')?.get('type')?.value === 'RESI'\"\r\n                      >\r\n                        {{ 'custom-gateways-add-gateway-add-p-flow' | translate }}\r\n                      </button>\r\n                      <button\r\n                        mat-stroked-button\r\n                        type=\"button\"\r\n                        style=\"flex: 1; background-color: #f0f0f0; color: black;\"\r\n                        (click)=\"addSensor()\"\r\n                      >\r\n                        {{ 'custom.gateways.add-gateway-add-sensor' | translate }}\r\n                      </button>\r\n                    </div>\r\n\r\n                    <!-- P-Flow Devices -->\r\n                    <div formArrayName=\"pflowDevices\">\r\n                      <div\r\n                        *ngFor=\"\r\n                          let pflowGroup of editEntityFormGroup.get('devices').get('pflowDevices')\r\n                            .controls;\r\n                          let i = index\r\n                        \"\r\n                        [formGroupName]=\"i\"\r\n                        class=\"flex justify-start items-center gap-2\"\r\n                      >\r\n                        <div class=\"flex-1\">\r\n                          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                            <mat-label>P-Flow {{ i + 1 }}</mat-label>\r\n                            <input matInput formControlName=\"name\" required readonly />\r\n                          </mat-form-field>\r\n                        </div>\r\n                        <button mat-icon-button type=\"button\" (click)=\"removePflow(i)\" *ngIf=\"canRemovePflow(i)\">\r\n                          <mat-icon>delete</mat-icon>\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <!-- Sensor Devices -->\r\n                    <div formArrayName=\"sensorDevices\">\r\n                      <div\r\n                        *ngFor=\"\r\n                          let sensorGroup of editEntityFormGroup.get('devices').get('sensorDevices')\r\n                            .controls;\r\n                          let i = index\r\n                        \"\r\n                        [formGroupName]=\"i\"\r\n                        class=\"flex flex-col gap-2\"\r\n                      >\r\n                        <div class=\"flex justify-start items-center gap-2\">\r\n                          <div class=\"flex-none w-[65%]\">\r\n                            <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                              <mat-label>Sensor {{ i + 1 }}</mat-label>\r\n                              <input matInput formControlName=\"name\" required readonly />\r\n                            </mat-form-field>\r\n                          </div>\r\n                          <div class=\"flex-none w-[35%]\">\r\n                            <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                              <mat-label>{{ 'custom.gateways.add-gateway-sensor-type' | translate }}</mat-label>\r\n                              <mat-select\r\n                                formControlName=\"type\"\r\n                                required\r\n                                (selectionChange)=\"onSensorTypeChange(i)\"\r\n                              >\r\n                                <mat-option\r\n                                  *ngIf=\"\r\n                                    editEntityFormGroup.get('general')?.get('type')?.value ===\r\n                                    'RESI'\r\n                                  \"\r\n                                  value=\"Temperature Sensor\"\r\n                                >\r\n                                  {{ 'custom-gateways-add-gateway-temperature' | translate }}\r\n                                </mat-option>\r\n                                <mat-option\r\n                                  *ngIf=\"\r\n                                    editEntityFormGroup.get('general')?.get('type')?.value !==\r\n                                    'RESI'\r\n                                  \"\r\n                                  value=\"Room Sensor CO2\"\r\n                                >\r\n                                  CO2\r\n                                </mat-option>\r\n                              </mat-select>\r\n                            </mat-form-field>\r\n                          </div>\r\n                          <button\r\n                            mat-icon-button\r\n                            type=\"button\"\r\n                            (click)=\"removeSensor(i)\"\r\n                            *ngIf=\"canRemoveSensor(i)\"\r\n                          >\r\n                            <mat-icon>delete</mat-icon>\r\n                          </button>\r\n                        </div>\r\n                        <div\r\n                          *ngIf=\"sensorGroup.get('devEUI')\"\r\n                          class=\"flex gap-2 justify-start items-center\"\r\n                        >\r\n                          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                            <mat-label>devEUI</mat-label>\r\n                            <input\r\n                              matInput\r\n                              formControlName=\"devEUI\"\r\n                              required\r\n                              pattern=\"[a-zA-Z0-9]{16}\"\r\n                            />\r\n                            <mat-error *ngIf=\"sensorGroup.get('devEUI').hasError('required')\">\r\n                              {{ 'custom-gateways-add-gateway-dev-eui-required' | translate }}\r\n                            </mat-error>\r\n                            <mat-error *ngIf=\"sensorGroup.get('devEUI').hasError('pattern')\">\r\n                              {{ 'custom-gateways-add-gateway-dev-eui-format' | translate }}\r\n                            </mat-error>\r\n                          </mat-form-field>\r\n                          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                            <mat-label>appKey</mat-label>\r\n                            <input\r\n                              matInput\r\n                              formControlName=\"appKey\"\r\n                              required\r\n                              pattern=\"[a-zA-Z0-9]{32}\"\r\n                            />\r\n                            <mat-error *ngIf=\"sensorGroup.get('appKey').hasError('required')\">\r\n                              {{ 'custom-gateways-add-gateway-appkey-required' | translate }}\r\n                            </mat-error>\r\n                            <mat-error *ngIf=\"sensorGroup.get('appKey').hasError('pattern')\">\r\n                              {{ 'custom-gateways-add-gateway-appkey-format' | translate }}\r\n                            </mat-error>\r\n                          </mat-form-field>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </ng-template>\r\n              </mat-tab>\r\n\r\n              <!-- Assign Tab -->\r\n              <mat-tab label=\"{{'action.assign' | translate}}\">\r\n                <ng-template matTabContent>\r\n                  <div style=\"margin-top: 10px;\" [formGroup]=\"editEntityFormGroup.get('devices').get('assignmentStep')\">\r\n                    <div class=\"flex gap-2\" style=\"margin-bottom: 10px;\">\r\n                      <button\r\n                        mat-stroked-button\r\n                        type=\"button\"\r\n                        style=\"width: 100%; margin-bottom: 8px; background-color: #f0f0f0; color: black;\"\r\n                        (click)=\"addAssignDevice()\"\r\n                        *ngIf=\"editEntityFormGroup.get('general')?.get('type')?.value === 'RESI'\"\r\n                      >\r\n                        {{ 'custom-gateways-add-gateway-add-p-flow' | translate }}\r\n                      </button>\r\n                      <button\r\n                        mat-stroked-button\r\n                        type=\"button\"\r\n                        style=\"width: 100%; margin-bottom: 16px; background-color: #f0f0f0; color: black;\"\r\n                        (click)=\"addAssignSensor()\"\r\n                      >\r\n                        {{ 'custom.gateways.add-gateway-add-sensor' | translate }}\r\n                      </button>\r\n                    </div>\r\n\r\n                    <div formArrayName=\"devices\" *ngIf=\"editEntityFormGroup.get('general')?.get('type')?.value === 'RESI'\">\r\n                      <div\r\n                        *ngFor=\"let deviceGroup of editEntityFormGroup.get('devices').get('assignmentStep').get('devices').controls; let i = index\"\r\n                        [formGroupName]=\"i\"\r\n                        class=\"flex justify-start items-center gap-2\"\r\n                      >\r\n                        <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                          <mat-label>P-Flow {{ i + 1 }}</mat-label>\r\n                          <input\r\n                            type=\"text\"\r\n                            matInput\r\n                            formControlName=\"device\"\r\n                            [matAutocomplete]=\"auto\"\r\n                            (keyup)=\"filterAssignDevices(i)\"\r\n                            (focus)=\"resetAssignFilter(i)\"\r\n                            required\r\n                          />\r\n                          <mat-autocomplete #auto=\"matAutocomplete\" [displayWith]=\"displayDevice\">\r\n                            <mat-option *ngFor=\"let device of filteredAssignDevices[i]\" [value]=\"device\">\r\n                              <div class=\"device-item flex flex-col gap-1\">\r\n                                <div class=\"flex\">\r\n                                  <div>{{ device?.name }}</div>\r\n                                </div>\r\n                                <div class=\"flex justify-between items-center\">\r\n                                  <div class=\"device-type\">{{ device?.type }}</div>\r\n                                  <div class=\"device-name\">{{ device?.label }}</div>\r\n                                </div>\r\n                              </div>\r\n                              <mat-divider></mat-divider>\r\n                            </mat-option>\r\n                            <mat-option *ngIf=\"filteredAssignDevices[i].length === 0\" disabled>\r\n                              {{ 'custom-gateways-add-gateway-no-devices' | translate }}\r\n                            </mat-option>\r\n                          </mat-autocomplete>\r\n                          <mat-error *ngIf=\"deviceGroup.get('device')?.hasError('required')\">\r\n                            {{ 'custom-gateways-add-gateway-device-required' | translate }}\r\n                          </mat-error>\r\n                          <mat-error *ngIf=\"deviceGroup.get('device').hasError('invalidDevice')\">\r\n                            {{ 'custom-gateways-add-gateway-select-valid-device' | translate }}\r\n                          </mat-error>\r\n                        </mat-form-field>\r\n                        <button\r\n                          mat-icon-button\r\n                          type=\"button\"\r\n                          (click)=\"removeAssignDevice(i)\"\r\n                          *ngIf=\"canRemoveAssignDevice(i)\"\r\n                        >\r\n                          <mat-icon>delete</mat-icon>\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div formArrayName=\"sensors\">\r\n                      <div\r\n                        *ngFor=\"let sensorGroup of editEntityFormGroup.get('devices').get('assignmentStep').get('sensors').controls; let i = index\"\r\n                        [formGroupName]=\"i\"\r\n                        class=\"flex justify-start items-center gap-2\"\r\n                      >\r\n                        <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                          <mat-label>Sensor {{ i + 1 }}</mat-label>\r\n                          <input\r\n                            type=\"text\"\r\n                            matInput\r\n                            formControlName=\"device\"\r\n                            [matAutocomplete]=\"autoSensor\"\r\n                            (keyup)=\"filterAssignSensors(i)\"\r\n                            (focus)=\"resetAssignSensorFilter(i)\"\r\n                            required\r\n                          />\r\n                          <mat-autocomplete #autoSensor=\"matAutocomplete\" [displayWith]=\"displaySensor\">\r\n                            <mat-option *ngFor=\"let device of filteredAssignSensors[i]\" [value]=\"device\">\r\n                              <div class=\"device-item flex flex-col gap-1\">\r\n                                <div class=\"flex\">\r\n                                  <div>{{ device?.name }}</div>\r\n                                </div>\r\n                                <div class=\"flex justify-between items-center\">\r\n                                  <div class=\"device-type\">{{ device?.type }}</div>\r\n                                  <div class=\"device-name\">{{ device?.label }}</div>\r\n                                </div>\r\n                              </div>\r\n                              <mat-divider></mat-divider>\r\n                            </mat-option>\r\n                            <mat-option *ngIf=\"filteredAssignSensors[i].length === 0\" disabled>\r\n                              {{ 'custom-gateways-add-gateway-no-devices' | translate }}\r\n                            </mat-option>\r\n                          </mat-autocomplete>\r\n                          <mat-error *ngIf=\"sensorGroup.get('device')?.hasError('required')\">\r\n                            {{ 'custom-gateways-add-gateway-device-required' | translate }}\r\n                          </mat-error>\r\n                          <mat-error *ngIf=\"sensorGroup.get('device')?.hasError('invalidDevice')\">\r\n                            {{ 'custom-gateways-add-gateway-select-valid-device' | translate }}\r\n                          </mat-error>\r\n                        </mat-form-field>\r\n                        <button\r\n                          mat-icon-button\r\n                          type=\"button\"\r\n                          (click)=\"removeAssignSensor(i)\"\r\n                          *ngIf=\"canRemoveAssignSensor(i)\"\r\n                        >\r\n                          <mat-icon>delete</mat-icon>\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </ng-template>\r\n              </mat-tab>\r\n            </mat-tab-group>\r\n\r\n            <!-- Step 3 Footer -->\r\n            <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n              <button mat-button color=\"primary\" type=\"button\" [disabled]=\"isLoading$ | async\" (click)=\"cancel()\">\r\n                {{ 'action.cancel' | translate }}\r\n              </button>\r\n              <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid || !editEntityFormGroup.dirty\">\r\n                {{ 'custom.gateways.add-gateway-create' | translate }}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </mat-step>\r\n    </mat-stepper>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n.device-item {\n    line-height: 24px;\n    width: 100%;\n    padding-top: 8px;\n    padding-bottom: 8px;\n}\n\n.device-item .device-name {\n    font-size: 12px;\n    opacity: 0.7;\n}\n\n.device-item .device-type {\n    font-size: 14px;\n    opacity: 0.7;\n}\n\nmat-option {\n    height: auto !important;\n    white-space: normal !important;\n}\n\n.mat-select-value-text {\n    display: block;\n    width: 100%;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet diagnostickitsAll = [];\r\n// Fetch all customers, then fetch all their Diagnostickits\r\n//customerService.getCustomers(pageLink).subscribe(customers => {\r\n  //console.log(\"customers:\", customers);\r\n\r\n  // Track how many customer queries have completed\r\n  let processed = 0;\r\n  //const totalCustomers = customers.data.length;\r\n\r\n  /*customers.data.map(customer => {\r\n    // Build our query for this specific customer's ID\r\n    const assetSearchQuery = {\r\n      parameters: {\r\n        rootId: customer.id.id,       \r\n        rootType: 'CUSTOMER',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Diagnostickit']\r\n    };\r\n    assetService.findByQuery(assetSearchQuery).subscribe(diagnostickits => {\r\n      //console.log(\"diagnostickits of customer:\", customer.name, diagnostickits);    \r\n      // Merge these Diagnostickits into our master array\r\n      diagnostickitsAll.push(...diagnostickits);\r\n\r\n      // Increment the processed counter\r\n      processed++;\r\n      // If we've processed all customers, open the dialog\r\n      if (processed === totalCustomers) {\r\n        //console.log('All Diagnostickits across all customers:', diagnostickitsAll);\r\n        openAddEntityDialog();\r\n      }\r\n    });\r\n  });\r\n});*/\r\nopenAddEntityDialog();\r\nfunction openAddEntityDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddEntityDialogController).subscribe();\r\n}\r\n\r\nfunction getSelectedCustomerId() {\r\n  let stateParams = widgetContext.stateController.getStateParams();\r\n  return stateParams.entityId.id;\r\n}\r\n\r\nfunction getSelectedCustomerName() {\r\n  let stateParams = widgetContext.stateController.getStateParams();\r\n  try {\r\n    return stateParams.entityName;\r\n  } catch (error) {\r\n    return stateParams.entityName;\r\n  }\r\n}\r\n\r\nfunction generateRandomPassword() {\r\n  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';\r\n  let password = '';\r\n  for (let i = 0; i < 20; i++) {\r\n    password += chars.charAt(Math.floor(Math.random() * chars.length));\r\n  }\r\n  return password;\r\n}\r\n\r\nfunction AddEntityDialogController(instance) {\r\n  let vm = instance;\r\n  let customerID = widgetContext.stateController.getStateParams().entityId.id;\r\n  let customerName = widgetContext.stateController.getStateParams().entityName;\r\n  vm.allowedEntityTypes = ['ASSET', 'DEVICE', 'Gateway'];\r\n  vm.entitySearchDirection = {\r\n    from: 'FROM',\r\n    to: 'TO',\r\n  };\r\n    \r\n     function deviceSelectionValidator(control) {\r\n       if (!control.value) {\r\n            return null;\r\n       }\r\n       return (typeof control.value === 'object' && control.value !== null)\r\n         ? null\r\n         : { invalidDevice: true };\r\n    }\r\n    \r\n  vm.editEntityFormGroup = vm.fb.group({\r\n    general: vm.fb.group({\r\n      type: ['MUC', [vm.validators.required]],\r\n      entityName: [{ value: '' }, [vm.validators.required]],\r\n      entityLabel: [''],\r\n      createKit: [false],\r\n      addDevices: [false],\r\n      activateSIM: [false],\r\n      newKit: [''],\r\n      attributes: vm.fb.group({\r\n        isGateway: [true],\r\n        inactivityTimeout: ['60'],\r\n        street: [''],\r\n        displayName: [''],\r\n        city: [''],\r\n        plz: [''],\r\n        customer: [getSelectedCustomerName()],\r\n        gatewayID: [''],\r\n        serialNumber: ['']\r\n      }),\r\n      connectivity: vm.fb.group({\r\n        ICCID: [''],\r\n        statusSIM: [''],\r\n        carrierSIM: ['']\r\n      }),\r\n    }),\r\n    credentials: vm.fb.group({\r\n      credentialsType: ['MQTT_BASIC'],\r\n      clientId: ['', [vm.validators.required]],\r\n      userName: ['pke', [vm.validators.required]],\r\n      password: [generateRandomPassword(), [vm.validators.required]],\r\n    }),\r\n    devices: vm.fb.group({\r\n      pflowDevices: vm.fb.array([]),\r\n      sensorDevices: vm.fb.array([]),\r\n      assignmentStep: vm.fb.group({\r\n        devices: vm.fb.array([\r\n          vm.fb.group({\r\n            device: [null, [vm.validators.required]],\r\n          }),\r\n        ]),\r\n        sensors: vm.fb.array([]),\r\n      }),\r\n    }),\r\n  });\r\n\r\n  vm.selectedTabIndex = 0;\r\n  \r\n    // Call this when the user types in the input field.\r\n    // 'i' is the index of the assign device group.\r\n    vm.filterAssignDevices = function(i) {\r\n      // Get the current input value from the form control.\r\n      let inputValue = vm.editEntityFormGroup.get('devices')\r\n                          .get('assignmentStep')\r\n                          .get('devices')\r\n                          .at(i)\r\n                          .get('device').value;\r\n      \r\n      // If the value is not a string, fallback to an empty string.\r\n      let filterValue = (typeof inputValue === 'string' ? inputValue.toLowerCase() : '');\r\n      \r\n      if (!filterValue) {\r\n        vm.filteredAssignDevices[i] = vm.getAvailablePFlowDevices(i).slice();\r\n      } else {\r\n        vm.filteredAssignDevices[i] = vm.getAvailablePFlowDevices(i).filter(device =>\r\n          device.name.toLowerCase().includes(filterValue) ||\r\n          (device.label && device.label.toLowerCase().includes(filterValue)) ||\r\n          device.type.toLowerCase().includes(filterValue)\r\n        );\r\n      }\r\n    };\r\n    \r\n    // Reset the filtered devices when the field is focused:\r\n    vm.resetAssignFilter = function(i) {\r\n      vm.filteredAssignDevices[i] = vm.getAvailablePFlowDevices(i).slice();\r\n    };\r\n    \r\n    // A helper display function (as used in your inspiration code)\r\n    vm.displayDevice = function(device) {\r\n      return device ? `${device.name} (${device.type})` : '';\r\n    };\r\n    \r\n    vm.filterAssignSensors = function(i) {\r\n      // Get current input value from the sensor assign control.\r\n      let inputValue = vm.editEntityFormGroup.get('devices')\r\n                          .get('assignmentStep')\r\n                          .get('sensors')\r\n                          .at(i)\r\n                          .get('device').value;\r\n      \r\n      // If the input is an object, get its name property; otherwise use it directly.\r\n      let filterValue = '';\r\n      if (typeof inputValue === 'object' && inputValue !== null) {\r\n        filterValue = inputValue.name ? inputValue.name.toLowerCase() : '';\r\n      } else if (typeof inputValue === 'string') {\r\n        filterValue = inputValue.toLowerCase();\r\n      }\r\n      \r\n      if (!filterValue) {\r\n        vm.filteredAssignSensors[i] = vm.getAvailableSensorDevices(i).slice();\r\n      } else {\r\n        vm.filteredAssignSensors[i] = vm.getAvailableSensorDevices(i).filter(sensor =>\r\n          sensor.name.toLowerCase().includes(filterValue) ||\r\n          (sensor.label && sensor.label.toLowerCase().includes(filterValue)) ||\r\n          sensor.type.toLowerCase().includes(filterValue)\r\n        );\r\n      }\r\n    };\r\n\r\n    \r\n    // 2. Reset function for sensor assign field:\r\n    vm.resetAssignSensorFilter = function(i) {\r\n      vm.filteredAssignSensors[i] = vm.getAvailableSensorDevices(i).slice();\r\n    };\r\n    \r\n    // 3. Display function for sensor:\r\n    vm.displaySensor = function(sensor) {\r\n      return sensor ? `${sensor.name} (${sensor.type})` : '';\r\n    };\r\n\r\n  vm.addPflow = function () {\r\n      if(vm.editEntityFormGroup.get('general').get('type').value === 'RESI') {\r\n        const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n        const index = pflowDevicesArray.length + 1;\r\n        const pflowName = constructBasicPflowName(\r\n          vm.customerShortName,\r\n          vm.editEntityFormGroup.get('general').get('type').value,\r\n          vm.editEntityFormGroup.get('general').get('attributes').get('serialNumber')?.value || '',\r\n          vm.editEntityFormGroup.get('general').get('attributes').get('gatewayID')?.value || '',\r\n          index\r\n        );\r\n      \r\n\r\n        const newPflowGroup = vm.fb.group({\r\n          name: [pflowName],\r\n        });\r\n        pflowDevicesArray.push(newPflowGroup);\r\n      }\r\n  };\r\n\r\n  vm.removePflow = function (index) {\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n    if (\r\n      pflowDevicesArray.length > 1 &&\r\n      index === pflowDevicesArray.length - 1 &&\r\n      index > 0\r\n    ) {\r\n      pflowDevicesArray.removeAt(index);\r\n    }\r\n  };\r\n\r\n  vm.canRemovePflow = function (index) {\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n    return (\r\n      pflowDevicesArray.length > 1 &&\r\n      index === pflowDevicesArray.length - 1 &&\r\n      index > 0\r\n    );\r\n  };\r\n\r\n  vm.addSensor = function () {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      let sensorType;\r\n      if(vm.editEntityFormGroup.get('general').get('type').value === 'RESI') {\r\n            sensorType = 'Temperature Sensor';\r\n      } else{\r\n            sensorType = 'Room Sensor CO2';\r\n      }\r\n      \r\n      let sensorGroupConfig = {\r\n        name: [''],\r\n        type: [sensorType, [vm.validators.required]],\r\n      };\r\n    \r\n      if (\r\n          vm.editEntityFormGroup.get('general').get('type').value === 'Gateway' &&\r\n          vm.editEntityFormGroup.get('general').get('createKit').value &&\r\n          vm.editEntityFormGroup.get('general').get('addDevices').value &&\r\n          sensorType === 'Room Sensor CO2'\r\n        ) {\r\n          sensorGroupConfig['devEUI'] = ['', [vm.validators.required, vm.validators.pattern('[a-zA-Z0-9]{16}')]];\r\n          sensorGroupConfig['appKey'] = ['', [vm.validators.required, vm.validators.pattern('[a-zA-Z0-9]{32}')]];\r\n        }\r\n\r\n    \r\n      const newSensorGroup = vm.fb.group(sensorGroupConfig);\r\n      sensorDevicesArray.push(newSensorGroup);\r\n      updateSensorNames();\r\n    };\r\n\r\n  vm.removeSensor = function (index) {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      if (sensorDevicesArray.length > 0 && index >= 0) {\r\n        sensorDevicesArray.removeAt(index);\r\n\r\n        updateSensorNames();\r\n      }\r\n    };\r\n\r\n  vm.canRemoveSensor = function (index) {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      return (\r\n        sensorDevicesArray.length > 0 &&\r\n        index === sensorDevicesArray.length - 1\r\n      );\r\n    };\r\n\r\n\r\n  vm.onSensorTypeChange = function (index) {\r\n    const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices') ;\r\n    const sensorGroup = sensorDevicesArray.at(index);\r\n    const sensorType = sensorGroup.get('type').value;\r\n    const sensorName = constructSensorName(\r\n      vm.customerShortName,\r\n      vm.editEntityFormGroup.get('general').get('type').value,\r\n      vm.editEntityFormGroup.get('general').get('attributes').get('serialNumber')?.value || '',\r\n      vm.editEntityFormGroup.get('general').get('attributes').get('gatewayID')?.value || '',\r\n      index + 1,\r\n      sensorType\r\n    );\r\n    sensorGroup.get('name').setValue(sensorName);\r\n    \r\n     updateSensorNames();\r\n  };\r\n\r\n  vm.onTabChange = function (index) {\r\n    vm.selectedTabIndex = index;\r\n    vm.updateTabControls();\r\n  };\r\n\r\n  vm.updateTabControls = function () {\r\n    if (vm.selectedTabIndex === 0) {\r\n      vm.enableCreateTabControls();\r\n      vm.disableAssignTabControls();\r\n    } else if (vm.selectedTabIndex === 1) {\r\n      vm.enableAssignTabControls();\r\n      vm.disableCreateTabControls();\r\n    }\r\n  };\r\n\r\n  vm.enableCreateTabControls = function () {\r\n    vm.editEntityFormGroup.get('devices').get('pflowDevices').enable();\r\n    vm.editEntityFormGroup.get('devices').get('sensorDevices').enable();\r\n\r\n    updateEntityName();\r\n\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n   const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices') ;\r\n    \r\n    if (pflowDevicesArray.length === 0 && vm.editEntityFormGroup.get('general').get('type').value === 'RESI') {\r\n      vm.addPflow();\r\n    }\r\n    if (sensorDevicesArray.length === 0 && vm.editEntityFormGroup.get('general').get('type').value === 'Gateway') {\r\n        /*console.log(\"Hello 1\");*/\r\n      vm.addSensor();\r\n    }\r\n  };\r\n\r\n  vm.disableCreateTabControls = function () {\r\n    vm.editEntityFormGroup.get('devices').get('pflowDevices').disable();\r\n    vm.editEntityFormGroup.get('devices').get('sensorDevices').disable();\r\n    vm.editEntityFormGroup.get('devices').get('pflowDevices').reset();\r\n    vm.editEntityFormGroup.get('devices').get('sensorDevices').reset();\r\n  };\r\n\r\n  vm.enableAssignTabControls = function () {\r\n    vm.editEntityFormGroup.get('devices').get('assignmentStep').enable();\r\n  };\r\n\r\n  vm.disableAssignTabControls = function () {\r\n    vm.editEntityFormGroup.get('devices').get('assignmentStep').disable();\r\n    vm.editEntityFormGroup.get('devices').get('assignmentStep').reset();\r\n  };\r\n\r\n  vm.updateTabControls();\r\n\r\n  vm.showDevicesStep = false;\r\n  vm.availableDevices = [];\r\n  vm.pFlowDevices = [];\r\n  vm.sensorDevices = [];\r\n  vm.unassignedDevicesGroup = null;\r\n  vm.customerId = null;\r\n\r\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n    vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n  } else {\r\n    vm.customerId = {\r\n      id: widgetContext.currentUser.customerId,\r\n      entityType: 'CUSTOMER',\r\n    };\r\n  }\r\n\r\n  entityGroupService\r\n    .getEntityGroupsByOwnerId(\r\n      vm.customerId.entityType,\r\n      vm.customerId.id,\r\n      'DEVICE'\r\n    )\r\n    .subscribe((entityGroups) => {\r\n      vm.unassignedDevicesGroup = entityGroups.find(\r\n        (group) => group.name === 'Unassigned Diagnostickit Devices'\r\n      );\r\n      if (vm.unassignedDevicesGroup) {\r\n        var query = {\r\n          entityFilter: {\r\n            type: 'entityGroup',\r\n            groupType: 'DEVICE',\r\n            entityGroup: vm.unassignedDevicesGroup.id.id,\r\n          },\r\n          pageLink: {\r\n            pageSize: 100,\r\n            page: 0,\r\n          },\r\n          entityFields: [\r\n            { key: 'name', type: 'ENTITY_FIELD' },\r\n            { key: 'type', type: 'ENTITY_FIELD' },\r\n          ],\r\n        };\r\n        entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n          vm.availableDevices = data.data.map((entityData) => {\r\n            return {\r\n              deviceId: entityData.entityId,\r\n              name: entityData.latest['ENTITY_FIELD'].name.value,\r\n              type: entityData.latest['ENTITY_FIELD'].type.value,\r\n            };\r\n          });\r\n\r\n          vm.pFlowDevices = vm.availableDevices.filter(\r\n            (device) => device.type === 'P-Flow D116'\r\n          );\r\n          vm.sensorDevices = vm.availableDevices.filter(\r\n            (device) =>\r\n              device.type !== 'P-Flow D116' &&\r\n              device.type !== 'IoT Gateway' &&\r\n              device.type !== 'RESI' &&\r\n              device.type !== 'Gateway' &&\r\n              device.type !== 'MUC'\r\n          );\r\n          // Initialize the filtered list for assign fields.\r\n          // For example, if you have at least one assignment group already (default group):\r\n          if (\r\n            vm.editEntityFormGroup.get('devices').get('assignmentStep').get('devices')\r\n              .controls.length > 0\r\n          ) {\r\n            // For the first assign field (index 0)\r\n            let allPFlowDevices = vm.getAvailablePFlowDevices(0);\r\n            vm.filteredAssignDevices = {}; // ensure the object exists\r\n            vm.filteredAssignDevices[0] = allPFlowDevices.slice();\r\n          }\r\n          \r\n          if (\r\n              vm.editEntityFormGroup.get('devices').get('assignmentStep').get('sensors')\r\n                .controls.length > 0\r\n            ) {\r\n              // For the first sensor assign field (index 0)\r\n              let allSensors = vm.getAvailableSensorDevices(0);\r\n              vm.filteredAssignSensors = {}; // ensure the object exists\r\n              vm.filteredAssignSensors[0] = allSensors.slice();\r\n            }\r\n        });\r\n      }\r\n    });\r\n\r\n  vm.getAvailableSensorDevices = function (currentIndex) {\r\n    const assignSensorsArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('sensors').controls;\r\n    const selectedDevices = assignSensorsArray\r\n      .map((sensorGroup, index) =>\r\n        index !== currentIndex ? sensorGroup.get('device').value : null\r\n      )\r\n      .filter((device) => device !== null);\r\n\r\n    return vm.sensorDevices.filter(\r\n      (device) =>\r\n        !selectedDevices.some(\r\n          (selectedDevice) => device.name === selectedDevice.name\r\n        )\r\n    );\r\n  };\r\n\r\n  vm.getAvailablePFlowDevices = function (currentIndex) {\r\n    const assignDevicesArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('devices').controls;\r\n    const selectedDevices = assignDevicesArray\r\n      .map((deviceGroup, index) =>\r\n        index !== currentIndex ? deviceGroup.get('device').value : null\r\n      )\r\n      .filter((device) => device !== null);\r\n\r\n    return vm.pFlowDevices.filter(\r\n      (device) =>\r\n        !selectedDevices.some(\r\n          (selectedDevice) => device.name === selectedDevice.name\r\n        )\r\n    );\r\n  };\r\n\r\n  vm.onCreateKitChange = function (event) {\r\n    let createKitControl = event.checked;\r\n    if (!createKitControl) {\r\n      vm.editEntityFormGroup.get('general').get('newKit').setValue('');\r\n      vm.editEntityFormGroup.get('general').get('addDevices').setValue(false);\r\n      vm.showDevicesStep = false;\r\n    }\r\n  };\r\n\r\n  vm.onAddDevicesChange = function (event) {\r\n    const type = vm.editEntityFormGroup.get('general').get('type').value;\r\n    let addDevicesControl = event.checked;\r\n    vm.showDevicesStep = addDevicesControl;\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices');\r\n    const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n\r\n    if (addDevicesControl === true) {\r\n      if (pflowDevicesArray.length === 0 && type==='RESI') {\r\n        vm.addPflow();\r\n      }else if (type ==='Gateway'){\r\n        sensorDevicesArray.clear();\r\n        vm.addSensor();\r\n        pflowDevicesArray.clear();  \r\n      }\r\n    } else {\r\n      pflowDevicesArray.clear();\r\n      sensorDevicesArray.clear();\r\n    }\r\n  };\r\n\r\n  vm.addAssignDevice = function () {\r\n      const assignDevicesArray = vm.editEntityFormGroup.get('devices').get('assignmentStep').get('devices');\r\n      const newDeviceGroup = vm.fb.group({\r\n        device: [null, [vm.validators.required, deviceSelectionValidator]]\r\n      });\r\n      assignDevicesArray.push(newDeviceGroup);\r\n    };\r\n\r\n  vm.removeAssignDevice = function (index) {\r\n    const assignDevicesArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('devices') ;\r\n    if (\r\n      assignDevicesArray.length > 1 &&\r\n      index === assignDevicesArray.length - 1 &&\r\n      index > 0\r\n    ) {\r\n      assignDevicesArray.removeAt(index);\r\n    }\r\n  };\r\n\r\n  vm.canRemoveAssignDevice = function (index) {\r\n    const assignDevicesArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('devices') ;\r\n    return (\r\n      assignDevicesArray.length > 1 &&\r\n      index === assignDevicesArray.length - 1 &&\r\n      index > 0\r\n    );\r\n  };\r\n\r\n  vm.addAssignSensor = function () {\r\n      const assignSensorsArray = vm.editEntityFormGroup.get('devices').get('assignmentStep').get('sensors');\r\n      const newSensorGroup = vm.fb.group({\r\n        device: [null, [vm.validators.required, deviceSelectionValidator]]\r\n      });\r\n      assignSensorsArray.push(newSensorGroup);\r\n    \r\n      // Ensure the filtered sensor object exists\r\n      if (!vm.filteredAssignSensors) {\r\n        vm.filteredAssignSensors = {};\r\n      }\r\n      // Initialize the filtered sensors for the new index\r\n      const newIndex = assignSensorsArray.length - 1;\r\n      vm.filteredAssignSensors[newIndex] = vm.getAvailableSensorDevices(newIndex).slice();\r\n    };\r\n\r\n  vm.removeAssignSensor = function (index) {\r\n    const assignSensorsArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('sensors') ;\r\n    if (\r\n      assignSensorsArray.length > 0 &&\r\n      index >= 0\r\n    ) {\r\n      assignSensorsArray.removeAt(index);\r\n    }\r\n  };\r\n\r\n  vm.canRemoveAssignSensor = function (index) {\r\n    const assignSensorsArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('sensors') ;\r\n    return assignSensorsArray.length > 0 && index === assignSensorsArray.length -1;\r\n  };\r\n\r\n  vm.editEntityFormGroup\r\n    .get('general')\r\n    .get('entityName')\r\n    .valueChanges.subscribe((value) => {\r\n      vm.editEntityFormGroup.get('credentials').patchValue({\r\n        clientId: value,\r\n      });\r\n    });\r\n\r\n  updateControls();\r\n\r\n  function setupControlSubscriptions() {\r\n    vm.editEntityFormGroup\r\n      .get('general')\r\n      .get('entityName')\r\n      .valueChanges.subscribe((value) => {\r\n        vm.editEntityFormGroup.get('credentials').patchValue({\r\n          clientId: value,\r\n        });\r\n      });\r\n\r\n    const serialNumberControl = vm.editEntityFormGroup\r\n      .get('general')\r\n      .get('attributes')\r\n      .get('serialNumber');\r\n    if (serialNumberControl) {\r\n      serialNumberControl.valueChanges.subscribe(() => updateEntityName());\r\n    }\r\n\r\n    const gatewayIDControl = vm.editEntityFormGroup\r\n      .get('general')\r\n      .get('attributes')\r\n      .get('gatewayID');\r\n    if (gatewayIDControl) {\r\n      gatewayIDControl.valueChanges.subscribe(() => updateEntityName());\r\n    }\r\n\r\n    const typeControl = vm.editEntityFormGroup.get('general').get('type');\r\n    if (typeControl) {\r\n      typeControl.valueChanges.subscribe(() => {\r\n        updateEntityName();\r\n      });\r\n    }\r\n\r\n    const createKitControl = vm.editEntityFormGroup\r\n      .get('general')\r\n      .get('createKit');\r\n    if (createKitControl) {\r\n      createKitControl.valueChanges.subscribe(() => {\r\n        updateEntityName();\r\n      });\r\n    }\r\n  }\r\n\r\n  function updateControls() {\r\n    const type = vm.editEntityFormGroup.get('general').get('type').value;\r\n    const attributesGroup = vm.editEntityFormGroup.get('general').get('attributes');\r\n    const connectivityGroup = vm.editEntityFormGroup.get('general').get('connectivity');\r\n\r\n    if (type === 'Gateway') {\r\n      if (!attributesGroup.contains('gatewayID')) {\r\n        attributesGroup.addControl('gatewayID', vm.fb.control('', [vm.validators.required]));\r\n      }\r\n      if (attributesGroup.contains('serialNumber')) {\r\n        attributesGroup.removeControl('serialNumber');\r\n      }\r\n      vm.editEntityFormGroup.get('credentials').disable();\r\n    } else {\r\n      if (!attributesGroup.contains('serialNumber')) {\r\n        attributesGroup.addControl('serialNumber', vm.fb.control('', [vm.validators.required]));\r\n      }\r\n      if (attributesGroup.contains('gatewayID')) {\r\n        attributesGroup.removeControl('gatewayID');\r\n      }\r\n      vm.editEntityFormGroup.get('credentials').enable();\r\n    }\r\n    \r\n    if(vm.editEntityFormGroup.get('general').get('activateSIM').value === true) {\r\n        connectivityGroup.addControl('ICCID', vm.fb.control('', [vm.validators.required]));\r\n        connectivityGroup.addControl('carrierSIM', vm.fb.control('', [vm.validators.required]));\r\n        connectivityGroup.addControl('statusSIM', vm.fb.control('', [vm.validators.required]));\r\n    } else if(vm.editEntityFormGroup.get('general').get('activateSIM').value === false) {\r\n        connectivityGroup.removeControl('ICCID');\r\n        connectivityGroup.removeControl('carrierSIM');\r\n        connectivityGroup.removeControl('statusSIM');\r\n    }\r\n\r\n    setupControlSubscriptions();\r\n  }\r\n  \r\n  function updateSensorNames() {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      const sensorTypeCounts = {};\r\n    \r\n      for (let i = 0; i < sensorDevicesArray.length; i++) {\r\n        const sensorGroup = sensorDevicesArray.at(i);\r\n        const sensorType = sensorGroup.get('type').value;\r\n    \r\n        const countingType = (sensorType === 'Temperature Sensor' || sensorType === 'Room Sensor T') ? 'Temperature' : sensorType;\r\n    \r\n        if (!sensorTypeCounts[countingType]) {\r\n          sensorTypeCounts[countingType] = 1;\r\n        } else {\r\n          sensorTypeCounts[countingType] += 1;\r\n        }\r\n    \r\n        const sensorTypeIndex = sensorTypeCounts[countingType];\r\n    \r\n        const sensorName = constructSensorName(\r\n          vm.customerShortName,\r\n          vm.editEntityFormGroup.get('general').get('type').value,\r\n          vm.editEntityFormGroup.get('general').get('attributes').get('serialNumber')?.value || '',\r\n          vm.editEntityFormGroup.get('general').get('attributes').get('gatewayID')?.value || '',\r\n          sensorTypeIndex,\r\n          sensorType\r\n        );\r\n    \r\n        sensorGroup.get('name').setValue(sensorName);\r\n      }\r\n    }\r\n\r\n\r\n\r\n  function updateEntityName() {\r\n    const type = vm.editEntityFormGroup.get('general').get('type').value;\r\n    const serialNumber =\r\n      vm.editEntityFormGroup\r\n        .get('general')\r\n        .get('attributes')\r\n        .get('serialNumber')?.value || '';\r\n    const gatewayID =\r\n      vm.editEntityFormGroup\r\n        .get('general')\r\n        .get('attributes')\r\n        .get('gatewayID')?.value || '';\r\n    const customerShortName = vm.customerShortName || '';\r\n    const updatedDeviceName = constructDeviceName(\r\n      customerShortName,\r\n      type,\r\n      serialNumber,\r\n      gatewayID\r\n    );\r\n    vm.editEntityFormGroup.get('general').get('entityName').setValue(updatedDeviceName);\r\n\r\n    /*if (vm.editEntityFormGroup.get('general').get('createKit').value) {\r\n      const kitName = generateDiagnostickitName(type);\r\n      vm.editEntityFormGroup.get('general').get('newKit').setValue(kitName);\r\n    }*/\r\n\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n    for (let i = 0; i < pflowDevicesArray.length; i++) {\r\n      const pflowGroup = pflowDevicesArray.at(i);\r\n      const pflowName = constructBasicPflowName(\r\n        customerShortName,\r\n        type,\r\n        serialNumber,\r\n        gatewayID,\r\n        i + 1\r\n      );\r\n      pflowGroup.get('name').setValue(pflowName);\r\n    }\r\n\r\n    const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices') ;\r\n    for (let i = 0; i < sensorDevicesArray.length; i++) {\r\n      const sensorGroup = sensorDevicesArray.at(i);\r\n      const sensorType = sensorGroup.get('type').value;\r\n      const sensorName = constructSensorName(\r\n        customerShortName,\r\n        type,\r\n        serialNumber,\r\n        gatewayID,\r\n        i + 1,\r\n        sensorType\r\n      );\r\n      sensorGroup.get('name').setValue(sensorName);\r\n    }\r\n    \r\n    updateSensorNames();\r\n  }\r\n\r\n  attributeService\r\n    .getEntityAttributes(\r\n      { entityType: 'CUSTOMER', id: customerID },\r\n      'SERVER_SCOPE',\r\n      ['shortName']\r\n    )\r\n    .subscribe((attributes) => {\r\n      const shortNameAttr = attributes.find((attr) => attr.key === 'shortName');\r\n      vm.customerShortName = shortNameAttr\r\n        ? shortNameAttr.value\r\n        : generateCustomerShortName(customerName);\r\n      updateEntityName();\r\n    });\r\n\r\n  vm.editEntityFormGroup.get('general').get('type').valueChanges.subscribe(() => {\r\n    updateControls();\r\n    updateEntityName();\r\n  });\r\n  \r\n  vm.editEntityFormGroup.get('general').get('activateSIM').valueChanges.subscribe(() => {\r\n    updateControls();\r\n  });\r\n\r\n  setupControlSubscriptions();\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  vm.save = function () {\r\n    vm.editEntityFormGroup.markAsPristine();\r\n\r\n    var customer = widgetContext.stateController.getStateParams().entityId;\r\n    var formValues = vm.editEntityFormGroup.value;\r\n    var kit;\r\n\r\n    if (vm.editEntityFormGroup.get('general').get('createKit').value) {\r\n      saveDiagnostickitObservable(customer).subscribe(\r\n      function (Diagnostickit) {\r\n        kit = Diagnostickit;\r\n        let kitType;\r\n        switch (vm.editEntityFormGroup.get('general').get('type').value) {\r\n            case 'RESI':\r\n                kitType = \"basis\";\r\n                break;\r\n            case 'Gateway':\r\n                kitType = \"loraWan\";\r\n                break;\r\n            default:\r\n                kitType = \"basis\";\r\n                break;\r\n        }\r\n        let attribute = [{\r\n            key : \"kitType\",\r\n            value:kitType,\r\n        }];\r\n        /*console.log(\"kit\",kit);\r\n        console.log(\"kitType\",kitType);*/\r\n        \r\n        attributeService.saveEntityAttributes(kit.id,'SERVER_SCOPE',attribute).subscribe();\r\n        saveCustomerToDiagnostickitRelation(customer, Diagnostickit.id).subscribe();\r\n\r\n        if (vm.editEntityFormGroup.get('general').get('addDevices').value) {\r\n          if (vm.selectedTabIndex === 1) {\r\n            var devicesArray = vm.editEntityFormGroup\r\n              .get('devices')\r\n              .get('assignmentStep')\r\n              .get('devices').value;\r\n\r\n            var sensorsArray = vm.editEntityFormGroup\r\n              .get('devices')\r\n              .get('assignmentStep')\r\n              .get('sensors').value;\r\n\r\n            devicesArray = devicesArray.concat(sensorsArray);\r\n\r\n            assignExistingDevices(kit.id, devicesArray).subscribe(\r\n              function () {\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              },\r\n              function (error) {\r\n                widgetContext.dialogs.alert('Error assigning devices:', error.message);\r\n              }\r\n            );\r\n          } else if (vm.selectedTabIndex === 0) {\r\n            var pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices').value;\r\n\r\n            var pflowDevices = pflowDevicesArray.map(function (device) {\r\n              return { name: device.name, type: 'P-Flow D116' };\r\n            });\r\n\r\n            var sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices').value;\r\n            var sensorDevices = sensorDevicesArray.map(function (device) {\r\n              let sensor = { name: device.name, type: device.type };\r\n              if (device.type === 'Room Sensor CO2' && device.devEUI && device.appKey) {\r\n                sensor.devEUI = device.devEUI;\r\n                sensor.appKey = device.appKey;\r\n              }\r\n              return sensor;\r\n            });\r\n\r\n            var devicesToCreate = pflowDevices.concat(sensorDevices);\r\n\r\n            createAndAssignDevices(kit.id, devicesToCreate).subscribe(\r\n              function () {\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              },\r\n              function (error) {\r\n                widgetContext.dialogs.alert('Error creating and assigning devices:', error.message);\r\n              }\r\n            );\r\n          } else {\r\n            vm.dialogRef.close(null);\r\n          }\r\n        } else {\r\n          vm.dialogRef.close(null);\r\n        }\r\n      });\r\n    } else {\r\n      vm.dialogRef.close(null);\r\n    }\r\n\r\n    \r\n    function createAndAssignDevices(DiagnostickitId, devicesToCreate) {\r\n      var customerId = widgetContext.stateController.getStateParams().entityId;\r\n    \r\n      return getDiagnostickitDevicesGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap(function (DiagnostickitDevicesGroup) {\r\n        return getUnassignedDevicesGroupMeasurement(customerId).pipe(\r\n        widgetContext.rxjs.switchMap(function (unassignedDevicesGroupMeasurement) {\r\n          var observables = devicesToCreate.map(function (deviceInfo) {\r\n            return createDeviceObservable(customerId, DiagnostickitDevicesGroup,unassignedDevicesGroupMeasurement, deviceInfo).pipe(\r\n              widgetContext.rxjs.switchMap(function (savedDevice) {\r\n                return saveDeviceToDiagnostickitRelation(DiagnostickitId, savedDevice.id);\r\n              })\r\n            );\r\n          });\r\n    \r\n          return widgetContext.rxjs.forkJoin(observables);\r\n        })\r\n      );\r\n            \r\n        })\r\n      );\r\n    }\r\n    \r\n    function getDiagnostickitDevicesGroup(customerId) {\r\n      return entityGroupService\r\n        .getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE')\r\n        .pipe(\r\n          widgetContext.rxjs.switchMap(function (groups) {\r\n            return getOrCreateDevicesGroup(groups, 'Diagnostickit Devices', customerId);\r\n          })\r\n        );\r\n    }\r\n    function getUnassignedDevicesGroupMeasurement(customerId) {\r\n      return entityGroupService\r\n        .getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE')\r\n        .pipe(\r\n          widgetContext.rxjs.switchMap(function (groups) {\r\n            return getOrCreateDevicesGroup(groups, 'Unassigned Measurement Devices', customerId);\r\n          })\r\n        );\r\n    }\r\n\r\n\r\n    \r\n    function createDeviceObservable(customerId, DiagnostickitDevicesGroup,unassignedDevicesGroupMeasurement, deviceInfo) {\r\n      var device = {\r\n        name: deviceInfo.name,\r\n        type: deviceInfo.type,\r\n        customerId: customerId,\r\n      };\r\n    \r\n      return deviceService.saveDevice(device, DiagnostickitDevicesGroup.id.id).pipe(\r\n        widgetContext.rxjs.switchMap(function (savedDevice) {\r\n                if (deviceInfo.type === 'Room Sensor CO2' && deviceInfo.devEUI && deviceInfo.appKey) {\r\n                let attributesArray = [\r\n                  { key: 'devEui', value: deviceInfo.devEUI },\r\n                  { key: 'appKey', value: deviceInfo.appKey }\r\n                ];\r\n                return attributeService.saveEntityAttributes(savedDevice.id, 'SERVER_SCOPE', attributesArray).pipe(\r\n                  widgetContext.rxjs.map(() => savedDevice)\r\n                );\r\n              }\r\n            return entityGroupService\r\n              .addEntityToEntityGroup(unassignedDevicesGroupMeasurement.id.id, savedDevice.id.id)\r\n              .pipe(\r\n                widgetContext.rxjs.switchMap(() => {\r\n              return saveCustomerToDeviceRelation(customerId, savedDevice.id).pipe(\r\n                widgetContext.rxjs.map(function () {\r\n                  return savedDevice;\r\n                })\r\n              );\r\n            })\r\n          );\r\n        })\r\n      );\r\n    }\r\n\r\n    function updateSensorControls() {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      const isGateway = vm.editEntityFormGroup.get('general').get('type').value === 'Gateway';\r\n      const createKit = vm.editEntityFormGroup.get('general').get('createKit').value;\r\n      const addDevices = vm.editEntityFormGroup.get('general').get('addDevices').value;\r\n      \r\n      sensorDevicesArray.controls.forEach(sensorGroup => {\r\n        // Only for Room Sensor CO2 sensors\r\n        if (sensorGroup.get('type').value === 'Room Sensor CO2') {\r\n          if (isGateway && createKit && addDevices) {\r\n            // Add extra controls if missing\r\n            if (!sensorGroup.contains('devEUI')) {\r\n              sensorGroup.addControl('devEUI', vm.fb.control(''));\r\n            }\r\n            if (!sensorGroup.contains('appKey')) {\r\n              sensorGroup.addControl('appKey', vm.fb.control(''));\r\n            }\r\n          } else {\r\n            // Remove extra controls if present\r\n            if (sensorGroup.contains('devEUI')) {\r\n              sensorGroup.removeControl('devEUI');\r\n            }\r\n            if (sensorGroup.contains('appKey')) {\r\n              sensorGroup.removeControl('appKey');\r\n            }\r\n          }\r\n        } else {\r\n          // For any sensor that isn’t a Room Sensor CO2, remove extra controls if they exist.\r\n          if (sensorGroup.contains('devEUI')) {\r\n            sensorGroup.removeControl('devEUI');\r\n          }\r\n          if (sensorGroup.contains('appKey')) {\r\n            sensorGroup.removeControl('appKey');\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n\r\n    \r\n    function assignExistingDevices(DiagnostickitId, devicesArray) {\r\n        var observables = [];\r\n        devicesArray.forEach((deviceGroup) => {\r\n            if (deviceGroup.device) {\r\n                var deviceId = deviceGroup.device.deviceId;\r\n                observables.push(\r\n                    widgetContext.rxjs.forkJoin([\r\n                        entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n                        saveDeviceToDiagnostickitRelation(DiagnostickitId, deviceId)\r\n                    ])\r\n                );\r\n            } else {\r\n                var deviceId = deviceGroup.deviceId;\r\n                observables.push(\r\n                    widgetContext.rxjs.forkJoin([\r\n                        entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n                        saveDeviceToDiagnostickitRelation(DiagnostickitId, deviceId)\r\n                    ])\r\n                );\r\n            }\r\n        });\r\n        return widgetContext.rxjs.forkJoin(observables);\r\n    }\r\n    \r\n    function saveDeviceToDiagnostickitRelation(DiagnostickitId, deviceId) {\r\n        var relation = {\r\n            from: DiagnostickitId,\r\n            to: deviceId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Contains'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function saveDiagnostickitObservable(customer) {\r\n        return getDiagnostickitsGroup(customer).pipe(\r\n            widgetContext.rxjs.switchMap((DiagnostickitsGroup) => {\r\n                const formValues = vm.editEntityFormGroup.value;\r\n                const Diagnostickit = {\r\n                    name: formValues.general.newKit,\r\n                    type: 'Diagnostickit',\r\n                    customerId: customer\r\n                };\r\n                /*console.log(\"kit:\", Diagnostickit);*/\r\n    \r\n                return assetService.saveAsset(Diagnostickit, DiagnostickitsGroup.id.id).pipe(\r\n                    widgetContext.rxjs.switchMap((savedAsset) => {\r\n                        //console.log(\"saved asset:\", savedAsset);\r\n                        return widgetContext.rxjs.of(savedAsset);\r\n                    })\r\n                );\r\n            })\r\n        );\r\n    }\r\n    \r\n    try {\r\n      getTargetDeviceGroups(customer)\r\n        .pipe(\r\n          widgetContext.rxjs.switchMap((targetDevicesGroup) => {\r\n            var DiagnostickitDevicesGroup = targetDevicesGroup[0];\r\n            var unassignedDevicesGroupMeasurement= targetDevicesGroup[1];\r\n            var unassignedDevicesGroupKit = targetDevicesGroup[2];\r\n            var Gateways = targetDevicesGroup[3];\r\n            \r\n            if(vm.editEntityFormGroup.get('general').get('createKit').value) {\r\n                return saveEntityObservableKit(\r\n                  customer,\r\n                  DiagnostickitDevicesGroup,\r\n                  unassignedDevicesGroupMeasurement,\r\n                  Gateways\r\n            );\r\n            } else {\r\n                return saveEntityObservable(\r\n                  customer,\r\n                  DiagnostickitDevicesGroup,\r\n                  unassignedDevicesGroupMeasurement,\r\n                  unassignedDevicesGroupKit,\r\n                  Gateways\r\n                );\r\n            }\r\n          })\r\n        )\r\n        .subscribe(gateway =>{\r\n            \r\n            if(vm.editEntityFormGroup.get('general').get('createKit').value) {\r\n                saveDeviceToDiagnostickitRelation(kit.id, gateway.id).subscribe();\r\n            }\r\n            \r\n            saveCustomerToDeviceRelation(customer, gateway.id).subscribe();\r\n            saveAttributes(gateway.id).subscribe();\r\n            \r\n            if (vm.editEntityFormGroup.get('general').get('type').value !== 'Gateway') {\r\n            updateCredentials(gateway.id).subscribe(\r\n              () => {\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              },\r\n              (error) => {\r\n                widgetContext.dialogs.alert('Error updating credentials:', error.message);\r\n              }\r\n            );\r\n          } else {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n          }\r\n        });\r\n        \r\n    } catch (error) {\r\n      widgetContext.dialogs.alert('Unexpected error:', error.message);\r\n    }\r\n    \r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  function getDiagnostickitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var DiagnostickitsGroup = entityGroups.find(group => group.name === 'Diagnostickits');\r\n              if (DiagnostickitsGroup) {\r\n                  return widgetContext.rxjs.of(DiagnostickitsGroup);\r\n              } else {\r\n                  DiagnostickitsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Diagnostickits',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(DiagnostickitsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  \r\n  function getUnassignedKitGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n              if (UnassignedKitGroup) {\r\n                  return widgetContext.rxjs.of(UnassignedKitGroup);\r\n              } else {\r\n                  UnassignedKitGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Unassigned Kit',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  \r\n function saveCustomerToDiagnostickitRelation(customerId, DiagnostickitId) {\r\n    var relation = {\r\n        from: customerId,\r\n        to: DiagnostickitId,\r\n        typeGroup: 'COMMON',\r\n        type: 'Owns'\r\n    };\r\n    //console.log(\"Initiating save relation with payload:\", relation);\r\n\r\n    return entityRelationService.saveRelation(relation).pipe(\r\n        widgetContext.rxjs.tap({\r\n            next: (response) => {\r\n                //console.log(\"Successfully saved relation:\", response);\r\n            },\r\n            error: (error) => {\r\n                console.error(\"Error occurred while saving relation:\", error);\r\n            },\r\n        }),\r\n        widgetContext.rxjs.catchError((error) => {\r\n            console.error(\"Caught error while saving relation:\", error);\r\n            return widgetContext.rxjs.throwError(() => new Error(`Failed to save relation: ${error.message}`));\r\n        })\r\n    );\r\n}\r\n\r\nfunction saveCustomerToDeviceRelation(customerId, DeviceId) {\r\n    var relation = {\r\n        from: customerId,\r\n        to: DeviceId,\r\n        typeGroup: 'COMMON',\r\n        type: 'Contains'\r\n    };\r\n    //console.log(\"Initiating save relation with payload:\", relation);\r\n\r\n    return entityRelationService.saveRelation(relation).pipe(\r\n        widgetContext.rxjs.tap({\r\n            next: (response) => {\r\n                //console.log(\"Successfully saved relation:\", response);\r\n            },\r\n            error: (error) => {\r\n                console.error(\"Error occurred while saving relation:\", error);\r\n            },\r\n        }),\r\n        widgetContext.rxjs.catchError((error) => {\r\n            console.error(\"Caught error while saving relation:\", error);\r\n            return widgetContext.rxjs.throwError(() => new Error(`Failed to save relation: ${error.message}`));\r\n        })\r\n    );\r\n}\r\n\r\n\r\n\r\n  vm.copyToClipboard = function (event, controlName) {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const value = vm.editEntityFormGroup.get(controlName.split('.')).value;\r\n    navigator.clipboard.writeText(value).then(() => {\r\n      widgetContext.showSuccessToast(\r\n        'Copied to clipboard!',\r\n        2000,\r\n        'top',\r\n        'center'\r\n      );\r\n    }).catch((err) => {\r\n      widgetContext.showErrorToast(\r\n        'Failed to copy to clipboard.',\r\n        2000,\r\n        'top',\r\n        'center'\r\n      );\r\n    });\r\n  };\r\n\r\n  vm.onDeviceTypeChange = function (stepper) {\r\n     let pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n    let sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n    let assignSensorsArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('sensors');\r\n    let assignDevicesArray = vm.editEntityFormGroup\r\n          .get('devices')\r\n          .get('assignmentStep')\r\n          .get('devices');\r\n    const type = vm.editEntityFormGroup.get('general').get('type').value;\r\n    /*console.log(pflowDevicesArray);*/\r\n    \r\n    if (type === 'Gateway') {\r\n      vm.editEntityFormGroup.get('credentials').disable();\r\n        pflowDevicesArray.clear();\r\n        sensorDevicesArray.clear();\r\n        assignSensorsArray.clear();\r\n        assignDevicesArray.clear();\r\n      /*stepper.selectedIndex = 0;*/\r\n    } else {\r\n      vm.editEntityFormGroup.get('credentials').enable();\r\n      /*if (stepper.selectedIndex === 0) {\r\n        stepper.selectedIndex = 1;\r\n      }*/\r\n      sensorDevicesArray.clear();\r\n      assignSensorsArray.clear();\r\n      assignDevicesArray.clear();\r\n    }\r\n    /*console.log(pflowDevicesArray);*/\r\n  };\r\n\r\n  vm.editEntityFormGroup.get('general').get('type').valueChanges.subscribe((type) => {\r\n    if (type === 'Gateway') {\r\n      vm.editEntityFormGroup.get('credentials').disable();\r\n    } else {\r\n      vm.editEntityFormGroup.get('credentials').enable();\r\n    }\r\n  });\r\n\r\n  vm.hidePassword = true;\r\n\r\n  vm.togglePasswordVisibility = function () {\r\n    vm.hidePassword = !vm.hidePassword;\r\n  };\r\n\r\n  function getTargetDeviceGroups(customerId) {\r\n    return entityGroupService\r\n      .getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE')\r\n      .pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          return widgetContext.rxjs.forkJoin([\r\n            getOrCreateDevicesGroup(groups, 'Diagnostickit Devices', customerId),\r\n            getOrCreateDevicesGroup(groups, 'Unassigned Measurement Devices', customerId),\r\n            getOrCreateDevicesGroup(groups, 'Unassigned Diagnostickit Devices', customerId),\r\n            getOrCreateDevicesGroup(groups, 'Gateways', customerId),\r\n          ]);\r\n        })\r\n      );\r\n  }\r\n\r\n  function getOrCreateDevicesGroup(groups, groupName, customerId) {\r\n    var devicesGroup = groups.find((group) => group.name === groupName);\r\n    if (devicesGroup) {\r\n      return widgetContext.rxjs.of(devicesGroup);\r\n    } else {\r\n      devicesGroup = {\r\n        type: 'DEVICE',\r\n        name: groupName,\r\n        ownerId: customerId,\r\n      };\r\n      return entityGroupService.saveEntityGroup(devicesGroup);\r\n    }\r\n  }\r\n\r\n  function saveEntityObservable(customerId, DiagnostickitDevicesGroup,unassignedDevicesGroupMeasurement, unassignedDevicesGroup, Gateways) {\r\n    const formValues = vm.editEntityFormGroup.get('general').value;\r\n    let entity = {\r\n      name: formValues.entityName,\r\n      type: formValues.type,\r\n      label: formValues.entityLabel,\r\n      customerId: customerId,\r\n    };\r\n\r\n    return deviceService.saveDevice(entity, unassignedDevicesGroup.id.id).pipe(\r\n      widgetContext.rxjs.switchMap((savedDevice) => {\r\n        return entityGroupService\r\n          .addEntityToEntityGroup(DiagnostickitDevicesGroup.id.id, savedDevice.id.id)\r\n          .pipe(\r\n            widgetContext.rxjs.switchMap(() => { \r\n            return entityGroupService\r\n              .addEntityToEntityGroup(unassignedDevicesGroupMeasurement.id.id, savedDevice.id.id)\r\n              .pipe(\r\n                widgetContext.rxjs.switchMap(() => {\r\n                  return entityGroupService\r\n                    .addEntityToEntityGroup(Gateways.id.id, savedDevice.id.id)\r\n                    .pipe(\r\n                      widgetContext.rxjs.map(() => {\r\n                        return savedDevice;\r\n                      })\r\n                    );\r\n                })\r\n              );\r\n            })\r\n          );\r\n      })\r\n    );\r\n  }\r\n\r\nfunction saveEntityObservableKit(customerId, DiagnostickitDevicesGroup,unassignedDevicesGroupMeasurement, Gateways) {\r\n    const formValues = vm.editEntityFormGroup.get('general').value;\r\n    let entity = {\r\n      name: formValues.entityName,\r\n      type: formValues.type,\r\n      label: formValues.entityLabel,\r\n      customerId: customerId,\r\n    };\r\n\r\n    return deviceService.saveDevice(entity).pipe(\r\n      widgetContext.rxjs.switchMap((savedDevice) => {\r\n        return entityGroupService\r\n          .addEntityToEntityGroup(DiagnostickitDevicesGroup.id.id, savedDevice.id.id)\r\n          .pipe(\r\n            widgetContext.rxjs.switchMap(() => {\r\n            return entityGroupService\r\n          .addEntityToEntityGroup(unassignedDevicesGroupMeasurement.id.id, savedDevice.id.id)\r\n          .pipe(\r\n            widgetContext.rxjs.switchMap(() => {\r\n              return entityGroupService\r\n                .addEntityToEntityGroup(Gateways.id.id, savedDevice.id.id)\r\n                .pipe(\r\n                  widgetContext.rxjs.map(() => {\r\n                    return savedDevice;\r\n                  })\r\n                );\r\n            })\r\n          );\r\n            })\r\n          );\r\n      })\r\n    );\r\n  }\r\n  \r\n  function constructDeviceName(customerShortName, type, serialNumber = '', gatewayID = '') {\r\n    return type === 'Gateway'\r\n      ? `ECO_${gatewayID}_gw`\r\n      : `ECO_${serialNumber}_gw`;\r\n  }\r\n\r\n  function constructBasicPflowName(customerShortName, type, serialNumber = '', gatewayID = '', index = '') {\r\n    return type === 'Gateway'\r\n      ? `ECO_${gatewayID}_PF${index}`\r\n      : `ECO_${serialNumber}_PF${index}`;\r\n  }\r\n\r\n  /*function constructKitName(customerShortName, type, serialNumber = '', gatewayID = '') {\r\n    return type === 'Gateway'\r\n      ? `${customerShortName}_${gatewayID}_Kit`\r\n      : `${customerShortName}_${serialNumber}_Kit`;\r\n  }*/\r\n  /*function generateDiagnostickitName(kitType) {\r\n  // Current 2-digit year\r\n  const year = (new Date().getFullYear() % 100).toString().padStart(2, '0');\r\n  // Prefix depends on kitType\r\n  const prefix = kitType === 'basis' ? 'DBKIT' : 'DEKIT';\r\n\r\n  // Pattern to match, ignoring the year for the counter:\r\n  // e.g. DBKITxxEU-0001 or DEKITxxEU-0001\r\n  // where \"xx\" can be any 2-digit year\r\n  const pattern = new RegExp(`^${prefix}\\\\d{2}EU-(\\\\d{4})$`);\r\n\r\n  // Find the maximum counter among all matching kits\r\n  let maxNumber = 0;\r\n  diagnostickitsAll.forEach(d => {\r\n    const match = d.name.match(pattern);\r\n    if (match) {\r\n      const currentNum = parseInt(match[1], 10);\r\n      if (currentNum > maxNumber) {\r\n        maxNumber = currentNum;\r\n      }\r\n    }\r\n  });\r\n\r\n  // Next counter (increment by 1)\r\n  const nextNumber = (maxNumber + 1).toString().padStart(4, '0');\r\n\r\n  // Construct new name with current year (but counter won't reset per year)\r\n  return `${prefix}${year}EU-${nextNumber}`;\r\n}\r\n  */\r\n  function constructSensorName(customerShortName, type, serialNumber = '', gatewayID = '', index = '', sensorType = 'Temperature Sensor') {\r\n      const sensorTypeShort = sensorType === 'Temperature Sensor' || sensorType === 'Room Sensor T' ? 'TS' :\r\n                              sensorType === 'Room Sensor CO2' ? 'CO2_' :\r\n                              'Sensor';\r\n    \r\n      return type === 'Gateway'\r\n        ? `ECO_${gatewayID}_${sensorTypeShort}${index}`\r\n        : `ECO_${serialNumber}_${sensorTypeShort}${index}`;\r\n    }\r\n\r\n\r\n\r\n  function generateCustomerShortName(customerName) {\r\n    if (!customerName) return '';\r\n    return customerName\r\n      .split(' ')\r\n      .map((word) => word[0].toUpperCase())\r\n      .join('');\r\n  }\r\n\r\n  function updateCredentials(entityId) {\r\n    return deviceService.getDeviceCredentials(entityId.id).pipe(\r\n      widgetContext.rxjs.mergeMap((existingCredentials) => {\r\n        let credentials = vm.editEntityFormGroup.get('credentials').value;\r\n        let deviceCredentials = {\r\n          id: existingCredentials.id,\r\n          deviceId: existingCredentials.deviceId,\r\n          credentialsType: credentials.credentialsType,\r\n          credentialsValue: JSON.stringify({\r\n            clientId: credentials.clientId,\r\n            userName: credentials.userName,\r\n            password: credentials.password,\r\n          }),\r\n        };\r\n        return deviceService.saveDeviceCredentials(deviceCredentials);\r\n      }),\r\n      widgetContext.rxjs.catchError((error) => {\r\n        widgetContext.showErrorToast(\r\n          `Failed to update credentials: ${error.message}`,\r\n          4000,\r\n          'top',\r\n          'center'\r\n        );\r\n        return widgetContext.rxjs.throwError(error);\r\n      })\r\n    );\r\n  }\r\n\r\n function saveAttributes(entityId) {\r\n     \r\n     /*console.log(\"entityId:\", entityId);*/\r\n      let attributes = vm.editEntityFormGroup.get('general').get('attributes').value;\r\n      let attributesArray = [];\r\n    \r\n      attributes.inactivityTimeout *= 60000;\r\n    \r\n      for (let key in attributes) {\r\n        if (attributes[key] !== null && attributes[key] !== '') {\r\n          attributesArray.push({\r\n            key: key,\r\n            value: attributes[key],\r\n          });\r\n        }\r\n      }\r\n    \r\n      if (vm.editEntityFormGroup.get('general').get('activateSIM').value) {\r\n        var connectivityValues = vm.editEntityFormGroup.get('general').get('connectivity').value;\r\n        var connectivityAttr = {\r\n          key: \"connectivity\",\r\n          value: {\r\n            \"carrier\": connectivityValues.carrierSIM,\r\n            \"ICCID\": connectivityValues.ICCID,\r\n            \"simStatus\": connectivityValues.statusSIM,\r\n          }\r\n        };\r\n    \r\n        attributesArray.push(connectivityAttr);\r\n      }\r\n      var kitAttr = {\r\n            key: 'diagnostickit',\r\n            value: vm.editEntityFormGroup.get('general').get('newKit').value\r\n        }\r\n    \r\n      attributesArray.push(kitAttr);\r\n      if (attributesArray.length > 0) {\r\n        return attributeService.saveEntityAttributes(\r\n          entityId,\r\n          'SERVER_SCOPE',\r\n          attributesArray\r\n        ).pipe(\r\n          widgetContext.rxjs.tap(() => {\r\n            /*console.log('Attributes saved successfully.');*/\r\n          }),\r\n          widgetContext.rxjs.catchError((error) => {\r\n            console.error('Error saving attributes:', error);\r\n            return widgetContext.rxjs.throwError(error);\r\n          })\r\n        );\r\n      } else {\r\n        return widgetContext.rxjs.of([]);\r\n      }\r\n    }\r\n\r\n\r\n\r\n  function saveRelations(entityId) {\r\n    let relations = vm.editEntityFormGroup.get('relations').value;\r\n    let tasks = [];\r\n    for (let i = 0; i < relations.length; i++) {\r\n      let relation = {\r\n        type: relations[i].relationType,\r\n        typeGroup: 'COMMON',\r\n      };\r\n      if (relations[i].direction == 'FROM') {\r\n        relation.to = relations[i].relatedEntity;\r\n        relation.from = entityId;\r\n      } else {\r\n        relation.to = entityId;\r\n        relation.from = relations[i].relatedEntity;\r\n      }\r\n      tasks.push(entityRelationService.saveRelation(relation));\r\n    }\r\n    if (tasks.length > 0) {\r\n      return widgetContext.rxjs.forkJoin(tasks);\r\n    }\r\n    return widgetContext.rxjs.of([]);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "dd13ad24-5569-02a3-b26d-446d9e9d436b"
              }
            ],
            "actionCellButton": [
              {
                "name": "{i18n:custom.gateways.edit-gateway}",
                "icon": "edit",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"editDeviceFormGroup\" (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 500px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.gateways.edit-gateway' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <mat-horizontal-stepper [linear]=\"true\" #stepper style=\"flex-grow: 1;\">\r\n        \r\n      <mat-step [stepControl]=\"editDeviceFormGroup.get('gatewayDetails')\">\r\n        <ng-template matStepLabel>Gateway</ng-template>\r\n        <div class=\"flex flex-col justify-start items-stretch flex-grow\" [formGroup]=\"editDeviceFormGroup.get('gatewayDetails')\">\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Name</mat-label>\r\n            <input matInput formControlName=\"name\" required readonly>\r\n            <mat-error *ngIf=\"editDeviceFormGroup.get('gatewayDetails.name').hasError('required')\">\r\n              {{ 'custom.devices.device-name-is-required' | translate }}\r\n            </mat-error>\r\n          </mat-form-field>\r\n          <!--<mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Type</mat-label>\r\n            <mat-select formControlName=\"type\" required>\r\n              <mat-option *ngFor=\"let type of deviceTypes\" [value]=\"type\">\r\n                {{ type }}\r\n              </mat-option>\r\n            </mat-select>\r\n            <mat-error *ngIf=\"editDeviceFormGroup.get('gatewayDetails.type').hasError('required')\">\r\n              Device type is required.\r\n            </mat-error>\r\n          </mat-form-field>-->\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Label</mat-label>\r\n            <input matInput formControlName=\"label\">\r\n          </mat-form-field>\r\n          <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n              <button mat-button mat-raised-button color=\"primary\" matStepperNext type=\"button\">\r\n                {{ 'custom.gateways.edit-gateway-next' | translate }}\r\n              </button>\r\n            </div>\r\n        </div>\r\n      </mat-step>\r\n      \r\n      <mat-step [stepControl]=\"editDeviceFormGroup.get('simDetails')\">\r\n        <div class=\"flex flex-col justify-start items-stretch flex-grow\" [formGroup]=\"editDeviceFormGroup.get('simDetails')\">\r\n          <ng-template matStepLabel>{{ 'custom.gateways.edit-gateway-sim-card' | translate }}</ng-template>\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>ICCID</mat-label>\r\n            <input matInput formControlName=\"ICCID\">\r\n          </mat-form-field>\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Carrier</mat-label>\r\n            <mat-select formControlName=\"carrierSIM\">\r\n              <mat-option value=\"tech+\">wherever SIM tech+</mat-option>\r\n              <mat-option value=\"link+\">wherever SIM link+</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>SIM Status</mat-label>\r\n            <mat-select formControlName=\"statusSIM\">\r\n              <mat-option [value]=\"2\">{{ 'custom.gateways.edit-gateway-activate' | translate }}</mat-option>\r\n              <mat-option [value]=\"5\">{{ 'custom.gateways.edit-gateway-deactivate' | translate }}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n              <button mat-button mat-raised-button color=\"primary\" matStepperNext type=\"button\">\r\n                {{ 'custom.gateways.edit-gateway-next' | translate }}\r\n              </button>\r\n            </div>\r\n        </div>\r\n      </mat-step>\r\n      \r\n      <mat-step [stepControl]=\"editDeviceFormGroup.get('credentialsDetails')\">\r\n        <div class=\"flex flex-col justify-start items-stretch flex-grow\" [formGroup]=\"editDeviceFormGroup.get('credentialsDetails')\">\r\n          <ng-template matStepLabel>{{ 'custom.gateways.edit-gateway-credentials' | translate }}</ng-template>\r\n          \r\n          <!-- MQTT_BASIC Fields -->\r\n          <div *ngIf=\"editDeviceFormGroup.get('credentialsDetails').get('credentialsType').value === 'MQTT_BASIC'\">\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>Client ID</mat-label>\r\n                <input matInput formControlName=\"clientId\" required />\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"{{ 'custom.gateways.edit-gateway-copy-client-id' | translate }}\" (click)=\"copyToClipboard($event, 'credentialsDetails.clientId')\">\r\n                  <mat-icon>content_copy</mat-icon>\r\n                </button>\r\n                <mat-error *ngIf=\"editDeviceFormGroup.get('credentialsDetails.clientId').hasError('required')\">{{ 'integration.client-id-required' | translate }}</mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>{{ 'custom.gateways.edit-gateway-user-name' | translate }}</mat-label>\r\n                <input matInput formControlName=\"userName\" required />\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"{{ 'custom.gateways.edit-gateway-copy-user-name' | translate }}\" (click)=\"copyToClipboard($event, 'credentialsDetails.userName')\">\r\n                  <mat-icon>content_copy</mat-icon>\r\n                </button>\r\n                <mat-error *ngIf=\"editDeviceFormGroup.get('credentialsDetails.userName').hasError('required')\">{{ 'device.user-name-required' | translate }}</mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>{{ 'custom.gateways.edit-gateway-password' | translate }}</mat-label>\r\n                <input matInput [type]=\"hidePassword ? 'password' : 'text'\" formControlName=\"password\" readonly/>\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"{{ hidePassword ? ('custom.gateways.edit-gateway-show-password' | translate) : 'Hide Password' }}\" (click)=\"togglePasswordVisibility()\">\r\n                    <mat-icon>{{ hidePassword ? 'visibility' : 'visibility_off' }}</mat-icon>\r\n                </button>\r\n                <button mat-icon-button type=\"button\" matSuffix [matTooltip]=\"'custom.gateways.edit-gateway-copy-password' | translate\" (click)=\"copyToClipboard($event, 'credentialsDetails.password')\">\r\n                    <mat-icon>content_copy</mat-icon>\r\n                </button>\r\n                <button mat-icon-button type=\"button\" matSuffix [matTooltip]=\"'custom.gateways.edit-gateway-generate-new-password' | translate\" (click)=\"generatePassword()\">\r\n                    <mat-icon>autorenew</mat-icon>\r\n                  </button>\r\n              </mat-form-field>\r\n          </div>\r\n          \r\n          <!-- ACCESS_TOKEN Fields -->\r\n          <div *ngIf=\"editDeviceFormGroup.get('credentialsDetails').get('credentialsType').value === 'ACCESS_TOKEN'\">\r\n            <div class=\"flex flex-col justify-evenly items-stretch flex-auto w-full h-full\">\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>Credentials ID</mat-label>\r\n                <input matInput formControlName=\"credentialsId\" required>\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"Copy Credentials ID\" (click)=\"copyToClipboard($event, 'credentialsDetails.credentialsId')\">\r\n                    <mat-icon>content_copy</mat-icon>\r\n                </button>\r\n                <mat-error *ngIf=\"editDeviceFormGroup.get('credentialsDetails.credentialsId').hasError('required')\">\r\n                    {{ 'custom.retrofit-companies.add-company-credentials-id-is-required' | translate }}\r\n                </mat-error>\r\n              </mat-form-field>\r\n              <br>\r\n            </div>\r\n          </div>\r\n          \r\n          <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n              <button mat-button matStepperPrevious type=\"button\"> {{ 'custom.gateways.edit-gateway-back' | translate }}</button>\r\n              <button mat-button mat-raised-button color=\"primary\" type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || editDeviceFormGroup.invalid || !editDeviceFormGroup.dirty\">\r\n                {{ 'custom.gateways.edit-gateway-update-device' | translate }}\r\n              </button>\r\n            </div>\r\n        </div>\r\n      </mat-step>\r\n      \r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>\r\n",
                "customCss": "\n.device-item {\n    line-height: 24px;\n    width: 100%;\n    padding-top: 8px;\n    padding-bottom: 8px;\n}\n\n.device-item .device-name {\n    font-size: 12px;\n    opacity: 0.7;\n}\n\n.device-item .device-type {\n    font-size: 14px;\n    opacity: 0.7;\n}\n\nmat-option {\n    height: auto !important;\n    white-space: normal !important;\n}\n\n.mat-select-value-text {\n    display: block;\n    width: 100%;\n}\n\n/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\n\r\nconst { mergeMap, of } = widgetContext.rxjs;\r\n\r\nopenEditDeviceDialog();\r\n\r\nfunction openEditDeviceDialog() {\r\n  customDialog.customDialog(htmlTemplate, EditDeviceDialogController).subscribe();\r\n}\r\n\r\nfunction EditDeviceDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.deviceTypes = [\r\n      'MUC',\r\n      'LoRaWAN Gateway',\r\n      'IoT Gateway',\r\n      'RESI'\r\n  ];\r\n\r\n  vm.device = {};\r\n  vm.credentials = {};\r\n  vm.hidePassword = true;\r\n\r\n  vm.editDeviceFormGroup = vm.fb.group({\r\n    gatewayDetails: vm.fb.group({\r\n      name: ['', [vm.validators.required]],\r\n      type: ['', [vm.validators.required]],\r\n      label: ['']\r\n    }),\r\n    simDetails: vm.fb.group({\r\n      ICCID: [''],\r\n      statusSIM: [''],\r\n      carrierSIM: ['']\r\n    }),\r\n    credentialsDetails: vm.fb.group({\r\n      clientId:[''],\r\n      userName:[''],\r\n      password: [''],\r\n      credentialsId:[''],\r\n      credentialsType:['']\r\n    })\r\n  });\r\n\r\n  getDevice();\r\n\r\n  vm.cancel = function() {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  vm.save = function() {\r\n    saveDevice().pipe(\r\n      mergeMap(() => {\r\n        if (vm.editDeviceFormGroup.get('credentialsDetails').dirty) {\r\n          return updateDeviceCredentials(vm.device.id);\r\n        }\r\n        return of(null);\r\n      })\r\n    ).subscribe(\r\n      function () {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n      },\r\n      function (error) {\r\n        console.error('Failed to save device or credentials:', error);\r\n        widgetContext.showErrorToast(`Failed to save device or credentials: ${error.message}`, 4000, 'top', 'center');\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.copyToClipboard = function (event, controlName) {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const value = vm.editDeviceFormGroup.get(controlName.split('.')).value;\r\n    navigator.clipboard.writeText(value).then(() => {\r\n      widgetContext.showSuccessToast(\r\n        'Copied to clipboard!',\r\n        2000,\r\n        'top',\r\n        'center'\r\n      );\r\n    }).catch((err) => {\r\n      widgetContext.showErrorToast(\r\n        'Failed to copy to clipboard.',\r\n        2000,\r\n        'top',\r\n        'center'\r\n      );\r\n    });\r\n  };\r\n\r\n  vm.togglePasswordVisibility = function () {\r\n    vm.hidePassword = !vm.hidePassword;\r\n  };\r\n\r\n  vm.generatePassword = function() {\r\n    const newPassword = generatePassword();\r\n    vm.editDeviceFormGroup.get('credentialsDetails.password').setValue(newPassword);\r\n    vm.editDeviceFormGroup.get('credentialsDetails').markAsDirty(); \r\n  };\r\n\r\n  function generatePassword() {\r\n    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\r\n    let password = '';\r\n    for (let i = 0; i < 20; i++) {\r\n      password += chars.charAt(Math.floor(Math.random() * chars.length));\r\n    }\r\n    return password;\r\n  }\r\n\r\n  function getDevice() {\r\n    deviceService.getDevice(entityId.id).subscribe(\r\n      function (device) {\r\n        vm.device = device;\r\n        attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE', ['connectivity']).subscribe(\r\n          function (attributes) {\r\n            if (attributes && attributes.length > 0) {\r\n              const connectivity = attributes.find(attr => attr.key === 'connectivity').value;\r\n              vm.editDeviceFormGroup.get('simDetails').patchValue({\r\n                ICCID: connectivity.ICCID,\r\n                carrierSIM: connectivity.carrier,\r\n                statusSIM: connectivity.simStatus\r\n              });\r\n            }\r\n\r\n            vm.editDeviceFormGroup.get('gatewayDetails').patchValue({\r\n              name: vm.device.name,\r\n              type: vm.device.type,\r\n              label: vm.device.label\r\n            });\r\n\r\n            getDeviceCredentials(entityId.id);\r\n          },\r\n          function (error) {\r\n            console.error('Failed to fetch attributes:', error);\r\n          }\r\n        );\r\n      }\r\n    );\r\n  }\r\n\r\n  function getDeviceCredentials(eid) {\r\n    deviceService.getDeviceCredentials(eid).subscribe(\r\n      (credentials) => {\r\n        let credentialsObject = { credentialsType: credentials.credentialsType };\r\n\r\n        if (credentials.credentialsType === \"MQTT_BASIC\") {\r\n          let credentialsValue = JSON.parse(credentials.credentialsValue);\r\n          credentialsObject.clientId = credentialsValue.clientId;\r\n          credentialsObject.userName = credentialsValue.userName;\r\n          credentialsObject.password = credentialsValue.password;\r\n        } else if (credentials.credentialsType === \"ACCESS_TOKEN\") {\r\n          const credentialsValue = credentials.credentialsValue ? JSON.parse(credentials.credentialsValue) : null;\r\n          if (credentialsValue && credentialsValue.credentialsId) {\r\n            credentialsObject.credentialsId = credentialsValue.credentialsId;\r\n          } else {\r\n            credentialsObject.credentialsId = '';\r\n            console.warn('Missing credentialsId in the device credentials.');\r\n          }\r\n        }\r\n\r\n        vm.credentials = credentialsObject;\r\n\r\n        vm.editDeviceFormGroup.get('credentialsDetails').patchValue({\r\n          credentialsType: credentialsObject.credentialsType || '',\r\n          clientId: credentialsObject.clientId || '',\r\n          userName: credentialsObject.userName || '',\r\n          password: credentialsObject.password || '',\r\n          credentialsId: credentialsObject.credentialsId || ''\r\n        });\r\n\r\n        vm.editDeviceFormGroup.markAsPristine();\r\n        vm.editDeviceFormGroup.markAsUntouched();\r\n        vm.editDeviceFormGroup.updateValueAndValidity();\r\n      },\r\n      (error) => {\r\n        console.error('Failed to load device credentials:', error);\r\n      }\r\n    );\r\n  }\r\n\r\n  function saveDevice() {\r\n    const gatewayValues = vm.editDeviceFormGroup.get('gatewayDetails').value;\r\n    const simValues = vm.editDeviceFormGroup.get('simDetails').value;\r\n\r\n    vm.device.name = gatewayValues.name;\r\n    if (vm.device.type !== gatewayValues.type) {\r\n      vm.device.type = gatewayValues.type;\r\n      vm.device.deviceProfileId = null;\r\n    }\r\n    vm.device.label = gatewayValues.label;\r\n\r\n    const attributes = [\r\n      {\r\n        key: 'connectivity',\r\n        value: {\r\n          ICCID: simValues.ICCID,\r\n          carrier: simValues.carrierSIM,\r\n          simStatus: simValues.statusSIM\r\n        }\r\n      }\r\n    ];\r\n\r\n    return deviceService.saveDevice(vm.device).pipe(\r\n      mergeMap(() => {\r\n        return attributeService.saveEntityAttributes(entityId, 'SERVER_SCOPE', attributes);\r\n      })\r\n    );\r\n  }\r\n\r\n  function updateDeviceCredentials(eid) {\r\n    return deviceService.getDeviceCredentials(eid).pipe(\r\n      mergeMap(existingCredentials => {\r\n        const credentialsValues = vm.editDeviceFormGroup.get('credentialsDetails').value;\r\n        let newCredentials = {\r\n          id: existingCredentials.id,\r\n          deviceId: existingCredentials.deviceId,\r\n          credentialsType: credentialsValues.credentialsType\r\n        };\r\n\r\n        if (credentialsValues.credentialsType === 'MQTT_BASIC') {\r\n          newCredentials.credentialsValue = JSON.stringify({\r\n            clientId: credentialsValues.clientId,\r\n            userName: credentialsValues.userName,\r\n            password: credentialsValues.password\r\n          });\r\n        } else if (credentialsValues.credentialsType === 'ACCESS_TOKEN') {\r\n          newCredentials.credentialsValue = JSON.stringify({\r\n            credentialsId: credentialsValues.credentialsId\r\n          });\r\n        }\r\n\r\n        return deviceService.saveDeviceCredentials(newCredentials);\r\n      })\r\n    );\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7e870fd2-9559-9a6e-d847-beefc971ecaa"
              },
              {
                "name": "{i18n:custom.gateways.delete-device}",
                "icon": "delete",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteDeviceDialog();\n\nfunction openDeleteDeviceDialog() {\n  let titleTranslation = translationService.instant(\n    'custom.gateways.delete-device-title',\n    { entityName: entityName }\n  );\n\n  let contentTranslation = translationService.instant(\n    'custom.gateways.delete-device-content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteDevice();\n    }\n  });\n}\n\nfunction deleteDevice() {\n  deviceService.deleteDevice(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "70f87b5b-3dbc-91e6-0e59-80511b0be772"
              }
            ]
          },
          "titleIcon": "devices_other",
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "28px",
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "0c7469aa-7b86-be27-5216-bc6cc702f8b1",
        "typeFullFqn": "system.cards.entities_table"
      },
      "248d9bcd-6dcc-381f-cd4c-211ec095b8c8": {
        "typeFullFqn": "system.action_button",
        "type": "latest",
        "sizeX": 3,
        "sizeY": 1,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1718798104772,
                "endTimeMs": 1718884504772
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#FFFFFF01",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "activatedState": {
              "action": "GET_DASHBOARD_STATE",
              "defaultValue": false,
              "executeRpc": {
                "method": null,
                "requestTimeout": null,
                "requestPersistent": null,
                "persistentPollingInterval": null
              },
              "getAttribute": {
                "scope": null,
                "key": "state"
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;",
                "compareToValue": "Doktorkit_devices_table"
              }
            },
            "disabledState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "appearance": {
              "type": "outlined",
              "showLabel": true,
              "label": "Table",
              "showIcon": true,
              "icon": "insert_chart",
              "iconSize": 24,
              "iconSizeUnit": "px",
              "mainColor": "#3D9BE9",
              "backgroundColor": "#FFFFFF",
              "autoScale": true,
              "customStyle": {
                "enabled": null,
                "hovered": null,
                "pressed": null,
                "activated": null,
                "disabled": null
              }
            }
          },
          "title": "Action button",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "borderRadius": "4px",
          "configMode": "advanced",
          "actions": {
            "click": [
              {
                "name": "onClick",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "updateDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "bd80b787-5b71-a945-c4c6-b80018b0b9e6"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "248d9bcd-6dcc-381f-cd4c-211ec095b8c8"
      },
      "1bed8029-36f3-d139-9171-d41e4dc9bfa4": {
        "typeFullFqn": "system.action_button",
        "type": "latest",
        "sizeX": 3,
        "sizeY": 1,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1718798104772,
                "endTimeMs": 1718884504772
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#FFFFFF01",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "activatedState": {
              "action": "GET_DASHBOARD_STATE",
              "defaultValue": false,
              "executeRpc": {
                "method": null,
                "requestTimeout": null,
                "requestPersistent": null,
                "persistentPollingInterval": null
              },
              "getAttribute": {
                "scope": null,
                "key": "state"
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;",
                "compareToValue": "Doktorkit_devices_plan"
              }
            },
            "disabledState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "appearance": {
              "type": "outlined",
              "showLabel": true,
              "label": "Plan",
              "showIcon": true,
              "icon": "insert_chart",
              "iconSize": 24,
              "iconSizeUnit": "px",
              "mainColor": "#3D9BE9",
              "backgroundColor": "#FFFFFF",
              "autoScale": true,
              "customStyle": {
                "enabled": null,
                "hovered": null,
                "pressed": null,
                "activated": null,
                "disabled": null
              }
            }
          },
          "title": "Action button",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "borderRadius": "4px",
          "configMode": "advanced",
          "actions": {
            "click": [
              {
                "name": "onClick",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "updateDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_plan",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "bd80b787-5b71-a945-c4c6-b80018b0b9e6"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "1bed8029-36f3-d139-9171-d41e4dc9bfa4"
      },
      "c7bcd0ec-a47b-5bb5-d7cf-9c07fbe96d98": {
        "typeFullFqn": "system.cards.markdown_card",
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "d13f6078-0d81-ec59-529c-64acbbcaf470",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1719396870991,
                "endTimeMs": 1719483270991
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"w-full h-full p-0 flex flex-col\">\r\n  <div class=\"flex-1 flex flex-col relative\">\r\n    <tb-dashboard-state\r\n      class=\"flex-1\"\r\n      [ctx]=\"ctx\"\r\n      [syncParentStateParams]=\"true\"\r\n      stateId=\"devices_table_doktorkit\"\r\n    ></tb-dashboard-state>\r\n  </div>\r\n</div>\r\n",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "enableDataExport": false,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "actions": {
            "headerButton": []
          }
        },
        "row": 0,
        "col": 0,
        "id": "c7bcd0ec-a47b-5bb5-d7cf-9c07fbe96d98"
      },
      "5d58360e-ec9a-cace-33d3-f64d2ba8e946": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\r\n     <div fxLayout=\"row\" style=\"width: 100%; height: 40px; justify-content: flex-start;\" fxLayoutAlign=\"start start\">\r\n        <h5 fxFlex class=\"market-title\">Devices</h5>\r\n        <div style=\"margin-right: 30px;\">\r\n        <button id=\"add-device\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">add</mat-icon><span>Add device manually</span></button>\r\n        <button id=\"replace-device\" mat-raised-button color=\"primary\" style=\"display: none;\">\r\n                <mat-icon class=\"tb-mat-20\">add</mat-icon>\r\n                <span>Replace Device</span>\r\n        </button>\r\n        </div> \r\n     </div>\r\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\r\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"doktorkit_devices_header_buttons\"></tb-dashboard-state>\r\n    </div>\r\n</div>\r\n",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-container .tb-widget .tb-multiple-input {\n    background-color: #FAFAFA;\n    border-radius: 4px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .input-field {\n    padding-right: 30px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input mat-slide-toggle {\n    margin-top: 15px !important;\n    margin-bottom: 0 !important;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-slide-toggle-content {\n    width: 120px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-bar {\n    width: 42px;\n    height: 24px;\n    border-radius: 16px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb-container {\n    top: 2px;\n    left: 2px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-thumb-container {\n    transform: translate3d(18px, 0, 0);\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb {\n    background-color: #fafafa;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-bar {\n    background-color: #F2994A;\n}\n",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "add-device",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDeviceFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 800px;\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Add device</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-horizontal-stepper formGroupName=\"stepper\" linear>\r\n      <mat-step formGroupName=\"assignmentStep\" label=\"Assignment\">\r\n        <ng-template matStepLabel>Assignment</ng-template>\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Device</mat-label>\r\n          <mat-select formControlName=\"device\" required>\r\n            <mat-select-trigger>\r\n              <div class=\"device-item\" fxLayout=\"row\">\r\n                <div fxLayout=\"column\" fxFlex>\r\n                  <div>{{addDeviceFormGroup.get('stepper.assignmentStep.device').value?.label}}</div>\r\n                  <div class=\"device-name\">{{addDeviceFormGroup.get('stepper.assignmentStep.device').value?.name}}</div>\r\n                </div>\r\n                <div class=\"device-type\">{{addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type}}</div>\r\n              </div>\r\n            </mat-select-trigger>\r\n            <mat-option *ngFor=\"let device of availableDevices\" [value]=\"device\">\r\n              <div class=\"device-item\" fxLayout=\"row\">\r\n                <div fxLayout=\"column\" fxFlex>\r\n                  <div>{{device?.label}}</div>\r\n                  <div class=\"device-name\">{{device?.name}}</div>\r\n                </div>\r\n                <div class=\"device-type\">{{device?.type}}</div>\r\n              </div>\r\n              <mat-divider></mat-divider>\r\n            </mat-option>\r\n            <mat-option *ngIf=\"!availableDevices?.length\" disabled [value]=\"null\">\r\n              <div class=\"device-item\">\r\n                No devices available\r\n              </div>\r\n            </mat-option>\r\n          </mat-select>\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').hasError('required')\">\r\n            Device is required.\r\n          </mat-error>\r\n        </mat-form-field>\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Label</mat-label>\r\n          <input matInput formControlName=\"label\">\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.label').hasError('required')\">\r\n            Device label is required.\r\n          </mat-error>\r\n        </mat-form-field>\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\"\r\n                  type=\"button\"\r\n                  [disabled]=\"(isLoading$ | async)\"\r\n                  (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n          </button>\r\n          <button mat-button matStepperNext color=\"primary\" type=\"button\">\r\n            Next\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n      <mat-step formGroupName=\"attributesStep\" label=\"Attributes\" *ngIf=\"showAttributesStep\">\r\n        <ng-template matStepLabel>Attributes</ng-template>\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Installation Type</mat-label>\r\n          <mat-select formControlName=\"installationType\" required>\r\n            <mat-option value=\"heating\">Heating</mat-option>\r\n            <mat-option value=\"cooling\">Cooling</mat-option>\r\n          </mat-select>\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationType').hasError('required')\">\r\n            Installation Type is required.\r\n          </mat-error>\r\n        </mat-form-field>\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Outside Temperature Threshold</mat-label>\r\n          <input matInput formControlName=\"loadCourseAnalysisTemperature\" type=\"number\">\r\n        </mat-form-field>\r\n        <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n          <mat-form-field class=\"mat-block\" fxFlex>\r\n            <mat-label>Outside Temperature Threshold Setting</mat-label>\r\n            <mat-select formControlName=\"loadCourseFilterTemperature\" required>\r\n              <mat-option value=\"above\">Above</mat-option>\r\n              <mat-option value=\"below\">Below</mat-option>\r\n            </mat-select>\r\n            <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.loadCourseFilterTemperature').hasError('required')\">\r\n              Temperature Condition is required.\r\n            </mat-error>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"mat-block\" fxFlex>\r\n            <mat-label>Outside Temperature Threshold</mat-label>\r\n            <input matInput formControlName=\"loadCourseFilterTemperatureValue\" type=\"number\">\r\n          </mat-form-field>\r\n        </div>\r\n        <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n        <mat-form-field class=\"mat-block\" fxFlex>\r\n          <mat-label>Maximum Power Threshold</mat-label>\r\n          <input matInput formControlName=\"loadCourseFilterMaxPower\" type=\"number\">\r\n        </mat-form-field>\r\n        <mat-form-field class=\"mat-block\" fxFlex>\r\n          <mat-label>Nominal Flow</mat-label>\r\n          <input matInput formControlName=\"nominalFlow\" type=\"number\">\r\n        </mat-form-field>\r\n        </div>\r\n        <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n          <mat-form-field class=\"mat-block\" fxFlex>\r\n            <mat-label>Delta T</mat-label>\r\n            <input matInput formControlName=\"deltaT\" type=\"number\">\r\n          </mat-form-field>\r\n          <mat-form-field class=\"mat-block\" fxFlex>\r\n            <mat-label>Circulation Pump Energy Consumption</mat-label>\r\n            <input matInput formControlName=\"deltaTAnalysisPumpEnergy\" type=\"number\">\r\n          </mat-form-field>\r\n          <mat-form-field class=\"mat-block\" fxFlex>\r\n            <mat-label>Floor Volume (l/h)</mat-label>\r\n            <input matInput formControlName=\"deltaTAnalysisFloorVolume\" type=\"number\">\r\n          </mat-form-field>\r\n        </div>\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\"\r\n                  type=\"button\"\r\n                  [disabled]=\"(isLoading$ | async)\"\r\n                  (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n          </button>\r\n          <button mat-button matStepperPrevious color=\"primary\" type=\"button\">\r\n            Back\r\n          </button>\r\n          <button mat-button matStepperNext color=\"primary\" type=\"button\">\r\n            Next\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n      <mat-step formGroupName=\"alarmThresholdsStep\" label=\"Alarm Thresholds\">\r\n        <ng-template matStepLabel>Alarm Thresholds</ng-template>\r\n        <div *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type === 'P-Flow D116'\">\r\n        <div fxLayout=\"row\" fxLayoutGap=\"24px\">\r\n          <div fxFlex=\"50%\">\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Volume Flow Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"maxVolumeFlowCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Energy Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"maxEnergyCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Min Temperature Difference Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"minTemperatureDifferenceCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n          <div fxFlex=\"50%\">\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Volume Flow Major Threshold</mat-label>\r\n              <input matInput formControlName=\"maxVolumeFlowMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Energy Major Threshold</mat-label>\r\n              <input matInput formControlName=\"maxEnergyMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Min Temperature Difference Major Threshold</mat-label>\r\n              <input matInput formControlName=\"minTemperatureDifferenceMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n        </div>\r\n        </div>\r\n         <!-- Additional fields for Room Sensor CO2 type -->\r\n        <div *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type === 'Room Sensor CO2'\">\r\n          <div fxLayout=\"row\" fxLayoutGap=\"24px\">\r\n            <div fxFlex=\"50%\">\r\n              <mat-form-field class=\"mat-block\">\r\n                <mat-label>High CO2 Threshold for critical alarm</mat-label>\r\n                <input matInput formControlName=\"highCo2CriticalThreshold\" type=\"number\">\r\n              </mat-form-field>\r\n            </div>\r\n            <div fxFlex=\"50%\">\r\n              <mat-form-field class=\"mat-block\">\r\n                <mat-label>High CO2 Threshold for major alarm</mat-label>\r\n                <input matInput formControlName=\"highCo2MajorThreshold\" type=\"number\">\r\n              </mat-form-field>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <!-- Additional fields for Room Sensor T type -->\r\n        <div *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type === 'Room Sensor T' ||addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type === 'Room Sensor CO2'\">\r\n          <div fxLayout=\"row\" fxLayoutGap=\"24px\">\r\n            <div fxFlex=\"50%\">\r\n              <mat-form-field class=\"mat-block\">\r\n                <mat-label>High Temperature Critical Threshold</mat-label>\r\n                <input matInput formControlName=\"highTemperatureCriticalThreshold\" type=\"number\">\r\n              </mat-form-field>\r\n              <mat-form-field class=\"mat-block\">\r\n                <mat-label>High Humidity Critical Threshold</mat-label>\r\n                <input matInput formControlName=\"highHumidityCriticalThreshold\" type=\"number\">\r\n              </mat-form-field>\r\n            </div>\r\n            <div fxFlex=\"50%\">\r\n              <mat-form-field class=\"mat-block\">\r\n                <mat-label>High Temperature Major Threshold</mat-label>\r\n                <input matInput formControlName=\"highTemperatureMajorThreshold\" type=\"number\">\r\n              </mat-form-field>\r\n              <mat-form-field class=\"mat-block\">\r\n                <mat-label>High Humidity Major Threshold</mat-label>\r\n                <input matInput formControlName=\"highHumidityMajorThreshold\" type=\"number\">\r\n              </mat-form-field>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <!-- End of additional fields for Room Sensor T type -->\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\"\r\n                  type=\"button\"\r\n                  [disabled]=\"(isLoading$ | async)\"\r\n                  (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n          </button>\r\n          <button mat-button matStepperPrevious color=\"primary\" type=\"button\">\r\n            Back\r\n          </button>\r\n          <button mat-button mat-raised-button color=\"primary\"\r\n                  type=\"submit\"\r\n                  [disabled]=\"(isLoading$ | async) || addDeviceFormGroup.invalid\">\r\n            Save\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>\r\n\r\n",
                "customCss": "\n.device-item {\n    line-height: 24px;\n    width: 100%;\n    padding-top: 8px;\n    padding-bottom: 8px;\n}\n\n.device-item .device-name {\n    font-size: 12px;\n    opacity: 0.7;\n}\n\n.device-item .device-type {\n    font-size: 14px;\n    opacity: 0.7;\n}\n\nmat-option {\n    height: auto !important;\n    white-space: normal !important;\n}\n\n.mat-select-value-text {\n    display: block;\n    width: 100%;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\n\r\nif (additionalParams.source === \"replace Device\") {\r\n    if (additionalParams.choice === true) {\r\n        openAddDeviceDialog();\r\n    } else {\r\n        // Handle other cases if needed\r\n    }\r\n} else if (additionalParams.source !== \"replace Device\") {\r\n    openAddDeviceDialog();\r\n}\r\n\r\nfunction openAddDeviceDialog() {\r\n    customDialog.customDialog(htmlTemplate, AddDeviceDialogController).subscribe();\r\n}\r\n\r\nfunction AddDeviceDialogController(instance) {\r\n    let vm = instance;\r\n\r\n    vm.addDeviceFormGroup = vm.fb.group({\r\n        stepper: vm.fb.group({\r\n            assignmentStep: vm.fb.group({\r\n                device: [null, [vm.validators.required]],\r\n                label: [{ value: null, disabled: true }]\r\n            }),\r\n            attributesStep: vm.fb.group({\r\n                installationType: ['heating', [vm.validators.required]],\r\n                loadCourseAnalysisTemperature: [null],\r\n                loadCourseFilterTemperature: ['above', [vm.validators.required]],\r\n                loadCourseFilterTemperatureValue: [null],\r\n                loadCourseFilterMaxPower: [null],\r\n                nominalFlow: [null],\r\n                deltaT: [null],\r\n                deltaTAnalysisPumpEnergy: [null],\r\n                deltaTAnalysisFloorVolume: [null],\r\n            }),\r\n            alarmThresholdsStep: vm.fb.group({\r\n                maxVolumeFlowCriticalThreshold: [null],\r\n                maxVolumeFlowMajorThreshold: [null],\r\n                maxEnergyCriticalThreshold: [null],\r\n                maxEnergyMajorThreshold: [null],\r\n                minTemperatureDifferenceCriticalThreshold: [null],\r\n                minTemperatureDifferenceMajorThreshold: [null],\r\n                // Additional fields for Room Sensor CO2 type\r\n                highCo2CriticalThreshold: [null],\r\n                highCo2MajorThreshold: [null],\r\n                // Additional fields for Room Sensor T type\r\n                highTemperatureCriticalThreshold: [null],\r\n                highHumidityCriticalThreshold: [null],\r\n                highTemperatureMajorThreshold: [null],\r\n                highHumidityMajorThreshold: [null]\r\n            })\r\n        })\r\n    });\r\n    \r\n     // Set initial deltaT based on default installationType\r\n    let initialInstallationType = vm.addDeviceFormGroup.get('stepper.attributesStep.installationType').value;\r\n    if (initialInstallationType === 'heating') {\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.deltaT').patchValue(15);\r\n    } else if (initialInstallationType === 'cooling') {\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.deltaT').patchValue(6);\r\n    }\r\n    \r\n    // Watch for changes in installationType to set default deltaT value\r\n    vm.addDeviceFormGroup.get('stepper.attributesStep.installationType').valueChanges.subscribe((installationType) => {\r\n        if (installationType === 'heating') {\r\n            vm.addDeviceFormGroup.get('stepper.attributesStep.deltaT').patchValue(15);\r\n        } else if (installationType === 'cooling') {\r\n            vm.addDeviceFormGroup.get('stepper.attributesStep.deltaT').patchValue(6);\r\n        }\r\n    });\r\n    // Additional state to control the visibility of the attributes step\r\n    vm.showAttributesStep = true;\r\n\r\n    vm.addDeviceFormGroup.get('stepper.assignmentStep.device').valueChanges.subscribe((device) => {\r\n        vm.addDeviceFormGroup.get('stepper.assignmentStep.label').patchValue(device.label, { emitEvent: false });\r\n        vm.addDeviceFormGroup.get('stepper.assignmentStep.label').enable({ emitEvent: false });\r\n        vm.addDeviceFormGroup.get('stepper.assignmentStep.label').updateValueAndValidity({ onlySelf: true });\r\n\r\n        // Check the device type and conditionally show/hide the attributes step\r\n        if (device.type === \"Room Sensor CO2\" || device.type === \"Room Sensor T\") {\r\n            vm.showAttributesStep = false;\r\n        } else {\r\n            vm.showAttributesStep = true;\r\n        }\r\n\r\n        // Trigger change detection manually\r\n        vm.changeDetectorRef.detectChanges();\r\n    });\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n    var DoktorkitId = widgetContext.stateController.getStateParams().selectedDoktorkit.entityId;\r\n    vm.addDeviceFormGroup.markAsPristine();\r\n    var device = vm.addDeviceFormGroup.value.stepper.assignmentStep.device;\r\n    var label = vm.addDeviceFormGroup.value.stepper.assignmentStep.label;\r\n    var installationType = vm.addDeviceFormGroup.value.stepper.attributesStep.installationType;\r\n    var maxVolumeFlowCriticalThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.maxVolumeFlowCriticalThreshold;\r\n    var maxVolumeFlowMajorThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.maxVolumeFlowMajorThreshold;\r\n    var loadCourseAnalysisTemperature = vm.addDeviceFormGroup.value.stepper.attributesStep.loadCourseAnalysisTemperature;\r\n    var loadCourseFilterTemperature = vm.addDeviceFormGroup.value.stepper.attributesStep.loadCourseFilterTemperature;\r\n    var loadCourseFilterTemperatureValue = vm.addDeviceFormGroup.value.stepper.attributesStep.loadCourseFilterTemperatureValue;\r\n    var loadCourseFilterMaxPower = vm.addDeviceFormGroup.value.stepper.attributesStep.loadCourseFilterMaxPower;\r\n    var nominalFlow = vm.addDeviceFormGroup.value.stepper.attributesStep.nominalFlow;\r\n    var deltaT = vm.addDeviceFormGroup.value.stepper.attributesStep.deltaT;\r\n    var deltaTAnalysisPumpEnergy = vm.addDeviceFormGroup.value.stepper.attributesStep.deltaTAnalysisPumpEnergy;\r\n    var deltaTAnalysisFloorVolume = vm.addDeviceFormGroup.value.stepper.attributesStep.deltaTAnalysisFloorVolume;\r\n    var maxEnergyCriticalThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.maxEnergyCriticalThreshold;\r\n    var maxEnergyMajorThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.maxEnergyMajorThreshold;\r\n    var minTemperatureDifferenceCriticalThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.minTemperatureDifferenceCriticalThreshold;\r\n    var minTemperatureDifferenceMajorThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.minTemperatureDifferenceMajorThreshold;\r\n    var highCo2CriticalThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.highCo2CriticalThreshold;\r\n    var highCo2MajorThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.highCo2MajorThreshold;\r\n    var highTemperatureCriticalThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.highTemperatureCriticalThreshold;\r\n    var highHumidityCriticalThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.highHumidityCriticalThreshold;\r\n    var highTemperatureMajorThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.highTemperatureMajorThreshold;\r\n    var highHumidityMajorThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.highHumidityMajorThreshold;\r\n\r\n    var deviceId = device.deviceId;\r\n    \r\n    widgetContext.rxjs.forkJoin([\r\n        entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n        saveDeviceToDoktorkitRelation(DoktorkitId, deviceId),\r\n        saveAttributes(\r\n            deviceId,\r\n            installationType,\r\n            maxVolumeFlowCriticalThreshold,\r\n            maxVolumeFlowMajorThreshold,\r\n            loadCourseAnalysisTemperature,\r\n            loadCourseFilterTemperature,\r\n            loadCourseFilterTemperatureValue,\r\n            loadCourseFilterMaxPower,\r\n            nominalFlow,\r\n            deltaT,\r\n            deltaTAnalysisPumpEnergy,\r\n            deltaTAnalysisFloorVolume,\r\n            maxEnergyCriticalThreshold,\r\n            maxEnergyMajorThreshold,\r\n            minTemperatureDifferenceCriticalThreshold,\r\n            minTemperatureDifferenceMajorThreshold,\r\n            highCo2CriticalThreshold,\r\n            highCo2MajorThreshold,\r\n            highTemperatureCriticalThreshold,\r\n            highHumidityCriticalThreshold,\r\n            highTemperatureMajorThreshold,\r\n            highHumidityMajorThreshold\r\n        ),\r\n        updateDeviceLabel(device, label)\r\n    ]).subscribe(() => {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n    });\r\n};\r\n\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedDevicesGroup = null;\r\n        vm.assignedDevicesGroup = null;\r\n        vm.availableDevices = [];\r\n        vm.assignedDevices = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'DEVICE').subscribe((entityGroups) => {\r\n            vm.customerDevicesGroups = entityGroups;\r\n            vm.unassignedDevicesGroup = entityGroups.find(group => group.name === 'Unassigned Doktorkit Devices');\r\n            vm.assignedDevicesGroup = entityGroups.find(group => group.name === 'Doktorkit Devices');\r\n            if (vm.unassignedDevicesGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.unassignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    vm.availableDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            deviceId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n\r\n                });\r\n            }\r\n            if (vm.assignedDevicesGroup) {\r\n                var query2 = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.assignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query2).subscribe((data) => {\r\n                    vm.assignedDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            deviceId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                    if (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Device\") {\r\n                        checkAdditionalParams();\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    function saveDeviceToDoktorkitRelation(DoktorkitId, deviceId) {\r\n        var relation = {\r\n            from: DoktorkitId,\r\n            to: deviceId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Contains'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function saveAttributes(entityId, installationType, maxVolumeFlowCriticalThreshold, maxVolumeFlowMajorThreshold, loadCourseAnalysisTemperature, loadCourseFilterTemperature, loadCourseFilterTemperatureValue, loadCourseFilterMaxPower, nominalFlow,deltaT, deltaTAnalysisPumpEnergy, deltaTAnalysisFloorVolume, maxEnergyCriticalThreshold, maxEnergyMajorThreshold, minTemperatureDifferenceCriticalThreshold, minTemperatureDifferenceMajorThreshold, highCo2CriticalThreshold, highCo2MajorThreshold, highTemperatureCriticalThreshold, highHumidityCriticalThreshold, highTemperatureMajorThreshold, highHumidityMajorThreshold) {\r\n    let attributesArray = [\r\n        { key: 'xPos', value: 0.5 },\r\n        { key: 'yPos', value: 0.5 },\r\n        { key: 'installationType', value: installationType },\r\n        { key: 'maxVolumeFlowCriticalThreshold', value: maxVolumeFlowCriticalThreshold },\r\n        { key: 'maxVolumeFlowMajorThreshold', value: maxVolumeFlowMajorThreshold },\r\n        { key: 'loadCourseAnalysisTemperature', value: loadCourseAnalysisTemperature },\r\n        { key: 'loadCourseFilterTemperature', value: loadCourseFilterTemperature },\r\n        { key: 'loadCourseFilterTemperatureValue', value: loadCourseFilterTemperatureValue },\r\n        { key: 'loadCourseFilterMaxPower', value: loadCourseFilterMaxPower },\r\n        { key: 'nominalFlow', value: nominalFlow },\r\n        { key: 'deltaT', value: deltaT },\r\n        { key: 'deltaTAnalysisPumpEnergy', value: deltaTAnalysisPumpEnergy },\r\n        { key: 'deltaTAnalysisFloorVolume', value: deltaTAnalysisFloorVolume },\r\n        { key: 'maxEnergyCriticalThreshold', value: maxEnergyCriticalThreshold },\r\n        { key: 'maxEnergyMajorThreshold', value: maxEnergyMajorThreshold },\r\n        { key: 'minTemperatureDifferenceCriticalThreshold', value: minTemperatureDifferenceCriticalThreshold },\r\n        { key: 'minTemperatureDifferenceMajorThreshold', value: minTemperatureDifferenceMajorThreshold },\r\n        { key: 'highCo2CriticalThreshold', value: highCo2CriticalThreshold },\r\n        { key: 'highCo2MajorThreshold', value: highCo2MajorThreshold },\r\n        { key: 'highHumidityCriticalThreshold', value: highHumidityCriticalThreshold },\r\n        { key: 'highHumidityMajorThreshold', value: highHumidityMajorThreshold },\r\n        { key: 'highTemperatureCriticalThreshold', value: highTemperatureCriticalThreshold },\r\n        { key: 'highTemperatureMajorThreshold', value: highTemperatureMajorThreshold }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n}\r\n\r\n\r\n    function updateDeviceLabel(device, label) {\r\n        if (device.label !== label) {\r\n            return deviceService.getDevice(device.deviceId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origDevice) => {\r\n                    origDevice.label = label;\r\n                    return deviceService.saveDevice(origDevice);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableDevice = vm.availableDevices.find(device => device.name === additionalParams.code);\r\n        const matchingAssignedDevice = vm.assignedDevices.find(device => device.name === additionalParams.code);\r\n\r\n                if (!matchingAvailableDevice && !matchingAssignedDevice) {\r\n            widgetContext.dialogs.alert(\"Device doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedDevice && !matchingAvailableDevice) {\r\n            getDoktorkit(additionalParams.code);\r\n        }\r\n        if (matchingAvailableDevice && matchingAssignedDevice) {\r\n            vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { device: matchingAvailableDevice } } }, { emitEvent: false });\r\n            vm.addDeviceFormGroup.get('stepper.assignmentStep.device').markAsDirty();\r\n            vm.addDeviceFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('mat-select[formControlName=\"device\"]');\r\n                if (selectElement) {\r\n                    selectElement.dispatchEvent(new Event('change'));\r\n                }\r\n\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n\r\n    function getDoktorkit(code) {\r\n        vm.deviceEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToDoktorkit = null;\r\n\r\n        deviceService.findByName(code)\r\n            .pipe(\r\n                widgetContext.rxjs.map((origDevice) => {\r\n                    vm.deviceEntityId = origDevice.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.deviceEntityId, 'entityType': 'DEVICE' }).pipe(\r\n                    widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations).pipe(\r\n                        widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToDoktorkit = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-device\");\r\n                        let params = {\r\n                            \"doktorkit\": vm.assignedToDoktorkit,\r\n                            \"device\": vm.deviceEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7cad1c71-0765-4277-32a8-c87808a0c689"
              },
              {
                "name": "replace-device",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<!-- replace-device-dialog.component.html -->\r\n<div class=\"replace-device-dialog-form\" style=\"width: 400px;\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Replace Device</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-dialog-content fxLayout=\"column\" class=\"mat-typography\">\r\n    <p>{{ confirmationMessage }}</p>\r\n  </mat-dialog-content>\r\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n    <button mat-button color=\"primary\" (click)=\"cancel()\" type=\"button\" cdkFocusInitial>\r\n      No\r\n    </button>\r\n    <button mat-button mat-raised-button color=\"primary\" (click)=\"confirm()\" type=\"button\">\r\n      Yes\r\n    </button>\r\n  </div>\r\n</div>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\nlet qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"add-device\");\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\n\nopenReplaceDeviceDialog();\n\nfunction openReplaceDeviceDialog() {\n    customDialog.customDialog(htmlTemplate, ReplaceDeviceDialogController).subscribe();\n}\n\nfunction returnSelection(replaceDevice) {\n    let params = {\n        source: \"replace Device\",\n        choice: replaceDevice // Use event.replaceDevice instead of replaceDevice directly\n    };\n    //widgetContext.dialogs.alert(\"User selected 2\" + replaceDevice.toString() + \"!\");\n    try {\n        widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\n    } catch (error) {\n        widgetContext.dialogs.alert('Error handling widget action:', error);\n    }\n}\n\nfunction ReplaceDeviceDialogController(instance) {\n    let vm = instance;\n    let replaceDevice;\n    //widgetContext.dialogs.alert(\"Aditional Params: \" + JSON.stringify(additionalParams) + additionalParams.device);\n\n    vm.confirmationMessage = \"Device is already assigned to \" + additionalParams.doktorkit + \"!\\n\" +\n        \"Do you want to remove it from \" + additionalParams.doktorkit + \" and assign it to the current one?\";\n\n    vm.cancel = function() {\n        replaceDevice = false; // Set replaceDevice to false\n        vm.handleConfirm({ replaceDevice: replaceDevice });\n    };\n\n    vm.confirm = function() {\n        let entityId = { 'id': additionalParams.device, 'entityType': 'DEVICE' };\n        let entityGroupId = \"684410d0-bfae-11ee-8196-b3999b4a11b6\";\n        //widgetContext.dialogs.alert(\"Additional Params: \" + JSON.stringify(entityId));\n        try {\n            entityRelationService.deleteRelations(entityId).subscribe(\n                () => {\n                    try {\n                        entityGroupService.addEntityToEntityGroup(entityGroupId, entityId.id).subscribe(\n                            () => {\n                                replaceDevice = true; // Set replaceDevice to true\n                                vm.handleConfirm({ replaceDevice: replaceDevice });\n                            },\n                            error => {\n                                widgetContext.dialogs.alert('Error handling add to Group action: ' + JSON.stringify(error));\n                            }\n                        );\n                    } catch (error) {\n                        widgetContext.dialogs.alert('Error initiating addEntityToEntityGroup: ' + JSON.stringify(error));\n                    }\n                },\n                error => {\n                    widgetContext.dialogs.alert('Error handling deleteRelations: ' + JSON.stringify(error));\n                }\n            );\n        } catch (error) {\n            widgetContext.dialogs.alert('Error initiating deleteRelations: ' + JSON.stringify(error));\n        }\n    };\n\n    vm.handleConfirm = function(event) {\n        vm.dialogRef.close(event);\n        let params = {\n            source: \"replace Device\",\n            choice: event.replaceDevice, // Use event.replaceDevice instead of replaceDevice directly\n            device: additionalParams.device,\n            code: additionalParams.code\n        };\n        try {\n            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\n        } catch (error) {\n            widgetContext.dialogs.alert('Error handling widget action:', error);\n        }\n    };\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "c45ba341-9bcd-8608-b0f5-15317d44eb8a"
              }
            ],
            "headerButton": [
              {
                "name": "qr-code",
                "icon": "qr_code_scanner",
                "useShowWidgetActionFunction": false,
                "showWidgetActionFunction": "return true;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "scanQrCode",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Scan QR code action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to scan QR code', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processQrCodeFunction": "// Function body to process result of QR code scanning. \n// - code - scanned QR code\n// - format - scanned QR code format\n//widgetContext.actionsApi.qrCodeCallback(code);\nlet $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\nlet qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"add-device\");\n\nlet params = {\n    source: \"qrcode\",\n    code: code\n}\ntry {\n    widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\n} catch (error) {\n    widgetContext.dialogs.alert('Error handling widget action:', error);\n}\n\n//showQrCodeDialog(\"Code\", code, format);\nfunction showQrCodeDialog(title, code, format) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Code: ['+code+']<br>Format: ' + format).subscribe();\n    }, 100);\n}\n\n"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "01671463-1c6c-41bb-da25-4eb5ee1ef842"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "5d58360e-ec9a-cace-33d3-f64d2ba8e946",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "faaa7767-eace-1546-163d-30d272242806": {
        "typeFullFqn": "system.cards.markdown_card",
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "d13f6078-0d81-ec59-529c-64acbbcaf470",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1719396870991,
                "endTimeMs": 1719483270991
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\r\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\r\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_plan\"></tb-dashboard-state>\r\n    </div>\r\n</div>\r\n",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": true,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "faaa7767-eace-1546-163d-30d272242806"
      },
      "d5ffcdcd-a934-115a-cf8b-641b03bea108": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "f765d469-eafe-c53b-d010-c75a39278cad",
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Name",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.4601055790893296
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "var ProjectState;\r\nif (data && data.length && data[0]['entityId'] && data[0]['aliasName'] !== 'Projects') {\r\n    ProjectState = true;\r\n} else {\r\n    ProjectState = false;\r\n}\r\nlet $injector = ctx.$scope.$injector;\r\nlet attributeService = $injector.get(ctx.servicesMap.get('attributeService'));\r\nvar customer;\r\nif (ctx.currentUser.authority !== 'CUSTOMER_USER'){\r\n  customer = ctx.stateController.getStateParams().entityId;  \r\n}else{\r\n    customer = {entityType:\"CUSTOMER\",id: ctx.currentUser.customerId};\r\n}\r\nconst attributesKey = [{ key: \"detailReportCheck\", value: \"check\" }, { key: \"generalReportCheck\", value: \"check\" }];\r\n            attributeService.saveEntityAttributes(\r\n              customer,\r\n              \"SERVER_SCOPE\",\r\n              attributesKey\r\n            ).subscribe(/*response => {\r\n                //console.log(\"Done\");\r\n            }*/);\r\n            \r\nvar projectSelected = ctx.stateController.getStateParams().selectedProject !== null && ctx.stateController.getStateParams().selectedProject;\r\nvar typeSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24\" viewBox=\"0 -960 960 960\" width=\"24\"><path d=\"M160-80q-33 0-56.5-23.5T80-160v-480q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v480q0 33-23.5 56.5T800-80H160Zm240-640h160v-80H400v80Zm40 360v120h80v-120h120v-80H520v-120h-80v120H320v80h120Z\"/></svg>';\r\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\r\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\r\n\r\n// var header = '<div class=\"header\" fxLayout=\"row\" fxLayoutAlign=\"start stretch\" fxLayoutGap=\"8px\">' +\r\n//                 '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><button id=\"go-back\" matTooltip=\"Go back\" type=\"button\" mat-icon-button><mat-icon>arrow_back</mat-icon></button></div>' +\r\n//                 '<div fxFlex fxLayout=\"column\" fxLayoutAlign=\"center\">' +\r\n//                   '<div class=\"title\">Edit Project: {{ ctx.stateController.getStateParams().selectedProject?.entityName }}</div>' +\r\n//                 '</div>' +\r\n//                 //'<div fxLayout=\"column\" class=\"button-margin-top\" fxLayoutAlign=\"start\"><button id=\"add-Measurement\" type=\"button\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">add_circle</mat-icon><span></span></button></div>' +\r\n//                 '<div fxLayout=\"column\" class=\"button-margin-top\" fxLayoutAlign=\"start\"><button id=\"Measurements\" type=\"button\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">devices_other</mat-icon><span></span></button></div>' +\r\n//                 '<div fxLayout=\"column\" class=\"button-margin-top\" fxLayoutAlign=\"start\" style=\"padding-right: 24px;\"><button id=\"delete-Project\" type=\"button\" mat-raised-button color=\"accent\"><mat-icon class=\"tb-mat-20\">delete</mat-icon><span></span></button></div>' +\r\n//              '</div>';\r\n/*let tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\r\nlet stripeSecretKey;\r\n\r\n            \r\nattributeService\r\n  .getEntityAttributes(customer, \"SERVER_SCOPE\", ['stripeKey'])\r\n  .subscribe(key => {\r\n    stripeSecretKey = key[0].value;\r\n    // 2. Now iterate over all measurements in data.\r\n    data.forEach(measurement => {\r\n      let measurementID = measurement.entityId;\r\n      if (!measurementID) {\r\n        console.warn(\"No entityId found for measurement:\", measurement);\r\n        return; // Skip if we don't have an entity ID\r\n      }\r\n\r\n      // 3. Retrieve server-side attributes for each measurement.\r\n      attributeService\r\n        .getEntityAttributes({ entityType: 'ASSET', id: measurementID }, 'SERVER_SCOPE')\r\n        .subscribe(response => {\r\n          // 4. Once the attributes come back, process them for session/invoice.\r\n          fetchAndUpdateAttributes(measurementID, response);\r\n        });\r\n    });\r\n  });\r\n*/\r\n/**\r\n * This function checks the 'detailReport' attribute, then sessionId or invoiceId,\r\n * and if paid, it updates the 'detailReport' attribute to true.\r\n */\r\n/*\r\nfunction fetchAndUpdateAttributes(measurementID, attributes) {\r\n  let detailReportAttr = attributes.find(attr => attr.key === 'detailReport' && attr.value !== null && attr.value !== undefined);\r\n  let detailReport = detailReportAttr ? detailReportAttr.value : false;\r\n\r\n  let sessionIdAttr = attributes.find(attr => attr.key === 'sessionId' && attr.value !== null && attr.value !== undefined);\r\n  let invoiceIdAttr = attributes.find(attr => attr.key === 'invoiceId' && attr.value !== null && attr.value !== undefined);\r\n\r\n  // If `detailReport` is not true, then we might need to check session or invoice\r\n  if (detailReport !== true) {\r\n    // Check for Stripe session\r\n    if (sessionIdAttr && stripeSecretKey) {\r\n      let sessionId = sessionIdAttr.value;\r\n      fetch(`https://api.stripe.com/v1/checkout/sessions/${sessionId}`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Authorization': 'Bearer ' + stripeSecretKey\r\n        }\r\n      })\r\n        .then(response => response.json())\r\n        .then(sessionData => {\r\n          if (sessionData.payment_status === 'paid') {\r\n            const attributesKey = [{ key: \"detailReport\", value: true }];\r\n            attributeService.saveEntityAttributes(\r\n              { entityType: 'ASSET', id: measurementID },\r\n              \"SERVER_SCOPE\",\r\n              attributesKey\r\n            ).subscribe();\r\n          }\r\n        })\r\n        .catch(error => {\r\n          console.error('Error fetching session data:', error);\r\n        });\r\n    } \r\n    // Otherwise check for Stripe invoice\r\n    else if (invoiceIdAttr && stripeSecretKey) {\r\n      let invoiceId = invoiceIdAttr.value;\r\n      fetch(`https://api.stripe.com/v1/invoices/${invoiceId}`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Authorization': 'Bearer ' + stripeSecretKey\r\n        }\r\n      })\r\n        .then(response => response.json())\r\n        .then(invoiceData => {\r\n          if (invoiceData.status === 'paid') {\r\n            const attributesKey = [{ key: \"detailReport\", value: true }];\r\n            attributeService.saveEntityAttributes(\r\n              { entityType: 'ASSET', id: measurementID },\r\n              \"SERVER_SCOPE\",\r\n              attributesKey\r\n            ).subscribe();\r\n          }\r\n        })\r\n        .catch(error => {\r\n          console.error('Error fetching invoice data:', error);\r\n        });\r\n    }\r\n  }\r\n}*/\r\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\" fxLayoutAlign=\"stretch\" fxLayoutGap=\"0px\">' + \r\n          (projectSelected \r\n            ? ('<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"measurements_card_proj\"></tb-dashboard-state>') \r\n            : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"projects_card\"></tb-dashboard-state>') +\r\n       '</div>';",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n.main-layout .header {\n    height: 60px;\n    margin: 4px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n.main-layout .tb-mat-20 {\n    width: 1px;\n    height: 2px;\n    margin: 2px;\n}\n\n.button-margin-top {\n    margin-top: 10px; \n}\n\n\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 12px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedProject'] = null;\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "116515c2-d9bd-80b6-7a34-97373a802806"
              },
              {
                "name": "add-Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addMeasurementFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 800px;\">\r\n\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Add Measurement</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-form-field class=\"mat-block\">\r\n      <mat-label>Measurement</mat-label>\r\n      <mat-select formControlName=\"Measurement\" required>\r\n        <mat-select-trigger>\r\n          <div class=\"Measurement-item\" fxLayout=\"row\">\r\n            <div fxLayout=\"column\" fxFlex>\r\n              <div>{{addMeasurementFormGroup.get('Measurement').value?.label}}</div>\r\n              <div class=\"Measurement-name\">{{addMeasurementFormGroup.get('Measurement').value?.name}}</div>\r\n            </div>\r\n            <div class=\"Measurement-type\">{{addMeasurementFormGroup.get('Measurement').value?.type}}</div>\r\n          </div>\r\n        </mat-select-trigger>\r\n        <mat-option *ngFor=\"let Measurement of availableMeasurement\" [value]=\"Measurement\">\r\n          <div class=\"Measurement-item\" fxLayout=\"row\">\r\n            <div fxLayout=\"column\" fxFlex>\r\n              <div>{{Measurement?.label}}</div>\r\n              <div class=\"Measurement-name\">{{Measurement?.name}}</div>\r\n            </div>\r\n            <div class=\"Measurement-type\">{{Measurement?.type}}</div>\r\n          </div>\r\n          <mat-divider></mat-divider>\r\n        </mat-option>\r\n        <mat-option *ngIf=\"!availableMeasurement?.length\" disabled [value]=\"null\">\r\n          <div class=\"Measurement-item\">No Measurements available</div>\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"addMeasurementFormGroup.get('Measurement').hasError('required')\">\r\n        Measurement is required.\r\n      </mat-error>\r\n    </mat-form-field>\r\n\r\n    <mat-form-field class=\"mat-block\">\r\n      <mat-label>Label</mat-label>\r\n      <input matInput formControlName=\"label\">\r\n      <mat-error *ngIf=\"addMeasurementFormGroup.get('label').hasError('required')\">\r\n        Measurement label is required.\r\n      </mat-error>\r\n    </mat-form-field>\r\n\r\n    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n      <button mat-button color=\"primary\"\r\n              type=\"button\"\r\n              [disabled]=\"(isLoading$ | async)\"\r\n              (click)=\"cancel()\" cdkFocusInitial>\r\n        Cancel\r\n      </button>\r\n      <button mat-button color=\"primary\" type=\"submit\">\r\n        Save\r\n      </button>\r\n    </div>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\n\r\nif (additionalParams.source === \"replace Measurement\") {\r\n    if (additionalParams.choice === true) {\r\n        openAddMeasurementDialog();\r\n    } else {\r\n        // Handle other cases if needed\r\n    }\r\n} else if (additionalParams.source !== \"replace Measurement\") {\r\n    openAddMeasurementDialog();\r\n}\r\n\r\nfunction openAddMeasurementDialog() {\r\n    customDialog.customDialog(htmlTemplate, AddMeasurementDialogController).subscribe();\r\n}\r\n\r\nfunction AddMeasurementDialogController(instance) {\r\n    let vm = instance;\r\n\r\n    vm.addMeasurementFormGroup = vm.fb.group({\r\n        Measurement: [null, [vm.validators.required]],\r\n        label: [{ value: null, disabled: true }]\r\n    });\r\n\r\n    vm.addMeasurementFormGroup.get('Measurement').valueChanges.subscribe((Measurement) => {\r\n        vm.addMeasurementFormGroup.get('label').patchValue(Measurement.label, { emitEvent: false });\r\n        vm.addMeasurementFormGroup.get('label').enable({ emitEvent: false });\r\n        vm.addMeasurementFormGroup.get('label').updateValueAndValidity({ onlySelf: true });\r\n    });\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        var ProjectId = widgetContext.stateController.getStateParams().selectedProject.entityId;\r\n        vm.addMeasurementFormGroup.markAsPristine();\r\n        var Measurement = vm.addMeasurementFormGroup.value.Measurement;\r\n        var label = vm.addMeasurementFormGroup.value.label;\r\n        var MeasurementId = Measurement.MeasurementId;\r\n        \r\n        widgetContext.rxjs.forkJoin([\r\n            entityGroupService.removeEntityFromEntityGroup(vm.unassignedMeasurementGroup.id.id, MeasurementId.id),\r\n            saveMeasurementToProjectRelation(ProjectId, MeasurementId),\r\n            updateMeasurementLabel(Measurement, label)\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedMeasurementGroup = null;\r\n        vm.availableMeasurement = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'ASSET').subscribe((entityGroups) => {\r\n            vm.unassignedMeasurementGroup = entityGroups.find(group => group.name === 'Unassigned Measurement');\r\n            if (vm.unassignedMeasurementGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'ASSET',\r\n                        entityGroup: vm.unassignedMeasurementGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    vm.availableMeasurement = data.data.map((entityData) => {\r\n                        return {\r\n                            MeasurementId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                });\r\n            }\r\n            if (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Measurement\") {\r\n                checkAdditionalParams();\r\n            }\r\n        });\r\n    }\r\n\r\n    function saveMeasurementToProjectRelation(ProjectId, MeasurementId) {\r\n        var relation = {\r\n            from: ProjectId,\r\n            to: MeasurementId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Owns'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function updateMeasurementLabel(Measurement, label) {\r\n        if (Measurement.label !== label) {\r\n            return deviceService.getDevice(Measurement.MeasurementId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origMeasurement) => {\r\n                    origMeasurement.label = label;\r\n                    return deviceService.saveDevice(origMeasurement);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableMeasurement = vm.availableMeasurement.find(Measurement => Measurement.name === additionalParams.code);\r\n        const matchingAssignedMeasurement = vm.assignedMeasurements.find(Measurement => Measurement.name === additionalParams.code);\r\n\r\n        if (!matchingAvailableMeasurement && !matchingAssignedMeasurement) {\r\n            widgetContext.dialogs.alert(\"Measurement doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedMeasurement && !matchingAvailableMeasurement) {\r\n            getProject(additionalParams.code);\r\n        }\r\n        if (matchingAvailableMeasurement && matchingAssignedMeasurement) {\r\n            vm.addMeasurementFormGroup.patchValue({ Measurement: matchingAvailableMeasurement }, { emitEvent: false });\r\n            vm.addMeasurementFormGroup.get('Measurement').markAsDirty();\r\n            vm.addMeasurementFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('mat-select[formControlName=\"Measurement\"]');\r\n                if (selectElement) {\r\n                    selectElement.dispatchEvent(new Event('change'));\r\n                }\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n    \r\n    function getProject(code) {\r\n        vm.MeasurementEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToProject = null;\r\n\r\n        deviceService.findByName(code)\r\n            .pipe(\r\n                widgetContext.rxjs.map((origMeasurement) => {\r\n                    vm.MeasurementEntityId = origMeasurement.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.MeasurementEntityId, 'entityType': 'ASSET' }).pipe(\r\n                    widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations).pipe(\r\n                        widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToProject = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-Measurement\");\r\n                        let params = {\r\n                            \"Project\": vm.assignedToProject,\r\n                            \"Measurement\": vm.MeasurementEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1adbc23d-7aa4-6282-d555-61ab94b71e7e"
              },
              {
                "name": "Measurements",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Measurements",
                "setEntityId": true,
                "stateEntityParamName": "selectedProject",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f921410a-47b7-5884-1c63-d010a39064a4"
              },
              {
                "name": "delete-Project",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenDeleteDoktorkitDialog();\n\nfunction openDeleteDoktorkitDialog() {\n  var title = 'Are you sure you want to delete the Doktorkit ' + entityName + '?';\n  var content = 'Be careful, after the confirmation, the Doktorkit will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteDoktorkit();\n      }\n    }\n  );\n}\n\nfunction deleteDoktorkit() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteDoktorkitToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Doktorkit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Doktorkit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDoktorkitToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1af63269-0a95-b82e-0703-86bd8daf9356"
              },
              {
                "name": "get-location",
                "icon": "location_on",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "getLocation",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Get location action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to get phone location', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processLocationFunction": "// Function body to process current location of the phone. \n// - latitude - phone location latitude\n// - longitude - phone location longitude\nlet $injector = widgetContext.$scope.$injector;\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\n//showLocationDialog('Location', latitude, longitude);\nsaveEntityLocationAttributes('latitude', 'longitude', latitude, longitude);\nfunction getSelectedKitId() {\n    let stateParams = widgetContext.stateController.getStateParams();\n    return stateParams.selectedDoktorkit.entityId;\n}\n\nfunction saveEntityLocationAttributes(latitudeAttributeName, longitudeAttributeName, latitude, longitude) {\n    let entityId = getSelectedKitId();\n    if (entityId) {\n        let attributes = [\n            { key: \"latitude\", value: latitude },\n            { key: \"longitude\", value: longitude }\n        ];\n        attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributes).subscribe(\n        widgetContext.dialogs.alert('Location attributes saved!\\nLatitude: ' + latitude + '\\nLongitude: ' + longitude),\n           function() {\n               widgetContext.showSuccessToast('Location attributes saved!');\n           },\n           function(error) {\n               widgetContext.dialogs.alert('Location attributes save failed', JSON.stringify(error));\n           }\n        );\n    }\n}\n\n\nfunction showLocationDialog(title, latitude, longitude) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Latitude: '+latitude+'<br>Longitude: ' + longitude).subscribe();\n    }, 100);\n}"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "94c2e448-3356-0d9d-d976-d11a0ac2165c"
              }
            ],
            "headerButton": []
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "d5ffcdcd-a934-115a-cf8b-641b03bea108",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "5c924b33-7327-d315-63e1-ba0e17e491d1": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "filterId": null,
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "var MeasurementState;\r\nif (data && data.length && data[0]['entityId']) {\r\n    MeasurementState = true;\r\n} else {\r\n    MeasurementState = false;\r\n}\r\n\r\nvar typeSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24\" viewBox=\"0 -960 960 960\" width=\"24\"><path d=\"M160-80q-33 0-56.5-23.5T80-160v-480q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v480q0 33-23.5 56.5T800-80H160Zm240-640h160v-80H400v80Zm40 360v120h80v-120h120v-80H520v-120h-80v120H320v80h120Z\"/></svg>';\r\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\r\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\r\n\r\n// Updated header with smaller size and no gap\r\nvar header = '<div class=\"header\" fxLayout=\"column\" fxLayoutAlign=\"start stretch\" style=\"height: 40px; padding: 5px 0;\">' + \r\n                  '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><button id=\"go-back\" matTooltip=\"Go back\" type=\"button\" mat-icon-button><mat-icon>arrow_back</mat-icon></button></div>' +\r\n             '</div>';\r\n\r\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\" fxLayoutAlign=\"stretch\" fxLayoutGap=\"0px\">' + \r\n          (MeasurementState \r\n            ? (header + \r\n               '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"edit_measurements_card\"></tb-dashboard-state>') \r\n            : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"measurements_card\"></tb-dashboard-state>') +\r\n       '</div>';\r\n\r\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n.main-layout .header {\n    height: 100px;\n    margin: 6px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n.main-layout .tb-mat-20 {\n    width: 1px;\n    height: 2px;\n    margin: 2px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 12px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedMeasurement'] = null;\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "116515c2-d9bd-80b6-7a34-97373a802806"
              },
              {
                "name": "add-Kit",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addKitFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 800px;\">\r\n\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Add Kit</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-form-field class=\"mat-block\">\r\n      <mat-label>Kit</mat-label>\r\n      <mat-select formControlName=\"kit\" required>\r\n        <mat-select-trigger>\r\n          <div class=\"kit-item\" fxLayout=\"row\">\r\n            <div fxLayout=\"column\" fxFlex>\r\n              <div>{{addKitFormGroup.get('kit').value?.label}}</div>\r\n              <div class=\"kit-name\">{{addKitFormGroup.get('kit').value?.name}}</div>\r\n            </div>\r\n            <div class=\"kit-type\">{{addKitFormGroup.get('kit').value?.type}}</div>\r\n          </div>\r\n        </mat-select-trigger>\r\n        <mat-option *ngFor=\"let kit of availableKit\" [value]=\"kit\">\r\n          <div class=\"kit-item\" fxLayout=\"row\">\r\n            <div fxLayout=\"column\" fxFlex>\r\n              <div>{{kit?.label}}</div>\r\n              <div class=\"kit-name\">{{kit?.name}}</div>\r\n            </div>\r\n            <div class=\"kit-type\">{{kit?.type}}</div>\r\n          </div>\r\n          <mat-divider></mat-divider>\r\n        </mat-option>\r\n        <mat-option *ngIf=\"!availableKit?.length\" disabled [value]=\"null\">\r\n          <div class=\"kit-item\">No kits available</div>\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"addKitFormGroup.get('kit').hasError('required')\">\r\n        Kit is required.\r\n      </mat-error>\r\n    </mat-form-field>\r\n\r\n    <mat-form-field class=\"mat-block\">\r\n      <mat-label>Label</mat-label>\r\n      <input matInput formControlName=\"label\">\r\n      <mat-error *ngIf=\"addKitFormGroup.get('label').hasError('required')\">\r\n        Kit label is required.\r\n      </mat-error>\r\n    </mat-form-field>\r\n\r\n    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n      <button mat-button color=\"primary\"\r\n              type=\"button\"\r\n              [disabled]=\"(isLoading$ | async)\"\r\n              (click)=\"cancel()\" cdkFocusInitial>\r\n        Cancel\r\n      </button>\r\n      <button mat-button color=\"primary\" type=\"submit\">\r\n        Save\r\n      </button>\r\n    </div>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\n\r\nif (additionalParams.source === \"replace Kit\") {\r\n    if (additionalParams.choice === true) {\r\n        openAddKitDialog();\r\n    } else {\r\n        // Handle other cases if needed\r\n    }\r\n} else if (additionalParams.source !== \"replace Kit\") {\r\n    openAddKitDialog();\r\n}\r\n\r\nfunction openAddKitDialog() {\r\n    customDialog.customDialog(htmlTemplate, AddKitDialogController).subscribe();\r\n}\r\n\r\nfunction AddKitDialogController(instance) {\r\n    let vm = instance;\r\n\r\n    vm.addKitFormGroup = vm.fb.group({\r\n        kit: [null, [vm.validators.required]],\r\n        label: [{ value: null, disabled: true }]\r\n    });\r\n\r\n    vm.addKitFormGroup.get('kit').valueChanges.subscribe((kit) => {\r\n        vm.addKitFormGroup.get('label').patchValue(kit.label, { emitEvent: false });\r\n        vm.addKitFormGroup.get('label').enable({ emitEvent: false });\r\n        vm.addKitFormGroup.get('label').updateValueAndValidity({ onlySelf: true });\r\n    });\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        var MeasurementId = widgetContext.stateController.getStateParams().selectedMeasurement.entityId;\r\n        vm.addKitFormGroup.markAsPristine();\r\n        var kit = vm.addKitFormGroup.value.kit;\r\n        var label = vm.addKitFormGroup.value.label;\r\n        var kitId = kit.kitId;\r\n        \r\n        widgetContext.rxjs.forkJoin([\r\n            entityGroupService.removeEntityFromEntityGroup(vm.unassignedKitGroup.id.id, kitId.id),\r\n            saveKitToMeasurementRelation(MeasurementId, kitId),\r\n            updateKitLabel(kit, label)\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedKitGroup = null;\r\n        vm.availableKit = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'ASSET').subscribe((entityGroups) => {\r\n            vm.unassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n            if (vm.unassignedKitGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'ASSET',\r\n                        entityGroup: vm.unassignedKitGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    vm.availableKit = data.data.map((entityData) => {\r\n                        return {\r\n                            kitId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                });\r\n            }\r\n            if (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Kit\") {\r\n                checkAdditionalParams();\r\n            }\r\n        });\r\n    }\r\n\r\n    function saveKitToMeasurementRelation(MeasurementId, KitId) {\r\n        var relation = {\r\n            from: MeasurementId,\r\n            to: KitId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Owns'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function updateKitLabel(kit, label) {\r\n        if (kit.label !== label) {\r\n            return deviceService.getDevice(kit.kitId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origKit) => {\r\n                    origKit.label = label;\r\n                    return deviceService.saveDevice(origKit);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableKit = vm.availableKit.find(kit => kit.name === additionalParams.code);\r\n        const matchingAssignedKit = vm.assignedKits.find(kit => kit.name === additionalParams.code);\r\n\r\n        if (!matchingAvailableKit && !matchingAssignedKit) {\r\n            widgetContext.dialogs.alert(\"Kit doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedKit && !matchingAvailableKit) {\r\n            getMeasurement(additionalParams.code);\r\n        }\r\n        if (matchingAvailableKit && matchingAssignedKit) {\r\n            vm.addKitFormGroup.patchValue({ kit: matchingAvailableKit }, { emitEvent: false });\r\n            vm.addKitFormGroup.get('kit').markAsDirty();\r\n            vm.addKitFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('mat-select[formControlName=\"kit\"]');\r\n                if (selectElement) {\r\n                    selectElement.dispatchEvent(new Event('change'));\r\n                }\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n    \r\n    function getMeasurement(code) {\r\n        vm.kitEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToMeasurement = null;\r\n\r\n        deviceService.findByName(code)\r\n            .pipe(\r\n                widgetContext.rxjs.map((origKit) => {\r\n                    vm.kitEntityId = origKit.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.kitEntityId, 'entityType': 'ASSET' }).pipe(\r\n                    widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations).pipe(\r\n                        widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToMeasurement = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-kit\");\r\n                        let params = {\r\n                            \"measurement\": vm.assignedToMeasurement,\r\n                            \"kit\": vm.kitEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "c61ba3c6-e65b-ef52-6948-2ead8dc5a2dc"
              },
              {
                "name": "Doktorkits",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkits",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f921410a-47b7-5884-1c63-d010a39064a4"
              },
              {
                "name": "Sensorkits",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Sensorkits",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e4559805-877a-3f46-e336-b23cc1c27407"
              },
              {
                "name": "delete-Measurement",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet customerId;\nlet measurementEntityId = entityId.id;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n\n\nlet doktorkitSearchQuery = {\n  \"parameters\": {\n    \"rootId\": measurementEntityId,\n    \"rootType\": \"ASSET\",\n    \"direction\": \"FROM\",\n    \"relationTypeGroup\": \"COMMON\",\n    \"maxLevel\": 10,\n    \"fetchLastLevelOnly\": false\n  },\n  \"relationType\": \"Owns\",\n  \"assetTypes\": [\n    \"Doktorkit\"\n  ]\n};\n\nassetService.findByQuery(doktorkitSearchQuery).subscribe(doktorkits => {\n        openDeleteMeasurementDialog(doktorkits);\n    });\n\n\nfunction addKitToUnassignedDoktorkits(doktorkits) {\n    return getUnassignedKitGroup(customerId).pipe(\n        widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\n            const addKitObservables = doktorkits.map((item) => {\n                \n                return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, item.id.id);\n            });\n            \n            return widgetContext.rxjs.forkJoin(addKitObservables);\n        })\n    );\n}\nfunction getUnassignedKitGroup(customerId) {\n  return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\n      widgetContext.rxjs.switchMap((entityGroups) => {\n          var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\n          if (UnassignedKitGroup) {\n              return widgetContext.rxjs.of(UnassignedKitGroup);\n          } else {\n              UnassignedKitGroup = {\n                  type: 'ASSET',\n                  name: 'Unassigned Kit',\n                  ownerId: customerId\n              };\n              return entityGroupService.saveEntityGroup(UnassignedKitGroup);\n          }\n      })\n  );\n}\nfunction openDeleteMeasurementDialog(doktorkits) {\n  let title = 'Are you sure you want to delete the Measurement ' + entityName + '?';\n  let content = 'Be careful, after the confirmation, the Measurement will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteMeasurement(doktorkits);\n      }\n    }\n  );\n}\n\nfunction deleteMeasurement(doktorkits) {\n  addKitToUnassignedDoktorkits(doktorkits).subscribe();\n  let relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      let removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  let removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteMeasurementToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  let unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Measurement Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Measurement Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteMeasurementToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1af63269-0a95-b82e-0703-86bd8daf9356"
              },
              {
                "name": "get-location",
                "icon": "location_on",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "getLocation",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Get location action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to get phone location', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processLocationFunction": "// Function body to process current location of the phone. \n// - latitude - phone location latitude\n// - longitude - phone location longitude\nlet $injector = widgetContext.$scope.$injector;\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\n//showLocationDialog('Location', latitude, longitude);\nsaveEntityLocationAttributes('latitude', 'longitude', latitude, longitude);\nfunction getSelectedKitId() {\n    let stateParams = widgetContext.stateController.getStateParams();\n    return stateParams.selectedDoktorkit.entityId;\n}\n\nfunction saveEntityLocationAttributes(latitudeAttributeName, longitudeAttributeName, latitude, longitude) {\n    let entityId = getSelectedKitId();\n    if (entityId) {\n        let attributes = [\n            { key: \"latitude\", value: latitude },\n            { key: \"longitude\", value: longitude }\n        ];\n        attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributes).subscribe(\n        widgetContext.dialogs.alert('Location attributes saved!\\nLatitude: ' + latitude + '\\nLongitude: ' + longitude),\n           function() {\n               widgetContext.showSuccessToast('Location attributes saved!');\n           },\n           function(error) {\n               widgetContext.dialogs.alert('Location attributes save failed', JSON.stringify(error));\n           }\n        );\n    }\n}\n\n\nfunction showLocationDialog(title, latitude, longitude) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Latitude: '+latitude+'<br>Longitude: ' + longitude).subscribe();\n    }, 100);\n}"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "94c2e448-3356-0d9d-d976-d11a0ac2165c"
              }
            ],
            "headerButton": []
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "5c924b33-7327-d315-63e1-ba0e17e491d1",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "5b9ff680-3af1-b4b0-9c84-457d9fd4cce8": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\n     <div fxLayout=\"row\" style=\"width: 100%; height: 60px;\" fxLayoutAlign=\"center start\">\n        <h5 fxFlex class=\"market-title\">{{'custom.diagnostics.measurements.title' | translate}}</h5>\n        <button id=\"add-Measurement\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">add</mat-icon><span>{{'custom.projects.measurements.add-measurement' | translate}}</span></button>\n     </div>\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"measurements_map\"></tb-dashboard-state>\n    </div>\n</div>",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-container .tb-widget .tb-multiple-input {\n    background-color: #FAFAFA;\n    border-radius: 4px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .input-field {\n    padding-right: 30px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input mat-slide-toggle {\n    margin-top: 15px !important;\n    margin-bottom: 0 !important;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-slide-toggle-content {\n    width: 120px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-bar {\n    width: 42px;\n    height: 24px;\n    border-radius: 16px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb-container {\n    top: 2px;\n    left: 2px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-thumb-container {\n    transform: translate3d(18px, 0, 0);\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb {\n    background-color: #fafafa;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-bar {\n    background-color: #F2994A;\n}\n",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "add-Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addMeasurementFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 350px;\">\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\n    <h2>Add Measurement</h2>\n    <span fxFlex></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content fxLayout=\"column\">\n    <div fxLayout=\"column\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">\n        <mat-form-field fxFlex class=\"mat-block\">\n            <mat-label>Measurement title</mat-label>\n            <input matInput formControlName=\"name\" required readonly>\n            <mat-error *ngIf=\"addMeasurementFormGroup.get('name').hasError('required')\">\n              Measurement title is required.\n            </mat-error>\n        </mat-form-field>\n        <mat-form-field fxFlex class=\"mat-block\">\n            <mat-label>Measurement alias</mat-label>\n            <input matInput formControlName=\"locationName\">\n            <mat-error *ngIf=\"addMeasurementFormGroup.get('locationName').hasError('required')\">\n              Measurement alias is required.\n            </mat-error>\n        </mat-form-field>\n        <mat-form-field fxFlex class=\"mat-block\">\n            <mat-label>Installation type</mat-label>\n            <mat-select formControlName=\"installationType\">\n            <mat-option value=\"heating\" selected>Heating</mat-option>\n            <mat-option value=\"cooling\">Cooling</mat-option>\n            </mat-select>\n            <mat-error *ngIf=\"addMeasurementFormGroup.get('installationType').hasError('required')\">\n            Installation type is required.\n            </mat-error>\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      Cancel\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addMeasurementFormGroup.invalid || !addMeasurementFormGroup.dirty\">\n      Add Measurement\n    </button>\n  </div>\n</form>\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\n\nlet nextMeasurementId = 0;\n\nlet customerName = widgetContext.stateController.getStateParams().entityName;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n/*console.log(\"Customer EntityID: \" + customerId.id);*/\n\nlet projectEntityId = widgetContext.stateController.getStateParams().selectedProject.entityId.id;\n/*console.log(\"Project EntityID: \" + projectEntityId);*/\n\nlet assetSearchQuery = {\n  \"parameters\": {\n    \"rootId\": projectEntityId,\n    \"rootType\": \"ASSET\",\n    \"direction\": \"FROM\",\n    \"relationTypeGroup\": \"COMMON\",\n    \"maxLevel\": 10,\n    \"fetchLastLevelOnly\": false\n  },\n  \"relationType\": \"Owns\",\n  \"assetTypes\": [\n    \"Measurement\"\n  ]\n};\nassetService.findByQuery(assetSearchQuery).subscribe(measurements => {\n/*    console.log(measurements);*/\n    nextMeasurementId = getLastMeasurementId(measurements);\n/*    console.log(\"Next Measurement: \" + nextMeasurementId);*/\n    attributeService.getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName']).subscribe(attributes => {\n        shortNameAttr = attributes.find(attr => attr.key === 'shortName');\n        customerShortName = shortNameAttr ? shortNameAttr.value : customerName;\n        openAddMeasurementDialog();\n    });\n});\n\nfunction getLastMeasurementId(measurements) {\n    let maxNumber = 0;\n    measurements.forEach(item => {\n        const name = item.name;\n        const parts = name.split('_');\n        if (parts.length === 3) {\n            const number = parseInt(parts[2], 10);\n            if (number > maxNumber) {\n                maxNumber = number;\n            }\n        }\n    });\n    const nextMeasurementId = maxNumber + 1;\n    return nextMeasurementId;\n}\n\nfunction openAddMeasurementDialog() {\n    customDialog.customDialog(htmlTemplate,\n        AddMeasurementDialogController).subscribe();\n}\n\nfunction AddMeasurementDialogController(instance) {\n    let vm = instance;\n    let projectName = widgetContext.stateController.getStateParams().selectedProject.entityName;\n    vm.addMeasurementFormGroup = vm.fb.group({\n        name: [projectName + \"_\" + nextMeasurementId, [vm.validators.required]],\n        locationName: ['', [vm.validators.required]],\n        installationType: ['heating', [vm.validators.required]]\n    });\n\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n\n    vm.save = function() {\n        const stateParams = widgetContext\n            .stateController.getStateParams();\n        var customerId;\n        var projectId;\n        projectId = {\n            id: (stateParams.selectedProject &&\n                    stateParams.selectedProject\n                    .entityId && stateParams\n                    .selectedProject.entityId.id) ?\n                stateParams.selectedProject.entityId\n                .id : '',\n            entityType: 'ASSET'\n        };\n        console.log(JSON.stringify(projectId));\n        if (widgetContext.currentUser.authority ===\n            'TENANT_ADMIN') {\n            customerId = widgetContext.stateController\n                .getStateParams().entityId;\n        } else {\n            customerId = {\n                id: widgetContext.currentUser\n                    .customerId,\n                entityType: 'CUSTOMER'\n            };\n        }\n        vm.addMeasurementFormGroup.markAsPristine();\n        saveMeasurementObservable(customerId).subscribe(\n            function(Measurement) {\n                const observables = [\n                    saveCustomerToMeasurementRelation(\n                        customerId, Measurement\n                        .id),\n                    saveAttributes(Measurement\n                        .id)\n                ];\n\n                // Add saveProjectToMeasurementRelation to observables if projectId is not empty\n                if (projectId.id !== \"\") {\n                    observables.push(\n                        saveProjectToMeasurementRelation(\n                            projectId,\n                            Measurement.id));\n                }\n                widgetContext.rxjs.forkJoin(observables).subscribe(\n                    function() {\n                        var params =\n                            widgetContext\n                            .stateController\n                            .getStateParams();\n                        var selectedMeasurement =\n                            params[\n                                'selectedMeasurement'\n                                ];\n                        params[\n                            'selectedMeasurement'] = {\n                            entityId: Measurement\n                                .id,\n                            entityName: Measurement\n                                .name,\n                            entityLabel: ''\n                        };\n                        widgetContext\n                            .updateAliases();\n                        vm.dialogRef.close(\n                        null);\n                    }\n                );\n            }\n        );\n    };\n\n    function saveMeasurementObservable(customerId) {\n        return getMeasurementsGroup(customerId).pipe(\n            widgetContext.rxjs.switchMap((\n                MeasurementsGroup) => {\n                const formValues = vm\n                    .addMeasurementFormGroup.value;\n                let Measurement = {\n                    name: formValues.name,\n                    type: 'Measurement',\n                    customerId: customerId\n                };\n                return assetService.saveAsset(\n                    Measurement,\n                    MeasurementsGroup.id.id)\n            })\n        );\n    }\n\n    function getMeasurementsGroup(customerId) {\n        return entityGroupService.getEntityGroupsByOwnerId(\n            customerId.entityType, customerId.id,\n            'ASSET').pipe(\n            widgetContext.rxjs.switchMap((\n                entityGroups) => {\n                    var MeasurementsGroup = entityGroups\n                        .find(group => group.name ===\n                            'Measurements');\n                    if (MeasurementsGroup) {\n                        return widgetContext.rxjs.of(\n                            MeasurementsGroup);\n                    } else {\n                        MeasurementsGroup = {\n                            type: 'ASSET',\n                            name: 'Measurements',\n                            ownerId: customerId\n                        };\n                        return entityGroupService\n                            .saveEntityGroup(\n                                MeasurementsGroup);\n                    }\n                })\n        );\n    }\n\n    function saveCustomerToMeasurementRelation(customerId,\n        MeasurementId) {\n        var relation = {\n            from: customerId,\n            to: MeasurementId,\n            typeGroup: 'COMMON',\n            type: 'Owns'\n        };\n        return entityRelationService.saveRelation(relation);\n    }\n\n    function saveProjectToMeasurementRelation(projectId,\n        MeasurementId) {\n        var relation = {\n            from: projectId,\n            to: MeasurementId,\n            typeGroup: 'COMMON',\n            type: 'Owns'\n        };\n        return entityRelationService.saveRelation(relation);\n    }\n\n    function saveAttributes(entityId) {\n        const formValues = vm.addMeasurementFormGroup.value;\n        let attributesArray = [{\n                key: 'latitude',\n                value: 48.1406022\n            },\n            {\n                key: 'longitude',\n                value: 16.2932688\n            },\n            {\n                key: 'address',\n                value: 'N/A'\n            },\n            {\n                key: 'installationType',\n                value: formValues.installationType\n            },\n            {\n                key: 'locationName',\n                value: formValues.locationName\n            },\n            {\n                key: 'state',\n                value: 'normal' // normal, minor, major, critical\n            },            \n            {\n                key: 'progress',\n                value: 'in preparation' // in preparation, active, finished, aborted\n            }, \n            {\n                key: 'active',\n                value: 'true'\n            },\n            {\n                key: 'units',\n                value: 'metric'\n            },\n            {\n                key: 'floorplan',\n                value: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCEtLSBDcmVhdGVkIHdpdGggSW5rc2NhcGUgKGh0dHA6Ly93d3cuaW5rc2NhcGUub3JnLykgLS0+Cjxzdmcgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc5LjM3NSA3OS4zNzUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiA8cmVjdCB4PSIyLjcwMTkiIHk9IjIuNzAxOSIgd2lkdGg9IjczLjk3MSIgaGVpZ2h0PSI3My45NzEiIGZpbGw9IiNmZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9Ii4xMTIxIiBzdHlsZT0icGFpbnQtb3JkZXI6bWFya2VycyBmaWxsIHN0cm9rZSIvPgogPGcgdHJhbnNmb3JtPSJtYXRyaXgoLjI2NDU4IDAgMCAuMjY0NTggMi42MzUgLTIuODgzNCkiIHN0cm9rZS13aWR0aD0iMXB4IiBzdHlsZT0ic2hhcGUtaW5zaWRlOnVybCgjcmVjdDQ4MzYpO3doaXRlLXNwYWNlOnByZSIgYXJpYS1sYWJlbD0iICAgTm8gcGxhbiBjb25maWd1cmVkIj4KICA8cGF0aCBkPSJtMTAxLjY3IDExOC4yOXYyOC40MzhoLTMuNzg5MWwtMTQuMzE2LTIxLjkzNHYyMS45MzRoLTMuNzY5NXYtMjguNDM4aDMuNzY5NWwxNC4zNzUgMjEuOTkydi0yMS45OTJ6Ii8+CiAgPHBhdGggZD0ibTEwNi44MyAxMzUuOTVxMC00LjU4OTggMi41NzgxLTcuNjU2MiAyLjU3ODEtMy4wODU5IDcuMDExNy0zLjA4NTl0Ny4wMTE3IDMuMDI3M3EyLjU3ODEgMy4wMDc4IDIuNjM2NyA3LjUxOTV2MC42NDQ1M3EwIDQuNTg5OC0yLjU5NzcgNy42NTYyLTIuNTc4MSAzLjA2NjQtNy4wMTE3IDMuMDY2NC00LjQ1MzEgMC03LjA1MDgtMy4wNjY0LTIuNTc4MS0zLjA2NjQtMi41NzgxLTcuNjU2MnptMy42MTMzIDAuNDQ5MjJxMCAzLjE0NDUgMS40ODQ0IDUuNDQ5MiAxLjUwMzkgMi4zMDQ3IDQuNTMxMiAyLjMwNDcgMi45NDkyIDAgNC40NTMxLTIuMjY1NiAxLjUwMzktMi4yODUyIDEuNTIzNC01LjQyOTd2LTAuNTA3ODFxMC0zLjEwNTUtMS41MDM5LTUuNDI5Ny0xLjUwMzktMi4zNDM4LTQuNTExNy0yLjM0MzgtMi45ODgzIDAtNC40OTIyIDIuMzQzOC0xLjQ4NDQgMi4zMjQyLTEuNDg0NCA1LjQyOTd6Ii8+CiAgPHBhdGggZD0ibTE1MC4xNyAxNDcuMTJxLTMuODA4NiAwLTYuMDM1Mi0yLjQ0MTR2MTAuMTc2aC0zLjYzMjh2LTI5LjI1OGgzLjMyMDNsMC4xNzU3OCAyLjMyNDJxMi4yMjY2LTIuNzE0OCA2LjExMzMtMi43MTQ4IDQuMDAzOSAwIDYuMTMyOCAyLjk2ODggMi4xMjg5IDIuOTY4OCAyLjEyODkgNy44MTI1djAuNDEwMTZxMCA0LjYyODktMi4xNDg0IDcuNjc1OC0yLjEyODkgMy4wNDY5LTYuMDU0NyAzLjA0Njl6bS0xLjExMzMtMTguODY3cS0zLjI4MTIgMC00LjkyMTkgMi45MTAydjEwLjExN3ExLjY2MDIgMi44NzExIDQuOTYwOSAyLjg3MTEgMi45Mjk3IDAgNC4yNzczLTIuMzA0NyAxLjM2NzItMi4zMDQ3IDEuMzY3Mi01LjQ0OTJ2LTAuNDEwMTZxMC0zLjE0NDUtMS4zNjcyLTUuNDI5Ny0xLjM0NzYtMi4zMDQ3LTQuMzE2NC0yLjMwNDd6Ii8+CiAgPHBhdGggZD0ibTE2Ni45MSAxMTYuNzN2MzBoLTMuNjMyOHYtMzB6Ii8+CiAgPHBhdGggZD0ibTE4NS43NSAxNDYuNzNxLTAuMzUxNTctMC43NjE3Mi0wLjUwNzgyLTIuMjI2Ni0xLjAxNTYgMS4wNzQyLTIuNTM5MSAxLjg1NTUtMS41MjM0IDAuNzYxNzItMy40NzY2IDAuNzYxNzItMy4yNDIyIDAtNS4xOTUzLTEuODE2NC0xLjk1MzEtMS44MTY0LTEuOTUzMS00LjQ1MzEgMC0zLjM5ODQgMi41NzgxLTUuMTU2MiAyLjU3ODEtMS43NzczIDYuOTMzNi0xLjc3NzNoMy41NzQydi0xLjY3OTdxMC0xLjg3NS0xLjEzMjgtMi45ODgzLTEuMTEzMy0xLjEzMjgtMy4zMjAzLTEuMTMyOC0yLjA1MDggMC0zLjMyMDMgMS4wMTU2LTEuMjUgMC45OTYxLTEuMjUgMi4zMjQyaC0zLjYxMzNxMC0yLjI2NTYgMi4yODUyLTQuMjU3OCAyLjI4NTItMS45OTIyIDYuMTEzMy0xLjk5MjIgMy40Mzc1IDAgNS42NDQ1IDEuNzU3OCAyLjIwNyAxLjc1NzggMi4yMDcgNS4zMTI1djkuNDkyMnEwIDIuOTI5NyAwLjc0MjE5IDQuNjQ4NHYwLjMxMjV6bS01Ljk5NjEtMi43NzM0cTEuOTUzMSAwIDMuMzc4OS0wLjk3NjU2IDEuNDQ1My0wLjk3NjU2IDIuMDMxMi0yLjE2OHYtNC4zNTU1aC0zLjM1OTRxLTYuMDkzOCAwLjExNzE5LTYuMDkzOCAzLjkwNjIgMCAxLjUwMzkgMS4wMTU2IDIuNTU4NiAxLjAxNTYgMS4wMzUyIDMuMDI3MyAxLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTIwMy4yMyAxMjguMjVxLTEuNzM4MyAwLTMuMDY2NCAwLjkzNzUtMS4zMjgxIDAuOTM3NS0yLjA4OTggMi40NDE0djE1LjA5OGgtMy42MTMzdi0yMS4xMzNoMy40MThsMC4xMTcxOSAyLjYzNjdxMi40MDIzLTMuMDI3MyA2LjMwODYtMy4wMjczIDMuMTA1NSAwIDQuOTIxOSAxLjczODMgMS44MzU5IDEuNzM4MyAxLjg1NTUgNS44Mzk4djEzLjk0NWgtMy42MzI4di0xMy44ODdxMC0yLjQ4MDUtMS4wOTM4LTMuNTM1Mi0xLjA3NDItMS4wNTQ3LTMuMTI1LTEuMDU0N3oiLz4KICA8cGF0aCBkPSJtNTcuOTQxIDE5NC4xNXExLjkzMzYgMCAzLjM3ODktMS4xNTIzIDEuNDY0OC0xLjE1MjMgMS42MDE2LTIuOTQ5MmgzLjQzNzVxLTAuMTM2NzIgMi44MzItMi41OTc3IDQuOTYwOS0yLjQ2MDkgMi4xMDk0LTUuODIwMyAyLjEwOTQtNC43NjU2IDAtNy4wODk4LTMuMTQ0NS0yLjMwNDctMy4xNDQ1LTIuMzA0Ny03LjQwMjN2LTAuODIwMzFxMC00LjI1NzggMi4zMDQ3LTcuNDAyNCAyLjMyNDItMy4xNDQ1IDcuMDg5OC0zLjE0NDUgMy43MTA5IDAgNS45OTYxIDIuMjA3IDIuMjg1MiAyLjE4NzUgMi40MjE5IDUuNDQ5MmgtMy40Mzc1cS0wLjEzNjcyLTEuOTUzMS0xLjQ4NDQtMy4zMjAzLTEuMzI4MS0xLjM2NzItMy40OTYxLTEuMzY3Mi0yLjIyNjYgMC0zLjQ5NjEgMS4xMzI4LTEuMjUgMS4xMzI4LTEuNzc3MyAyLjg3MTEtMC41MDc4MSAxLjczODMtMC41MDc4MSAzLjU3NDJ2MC44MjAzMXEwIDEuODU1NSAwLjUwNzgxIDMuNTkzOCAwLjUwNzgxIDEuNzM4MyAxLjc1NzggMi44NzExIDEuMjY5NSAxLjExMzMgMy41MTU2IDEuMTEzM3oiLz4KICA8cGF0aCBkPSJtNjkuNDY1IDE4NS45NXEwLTQuNTg5OCAyLjU3ODEtNy42NTYyIDIuNTc4MS0zLjA4NTkgNy4wMTE3LTMuMDg1OSA0LjQzMzYgMCA3LjAxMTcgMy4wMjczIDIuNTc4MSAzLjAwNzggMi42MzY3IDcuNTE5NXYwLjY0NDUzcTAgNC41ODk4LTIuNTk3NyA3LjY1NjItMi41NzgxIDMuMDY2NC03LjAxMTcgMy4wNjY0LTQuNDUzMSAwLTcuMDUwOC0zLjA2NjQtMi41NzgxLTMuMDY2NC0yLjU3ODEtNy42NTYyem0zLjYxMzMgMC40NDkyMnEwIDMuMTQ0NSAxLjQ4NDQgNS40NDkyIDEuNTAzOSAyLjMwNDcgNC41MzEyIDIuMzA0NyAyLjk0OTIgMCA0LjQ1MzEtMi4yNjU2IDEuNTAzOS0yLjI4NTIgMS41MjM0LTUuNDI5N3YtMC41MDc4MXEwLTMuMTA1NS0xLjUwMzktNS40Mjk3LTEuNTAzOS0yLjM0MzgtNC41MTE3LTIuMzQzOC0yLjk4ODMgMC00LjQ5MjIgMi4zNDM4LTEuNDg0NCAyLjMyNDItMS40ODQ0IDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTAyIDE3OC4yNXEtMS43MzgzIDAtMy4wNjY0IDAuOTM3NS0xLjMyODEgMC45Mzc1LTIuMDg5OCAyLjQ0MTR2MTUuMDk4aC0zLjYxMzN2LTIxLjEzM2gzLjQxOGwwLjExNzE5IDIuNjM2N3EyLjQwMjMtMy4wMjczIDYuMzA4Ni0zLjAyNzMgMy4xMDU1IDAgNC45MjE5IDEuNzM4MyAxLjgzNTkgMS43MzgzIDEuODU1NSA1LjgzOTh2MTMuOTQ1aC0zLjYzMjh2LTEzLjg4N3EwLTIuNDgwNS0xLjA5MzgtMy41MzUyLTEuMDc0Mi0xLjA1NDctMy4xMjUtMS4wNTQ3eiIvPgogIDxwYXRoIGQ9Im0xMjQuNDYgMTc4LjM3aC00LjMxNjR2MTguMzU5aC0zLjYxMzN2LTE4LjM1OWgtMy4zMzk4di0yLjc3MzRoMy4zMzk4di0xLjgzNTlxMC0zLjU5MzggMi4wNzAzLTUuNTA3OCAyLjA3MDMtMS45MzM2IDUuNjY0MS0xLjkzMzYgMi4xODc1IDAgNS41MjczIDEuMTkxNGwtMC42MDU0NiAzLjA0NjlxLTIuNTM5MS0wLjk5NjA5LTQuNjY4LTAuOTk2MDktMi4zMjQyIDAtMy4zNTk0IDEuMDU0Ny0xLjAxNTYgMS4wMzUyLTEuMDE1NiAzLjE0NDV2MS44MzU5aDQuMzE2NHptNy4xMDk0LTIuNzczNHYyMS4xMzNoLTMuNjEzM3YtMjEuMTMzeiIvPgogIDxwYXRoIGQ9Im0xNDUuNTIgMjA1LjA3cS0xLjY0MDYgMC00LjAyMzQtMC44MDA3OC0yLjM4MjgtMC44MDA3OC0zLjgwODYtMi44NzExbDEuODk0NS0yLjE0ODRxMi4zNDM4IDIuODUxNiA1LjY2NDEgMi44NTE2IDIuNTU4NiAwIDQuMDgyLTEuNDQ1MyAxLjUyMzQtMS40MjU4IDEuNTIzNC00LjE5OTJ2LTEuODU1NXEtMi4xNDg0IDIuNTE5NS01LjkxOCAyLjUxOTUtMy44MDg2IDAtNi4wNTQ3LTMuMDQ2OS0yLjI0NjEtMy4wNDY5LTIuMjQ2MS03LjY3NTh2LTAuNDEwMTZxMC00Ljg0MzggMi4yMjY2LTcuODEyNSAyLjI0NjEtMi45Njg4IDYuMTEzMy0yLjk2ODggMy44ODY3IDAgNi4wMzUyIDIuNzM0NGwwLjE3NTc4LTIuMzQzOGgzLjI4MTJ2MjAuNjg0cTAgNC4xOTkyLTIuNSA2LjQ4NDQtMi41IDIuMzA0Ny02LjQ0NTMgMi4zMDQ3em0tNS4yNzM0LTE4LjY3MnEwIDMuMTQ0NSAxLjMwODYgNS40MTAyIDEuMzI4MSAyLjI0NjEgNC4yNTc4IDIuMjQ2MSAzLjQzNzUgMCA1LjAzOTEtMy4xMjV2LTkuNjI4OXEtMC42ODM1OS0xLjMwODYtMS44OTQ1LTIuMTY4LTEuMjEwOS0wLjg3ODktMy4xMDU1LTAuODc4OS0yLjk0OTIgMC00LjI3NzMgMi4zMDQ3LTEuMzI4MSAyLjI4NTItMS4zMjgxIDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTczLjA2IDE5Ni43My0wLjA3ODEtMi4wODk4cS0yLjA3MDMgMi40ODA1LTYuMTcxOSAyLjQ4MDUtMy4xMDU1IDAtNS4wMTk1LTEuODM1OS0xLjkxNDEtMS44MzU5LTEuOTE0MS02LjA1NDd2LTEzLjYzM2gzLjYxMzN2MTMuNjcycTAgMi44NTE2IDEuMTkxNCAzLjgyODEgMS4yMTA5IDAuOTU3MDMgMi42OTUzIDAuOTU3MDMgNC4wODIgMCA1LjUwNzgtMy4wNjY0di0xNS4zOTFoMy42MzI4djIxLjEzM3oiLz4KICA8cGF0aCBkPSJtMTkwLjQ0IDE3OC42OHEtMy41MzUyIDAtNC44MjQyIDMuMDQ2OXYxNWgtMy42MTMzdi0yMS4xMzNoMy41MTU2bDAuMDc4MSAyLjQyMTlxMS43MzgzLTIuODEyNSA1LjAxOTUtMi44MTI1IDEuMDE1NiAwIDEuNjAxNiAwLjI3MzQ0bC0wLjAxOTUgMy4zNTk0cS0wLjgwMDc4LTAuMTU2MjUtMS43NTc4LTAuMTU2MjV6Ii8+CiAgPHBhdGggZD0ibTIxMS45MSAxOTMuMDRxLTEuMDM1MiAxLjU2MjUtMi45Mjk3IDIuODMyLTEuODk0NSAxLjI1LTUuMDE5NSAxLjI1LTQuNDE0MSAwLTcuMDcwMy0yLjg3MTEtMi42MzY3LTIuODcxMS0yLjYzNjctNy4zNDM4di0wLjgyMDMxcTAtMy40NTcgMS4zMDg2LTUuODc4OSAxLjMyODEtMi40NDE0IDMuNDM3NS0zLjcxMDkgMi4xMDk0LTEuMjg5MSA0LjQ5MjItMS4yODkxIDQuNTMxMiAwIDYuNjAxNiAyLjk2ODggMi4wODk4IDIuOTQ5MiAyLjA4OTggNy4zODI4djEuNjIxMWgtMTQuMjk3cTAuMDc4MSAyLjkxMDIgMS43MTg4IDQuOTYwOSAxLjY2MDIgMi4wMzEyIDQuNTUwOCAyLjAzMTIgMS45MTQxIDAgMy4yNDIyLTAuNzgxMjUgMS4zMjgxLTAuNzgxMjUgMi4zMjQyLTIuMDg5OHptLTguNDE4LTE0Ljg2M3EtMi4xNDg0IDAtMy42MzI4IDEuNTYyNS0xLjQ4NDQgMS41NjI1LTEuODU1NSA0LjQ5MjJoMTAuNTY2di0wLjI3MzQ0cS0wLjEzNjcyLTIuMTA5NC0xLjIzMDUtMy45NDUzLTEuMDc0Mi0xLjgzNTktMy44NDc3LTEuODM1OXoiLz4KICA8cGF0aCBkPSJtMjMwLjAzIDE5Ni43My0wLjE3NTc4LTIuMjY1NnEtMi4xNjggMi42NTYyLTYuMDM1MiAyLjY1NjItMy43MTA5IDAtNS45OTYxLTMuMDA3OC0yLjI4NTItMy4wMDc4LTIuMzI0Mi03LjU1ODZ2LTAuNTY2NDFxMC00Ljg0MzggMi4yODUyLTcuODEyNSAyLjMwNDctMi45Njg4IDYuMDc0Mi0yLjk2ODggMy43MzA1IDAgNS44NTk0IDIuNXYtMTAuOTc3aDMuNjMyOHYzMHptLTEwLjg5OC0xMC4zMzJxMCAzLjE0NDUgMS4zMjgxIDUuNDEwMiAxLjMyODEgMi4yNDYxIDQuMjU3OCAyLjI0NjEgMy4zNTk0IDAgNS0zLjA2NjR2LTkuNzI2NnEtMS42MjExLTMuMDA3OC00Ljk2MDktMy4wMDc4LTIuOTQ5MiAwLTQuMjk2OSAyLjMwNDctMS4zMjgxIDIuMjg1Mi0xLjMyODEgNS40Mjk3eiIvPgogPC9nPgo8L3N2Zz4K'\n            }\n        ];\n        return attributeService.saveEntityAttributes(\n            entityId, \"SERVER_SCOPE\", attributesArray);\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7cad1c71-0765-4277-32a8-c87808a0c689"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "5b9ff680-3af1-b4b0-9c84-457d9fd4cce8",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "0aca86bb-f602-af18-62ed-998cc968189d": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Measurements",
            "enableSearch": true,
            "enableSelectColumnDisplay": true,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": true,
            "entityNameColumnTitle": "Measurement ID",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Measurements",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f765d469-eafe-c53b-d010-c75a39278cad",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "locationName",
                  "type": "attribute",
                  "label": "Measurement Alias",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "74px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7448728411727017,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "Address",
                  "color": "#2196f3",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0%",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.1345774127559587,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "measurementType",
                  "type": "attribute",
                  "label": "Measurement Type",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.03974158377750392,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "detailReport",
                  "type": "attribute",
                  "label": "Detail Report",
                  "color": "#ffc107",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar detailReport = value;\r\nif (detailReport == 'true') { // all key values here are strings\r\n  color = '#27AE60';\r\n} else {\r\n  color = '#EB5757';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span>';",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.6063070297050241,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "Select Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "updateDashboardState",
                "targetDashboardStateId": "",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "5e50c296-0eac-8841-a69a-1cbbfe04d1c5"
              }
            ],
            "actionCellButton": [
              {
                "name": "Unlock Report",
                "icon": "verified",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" (ngSubmit)=\"checkout()\" class=\"add-entity-form\" [formGroup]=\"addEntityFormGroup\">\r\n    <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n        <h2>Payment Options</h2>\r\n        <span fxFlex></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n            <mat-icon class=\"material-icons\">close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n    <div mat-dialog-content fxLayout=\"column\">\r\n        <div fxLayout=\"row\" fxLayoutAlign=\"center center\" fxLayoutGap=\"32px\">\r\n            <div fxLayout=\"column\">\r\n                <div>Pay by Invoice</div>\r\n                <mat-checkbox [checked]=\"buyInvoice\" (change)=\"onSelectBuyInvoice($event)\"></mat-checkbox>\r\n            </div>\r\n            <div fxLayout=\"column\">\r\n                <div>Credit Card / Alternative Payments</div>\r\n                <mat-checkbox [checked]=\"buyCard\" (change)=\"onSelectBuyCard($event)\"></mat-checkbox>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n        <button mat-button color=\"primary\" type=\"button\" [disabled]=\"(isLoading$ | async)\" (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n        </button>\r\n        <button mat-button mat-raised-button color=\"primary\" type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || (!buyInvoice && !buyCard)\">\r\n            Checkout\r\n        </button>\r\n    </div>\r\n</form>",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "    let $injector = widgetContext.$scope.$injector;\n    let PageLink = widgetContext.pageLink;\n    let customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\n    let assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n    let attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n    let assetProfileService = $injector.get(widgetContext.servicesMap.get('assetProfileService'));\n    let customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\n\n    let tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\n    let stripeSecretKey;\n    let sessionId = '';\n    let products = [];\n    let projectID = entityId.id;\n    let customerId;\n    let customerStripeId;\n    let projectName = '';\n    var url = window.location.href;\n\n    // We'll use this variable to store the required prodType based on measurementType\n    let requiredProdType = null;\n\n    function getQueryParam(param) {\n      const urlParams = new URLSearchParams(window.location.search);\n      return urlParams.get(param);\n    }\n\n    const sessionIdFromUrl = getQueryParam('session_id');\n    if (sessionIdFromUrl) {\n      window.history.replaceState({}, document.title, window.location.pathname);\n      localStorage.removeItem('selectedProjectId');\n      checkPaymentStatus(sessionIdFromUrl, projectID);\n    } else {\n      initialize();\n    }\n\n    function initialize() {\n      // First, fetch the measurementType for our current project (entityId) \n      attributeService.getEntityAttributes(\n        { entityType: 'ASSET', id: projectID },\n        \"SERVER_SCOPE\",\n        [\"measurementType\"]\n      ).subscribe(mtAttributes => {\n        let measurementTypeVal = (mtAttributes && mtAttributes.length && mtAttributes[0].value) ? mtAttributes[0].value : null;\n        \n        // Decide which prodType is needed based on measurementType\n        if (measurementTypeVal === \"ultrasonic\") {\n          requiredProdType = \"detailReportUltrasonic\";\n        } else if (measurementTypeVal === \"loraWan\") {\n          requiredProdType = \"detailReportLoraWan\";\n        } else {\n          requiredProdType = null; \n          // If unknown, you might want to handle it gracefully or default to something else.\n        }\n\n        // Now retrieve standard project info to get customerId, etc.\n        assetService.getAssetInfo(projectID).subscribe(info => {\n          customerId = info.customerId;\n          projectName = info.name || projectID;\n\n          checkSingleProjectStatus(projectID).then(result => {\n            if (result === 'paid') {\n              alert(\"The selected Project already has the report activated.\");\n            } else if (result === 'openInvoice') {\n              alert(\"There is an open invoice for this Project. Please check your email inbox.\");\n            } else {\n              attributeService.getEntityAttributes(customerId, \"SERVER_SCOPE\", ['stripe_id']).subscribe(stripeId => {\n                customerStripeId = stripeId[0].value;\n                attributeService.getEntityAttributes({ entityType: 'TENANT', id: tenantId }, \"SERVER_SCOPE\", ['stripeKey'])\n                  .subscribe(attribute => {\n                    stripeSecretKey = attribute[0].value;\n                    // We'll fetch all potential \"Product\" assets \n                    // and then filter them by the requiredProdType\n                    const pageLink = PageLink(50, 0);\n                    const query = {\n                      parameters: {\n                        rootId: tenantId,\n                        rootType: \"TENANT\",\n                        direction: \"FROM\",\n                        relationTypeGroup: \"COMMON\",\n                        maxLevel: 1073741824,\n                        fetchLastLevelOnly: true\n                      },\n                      relationType: \"Contains\",\n                      assetTypes: [\"Product\"]\n                    };\n\n                    assetService.findByQuery(query).subscribe(assets => {\n                      let filteredProducts = [];\n                      // Filter the returned products by the 'prodType' attribute \n                      // that must match requiredProdType \n                      let productFetches = assets.map(asset => {\n                        return attributeService\n                          .getEntityAttributes(asset.id, \"SERVER_SCOPE\", ['prodType'])\n                          .toPromise()\n                          .then(attributes => {\n                            if (\n                              attributes.length > 0 &&\n                              attributes[0].key === 'prodType' &&\n                              attributes[0].value === requiredProdType\n                            ) {\n                              filteredProducts.push(asset);\n                            }\n                          });\n                      });\n                      Promise.all(productFetches).then(() => {\n                        products = filteredProducts;\n                        openAddEntityDialog();\n                      });\n                    });\n                  });\n              });\n            }\n          }).catch(err => {\n            console.error('Error checking project status:', err);\n            alert('Failed to check project status. Please try again.');\n          });\n        });\n      }, error => {\n        console.error('Failed to fetch measurementType:', error);\n        alert('Unable to determine the measurement type for this Project.');\n      });\n    }\n\n    function openAddEntityDialog() {\n      customDialog.customDialog(htmlTemplate, AddEntityDialogController).subscribe();\n    }\n\n    function AddEntityDialogController(instance) {\n      let vm = instance;\n      vm.products = products;\n      vm.buyInvoice = false;\n      vm.buyCard = false;\n\n      // Minimal FormBuilder usage to keep consistent pattern\n      vm.addEntityFormGroup = vm.fb.group({});\n\n      vm.onSelectBuyInvoice = function(event) {\n        vm.buyInvoice = event.checked;\n        if (vm.buyInvoice) {\n          vm.buyCard = false;\n        }\n      };\n\n      vm.onSelectBuyCard = function(event) {\n        vm.buyCard = event.checked;\n        if (vm.buyCard) {\n          vm.buyInvoice = false;\n        }\n      };\n\n      vm.cancel = function () {\n        vm.dialogRef.close(null);\n      };\n\n      vm.checkout = function () {\n        if (!vm.products.length) {\n          alert(\"No product found for the specified measurement type.\");\n          vm.dialogRef.close(null);\n          return;\n        }\n        // We'll just pick the first product from the filtered list\n        const productId = vm.products[0].id.id;\n        attributeService.getEntityAttributes(\n          { entityType: 'ASSET', id: productId },\n          \"SERVER_SCOPE\",\n          ['price_stripe_id']\n        ).subscribe(attributes => {\n          if (attributes.length > 0 && attributes[0].key === 'price_stripe_id') {\n            const priceId = attributes[0].value;\n            if (vm.buyInvoice) {\n              createInvoiceForOneTimePurchase(priceId, instance);\n            } else if (vm.buyCard) {\n              createCheckoutSession(priceId, instance);\n            } else {\n              alert(\"Please select a payment method.\");\n            }\n          } else {\n            console.error('Price ID not found for the product.');\n            vm.dialogRef.close(null);\n          }\n        });\n      };\n    }\n\n    async function createInvoiceForOneTimePurchase(priceId, instance) {\n      try {\n        const priceResp = await fetch(`https://api.stripe.com/v1/prices/${priceId}`, {\n          method: 'GET',\n          headers: {\n            'Authorization': `Bearer ${stripeSecretKey}`\n          }\n        });\n        if (!priceResp.ok) {\n          throw new Error(`Error fetching price details: ${priceResp.statusText}`);\n        }\n        const priceData = await priceResp.json();\n        const amount = priceData.unit_amount;\n        const currency = priceData.currency;\n\n        let invoiceBody = new URLSearchParams({\n          customer: customerStripeId,\n          auto_advance: 'false',\n          collection_method: 'send_invoice',\n          days_until_due: '14'\n        });\n        const invoiceResp = await fetch('https://api.stripe.com/v1/invoices', {\n          method: 'POST',\n          headers: {\n            'Authorization': `Bearer ${stripeSecretKey}`,\n            'Content-Type': 'application/x-www-form-urlencoded'\n          },\n          body: invoiceBody\n        });\n        if (!invoiceResp.ok) {\n          throw new Error(`Error creating draft invoice: ${invoiceResp.statusText}`);\n        }\n        const invoiceData = await invoiceResp.json();\n\n        let invoiceItemBody = new URLSearchParams({\n          customer: customerStripeId,\n          invoice: invoiceData.id,\n          amount: amount.toString(),\n          currency: currency,\n          description: `One-time purchase for project: ${projectName}`\n        });\n        const invoiceItemResp = await fetch('https://api.stripe.com/v1/invoiceitems', {\n          method: 'POST',\n          headers: {\n            'Authorization': `Bearer ${stripeSecretKey}`,\n            'Content-Type': 'application/x-www-form-urlencoded'\n          },\n          body: invoiceItemBody\n        });\n        if (!invoiceItemResp.ok) {\n          throw new Error(`Error creating invoice item: ${invoiceItemResp.statusText}`);\n        }\n        await invoiceItemResp.json();\n\n        const finalizeResp = await fetch(`https://api.stripe.com/v1/invoices/${invoiceData.id}/finalize`, {\n          method: 'POST',\n          headers: {\n            'Authorization': `Bearer ${stripeSecretKey}`\n          }\n        });\n        if (!finalizeResp.ok) {\n          throw new Error(`Error finalizing invoice: ${finalizeResp.statusText}`);\n        }\n        const finalizedInvoice = await finalizeResp.json();\n\n        const attributes = [\n          { key: \"generalReport\", value: false },\n          { key: \"invoiceId\", value: invoiceData.id }\n        ];\n        attributeService.saveEntityAttributes(\n          { entityType: 'ASSET', id: projectID },\n          \"SERVER_SCOPE\",\n          attributes\n        ).subscribe(\n          () => {\n            alert(\"Invoice created and sent!\");\n            instance.dialogRef.close(null);\n          },\n          (error) => {\n            console.error('Error updating attributes:', error);\n            instance.dialogRef.close(null);\n          }\n        );\n      } catch (err) {\n        console.error(\"Error creating invoice:\", err);\n        alert(\"Failed to create invoice. Please try again.\");\n        instance.dialogRef.close(null);\n      }\n    }\n\n    async function createCheckoutSession(priceId, instance) {\n      try {\n        const priceResponse = await fetch(`https://api.stripe.com/v1/prices/${priceId}`, {\n          method: 'GET',\n          headers: {\n            'Authorization': `Bearer ${stripeSecretKey}`\n          }\n        });\n        if (!priceResponse.ok) {\n          throw new Error(`Error fetching price details: ${priceResponse.statusText}`);\n        }\n        const priceData = await priceResponse.json();\n        const isRecurring = priceData.recurring !== null;\n        const mode = isRecurring ? 'subscription' : 'payment';\n        const successUrl = url;\n        const cancelUrl = url;\n\n        const bodyParams = new URLSearchParams({\n          'success_url': successUrl,\n          'cancel_url': cancelUrl,\n          'payment_method_types[]': 'card',\n          'mode': mode,\n          'customer': customerStripeId\n        });\n        bodyParams.append('line_items[0][price_data][currency]', priceData.currency);\n        bodyParams.append('line_items[0][price_data][unit_amount]', String(priceData.unit_amount));\n        bodyParams.append('line_items[0][price_data][product_data][name]', `One-time purchase for: ${projectName}`);\n        bodyParams.append('line_items[0][quantity]', '1');\n\n        const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {\n          method: 'POST',\n          headers: {\n            'Authorization': `Bearer ${stripeSecretKey}`,\n            'Content-Type': 'application/x-www-form-urlencoded'\n          },\n          body: bodyParams\n        });\n        if (!response.ok) {\n          throw new Error(`Error: ${response.statusText}`);\n        }\n        const data = await response.json();\n        if (data.url) {\n          sessionId = data.id;\n          localStorage.setItem('sessionId', sessionId);\n          await new Promise((resolve, reject) => {\n            attributeService.saveEntityAttributes(\n              { entityType: 'ASSET', id: projectID },\n              \"SERVER_SCOPE\",\n              [{ key: \"sessionId\", value: sessionId }]\n            ).subscribe(\n              () => resolve(),\n              (error) => {\n                console.error('Error saving session ID attribute:', error);\n                reject(error);\n              }\n            );\n          });\n          instance.dialogRef.close(null);\n          window.location.href = data.url;\n        } else {\n          console.error('Checkout session URL not found in response');\n        }\n      } catch (error) {\n        console.error('Error creating checkout session:', error);\n      }\n    }\n\n    async function checkPaymentStatus(sessionId, entityId) {\n      try {\n        if (!stripeSecretKey || !customerStripeId) {\n          await fetchStripeKeysAndCustomerId();\n        }\n        const response = await fetch(`https://api.stripe.com/v1/checkout/sessions/${sessionId}`, {\n          method: 'GET',\n          headers: {\n            'Authorization': `Bearer ${stripeSecretKey}`\n          }\n        });\n        if (!response.ok) {\n          throw new Error(`Error: ${response.statusText}`);\n        }\n        const data = await response.json();\n        if (data.payment_status === 'paid') {\n          alert('Payment completed successfully!');\n          const attributes = [\n            { key: \"generalReport\", value: true }\n          ];\n          attributeService.saveEntityAttributes(\n            { entityType: 'ASSET', id: projectID },\n            \"SERVER_SCOPE\",\n            attributes\n          ).subscribe(\n            () => {},\n            (error) => {\n              console.error('Error saving report attribute:', error);\n            }\n          );\n          return 'paid';\n        } else {\n          alert('Payment was not successful. Please try again.');\n          return data.payment_status;\n        }\n      } catch (error) {\n        console.error('Error checking payment status:', error);\n        return 'error';\n      }\n    }\n\n    async function fetchStripeKeysAndCustomerId() {\n      return new Promise((resolve, reject) => {\n        assetService.getAssetInfo(projectID).subscribe(info => {\n          customerId = info.customerId;\n          projectName = info.name || projectID;\n          attributeService.getEntityAttributes(customerId, \"SERVER_SCOPE\", ['stripe_id']).subscribe(stripeId => {\n            customerStripeId = stripeId[0].value;\n            attributeService.getEntityAttributes({ entityType: 'TENANT', id: tenantId }, \"SERVER_SCOPE\", ['stripeKey']).subscribe(attribute => {\n              stripeSecretKey = attribute[0].value;\n              resolve();\n            }, reject);\n          }, reject);\n        }, reject);\n      });\n    }\n\n    function checkSingleProjectStatus(mId) {\n      return new Promise((resolve, reject) => {\n        attributeService.getEntityAttributes(\n          { entityType: 'ASSET', id: mId },\n          \"SERVER_SCOPE\",\n          ['generalReport','invoiceId','sessionId']\n        ).subscribe(attrs => {\n          let generalReportVal = false;\n          let invoiceIdVal = null;\n          let sessionIdVal = null;\n          attrs.forEach(a => {\n            if (a.key === 'generalReport') generalReportVal = a.value;\n            if (a.key === 'invoiceId') invoiceIdVal = a.value;\n            if (a.key === 'sessionId') sessionIdVal = a.value;\n          });\n          if (generalReportVal === true) {\n            resolve(\"paid\");\n          } else {\n            if (sessionIdVal) {\n              checkStripeSessionPaid(sessionIdVal).then(isSessionPaid => {\n                if (isSessionPaid) {\n                  resolve(\"paid\");\n                } else if (invoiceIdVal) {\n                  checkStripeInvoice(invoiceIdVal).then(invStatus => {\n                    if (invStatus === 'paid') resolve(\"paid\");\n                    else if (invStatus === 'open') resolve(\"openInvoice\");\n                    else resolve(\"unpaid\");\n                  }).catch(() => reject());\n                } else {\n                  resolve(\"unpaid\");\n                }\n              }).catch(() => reject());\n            } else if (invoiceIdVal) {\n              checkStripeInvoice(invoiceIdVal).then(invStatus => {\n                if (invStatus === 'paid') resolve(\"paid\");\n                else if (invStatus === 'open') resolve(\"openInvoice\");\n                else resolve(\"unpaid\");\n              }).catch(() => reject());\n            } else {\n              resolve(\"unpaid\");\n            }\n          }\n        }, err => reject(err));\n      });\n    }\n\n    function checkStripeSessionPaid(sid) {\n      return new Promise((resolve, reject) => {\n        fetchStripeKeysAndCustomerId().then(() => {\n          fetch(`https://api.stripe.com/v1/checkout/sessions/${sid}`, {\n            method: 'GET',\n            headers: {\n              'Authorization': `Bearer ${stripeSecretKey}`\n            }\n          })\n            .then(r => r.json())\n            .then(d => {\n              if (d.payment_status === 'paid') resolve(true);\n              else resolve(false);\n            })\n            .catch(() => reject());\n        }).catch(() => reject());\n      });\n    }\n\n    function checkStripeInvoice(invoiceIdVal) {\n      return new Promise((resolve, reject) => {\n        fetchStripeKeysAndCustomerId().then(() => {\n          fetch(`https://api.stripe.com/v1/invoices/${invoiceIdVal}`, {\n            method: 'GET',\n            headers: {\n              'Authorization': `Bearer ${stripeSecretKey}`\n            }\n          })\n            .then(r => r.json())\n            .then(d => {\n              if (d.status === 'paid') {\n                resolve('paid');\n              } else if (d.status === 'open' || d.status === 'draft') {\n                resolve('open');\n              } else {\n                resolve(d.status);\n              }\n            })\n            .catch(() => reject());\n        }).catch(() => reject());\n      });\n    }",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "fa035de0-2d8c-9832-0d42-f67856f3e909"
              },
              {
                "name": "Assigned Devices",
                "icon": "medical_services",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "measurement_devices",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "71c478b6-a4b1-e569-e99a-85d5562cc721"
              },
              {
                "name": "Edit Measurement",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"editEntityFormGroup\"\r\n      (ngSubmit)=\"save()\" \r\n      class=\"edit-entity-form max-w-3xl mx-auto\">\r\n    \r\n    <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n        <h2 class=\"text-lg font-semibold\">Edit Measurement</h2>\r\n        <span class=\"flex-1\"></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n            <mat-icon>close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n    <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n\r\n        <!-- First row: Name, Measurement alias -->\r\n        <div class=\"flex w-full gap-2\">\r\n\r\n            <!-- Name (Top-level form control) -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Measurement ID</mat-label>\r\n                <input matInput \r\n                       formControlName=\"entityName\" \r\n                       required>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('entityName')?.hasError('required')\">\r\n                  Name is required.\r\n                </mat-error>\r\n            </mat-form-field>\r\n\r\n            <!-- Measurement alias (Inside 'attributes' child form group) -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\" [formGroup]=\"editEntityFormGroup.controls['attributes']\">\r\n                <mat-label>Measurement Alias</mat-label>\r\n                <input matInput formControlName=\"locationName\">\r\n            </mat-form-field>\r\n        </div>\r\n\r\n        <!-- Second row: Address -->\r\n        <div class=\"flex w-full\">\r\n            <mat-form-field appearance=\"fill\" class=\"w-full\" [formGroup]=\"editEntityFormGroup.controls['attributes']\">\r\n                <mat-label>Address</mat-label>\r\n                <input matInput formControlName=\"address\">\r\n            </mat-form-field>\r\n        </div>\r\n\r\n        <!-- Third row: Installation Type, Measurement Type -->\r\n        <div class=\"flex w-full gap-2\">\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\" [formGroup]=\"editEntityFormGroup.controls['attributes']\">\r\n                            <mat-label>Measurement Type</mat-label>\r\n                            <mat-select formControlName=\"measurementType\" required>\r\n                                <mat-option value=\"ultrasonic\">Ultrasonic</mat-option>\r\n                                <mat-option value=\"loraWan\">LoRaWan</mat-option>\r\n                            </mat-select>\r\n                            <mat-error *ngIf=\"editEntityFormGroup.get('attributes.measurementType')?.hasError('required')\">\r\n                              Measurement type is required.\r\n                            </mat-error>\r\n                        </mat-form-field>\r\n            <!-- HIDE Installation Type if measurementType is 'loraWan' -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\"\r\n                            *ngIf=\"editEntityFormGroup.get('attributes.measurementType')?.value !== 'loraWan'\"\r\n                            [formGroup]=\"editEntityFormGroup.controls['attributes']\">\r\n                <mat-label>Installation Type</mat-label>\r\n                <mat-select formControlName=\"installationType\" required>\r\n                    <mat-option value=\"heating\">Heating</mat-option>\r\n                    <mat-option value=\"cooling\">Cooling</mat-option>\r\n                </mat-select>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('attributes.installationType')?.hasError('required')\">\r\n                  Installation type is required.\r\n                </mat-error>\r\n            </mat-form-field>\r\n\r\n            \r\n        </div>\r\n    </div>\r\n\r\n    <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n        <button mat-button\r\n                color=\"primary\"\r\n                type=\"button\"\r\n                [disabled]=\"(isLoading$ | async)\"\r\n                (click)=\"cancel()\"\r\n                cdkFocusInitial>\r\n            Cancel\r\n        </button>\r\n        <button mat-button\r\n                mat-raised-button\r\n                color=\"primary\"\r\n                type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid\">\r\n            Save\r\n        </button>\r\n    </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.edit-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.edit-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.edit-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.edit-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*.mat-form-field input[disabled] {\n  background-color: #f5f5f5;\n  cursor: not-allowed; \n  color: #9e9e9e;\n  \n}*/",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenEditEntityDialog();\n\nfunction openEditEntityDialog() {\n    customDialog.customDialog(htmlTemplate, EditEntityDialogController).subscribe();\n}\n\nfunction EditEntityDialogController(instance) {\n    let vm = instance;\n    vm.entityName = entityName; \n    vm.attributes = {};\n    vm.entity = {};\n\n    // Build the form group with a nested 'attributes' group\n    vm.editEntityFormGroup = vm.fb.group({\n        entityName: ['', [vm.validators.required]],\n        attributes: vm.fb.group({\n            locationName: [null],\n            address: [null],\n            installationType: [null],\n            measurementType: [null]\n        })\n    });\n\n    getEntityInfo();\n\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n\n    vm.save = function() {\n        // Mark the form as pristine right before saving\n        vm.editEntityFormGroup.markAsPristine();\n\n        // Save both entity main fields and attributes\n        widgetContext.rxjs.forkJoin([\n            saveAttributes(entityId),\n            saveEntity()\n        ]).subscribe(() => {\n            widgetContext.updateAliases();\n            vm.dialogRef.close(null);\n        });\n    };\n\n    function getEntityInfo() {\n        // Retrieve attributes + entity info in parallel\n        widgetContext.rxjs.forkJoin([\n            attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE'),\n            entityService.getEntity(entityId.entityType, entityId.id)\n        ]).subscribe(([attrData, entityData]) => {\n            vm.attributes = {};\n            // Populate vm.attributes from server response\n            for (let i = 0; i < attrData.length; i++) {\n                vm.attributes[attrData[i].key] = attrData[i].value;\n            }\n\n            vm.entity = entityData;\n\n            // Patch form values. \n            // Note that 'attributes' is a nested form group, so we pass an object for it.\n            vm.editEntityFormGroup.patchValue({\n                entityName: vm.entity.name,\n                attributes: {\n                    locationName: vm.attributes.locationName,\n                    address: vm.attributes.address,\n                    installationType: vm.attributes.installationType,\n                    measurementType: vm.attributes.measurementType\n                }\n            }, { emitEvent: false });\n        });\n    }\n\n    function saveEntity() {\n        const formValues = vm.editEntityFormGroup.value;\n        \n        // Always update name & label (ensures \"Save\" works even if no change)\n        vm.entity.name = formValues.entityName;\n\n        if (vm.entityType === 'ASSET') {\n            return assetService.saveAsset(vm.entity);\n        } else if (vm.entityType === 'DEVICE') {\n            return deviceService.saveDevice(vm.entity);\n        }\n        \n        // If some other type, or no changes, return an observable that completes.\n        return widgetContext.rxjs.of([]);\n    }\n\n    function saveAttributes(entityId) {\n        // Compare original vs. new values to only send changed attributes\n        const currentAttributes = vm.attributes;\n        const updatedAttributes = vm.editEntityFormGroup.value.attributes;\n        \n        let attributesArray = [];\n        for (let key in updatedAttributes) {\n            if (updatedAttributes.hasOwnProperty(key)) {\n                if (updatedAttributes[key] !== currentAttributes[key]) {\n                    attributesArray.push({ key: key, value: updatedAttributes[key] });\n                }\n            }\n        }\n\n        if (attributesArray.length > 0) {\n            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n        }\n        return widgetContext.rxjs.of([]);\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "eae3b679-7c47-2acc-0632-24a07f2cc8fd"
              },
              {
                "name": "Delete Measurement",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet customerId;\nlet measurementEntityId = entityId.id;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n\n\nlet doktorkitSearchQuery = {\n  \"parameters\": {\n    \"rootId\": measurementEntityId,\n    \"rootType\": \"ASSET\",\n    \"direction\": \"FROM\",\n    \"relationTypeGroup\": \"COMMON\",\n    \"maxLevel\": 10,\n    \"fetchLastLevelOnly\": false\n  },\n  \"relationType\": \"Owns\",\n  \"assetTypes\": [\n    \"Doktorkit\"\n  ]\n};\n\nassetService.findByQuery(doktorkitSearchQuery).subscribe(doktorkits => {\n        openDeleteMeasurementDialog(doktorkits);\n    });\n\n\nfunction addKitToUnassignedDoktorkits(doktorkits) {\n    return getUnassignedKitGroup(customerId).pipe(\n        widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\n            const addKitObservables = doktorkits.map((item) => {\n                \n                return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, item.id.id);\n            });\n            \n            return widgetContext.rxjs.forkJoin(addKitObservables);\n        })\n    );\n}\nfunction getUnassignedKitGroup(customerId) {\n  return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\n      widgetContext.rxjs.switchMap((entityGroups) => {\n          var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\n          if (UnassignedKitGroup) {\n              return widgetContext.rxjs.of(UnassignedKitGroup);\n          } else {\n              UnassignedKitGroup = {\n                  type: 'ASSET',\n                  name: 'Unassigned Kit',\n                  ownerId: customerId\n              };\n              return entityGroupService.saveEntityGroup(UnassignedKitGroup);\n          }\n      })\n  );\n}\nfunction openDeleteMeasurementDialog(doktorkits) {\n  let title = 'Are you sure you want to delete the Measurement ' + entityName + '?';\n  let content = 'Be careful, after the confirmation, the Measurement will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteMeasurement(doktorkits);\n      }\n    }\n  );\n}\n\nfunction deleteMeasurement(doktorkits) {\n  addKitToUnassignedDoktorkits(doktorkits).subscribe();\n  let relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      let removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  let removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteMeasurementToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  let unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Measurement Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Measurement Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteMeasurementToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "338d9fd7-c752-eb0e-4687-2c2e32ca1a32"
              }
            ],
            "headerButton": [
              {
                "name": "Go-Back",
                "icon": "arrow_back",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nparams['selectedProject'] = null;\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "0e3af36e-58d2-1609-8e1a-f637992cee4e"
              },
              {
                "name": "Add Measurement",
                "icon": "add",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"addMeasurementFormGroup\"\r\n      (ngSubmit)=\"save()\"\r\n      class=\"add-entity-form\"\r\n      style=\"width: 350px;\">\r\n\r\n  <!-- Optional if you're not mixing template-driven forms with reactive forms \r\n       <form #addEntityForm=\"ngForm\"> can be removed if not needed. -->\r\n\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Add Measurement</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <div fxLayout=\"column\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\" fxLayoutGap.xs=\"0\">\r\n\r\n      <!-- Measurement title -->\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>Measurement ID</mat-label>\r\n        <input matInput formControlName=\"name\" required readonly>\r\n        <mat-error *ngIf=\"addMeasurementFormGroup.get('name')?.hasError('required')\">\r\n          Measurement title is required.\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Measurement alias -->\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>Measurement alias</mat-label>\r\n        <input matInput formControlName=\"locationName\">\r\n        <mat-error *ngIf=\"addMeasurementFormGroup.get('locationName')?.hasError('required')\">\r\n          Measurement alias is required.\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Address -->\r\n      <mat-form-field fxFlex class=\"mat-block\">\r\n        <mat-label>Address</mat-label>\r\n        <input matInput formControlName=\"address\">\r\n        <!-- You can add an error check if required for \"address\" -->\r\n      </mat-form-field>\r\n    <!-- Measurement type -->\r\n          <mat-form-field fxFlex class=\"mat-block\">\r\n            <mat-label>Measurement type</mat-label>\r\n            <mat-select formControlName=\"measurementType\" required>\r\n              <mat-option value=\"ultrasonic\">Ultrasonic</mat-option>\r\n              <mat-option value=\"loraWan\">LoRaWan</mat-option>\r\n            </mat-select>\r\n            <mat-error *ngIf=\"addMeasurementFormGroup.get('measurementType')?.hasError('required')\">\r\n              Measurement type is required.\r\n            </mat-error>\r\n          </mat-form-field>\r\n      <!-- Installation type (HIDDEN if measurementType is loraWan) -->\r\n      <mat-form-field fxFlex class=\"mat-block\"\r\n                      *ngIf=\"addMeasurementFormGroup.get('measurementType')?.value !== 'loraWan'\">\r\n        <mat-label>Installation type</mat-label>\r\n        <mat-select formControlName=\"installationType\" required>\r\n          <mat-option value=\"heating\">Heating</mat-option>\r\n          <mat-option value=\"cooling\">Cooling</mat-option>\r\n        </mat-select>\r\n        <mat-error *ngIf=\"addMeasurementFormGroup.get('installationType')?.hasError('required')\">\r\n          Installation type is required.\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n    <button mat-button\r\n            color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\"\r\n            cdkFocusInitial>\r\n      Cancel\r\n    </button>\r\n    <button mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(isLoading$ | async) || addMeasurementFormGroup.invalid || !addMeasurementFormGroup.dirty\">\r\n      Add Measurement\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\n\nlet nextMeasurementId = 0;\nlet longitude;\nlet latitude;\nlet address;\nlet customerName = widgetContext.stateController.getStateParams().entityName;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n/*console.log(\"Customer EntityID: \" + customerId.id);*/\n\nlet projectEntityId = widgetContext.stateController.getStateParams().selectedProject.entityId;\n/*console.log(\"Project EntityID: \" + projectEntityId);*/\n\nlet assetSearchQuery = {\n  \"parameters\": {\n    \"rootId\": projectEntityId.id,\n    \"rootType\": \"ASSET\",\n    \"direction\": \"FROM\",\n    \"relationTypeGroup\": \"COMMON\",\n    \"maxLevel\": 10,\n    \"fetchLastLevelOnly\": false\n  },\n  \"relationType\": \"Owns\",\n  \"assetTypes\": [\n    \"Measurement\"\n  ]\n};\nassetService.findByQuery(assetSearchQuery).subscribe(measurements => {\n/*    console.log(measurements);*/\n    nextMeasurementId = getLastMeasurementId(measurements);\n/*    console.log(\"Next Measurement: \" + nextMeasurementId);*/\n    attributeService.getEntityAttributes(projectEntityId,'SERVER_SCOPE',['longitude','latitude','address']).subscribe(projectatt => {\n        /*console.log(\"projectatt\", projectatt);*/\n        longitude = projectatt[2].value;\n        latitude = projectatt[1].value;\n        address = projectatt[0].value;\n        attributeService.getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName']).subscribe(attributes => {\n            shortNameAttr = attributes.find(attr => attr.key === 'shortName');\n            customerShortName = shortNameAttr ? shortNameAttr.value : customerName;\n            openAddMeasurementDialog();\n        });\n    });\n});\n\nfunction getLastMeasurementId(measurements) {\n    let maxNumber = 0;\n    measurements.forEach(item => {\n        const name = item.name;\n        const parts = name.split('_');\n        if (parts.length === 3) {\n            const number = parseInt(parts[2], 10);\n            if (number > maxNumber) {\n                maxNumber = number;\n            }\n        }\n    });\n    const nextMeasurementId = maxNumber + 1;\n    return nextMeasurementId;\n}\n\nfunction openAddMeasurementDialog() {\n    customDialog.customDialog(htmlTemplate,\n        AddMeasurementDialogController).subscribe();\n}\n\nfunction AddMeasurementDialogController(instance) {\n    let vm = instance;\n    let projectName = widgetContext.stateController.getStateParams().selectedProject.entityName;\n    vm.addMeasurementFormGroup = vm.fb.group({\n        name: [projectName + \"_\" + nextMeasurementId, [vm.validators.required]],\n        locationName: ['', [vm.validators.required]],\n        address: [address, [vm.validators.required]],\n        installationType: ['heating', [vm.validators.required]],\n        measurementType: ['ultrasonic', [vm.validators.required]]\n    });\n\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n\n    vm.save = function() {\n        const stateParams = widgetContext\n            .stateController.getStateParams();\n        var customerId;\n        var projectId;\n        projectId = {\n            id: (stateParams.selectedProject &&\n                    stateParams.selectedProject\n                    .entityId && stateParams\n                    .selectedProject.entityId.id) ?\n                stateParams.selectedProject.entityId\n                .id : '',\n            entityType: 'ASSET'\n        };\n        /*console.log(JSON.stringify(projectId));*/\n        if (widgetContext.currentUser.authority ===\n            'TENANT_ADMIN') {\n            customerId = widgetContext.stateController\n                .getStateParams().entityId;\n        } else {\n            customerId = {\n                id: widgetContext.currentUser\n                    .customerId,\n                entityType: 'CUSTOMER'\n            };\n        }\n        vm.addMeasurementFormGroup.markAsPristine();\n        saveMeasurementObservable(customerId).subscribe(\n            function(Measurement) {\n                const observables = [\n                    saveCustomerToMeasurementRelation(\n                        customerId, Measurement\n                        .id),\n                    saveAttributes(Measurement\n                        .id)\n                ];\n\n                // Add saveProjectToMeasurementRelation to observables if projectId is not empty\n                if (projectId.id !== \"\") {\n                    observables.push(\n                        saveProjectToMeasurementRelation(\n                            projectId,\n                            Measurement.id));\n                }\n                widgetContext.rxjs.forkJoin(observables).subscribe(\n                    function() {\n                        var params =\n                            widgetContext\n                            .stateController\n                            .getStateParams();\n                        var selectedMeasurement =\n                            params[\n                                'selectedMeasurement'\n                                ];\n                        params[\n                            'selectedMeasurement'] = {\n                            entityId: Measurement\n                                .id,\n                            entityName: Measurement\n                                .name,\n                            entityLabel: ''\n                        };\n                        widgetContext\n                            .updateAliases();\n                        vm.dialogRef.close(\n                        null);\n                    }\n                );\n            }\n        );\n    };\n\n    function saveMeasurementObservable(customerId) {\n        return getMeasurementsGroup(customerId).pipe(\n            widgetContext.rxjs.switchMap((\n                MeasurementsGroup) => {\n                const formValues = vm\n                    .addMeasurementFormGroup.value;\n                let Measurement = {\n                    name: formValues.name,\n                    type: 'Measurement',\n                    customerId: customerId\n                };\n                return assetService.saveAsset(\n                    Measurement,\n                    MeasurementsGroup.id.id)\n            })\n        );\n    }\n\n    function getMeasurementsGroup(customerId) {\n        return entityGroupService.getEntityGroupsByOwnerId(\n            customerId.entityType, customerId.id,\n            'ASSET').pipe(\n            widgetContext.rxjs.switchMap((\n                entityGroups) => {\n                    var MeasurementsGroup = entityGroups\n                        .find(group => group.name ===\n                            'Measurements');\n                    if (MeasurementsGroup) {\n                        return widgetContext.rxjs.of(\n                            MeasurementsGroup);\n                    } else {\n                        MeasurementsGroup = {\n                            type: 'ASSET',\n                            name: 'Measurements',\n                            ownerId: customerId\n                        };\n                        return entityGroupService\n                            .saveEntityGroup(\n                                MeasurementsGroup);\n                    }\n                })\n        );\n    }\n\n    function saveCustomerToMeasurementRelation(customerId,\n        MeasurementId) {\n        var relation = {\n            from: customerId,\n            to: MeasurementId,\n            typeGroup: 'COMMON',\n            type: 'Owns'\n        };\n        return entityRelationService.saveRelation(relation);\n    }\n\n    function saveProjectToMeasurementRelation(projectId,\n        MeasurementId) {\n        var relation = {\n            from: projectId,\n            to: MeasurementId,\n            typeGroup: 'COMMON',\n            type: 'Owns'\n        };\n        return entityRelationService.saveRelation(relation);\n    }\n\n    function saveAttributes(entityId) {\n        const formValues = vm.addMeasurementFormGroup.value;\n        let attributesArray = [{\n                key: 'latitude',\n                value: latitude\n            },\n            {\n                key: 'longitude',\n                value: longitude\n            },\n            {\n                key: 'address',\n                value: formValues.address\n            },\n            {\n                key: 'installationType',\n                value: formValues.installationType\n            },\n            {\n                key: 'locationName',\n                value: formValues.locationName\n            },\n            {\n                key: 'measurementType',\n                value: formValues.measurementType\n            },\n            {\n                key: 'state',\n                value: 'normal' // normal, minor, major, critical\n            },            \n            {\n                key: 'progress',\n                value: 'in preparation' // in preparation, active, finished, aborted\n            }, \n            {\n                key: 'active',\n                value: 'true'\n            },\n            {\n                key: 'units',\n                value: 'metric'\n            },\n            {\n                key: 'floorplan',\n                value: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCEtLSBDcmVhdGVkIHdpdGggSW5rc2NhcGUgKGh0dHA6Ly93d3cuaW5rc2NhcGUub3JnLykgLS0+Cjxzdmcgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc5LjM3NSA3OS4zNzUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiA8cmVjdCB4PSIyLjcwMTkiIHk9IjIuNzAxOSIgd2lkdGg9IjczLjk3MSIgaGVpZ2h0PSI3My45NzEiIGZpbGw9IiNmZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9Ii4xMTIxIiBzdHlsZT0icGFpbnQtb3JkZXI6bWFya2VycyBmaWxsIHN0cm9rZSIvPgogPGcgdHJhbnNmb3JtPSJtYXRyaXgoLjI2NDU4IDAgMCAuMjY0NTggMi42MzUgLTIuODgzNCkiIHN0cm9rZS13aWR0aD0iMXB4IiBzdHlsZT0ic2hhcGUtaW5zaWRlOnVybCgjcmVjdDQ4MzYpO3doaXRlLXNwYWNlOnByZSIgYXJpYS1sYWJlbD0iICAgTm8gcGxhbiBjb25maWd1cmVkIj4KICA8cGF0aCBkPSJtMTAxLjY3IDExOC4yOXYyOC40MzhoLTMuNzg5MWwtMTQuMzE2LTIxLjkzNHYyMS45MzRoLTMuNzY5NXYtMjguNDM4aDMuNzY5NWwxNC4zNzUgMjEuOTkydi0yMS45OTJ6Ii8+CiAgPHBhdGggZD0ibTEwNi44MyAxMzUuOTVxMC00LjU4OTggMi41NzgxLTcuNjU2MiAyLjU3ODEtMy4wODU5IDcuMDExNy0zLjA4NTl0Ny4wMTE3IDMuMDI3M3EyLjU3ODEgMy4wMDc4IDIuNjM2NyA3LjUxOTV2MC42NDQ1M3EwIDQuNTg5OC0yLjU5NzcgNy42NTYyLTIuNTc4MSAzLjA2NjQtNy4wMTE3IDMuMDY2NC00LjQ1MzEgMC03LjA1MDgtMy4wNjY0LTIuNTc4MS0zLjA2NjQtMi41NzgxLTcuNjU2MnptMy42MTMzIDAuNDQ5MjJxMCAzLjE0NDUgMS40ODQ0IDUuNDQ5MiAxLjUwMzkgMi4zMDQ3IDQuNTMxMiAyLjMwNDcgMi45NDkyIDAgNC40NTMxLTIuMjY1NiAxLjUwMzktMi4yODUyIDEuNTIzNC01LjQyOTd2LTAuNTA3ODFxMC0zLjEwNTUtMS41MDM5LTUuNDI5Ny0xLjUwMzktMi4zNDM4LTQuNTExNy0yLjM0MzgtMi45ODgzIDAtNC40OTIyIDIuMzQzOC0xLjQ4NDQgMi4zMjQyLTEuNDg0NCA1LjQyOTd6Ii8+CiAgPHBhdGggZD0ibTE1MC4xNyAxNDcuMTJxLTMuODA4NiAwLTYuMDM1Mi0yLjQ0MTR2MTAuMTc2aC0zLjYzMjh2LTI5LjI1OGgzLjMyMDNsMC4xNzU3OCAyLjMyNDJxMi4yMjY2LTIuNzE0OCA2LjExMzMtMi43MTQ4IDQuMDAzOSAwIDYuMTMyOCAyLjk2ODggMi4xMjg5IDIuOTY4OCAyLjEyODkgNy44MTI1djAuNDEwMTZxMCA0LjYyODktMi4xNDg0IDcuNjc1OC0yLjEyODkgMy4wNDY5LTYuMDU0NyAzLjA0Njl6bS0xLjExMzMtMTguODY3cS0zLjI4MTIgMC00LjkyMTkgMi45MTAydjEwLjExN3ExLjY2MDIgMi44NzExIDQuOTYwOSAyLjg3MTEgMi45Mjk3IDAgNC4yNzczLTIuMzA0NyAxLjM2NzItMi4zMDQ3IDEuMzY3Mi01LjQ0OTJ2LTAuNDEwMTZxMC0zLjE0NDUtMS4zNjcyLTUuNDI5Ny0xLjM0NzYtMi4zMDQ3LTQuMzE2NC0yLjMwNDd6Ii8+CiAgPHBhdGggZD0ibTE2Ni45MSAxMTYuNzN2MzBoLTMuNjMyOHYtMzB6Ii8+CiAgPHBhdGggZD0ibTE4NS43NSAxNDYuNzNxLTAuMzUxNTctMC43NjE3Mi0wLjUwNzgyLTIuMjI2Ni0xLjAxNTYgMS4wNzQyLTIuNTM5MSAxLjg1NTUtMS41MjM0IDAuNzYxNzItMy40NzY2IDAuNzYxNzItMy4yNDIyIDAtNS4xOTUzLTEuODE2NC0xLjk1MzEtMS44MTY0LTEuOTUzMS00LjQ1MzEgMC0zLjM5ODQgMi41NzgxLTUuMTU2MiAyLjU3ODEtMS43NzczIDYuOTMzNi0xLjc3NzNoMy41NzQydi0xLjY3OTdxMC0xLjg3NS0xLjEzMjgtMi45ODgzLTEuMTEzMy0xLjEzMjgtMy4zMjAzLTEuMTMyOC0yLjA1MDggMC0zLjMyMDMgMS4wMTU2LTEuMjUgMC45OTYxLTEuMjUgMi4zMjQyaC0zLjYxMzNxMC0yLjI2NTYgMi4yODUyLTQuMjU3OCAyLjI4NTItMS45OTIyIDYuMTEzMy0xLjk5MjIgMy40Mzc1IDAgNS42NDQ1IDEuNzU3OCAyLjIwNyAxLjc1NzggMi4yMDcgNS4zMTI1djkuNDkyMnEwIDIuOTI5NyAwLjc0MjE5IDQuNjQ4NHYwLjMxMjV6bS01Ljk5NjEtMi43NzM0cTEuOTUzMSAwIDMuMzc4OS0wLjk3NjU2IDEuNDQ1My0wLjk3NjU2IDIuMDMxMi0yLjE2OHYtNC4zNTU1aC0zLjM1OTRxLTYuMDkzOCAwLjExNzE5LTYuMDkzOCAzLjkwNjIgMCAxLjUwMzkgMS4wMTU2IDIuNTU4NiAxLjAxNTYgMS4wMzUyIDMuMDI3MyAxLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTIwMy4yMyAxMjguMjVxLTEuNzM4MyAwLTMuMDY2NCAwLjkzNzUtMS4zMjgxIDAuOTM3NS0yLjA4OTggMi40NDE0djE1LjA5OGgtMy42MTMzdi0yMS4xMzNoMy40MThsMC4xMTcxOSAyLjYzNjdxMi40MDIzLTMuMDI3MyA2LjMwODYtMy4wMjczIDMuMTA1NSAwIDQuOTIxOSAxLjczODMgMS44MzU5IDEuNzM4MyAxLjg1NTUgNS44Mzk4djEzLjk0NWgtMy42MzI4di0xMy44ODdxMC0yLjQ4MDUtMS4wOTM4LTMuNTM1Mi0xLjA3NDItMS4wNTQ3LTMuMTI1LTEuMDU0N3oiLz4KICA8cGF0aCBkPSJtNTcuOTQxIDE5NC4xNXExLjkzMzYgMCAzLjM3ODktMS4xNTIzIDEuNDY0OC0xLjE1MjMgMS42MDE2LTIuOTQ5MmgzLjQzNzVxLTAuMTM2NzIgMi44MzItMi41OTc3IDQuOTYwOS0yLjQ2MDkgMi4xMDk0LTUuODIwMyAyLjEwOTQtNC43NjU2IDAtNy4wODk4LTMuMTQ0NS0yLjMwNDctMy4xNDQ1LTIuMzA0Ny03LjQwMjN2LTAuODIwMzFxMC00LjI1NzggMi4zMDQ3LTcuNDAyNCAyLjMyNDItMy4xNDQ1IDcuMDg5OC0zLjE0NDUgMy43MTA5IDAgNS45OTYxIDIuMjA3IDIuMjg1MiAyLjE4NzUgMi40MjE5IDUuNDQ5MmgtMy40Mzc1cS0wLjEzNjcyLTEuOTUzMS0xLjQ4NDQtMy4zMjAzLTEuMzI4MS0xLjM2NzItMy40OTYxLTEuMzY3Mi0yLjIyNjYgMC0zLjQ5NjEgMS4xMzI4LTEuMjUgMS4xMzI4LTEuNzc3MyAyLjg3MTEtMC41MDc4MSAxLjczODMtMC41MDc4MSAzLjU3NDJ2MC44MjAzMXEwIDEuODU1NSAwLjUwNzgxIDMuNTkzOCAwLjUwNzgxIDEuNzM4MyAxLjc1NzggMi44NzExIDEuMjY5NSAxLjExMzMgMy41MTU2IDEuMTEzM3oiLz4KICA8cGF0aCBkPSJtNjkuNDY1IDE4NS45NXEwLTQuNTg5OCAyLjU3ODEtNy42NTYyIDIuNTc4MS0zLjA4NTkgNy4wMTE3LTMuMDg1OSA0LjQzMzYgMCA3LjAxMTcgMy4wMjczIDIuNTc4MSAzLjAwNzggMi42MzY3IDcuNTE5NXYwLjY0NDUzcTAgNC41ODk4LTIuNTk3NyA3LjY1NjItMi41NzgxIDMuMDY2NC03LjAxMTcgMy4wNjY0LTQuNDUzMSAwLTcuMDUwOC0zLjA2NjQtMi41NzgxLTMuMDY2NC0yLjU3ODEtNy42NTYyem0zLjYxMzMgMC40NDkyMnEwIDMuMTQ0NSAxLjQ4NDQgNS40NDkyIDEuNTAzOSAyLjMwNDcgNC41MzEyIDIuMzA0NyAyLjk0OTIgMCA0LjQ1MzEtMi4yNjU2IDEuNTAzOS0yLjI4NTIgMS41MjM0LTUuNDI5N3YtMC41MDc4MXEwLTMuMTA1NS0xLjUwMzktNS40Mjk3LTEuNTAzOS0yLjM0MzgtNC41MTE3LTIuMzQzOC0yLjk4ODMgMC00LjQ5MjIgMi4zNDM4LTEuNDg0NCAyLjMyNDItMS40ODQ0IDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTAyIDE3OC4yNXEtMS43MzgzIDAtMy4wNjY0IDAuOTM3NS0xLjMyODEgMC45Mzc1LTIuMDg5OCAyLjQ0MTR2MTUuMDk4aC0zLjYxMzN2LTIxLjEzM2gzLjQxOGwwLjExNzE5IDIuNjM2N3EyLjQwMjMtMy4wMjczIDYuMzA4Ni0zLjAyNzMgMy4xMDU1IDAgNC45MjE5IDEuNzM4MyAxLjgzNTkgMS43MzgzIDEuODU1NSA1LjgzOTh2MTMuOTQ1aC0zLjYzMjh2LTEzLjg4N3EwLTIuNDgwNS0xLjA5MzgtMy41MzUyLTEuMDc0Mi0xLjA1NDctMy4xMjUtMS4wNTQ3eiIvPgogIDxwYXRoIGQ9Im0xMjQuNDYgMTc4LjM3aC00LjMxNjR2MTguMzU5aC0zLjYxMzN2LTE4LjM1OWgtMy4zMzk4di0yLjc3MzRoMy4zMzk4di0xLjgzNTlxMC0zLjU5MzggMi4wNzAzLTUuNTA3OCAyLjA3MDMtMS45MzM2IDUuNjY0MS0xLjkzMzYgMi4xODc1IDAgNS41MjczIDEuMTkxNGwtMC42MDU0NiAzLjA0NjlxLTIuNTM5MS0wLjk5NjA5LTQuNjY4LTAuOTk2MDktMi4zMjQyIDAtMy4zNTk0IDEuMDU0Ny0xLjAxNTYgMS4wMzUyLTEuMDE1NiAzLjE0NDV2MS44MzU5aDQuMzE2NHptNy4xMDk0LTIuNzczNHYyMS4xMzNoLTMuNjEzM3YtMjEuMTMzeiIvPgogIDxwYXRoIGQ9Im0xNDUuNTIgMjA1LjA3cS0xLjY0MDYgMC00LjAyMzQtMC44MDA3OC0yLjM4MjgtMC44MDA3OC0zLjgwODYtMi44NzExbDEuODk0NS0yLjE0ODRxMi4zNDM4IDIuODUxNiA1LjY2NDEgMi44NTE2IDIuNTU4NiAwIDQuMDgyLTEuNDQ1MyAxLjUyMzQtMS40MjU4IDEuNTIzNC00LjE5OTJ2LTEuODU1NXEtMi4xNDg0IDIuNTE5NS01LjkxOCAyLjUxOTUtMy44MDg2IDAtNi4wNTQ3LTMuMDQ2OS0yLjI0NjEtMy4wNDY5LTIuMjQ2MS03LjY3NTh2LTAuNDEwMTZxMC00Ljg0MzggMi4yMjY2LTcuODEyNSAyLjI0NjEtMi45Njg4IDYuMTEzMy0yLjk2ODggMy44ODY3IDAgNi4wMzUyIDIuNzM0NGwwLjE3NTc4LTIuMzQzOGgzLjI4MTJ2MjAuNjg0cTAgNC4xOTkyLTIuNSA2LjQ4NDQtMi41IDIuMzA0Ny02LjQ0NTMgMi4zMDQ3em0tNS4yNzM0LTE4LjY3MnEwIDMuMTQ0NSAxLjMwODYgNS40MTAyIDEuMzI4MSAyLjI0NjEgNC4yNTc4IDIuMjQ2MSAzLjQzNzUgMCA1LjAzOTEtMy4xMjV2LTkuNjI4OXEtMC42ODM1OS0xLjMwODYtMS44OTQ1LTIuMTY4LTEuMjEwOS0wLjg3ODktMy4xMDU1LTAuODc4OS0yLjk0OTIgMC00LjI3NzMgMi4zMDQ3LTEuMzI4MSAyLjI4NTItMS4zMjgxIDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTczLjA2IDE5Ni43My0wLjA3ODEtMi4wODk4cS0yLjA3MDMgMi40ODA1LTYuMTcxOSAyLjQ4MDUtMy4xMDU1IDAtNS4wMTk1LTEuODM1OS0xLjkxNDEtMS44MzU5LTEuOTE0MS02LjA1NDd2LTEzLjYzM2gzLjYxMzN2MTMuNjcycTAgMi44NTE2IDEuMTkxNCAzLjgyODEgMS4yMTA5IDAuOTU3MDMgMi42OTUzIDAuOTU3MDMgNC4wODIgMCA1LjUwNzgtMy4wNjY0di0xNS4zOTFoMy42MzI4djIxLjEzM3oiLz4KICA8cGF0aCBkPSJtMTkwLjQ0IDE3OC42OHEtMy41MzUyIDAtNC44MjQyIDMuMDQ2OXYxNWgtMy42MTMzdi0yMS4xMzNoMy41MTU2bDAuMDc4MSAyLjQyMTlxMS43MzgzLTIuODEyNSA1LjAxOTUtMi44MTI1IDEuMDE1NiAwIDEuNjAxNiAwLjI3MzQ0bC0wLjAxOTUgMy4zNTk0cS0wLjgwMDc4LTAuMTU2MjUtMS43NTc4LTAuMTU2MjV6Ii8+CiAgPHBhdGggZD0ibTIxMS45MSAxOTMuMDRxLTEuMDM1MiAxLjU2MjUtMi45Mjk3IDIuODMyLTEuODk0NSAxLjI1LTUuMDE5NSAxLjI1LTQuNDE0MSAwLTcuMDcwMy0yLjg3MTEtMi42MzY3LTIuODcxMS0yLjYzNjctNy4zNDM4di0wLjgyMDMxcTAtMy40NTcgMS4zMDg2LTUuODc4OSAxLjMyODEtMi40NDE0IDMuNDM3NS0zLjcxMDkgMi4xMDk0LTEuMjg5MSA0LjQ5MjItMS4yODkxIDQuNTMxMiAwIDYuNjAxNiAyLjk2ODggMi4wODk4IDIuOTQ5MiAyLjA4OTggNy4zODI4djEuNjIxMWgtMTQuMjk3cTAuMDc4MSAyLjkxMDIgMS43MTg4IDQuOTYwOSAxLjY2MDIgMi4wMzEyIDQuNTUwOCAyLjAzMTIgMS45MTQxIDAgMy4yNDIyLTAuNzgxMjUgMS4zMjgxLTAuNzgxMjUgMi4zMjQyLTIuMDg5OHptLTguNDE4LTE0Ljg2M3EtMi4xNDg0IDAtMy42MzI4IDEuNTYyNS0xLjQ4NDQgMS41NjI1LTEuODU1NSA0LjQ5MjJoMTAuNTY2di0wLjI3MzQ0cS0wLjEzNjcyLTIuMTA5NC0xLjIzMDUtMy45NDUzLTEuMDc0Mi0xLjgzNTktMy44NDc3LTEuODM1OXoiLz4KICA8cGF0aCBkPSJtMjMwLjAzIDE5Ni43My0wLjE3NTc4LTIuMjY1NnEtMi4xNjggMi42NTYyLTYuMDM1MiAyLjY1NjItMy43MTA5IDAtNS45OTYxLTMuMDA3OC0yLjI4NTItMy4wMDc4LTIuMzI0Mi03LjU1ODZ2LTAuNTY2NDFxMC00Ljg0MzggMi4yODUyLTcuODEyNSAyLjMwNDctMi45Njg4IDYuMDc0Mi0yLjk2ODggMy43MzA1IDAgNS44NTk0IDIuNXYtMTAuOTc3aDMuNjMyOHYzMHptLTEwLjg5OC0xMC4zMzJxMCAzLjE0NDUgMS4zMjgxIDUuNDEwMiAxLjMyODEgMi4yNDYxIDQuMjU3OCAyLjI0NjEgMy4zNTk0IDAgNS0zLjA2NjR2LTkuNzI2NnEtMS42MjExLTMuMDA3OC00Ljk2MDktMy4wMDc4LTIuOTQ5MiAwLTQuMjk2OSAyLjMwNDctMS4zMjgxIDIuMjg1Mi0xLjMyODEgNS40Mjk3eiIvPgogPC9nPgo8L3N2Zz4K'\n            }\n        ];\n        return attributeService.saveEntityAttributes(\n            entityId, \"SERVER_SCOPE\", attributesArray);\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e965b8a1-a6ac-5ae4-fd79-2b7220b91ed1"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "pageSize": 1024,
          "configMode": "advanced",
          "titleFont": null,
          "titleColor": null,
          "titleIcon": null,
          "iconColor": null
        },
        "row": 0,
        "col": 0,
        "id": "0aca86bb-f602-af18-62ed-998cc968189d",
        "typeFullFqn": "system.cards.entities_table"
      },
      "c23ea856-e76f-5b47-945a-b8a2e5b2b936": {
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f765d469-eafe-c53b-d010-c75a39278cad",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "latitude",
                  "type": "attribute",
                  "label": "latitude",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.862061599769905
                },
                {
                  "name": "longitude",
                  "type": "attribute",
                  "label": "longitude",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.017864596400994026
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "latitude",
                  "type": "attribute",
                  "label": "selectedDoktorkit",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.5292772206260663,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": true,
                  "postFuncBody": "if (value !== '') {\n    return true;\n} else {\n    return false;\n}"
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "provider": "openstreet-map",
            "gmApiKey": "AIzaSyDoEx2kaGz3PxwbI9T7ccTSg5xjdw8Nw8Q",
            "gmDefaultMapType": "roadmap",
            "mapProvider": "CartoDB.Positron",
            "useCustomProvider": false,
            "customProviderTileUrl": "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            "mapProviderHere": "HERE.normalDay",
            "credentials": {
              "useV3": false,
              "app_id": "AhM6TzD9ThyK78CT3ptx",
              "app_code": "p6NPiITB3Vv0GMUFnkLOOg",
              "apiKey": "kVXykxAfZ6LS4EbCTO02soFVfjA7HoBzNVVH9u7nzoE"
            },
            "mapImageUrl": "tb-image;/api/images/system/here_map_system_widget_map_image.svg",
            "imageEntityAlias": "",
            "imageUrlAttribute": "",
            "tmApiKey": "84d6d83e0e51e481e50454ccbe8986b",
            "tmDefaultMapType": "roadmap",
            "latKeyName": "latitude",
            "lngKeyName": "longitude",
            "xPosKeyName": "xPos",
            "yPosKeyName": "yPos",
            "defaultZoomLevel": 18,
            "defaultCenterPosition": "0,0",
            "disableScrollZooming": false,
            "disableDoubleClickZooming": false,
            "disableZoomControl": false,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "mapPageSize": 16384,
            "markerOffsetX": 0.5,
            "markerOffsetY": 1,
            "posFunction": "return {x: origXPos, y: origYPos};",
            "draggableMarker": true,
            "showLabel": true,
            "useLabelFunction": false,
            "label": "${entityName}",
            "labelFunction": null,
            "showTooltip": true,
            "showTooltipAction": "click",
            "autocloseTooltip": true,
            "useTooltipFunction": false,
            "tooltipPattern": "<b>${entityName}</b><br/><br/><link-act name='Assigned Devices'>Assigned Devices</link-act><br/><br/><link-act name='delete-Measurement'>Delete</link-act>",
            "tooltipFunction": null,
            "tooltipOffsetX": 0,
            "tooltipOffsetY": -1,
            "color": "#fe7569",
            "useColorFunction": false,
            "colorFunction": null,
            "useMarkerImageFunction": true,
            "markerImage": null,
            "markerImageSize": 34,
            "markerImageFunction": "var selectedDoktorkit = data['selectedDoktorkit'] === true;\nvar selectedMode = dsData.filter(function (data) { return data['selectedDoktorkit'] === true; }).length > 0;\n\nvar width = 30;\nvar svgStr = getDoktorkitSvg(width, selectedDoktorkit);\nvar encodedSvg = encodeURIComponent(svgStr);\nvar svgUrl = 'data:image/svg+xml,' + encodedSvg;\n\nif (selectedDoktorkit) {\n    width += 8;\n}\n\nreturn {\n    url: svgUrl,\n    size: width,\n    markerOffset: [width / 2, width / 2],\n    tooltipOffset: [width * 0.5 - width / 2, - (width / 2)]\n};\n\nfunction getDoktorkitSvg(width, isSelected) {\n    var shape = '<path d=\"M3.75 15.75L4.5 16.5L19.5 16.5L20.25 15.75V8.25L19.5 7.5H4.5L3.75 8.25V15.75ZM18.75 15L5.25 15L5.25 9H6.375L6.375 11.625H7.875L7.875 9L9.375 9V12.375H10.875L10.875 9L12.375 9V11.625H13.875V9L15.375 9V11.625H16.875V9L18.75 9V15Z\" fill=\"white\" stroke-width=\".7997\"/>';\n    var color = '#1F8B4D';\n    var background = getBackground(color);\n    var svgWidth = isSelected ? (width + 8) : width;\n    var svgHeight = isSelected ? 38 : 30;\n    \n    var opacity = selectedMode && !isSelected ? 0.4 : 1;\n    \n    var DoktorkitSvg = '<svg opacity=\"' + opacity + '\" width=\"' + svgWidth + '\" height=\"' + svgHeight + '\" viewBox=\"0 0' + svgWidth + ' ' + svgHeight + '\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                    wrapIfSelected(background + shape, isSelected);\n    if (isSelected) {\n        DoktorkitSvg += getDoktorkitSelectionStroke();\n    }\n    DoktorkitSvg += '</svg>';\n    return DoktorkitSvg;    \n}\n\nfunction wrapIfSelected(svg, isSelected) {\n    if (isSelected) {\n        return '<g transform=\"translate(7 7)\">' + svg + '</g>';\n    } else {\n        return '<g transform=\"translate(3 3)\">' + svg + '</g>';\n    }\n}\n\nfunction getBackground(color) {\n     return '<circle cx=\"12\" cy=\"12\" r=\"15\" fill=\"'+ color +'\"/>';\n}\n\nfunction getDoktorkitSelectionStroke() {\n     return '<circle cx=\"19\" cy=\"19\" r=\"18\" stroke=\"#D5C21B\" stroke-width=\"2\"/>';\n}",
            "markerImages": [],
            "showPolygon": false,
            "polygonKeyName": "perimeter",
            "editablePolygon": false,
            "showPolygonLabel": false,
            "usePolygonLabelFunction": false,
            "polygonLabel": "${entityName}",
            "polygonLabelFunction": null,
            "showPolygonTooltip": false,
            "showPolygonTooltipAction": "click",
            "autoClosePolygonTooltip": true,
            "usePolygonTooltipFunction": false,
            "polygonTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "polygonTooltipFunction": null,
            "polygonColor": "#3388ff",
            "polygonOpacity": 0.2,
            "usePolygonColorFunction": false,
            "polygonColorFunction": null,
            "polygonStrokeColor": "#3388ff",
            "polygonStrokeOpacity": 1,
            "polygonStrokeWeight": 3,
            "usePolygonStrokeColorFunction": false,
            "polygonStrokeColorFunction": null,
            "showCircle": false,
            "circleKeyName": "perimeter",
            "editableCircle": false,
            "showCircleLabel": false,
            "useCircleLabelFunction": false,
            "circleLabel": "${entityName}",
            "circleLabelFunction": null,
            "showCircleTooltip": false,
            "showCircleTooltipAction": "click",
            "autoCloseCircleTooltip": true,
            "useCircleTooltipFunction": false,
            "circleTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "circleTooltipFunction": null,
            "circleFillColor": "#3388ff",
            "circleFillColorOpacity": 0.2,
            "useCircleFillColorFunction": false,
            "circleFillColorFunction": null,
            "circleStrokeColor": "#3388ff",
            "circleStrokeOpacity": 1,
            "circleStrokeWeight": 3,
            "useCircleStrokeColorFunction": false,
            "circleStrokeColorFunction": null,
            "snappable": false,
            "initDragMode": false,
            "hideAllControlButton": false,
            "hideDrawControlButton": false,
            "hideEditControlButton": false,
            "hideRemoveControlButton": false,
            "useClusterMarkers": true,
            "zoomOnClick": true,
            "maxZoom": null,
            "maxClusterRadius": 80,
            "animate": true,
            "spiderfyOnMaxZoom": true,
            "showCoverageOnHover": true,
            "chunkedLoading": false,
            "removeOutsideVisibleBounds": true,
            "useIconCreateFunction": false,
            "clusterMarkerFunction": null
          },
          "title": "Doktorkits map",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "widgetStyle": {},
          "actions": {
            "markerClick": [
              {
                "name": "Select Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nvar selectedMeasurement = params['selectedMeasurement'];\nif (selectedMeasurement && selectedMeasurement.entityId.id === entityId.id) {\n    params['selectedMeasurement'] = null;\n} else {\n    params['selectedMeasurement'] = { entityId: entityId, entityName: entityName, entityLabel: entityLabel };\n}\nwidgetContext.stateController.updateState(null, params);\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "4de7962b-a1de-5cb1-cd78-993dc7863614"
              }
            ],
            "tooltipAction": [
              {
                "name": "Assigned Devices",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = JSON.parse(JSON.stringify(widgetContext.stateController.getStateParams()));\nparams['selectedMeasurement'] = {\n        entityId: entityId,\n        entityName: entityName,\n        entityLabel: entityLabel,\n};\nparams['targetEntityParamName'] = 'selectedMeasurement';\nparams['selectedDevice'] = null;\n\nwidgetContext.stateController.openState('measurement_devices', params);\t",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1ca54350-817a-27b3-26a7-3572544d8523"
              },
              {
                "name": "delete-Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenDeleteMeasurementDialog();\n\nfunction openDeleteMeasurementDialog() {\n  var title = 'Are you sure you want to delete the Measurement ' + entityName + '?';\n  var content = 'Be careful, after the confirmation, the Measurement will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteMeasurement();\n      }\n    }\n  );\n}\n\nfunction deleteMeasurement() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, customerId, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, customerId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteMeasurementToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Measurement Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Measurement Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteMeasurementToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "89d67b54-a78e-f190-3832-1aae29cee395"
              }
            ]
          },
          "showTitleIcon": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "titleTooltip": "",
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "c23ea856-e76f-5b47-945a-b8a2e5b2b936",
        "typeFullFqn": "system.maps_v2.openstreetmap"
      },
      "2eb3b5d4-b23a-63f6-2295-ffdf59a880f5": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "{i18n:custom.diagnostics.projects.title}",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": true,
            "entityNameColumnTitle": "ID",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "pageStepCount": 3,
            "pageStepIncrement": 10,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "{i18n:custom.diagnostics.projects.title}",
          "dropShadow": false,
          "enableFullscreen": true,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "df6ecbc0-0dae-bc9b-fbeb-96b5c11f9ebc",
              "filterId": "6399251d-d843-e4ee-9b39-3a7096b8ef07",
              "dataKeys": [
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Name",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.23547368231999988,
                  "decimals": 0,
                  "aggregationType": null,
                  "units": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "{i18n:custom.measurement.administration.action.address.title}",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.8348661406382081,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostics.measurement-progress.title}",
                  "color": "#f44336",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar description;\r\nvar state = value;\r\nif (state == 'active') { // all key values here are strings\r\n  color = '#f3de61'; // Yellow\r\n  description = '{i18n:custom.diagnostics.state-filter.active.title}';\r\n} else if (state == 'in preparation') {\r\n  /*color = '#005757';*/\r\n  /*color = '#eef30b';*/\r\n  color = '#CAC1D2';// Grey\r\n  description = '{i18n:custom.diagnostics.state-filter.preparation.title}';\r\n}\r\nelse {\r\n  color = '#27AE60';//Green\r\n  description = '{i18n:custom.diagnostics.state-filter.finished.title}';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span>' + ' ' + description;\r\n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.15334267783981326,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "generalReport",
                  "type": "attribute",
                  "label": "{i18n:custom.measurement.administration.action.report.title}",
                  "color": "#ffc107",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar detailReport = value;\r\nvar status;\r\nif (detailReport == 'true') { // all key values here are strings\r\n  color = '#27AE60';\r\n  status = '{i18n:custom.measurement.administration.report.paid}';\r\n} else {\r\n  color = '#EB5757';\r\n  status = '{i18n:custom.measurement.administration.report.inactive}';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span>' + ' ' + status;",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.6722693120890098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "{i18n:custom.projects.project.open-measurements}",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedProject'] = {\"entityId\":entityId,\"entityName\":entityName,\"entityLabel\":entityLabel}; \nwidgetContext.updateAliases();\nwidgetContext.stateController.updateState('Projects', params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "5e50c296-0eac-8841-a69a-1cbbfe04d1c5"
              }
            ],
            "actionCellButton": [
              {
                "name": "{i18n:custom.projects.project.general-report}",
                "icon": "verified",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" (ngSubmit)=\"checkout()\" class=\"add-entity-form\" [formGroup]=\"addEntityFormGroup\">\n    <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n        <h2 class=\"text-lg font-semibold\">{{'custom.measurement.administration.unlock-report.payment-options' | translate }}</h2>\n            <span class=\"flex-1\"></span>\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n            <mat-icon class=\"material-icons\">close</mat-icon>\n        </button>\n    </mat-toolbar>\n\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n\n    <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n        <div class=\"flex justify-center items-center gap-8\">\n            <div class=\"flex flex-col\">\n                <div>{{'custom.measurement.administration.unlock-report.pay-by-invoice' | translate }}</div>\n                <mat-checkbox [checked]=\"buyInvoice\" (change)=\"onSelectBuyInvoice($event)\"></mat-checkbox>\n            </div>\n            <div class=\"flex flex-col\">\n                <div>{{'custom.measurement.administration.unlock-report.credit-card.alternative-payments' | translate }}</div>\n                <mat-checkbox [checked]=\"buyCard\" (change)=\"onSelectBuyCard($event)\"></mat-checkbox>\n            </div>\n        </div>\n    </div>\n\n    <div mat-dialog-actions class=\"flex justify-end gap-2\">\n        <button mat-button color=\"primary\" type=\"button\" [disabled]=\"(isLoading$ | async)\" (click)=\"cancel()\" cdkFocusInitial>\n            {{ 'action.cancel' | translate }}\n        </button>\n        <button mat-button mat-raised-button color=\"primary\" type=\"submit\"\n                [disabled]=\"(isLoading$ | async) || (!buyInvoice && !buyCard)\">\n            {{ 'custom.measurement.administration.unlock-report.checkout' | translate }}\n        </button>\n    </div>\n</form>",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet PageLink = widgetContext.pageLink;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet assetProfileService = $injector.get(widgetContext.servicesMap.get('assetProfileService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\r\nlet stripeSecretKey;\r\nlet sessionId = '';\r\nlet products = [];\r\nlet projectID = entityId.id;\r\nlet customerId;\r\nlet customerStripeId;\r\nlet bearerToken = '';\r\n\r\nvar customer;\r\nif (widgetContext.currentUser.authority !== 'CUSTOMER_USER') {\r\n  customer = widgetContext.stateController.getStateParams().entityId;  \r\n} else {\r\n  customer = { entityType: \"CUSTOMER\", id: widgetContext.currentUser.customerId };\r\n}\r\n//console.log(\"customer\",customer);\r\nlet projectName = '';\r\nvar url = window.location.href;\r\n\r\nfunction getQueryParam(param) {\r\n  const urlParams = new URLSearchParams(window.location.search);\r\n  return urlParams.get(param);\r\n}\r\n\r\nconst sessionIdFromUrl = getQueryParam('session_id');\r\nif (sessionIdFromUrl) {\r\n  window.history.replaceState({}, document.title, window.location.pathname);\r\n  localStorage.removeItem('selectedProjectId');\r\n  checkPaymentStatus(sessionIdFromUrl, projectID);\r\n} else {\r\n  initialize();\r\n}\r\n\r\nfunction initialize() {\r\n  const pageLink = PageLink(50, 0);\r\n  const query = {\r\n    parameters: {\r\n      rootId: customer.id,\r\n      rootType: \"CUSTOMER\",\r\n      direction: \"FROM\",\r\n      relationTypeGroup: \"COMMON\",\r\n      maxLevel: 1,\r\n      fetchLastLevelOnly: false\r\n    },\r\n    relationType: \"Contains\",\r\n    assetTypes: [\"Product\"]\r\n  };\r\n\r\n  assetService.getAssetInfo(projectID).subscribe(info => {\r\n    customerId = info.customerId;\r\n    projectName = info.name || projectID;\r\n    /*console.log(\"projectID\", projectID);*/\r\n    checkSingleProjectStatus(projectID).then(result => {\r\n        /*console.log(\"result Proje\", result)*/\r\n      if (result === 'paid') {\r\n        alert(translationService.instant('custom.payment.alert.project-already-has-general-report'));\r\n      } else if (result === 'openInvoice') {\r\n        alert(translationService.instant('custom.payment.alert.open-invoice'));\r\n      } else {\r\n        attributeService.getEntityAttributes(customerId, \"SERVER_SCOPE\", ['stripe_id']).subscribe(stripeId => {\r\n          customerStripeId = stripeId[0].value;\r\n          attributeService.getEntityAttributes(customer, \"SERVER_SCOPE\", ['stripeKey'])\r\n            .subscribe(attribute => {\r\n              stripeSecretKey = attribute[0].value;\r\n              fetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n                method: 'POST',\r\n                headers: {\r\n                  'Content-Type': 'application/json'\r\n                },\r\n                body: JSON.stringify({\r\n                  \"username\": \"belimo.api@pke-iot.expert\",\r\n                  \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n                })\r\n              })\r\n              .then(resp => resp.json())\r\n              .then(loginData => {\r\n                bearerToken = loginData.token;\r\n                return fetch('https://cloud.pke-iot.expert/api/assets', {\r\n                  method: 'POST',\r\n                  headers: {\r\n                    'accept': 'application/json',\r\n                    'Content-Type': 'application/json',\r\n                    'X-Authorization': 'Bearer ' + bearerToken\r\n                  },\r\n                  body: JSON.stringify(query)\r\n                });\r\n              })\r\n              .then(resp2 => resp2.json())\r\n              .then(assets => {\r\n                /*console.log(\"All fetched products:\", assets);*/\r\n                let filteredProducts = [];\r\n                let productFetches = assets.map(asset => {\r\n                  return new Promise((resolve, reject) => {\r\n                    fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${asset.id.id}/values/attributes?keys=prodType`, {\r\n                      method: 'GET',\r\n                      headers: {\r\n                        'accept': 'application/json',\r\n                        'X-Authorization': 'Bearer ' + bearerToken\r\n                      }\r\n                    })\r\n                    .then(resp3 => resp3.json())\r\n                    .then(attributes => {\r\n                      if (attributes.length > 0 && attributes[0].key === 'prodType' && attributes[0].value === 'generalReport') {\r\n                        filteredProducts.push(asset);\r\n                      }\r\n                      resolve();\r\n                    })\r\n                    .catch(err => {\r\n                      console.error(\"Error fetching prodType:\", err);\r\n                      resolve();\r\n                    });\r\n                  });\r\n                });\r\n                Promise.all(productFetches).then(() => {\r\n                  /*console.log(\"Filtered products:\", filteredProducts);*/\r\n                  products = filteredProducts;\r\n                  openAddEntityDialog();\r\n                });\r\n              })\r\n              .catch(error => {\r\n                console.error(\"Error fetching products:\", error);\r\n                alert(translationService.instant('custom.payment.alert.fetch-products-failed'));\r\n              });\r\n            });\r\n        });\r\n      }\r\n    }).catch(err => {\r\n      console.error('Error checking project status:', err);\r\n      alert(translationService.instant('custom.payment.alert.check-project-status-failed'));\r\n    });\r\n  });\r\n}\r\n\r\nfunction openAddEntityDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddEntityDialogController).subscribe();\r\n}\r\n\r\nfunction AddEntityDialogController(instance) {\r\n  let vm = instance;\r\n  vm.products = products;\r\n  vm.buyInvoice = false;\r\n  vm.buyCard = false;\r\n\r\n  vm.addEntityFormGroup = vm.fb.group({});\r\n\r\n  vm.onSelectBuyInvoice = function(event) {\r\n    vm.buyInvoice = event.checked;\r\n    if (vm.buyInvoice) {\r\n      vm.buyCard = false;\r\n    }\r\n  };\r\n\r\n  vm.onSelectBuyCard = function(event) {\r\n    vm.buyCard = event.checked;\r\n    if (vm.buyCard) {\r\n      vm.buyInvoice = false;\r\n    }\r\n  };\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  vm.checkout = function () {\r\n    if (!vm.products.length) {\r\n      alert(translationService.instant('custom.payment.alert.product-not-found'));\r\n      vm.dialogRef.close(null);\r\n      return;\r\n    }\r\n    const productId = vm.products[0].id.id;\r\n    fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${productId}/values/attributes?keys=price_stripe_id`, {\r\n      method: 'GET',\r\n      headers: {\r\n        'accept': 'application/json',\r\n        'X-Authorization': 'Bearer ' + bearerToken\r\n      }\r\n    })\r\n    .then(resp => resp.json())\r\n    .then(attributes => {\r\n      let priceIdObj = attributes.find(attr => attr.key === 'price_stripe_id');\r\n      if (priceIdObj) {\r\n        const priceId = priceIdObj.value;\r\n        if (vm.buyInvoice) {\r\n          createInvoiceForOneTimePurchase(priceId, instance);\r\n        } else if (vm.buyCard) {\r\n          createCheckoutSession(priceId, instance);\r\n        } else {\r\n          alert(translationService.instant('custom.payment.alert.select-payment-method'));\r\n        }\r\n      } else {\r\n        console.error('Price ID not found for the product (price_stripe_id).');\r\n        vm.dialogRef.close(null);\r\n      }\r\n    })\r\n    .catch(err => {\r\n      console.error('Error fetching price_stripe_id:', err);\r\n      vm.dialogRef.close(null);\r\n    });\r\n  };\r\n}\r\n\r\nasync function createInvoiceForOneTimePurchase(priceId, instance) {\r\n  try {\r\n    const priceResp = await fetch(`https://api.stripe.com/v1/prices/${priceId}`, {\r\n      method: 'GET',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`\r\n      }\r\n    });\r\n    if (!priceResp.ok) {\r\n      throw new Error(`Error fetching price details: ${priceResp.statusText}`);\r\n    }\r\n    const priceData = await priceResp.json();\r\n    const amount = priceData.unit_amount;\r\n    const currency = priceData.currency;\r\n\r\n    let invoiceBody = new URLSearchParams({\r\n      customer: customerStripeId,\r\n      auto_advance: 'false',\r\n      collection_method: 'send_invoice',\r\n      days_until_due: '14'\r\n    });\r\n    const invoiceResp = await fetch('https://api.stripe.com/v1/invoices', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: invoiceBody\r\n    });\r\n    if (!invoiceResp.ok) {\r\n      throw new Error(`Error creating draft invoice: ${invoiceResp.statusText}`);\r\n    }\r\n    const invoiceData = await invoiceResp.json();\r\n\r\n    let invoiceItemBody = new URLSearchParams({\r\n      customer: customerStripeId,\r\n      invoice: invoiceData.id,\r\n      amount: amount.toString(),\r\n      currency: currency,\r\n      description: `One-time purchase for project: ${projectName}`\r\n    });\r\n    const invoiceItemResp = await fetch('https://api.stripe.com/v1/invoiceitems', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: invoiceItemBody\r\n    });\r\n    if (!invoiceItemResp.ok) {\r\n      throw new Error(`Error creating invoice item: ${invoiceItemResp.statusText}`);\r\n    }\r\n    await invoiceItemResp.json();\r\n\r\n    const finalizeResp = await fetch(`https://api.stripe.com/v1/invoices/${invoiceData.id}/finalize`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`\r\n      }\r\n    });\r\n    if (!finalizeResp.ok) {\r\n      throw new Error(`Error finalizing invoice: ${finalizeResp.statusText}`);\r\n    }\r\n    const finalizedInvoice = await finalizeResp.json();\r\n\r\n    const attributes = [\r\n      { key: \"generalReport\", value: false },\r\n      { key: \"invoiceId\", value: invoiceData.id }\r\n    ];\r\n    attributeService.saveEntityAttributes(\r\n      { entityType: 'ASSET', id: projectID },\r\n      \"SERVER_SCOPE\",\r\n      attributes\r\n    ).subscribe(\r\n      () => {\r\n        alert(translationService.instant('custom.payment.alert.invoice-created'));\r\n        instance.dialogRef.close(null);\r\n      },\r\n      (error) => {\r\n        console.error('Error updating generalReport attribute:', error);\r\n        instance.dialogRef.close(null);\r\n      }\r\n    );\r\n  } catch (err) {\r\n    console.error(\"Error creating invoice:\", err);\r\n    alert(translationService.instant('custom.payment.alert.invoice-creation-failed'));\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\nasync function createCheckoutSession(priceId, instance) {\r\n  try {\r\n    const priceResponse = await fetch(`https://api.stripe.com/v1/prices/${priceId}`, {\r\n      method: 'GET',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`\r\n      }\r\n    });\r\n    if (!priceResponse.ok) {\r\n      throw new Error(`Error fetching price details: ${priceResponse.statusText}`);\r\n    }\r\n    const priceData = await priceResponse.json();\r\n    const isRecurring = priceData.recurring !== null;\r\n    const mode = isRecurring ? 'subscription' : 'payment';\r\n    const successUrl = url;\r\n    const cancelUrl = url;\r\n\r\n    const bodyParams = new URLSearchParams({\r\n      'success_url': successUrl,\r\n      'cancel_url': cancelUrl,\r\n      'payment_method_types[]': 'card',\r\n      'mode': mode,\r\n      'customer': customerStripeId\r\n    });\r\n    bodyParams.append('line_items[0][price_data][currency]', priceData.currency);\r\n    bodyParams.append('line_items[0][price_data][unit_amount]', String(priceData.unit_amount));\r\n    bodyParams.append('line_items[0][price_data][product_data][name]', `One-time purchase for: ${projectName}`);\r\n    bodyParams.append('line_items[0][quantity]', '1');\r\n\r\n    const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: bodyParams\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error: ${response.statusText}`);\r\n    }\r\n    const data = await response.json();\r\n    if (data.url) {\r\n      sessionId = data.id;\r\n      localStorage.setItem('sessionId', sessionId);\r\n      await new Promise((resolve, reject) => {\r\n        attributeService.saveEntityAttributes(\r\n          { entityType: 'ASSET', id: projectID },\r\n          \"SERVER_SCOPE\",\r\n          [{ key: \"sessionId\", value: sessionId }]\r\n        ).subscribe(\r\n          () => resolve(),\r\n          (error) => {\r\n            console.error('Error saving session ID attribute:', error);\r\n            reject(error);\r\n          }\r\n        );\r\n      });\r\n      instance.dialogRef.close(null);\r\n      window.location.href = data.url;\r\n    } else {\r\n      console.error('Checkout session URL not found in response');\r\n    }\r\n  } catch (error) {\r\n    console.error('Error creating checkout session:', error);\r\n  }\r\n}\r\n\r\nasync function checkPaymentStatus(sessionId, entityId) {\r\n  try {\r\n    if (!stripeSecretKey || !customerStripeId) {\r\n      await fetchStripeKeysAndCustomerId();\r\n    }\r\n    const response = await fetch(`https://api.stripe.com/v1/checkout/sessions/${sessionId}`, {\r\n      method: 'GET',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`\r\n      }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error: ${response.statusText}`);\r\n    }\r\n    const data = await response.json();\r\n    if (data.payment_status === 'paid') {\r\n      alert(translationService.instant('custom.payment.alert.payment-successful'));\r\n      const attributes = [\r\n        { key: \"generalReport\", value: true }\r\n      ];\r\n      attributeService.saveEntityAttributes(\r\n        { entityType: 'ASSET', id: projectID },\r\n        \"SERVER_SCOPE\",\r\n        attributes\r\n      ).subscribe(\r\n        () => {},\r\n        (error) => {\r\n          console.error('Error saving generalReport attribute:', error);\r\n        }\r\n      );\r\n      return 'paid';\r\n    } else {\r\n      alert(translationService.instant('custom.payment.alert.payment-failed'));\r\n      return data.payment_status;\r\n    }\r\n  } catch (error) {\r\n    console.error('Error checking payment status:', error);\r\n    return 'error';\r\n  }\r\n}\r\n\r\nasync function fetchStripeKeysAndCustomerId() {\r\n  return new Promise((resolve, reject) => {\r\n    assetService.getAssetInfo(projectID).subscribe(info => {\r\n      customerId = info.customerId;\r\n      projectName = info.name || projectID;\r\n      attributeService.getEntityAttributes(customerId, \"SERVER_SCOPE\", ['stripe_id']).subscribe(stripeId => {\r\n        customerStripeId = stripeId[0].value;\r\n        attributeService.getEntityAttributes(customer, \"SERVER_SCOPE\", ['stripeKey']).subscribe(attribute => {\r\n          stripeSecretKey = attribute[0].value;\r\n          resolve();\r\n        }, reject);\r\n      }, reject);\r\n    }, reject);\r\n  });\r\n}\r\n\r\nfunction checkSingleProjectStatus(mId) {\r\n  return new Promise((resolve, reject) => {\r\n    attributeService.getEntityAttributes(\r\n      { entityType: 'ASSET', id: mId },\r\n      \"SERVER_SCOPE\",\r\n      ['generalReport','invoiceId','sessionId']\r\n    ).subscribe(attrs => {\r\n      /*console.log(\"attrs\", attrs);*/\r\n      let generalReportVal = false;\r\n      let invoiceIdVal = null;\r\n      let sessionIdVal = null;\r\n      attrs.forEach(a => {\r\n        if (a.key === 'generalReport') generalReportVal = a.value;\r\n        if (a.key === 'invoiceId') invoiceIdVal = a.value;\r\n        if (a.key === 'sessionId') sessionIdVal = a.value;\r\n      });\r\n      if (generalReportVal === true) {\r\n        resolve(\"paid\");\r\n      } else {\r\n        if (sessionIdVal) {\r\n          checkStripeSessionPaid(sessionIdVal).then(isSessionPaid => {\r\n            if (isSessionPaid) {\r\n              resolve(\"paid\");\r\n            } else if (invoiceIdVal) {\r\n              checkStripeInvoice(invoiceIdVal).then(invStatus => {\r\n                if (invStatus === 'paid') resolve(\"paid\");\r\n                else if (invStatus === 'open') resolve(\"openInvoice\");\r\n                else resolve(\"unpaid\");\r\n              }).catch(() => reject());\r\n            } else {\r\n              resolve(\"unpaid\");\r\n            }\r\n          }).catch(() => reject());\r\n        } else if (invoiceIdVal) {\r\n          checkStripeInvoice(invoiceIdVal).then(invStatus => {\r\n            if (invStatus === 'paid') resolve(\"paid\");\r\n            else if (invStatus === 'open') resolve(\"openInvoice\");\r\n            else resolve(\"unpaid\");\r\n          }).catch(() => reject());\r\n        } else {\r\n          resolve(\"unpaid\");\r\n        }\r\n      }\r\n    }, err => reject(err));\r\n  });\r\n}\r\n\r\nfunction checkStripeSessionPaid(sid) {\r\n  return new Promise((resolve, reject) => {\r\n    fetchStripeKeysAndCustomerId().then(() => {\r\n      fetch(`https://api.stripe.com/v1/checkout/sessions/${sid}`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Authorization': `Bearer ${stripeSecretKey}`\r\n        }\r\n      })\r\n      .then(r => r.json())\r\n      .then(d => {\r\n        if (d.payment_status === 'paid') resolve(true);\r\n        else resolve(false);\r\n      })\r\n      .catch(() => reject());\r\n    }).catch(() => reject());\r\n  });\r\n}\r\n\r\nfunction checkStripeInvoice(invoiceIdVal) {\r\n  return new Promise((resolve, reject) => {\r\n    fetchStripeKeysAndCustomerId().then(() => {\r\n      fetch(`https://api.stripe.com/v1/invoices/${invoiceIdVal}`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Authorization': `Bearer ${stripeSecretKey}`\r\n        }\r\n      })\r\n      .then(r => r.json())\r\n      .then(d => {\r\n        if (d.status === 'paid') {\r\n          resolve('paid');\r\n        } else if (d.status === 'open' || d.status === 'draft') {\r\n          resolve('open');\r\n        } else {\r\n          resolve(d.status);\r\n        }\r\n      })\r\n      .catch(() => reject());\r\n    }).catch(() => reject());\r\n  });\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "d0d79c7c-5f92-26af-8898-3e8ff91dd01d"
              },
              {
                "name": "{i18n:custom.projects.project.activate-all-reports}",
                "icon": "mdi:file-chart",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" (ngSubmit)=\"checkout()\" class=\"add-entity-form\" [formGroup]=\"addEntityFormGroup\">\r\n    <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n        <h2 class=\"text-lg font-semibold\">{{'custom.measurement.administration.unlock-report.payment-options' | translate }}</h2>\r\n            <span class=\"flex-1\"></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n            <mat-icon class=\"material-icons\">close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n    <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n        <div class=\"flex justify-center items-center gap-8\">\r\n            <div class=\"flex flex-col\">\r\n                <div>{{'custom.measurement.administration.unlock-report.pay-by-invoice' | translate }}</div>\r\n                <mat-checkbox [checked]=\"buyInvoice\" (change)=\"onSelectBuyInvoice($event)\"></mat-checkbox>\r\n            </div>\r\n            <div class=\"flex flex-col\">\r\n                <div>{{ 'custom.measurement.administration.unlock-report.credit-card.alternative-payments' | translate }}</div>\r\n                <mat-checkbox [checked]=\"buyCard\" (change)=\"onSelectBuyCard($event)\"></mat-checkbox>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n        <button mat-button color=\"primary\" type=\"button\" [disabled]=\"(isLoading$ | async)\" (click)=\"cancel()\" cdkFocusInitial>\r\n            {{ 'action.cancel' | translate }}\r\n        </button>\r\n        <button mat-button mat-raised-button color=\"primary\" type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || (!buyInvoice && !buyCard)\">\r\n            {{ 'custom.measurement.administration.unlock-report.checkout' | translate }}\r\n        </button>\r\n    </div>\r\n</form>",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet PageLink = widgetContext.pageLink;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet assetProfileService = $injector.get(widgetContext.servicesMap.get('assetProfileService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\r\nlet stripeSecretKey;\r\nlet sessionId = '';\r\nlet bearerToken = '';\r\nlet projectID = entityId.id;\r\nlet customerId;\r\nlet customerStripeId;\r\nlet projectName = '';\r\nlet measurements;\r\nvar customer;\r\nif (widgetContext.currentUser.authority !== 'CUSTOMER_USER') {\r\n  customer = widgetContext.stateController.getStateParams().entityId;  \r\n} else {\r\n  customer = { entityType: \"CUSTOMER\", id: widgetContext.currentUser.customerId };\r\n}\r\nvar url = window.location.href;\r\n\r\n// Global variables for products\r\nlet productGeneral, productUltrasonic, productLoraWan;\r\n\r\n// Helper: get query parameter from URL\r\nfunction getQueryParam(param) {\r\n  const urlParams = new URLSearchParams(window.location.search);\r\n  return urlParams.get(param);\r\n}\r\n\r\n// Provided function to get related sensors for a measurement (loraWan type)\r\nfunction getRelatedSensors(measurementId){\r\n    let deviceQuery = {\r\n      parameters: {\r\n        rootId: measurementId,\r\n        rootType: \"ASSET\",\r\n        direction: \"FROM\",\r\n        relationTypeGroup: \"COMMON\",\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: true\r\n      },\r\n      relationType: \"Measurement\",\r\n      deviceTypes: [\"Room Sensor CO2\"]\r\n    }\r\n    return deviceService.findByQuery(deviceQuery);\r\n}\r\n\r\n// First, fetch all measurements for the project (assets of type \"Measurement\")\r\nlet assetSearchQuery = {\r\n  \"parameters\": {\r\n    \"rootId\": projectID,\r\n    \"rootType\": \"ASSET\",\r\n    \"direction\": \"FROM\",\r\n    \"relationTypeGroup\": \"COMMON\",\r\n    \"maxLevel\": 10,\r\n    \"fetchLastLevelOnly\": false\r\n  },\r\n  \"relationType\": \"Owns\",\r\n  \"assetTypes\": [\r\n    \"Measurement\"\r\n  ]\r\n};\r\n\r\nassetService.findByQuery(assetSearchQuery).subscribe(response => {\r\n  measurements = response;\r\n  console.log(\"measurements\", measurements);\r\n  const sessionIdFromUrl = getQueryParam('session_id');\r\n  if (sessionIdFromUrl) {\r\n    window.history.replaceState({}, document.title, window.location.pathname);\r\n    localStorage.removeItem('selectedProjectId');\r\n    checkPaymentStatus(sessionIdFromUrl, projectID);\r\n  } else {\r\n    initialize();\r\n  }\r\n});\r\n\r\n// Main initialization: fetch project info, check payment status and then fetch Products\r\nfunction initialize() {\r\n  // Get project info to obtain customer and project name\r\n  assetService.getAssetInfo(projectID).subscribe(info => {\r\n    customerId = info.customerId;\r\n    projectName = info.name || projectID;\r\n    checkSingleProjectStatus(projectID).then(result => {\r\n      if (result === 'paid') {\r\n        alert(translationService.instant('custom.payment.alert.project-already-has-general-report'));\r\n      } else if (result === 'openInvoice') {\r\n        alert(translationService.instant('custom.payment.alert.open-invoice'));\r\n      } else {\r\n        // Fetch stripe keys\r\n        attributeService.getEntityAttributes(customerId, \"SERVER_SCOPE\", ['stripe_id']).subscribe(stripeId => {\r\n          customerStripeId = stripeId[0].value;\r\n          attributeService.getEntityAttributes(customer, \"SERVER_SCOPE\", ['stripeKey'])\r\n            .subscribe(attribute => {\r\n              stripeSecretKey = attribute[0].value;\r\n              // Login to get bearer token for REST calls\r\n              fetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n                method: 'POST',\r\n                headers: {\r\n                  'Content-Type': 'application/json'\r\n                },\r\n                body: JSON.stringify({\r\n                  \"username\": \"belimo.api@pke-iot.expert\",\r\n                  \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n                })\r\n              })\r\n              .then(resp => resp.json())\r\n              .then(loginData => {\r\n                bearerToken = loginData.token;\r\n                // Query for Products from customer using a Contains relation.\r\n                const query = {\r\n                  parameters: {\r\n                    rootId: customer.id,\r\n                    rootType: \"CUSTOMER\",\r\n                    direction: \"FROM\",\r\n                    relationTypeGroup: \"COMMON\",\r\n                    maxLevel: 1,\r\n                    fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: \"Contains\",\r\n                  assetTypes: [\"Product\"]\r\n                };\r\n                return fetch('https://cloud.pke-iot.expert/api/assets', {\r\n                  method: 'POST',\r\n                  headers: {\r\n                    'accept': 'application/json',\r\n                    'Content-Type': 'application/json',\r\n                    'X-Authorization': 'Bearer ' + bearerToken\r\n                  },\r\n                  body: JSON.stringify(query)\r\n                });\r\n              })\r\n              .then(resp2 => resp2.json())\r\n              .then(assets => {\r\n                // Filter and assign products based on prodType.\r\n                let productFetches = assets.map(asset => {\r\n                  return new Promise((resolve) => {\r\n                    fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${asset.id.id}/values/attributes?keys=prodType,price_stripe_id`, {\r\n                      method: 'GET',\r\n                      headers: {\r\n                        'accept': 'application/json',\r\n                        'X-Authorization': 'Bearer ' + bearerToken\r\n                      }\r\n                    })\r\n                    .then(resp3 => resp3.json())\r\n                    .then(attributes => {\r\n                      if (attributes && attributes.length > 0) {\r\n                        let prodTypeAttr = attributes.find(a => a.key === 'prodType');\r\n                        // Depending on prodType assign to the proper product variable\r\n                        if (prodTypeAttr) {\r\n                          if (prodTypeAttr.value === 'generalReport') {\r\n                            productGeneral = asset;\r\n                          } else if (prodTypeAttr.value === 'detailReportUltrasonic') {\r\n                            productUltrasonic = asset;\r\n                          } else if (prodTypeAttr.value === 'detailReportLoraWan') {\r\n                            productLoraWan = asset;\r\n                          }\r\n                        }\r\n                      }\r\n                      resolve();\r\n                    })\r\n                    .catch(err => {\r\n                      console.error(\"Error fetching product attributes:\", err);\r\n                      resolve();\r\n                    });\r\n                  });\r\n                });\r\n                Promise.all(productFetches).then(() => {\r\n                  if (!productGeneral) {\r\n                    alert(translationService.instant('custom.payment.alert.general-report-product-not-found'));\r\n                    return;\r\n                  }\r\n                  // Now open the dialog for checkout\r\n                  openAddEntityDialog();\r\n                });\r\n              })\r\n              .catch(error => {\r\n                console.error(\"Error fetching products:\", error);\r\n                alert(translationService.instant('custom.payment.alert.failed-to-fetch'));\r\n              });\r\n            });\r\n        });\r\n      }\r\n    }).catch(err => {\r\n      console.error('Error checking project status:', err);\r\n      alert(translationService.instant('custom.payment.alert.failed-to-check'));\r\n    });\r\n  });\r\n}\r\n\r\nfunction openAddEntityDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddEntityDialogController).subscribe();\r\n}\r\n\r\nfunction AddEntityDialogController(instance) {\r\n  let vm = instance;\r\n  // For display purposes we may show available products (optional)\r\n  vm.products = {\r\n    general: productGeneral,\r\n    ultrasonic: productUltrasonic,\r\n    loraWan: productLoraWan\r\n  };\r\n  vm.buyInvoice = false;\r\n  vm.buyCard = false;\r\n  vm.addEntityFormGroup = vm.fb.group({});\r\n\r\n  vm.onSelectBuyInvoice = function(event) {\r\n    vm.buyInvoice = event.checked;\r\n    if (vm.buyInvoice) {\r\n      vm.buyCard = false;\r\n    }\r\n  };\r\n\r\n  vm.onSelectBuyCard = function(event) {\r\n    vm.buyCard = event.checked;\r\n    if (vm.buyCard) {\r\n      vm.buyInvoice = false;\r\n    }\r\n  };\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  // When checking out, fetch price details for each product and compute totals for measurements.\r\n  vm.checkout = function () {\r\n    if (!productGeneral) {\r\n      alert(translationService.instant('custom.payment.alert.no-general-report-product-found'));\r\n      vm.dialogRef.close(null);\r\n      return;\r\n    }\r\n    // Helper: fetch price data for a given product asset.\r\n    function fetchPriceData(product) {\r\n      return new Promise((resolve, reject) => {\r\n        if (!product) {\r\n          return resolve(null);\r\n        }\r\n        fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${product.id.id}/values/attributes?keys=price_stripe_id`, {\r\n          method: 'GET',\r\n          headers: {\r\n            'accept': 'application/json',\r\n            'X-Authorization': 'Bearer ' + bearerToken\r\n          }\r\n        })\r\n        .then(resp => resp.json())\r\n        .then(attributes => {\r\n          let priceIdObj = attributes.find(attr => attr.key === 'price_stripe_id');\r\n          if (priceIdObj) {\r\n            // Fetch the price details from Stripe\r\n            fetch(`https://api.stripe.com/v1/prices/${priceIdObj.value}`, {\r\n              method: 'GET',\r\n              headers: {\r\n                'Authorization': `Bearer ${stripeSecretKey}`\r\n              }\r\n            })\r\n            .then(resp2 => {\r\n              if (!resp2.ok) {\r\n                throw new Error(resp2.statusText);\r\n              }\r\n              return resp2.json();\r\n            })\r\n            .then(priceData => {\r\n              resolve(priceData);\r\n            })\r\n            .catch(err => {\r\n              console.error(\"Error fetching Stripe price:\", err);\r\n              reject(err);\r\n            });\r\n          } else {\r\n            reject(\"Price ID not found for product \" + product.id.id);\r\n          }\r\n        })\r\n        .catch(err => {\r\n          console.error(\"Error fetching price_stripe_id:\", err);\r\n          reject(err);\r\n        });\r\n      });\r\n    }\r\n\r\n    Promise.all([\r\n      fetchPriceData(productGeneral),\r\n      fetchPriceData(productUltrasonic),\r\n      fetchPriceData(productLoraWan)\r\n    ]).then(([generalPriceData, ultrasonicPriceData, loraWanPriceData]) => {\r\n      if (vm.buyInvoice) {\r\n        createInvoiceForOneTimePurchase(generalPriceData, ultrasonicPriceData, loraWanPriceData, instance);\r\n      } else if (vm.buyCard) {\r\n        createCheckoutSession(generalPriceData, ultrasonicPriceData, loraWanPriceData, instance);\r\n      } else {\r\n        alert(translationService.instant('custom.payment.alert.payment.method'));\r\n      }\r\n    }).catch(err => {\r\n      console.error(\"Error fetching price data:\", err);\r\n      vm.dialogRef.close(null);\r\n    });\r\n  };\r\n}\r\n\r\n// Helper: Compute measurement totals and return an object:\r\n// { ultrasonicCount, loraWanSensorCount, includedMeasurements }\r\n// Only include a measurement if its detailReport attribute is not true,\r\n// its progress attribute is not \"aborted\", and for loraWan measurements only if there is at least one sensor.\r\nfunction computeMeasurementTotals() {\r\n  let ultrasonicCount = 0;\r\n  let loraWanSensorCount = 0;\r\n  let includedMeasurements = [];\r\n  let promises = measurements.map(meas => {\r\n    return new Promise((resolve) => {\r\n      attributeService.getEntityAttributes(\r\n        { entityType: 'ASSET', id: meas.id.id },\r\n        \"SERVER_SCOPE\",\r\n        ['measurementType', 'detailReport', 'progress']\r\n      ).subscribe(attrs => {\r\n        let measurementTypeVal = null;\r\n        let detailReportVal = false;\r\n        let progressVal = null;\r\n        attrs.forEach(a => {\r\n          if (a.key === 'measurementType') {\r\n            measurementTypeVal = a.value;\r\n          }\r\n          if (a.key === 'detailReport') {\r\n            detailReportVal = a.value;\r\n          }\r\n          if (a.key === 'progress') {\r\n            progressVal = a.value;\r\n          }\r\n        });\r\n        // Skip measurement if detailReport is true or progress is \"aborted\"\r\n        if (detailReportVal === true || detailReportVal === \"true\" ||\r\n            (progressVal && progressVal.toLowerCase() === \"aborted\")) {\r\n          return resolve();\r\n        }\r\n        if (measurementTypeVal === \"ultrasonic\") {\r\n          ultrasonicCount += 1;\r\n          includedMeasurements.push(meas.id.id);\r\n          return resolve();\r\n        } else if (measurementTypeVal === \"loraWan\") {\r\n          // For loraWan, fetch related sensors and only include if sensors exist.\r\n          getRelatedSensors(meas.id.id).subscribe(response => {\r\n            if (Array.isArray(response) && response.length > 0) {\r\n              loraWanSensorCount += response.length;\r\n              includedMeasurements.push(meas.id.id);\r\n            }\r\n            resolve();\r\n          }, err => {\r\n            console.error(\"Error fetching related sensors:\", err);\r\n            resolve();\r\n          });\r\n        } else {\r\n          resolve();\r\n        }\r\n      }, err => {\r\n        console.error(\"Error fetching measurement attributes:\", err);\r\n        resolve();\r\n      });\r\n    });\r\n  });\r\n  return Promise.all(promises).then(() => ({ ultrasonicCount, loraWanSensorCount, includedMeasurements }));\r\n}\r\n\r\n// Helper: Update a set of measurements with a given attribute key/value.\r\nfunction updateMeasurementsAttributes(attributeKey, attributeValue, measurementIds) {\r\n  measurementIds.forEach(id => {\r\n    attributeService.saveEntityAttributes(\r\n      { entityType: 'ASSET', id: id },\r\n      \"SERVER_SCOPE\",\r\n      [{ key: attributeKey, value: attributeValue }]\r\n    ).subscribe(\r\n      () => { console.log(`Updated measurement ${id} with ${attributeKey}`); },\r\n      (error) => { console.error(`Error updating measurement ${id} with ${attributeKey}:`, error); }\r\n    );\r\n  });\r\n}\r\n\r\n// Create invoice for one-time purchase for project and measurements\r\nasync function createInvoiceForOneTimePurchase(generalPriceData, ultrasonicPriceData, loraWanPriceData, instance) {\r\n  try {\r\n    // Compute measurement totals and obtain the list of measurement IDs to update.\r\n    const { ultrasonicCount, loraWanSensorCount, includedMeasurements } = await computeMeasurementTotals();\r\n    // Create a draft invoice first\r\n    let invoiceBody = new URLSearchParams({\r\n      customer: customerStripeId,\r\n      auto_advance: 'false',\r\n      collection_method: 'send_invoice',\r\n      days_until_due: '14'\r\n    });\r\n    const invoiceResp = await fetch('https://api.stripe.com/v1/invoices', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: invoiceBody\r\n    });\r\n    if (!invoiceResp.ok) {\r\n      throw new Error(`Error creating draft invoice: ${invoiceResp.statusText}`);\r\n    }\r\n    const invoiceData = await invoiceResp.json();\r\n    \r\n    // Create invoice item for Project Report (generalReport)\r\n    let invoiceItemBody = new URLSearchParams({\r\n      customer: customerStripeId,\r\n      invoice: invoiceData.id,\r\n      amount: String(generalPriceData.unit_amount),\r\n      currency: generalPriceData.currency,\r\n      description: `Project Report for: ${projectName}`\r\n    });\r\n    let invoiceItemResp = await fetch('https://api.stripe.com/v1/invoiceitems', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: invoiceItemBody\r\n    });\r\n    if (!invoiceItemResp.ok) {\r\n      throw new Error(`Error creating invoice item for project: ${invoiceItemResp.statusText}`);\r\n    }\r\n    await invoiceItemResp.json();\r\n    \r\n    // If there are ultrasonic measurements, add invoice item\r\n    if (ultrasonicCount > 0 && ultrasonicPriceData) {\r\n      let ultrasonicAmount = ultrasonicPriceData.unit_amount * ultrasonicCount;\r\n      let ultrasonicItemBody = new URLSearchParams({\r\n        customer: customerStripeId,\r\n        invoice: invoiceData.id,\r\n        amount: String(ultrasonicAmount),\r\n        currency: ultrasonicPriceData.currency,\r\n        description: `Ultrasonic Measurements (${ultrasonicCount} unit(s))`\r\n      });\r\n      let ultrasonicResp = await fetch('https://api.stripe.com/v1/invoiceitems', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${stripeSecretKey}`,\r\n          'Content-Type': 'application/x-www-form-urlencoded'\r\n        },\r\n        body: ultrasonicItemBody\r\n      });\r\n      if (!ultrasonicResp.ok) {\r\n        throw new Error(`Error creating invoice item for ultrasonic measurements: ${ultrasonicResp.statusText}`);\r\n      }\r\n      await ultrasonicResp.json();\r\n    }\r\n    \r\n    // If there are loraWan measurements, add invoice item\r\n    if (loraWanSensorCount > 0 && loraWanPriceData) {\r\n      let loraWanAmount = loraWanPriceData.unit_amount * loraWanSensorCount;\r\n      let loraWanItemBody = new URLSearchParams({\r\n        customer: customerStripeId,\r\n        invoice: invoiceData.id,\r\n        amount: String(loraWanAmount),\r\n        currency: loraWanPriceData.currency,\r\n        description: `LoRaWAN Measurements (Total sensors: ${loraWanSensorCount})`\r\n      });\r\n      let loraWanResp = await fetch('https://api.stripe.com/v1/invoiceitems', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${stripeSecretKey}`,\r\n          'Content-Type': 'application/x-www-form-urlencoded'\r\n        },\r\n        body: loraWanItemBody\r\n      });\r\n      if (!loraWanResp.ok) {\r\n        throw new Error(`Error creating invoice item for LoRaWAN measurements: ${loraWanResp.statusText}`);\r\n      }\r\n      await loraWanResp.json();\r\n    }\r\n    \r\n    // Finalize the invoice\r\n    const finalizeResp = await fetch(`https://api.stripe.com/v1/invoices/${invoiceData.id}/finalize`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`\r\n      }\r\n    });\r\n    if (!finalizeResp.ok) {\r\n      throw new Error(`Error finalizing invoice: ${finalizeResp.statusText}`);\r\n    }\r\n    await finalizeResp.json();\r\n    \r\n    // Save attributes for the project\r\n    const projectAttributes = [\r\n      { key: \"generalReport\", value: false },\r\n      { key: \"invoiceId\", value: invoiceData.id }\r\n    ];\r\n    attributeService.saveEntityAttributes(\r\n      { entityType: 'ASSET', id: projectID },\r\n      \"SERVER_SCOPE\",\r\n      projectAttributes\r\n    ).subscribe(\r\n      () => { console.log(\"Updated project with invoiceId\"); },\r\n      (error) => { console.error('Error updating project attribute:', error); }\r\n    );\r\n    // Also update each measurement that was included\r\n    updateMeasurementsAttributes(\"invoiceId\", invoiceData.id, includedMeasurements);\r\n    \r\n    alert(translationService.instant('custom.payment.alert.invoice-created-and-sent'));\r\n    instance.dialogRef.close(null);\r\n  } catch (err) {\r\n    console.error(\"Error creating invoice:\", err);\r\n    alert(translationService.instant('custom.payment.alert.failed-to-create-invoice'));\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\n// Create a Stripe Checkout session with multiple line items\r\nasync function createCheckoutSession(generalPriceData, ultrasonicPriceData, loraWanPriceData, instance) {\r\n  try {\r\n    // Compute measurement totals and obtain the list of measurement IDs to update.\r\n    const { ultrasonicCount, loraWanSensorCount, includedMeasurements } = await computeMeasurementTotals();\r\n    const successUrl = url;\r\n    const cancelUrl = url;\r\n    // Build URLSearchParams for line items (Stripe expects line_items[0], line_items[1], etc.)\r\n    let bodyParams = new URLSearchParams({\r\n      'success_url': successUrl,\r\n      'cancel_url': cancelUrl,\r\n      'payment_method_types[]': 'card',\r\n      'mode': 'payment',\r\n      'customer': customerStripeId\r\n    });\r\n    // Line item for project report\r\n    bodyParams.append('line_items[0][price_data][currency]', generalPriceData.currency);\r\n    bodyParams.append('line_items[0][price_data][unit_amount]', String(generalPriceData.unit_amount));\r\n    bodyParams.append('line_items[0][price_data][product_data][name]', `Project Report for: ${projectName}`);\r\n    bodyParams.append('line_items[0][quantity]', '1');\r\n    \r\n    let index = 1;\r\n    // If ultrasonic measurements exist, add a line item\r\n    if (ultrasonicCount > 0 && ultrasonicPriceData) {\r\n      bodyParams.append(`line_items[${index}][price_data][currency]`, ultrasonicPriceData.currency);\r\n      bodyParams.append(`line_items[${index}][price_data][unit_amount]`, String(ultrasonicPriceData.unit_amount));\r\n      bodyParams.append(`line_items[${index}][price_data][product_data][name]`, `Ultrasonic Measurements (${ultrasonicCount} unit(s))`);\r\n      bodyParams.append(`line_items[${index}][quantity]`, String(ultrasonicCount));\r\n      index++;\r\n    }\r\n    // If loraWan measurements exist, add a line item\r\n    if (loraWanSensorCount > 0 && loraWanPriceData) {\r\n      bodyParams.append(`line_items[${index}][price_data][currency]`, loraWanPriceData.currency);\r\n      bodyParams.append(`line_items[${index}][price_data][unit_amount]`, String(loraWanPriceData.unit_amount));\r\n      bodyParams.append(`line_items[${index}][price_data][product_data][name]`, `LoRaWAN Measurements (Total sensors: ${loraWanSensorCount})`);\r\n      bodyParams.append(`line_items[${index}][quantity]`, String(loraWanSensorCount));\r\n      index++;\r\n    }\r\n    \r\n    const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: bodyParams\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error: ${response.statusText}`);\r\n    }\r\n    const data = await response.json();\r\n    if (data.url) {\r\n      sessionId = data.id;\r\n      localStorage.setItem('sessionId', sessionId);\r\n      await new Promise((resolve, reject) => {\r\n        attributeService.saveEntityAttributes(\r\n          { entityType: 'ASSET', id: projectID },\r\n          \"SERVER_SCOPE\",\r\n          [{ key: \"sessionId\", value: sessionId }]\r\n        ).subscribe(\r\n          () => resolve(),\r\n          (error) => {\r\n            console.error('Error saving session ID attribute for project:', error);\r\n            reject(error);\r\n          }\r\n        );\r\n      });\r\n      // Also update each measurement that was included\r\n      updateMeasurementsAttributes(\"sessionId\", sessionId, includedMeasurements);\r\n      \r\n      instance.dialogRef.close(null);\r\n      window.location.href = data.url;\r\n    } else {\r\n      console.error('Checkout session URL not found in response');\r\n    }\r\n  } catch (error) {\r\n    console.error('Error creating checkout session:', error);\r\n  }\r\n}\r\n\r\nasync function checkPaymentStatus(sessionId, entityId) {\r\n  try {\r\n    if (!stripeSecretKey || !customerStripeId) {\r\n      await fetchStripeKeysAndCustomerId();\r\n    }\r\n    const response = await fetch(`https://api.stripe.com/v1/checkout/sessions/${sessionId}`, {\r\n      method: 'GET',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`\r\n      }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error: ${response.statusText}`);\r\n    }\r\n    const data = await response.json();\r\n    if (data.payment_status === 'paid') {\r\n      alert(translationService.instant('custom.payment.alert.payment-completed-successfully'));\r\n      const attributes = [\r\n        { key: \"generalReport\", value: true }\r\n      ];\r\n      attributeService.saveEntityAttributes(\r\n        { entityType: 'ASSET', id: projectID },\r\n        \"SERVER_SCOPE\",\r\n        attributes\r\n      ).subscribe(\r\n        () => {},\r\n        (error) => {\r\n          console.error('Error saving generalReport attribute:', error);\r\n        }\r\n      );\r\n      return 'paid';\r\n    } else {\r\n      alert(translationService.instant('custom.payment.alert.payment-was-not-successful'));\r\n      return data.payment_status;\r\n    }\r\n  } catch (error) {\r\n    console.error('Error checking payment status:', error);\r\n    return 'error';\r\n  }\r\n}\r\n\r\nasync function fetchStripeKeysAndCustomerId() {\r\n  return new Promise((resolve, reject) => {\r\n    assetService.getAssetInfo(projectID).subscribe(info => {\r\n      customerId = info.customerId;\r\n      projectName = info.name || projectID;\r\n      attributeService.getEntityAttributes(customerId, \"SERVER_SCOPE\", ['stripe_id']).subscribe(stripeId => {\r\n        customerStripeId = stripeId[0].value;\r\n        attributeService.getEntityAttributes(customer, \"SERVER_SCOPE\", ['stripeKey']).subscribe(attribute => {\r\n          stripeSecretKey = attribute[0].value;\r\n          resolve();\r\n        }, reject);\r\n      }, reject);\r\n    }, reject);\r\n  });\r\n}\r\n\r\nfunction checkSingleProjectStatus(mId) {\r\n  return new Promise((resolve, reject) => {\r\n    attributeService.getEntityAttributes(\r\n      { entityType: 'ASSET', id: mId },\r\n      \"SERVER_SCOPE\",\r\n      ['generalReport','invoiceId','sessionId']\r\n    ).subscribe(attrs => {\r\n      let generalReportVal = false;\r\n      let invoiceIdVal = null;\r\n      let sessionIdVal = null;\r\n      attrs.forEach(a => {\r\n        if (a.key === 'generalReport') generalReportVal = a.value;\r\n        if (a.key === 'invoiceId') invoiceIdVal = a.value;\r\n        if (a.key === 'sessionId') sessionIdVal = a.value;\r\n      });\r\n      if (generalReportVal === true) {\r\n        resolve(\"paid\");\r\n      } else {\r\n        if (sessionIdVal) {\r\n          checkStripeSessionPaid(sessionIdVal).then(isSessionPaid => {\r\n            if (isSessionPaid) {\r\n              resolve(\"paid\");\r\n            } else if (invoiceIdVal) {\r\n              checkStripeInvoice(invoiceIdVal).then(invStatus => {\r\n                if (invStatus === 'paid') resolve(\"paid\");\r\n                else if (invStatus === 'open') resolve(\"openInvoice\");\r\n                else resolve(\"unpaid\");\r\n              }).catch(() => reject());\r\n            } else {\r\n              resolve(\"unpaid\");\r\n            }\r\n          }).catch(() => reject());\r\n        } else if (invoiceIdVal) {\r\n          checkStripeInvoice(invoiceIdVal).then(invStatus => {\r\n            if (invStatus === 'paid') resolve(\"paid\");\r\n            else if (invStatus === 'open') resolve(\"openInvoice\");\r\n            else resolve(\"unpaid\");\r\n          }).catch(() => reject());\r\n        } else {\r\n          resolve(\"unpaid\");\r\n        }\r\n      }\r\n    }, err => reject(err));\r\n  });\r\n}\r\n\r\nfunction checkStripeSessionPaid(sid) {\r\n  return new Promise((resolve, reject) => {\r\n    fetchStripeKeysAndCustomerId().then(() => {\r\n      fetch(`https://api.stripe.com/v1/checkout/sessions/${sid}`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Authorization': `Bearer ${stripeSecretKey}`\r\n        }\r\n      })\r\n      .then(r => r.json())\r\n      .then(d => {\r\n        if (d.payment_status === 'paid') resolve(true);\r\n        else resolve(false);\r\n      })\r\n      .catch(() => reject());\r\n    }).catch(() => reject());\r\n  });\r\n}\r\n\r\nfunction checkStripeInvoice(invoiceIdVal) {\r\n  return new Promise((resolve, reject) => {\r\n    fetchStripeKeysAndCustomerId().then(() => {\r\n      fetch(`https://api.stripe.com/v1/invoices/${invoiceIdVal}`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Authorization': `Bearer ${stripeSecretKey}`\r\n        }\r\n      })\r\n      .then(r => r.json())\r\n      .then(d => {\r\n        if (d.status === 'paid') {\r\n          resolve('paid');\r\n        } else if (d.status === 'open' || d.status === 'draft') {\r\n          resolve('open');\r\n        } else {\r\n          resolve(d.status);\r\n        }\r\n      })\r\n      .catch(() => reject());\r\n    }).catch(() => reject());\r\n  });\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "10951210-5e89-3838-1bdf-f0c50003dec5"
              },
              {
                "name": "{i18n:custom.projects.project.open-measurements}",
                "icon": "straighten",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedProject'] = {\"entityId\":entityId,\"entityName\":entityName,\"entityLabel\":entityLabel}; \nwidgetContext.updateAliases();\nwidgetContext.stateController.updateState('Projects', params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "71c478b6-a4b1-e569-e99a-85d5562cc721"
              },
              {
                "name": "{i18n:custom.projects.project.edit-project}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"editEntityFormGroup\"\n      (ngSubmit)=\"save()\" \n      class=\"edit-entity-form w-11/12 max-w-3xl mx-auto\">\n    \n    <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n        <h2 class=\"text-lg font-semibold\">\n  {{ 'custom.projects.edit-project.edit-project-name' | translate:{ entityName: entityName } }}\n        </h2>\n        <span class=\"flex-1\"></span>\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n            <mat-icon>close</mat-icon>\n        </button>\n    </mat-toolbar>\n\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n\n    <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n        <div class=\"flex w-full gap-2\">\n            <mat-form-field appearance=\"fill\" class=\"flex-1\">\n                <mat-label>{{ 'custom.projects.edit-project.project-id' | translate }}</mat-label>\n                <input matInput \n                       formControlName=\"entityName\" \n                       required readonly>\n            </mat-form-field>\n\n            <mat-form-field appearance=\"fill\" class=\"flex-1\">\n                <mat-label>{{ 'custom.projects.edit-project.project-name' | translate }}</mat-label>\n                <input matInput \n                       formControlName=\"entityLabel\">\n            </mat-form-field>\n        </div>\n\n        <div formGroupName=\"attributes\">\n            <div class=\"flex w-full gap-2\">\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\n                    <mat-label>{{ 'custom.projects.edit-project.address' | translate }}</mat-label>\n                    <input matInput \n                           formControlName=\"address\">\n                </mat-form-field>\n            </div>\n\n            <div class=\"flex w-full gap-2\">\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\n                    <mat-label>{{ 'custom.projects.edit-project.latitude' | translate }}</mat-label>\n                    <input type=\"number\" \n                           step=\"any\" \n                           matInput \n                           formControlName=\"latitude\">\n                </mat-form-field>\n\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\n                    <mat-label>{{ 'custom.projects.edit-project.longitude' | translate }}</mat-label>\n                    <input type=\"number\"\n                           step=\"any\"\n                           matInput\n                           formControlName=\"longitude\">\n                </mat-form-field>\n            </div>\n\n            <div class=\"flex w-full gap-2\">\n                <mat-form-field appearance=\"fill\" class=\"w-full\">\n                    <mat-label>{{ 'custom.projects.edit-project.progress' | translate }}</mat-label>\n                    <mat-select formControlName=\"progress\">\n                        <mat-option value=\"in preparation\">{{ 'custom.projects.edit-project.in-preparation' | translate }}</mat-option>\n                        <mat-option value=\"active\">{{ 'custom.projects.edit-project.active' | translate }}</mat-option>\n                        <mat-option value=\"finished\">{{ 'custom.projects.edit-project.finished' | translate }}</mat-option>\n                    </mat-select>\n                </mat-form-field>\n            </div>\n            <div class=\"flex w-full gap-2\">\n              <tb-image-input formControlName=\"image\" label=\"Project Image\" noImageText=\"No image selected\"></tb-image-input>\n            </div>            \n        </div>\n    </div>\n\n    <div mat-dialog-actions class=\"flex justify-end gap-2\">\n        <button mat-button\n                color=\"primary\"\n                type=\"button\"\n                [disabled]=\"(isLoading$ | async)\"\n                (click)=\"cancel()\"\n                cdkFocusInitial>\n            {{ 'action.cancel' | translate }}\n        </button>\n        <button mat-button\n                mat-raised-button\n                color=\"primary\"\n                type=\"submit\"\n                [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid\">\n            {{ 'action.save' | translate }}\n        </button>\n    </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.edit-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.edit-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.edit-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.edit-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*.mat-form-field input[disabled] {\n  background-color: #f5f5f5;\n  cursor: not-allowed; \n  color: #9e9e9e;\n  \n}*/",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenEditEntityDialog();\n\nfunction openEditEntityDialog() {\n    customDialog.customDialog(htmlTemplate, EditEntityDialogController).subscribe();\n}\n\nfunction EditEntityDialogController(instance) {\n    let vm = instance;\n    vm.entityName = entityName; \n    vm.entityType = entityId.entityType;\n    vm.attributes = {};\n    vm.entity = {};\n\n    vm.editEntityFormGroup = vm.fb.group({\n        entityName: ['', [vm.validators.required]],\n        entityLabel: [null],\n        attributes: vm.fb.group({\n            address: [null],\n            latitude: [null],\n            longitude: [null],\n            progress: [null],\n            image: [null]\n        })\n    });\n\n    getEntityInfo();\n\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n\n    vm.save = function() {\n        vm.editEntityFormGroup.markAsPristine();\n        widgetContext.rxjs.forkJoin([\n            saveAttributes(entityId),\n            saveEntity()\n        ]).subscribe(() => {\n            widgetContext.updateAliases();\n            vm.dialogRef.close(null);\n        });\n    };\n\n    function getEntityInfo() {\n        widgetContext.rxjs.forkJoin([\n            attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE'),\n            entityService.getEntity(entityId.entityType, entityId.id)\n        ]).subscribe(([attrData, entityData]) => {\n            vm.attributes = {};\n            for (let i = 0; i < attrData.length; i++) {\n                vm.attributes[attrData[i].key] = attrData[i].value;\n            }\n\n            vm.entity = entityData;\n\n            vm.editEntityFormGroup.patchValue({\n                entityName: vm.entity.name,\n                entityLabel: vm.entity.label,\n                attributes: {\n                    address: vm.attributes.address,\n                    latitude: vm.attributes.latitude,\n                    longitude: vm.attributes.longitude,\n                    progress: vm.attributes.progress,\n                    image: vm.attributes.image\n                }\n            }, { emitEvent: false });\n        });\n    }\n\n    function saveEntity() {\n        const formValues = vm.editEntityFormGroup.value;\n        vm.entity.name = formValues.entityName;\n        vm.entity.label = formValues.entityLabel;\n\n        if (vm.entityType === 'ASSET') {\n            return assetService.saveAsset(vm.entity);\n        } else if (vm.entityType === 'DEVICE') {\n            return deviceService.saveDevice(vm.entity);\n        }\n        return widgetContext.rxjs.of([]);\n    }\n\n    function saveAttributes(entityId) {\n        const currentAttributes = vm.attributes;\n        const updatedAttributes = vm.editEntityFormGroup.value.attributes;\n        \n        let attributesArray = [];\n        for (let key in updatedAttributes) {\n            if (updatedAttributes.hasOwnProperty(key)) {\n                if (updatedAttributes[key] !== currentAttributes[key]) {\n                    attributesArray.push({ key: key, value: updatedAttributes[key] });\n                }\n            }\n        }\n\n        if (attributesArray.length > 0) {\n            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n        }\n        return widgetContext.rxjs.of([]);\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "9dea6b62-3ef6-b94f-a46b-bee18c6842a4"
              },
              {
                "name": "{i18n:custom.projects.project.delete-project}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\r\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\r\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\r\n\r\nlet projectEntityId = entityId.id;\r\nlet customerId;\r\n\r\nlet customerName = widgetContext.stateController.getStateParams().entityName;\r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        customerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n\r\n\r\nlet assetSearchQuery = {\r\n  \"parameters\": {\r\n    \"rootId\": projectEntityId,\r\n    \"rootType\": \"ASSET\",\r\n    \"direction\": \"FROM\",\r\n    \"relationTypeGroup\": \"COMMON\",\r\n    \"maxLevel\": 10,\r\n    \"fetchLastLevelOnly\": false\r\n  },\r\n  \"relationType\": \"Owns\",\r\n  \"assetTypes\": [\r\n    \"Measurement\"\r\n  ]\r\n};\r\n\r\nlet doktorkitSearchQuery = {\r\n  \"parameters\": {\r\n    \"rootId\": projectEntityId,\r\n    \"rootType\": \"ASSET\",\r\n    \"direction\": \"FROM\",\r\n    \"relationTypeGroup\": \"COMMON\",\r\n    \"maxLevel\": 10,\r\n    \"fetchLastLevelOnly\": false\r\n  },\r\n  \"relationType\": \"Owns\",\r\n  \"assetTypes\": [\r\n    \"Doktorkit\"\r\n  ]\r\n};\r\n\r\nassetService.findByQuery(assetSearchQuery).subscribe(measurements => {\r\n    assetService.findByQuery(doktorkitSearchQuery).subscribe(doktorkits => {\r\n        openDeleteDoktorkitDialog(measurements, doktorkits);\r\n    })\r\n});\r\n\r\nfunction addKitToUnassignedDoktorkits(doktorkits) {\r\n    return getUnassignedKitGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\r\n            const addKitObservables = doktorkits.map((item) => {\r\n                \r\n                return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, item.id.id);\r\n            });\r\n            \r\n            return widgetContext.rxjs.forkJoin(addKitObservables);\r\n        })\r\n    );\r\n}\r\n\r\n\r\nfunction openDeleteDoktorkitDialog(measurements, doktorkits) {\r\n  const title = translationService.instant(\r\n    'custom.doktorkits.delete.title',\r\n    { entityName: entityName }\r\n  );\r\n\r\n  const content = translationService.instant(\r\n    'custom.doktorkits.delete.content',\r\n    { count: measurements.length }\r\n  );\r\n\r\n  dialogs.confirm(\r\n    title,\r\n    content,\r\n    translationService.instant('action.cancel'),\r\n    translationService.instant('action.delete')\r\n  ).subscribe(function(result) {\r\n    if (result) {\r\n      deleteProject(measurements, doktorkits);\r\n    }\r\n  });\r\n}\r\n\r\nfunction deleteProject(measurements, doktorkits) {\r\n    addKitToUnassignedDoktorkits(doktorkits).subscribe();\r\n    deleteMeasurements(measurements);\r\n    assetService.deleteAsset(entityId.id).subscribe(\r\n        function() {\r\n            widgetContext.updateAliases();\r\n        }\r\n    );  \r\n}\r\n\r\nfunction deleteMeasurements(measurements) {\r\n    measurements.forEach(item => {\r\n        assetService.deleteAsset(item.id.id).subscribe(\r\n            function() {\r\n                widgetContext.updateAliases();\r\n            }\r\n        ); \r\n    })\r\n}\r\n\r\nfunction getUnassignedKitGroup(customerId) {\r\n  return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n      widgetContext.rxjs.switchMap((entityGroups) => {\r\n          var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n          if (UnassignedKitGroup) {\r\n              return widgetContext.rxjs.of(UnassignedKitGroup);\r\n          } else {\r\n              UnassignedKitGroup = {\r\n                  type: 'ASSET',\r\n                  name: 'Unassigned Kit',\r\n                  ownerId: customerId\r\n              };\r\n              return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n          }\r\n      })\r\n  );\r\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "338d9fd7-c752-eb0e-4687-2c2e32ca1a32"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.projects.project.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nparams['selectedCustomer'] = null;\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "36be8943-9088-db88-bc89-2c77c4b9e52a"
              },
              {
                "name": "{i18n:custom.projects.project.add-project}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addProjectFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 350px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">Add Project</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <div class=\"flex flex-col gap-0 sm:gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>Project ID</mat-label>\n            <input matInput formControlName=\"name\" required readonly>\n            <mat-error *ngIf=\"addProjectFormGroup.get('name').hasError('required')\">\n              Project title is required.\n            </mat-error>\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>Label</mat-label>\n            <input matInput formControlName=\"entityLabel\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>Project address</mat-label>\n            <input matInput formControlName=\"address\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>Latitude</mat-label>\n            <input matInput formControlName=\"latitude\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>Longitude</mat-label>\n            <input matInput formControlName=\"longitude\">\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      Cancel\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addProjectFormGroup.invalid || !addProjectFormGroup.dirty\">\n      Add Project\n    </button>\n  </div>\n</form>",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*.mat-form-field input[disabled] {\n  background-color: #f5f5f5;\n  cursor: not-allowed; \n  color: #9e9e9e;\n  \n}*/",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\n//let $scope = widgetContext.$scope;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet customerId;\r\nlet shortNameAttr;\r\nlet customerShortName;\r\nlet nextProjectId = 0;\r\n\r\nlet customerName = widgetContext.stateController.getStateParams().entityName;\r\nlet userRole = widgetContext.stateController.getStateParams().userRole;\r\n\r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN' || userRole === 'ECO Administrator') {\r\n        customerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n/*console.log(customerId.id);*/\r\n\r\nlet assetSearchQuery = {\r\n  \"parameters\": {\r\n    \"rootId\": customerId.id,\r\n    \"rootType\": \"CUSTOMER\",\r\n    \"direction\": \"FROM\",\r\n    \"relationTypeGroup\": \"COMMON\",\r\n    \"maxLevel\": 10,\r\n    \"fetchLastLevelOnly\": false\r\n  },\r\n  \"relationType\": \"Owns\",\r\n  \"assetTypes\": [\r\n    \"Project\"\r\n  ]\r\n};\r\nassetService.findByQuery(assetSearchQuery).subscribe(projects => {\r\n    /*console.log(projects);*/\r\n    nextProjectId = getLastProjectId(projects);\r\n    /*console.log(nextProjectId);*/\r\n    attributeService.getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName']).subscribe(attributes => {\r\n        shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n        customerShortName = shortNameAttr ? shortNameAttr.value : customerName;\r\n        openAddProjectDialog();\r\n    });\r\n});\r\n\r\nfunction getLastProjectId(projects) {\r\n    let maxNumber = 0;\r\n    projects.forEach(item => {\r\n        const name = item.name;\r\n        const parts = name.split('_');\r\n        if (parts.length === 2) {\r\n            const number = parseInt(parts[1], 10);\r\n            if (number > maxNumber) {\r\n                maxNumber = number;\r\n            }\r\n        }\r\n    });\r\n    const nextProjectId = maxNumber + 1;\r\n    return nextProjectId;\r\n}\r\n\r\nfunction openAddProjectDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddProjectDialogController).subscribe();\r\n}\r\n\r\nfunction AddProjectDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.addProjectFormGroup = vm.fb.group({\r\n    name: [customerShortName + \"_\" + nextProjectId, [vm.validators.required]],\r\n    entityLabel: [''],\r\n    address: [''],\r\n    latitude:[''],\r\n    longitude:['']\r\n  });\r\n  \r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    vm.addProjectFormGroup.markAsPristine();\r\n    saveProjectObservable(customerId).subscribe(\r\n      function (Project) {\r\n          widgetContext.rxjs.forkJoin([\r\n              saveCustomerToProjectRelation(customerId, Project.id),\r\n              saveAttributes(Project.id)\r\n          ]).subscribe(\r\n              function () {\r\n                var params = widgetContext.stateController.getStateParams();\r\n                var selectedProject = params['selectedProject'];\r\n                params['selectedProject'] = { entityId: Project.id, entityName: Project.name, entityLabel: '' };\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              }\r\n        );\r\n      }\r\n    );\r\n  };\r\n\r\n  function saveProjectObservable(customerId) {\r\n    return getProjectsGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((ProjectsGroup) => {\r\n            const formValues = vm.addProjectFormGroup.value;\r\n            let Project = {\r\n              name: formValues.name,\r\n              type: 'Project',\r\n              label: formValues.entityLabel,\r\n              customerId: customerId\r\n            };\r\n            return assetService.saveAsset(Project, ProjectsGroup.id.id)\r\n        })\r\n    );\r\n  }\r\n  \r\n  function getProjectsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var ProjectsGroup = entityGroups.find(group => group.name === 'Projects');\r\n              if (ProjectsGroup) {\r\n                  return widgetContext.rxjs.of(ProjectsGroup);\r\n              } else {\r\n                  ProjectsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Projects',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(ProjectsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n\r\n  function saveCustomerToProjectRelation(customerId, ProjectId) {\r\n      var relation = {\r\n          from: customerId,\r\n          to: ProjectId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  \r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n        {\r\n            key: 'latitude',\r\n            value: vm.addProjectFormGroup.value.latitude || 48.1406022\r\n        },\r\n        {\r\n            key: 'longitude',\r\n            value: vm.addProjectFormGroup.value.longitude || 16.2932688\r\n        },\r\n        {\r\n            key: 'address',\r\n            value: vm.addProjectFormGroup.value.address\r\n        },        \r\n        {\r\n            key: 'progress',\r\n            value: 'in preparation'\r\n        },\r\n        {\r\n            key: 'units',\r\n            value: 'metric'\r\n        }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e965b8a1-a6ac-5ae4-fd79-2b7220b91ed1"
              },
              {
                "name": "{i18n:custom.projects.project.transfer-project}",
                "buttonType": "icon",
                "icon": "mdi:swap-horizontal",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "/*var userRole = widgetContext.stateController.getStateParams().userRole;\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}*/\n\nreturn false;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addProjectFormGroup\" (ngSubmit)=\"save()\" style=\"width: 500px;\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Transfer Project</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <div fxLayout=\"column\">\r\n      <!-- Project Selection -->\r\n      <mat-form-field fxFlex>\r\n        <mat-label>Project</mat-label>\r\n        <mat-select formControlName=\"project\" required>\r\n          <mat-option *ngFor=\"let proj of projects\" [value]=\"proj\">\r\n            {{ proj.name }}\r\n          </mat-option>\r\n        </mat-select>\r\n        <mat-error *ngIf=\"addProjectFormGroup.get('project')?.hasError('required')\">\r\n          Project is required\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <div fxLayout=\"row\" fxLayoutAlign=\"center center\" style=\"padding-bottom: 20px;\">\r\n        <mat-icon>arrow_downward</mat-icon>\r\n      </div>\r\n\r\n      <mat-form-field fxFlex>\r\n        <mat-label>Customer</mat-label>\r\n        <mat-select formControlName=\"customer\" required>\r\n          <mat-option *ngFor=\"let cust of customers\" [value]=\"cust\">\r\n            {{ cust.title }}\r\n          </mat-option>\r\n        </mat-select>\r\n        <mat-error *ngIf=\"addProjectFormGroup.get('customer')?.hasError('required')\">\r\n          Customer is required\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <div fxLayout=\"row\" fxLayoutAlign=\"center center\" style=\"padding: 10px 0;\">\r\n        <mat-icon>arrow_downward</mat-icon>\r\n      </div>\r\n\r\n      <mat-form-field fxFlex>\r\n        <mat-label>Transferred Project</mat-label>\r\n        <input matInput [value]=\"transferredProject\" readonly>\r\n      </mat-form-field>\r\n\r\n      <div *ngIf=\"addProjectFormGroup.get('project').value && addProjectFormGroup.get('customer').value\" style=\"margin-top:10px;\">\r\n        \r\n        <!-- Measurements Section -->\r\n        <div *ngIf=\"measurementsData && measurementsData.length > 0\">\r\n          <div *ngFor=\"let item of measurementsData\" fxLayout=\"row\" fxLayoutAlign=\"start center\" style=\"margin-bottom:8px;\">\r\n            <mat-form-field fxFlex=\"45%\">\r\n              <mat-label>Found Measurement</mat-label>\r\n              <input matInput [value]=\"item.measurement.name\" readonly>\r\n            </mat-form-field>\r\n            <div style=\"padding: 0 10px;\">\r\n              <mat-icon>arrow_right_alt</mat-icon>\r\n            </div>\r\n            <mat-form-field fxFlex=\"45%\">\r\n              <mat-label>Transferred Measurement</mat-label>\r\n              <input matInput [value]=\"item.newName\" readonly>\r\n            </mat-form-field>\r\n          </div>\r\n        </div>\r\n\r\n        <div *ngIf=\"measurementsData\">\r\n          <div *ngFor=\"let item of measurementsData\">\r\n            <div *ngIf=\"item?.kits?.length > 0\">\r\n              <div *ngFor=\"let kit of item.kits\" fxLayout=\"row\" fxLayoutAlign=\"start center\" style=\"margin-bottom:8px;\">\r\n                <mat-form-field fxFlex=\"45%\">\r\n                  <mat-label>Found Kit</mat-label>\r\n                  <input matInput [value]=\"kit.name\" readonly>\r\n                </mat-form-field>\r\n                <div style=\"padding: 0 10px;\">\r\n                  <mat-icon>arrow_right_alt</mat-icon>\r\n                </div>\r\n                <mat-form-field fxFlex=\"45%\">\r\n                  <mat-label>Transferred Kit</mat-label>\r\n                  <input matInput [value]=\"kit.name\" readonly>\r\n                </mat-form-field>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div *ngIf=\"measurementsData\">\r\n          <div *ngFor=\"let item of measurementsData\">\r\n            <div *ngIf=\"item?.devices?.length > 0\">\r\n              <div *ngFor=\"let device of item.devices\" fxLayout=\"row\" fxLayoutAlign=\"start center\" style=\"margin-bottom:8px;\">\r\n                <mat-form-field fxFlex=\"45%\">\r\n                  <mat-label>Found Device</mat-label>\r\n                  <input matInput [value]=\"device.name\" readonly>\r\n                </mat-form-field>\r\n                <div style=\"padding: 0 10px;\">\r\n                  <mat-icon>arrow_right_alt</mat-icon>\r\n                </div>\r\n                <mat-form-field fxFlex=\"45%\">\r\n                  <mat-label>Transferred Device</mat-label>\r\n                  <input matInput [value]=\"device.name\" readonly>\r\n                </mat-form-field>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n      </div>\r\n      \r\n    </div>\r\n  </div>\r\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n    <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">Cancel</button>\r\n    <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"addProjectFormGroup.invalid\">\r\n      Save\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet customerId, customer;\r\n\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet assetSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id,\r\n    rootType: 'CUSTOMER',\r\n    direction: 'FROM',\r\n    relationTypeGroup: 'COMMON',\r\n    maxLevel: 10,\r\n    fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Project']\r\n};\r\n\r\nlet pageLink = {\r\n  pageSize: 100,\r\n  page: 0,\r\n  textSearch: '',\r\n  sortOrder: 'ASC',\r\n  sortProperty: 'title',\r\n  toQuery: function() {\r\n    let query = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) { query += '&textSearch=' + encodeURIComponent(this.textSearch); }\r\n    if (this.sortProperty) { query += '&sortProperty=' + encodeURIComponent(this.sortProperty); }\r\n    if (this.sortOrder) { query += '&sortOrder=' + encodeURIComponent(this.sortOrder); }\r\n    return query;\r\n  }\r\n};\r\n\r\nlet projects = [];\r\nlet customers = [];\r\nlet projectsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (projectsLoaded && customersLoaded) { openAddProjectDialog(projects, customers); }\r\n}\r\n\r\nassetService.findByQuery(assetSearchQuery).subscribe(\r\n  assets => { projects = assets; projectsLoaded = true; checkAndOpenDialog(); },\r\n  () => { projects = []; projectsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\ncustomerService.getCustomers(pageLink).subscribe(\r\n  pageData => {\r\n    customers = pageData.data;\r\n    if (customer) { customers = customers.filter(cust => cust.title !== customer); }\r\n    customersLoaded = true; checkAndOpenDialog();\r\n  },\r\n  () => { customers = []; customersLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\nfunction openAddProjectDialog(projectAssets, customers) {\r\n  customDialog.customDialog(htmlTemplate, AddProjectDialogController, {\r\n    projectNames: projectAssets,\r\n    customers: customers\r\n  }).subscribe();\r\n}\r\n\r\nfunction AddProjectDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.projects = data.projectNames || [];\r\n  vm.customers = data.customers || [];\r\n  vm.measurementsData = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n\r\n  vm.addProjectFormGroup = vm.fb.group({\r\n    project: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n\r\n  vm.cancel = function() { vm.dialogRef.close(null); };\r\n\r\n  vm.addProjectFormGroup.get('project').valueChanges.subscribe(selectedProject => {\r\n    if (selectedProject && selectedProject.id) {\r\n      let projectEntity = {\r\n        id: selectedProject.id.id ? selectedProject.id.id : selectedProject.id,\r\n        entityType: 'ASSET'\r\n      };\r\n      let measurementSearchQuery = {\r\n        parameters: {\r\n          rootId: projectEntity.id,\r\n          rootType: 'ASSET',\r\n          direction: 'FROM',\r\n          relationTypeGroup: 'COMMON',\r\n          maxLevel: 10,\r\n          fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Measurement']\r\n      };\r\n      assetService.findByQuery(measurementSearchQuery).subscribe(\r\n        measurements => {\r\n          let measurementRequests = measurements.map(m => {\r\n            let measId = { id: m.id.id ? m.id.id : m.id, entityType: 'ASSET' };\r\n            return attributeService.getEntityAttributes(measId, 'SERVER_SCOPE').pipe(\r\n              widgetContext.rxjs.switchMap(attrs => {\r\n                let measurementDataItem = { measurement: m, attributes: attrs, newName: '' };\r\n                let deviceSearchQuery = {\r\n                  parameters: {\r\n                    rootId: measId.id,\r\n                    rootType: 'ASSET',\r\n                    direction: 'FROM',\r\n                    relationTypeGroup: 'COMMON',\r\n                    maxLevel: 1073741824,\r\n                    fetchLastLevelOnly: true\r\n                  },\r\n                  relationType: 'Measurement',\r\n                  deviceTypes: ['P-Flow D116', 'Room Sensor CO2', 'Temperature Sensor', 'RESI', 'IoT Gateway']\r\n                };\r\n                return deviceService.findByQuery(deviceSearchQuery).pipe(\r\n                  widgetContext.rxjs.switchMap(devices => {\r\n                    measurementDataItem.devices = devices;\r\n                    if (devices && devices.length) {\r\n                      let kitRequests = devices.map(device => {\r\n                        let deviceId = device.id.id ? device.id.id : device.id;\r\n                        let kitSearchQuery = {\r\n                          parameters: {\r\n                            rootId: deviceId,\r\n                            rootType: 'DEVICE',\r\n                            direction: 'TO',\r\n                            relationTypeGroup: 'COMMON',\r\n                            maxLevel: 1073741824,\r\n                            fetchLastLevelOnly: false\r\n                          },\r\n                          relationType: 'Contains',\r\n                          assetTypes: ['Diagnostickit']\r\n                        };\r\n                        return assetService.findByQuery(kitSearchQuery).pipe(\r\n                          widgetContext.rxjs.map(kits => {\r\n                            return { device: device, kits: kits };\r\n                          })\r\n                        );\r\n                      });\r\n                      return widgetContext.rxjs.forkJoin(kitRequests).pipe(\r\n                        widgetContext.rxjs.map(devicesKits => {\r\n                          measurementDataItem.kits = devicesKits.reduce((acc, cur) => acc.concat(cur.kits), []);\r\n                          return measurementDataItem;\r\n                        })\r\n                      );\r\n                    } else {\r\n                      measurementDataItem.kits = [];\r\n                      return widgetContext.rxjs.of(measurementDataItem);\r\n                    }\r\n                  })\r\n                );\r\n              })\r\n            );\r\n          });\r\n          widgetContext.rxjs.forkJoin(measurementRequests).subscribe(\r\n            results => {\r\n              vm.measurementsData = results;\r\n            },\r\n            err => { vm.measurementsData = []; }\r\n          );\r\n        },\r\n        () => { vm.measurementsData = []; }\r\n      );\r\n    } else { vm.measurementsData = []; }\r\n  });\r\n\r\n  vm.addProjectFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId,\r\n          rootType: 'CUSTOMER',\r\n          direction: 'FROM',\r\n          relationTypeGroup: 'COMMON',\r\n          maxLevel: 10,\r\n          fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateTransferredProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateTransferredProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { vm.transferredProject = null; vm.customerShortName = null; }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null;\r\n      vm.customerShortName = null;\r\n      vm.measurementsData.forEach(m => (m.newName = ''));\r\n    }\r\n  });\r\n\r\n  vm.save = function() {\r\n    function getProjectsGroup(customerId) {\r\n        return entityGroupService.getEntityGroupsByOwnerId(\r\n            customerId.entityType,\r\n            customerId.id,\r\n            'ASSET'\r\n        ).pipe(\r\n            widgetContext.rxjs.switchMap((entityGroups) => {\r\n                let projectsGroup = entityGroups.find(group => group.name === 'Projects');\r\n                if (projectsGroup) {\r\n                    return widgetContext.rxjs.of(projectsGroup);\r\n                } else {\r\n                    // create a new \"Projects\" group\r\n                    projectsGroup = {\r\n                        type: 'ASSET',\r\n                        name: 'Projects',\r\n                        ownerId: customerId\r\n                    };\r\n                    return entityGroupService.saveEntityGroup(projectsGroup);\r\n                }\r\n            })\r\n        );\r\n    }\r\n\r\n    function getMeasurementsGroup(customerId) {\r\n        return entityGroupService.getEntityGroupsByOwnerId(\r\n            customerId.entityType,\r\n            customerId.id,\r\n            'ASSET'\r\n        ).pipe(\r\n            widgetContext.rxjs.switchMap((entityGroups) => {\r\n                let measurementsGroup = entityGroups.find(group => group.name === 'Measurements');\r\n                if (measurementsGroup) {\r\n                    return widgetContext.rxjs.of(measurementsGroup);\r\n                } else {\r\n                    // create a new \"Measurements\" group\r\n                    measurementsGroup = {\r\n                        type: 'ASSET',\r\n                        name: 'Measurements',\r\n                        ownerId: customerId\r\n                    };\r\n                    return entityGroupService.saveEntityGroup(measurementsGroup);\r\n                }\r\n            })\r\n        );\r\n    }\r\n    \r\n    function getDiagnostickitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((entityGroups) => {\r\n          let kitsGroup = entityGroups.find(group => group.name === 'Diagnostickits');\r\n          if (kitsGroup) {\r\n            return widgetContext.rxjs.of(kitsGroup);\r\n          } else {\r\n            kitsGroup = {\r\n              type: 'ASSET',\r\n              name: 'Diagnostickits',\r\n              ownerId: customerId\r\n            };\r\n            return entityGroupService.saveEntityGroup(kitsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n    function getDiagnostickitDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((entityGroups) => {\r\n          let devicesGroup = entityGroups.find(group => group.name === 'Diagnostickit Devices');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = {\r\n              type: 'DEVICE',\r\n              name: 'Diagnostickit Devices',\r\n              ownerId: customerId\r\n            };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getUnassignedDiagnostickitDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((entityGroups) => {\r\n          let unassignedGroup = entityGroups.find(group => group.name === 'Unassigned Diagnostickit Devices');\r\n          if (unassignedGroup) {\r\n            return widgetContext.rxjs.of(unassignedGroup);\r\n          } else {\r\n            unassignedGroup = {\r\n              type: 'DEVICE',\r\n              name: 'Unassigned Diagnostickit Devices',\r\n              ownerId: customerId\r\n            };\r\n            return entityGroupService.saveEntityGroup(unassignedGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n\r\n\r\n    function updateEntityRelation(newOwner, asset) {\r\n        return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n            widgetContext.rxjs.switchMap(() => {\r\n                let newRelation = {\r\n                    from: newOwner,\r\n                    to: asset,\r\n                    type: 'Owns',\r\n                    typeGroup: 'COMMON'\r\n                };\r\n                return entityRelationService.saveRelation(newRelation);\r\n            })\r\n        );\r\n    }\r\n\r\n    let formValue = vm.addProjectFormGroup.value;\r\n    formValue.transferredProject = vm.transferredProject;\r\n    let selectedCustomer = formValue.customer;\r\n\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n        let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n        let newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n        let projectAsset = formValue.project;\r\n        projectAsset.name = formValue.transferredProject;\r\n\r\n        assetService.saveAsset(projectAsset).subscribe(\r\n            updatedProject => {\r\n                let projectEntity = updatedProject.id && updatedProject.id.entityType\r\n                    ? updatedProject.id\r\n                    : { id: updatedProject.id, entityType: 'ASSET' };\r\n\r\n                entityGroupService.changeEntityOwner(newOwner, projectEntity).subscribe(\r\n                    () => {\r\n                        updateEntityRelation(newOwner, projectEntity).subscribe(\r\n                            () => {\r\n                                getProjectsGroup(newOwner).subscribe(\r\n                                    (projectsGroup) => {\r\n                                        entityGroupService.addEntitiesToEntityGroup(\r\n                                            projectsGroup.id.id,\r\n                                            [projectEntity.id]\r\n                                        ).subscribe(\r\n                                            () => {\r\n                                                let measurementObservables = vm.measurementsData.map(item => {\r\n                                                    let measurementAsset = item.measurement;\r\n                                                    measurementAsset.name = item.newName;\r\n                                                    return assetService.saveAsset(measurementAsset).pipe(\r\n                                                        widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n                                                            let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType\r\n                                                                ? updatedMeasurement.id\r\n                                                                : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n\r\n                                                            return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n                                                                widgetContext.rxjs.switchMap(() =>\r\n                                                                    updateEntityRelation(newOwner, measurementEntity)\r\n                                                                ),\r\n                                                                widgetContext.rxjs.switchMap(() =>\r\n                                                                    getMeasurementsGroup(newOwner)\r\n                                                                ),\r\n                                                                widgetContext.rxjs.switchMap((measurementsGroup) =>\r\n                                                                    entityGroupService.addEntitiesToEntityGroup(\r\n                                                                        measurementsGroup.id.id,\r\n                                                                        [measurementEntity.id]\r\n                                                                    )\r\n                                                                )\r\n                                                            );\r\n                                                        })\r\n                                                    );\r\n                                                });\r\n                                                let measurementUpdate$ = widgetContext.rxjs.forkJoin(measurementObservables);\r\n\r\n                                                let kitObservables = [];\r\n                                                vm.measurementsData.forEach(item => {\r\n                                                    if (item.kits && item.kits.length) {\r\n                                                        item.kits.forEach(kit => {\r\n                                                            kitObservables.push(\r\n                                                                assetService.saveAsset(kit).pipe(\r\n                                                                    widgetContext.rxjs.switchMap(updatedKit => {\r\n                                                                        let kitEntity = updatedKit.id && updatedKit.id.entityType\r\n                                                                            ? updatedKit.id\r\n                                                                            : { id: updatedKit.id, entityType: 'ASSET' };\r\n                                                                        return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n                                                                            widgetContext.rxjs.switchMap(() =>\r\n                                                                                 updateEntityRelation(newOwner, kitEntity)\r\n                                                      ),\r\n                                                      // Get or create Diagnostickits group and add the kit\r\n                                                      widgetContext.rxjs.switchMap(() =>\r\n                                                        getDiagnostickitsGroup(newOwner)\r\n                                                      ),\r\n                                                      widgetContext.rxjs.switchMap((kitsGroup) =>\r\n                                                        entityGroupService.addEntitiesToEntityGroup(kitsGroup.id.id, [kitEntity.id])\r\n                                                      )\r\n                                                    );\r\n                                                  })\r\n                                                )\r\n                                              );\r\n                                            });\r\n                                          }\r\n                                        });\r\n                                                let kitUpdate$ = kitObservables.length\r\n                                                    ? widgetContext.rxjs.forkJoin(kitObservables)\r\n                                                    : widgetContext.rxjs.of(null);\r\n\r\n                                                let deviceObservables = [];\r\n                                                vm.measurementsData.forEach(item => {\r\n                                                    if (item.devices && item.devices.length) {\r\n                                                        item.devices.forEach(device => {\r\n                                                            deviceObservables.push(\r\n                                                                deviceService.saveDevice(device).pipe(\r\n                                                                    widgetContext.rxjs.switchMap(updatedDevice => {\r\n                                                                        let deviceEntity = updatedDevice.id && updatedDevice.id.entityType\r\n                                                                            ? updatedDevice.id\r\n                                                                            : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n                                                                        return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n                                                                          // First add device to the Diagnostickit Devices group\r\n                                                                          widgetContext.rxjs.switchMap(() =>\r\n                                                                            getDiagnostickitDevicesGroup(newOwner)\r\n                                                                          ),\r\n                                                                          widgetContext.rxjs.switchMap((devicesGroup) =>\r\n                                                                            entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                                                                          ),\r\n                                                                          // Then check whether the device is related to any kit\r\n                                                                          widgetContext.rxjs.switchMap(() => {\r\n                                                                            // Use the same kit search query logic for a device:\r\n                                                                            let kitSearchQuery = {\r\n                                                                              parameters: {\r\n                                                                                rootId: deviceEntity.id,\r\n                                                                                rootType: 'DEVICE',\r\n                                                                                direction: 'TO',\r\n                                                                                relationTypeGroup: 'COMMON',\r\n                                                                                maxLevel: 1073741824,\r\n                                                                                fetchLastLevelOnly: false\r\n                                                                              },\r\n                                                                              relationType: 'Contains',\r\n                                                                              assetTypes: ['Diagnostickit']\r\n                                                                            };\r\n                                                                            return assetService.findByQuery(kitSearchQuery);\r\n                                                                          }),\r\n                                                                          // If no kit is found, add device to Unassigned Diagnostickit Devices group\r\n                                                                          widgetContext.rxjs.switchMap((kits) => {\r\n                                                                            if (!kits || kits.length === 0) {\r\n                                                                              return getUnassignedDiagnostickitDevicesGroup(newOwner).pipe(\r\n                                                                                widgetContext.rxjs.switchMap((unassignedGroup) =>\r\n                                                                                  entityGroupService.addEntitiesToEntityGroup(unassignedGroup.id.id, [deviceEntity.id])\r\n                                                                                )\r\n                                                                              );\r\n                                                                            } else {\r\n                                                                              return widgetContext.rxjs.of(null);\r\n                                                                            }\r\n                                                                          })\r\n                                                                        );\r\n                                                                    })\r\n                                                                )\r\n                                                            );\r\n                                                        });\r\n                                                    }\r\n                                                });\r\n                                                let deviceUpdate$ = deviceObservables.length\r\n                                                    ? widgetContext.rxjs.forkJoin(deviceObservables)\r\n                                                    : widgetContext.rxjs.of(null);\r\n\r\n                                                widgetContext.rxjs\r\n                                                    .forkJoin([measurementUpdate$, kitUpdate$, deviceUpdate$])\r\n                                                    .subscribe(\r\n                                                        () => {\r\n                                                            widgetContext.updateAliases();\r\n                                                            vm.dialogRef.close(formValue);\r\n                                                        },\r\n                                                        err => {\r\n                                                            console.error('Error updating measurement, kit, or device:', err);\r\n                                                        }\r\n                                                    );\r\n                                            },\r\n                                            err => {\r\n                                                console.error('Error adding project to Projects group:', err);\r\n                                            }\r\n                                        );\r\n                                    },\r\n                                    err => {\r\n                                        console.error('Error retrieving or creating Projects group:', err);\r\n                                    }\r\n                                );\r\n                            },\r\n                            error => {\r\n                                console.error('Error updating project relation:', error);\r\n                            }\r\n                        );\r\n                    },\r\n                    error => {\r\n                        console.error('Error changing project owner:', error);\r\n                    }\r\n                );\r\n            },\r\n            err => {\r\n                console.error('Error saving project asset:', err);\r\n            }\r\n        );\r\n\r\n    } else {\r\n        console.warn('No customer selected for the new owner.');\r\n    }\r\n};\r\n\r\n\r\n    function saveProjectObservable(customerId) {\r\n    return getProjectsGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((ProjectsGroup) => {\r\n            const formValues = vm.addProjectFormGroup.value;\r\n            let Project = {\r\n              name: formValues.name,\r\n              type: 'Project',\r\n              label: formValues.entityLabel,\r\n              customerId: customerId\r\n            };\r\n            return assetService.saveAsset(Project, ProjectsGroup.id.id)\r\n        })\r\n    );\r\n  }\r\n  \r\n  function getProjectsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var ProjectsGroup = entityGroups.find(group => group.name === 'Projects');\r\n              if (ProjectsGroup) {\r\n                  return widgetContext.rxjs.of(ProjectsGroup);\r\n              } else {\r\n                  ProjectsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Projects',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(ProjectsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  \r\n  function getMeasurementsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(\r\n        customerId.entityType, \r\n        customerId.id, \r\n        'ASSET'\r\n      ).pipe(\r\n        widgetContext.rxjs.switchMap((entityGroups) => {\r\n          let measurementsGroup = entityGroups.find(group => group.name === 'Measurements');\r\n          if (measurementsGroup) {\r\n            return widgetContext.rxjs.of(measurementsGroup);\r\n          } else {\r\n            measurementsGroup = {\r\n              type: 'ASSET',\r\n              name: 'Measurements',\r\n              ownerId: customerId\r\n            };\r\n            return entityGroupService.saveEntityGroup(measurementsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n  \r\n  \r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      })\r\n    );\r\n  }\r\n\r\n  function updateTransferredProjectName(customerShortName, existingProjects) {\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) { maxNumericSuffix = parsedNum; }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    while (existingNames.includes(candidate)) {\r\n      maxNumericSuffix++;\r\n      candidate = base + (maxNumericSuffix + 1);\r\n    }\r\n    vm.transferredProject = candidate;\r\n    renameMeasurements(vm.transferredProject);\r\n  }\r\n\r\n  function renameMeasurements(baseProjectName) {\r\n    vm.measurementsData.forEach(item => {\r\n      let oldName = item.measurement.name;\r\n      let parts = oldName.split('_');\r\n      if (parts.length >= 3) {\r\n        let afterSecond = parts.slice(2).join('_');\r\n        item.newName = baseProjectName + '_' + afterSecond;\r\n      } else { \r\n        item.newName = baseProjectName; \r\n      }\r\n    });\r\n  }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "c636ebdc-069b-3725-ebc7-65bcc05a48ee"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "pageSize": 1024,
          "configMode": "advanced",
          "titleFont": null,
          "titleColor": null,
          "titleIcon": null,
          "iconColor": null
        },
        "row": 0,
        "col": 0,
        "id": "2eb3b5d4-b23a-63f6-2295-ffdf59a880f5",
        "typeFullFqn": "system.cards.entities_table"
      },
      "29bc4f22-e66e-ed76-cdd5-a2f4c1424ebd": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "filterId": null,
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": true,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n<!--    <tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex=\"10\" stateId='edit_title'></tb-dashboard-state>\n    <tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex=\"10\" stateId='edit_label'></tb-dashboard-state>-->\n    <tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex=\"100\" stateId='edit_measurement_alias'></tb-dashboard-state>\n    <!--<tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex=\"20\" stateId='edit_measurement_plan'></tb-dashboard-state>-->\n</div>",
            "markdownTextFunction": "return '# Some title\\\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": false,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n"
          },
          "title": "Edit Measurement",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "font-size": "26px",
            "padding-bottom": "16px",
            "padding-left": "10px",
            "padding-top": "5px",
            "font-weight": "500"
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "save-title",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "const targetElement = $($event.target).closest('#save-title', widgetContext.$container[0]);\n\nvar title = $(targetElement).attr('data-title');\n\nwidgetContext.assetService.getAsset(entityId.id, {ignoreLoading: true}).subscribe((Measurement) => {\n    Measurement.name = title;\n    widgetContext.assetService.saveAsset(Measurement, null, {ignoreLoading: true}).subscribe(() => {\n       var stateParams = widgetContext.stateController.getStateParams();\n       stateParams.selectedMeasurement.entityName = title;\n       widgetContext.stateController.updateState(null, stateParams);\n       /*if (widgetContext.parentDashboard) {\n           widgetContext.parentDashboard.aliasController.updateAliases();\n       }\n       widgetContext.updateAliases();*/\n    });\n});\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "088a4799-8551-7ab4-892f-2a08d6d40a7c"
              }
            ],
            "headerButton": [
              {
                "name": "Go back",
                "icon": "arrow_back",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedMeasurement'] = null;\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f391e279-5095-d69f-7420-1cd0102329e9"
              },
              {
                "name": "Add Devices",
                "icon": "add",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDeviceFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 800px;\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Add device</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-horizontal-stepper formGroupName=\"stepper\" linear>\r\n      <mat-step formGroupName=\"assignmentStep\" label=\"Assignment\">\r\n        <ng-template matStepLabel>Assignment</ng-template>\r\n        <fieldset *ngIf=\"pFlowLimit || CO2Limit\" class=\"fieldset\" style=\"margin-bottom: 16px;\">\r\n            <div  fxLayout=\"column\" fxLayoutAlign=\"start start\" style=\"padding-top: 10px; padding-bottom: 10px;\">\r\n                <div fxLayout=\"row\" fxLayoutAlign=\"start center\" style=\"align-items: center;\">\r\n                    <mat-icon *ngIf=\"pFlowLimit\" style=\"margin-right: 8px;\">info</mat-icon>\r\n                    <p *ngIf=\"pFlowLimit\" style=\"font-size: 15px; margin: 0;\">You have reached the maximum Limit of P-Flows.</p>\r\n                </div>\r\n                <div fxLayout=\"row\" fxLayoutAlign=\"start center\" style=\"align-items: center;\">\r\n                    <mat-icon *ngIf=\"CO2Limit\" style=\"margin-right: 8px;\">info</mat-icon>\r\n                    <p *ngIf=\"CO2Limit\" style=\"font-size: 15px; margin: 0;\">You have reached the maximum Limit of CO2 Room Sensors.</p>\r\n                </div>\r\n            </div>\r\n        </fieldset>\r\n\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Device</mat-label>\r\n          <mat-select formControlName=\"device\" required>\r\n            <mat-select-trigger>\r\n              <div class=\"device-item\" fxLayout=\"column\" fxLayoutGap=\"4px\">\r\n                <!-- First Row: Device Name -->\r\n                <div fxLayout=\"row\">\r\n                  <div>{{ addDeviceFormGroup.get('stepper.assignmentStep.device').value?.name }}</div>\r\n                </div>\r\n                <!-- Second Row: Device Type on Left, Label on Right -->\r\n                <div fxLayout=\"row\" fxLayoutAlign=\"space-between center\">\r\n                  <div class=\"device-type\">{{ addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type }}</div>\r\n                  <div class=\"device-label\">{{ addDeviceFormGroup.get('stepper.assignmentStep.device').value?.label }}</div>\r\n                </div>\r\n              </div>\r\n            </mat-select-trigger>\r\n\r\n            <mat-option *ngFor=\"let device of availableDevices\" [value]=\"device\">\r\n              <div class=\"device-item\" fxLayout=\"column\" fxLayoutGap=\"4px\">\r\n                <div fxLayout=\"row\">\r\n                  <div>{{ device?.name }}</div>\r\n                </div>\r\n                <div fxLayout=\"row\" fxLayoutAlign=\"space-between center\">\r\n                  <div class=\"device-type\">{{ device?.type }}</div>\r\n                  <div class=\"device-name\">{{ device?.label }}</div>\r\n                </div>\r\n              </div>\r\n              <mat-divider></mat-divider>\r\n            </mat-option>\r\n\r\n            <mat-option *ngIf=\"!availableDevices?.length\" disabled [value]=\"null\">\r\n              <div class=\"device-item\">\r\n                No devices available\r\n              </div>\r\n            </mat-option>\r\n          </mat-select>\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').hasError('required')\">\r\n            Device is required.\r\n          </mat-error>\r\n        </mat-form-field>\r\n\r\n        <!-- Label Input Field -->\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Label</mat-label>\r\n          <input matInput formControlName=\"label\">\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.label').hasError('required')\">\r\n            Device label is required.\r\n          </mat-error>\r\n        </mat-form-field>\r\n\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\"\r\n                  type=\"button\"\r\n                  [disabled]=\"(isLoading$ | async)\"\r\n                  (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n          </button>\r\n          <button mat-button mat-raised-button color=\"primary\"\r\n                  type=\"submit\"\r\n                  [disabled]=\"(isLoading$ | async) || addDeviceFormGroup.invalid\">\r\n            Save\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>\r\n",
                "customCss": ".fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.device-item {\n    line-height: 24px;\n    width: 100%;\n    padding-top: 8px;\n    padding-bottom: 8px;\n}\n\n.device-item .device-name {\n    font-size: 12px;\n    opacity: 0.7;\n}\n\n.device-item .device-type {\n    font-size: 14px;\n    opacity: 0.7;\n}\n\nmat-option {\n    height: auto !important;\n    white-space: normal !important;\n}\n\n.mat-select-value-text {\n    display: block;\n    width: 100%;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\n\r\nconst measurementId = widgetContext.stateController.getStateParams()?.selectedMeasurement?.entityId;\r\n\r\nif (!measurementId || !measurementId.id) {\r\n    console.error(\"Invalid measurementId:\", measurementId);\r\n} else {\r\n    checkAssignedDevices(measurementId.id);\r\n}\r\n\r\nfunction checkAssignedDevices(measurementId) {\r\n    const deviceSearchQuery = {\r\n        parameters: {\r\n            rootId: measurementId,\r\n            rootType: \"ASSET\",\r\n            direction: \"FROM\",\r\n            relationTypeGroup: \"COMMON\",\r\n            maxLevel: 100,\r\n            fetchLastLevelOnly: false,\r\n        },\r\n        relationType: \"Measurement\",\r\n        deviceTypes: [\"P-Flow D116\", \"Room Sensor CO2\", \"Temperature Sensor\"]\r\n    };\r\n\r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n        (devices) => {\r\n            let maxLimitPFlows = false;\r\n            let maxLimitRoomSensorCO2 = false;\r\n\r\n            const pFlows = devices.filter(device => device.type === \"P-Flow D116\");\r\n            const roomSensorCO2 = devices.filter(device => device.type === \"Room Sensor CO2\");\r\n\r\n            if (pFlows.length > 0) {\r\n                maxLimitPFlows = true;\r\n            }\r\n            if (roomSensorCO2.length > 99) {\r\n                maxLimitRoomSensorCO2 = true;\r\n            }\r\n\r\n            openAddDeviceDialog(maxLimitPFlows, maxLimitRoomSensorCO2);\r\n        },\r\n        (error) => {\r\n            console.error(\"Error fetching devices:\", error);\r\n            openAddDeviceDialog(false, false);\r\n        }\r\n    );\r\n}\r\n\r\nfunction openAddDeviceDialog(maxLimitPFlows, maxLimitRoomSensorCO2) {\r\n    customDialog.customDialog(htmlTemplate, AddDeviceDialogController, {\r\n        measurementId,\r\n        maxLimitPFlows,\r\n        maxLimitRoomSensorCO2,\r\n    }).subscribe();\r\n}\r\n\r\nfunction AddDeviceDialogController(instance) {\r\n    let vm = instance;\r\n    const {\r\n        measurementId,\r\n        maxLimitPFlows,\r\n        maxLimitRoomSensorCO2,\r\n    } = vm.data || {};\r\n\r\n    vm.pFlowLimit = !!maxLimitPFlows;\r\n    vm.CO2Limit = !!maxLimitRoomSensorCO2;\r\n\r\n    vm.addDeviceFormGroup = vm.fb.group({\r\n        stepper: vm.fb.group({\r\n            assignmentStep: vm.fb.group({\r\n                device: [null, [vm.validators.required]],\r\n                label: [{ value: null, disabled: false }]\r\n            }),\r\n        })\r\n    });\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        var measurementId = widgetContext.stateController.getStateParams().selectedMeasurement.entityId;\r\n        vm.addDeviceFormGroup.markAsPristine();\r\n        var device = vm.addDeviceFormGroup.value.stepper.assignmentStep.device;\r\n        var label = vm.addDeviceFormGroup.value.stepper.assignmentStep.label;\r\n        var deviceId = device.deviceId;\r\n\r\n        widgetContext.rxjs.forkJoin([\r\n            entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n            saveDeviceToMeasurementRelation(measurementId, deviceId),\r\n            saveAttributes(deviceId),\r\n            updateDeviceLabel(device, label)\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedDevicesGroup = null;\r\n        vm.assignedDevicesGroup = null;\r\n        vm.availableDevices = [];\r\n        vm.assignedDevices = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'DEVICE').subscribe((entityGroups) => {\r\n            vm.customerDevicesGroups = entityGroups;\r\n            vm.unassignedDevicesGroup = entityGroups.find(group => group.name === 'Unassigned Measurement Devices');\r\n            vm.assignedDevicesGroup = entityGroups.find(group => group.name === 'Measurement Devices');\r\n\r\n            if (vm.unassignedDevicesGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.unassignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 1000,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    //console.log(\"data\",data);\r\n                    vm.availableDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value,\r\n                            deviceId: entityData.entityId\r\n                        };\r\n                    });\r\n                    //console.log(\"avail\",vm.availableDevices);\r\n                    // Apply filters based on limits\r\n                    if (maxLimitPFlows === true) {\r\n                        vm.availableDevices = vm.availableDevices.filter(device => device.type !== \"P-Flow D116\");\r\n                    }\r\n                    if (maxLimitRoomSensorCO2 === true) {\r\n                        vm.availableDevices = vm.availableDevices.filter(device => device.type !== \"Room Sensor CO2\");\r\n                    }\r\n\r\n                    // Custom sorting based on hexadecimal IDs\r\n                    vm.availableDevices.sort(function (a, b) {\r\n                        const hexPattern = /^ECO_([0-9A-Fa-f]{8})/;\r\n\r\n                        const matchA = a.name.match(hexPattern);\r\n                        const matchB = b.name.match(hexPattern);\r\n\r\n                        if (matchA && matchB) {\r\n                            const hexA = matchA[1];\r\n                            const hexB = matchB[1];\r\n\r\n                            const numA = parseInt(hexA, 16);\r\n                            const numB = parseInt(hexB, 16);\r\n\r\n                            return numA - numB;\r\n                        } else {\r\n                            // Fallback to string comparison if pattern doesn't match\r\n                            return a.name.localeCompare(b.name);\r\n                        }\r\n                    });\r\n\r\n                    // Optional: Log the sorted device names for verification\r\n                    // console.log('Sorted Device Names:', vm.availableDevices.map(device => device.name));\r\n                });\r\n\r\n            }\r\n\r\n            if (vm.assignedDevicesGroup) {\r\n                var query2 = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.assignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query2).subscribe((data) => {\r\n                    vm.assignedDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            deviceId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                    // Handle additional parameters if needed\r\n                    if (additionalParams && (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Device\")) {\r\n                        checkAdditionalParams();\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    function saveAttributes(deviceId) {\r\n        const attributesArray = [\r\n            { key: \"xPos\", value: \"0\" },\r\n            { key: \"yPos\", value: \"0\" }\r\n        ];\r\n        return attributeService.saveEntityAttributes(deviceId, 'SERVER_SCOPE', attributesArray);\r\n    }\r\n\r\n    function saveDeviceToMeasurementRelation(measurementId, deviceId) {\r\n        var relation = {\r\n            from: measurementId,\r\n            to: deviceId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Measurement'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function updateDeviceLabel(device, label) {\r\n        if (device.label !== label) {\r\n            return deviceService.getDevice(device.deviceId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origDevice) => {\r\n                    origDevice.label = label;\r\n                    return deviceService.saveDevice(origDevice);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableDevice = vm.availableDevices.find(device => device.name === additionalParams.code);\r\n        const matchingAssignedDevice = vm.assignedDevices.find(device => device.name === additionalParams.code);\r\n\r\n        if (!matchingAvailableDevice && !matchingAssignedDevice) {\r\n            widgetContext.dialogs.alert(\"Device doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedDevice && !matchingAvailableDevice) {\r\n            getMeasurement(additionalParams.code);\r\n        }\r\n        if (matchingAvailableDevice && matchingAssignedDevice) {\r\n            vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { device: matchingAvailableDevice } } }, { emitEvent: false });\r\n            vm.addDeviceFormGroup.get('stepper.assignmentStep.device').markAsDirty();\r\n            vm.addDeviceFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('mat-select[formControlName=\"device\"]');\r\n                if (selectElement) {\r\n                    selectElement.dispatchEvent(new Event('change'));\r\n                }\r\n\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n\r\n    function getMeasurement(code) {\r\n        vm.deviceEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToMeasurement = null;\r\n\r\n        deviceService.findByName(code)\r\n            .pipe(\r\n                widgetContext.rxjs.map((origDevice) => {\r\n                    vm.deviceEntityId = origDevice.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.deviceEntityId, 'entityType': 'DEVICE' }).pipe(\r\n                    widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations).pipe(\r\n                        widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToMeasurement = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-device\");\r\n                        let params = {\r\n                            \"measurement\": vm.assignedToMeasurement,\r\n                            \"device\": vm.deviceEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "26feafc8-21d5-484c-979b-5dff1a5d69bb"
              },
              {
                "name": "Add Devices old",
                "icon": "add",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addKitFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 800px;\">\r\n\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Add Kit</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div  mat-dialog-content fxLayout=\"column\">\r\n    <div *ngIf = \"kitAlreadyAssigned\" fxLayout=\"row\" fxLayoutAlign=\"start center\" style=\"align-items: center;\">\r\n        <mat-icon style=\"margin-right: 8px;\">info</mat-icon>\r\n        <p style=\"font-size: 20px; margin: 0;\">A Kit has already been assigned to this measurement.</p>\r\n    </div>\r\n    <mat-form-field *ngIf = \"!kitAlreadyAssigned\" class=\"mat-block\">\r\n      <mat-label>Kit</mat-label>\r\n      <mat-select formControlName=\"kit\" required>\r\n        <mat-select-trigger>\r\n          <div class=\"kit-item\" fxLayout=\"row\">\r\n            <div fxLayout=\"column\" fxFlex>\r\n              <div>{{addKitFormGroup.get('kit').value?.label}}</div>\r\n              <div class=\"kit-name\">{{addKitFormGroup.get('kit').value?.name}}</div>\r\n            </div>\r\n            <div class=\"kit-type\">{{addKitFormGroup.get('kit').value?.type}}</div>\r\n          </div>\r\n        </mat-select-trigger>\r\n        <mat-option *ngFor=\"let kit of availableKit\" [value]=\"kit\">\r\n          <div class=\"kit-item\" fxLayout=\"row\">\r\n            <div fxLayout=\"column\" fxFlex>\r\n              <div>{{kit?.label}}</div>\r\n              <div class=\"kit-name\">{{kit?.name}}</div>\r\n            </div>\r\n            <div class=\"kit-type\">{{kit?.type}}</div>\r\n          </div>\r\n          <mat-divider></mat-divider>\r\n        </mat-option>\r\n        <mat-option *ngIf=\"!availableKit?.length\" disabled [value]=\"null\">\r\n          <div class=\"kit-item\">No kits available</div>\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"addKitFormGroup.get('kit').hasError('required')\">\r\n        Kit is required.\r\n      </mat-error>\r\n    </mat-form-field>\r\n\r\n    <mat-form-field *ngIf = \"!kitAlreadyAssigned\" class=\"mat-block\">\r\n      <mat-label>Label</mat-label>\r\n      <input matInput formControlName=\"label\">\r\n      <mat-error *ngIf=\"addKitFormGroup.get('label').hasError('required')\">\r\n        Kit label is required.\r\n      </mat-error>\r\n    </mat-form-field>\r\n\r\n    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n      <button mat-button color=\"primary\"\r\n              type=\"button\"\r\n              [disabled]=\"(isLoading$ | async)\"\r\n              (click)=\"cancel()\" cdkFocusInitial>\r\n        Cancel\r\n      </button>\r\n      <button *ngIf = \"!kitAlreadyAssigned\" mat-button color=\"primary\" type=\"submit\">\r\n        Save\r\n      </button>\r\n    </div>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\n\r\nconst measurementId = widgetContext.stateController.getStateParams()?.selectedMeasurement?.entityId;\r\n\r\nif (!measurementId || !measurementId.id) {\r\n    console.error(\"Ungültige measurementId:\", measurementId);\r\n} else {\r\n    fetchAssignedAssets(measurementId.id);\r\n}\r\n\r\nfunction fetchAssignedAssets(measurementId) {\r\n    const assetSearchQuery = {\r\n        parameters: {\r\n            rootId: measurementId,\r\n            rootType: \"ASSET\",\r\n            direction: \"FROM\",\r\n            relationTypeGroup: \"COMMON\",\r\n            maxLevel: 100,\r\n            fetchLastLevelOnly: false,\r\n        },\r\n        relationType: \"Owns\",\r\n        assetTypes: [\"Doktorkit\"],\r\n    };\r\n\r\n    assetService.findByQuery(assetSearchQuery).subscribe(\r\n        (doktorkits) => {\r\n            let assignedDoktorkitName = 'No Kit assigned!';\r\n            let doktorkitId = null;\r\n\r\n            if (doktorkits.length > 0) {\r\n                const assignedDoktorkit = doktorkits[0];\r\n                assignedDoktorkitName = assignedDoktorkit?.name || 'No Kit assigned!';\r\n                doktorkitId = assignedDoktorkit?.id?.id || null;\r\n            }\r\n        openAddKitDialog(assignedDoktorkitName);\r\n        },\r\n        (error) => {\r\n            console.error(\"Fehler beim Abrufen des Doktorkits:\", error);\r\n            fetchAttributes('No Kit assigned!', 'No P-Flow assigned!');\r\n        }\r\n    );\r\n}\r\n/*if (additionalParams.source === \"replace Kit\") {\r\n    if (additionalParams.choice === true) {\r\n        openAddKitDialog();\r\n    } else {\r\n        // Handle other cases if needed\r\n    }\r\n} else if (additionalParams.source !== \"replace Kit\") {\r\n    openAddKitDialog();\r\n}*/\r\n\r\nfunction openAddKitDialog(assignedDoktorkitName) {\r\n    customDialog.customDialog(htmlTemplate, AddKitDialogController, {\r\n        measurementId,\r\n        assignedDoktorkitName,\r\n    }).subscribe();\r\n}\r\n\r\nfunction AddKitDialogController(instance) {\r\n    let vm = instance;\r\n    const {\r\n        measurementId,\r\n        assignedDoktorkitName,\r\n    } = vm.data || {};\r\n    \r\n    \r\n    vm.measurementId = measurementId;\r\n    \r\n    if(assignedDoktorkitName !== 'No Kit assigned!') {\r\n        vm.kitAlreadyAssigned = true;\r\n    } else if (assignedDoktorkitName === 'No Kit assigned!') {\r\n        vm.kitAlreadyAssigned = false;\r\n    }\r\n    \r\n    console.log(\"Kit assigned:\", vm.kitAlreadyAssigned);\r\n    \r\n    vm.addKitFormGroup = vm.fb.group({\r\n        kit: [null, [vm.validators.required]],\r\n        label: [{ value: null, disabled: true }]\r\n    });\r\n\r\n    vm.addKitFormGroup.get('kit').valueChanges.subscribe((kit) => {\r\n        vm.addKitFormGroup.get('label').patchValue(kit.label, { emitEvent: false });\r\n        vm.addKitFormGroup.get('label').enable({ emitEvent: false });\r\n        vm.addKitFormGroup.get('label').updateValueAndValidity({ onlySelf: true });\r\n    });\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        var MeasurementId = widgetContext.stateController.getStateParams().selectedMeasurement.entityId;\r\n        vm.addKitFormGroup.markAsPristine();\r\n        var kit = vm.addKitFormGroup.value.kit;\r\n        var label = vm.addKitFormGroup.value.label;\r\n        var kitId = kit.kitId;\r\n        \r\n        widgetContext.rxjs.forkJoin([\r\n            entityGroupService.removeEntityFromEntityGroup(vm.unassignedKitGroup.id.id, kitId.id),\r\n            saveKitToMeasurementRelation(MeasurementId, kitId),\r\n            updateKitLabel(kit, label)\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedKitGroup = null;\r\n        vm.availableKit = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'ASSET').subscribe((entityGroups) => {\r\n            vm.unassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n            if (vm.unassignedKitGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'ASSET',\r\n                        entityGroup: vm.unassignedKitGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    vm.availableKit = data.data.map((entityData) => {\r\n                        return {\r\n                            kitId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                });\r\n            }\r\n            if (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Kit\") {\r\n                checkAdditionalParams();\r\n            }\r\n        });\r\n    }\r\n\r\n    function saveKitToMeasurementRelation(MeasurementId, KitId) {\r\n        var relation = {\r\n            from: MeasurementId,\r\n            to: KitId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Owns'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function updateKitLabel(kit, label) {\r\n        if (kit.label !== label) {\r\n            return deviceService.getDevice(kit.kitId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origKit) => {\r\n                    origKit.label = label;\r\n                    return deviceService.saveDevice(origKit);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableKit = vm.availableKit.find(kit => kit.name === additionalParams.code);\r\n        const matchingAssignedKit = vm.assignedKits.find(kit => kit.name === additionalParams.code);\r\n\r\n        if (!matchingAvailableKit && !matchingAssignedKit) {\r\n            widgetContext.dialogs.alert(\"Kit doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedKit && !matchingAvailableKit) {\r\n            getMeasurement(additionalParams.code);\r\n        }\r\n        if (matchingAvailableKit && matchingAssignedKit) {\r\n            vm.addKitFormGroup.patchValue({ kit: matchingAvailableKit }, { emitEvent: false });\r\n            vm.addKitFormGroup.get('kit').markAsDirty();\r\n            vm.addKitFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('mat-select[formControlName=\"kit\"]');\r\n                if (selectElement) {\r\n                    selectElement.dispatchEvent(new Event('change'));\r\n                }\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n    \r\n    function getMeasurement(code) {\r\n        vm.kitEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToMeasurement = null;\r\n\r\n        deviceService.findByName(code)\r\n            .pipe(\r\n                widgetContext.rxjs.map((origKit) => {\r\n                    vm.kitEntityId = origKit.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.kitEntityId, 'entityType': 'ASSET' }).pipe(\r\n                    widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations).pipe(\r\n                        widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToMeasurement = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-kit\");\r\n                        let params = {\r\n                            \"measurement\": vm.assignedToMeasurement,\r\n                            \"kit\": vm.kitEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "27e85395-7e91-0ff2-68ae-ccf6d56e7c24"
              },
              {
                "name": "Measurement Parameters",
                "icon": "settings",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"addDeviceFormGroup\" (ngSubmit)=\"save()\" class=\"add-entity-form\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Edit Measurement Parameters</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-horizontal-stepper formGroupName=\"stepper\" linear>\r\n      <!-- Assignment Step -->\r\n      <mat-step formGroupName=\"assignmentStep\" label=\"Assignment\">\r\n        <ng-template matStepLabel>Assignment</ng-template>\r\n        \r\n        <!-- Assigned Kit Field -->\r\n        <!--<mat-form-field class=\"mat-block\">\r\n          <mat-label>Assigned Kit</mat-label>\r\n          <input matInput formControlName=\"assignedKit\" type=\"text\" readonly\r\n                 [ngClass]=\"{'error-text': !assignedKitAvailable}\">\r\n        </mat-form-field>-->\r\n\r\n        <!-- Assigned P-Flow Field -->\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Assigned P-Flow</mat-label>\r\n          <input matInput formControlName=\"assignedPFlow\" type=\"text\" readonly\r\n                 [ngClass]=\"{'error-text': !assignedPFlowAvailable}\">\r\n        </mat-form-field>\r\n\r\n        <!-- Progress Field -->\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Progress</mat-label>\r\n          <mat-select formControlName=\"progress\">\r\n            <mat-option value=\"in preparation\">In Preparation</mat-option>\r\n            <mat-option value=\"active\">Active</mat-option>\r\n            <mat-option value=\"finished\">Finished</mat-option>\r\n            <mat-option value=\"aborted\">Aborted</mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n\r\n        <!-- Start Date and Time -->\r\n        <section fxLayout=\"row\" fxLayoutAlign=\"center center\" fxLayoutGap=\"16px\" style=\"width: 100%;\">\r\n          <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\r\n            <mat-label>Start Date</mat-label>\r\n            <mat-datetimepicker-toggle [for]=\"startDatePicker\" matPrefix></mat-datetimepicker-toggle>\r\n            <mat-datetimepicker #startDatePicker type=\"date\" openOnFocus=\"true\"></mat-datetimepicker>\r\n            <input matInput formControlName=\"startDate\" [matDatetimepicker]=\"startDatePicker\">\r\n          </mat-form-field>\r\n          <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\r\n            <mat-label>Start Time</mat-label>\r\n            <mat-datetimepicker-toggle [for]=\"startTimePicker\" matPrefix></mat-datetimepicker-toggle>\r\n            <mat-datetimepicker #startTimePicker type=\"time\" openOnFocus=\"true\"></mat-datetimepicker>\r\n            <input matInput formControlName=\"startTime\" [matDatetimepicker]=\"startTimePicker\">\r\n          </mat-form-field>\r\n        </section>\r\n\r\n        <!-- End Date and Time -->\r\n        <section fxLayout=\"row\" fxLayoutAlign=\"center center\" fxLayoutGap=\"16px\" style=\"width: 100%;\">\r\n          <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\r\n            <mat-label>End Date</mat-label>\r\n            <mat-datetimepicker-toggle [for]=\"endDatePicker\" matPrefix></mat-datetimepicker-toggle>\r\n            <mat-datetimepicker #endDatePicker type=\"date\" openOnFocus=\"true\"></mat-datetimepicker>\r\n            <input matInput formControlName=\"endDate\" [matDatetimepicker]=\"endDatePicker\">\r\n          </mat-form-field>\r\n          <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\r\n            <mat-label>End Time</mat-label>\r\n            <mat-datetimepicker-toggle [for]=\"endTimePicker\" matPrefix></mat-datetimepicker-toggle>\r\n            <mat-datetimepicker #endTimePicker type=\"time\" openOnFocus=\"true\"></mat-datetimepicker>\r\n            <input matInput formControlName=\"endTime\" [matDatetimepicker]=\"endTimePicker\">\r\n          </mat-form-field>\r\n        </section>\r\n\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">Cancel</button>\r\n          <button mat-button matStepperNext color=\"primary\" type=\"button\" *ngIf=\"showAttributesStep\" [disabled]=\"!assignedPFlowAvailable\">Next</button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <!-- Attributes Step -->\r\n      <mat-step formGroupName=\"attributesStep\" label=\"Attributes\" *ngIf=\"showAttributesStep\">\r\n        <ng-template matStepLabel>Default Parameters</ng-template>\r\n\r\n        <!-- Dimension -->\r\n        <fieldset class=\"fieldset\">\r\n          <legend>Dimension</legend>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Dimension</mat-label>\r\n              <mat-select formControlName=\"dimension\" required>\r\n                <mat-option *ngFor=\"let dimension of dimensionOptions\" [value]=\"dimension\">{{ dimension }}</mat-option>\r\n              </mat-select>\r\n              <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.dimension').hasError('required')\">\r\n                Dimension is required.\r\n              </mat-error>\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Nominal Flow (m³/hr)</mat-label>\r\n              <input matInput formControlName=\"nominalFlow\" type=\"number\" readonly>\r\n            </mat-form-field>\r\n          </div>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" style=\"width:50%\">\r\n              <mat-label>Floor Volume (m³/hr)</mat-label>\r\n              <input matInput formControlName=\"deltaTAnalysisFloorVolume\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Pump Power (W)</mat-label>\r\n              <input matInput formControlName=\"deltaTAnalysisPumpEnergy\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n        </fieldset>\r\n\r\n        <!-- Installation Type -->\r\n        <fieldset class=\"fieldset\">\r\n          <legend>Installation</legend>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Installation Type</mat-label>\r\n              <mat-select formControlName=\"installationType\" required>\r\n                <mat-option value=\"heating\">Heating</mat-option>\r\n                <mat-option value=\"cooling\">Cooling</mat-option>\r\n              </mat-select>\r\n              <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationType').hasError('required')\">\r\n                Installation Type is required.\r\n              </mat-error>\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Installation Type Options</mat-label>\r\n              <mat-select formControlName=\"installationTypeOptions\" required>\r\n                <ng-container *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationType').value === 'heating'\">\r\n                  <mat-option value=\"radiatorHeating\">Radiator Heating</mat-option>\r\n                  <mat-option value=\"floorHeating\">Floor Heating</mat-option>\r\n                  <mat-option value=\"districtHeating\">District Heating</mat-option>\r\n                  <mat-option value=\"heatingOther\">Heating Other</mat-option>\r\n                </ng-container>\r\n                <ng-container *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationType').value === 'cooling'\">\r\n                  <mat-option value=\"coolingCircuit\">Cooling Circuit</mat-option>\r\n                  <mat-option value=\"coolingCeiling\">Cooling Ceiling</mat-option>\r\n                  <mat-option value=\"chiller\">Chiller</mat-option>\r\n                  <mat-option value=\"coolingOther\">Cooling Other</mat-option>\r\n                </ng-container>\r\n              </mat-select>\r\n              <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationTypeOptions').hasError('required')\">\r\n                Installation Type Option is required.\r\n              </mat-error>\r\n            </mat-form-field>\r\n          </div>\r\n        </fieldset>\r\n\r\n        <!-- Analysis -->\r\n        <fieldset class=\"fieldset\">\r\n          <legend>Analysis</legend>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Standard Outdoor Temperature</mat-label>\r\n              <input matInput formControlName=\"standardOutdoorTemperature\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Delta T</mat-label>\r\n              <input matInput formControlName=\"deltaT\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Outside Temperature Threshold Setting</mat-label>\r\n              <mat-select formControlName=\"loadCourseFilterTemperature\" required>\r\n                <mat-option value=\"above\">Above</mat-option>\r\n                <mat-option value=\"below\">Below</mat-option>\r\n              </mat-select>\r\n              <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.loadCourseFilterTemperature').hasError('required')\">\r\n                Temperature Condition is required.\r\n              </mat-error>\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Outside Temperature Threshold</mat-label>\r\n              <input matInput formControlName=\"loadCourseFilterTemperatureValue\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Maximum Power Threshold (%)</mat-label>\r\n              <input matInput formControlName=\"loadCourseFilterMaxPower\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" style=\"width:50%\">\r\n              <mat-label>Area</mat-label>\r\n              <input matInput formControlName=\"area\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\" style=\"width:50%\">\r\n              <mat-label>Unit</mat-label>\r\n              <input matInput formControlName=\"unit\" type=\"string\">\r\n            </mat-form-field>\r\n          </div>\r\n        </fieldset>\r\n\r\n        <!-- Specific Side Information -->\r\n        <!--<fieldset class=\"fieldset\">\r\n          <legend>Specific Side Information</legend>\r\n          \r\n        </fieldset>-->\r\n\r\n        <!-- Weekly Operating Schedule -->\r\n        <fieldset class=\"fieldset\">\r\n          <legend>Weekly Operating Schedule</legend>\r\n          <div formGroupName=\"weeklyOperatingSchedule\" fxLayout=\"row\" fxLayoutGap=\"6px\" fxLayoutAlign=\"space-between center\">\r\n            <mat-checkbox formControlName=\"monday\">Mon</mat-checkbox>\r\n            <mat-checkbox formControlName=\"tuesday\">Tue</mat-checkbox>\r\n            <mat-checkbox formControlName=\"wednesday\">Wed</mat-checkbox>\r\n            <mat-checkbox formControlName=\"thursday\">Thu</mat-checkbox>\r\n            <mat-checkbox formControlName=\"friday\">Fri</mat-checkbox>\r\n            <mat-checkbox formControlName=\"saturday\">Sat</mat-checkbox>\r\n            <mat-checkbox formControlName=\"sunday\">Sun</mat-checkbox>\r\n          </div>\r\n        </fieldset>\r\n\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">Cancel</button>\r\n          <button mat-button matStepperPrevious color=\"primary\" type=\"button\">Back</button>\r\n          <button mat-button matStepperNext color=\"primary\" type=\"button\" [disabled]=\"addDeviceFormGroup.invalid\">Next</button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <!-- Alarm Thresholds Step -->\r\n      <mat-step formGroupName=\"alarmThresholdsStep\" label=\"Alarm Thresholds\" *ngIf=\"showAlarmThresholdsStep\">\r\n        <ng-template matStepLabel>Alarm Thresholds</ng-template>\r\n        <div fxLayout=\"row\" fxLayoutGap=\"24px\">\r\n          <div fxFlex=\"50%\">\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Volume Flow Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"maxVolumeFlowCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Energy Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"maxEnergyCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Min Temperature Difference Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"minTemperatureDifferenceCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n          <div fxFlex=\"50%\">\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Volume Flow Major Threshold</mat-label>\r\n              <input matInput formControlName=\"maxVolumeFlowMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Energy Major Threshold</mat-label>\r\n              <input matInput formControlName=\"maxEnergyMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Min Temperature Difference Major Threshold</mat-label>\r\n              <input matInput formControlName=\"minTemperatureDifferenceMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n        </div>\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">Cancel</button>\r\n          <button mat-button matStepperPrevious color=\"primary\" type=\"button\">Back</button>\r\n          <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"addDeviceFormGroup.invalid\">Save</button>\r\n        </div>\r\n      </mat-step>\r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>\r\n",
                "customCss": ".mat-form-field input[disabled] {\n  background-color: #f5f5f5; /* Light grey background to indicate disabled state */\n  cursor: not-allowed; /* Change cursor to indicate non-interactive element */\n  color: #9e9e9e; /* Change text color to indicate disabled state */\n  \n}\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nconst {\r\n    customDialog,\r\n    entityService,\r\n    deviceService,\r\n    entityGroupService,\r\n    attributeService,\r\n    entityRelationService,\r\n    assetService,\r\n} = ['customDialog', 'entityService', 'deviceService', 'entityGroupService', 'attributeService', 'entityRelationService', 'assetService'].reduce((services, name) => {\r\n    services[name] = $injector.get(widgetContext.servicesMap.get(name));\r\n    return services;\r\n}, {});\r\n\r\nconst measurementId = widgetContext.stateController.getStateParams()?.selectedMeasurement?.entityId;\r\n\r\nif (!measurementId || !measurementId.id) {\r\n    console.error(\"Ungültige measurementId:\", measurementId);\r\n} else {\r\n    fetchAssignedDevices(measurementId.id);\r\n}\r\n\r\n/*function fetchAssignedAssetsAndDevices(measurementId) {\r\n    const assetSearchQuery = {\r\n        parameters: {\r\n            rootId: measurementId,\r\n            rootType: \"ASSET\",\r\n            direction: \"FROM\",\r\n            relationTypeGroup: \"COMMON\",\r\n            maxLevel: 100,\r\n            fetchLastLevelOnly: false,\r\n        },\r\n        relationType: \"Owns\",\r\n        assetTypes: [\"Doktorkit\"],\r\n    };\r\n\r\n    assetService.findByQuery(assetSearchQuery).subscribe(\r\n        (doktorkits) => {\r\n            let assignedDoktorkitName = 'No Kit assigned!';\r\n            let doktorkitId = null;\r\n\r\n            if (doktorkits.length > 0) {\r\n                const assignedDoktorkit = doktorkits[0];\r\n                assignedDoktorkitName = assignedDoktorkit?.name || 'No Kit assigned!';\r\n                doktorkitId = assignedDoktorkit?.id?.id || null;\r\n            }\r\n\r\n            if (!doktorkitId) {\r\n                fetchAttributes(assignedDoktorkitName, 'No P-Flow assigned!');\r\n                return;\r\n            }\r\n\r\n            fetchAssignedDevices(doktorkitId, assignedDoktorkitName);\r\n        },\r\n        (error) => {\r\n            console.error(\"Fehler beim Abrufen des Doktorkits:\", error);\r\n            fetchAttributes('No Kit assigned!', 'No P-Flow assigned!');\r\n        }\r\n    );\r\n}*/\r\n\r\nfunction fetchAssignedDevices(measurementId) {\r\n/*    if (!doktorkitId) {\r\n        fetchAttributes(assignedDoktorkitName, 'No P-Flow assigned!');\r\n        return;\r\n    }*/\r\n\r\n    const deviceSearchQuery = {\r\n        parameters: {\r\n            rootId: measurementId,\r\n            rootType: \"ASSET\",\r\n            direction: \"FROM\",\r\n            relationTypeGroup: \"COMMON\",\r\n            maxLevel: 100,\r\n            fetchLastLevelOnly: false,\r\n        },\r\n        relationType: \"Measurement\",\r\n        deviceTypes: [\"P-Flow D116\"],\r\n    };\r\n\r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n        (PFlows) => {\r\n            let assignedPFlowName = 'No P-Flow assigned!';\r\n\r\n            if (PFlows.length > 0) {\r\n                assignedPFlowName = PFlows[0]?.name || 'No P-Flow assigned!';\r\n            }\r\n\r\n            fetchAttributes(assignedPFlowName);\r\n        },\r\n        (error) => {\r\n            console.error(\"Fehler beim Abrufen des P-Flows:\", error);\r\n            fetchAttributes('No P-Flow assigned!');\r\n        }\r\n    );\r\n}\r\n\r\nfunction fetchAttributes(assignedPFlowName) {\r\n    attributeService.getEntityAttributes(measurementId).subscribe(\r\n        (attributes) => {\r\n            openAddDeviceDialog(assignedPFlowName, attributes);\r\n        },\r\n        (error) => {\r\n            console.error(\"Fehler beim Abrufen der Attribute:\", error);\r\n            openAddDeviceDialog(assignedPFlowName, null);\r\n        }\r\n    );\r\n}\r\n\r\nfunction openAddDeviceDialog(assignedPFlowName, attributes) {\r\n    customDialog\r\n        .customDialog(htmlTemplate, AddDeviceDialogController, {\r\n            measurementId,\r\n            assignedPFlowName,\r\n            attributes,\r\n        })\r\n        .subscribe();\r\n}\r\n\r\nfunction AddDeviceDialogController(instance) {\r\n    const vm = instance;\r\n    const {\r\n        measurementId,\r\n        assignedPFlowName,\r\n        attributes = [],\r\n    } = vm.data || {};\r\n\r\n    vm.measurementId = measurementId;\r\n    vm.attributes = attributes;\r\n    \r\n    // Assuming assignedDoktorkitName and assignedPFlowName are defined somewhere in your code\r\n    if (assignedPFlowName !=='No P-Flow assigned!') {\r\n        vm.showAttributesStep = true;\r\n        vm.showAlarmThresholdsStep = true;\r\n    } else {\r\n        vm.showAttributesStep = false;\r\n        vm.showAlarmThresholdsStep = false;\r\n    }\r\n\r\n    vm.assignedPFlowAvailable = assignedPFlowName !== 'No P-Flow assigned!';\r\n\r\n    vm.weekDays = [\r\n        { key: 'monday', label: 'Monday' },\r\n        { key: 'tuesday', label: 'Tuesday' },\r\n        { key: 'wednesday', label: 'Wednesday' },\r\n        { key: 'thursday', label: 'Thursday' },\r\n        { key: 'friday', label: 'Friday' },\r\n        { key: 'saturday', label: 'Saturday' },\r\n        { key: 'sunday', label: 'Sunday' },\r\n    ];\r\n\r\n    vm.heatingOptions = ['radiatorHeating', 'floorHeating', 'districtHeating', 'heatingOther'];\r\n    vm.coolingOptions = ['coolingCircuit', 'coolingCeiling', 'chiller', 'coolingOther'];\r\n    vm.dimensionOptions = ['DN15', 'DN20', 'DN25', 'DN32', 'DN40', 'DN50', 'DN65', 'DN80', 'DN100', 'DN125', 'DN150'];\r\n\r\n    vm.addDeviceFormGroup = vm.fb.group({\r\n        stepper: vm.fb.group({\r\n            assignmentStep: vm.fb.group({\r\n                assignedPFlow: [{ value: assignedPFlowName, disabled: true }, [vm.validators.required]],\r\n                progress: [{ value: 'in preparation', disabled: true }, [vm.validators.required]],\r\n                startDate: [{ value: null, disabled: true }],\r\n                startTime: [{ value: null, disabled: true }],\r\n                endDate: [{ value: null, disabled: true }],\r\n                endTime: [{ value: null, disabled: true }],\r\n            }),\r\n            attributesStep: vm.fb.group({\r\n                installationType: [null, [vm.validators.required]],\r\n                installationTypeOptions: ['', [vm.validators.required]],\r\n                standardOutdoorTemperature: [null],\r\n                loadCourseAnalysisTemperature: [null],\r\n                loadCourseFilterTemperature: [null, [vm.validators.required]],\r\n                loadCourseFilterTemperatureValue: [null],\r\n                loadCourseFilterMaxPower: [null],\r\n                nominalFlow: [null],\r\n                deltaT: [null],\r\n                deltaTAnalysisPumpEnergy: [null],\r\n                deltaTAnalysisFloorVolume: [null],\r\n                dimension: [null],\r\n                area:[null],\r\n                unit:[null],\r\n                weeklyOperatingSchedule: vm.fb.group(\r\n                    vm.weekDays.reduce((acc, day) => {\r\n                        acc[day.key] = [false];\r\n                        return acc;\r\n                    }, {})\r\n                ),\r\n            }),\r\n            alarmThresholdsStep: vm.fb.group({\r\n                maxVolumeFlowCriticalThreshold: [null],\r\n                maxVolumeFlowMajorThreshold: [null],\r\n                maxEnergyCriticalThreshold: [null],\r\n                maxEnergyMajorThreshold: [null],\r\n                minTemperatureDifferenceCriticalThreshold: [null],\r\n                minTemperatureDifferenceMajorThreshold: [null],\r\n                highCo2CriticalThreshold: [null],\r\n                highCo2MajorThreshold: [null],\r\n                highTemperatureCriticalThreshold: [null],\r\n                highHumidityCriticalThreshold: [null],\r\n                highTemperatureMajorThreshold: [null],\r\n                highHumidityMajorThreshold: [null],\r\n            }),\r\n        }),\r\n    });\r\n\r\n    initializeFormValues();\r\n    setupFormSubscriptions();\r\n\r\n    function initializeFormValues() {\r\n        // Mapping between attribute keys and form control names\r\n        const attributeToFormControlMap = {\r\n            'installationType': 'installationType',\r\n            'installationTypeOptions': 'installationTypeOptions',\r\n            'loadCourseFilterTemperature': 'loadCourseFilterTemperature',\r\n            'loadCourseFilterTemperatureValue': 'loadCourseFilterTemperatureValue',\r\n            'dimension': 'dimension',\r\n            'nominalFlow': 'nominalFlow',\r\n            'pumpPower': 'deltaTAnalysisPumpEnergy',\r\n            'standardOutsideTemperature': 'standardOutdoorTemperature',\r\n            'loadCourseFilterMaxPower': 'loadCourseFilterMaxPower',\r\n            'deltaT': 'deltaT',\r\n            'deltaTAnalysisFloorVolume': 'deltaTAnalysisFloorVolume',\r\n            'loadCourseAnalysisTemperature': 'loadCourseAnalysisTemperature',\r\n            'progress': 'progress',\r\n        };\r\n\r\n        attributes.forEach((attr) => {\r\n            const formControlName = attributeToFormControlMap[attr.key];\r\n            if (formControlName) {\r\n                vm.addDeviceFormGroup\r\n                    .get(`stepper.${['progress'].includes(formControlName) ? 'assignmentStep' : 'attributesStep'}.${formControlName}`)\r\n                    .setValue(attr.value);\r\n            } else if (attr.key === 'startTimeMs' || attr.key === 'endTimeMs') {\r\n                if (attr.value) {\r\n                    const dateTime = new Date(Number(attr.value));\r\n                    const dateControlName = attr.key === 'startTimeMs' ? 'startDate' : 'endDate';\r\n                    const timeControlName = attr.key === 'startTimeMs' ? 'startTime' : 'endTime';\r\n                    vm.addDeviceFormGroup.get(`stepper.assignmentStep.${dateControlName}`).setValue(dateTime);\r\n                    vm.addDeviceFormGroup.get(`stepper.assignmentStep.${timeControlName}`).setValue(dateTime);\r\n                }\r\n            } else if (attr.key === 'weeklySchedule') {\r\n                if (attr.value) {\r\n                    Object.keys(attr.value).forEach((day) => {\r\n                        vm.addDeviceFormGroup\r\n                            .get(`stepper.attributesStep.weeklyOperatingSchedule.${day}`)\r\n                            .setValue(attr.value[day]);\r\n                    });\r\n                }\r\n            }\r\n        });\r\n\r\n        updateProgressControl();\r\n    }\r\n    \r\n    let lastProgressValue = null;\r\n\r\n    function setupFormSubscriptions() {\r\n        vm.addDeviceFormGroup\r\n            .get('stepper.attributesStep.installationType')\r\n            .valueChanges.subscribe(() => {\r\n                updateInstallationTypeOptions();\r\n            });\r\n\r\n        vm.addDeviceFormGroup\r\n            .get('stepper.attributesStep.installationTypeOptions')\r\n            .valueChanges.subscribe((installationTypeOptions) => {\r\n                setDefaultDeltaT(installationTypeOptions);\r\n            });\r\n\r\n        vm.addDeviceFormGroup\r\n            .get('stepper.attributesStep.dimension')\r\n            .valueChanges.subscribe((dimension) => {\r\n                const nominalFlow = getNominalFlowByDimension(dimension);\r\n                vm.addDeviceFormGroup\r\n                    .get('stepper.attributesStep.nominalFlow')\r\n                    .setValue(nominalFlow);\r\n            });\r\n         // New subscription to calculate and set deltaTAnalysisFloorVolume\r\n        vm.addDeviceFormGroup\r\n            .get('stepper.attributesStep.nominalFlow')\r\n            .valueChanges.subscribe((nominalFlow) => {\r\n                if (nominalFlow) {\r\n                    const deltaTValue = (nominalFlow * 0.02).toFixed(3); // Calculate 2% of nominalFlow\r\n                    vm.addDeviceFormGroup\r\n                        .get('stepper.attributesStep.deltaTAnalysisFloorVolume')\r\n                        .setValue(deltaTValue);\r\n                }\r\n            });\r\n            \r\n        vm.addDeviceFormGroup\r\n        .get('stepper.assignmentStep.progress')\r\n        .valueChanges.subscribe((newValue) => {\r\n            if (newValue !== lastProgressValue) {\r\n                lastProgressValue = newValue;\r\n                updateProgressControl();\r\n            }\r\n        });\r\n    }\r\n\r\n    function updateProgressControl() {\r\n        const progressControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.progress');\r\n        const startDateControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.startDate');\r\n        const startTimeControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.startTime');\r\n        const endDateControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.endDate');\r\n        const endTimeControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.endTime');\r\n\r\n        if (!vm.assignedPFlowAvailable) {\r\n            progressControl.disable();\r\n            startDateControl.disable();\r\n            startTimeControl.disable();\r\n            endDateControl.disable();\r\n            endTimeControl.disable();\r\n        } else {\r\n            progressControl.enable();\r\n            startDateControl.enable();\r\n            startTimeControl.enable();\r\n            endDateControl.enable();\r\n            endTimeControl.enable();\r\n        }\r\n        \r\n        if (progressControl.value === 'active' && !startDateControl.value && !startTimeControl.value) {\r\n            const now = new Date();\r\n            startDateControl.setValue(now);\r\n            startTimeControl.setValue(now);\r\n        } else if((progressControl.value === 'finished' || progressControl.value === 'aborted') && startDateControl.value && \r\n            startTimeControl.value && !endDateControl.value && !endTimeControl.value) {\r\n            const now = new Date();\r\n            endDateControl.setValue(now);\r\n            endTimeControl.setValue(now);\r\n        }\r\n    }\r\n\r\n    function updateInstallationTypeOptions() {\r\n        const installationType = vm.addDeviceFormGroup.get('stepper.attributesStep.installationType').value;\r\n        let options = [];\r\n        if (installationType === 'heating') {\r\n            options = vm.heatingOptions;\r\n        } else if (installationType === 'cooling') {\r\n            options = vm.coolingOptions;\r\n        }\r\n        vm.filteredInstallationTypeOptions = options;\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.installationTypeOptions').setValue('');\r\n    }\r\n\r\n    function setDefaultDeltaT(installationTypeOptions) {\r\n        const deltaTValues = {\r\n            coolingCircuit: 6,\r\n            coolingCeiling: 3,\r\n            chiller: 6,\r\n            coolingOther: null,\r\n            radiatorHeating: 15,\r\n            floorHeating: 5,\r\n            districtHeating: 25,\r\n            heatingOther: null,\r\n        };\r\n        const deltaT = deltaTValues[installationTypeOptions] || null;\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.deltaT').setValue(deltaT);\r\n    }\r\n\r\n    function getNominalFlowByDimension(dimension) {\r\n        const dimensionToNominalFlow = {\r\n            DN15: 1.5,\r\n            DN20: 2.5,\r\n            DN25: 3.5,\r\n            DN32: 6,\r\n            DN40: 10,\r\n            DN50: 15,\r\n            DN65: 28.8,\r\n            DN80: 39.6,\r\n            DN100: 72,\r\n            DN125: 111.6,\r\n            DN150: 162,\r\n        };\r\n        return dimensionToNominalFlow[dimension] || null;\r\n    }\r\n\r\n    function parseDateTime(dateObj, timeObj) {\r\n        if (!dateObj || !timeObj) return null;\r\n        const date = new Date(dateObj);\r\n        const time = new Date(timeObj);\r\n        date.setHours(time.getHours(), time.getMinutes(), time.getSeconds(), time.getMilliseconds());\r\n        return date;\r\n    }\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        if (vm.addDeviceFormGroup.invalid) {\r\n            return;\r\n        }\r\n\r\n        const formData = vm.addDeviceFormGroup.value;\r\n        const assignmentStep = formData.stepper.assignmentStep;\r\n        const attributesStep = formData.stepper.attributesStep;\r\n        const alarmThresholdsStep = formData.stepper.alarmThresholdsStep;\r\n\r\n        const startDateTime = parseDateTime(assignmentStep.startDate, assignmentStep.startTime);\r\n        const endDateTime = parseDateTime(assignmentStep.endDate, assignmentStep.endTime);\r\n\r\n        const attributesArray = [\r\n            { key: 'xPos', value: 0.5 },\r\n            { key: 'yPos', value: 0.5 },\r\n            { key: 'installationType', value: attributesStep.installationType },\r\n            { key: 'installationTypeOptions', value: attributesStep.installationTypeOptions },\r\n            { key: 'progress', value: assignmentStep.progress },\r\n            { key: 'startTimeMs', value: startDateTime ? startDateTime.getTime() : null },\r\n            { key: 'endTimeMs', value: endDateTime ? endDateTime.getTime() : null },\r\n            { key: 'maxVolumeFlowCriticalThreshold', value: alarmThresholdsStep.maxVolumeFlowCriticalThreshold },\r\n            { key: 'maxVolumeFlowMajorThreshold', value: alarmThresholdsStep.maxVolumeFlowMajorThreshold },\r\n            { key: 'loadCourseAnalysisTemperature', value: attributesStep.loadCourseAnalysisTemperature },\r\n            { key: 'loadCourseFilterTemperature', value: attributesStep.loadCourseFilterTemperature },\r\n            { key: 'loadCourseFilterTemperatureValue', value: attributesStep.loadCourseFilterTemperatureValue },\r\n            { key: 'loadCourseFilterMaxPower', value: attributesStep.loadCourseFilterMaxPower },\r\n            { key: 'area', value: {\"value\":attributesStep.area, \"unit\":attributesStep.unit}},\r\n            { key: 'nominalFlow', value: attributesStep.nominalFlow },\r\n            { key: 'dimension', value: attributesStep.dimension },\r\n            { key: 'weeklySchedule', value: attributesStep.weeklyOperatingSchedule },\r\n            { key: 'deltaT', value: attributesStep.deltaT },\r\n            { key: 'deltaTAnalysisPumpEnergy', value: attributesStep.deltaTAnalysisPumpEnergy },\r\n            { key: 'deltaTAnalysisFloorVolume', value: attributesStep.deltaTAnalysisFloorVolume },\r\n            { key: 'maxEnergyCriticalThreshold', value: alarmThresholdsStep.maxEnergyCriticalThreshold },\r\n            { key: 'maxEnergyMajorThreshold', value: alarmThresholdsStep.maxEnergyMajorThreshold },\r\n            { key: 'minTemperatureDifferenceCriticalThreshold', value: alarmThresholdsStep.minTemperatureDifferenceCriticalThreshold },\r\n            { key: 'minTemperatureDifferenceMajorThreshold', value: alarmThresholdsStep.minTemperatureDifferenceMajorThreshold },\r\n            { key: 'highCo2CriticalThreshold', value: alarmThresholdsStep.highCo2CriticalThreshold },\r\n            { key: 'highCo2MajorThreshold', value: alarmThresholdsStep.highCo2MajorThreshold },\r\n            { key: 'highHumidityCriticalThreshold', value: alarmThresholdsStep.highHumidityCriticalThreshold },\r\n            { key: 'highHumidityMajorThreshold', value: alarmThresholdsStep.highHumidityMajorThreshold },\r\n            { key: 'highTemperatureCriticalThreshold', value: alarmThresholdsStep.highTemperatureCriticalThreshold },\r\n            { key: 'highTemperatureMajorThreshold', value: alarmThresholdsStep.highTemperatureMajorThreshold },\r\n        ];\r\n\r\n        attributeService.saveEntityAttributes(vm.measurementId, \"SERVER_SCOPE\", attributesArray).subscribe(\r\n            () => {\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n            },\r\n            (error) => {\r\n                console.error(\"Fehler beim Speichern der Attribute:\", error);\r\n            }\r\n        );\r\n    };\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "dd61dc57-da78-0fae-80f1-2b36654bb87a"
              },
              {
                "name": "Assigned Devices",
                "icon": "medical_services",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "measurement_devices",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "d98a9e1b-838a-5be1-28c7-cd682de58ace"
              },
              {
                "name": "Edit Floor plan",
                "icon": "mdi:floor-plan",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "devices_plan",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "41faf1fe-156b-0617-1683-b65717fbf8ae"
              },
              {
                "name": "Get Location",
                "icon": "location_on",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "getLocation",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Get location action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to get phone location', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processLocationFunction": "// Function body to process current location of the phone. \n// - latitude - phone location latitude\n// - longitude - phone location longitude\nlet $injector = widgetContext.$scope.$injector;\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\n//showLocationDialog('Location', latitude, longitude);\nsaveEntityLocationAttributes('latitude', 'longitude', latitude, longitude);\nfunction getSelectedKitId() {\n    let stateParams = widgetContext.stateController.getStateParams();\n    return stateParams.selectedDoktorkit.entityId;\n}\n\nfunction saveEntityLocationAttributes(latitudeAttributeName, longitudeAttributeName, latitude, longitude) {\n    let entityId = getSelectedKitId();\n    if (entityId) {\n        let attributes = [\n            { key: \"latitude\", value: latitude },\n            { key: \"longitude\", value: longitude }\n        ];\n        attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributes).subscribe(\n        widgetContext.dialogs.alert('Location attributes saved!\\nLatitude: ' + latitude + '\\nLongitude: ' + longitude),\n           function() {\n               widgetContext.showSuccessToast('Location attributes saved!');\n           },\n           function(error) {\n               widgetContext.dialogs.alert('Location attributes save failed', JSON.stringify(error));\n           }\n        );\n    }\n}\n\n\nfunction showLocationDialog(title, latitude, longitude) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Latitude: '+latitude+'<br>Longitude: ' + longitude).subscribe();\n    }, 100);\n}"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "2c3f1d4a-57f0-89d7-fc5f-8a5741a8a953"
              },
              {
                "name": "Delete Measurement",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet customerId;\nlet measurementEntityId = entityId.id;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n\n\nlet doktorkitSearchQuery = {\n  \"parameters\": {\n    \"rootId\": measurementEntityId,\n    \"rootType\": \"ASSET\",\n    \"direction\": \"FROM\",\n    \"relationTypeGroup\": \"COMMON\",\n    \"maxLevel\": 10,\n    \"fetchLastLevelOnly\": false\n  },\n  \"relationType\": \"Owns\",\n  \"assetTypes\": [\n    \"Doktorkit\"\n  ]\n};\n\nassetService.findByQuery(doktorkitSearchQuery).subscribe(doktorkits => {\n        openDeleteMeasurementDialog(doktorkits);\n    });\n\n\nfunction addKitToUnassignedDoktorkits(doktorkits) {\n    return getUnassignedKitGroup(customerId).pipe(\n        widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\n            const addKitObservables = doktorkits.map((item) => {\n                \n                return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, item.id.id);\n            });\n            \n            return widgetContext.rxjs.forkJoin(addKitObservables);\n        })\n    );\n}\nfunction getUnassignedKitGroup(customerId) {\n  return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\n      widgetContext.rxjs.switchMap((entityGroups) => {\n          var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\n          if (UnassignedKitGroup) {\n              return widgetContext.rxjs.of(UnassignedKitGroup);\n          } else {\n              UnassignedKitGroup = {\n                  type: 'ASSET',\n                  name: 'Unassigned Kit',\n                  ownerId: customerId\n              };\n              return entityGroupService.saveEntityGroup(UnassignedKitGroup);\n          }\n      })\n  );\n}\nfunction openDeleteMeasurementDialog(doktorkits) {\n  let title = 'Are you sure you want to delete the Measurement ' + entityName + '?';\n  let content = 'Be careful, after the confirmation, the Measurement will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteMeasurement(doktorkits);\n      }\n    }\n  );\n}\n\nfunction deleteMeasurement(doktorkits) {\n  addKitToUnassignedDoktorkits(doktorkits).subscribe();\n  let relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      let removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  let removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteMeasurementToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  let unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Measurement Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Measurement Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteMeasurementToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f1eb48d4-6320-03b7-440f-382a53375049"
              }
            ]
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "29bc4f22-e66e-ed76-cdd5-a2f4c1424ebd",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "89a03141-e3ba-4e60-661b-c36e1ec2360d": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
              "filterId": null,
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <div fxLayout=\"row\">\n        <tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex style=\"height: 730px;\" stateId='edit_project_alias'></tb-dashboard-state>\n    </div>\n</div>",
            "markdownTextFunction": "return '# Some title\\\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": false,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "save-title",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "const targetElement = $($event.target).closest('#save-title', widgetContext.$container[0]);\n\nvar title = $(targetElement).attr('data-title');\n\nwidgetContext.assetService.getAsset(entityId.id, {ignoreLoading: true}).subscribe((Project) => {\n    Project.name = title;\n    widgetContext.assetService.saveAsset(Project, null, {ignoreLoading: true}).subscribe(() => {\n       var stateParams = widgetContext.stateController.getStateParams();\n       stateParams.selectedProject.entityName = title;\n       widgetContext.stateController.updateState(null, stateParams);\n       /*if (widgetContext.parentDashboard) {\n           widgetContext.parentDashboard.aliasController.updateAliases();\n       }\n       widgetContext.updateAliases();*/\n    });\n});\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "088a4799-8551-7ab4-892f-2a08d6d40a7c"
              }
            ]
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "89a03141-e3ba-4e60-661b-c36e1ec2360d",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "792f905b-6762-d356-e852-8960355c20bb": {
        "typeFullFqn": "system.input_widgets.update_multiple_attributes",
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Project Name",
                  "color": "#f44336",
                  "settings": {
                    "dataKeyHidden": false,
                    "dataKeyType": "server",
                    "dataKeyValueType": "string",
                    "required": false,
                    "isEditable": "readonly",
                    "disabledOnDataKey": "",
                    "appearance": "outline",
                    "subscriptSizing": "fixed",
                    "slideToggleLabelPosition": "after",
                    "selectOptions": [],
                    "step": 1,
                    "minValue": null,
                    "maxValue": null,
                    "requiredErrorMessage": "",
                    "minValueErrorMessage": "",
                    "maxValueErrorMessage": "",
                    "invalidDateErrorMessage": "",
                    "invalidJsonErrorMessage": "",
                    "dialogTitle": "",
                    "saveButtonLabel": "",
                    "cancelButtonLabel": "",
                    "useCustomIcon": false,
                    "icon": "",
                    "customIcon": "",
                    "useGetValueFunction": false,
                    "getValueFunctionBody": "",
                    "useSetValueFunction": false,
                    "setValueFunctionBody": ""
                  },
                  "_hash": 0.7261262741197994,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#048AD3",
                  "settings": {},
                  "_hash": 0.5038713353626756
                },
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "Address",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.7434410240897191,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "Progress",
                  "color": "#ffc107",
                  "settings": {
                    "dataKeyHidden": false,
                    "dataKeyType": "server",
                    "dataKeyValueType": "select",
                    "required": false,
                    "isEditable": "editable",
                    "disabledOnDataKey": "",
                    "appearance": "outline",
                    "subscriptSizing": "fixed",
                    "slideToggleLabelPosition": "after",
                    "selectOptions": [
                      {
                        "value": "in preparation",
                        "label": "In Preparation"
                      },
                      {
                        "value": "active",
                        "label": "Active"
                      },
                      {
                        "value": "finished",
                        "label": "Finished"
                      }
                    ],
                    "step": 1,
                    "minValue": null,
                    "maxValue": null,
                    "requiredErrorMessage": "",
                    "minValueErrorMessage": "",
                    "maxValueErrorMessage": "",
                    "invalidDateErrorMessage": "",
                    "invalidJsonErrorMessage": "",
                    "dialogTitle": "",
                    "saveButtonLabel": "",
                    "cancelButtonLabel": "",
                    "useCustomIcon": false,
                    "icon": "",
                    "customIcon": "",
                    "useGetValueFunction": false,
                    "getValueFunctionBody": "",
                    "useSetValueFunction": false,
                    "setValueFunctionBody": ""
                  },
                  "_hash": 0.3710536025574047,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1707571374578,
                "endTimeMs": 1707657774578
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": null,
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "40",
          "settings": {
            "widgetTitle": "Doktorkit Attributes",
            "showResultMessage": true,
            "showActionButtons": true,
            "updateAllValues": true,
            "saveButtonLabel": "Save",
            "resetButtonLabel": "Undo",
            "showGroupTitle": false,
            "groupTitle": "${entityName}",
            "fieldsAlignment": "row",
            "fieldsInRow": 1,
            "rowGap": 5,
            "columnGap": 10
          },
          "title": "Update Multiple Attributes",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "actions": {
            "headerButton": []
          },
          "displayTimewindow": true,
          "showTitleIcon": false,
          "titleTooltip": "",
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "titleIcon": null,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px"
        },
        "row": 0,
        "col": 0,
        "id": "792f905b-6762-d356-e852-8960355c20bb"
      },
      "68e52426-3b51-1e15-5564-c3f1922057bb": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "address",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.7546586070710162
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "showResultMessage": false,
            "showLabel": true,
            "isRequired": true,
            "labelValue": "Address",
            "requiredErrorMessage": "Address is required"
          },
          "title": "New Update server string attribute",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "actions": {},
          "showTitleIcon": false,
          "titleTooltip": "",
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "68e52426-3b51-1e15-5564-c3f1922057bb",
        "typeFullFqn": "system.input_widgets.update_server_string_attribute"
      },
      "30311521-81d4-308a-e02c-1a33bcfdf2cf": {
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "latitude",
                  "type": "attribute",
                  "label": "latitude",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.862061599769905
                },
                {
                  "name": "longitude",
                  "type": "attribute",
                  "label": "longitude",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.017864596400994026
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "provider": "openstreet-map",
            "gmApiKey": "AIzaSyDoEx2kaGz3PxwbI9T7ccTSg5xjdw8Nw8Q",
            "gmDefaultMapType": "roadmap",
            "mapProvider": "CartoDB.Positron",
            "useCustomProvider": false,
            "customProviderTileUrl": "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            "mapProviderHere": "HERE.normalDay",
            "credentials": {
              "app_id": "AhM6TzD9ThyK78CT3ptx",
              "app_code": "p6NPiITB3Vv0GMUFnkLOOg"
            },
            "mapImageUrl": "tb-image;/api/images/system/here_map_system_widget_map_image.svg",
            "tmApiKey": "84d6d83e0e51e481e50454ccbe8986b",
            "tmDefaultMapType": "roadmap",
            "latKeyName": "latitude",
            "lngKeyName": "longitude",
            "xPosKeyName": "xPos",
            "yPosKeyName": "yPos",
            "defaultZoomLevel": 14,
            "defaultCenterPosition": "0,0",
            "disableScrollZooming": false,
            "disableDoubleClickZooming": false,
            "disableZoomControl": false,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "mapPageSize": 16384,
            "markerOffsetX": 0.5,
            "markerOffsetY": 1,
            "posFunction": "return {x: origXPos, y: origYPos};",
            "draggableMarker": true,
            "showLabel": true,
            "useLabelFunction": false,
            "label": "${entityName}",
            "labelFunction": "var deviceType = dsData[dsIndex]['Type'];\r\nif (typeof deviceType !== undefined) {\r\n    if (deviceType == \"energy meter\") {\r\n        return '<span style=\"color:orange;\">${entityName}, ${energy:2} kWt</span>';\r\n    } else if (deviceType == \"thermometer\") {\r\n        return '<span style=\"color:blue;\">${entityName}, ${temperature:2} °C</span>';\r\n    }\r\n}",
            "showTooltip": false,
            "showTooltipAction": "click",
            "autocloseTooltip": true,
            "useTooltipFunction": false,
            "tooltipPattern": "<b>${entityName}</b><br/><br/><link-act name='Doktorkit-devices'>Doktorkit devices</link-act>",
            "tooltipFunction": "var deviceType = dsData[dsIndex]['Type'];\r\nif (typeof deviceType !== undefined) {\r\n    if (deviceType == \"energy meter\") {\r\n        return '<b>${entityName}</b><br/><b>Energy:</b> ${energy:2} kWt<br/>';\r\n    } else if (deviceType == \"thermometer\") {\r\n        return '<b>${entityName}</b><br/><b>Temperature:</b> ${temperature:2} °C<br/>';\r\n    }\r\n}",
            "tooltipOffsetX": 0,
            "tooltipOffsetY": -1,
            "color": "#fe7569",
            "useColorFunction": false,
            "useMarkerImageFunction": true,
            "markerImageSize": 34,
            "markerImageFunction": "var width = 30;\nvar svgStr = getDoktorkitSvg(width);\nvar encodedSvg = encodeURIComponent(svgStr);\nvar svgUrl = 'data:image/svg+xml,' + encodedSvg;\n\nreturn {\n    url: svgUrl,\n    size: width,\n    markerOffset: [width / 2, width / 2],\n    tooltipOffset: [width * 0.5 - width / 2, - (width / 2)]\n};\n\nfunction getDoktorkitSvg(width, isSelected) {\n    var shape = '<path d=\"m18.636 15.8c0.59978 0 1.1276-0.32788 1.3995-0.82369l2.8629-5.1901c0.29589-0.5278-0.08796-1.1836-0.69574-1.1836h-11.836l-0.75172-1.5994h-2.615v1.5994h1.5994l2.8789 6.0697-1.0796 1.9513c-0.58378 1.0716 0.18393 2.3751 1.3995 2.3751h9.5964v-1.5994h-9.5964l0.87967-1.5994zm-7.5092-5.5979h9.7164l-2.2072 3.9985h-5.6139zm0.67175 9.5964c-0.87967 0-1.5914 0.71973-1.5914 1.5994s0.71174 1.5994 1.5914 1.5994 1.5994-0.71973 1.5994-1.5994-0.71973-1.5994-1.5994-1.5994zm7.997 0c-0.87967 0-1.5914 0.71973-1.5914 1.5994s0.71174 1.5994 1.5914 1.5994c0.87967 0 1.5994-0.71973 1.5994-1.5994s-0.71973-1.5994-1.5994-1.5994z\" fill=\"white\" stroke-width=\".7997\"/>';\n    var color = '#1F8B4D';\n    var background = getBackground(color);\n    var svgWidth = width;\n    var svgHeight = 30;\n    \n    var opacity = 1;\n    \n    var DoktorkitSvg = '<svg opacity=\"' + opacity + '\" width=\"' + svgWidth + '\" height=\"' + svgHeight + '\" viewBox=\"0 0 ' + svgWidth + ' ' + svgHeight + '\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                    background + shape;\n    DoktorkitSvg += '</svg>';\n    return DoktorkitSvg;    \n}\n\nfunction getBackground(color) {\n     return '<circle cx=\"15\" cy=\"15\" r=\"15\" fill=\"'+ color +'\"/>';\n}\n",
            "markerImages": [],
            "showPolygon": false,
            "polygonKeyName": "perimeter",
            "editablePolygon": false,
            "showPolygonLabel": false,
            "usePolygonLabelFunction": false,
            "polygonLabel": "${entityName}",
            "showPolygonTooltip": false,
            "showPolygonTooltipAction": "click",
            "autoClosePolygonTooltip": true,
            "usePolygonTooltipFunction": false,
            "polygonTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "polygonColor": "#3388ff",
            "polygonOpacity": 0.2,
            "usePolygonColorFunction": false,
            "polygonStrokeColor": "#3388ff",
            "polygonStrokeOpacity": 1,
            "polygonStrokeWeight": 3,
            "usePolygonStrokeColorFunction": false,
            "showCircle": false,
            "circleKeyName": "perimeter",
            "editableCircle": false,
            "showCircleLabel": false,
            "useCircleLabelFunction": false,
            "circleLabel": "${entityName}",
            "showCircleTooltip": false,
            "showCircleTooltipAction": "click",
            "autoCloseCircleTooltip": true,
            "useCircleTooltipFunction": false,
            "circleTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "circleFillColor": "#3388ff",
            "circleFillColorOpacity": 0.2,
            "useCircleFillColorFunction": false,
            "circleStrokeColor": "#3388ff",
            "circleStrokeOpacity": 1,
            "circleStrokeWeight": 3,
            "useCircleStrokeColorFunction": false,
            "snappable": false,
            "initDragMode": true,
            "hideAllControlButton": true,
            "useClusterMarkers": false,
            "zoomOnClick": true,
            "maxClusterRadius": 80,
            "animate": true,
            "spiderfyOnMaxZoom": false,
            "showCoverageOnHover": true,
            "chunkedLoading": false,
            "removeOutsideVisibleBounds": true,
            "useIconCreateFunction": false
          },
          "title": "Edit Doktorkit location",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "widgetStyle": {},
          "actions": {
            "markerClick": [],
            "tooltipAction": []
          },
          "showTitleIcon": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "titleTooltip": "",
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "30311521-81d4-308a-e02c-1a33bcfdf2cf",
        "typeFullFqn": "system.maps_v2.openstreetmap"
      },
      "39414644-240c-54ad-cc74-50fd83a19b8f": {
        "typeFullFqn": "system.input_widgets.update_multiple_attributes",
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Measurement ID",
                  "color": "#f44336",
                  "settings": {
                    "dataKeyHidden": false,
                    "dataKeyType": "server",
                    "dataKeyValueType": "string",
                    "required": false,
                    "isEditable": "readonly",
                    "disabledOnDataKey": "",
                    "appearance": "outline",
                    "subscriptSizing": "fixed",
                    "slideToggleLabelPosition": "after",
                    "selectOptions": [],
                    "step": 1,
                    "minValue": null,
                    "maxValue": null,
                    "requiredErrorMessage": "",
                    "minValueErrorMessage": "",
                    "maxValueErrorMessage": "",
                    "invalidDateErrorMessage": "",
                    "invalidJsonErrorMessage": "",
                    "dialogTitle": "",
                    "saveButtonLabel": "",
                    "cancelButtonLabel": "",
                    "useCustomIcon": false,
                    "icon": "",
                    "customIcon": "",
                    "useGetValueFunction": false,
                    "getValueFunctionBody": "",
                    "useSetValueFunction": false,
                    "setValueFunctionBody": ""
                  },
                  "_hash": 0.7261262741197994,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "locationName",
                  "type": "attribute",
                  "label": "Measurement Alias",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.3661436310629984,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "Address",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.859170990312162,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "installationType",
                  "type": "attribute",
                  "label": "Installation Type",
                  "color": "#e91e63",
                  "settings": {
                    "dataKeyHidden": false,
                    "dataKeyType": "server",
                    "dataKeyValueType": "select",
                    "required": false,
                    "isEditable": "editable",
                    "disabledOnDataKey": "",
                    "appearance": "outline",
                    "subscriptSizing": "fixed",
                    "slideToggleLabelPosition": "after",
                    "selectOptions": [
                      {
                        "value": "cooling",
                        "label": "Cooling"
                      },
                      {
                        "value": "heating",
                        "label": "Heating"
                      }
                    ],
                    "step": 1,
                    "minValue": null,
                    "maxValue": null,
                    "requiredErrorMessage": "",
                    "minValueErrorMessage": "",
                    "maxValueErrorMessage": "",
                    "invalidDateErrorMessage": "",
                    "invalidJsonErrorMessage": "",
                    "dialogTitle": "",
                    "saveButtonLabel": "",
                    "cancelButtonLabel": "",
                    "useCustomIcon": false,
                    "icon": "",
                    "customIcon": "",
                    "useGetValueFunction": false,
                    "getValueFunctionBody": "",
                    "useSetValueFunction": false,
                    "setValueFunctionBody": ""
                  },
                  "_hash": 0.21277466910118492,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "measurementType",
                  "type": "attribute",
                  "label": "Measurement Type",
                  "color": "#9c27b0",
                  "settings": {
                    "dataKeyHidden": false,
                    "dataKeyType": "server",
                    "dataKeyValueType": "select",
                    "required": false,
                    "isEditable": "editable",
                    "disabledOnDataKey": "",
                    "appearance": "outline",
                    "subscriptSizing": "fixed",
                    "slideToggleLabelPosition": "after",
                    "selectOptions": [
                      {
                        "value": "ultrasonic",
                        "label": "Ultrasonic"
                      },
                      {
                        "value": "loraWan",
                        "label": "LoRaWan"
                      }
                    ],
                    "step": 1,
                    "minValue": null,
                    "maxValue": null,
                    "requiredErrorMessage": "",
                    "minValueErrorMessage": "",
                    "maxValueErrorMessage": "",
                    "invalidDateErrorMessage": "",
                    "invalidJsonErrorMessage": "",
                    "dialogTitle": "",
                    "saveButtonLabel": "",
                    "cancelButtonLabel": "",
                    "useCustomIcon": false,
                    "icon": "",
                    "customIcon": "",
                    "useGetValueFunction": false,
                    "getValueFunctionBody": "",
                    "useSetValueFunction": false,
                    "setValueFunctionBody": ""
                  },
                  "_hash": 0.5476166374805158,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "active",
                  "type": "attribute",
                  "label": "Activity",
                  "color": "#8bc34a",
                  "settings": {
                    "dataKeyHidden": true,
                    "dataKeyType": "server",
                    "dataKeyValueType": "booleanSwitch",
                    "required": false,
                    "isEditable": "editable",
                    "disabledOnDataKey": "",
                    "appearance": "outline",
                    "subscriptSizing": "fixed",
                    "slideToggleLabelPosition": "after",
                    "selectOptions": [],
                    "step": 1,
                    "minValue": null,
                    "maxValue": null,
                    "requiredErrorMessage": "",
                    "minValueErrorMessage": "",
                    "maxValueErrorMessage": "",
                    "invalidDateErrorMessage": "",
                    "invalidJsonErrorMessage": "",
                    "dialogTitle": "",
                    "saveButtonLabel": "",
                    "cancelButtonLabel": "",
                    "useCustomIcon": false,
                    "icon": "",
                    "customIcon": "",
                    "useGetValueFunction": false,
                    "getValueFunctionBody": "",
                    "useSetValueFunction": false,
                    "setValueFunctionBody": ""
                  },
                  "_hash": 0.906407032891368,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1707571374578,
                "endTimeMs": 1707657774578
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": null,
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "40",
          "settings": {
            "widgetTitle": "Edit Measurement",
            "showResultMessage": true,
            "showActionButtons": true,
            "updateAllValues": true,
            "saveButtonLabel": "Save",
            "resetButtonLabel": "Undo",
            "showGroupTitle": false,
            "groupTitle": "${entityName}",
            "fieldsAlignment": "row",
            "fieldsInRow": 1,
            "rowGap": 5,
            "columnGap": 10
          },
          "title": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {
            "margin-top": "5px"
          },
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "actions": {
            "headerButton": []
          },
          "displayTimewindow": true,
          "showTitleIcon": false,
          "titleTooltip": "",
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "titleIcon": null,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "margin": ""
        },
        "row": 0,
        "col": 0,
        "id": "39414644-240c-54ad-cc74-50fd83a19b8f"
      },
      "6fe780fc-b5fc-0a29-95f0-41a82c0f22ca": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "address",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.7546586070710162
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "showResultMessage": false,
            "showLabel": true,
            "isRequired": true,
            "labelValue": "Address",
            "requiredErrorMessage": "Address is required"
          },
          "title": "New Update server string attribute",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "actions": {},
          "showTitleIcon": false,
          "titleTooltip": "",
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "6fe780fc-b5fc-0a29-95f0-41a82c0f22ca",
        "typeFullFqn": "system.input_widgets.update_server_string_attribute"
      },
      "43c4cbcd-127c-7085-0f83-5a168e646d12": {
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "latitude",
                  "type": "attribute",
                  "label": "latitude",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.862061599769905
                },
                {
                  "name": "longitude",
                  "type": "attribute",
                  "label": "longitude",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.017864596400994026
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "provider": "openstreet-map",
            "gmApiKey": "AIzaSyDoEx2kaGz3PxwbI9T7ccTSg5xjdw8Nw8Q",
            "gmDefaultMapType": "roadmap",
            "mapProvider": "CartoDB.Positron",
            "useCustomProvider": false,
            "customProviderTileUrl": "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            "mapProviderHere": "HERE.normalDay",
            "credentials": {
              "app_id": "AhM6TzD9ThyK78CT3ptx",
              "app_code": "p6NPiITB3Vv0GMUFnkLOOg"
            },
            "mapImageUrl": "tb-image;/api/images/system/here_map_system_widget_map_image.svg",
            "tmApiKey": "84d6d83e0e51e481e50454ccbe8986b",
            "tmDefaultMapType": "roadmap",
            "latKeyName": "latitude",
            "lngKeyName": "longitude",
            "xPosKeyName": "xPos",
            "yPosKeyName": "yPos",
            "defaultZoomLevel": 14,
            "defaultCenterPosition": "0,0",
            "disableScrollZooming": false,
            "disableDoubleClickZooming": false,
            "disableZoomControl": false,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "mapPageSize": 16384,
            "markerOffsetX": 0.5,
            "markerOffsetY": 1,
            "posFunction": "return {x: origXPos, y: origYPos};",
            "draggableMarker": true,
            "showLabel": true,
            "useLabelFunction": false,
            "label": "${entityName}",
            "labelFunction": "var deviceType = dsData[dsIndex]['Type'];\r\nif (typeof deviceType !== undefined) {\r\n    if (deviceType == \"energy meter\") {\r\n        return '<span style=\"color:orange;\">${entityName}, ${energy:2} kWt</span>';\r\n    } else if (deviceType == \"thermometer\") {\r\n        return '<span style=\"color:blue;\">${entityName}, ${temperature:2} °C</span>';\r\n    }\r\n}",
            "showTooltip": false,
            "showTooltipAction": "click",
            "autocloseTooltip": true,
            "useTooltipFunction": false,
            "tooltipPattern": "<b>${entityName}</b><br/><br/><link-act name='Doktorkit-devices'>Doktorkit devices</link-act>",
            "tooltipFunction": "var deviceType = dsData[dsIndex]['Type'];\r\nif (typeof deviceType !== undefined) {\r\n    if (deviceType == \"energy meter\") {\r\n        return '<b>${entityName}</b><br/><b>Energy:</b> ${energy:2} kWt<br/>';\r\n    } else if (deviceType == \"thermometer\") {\r\n        return '<b>${entityName}</b><br/><b>Temperature:</b> ${temperature:2} °C<br/>';\r\n    }\r\n}",
            "tooltipOffsetX": 0,
            "tooltipOffsetY": -1,
            "color": "#fe7569",
            "useColorFunction": false,
            "useMarkerImageFunction": true,
            "markerImageSize": 34,
            "markerImageFunction": "var width = 30;\nvar svgStr = getDoktorkitSvg(width);\nvar encodedSvg = encodeURIComponent(svgStr);\nvar svgUrl = 'data:image/svg+xml,' + encodedSvg;\n\nreturn {\n    url: svgUrl,\n    size: width,\n    markerOffset: [width / 2, width / 2],\n    tooltipOffset: [width * 0.5 - width / 2, - (width / 2)]\n};\n\nfunction getDoktorkitSvg(width, isSelected) {\n    var shape = '<path d=\"m18.636 15.8c0.59978 0 1.1276-0.32788 1.3995-0.82369l2.8629-5.1901c0.29589-0.5278-0.08796-1.1836-0.69574-1.1836h-11.836l-0.75172-1.5994h-2.615v1.5994h1.5994l2.8789 6.0697-1.0796 1.9513c-0.58378 1.0716 0.18393 2.3751 1.3995 2.3751h9.5964v-1.5994h-9.5964l0.87967-1.5994zm-7.5092-5.5979h9.7164l-2.2072 3.9985h-5.6139zm0.67175 9.5964c-0.87967 0-1.5914 0.71973-1.5914 1.5994s0.71174 1.5994 1.5914 1.5994 1.5994-0.71973 1.5994-1.5994-0.71973-1.5994-1.5994-1.5994zm7.997 0c-0.87967 0-1.5914 0.71973-1.5914 1.5994s0.71174 1.5994 1.5914 1.5994c0.87967 0 1.5994-0.71973 1.5994-1.5994s-0.71973-1.5994-1.5994-1.5994z\" fill=\"white\" stroke-width=\".7997\"/>';\n    var color = '#1F8B4D';\n    var background = getBackground(color);\n    var svgWidth = width;\n    var svgHeight = 30;\n    \n    var opacity = 1;\n    \n    var DoktorkitSvg = '<svg opacity=\"' + opacity + '\" width=\"' + svgWidth + '\" height=\"' + svgHeight + '\" viewBox=\"0 0 ' + svgWidth + ' ' + svgHeight + '\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                    background + shape;\n    DoktorkitSvg += '</svg>';\n    return DoktorkitSvg;    \n}\n\nfunction getBackground(color) {\n     return '<circle cx=\"15\" cy=\"15\" r=\"15\" fill=\"'+ color +'\"/>';\n}\n",
            "markerImages": [],
            "showPolygon": false,
            "polygonKeyName": "perimeter",
            "editablePolygon": false,
            "showPolygonLabel": false,
            "usePolygonLabelFunction": false,
            "polygonLabel": "${entityName}",
            "showPolygonTooltip": false,
            "showPolygonTooltipAction": "click",
            "autoClosePolygonTooltip": true,
            "usePolygonTooltipFunction": false,
            "polygonTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "polygonColor": "#3388ff",
            "polygonOpacity": 0.2,
            "usePolygonColorFunction": false,
            "polygonStrokeColor": "#3388ff",
            "polygonStrokeOpacity": 1,
            "polygonStrokeWeight": 3,
            "usePolygonStrokeColorFunction": false,
            "showCircle": false,
            "circleKeyName": "perimeter",
            "editableCircle": false,
            "showCircleLabel": false,
            "useCircleLabelFunction": false,
            "circleLabel": "${entityName}",
            "showCircleTooltip": false,
            "showCircleTooltipAction": "click",
            "autoCloseCircleTooltip": true,
            "useCircleTooltipFunction": false,
            "circleTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "circleFillColor": "#3388ff",
            "circleFillColorOpacity": 0.2,
            "useCircleFillColorFunction": false,
            "circleStrokeColor": "#3388ff",
            "circleStrokeOpacity": 1,
            "circleStrokeWeight": 3,
            "useCircleStrokeColorFunction": false,
            "snappable": false,
            "initDragMode": true,
            "hideAllControlButton": true,
            "useClusterMarkers": false,
            "zoomOnClick": true,
            "maxClusterRadius": 80,
            "animate": true,
            "spiderfyOnMaxZoom": false,
            "showCoverageOnHover": true,
            "chunkedLoading": false,
            "removeOutsideVisibleBounds": true,
            "useIconCreateFunction": false
          },
          "title": "Edit Doktorkit location",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "widgetStyle": {},
          "actions": {
            "markerClick": [],
            "tooltipAction": []
          },
          "showTitleIcon": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "titleTooltip": "",
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "43c4cbcd-127c-7085-0f83-5a168e646d12",
        "typeFullFqn": "system.maps_v2.openstreetmap"
      },
      "3c990db9-ab04-d3a5-ae24-bc58de2fbc94": {
        "typeFullFqn": "system.cards.entities_table",
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1713435502260,
                "endTimeMs": 1713521902260
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "enableSearch": true,
            "enableSelectColumnDisplay": true,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "displayEntityLabel": false,
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "name",
            "useRowStyleFunction": false,
            "entitiesTitle": "Entities"
          },
          "title": "Entities table",
          "dropShadow": true,
          "enableFullscreen": true,
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400,
            "padding": "5px 10px 5px 10px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "d13f6078-0d81-ec59-529c-64acbbcaf470",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Name",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.1849002505353028
                },
                {
                  "name": "active",
                  "type": "attribute",
                  "label": "active",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.8128568406469565,
                  "decimals": 0
                },
                {
                  "name": "type",
                  "type": "entityField",
                  "label": "Type",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.3089029814236317,
                  "decimals": 0
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.9719730919393044,
                  "decimals": 0
                },
                {
                  "name": "licenseActivationStatus",
                  "type": "attribute",
                  "label": "licenseActivationStatus",
                  "color": "#607d8b",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar licenseActivationStatus = value;\r\nif (licenseActivationStatus == 'true') { // all key values here are strings\r\n  color = '#27AE60';\r\n} else {\r\n  color = '#EB5757';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span>';\r\n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.10755740653396839,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "displayTimewindow": false,
          "configMode": "advanced",
          "actions": {
            "actionCellButton": [
              {
                "name": "Add Device to Doctorkit",
                "icon": "medical_services",
                "useShowWidgetActionFunction": false,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<!--=======================================================================-->\n<!--=====  There are two example templates: for edit and add entity   =====-->\n<!--=======================================================================-->\n<!--========================  Edit entity example  ========================-->\n<!--=======================================================================-->\n<!-- -->\n<!--<form #editEntityForm=\"ngForm\" [formGroup]=\"editEntityFormGroup\"-->\n<!--      (ngSubmit)=\"save()\"  class=\"edit-entity-form\">-->\n<!--    <mat-toolbar fxLayout=\"row\" color=\"primary\">-->\n<!--        <h2>Edit {{entityType.toLowerCase()}} {{entityName}}</h2>-->\n<!--        <span fxFlex></span>-->\n<!--        <button mat-icon-button (click)=\"cancel()\" type=\"button\">-->\n<!--            <mat-icon class=\"material-icons\">close</mat-icon>-->\n<!--        </button>-->\n<!--    </mat-toolbar>-->\n<!--    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">-->\n<!--    </mat-progress-bar>-->\n<!--    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>-->\n<!--    <div mat-dialog-content fxLayout=\"column\">-->\n<!--        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Name</mat-label>-->\n<!--                <input matInput formControlName=\"entityName\" required readonly=\"\">-->\n<!--            </mat-form-field>-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Label</mat-label>-->\n<!--                <input matInput formControlName=\"entityLabel\">-->\n<!--            </mat-form-field>-->\n<!--        </div>-->\n<!--        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Type</mat-label>-->\n<!--                <input matInput formControlName=\"entityType\" readonly>-->\n<!--            </mat-form-field>-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Type</mat-label>-->\n<!--                <input matInput formControlName=\"type\" readonly>-->\n<!--            </mat-form-field>-->\n<!--        </div>-->\n<!--        <div formGroupName=\"attributes\" fxLayout=\"column\">-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Latitude</mat-label>-->\n<!--                    <input type=\"number\" step=\"any\" matInput formControlName=\"latitude\">-->\n<!--                </mat-form-field>-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Longitude</mat-label>-->\n<!--                    <input type=\"number\" step=\"any\" matInput formControlName=\"longitude\">-->\n<!--                </mat-form-field>-->\n<!--            </div>-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Address</mat-label>-->\n<!--                    <input matInput formControlName=\"address\">-->\n<!--                </mat-form-field>-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Owner</mat-label>-->\n<!--                    <input matInput formControlName=\"owner\">-->\n<!--                </mat-form-field>-->\n<!--            </div>-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Integer Value</mat-label>-->\n<!--                    <input type=\"number\" step=\"1\" matInput formControlName=\"number\">-->\n<!--                    <mat-error *ngIf=\"editEntityFormGroup.get('attributes.number').hasError('pattern')\">-->\n<!--                        Invalid integer value.-->\n<!--                    </mat-error>-->\n<!--                </mat-form-field>-->\n<!--                <div class=\"boolean-value-input\" fxLayout=\"column\" fxLayoutAlign=\"center start\" fxFlex>-->\n<!--                    <label class=\"checkbox-label\">Boolean Value</label>-->\n<!--                    <mat-checkbox formControlName=\"booleanValue\" style=\"margin-bottom: 40px;\">-->\n<!--                        {{ (editEntityFormGroup.get('attributes.booleanValue').value ? \"value.true\" : \"value.false\") | translate }}-->\n<!--                    </mat-checkbox>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--        <div class=\"relations-list old-relations\">-->\n<!--            <div class=\"mat-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">Relations</div>-->\n<!--            <div class=\"body\" [fxShow]=\"oldRelations().length\">-->\n<!--                <div class=\"row\" fxLayout=\"row\" fxLayoutAlign=\"start center\" formArrayName=\"oldRelations\" -->\n<!--                     *ngFor=\"let relation of oldRelations().controls; let i = index;\">-->\n<!--                    <div [formGroupName]=\"i\" class=\"mat-elevation-z2\" fxFlex fxLayout=\"row\" style=\"padding: 5px 0 5px 5px;\">-->\n<!--                        <div fxFlex fxLayout=\"column\">-->\n<!--                            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                                <mat-form-field class=\"mat-block\" style=\"min-width: 100px;\">-->\n<!--                                    <mat-label>Direction</mat-label>-->\n<!--                                    <mat-select formControlName=\"direction\" name=\"direction\">-->\n<!--                                        <mat-option *ngFor=\"let direction of entitySearchDirection | keyvalue\" [value]=\"direction.value\">-->\n<!--                                            {{ (\"relation.search-direction.\" + direction.value) | translate}}-->\n<!--                                        </mat-option>-->\n<!--                                    </mat-select>-->\n<!--                                    <mat-error *ngIf=\"relation.get('direction').hasError('required')\">-->\n<!--                                        Relation direction is required.-->\n<!--                                    </mat-error>-->\n<!--                                </mat-form-field>-->\n<!--                                <tb-relation-type-autocomplete-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        formControlName=\"relationType\"-->\n<!--                                        required=\"true\">-->\n<!--                                </tb-relation-type-autocomplete>-->\n<!--                            </div>-->\n<!--                            <div fxLayout=\"row\" fxLayout.xs=\"column\">-->\n<!--                                <tb-entity-select-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        required=\"true\"-->\n<!--                                        formControlName=\"relatedEntity\">-->\n<!--                                </tb-entity-select>-->\n<!--                            </div>-->\n<!--                        </div>-->\n<!--                        <div fxLayout=\"column\" fxLayoutAlign=\"center center\">-->\n<!--                            <button mat-icon-button color=\"primary\"-->\n<!--                                    aria-label=\"Remove\"-->\n<!--                                    type=\"button\"-->\n<!--                                    (click)=\"removeOldRelation(i, relation.value)\"-->\n<!--                                    matTooltip=\"Remove relation\"-->\n<!--                                    matTooltipPosition=\"above\">-->\n<!--                                <mat-icon>close</mat-icon>-->\n<!--                            </button>-->\n<!--                        </div>-->\n<!--                    </div>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--        <div class=\"relations-list\">-->\n<!--            <div class=\"mat-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">New Relations</div>-->\n<!--            <div class=\"body\" [fxShow]=\"relations().length\">-->\n<!--                <div class=\"row\" fxLayout=\"row\" fxLayoutAlign=\"start center\" formArrayName=\"relations\" *ngFor=\"let relation of relations().controls; let i = index;\">-->\n<!--                    <div [formGroupName]=\"i\" class=\"mat-elevation-z2\" fxFlex fxLayout=\"row\" style=\"padding: 5px 0 5px 5px;\">-->\n<!--                        <div fxFlex fxLayout=\"column\">-->\n<!--                            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                                <mat-form-field class=\"mat-block\" style=\"min-width: 100px;\">-->\n<!--                                    <mat-label>Direction</mat-label>-->\n<!--                                    <mat-select formControlName=\"direction\" name=\"direction\">-->\n<!--                                        <mat-option *ngFor=\"let direction of entitySearchDirection | keyvalue\" [value]=\"direction.value\">-->\n<!--                                            {{ (\"relation.search-direction.\" + direction.value) | translate}}-->\n<!--                                        </mat-option>-->\n<!--                                    </mat-select>-->\n<!--                                    <mat-error *ngIf=\"relation.get('direction').hasError('required')\">-->\n<!--                                        Relation direction is required.-->\n<!--                                    </mat-error>-->\n<!--                                </mat-form-field>-->\n<!--                                <tb-relation-type-autocomplete-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        formControlName=\"relationType\"-->\n<!--                                        [required]=\"true\">-->\n<!--                                </tb-relation-type-autocomplete>-->\n<!--                            </div>-->\n<!--                            <div fxLayout=\"row\" fxLayout.xs=\"column\">-->\n<!--                                <tb-entity-select-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        [required]=\"true\"-->\n<!--                                        formControlName=\"relatedEntity\">-->\n<!--                                </tb-entity-select>-->\n<!--                            </div>-->\n<!--                        </div>-->\n<!--                        <div fxLayout=\"column\" fxLayoutAlign=\"center center\">-->\n<!--                            <button mat-icon-button color=\"primary\"-->\n<!--                                    aria-label=\"Remove\"-->\n<!--                                    type=\"button\"-->\n<!--                                    (click)=\"removeRelation(i)\"-->\n<!--                                    matTooltip=\"Remove relation\"-->\n<!--                                    matTooltipPosition=\"above\">-->\n<!--                                <mat-icon>close</mat-icon>-->\n<!--                            </button>-->\n<!--                        </div>-->\n<!--                    </div>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--            <div>-->\n<!--                <button mat-raised-button color=\"primary\"-->\n<!--                        type=\"button\"-->\n<!--                        (click)=\"addRelation()\"-->\n<!--                        matTooltip=\"Add Relation\"-->\n<!--                        matTooltipPosition=\"above\">-->\n<!--                    Add-->\n<!--                </button>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--    </div>-->\n<!--    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">-->\n<!--        <button mat-button color=\"primary\"-->\n<!--                type=\"button\"-->\n<!--                [disabled]=\"(isLoading$ | async)\"-->\n<!--                (click)=\"cancel()\" cdkFocusInitial>-->\n<!--            Cancel-->\n<!--        </button>-->\n<!--        <button mat-button mat-raised-button color=\"primary\"-->\n<!--                type=\"submit\"-->\n<!--                [disabled]=\"(isLoading$ | async) || editEntityForm.invalid || !editEntityForm.dirty\">-->\n<!--            Save-->\n<!--        </button>-->\n<!--    </div>-->\n<!--</form>-->\n<!---->\n<!--========================================================================-->\n<!--=========================  Add entity example  =========================-->\n<!--========================================================================-->\n<!---->\n<!--<form #addEntityForm=\"ngForm\" [formGroup]=\"addEntityFormGroup\"-->\n<!--      (ngSubmit)=\"save()\" class=\"add-entity-form\">-->\n<!--    <mat-toolbar fxLayout=\"row\" color=\"primary\">-->\n<!--        <h2>Add entity</h2>-->\n<!--        <span fxFlex></span>-->\n<!--        <button mat-icon-button (click)=\"cancel()\" type=\"button\">-->\n<!--            <mat-icon class=\"material-icons\">close</mat-icon>-->\n<!--        </button>-->\n<!--    </mat-toolbar>-->\n<!--    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">-->\n<!--    </mat-progress-bar>-->\n<!--    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>-->\n<!--    <div mat-dialog-content fxLayout=\"column\">-->\n<!--        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Name</mat-label>-->\n<!--                <input matInput formControlName=\"entityName\" required>-->\n<!--                <mat-error *ngIf=\"addEntityFormGroup.get('entityName').hasError('required')\">-->\n<!--                    Entity name is required.-->\n<!--                </mat-error>-->\n<!--            </mat-form-field>-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Label</mat-label>-->\n<!--                <input matInput formControlName=\"entityLabel\" >-->\n<!--            </mat-form-field>-->\n<!--        </div>-->\n<!--        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--            <tb-entity-type-select-->\n<!--                    class=\"mat-block\"-->\n<!--                    formControlName=\"entityType\"-->\n<!--                    [showLabel]=\"true\"-->\n<!--                    [allowedEntityTypes]=\"allowedEntityTypes\"-->\n<!--            ></tb-entity-type-select>-->\n<!--            <tb-entity-subtype-autocomplete-->\n<!--                    fxFlex *ngIf=\"addEntityFormGroup.get('entityType').value == 'ASSET'\"-->\n<!--                    class=\"mat-block\"-->\n<!--                    formControlName=\"type\"-->\n<!--                    [required]=\"true\"-->\n<!--                    [entityType]=\"'ASSET'\"-->\n<!--            ></tb-entity-subtype-autocomplete>-->\n<!--            <tb-entity-subtype-autocomplete-->\n<!--                    fxFlex *ngIf=\"addEntityFormGroup.get('entityType').value != 'ASSET'\"-->\n<!--                    class=\"mat-block\"-->\n<!--                    formControlName=\"type\"-->\n<!--                    [required]=\"true\"-->\n<!--                    [entityType]=\"'DEVICE'\"-->\n<!--            ></tb-entity-subtype-autocomplete>-->\n<!--        </div>-->\n<!--        <div formGroupName=\"attributes\" fxLayout=\"column\">-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Latitude</mat-label>-->\n<!--                    <input type=\"number\" step=\"any\" matInput formControlName=\"latitude\">-->\n<!--                </mat-form-field>-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Longitude</mat-label>-->\n<!--                    <input type=\"number\" step=\"any\" matInput formControlName=\"longitude\">-->\n<!--                </mat-form-field>-->\n<!--            </div>-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Address</mat-label>-->\n<!--                    <input matInput formControlName=\"address\">-->\n<!--                </mat-form-field>-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Owner</mat-label>-->\n<!--                    <input matInput formControlName=\"owner\">-->\n<!--                </mat-form-field>-->\n<!--            </div>-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Integer Value</mat-label>-->\n<!--                    <input type=\"number\" step=\"1\" matInput formControlName=\"number\">-->\n<!--                    <mat-error *ngIf=\"addEntityFormGroup.get('attributes.number').hasError('pattern')\">-->\n<!--                        Invalid integer value.-->\n<!--                    </mat-error>-->\n<!--                </mat-form-field>-->\n<!--                <div class=\"boolean-value-input\" fxLayout=\"column\" fxLayoutAlign=\"center start\" fxFlex>-->\n<!--                    <label class=\"checkbox-label\">Boolean Value</label>-->\n<!--                    <mat-checkbox formControlName=\"booleanValue\" style=\"margin-bottom: 40px;\">-->\n<!--                        {{ (addEntityFormGroup.get('attributes.booleanValue').value ? \"value.true\" : \"value.false\") | translate }}-->\n<!--                    </mat-checkbox>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--        <div class=\"relations-list\">-->\n<!--            <div class=\"mat-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">Relations</div>-->\n<!--            <div class=\"body\" [fxShow]=\"relations().length\">-->\n<!--                <div class=\"row\" fxLayout=\"row\" fxLayoutAlign=\"start center\" formArrayName=\"relations\" *ngFor=\"let relation of relations().controls; let i = index;\">-->\n<!--                    <div [formGroupName]=\"i\" class=\"mat-elevation-z2\" fxFlex fxLayout=\"row\" style=\"padding: 5px 0 5px 5px;\">-->\n<!--                        <div fxFlex fxLayout=\"column\">-->\n<!--                            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                                <mat-form-field class=\"mat-block\" style=\"min-width: 100px;\">-->\n<!--                                    <mat-label>Direction</mat-label>-->\n<!--                                    <mat-select formControlName=\"direction\" name=\"direction\">-->\n<!--                                        <mat-option *ngFor=\"let direction of entitySearchDirection | keyvalue\" [value]=\"direction.value\">-->\n<!--                                            {{ (\"relation.search-direction.\" + direction.value) | translate}}-->\n<!--                                        </mat-option>-->\n<!--                                    </mat-select>-->\n<!--                                    <mat-error *ngIf=\"relation.get('direction').hasError('required')\">-->\n<!--                                        Relation direction is required.-->\n<!--                                    </mat-error>-->\n<!--                                </mat-form-field>-->\n<!--                                <tb-relation-type-autocomplete-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        formControlName=\"relationType\"-->\n<!--                                        [required]=\"true\">-->\n<!--                                </tb-relation-type-autocomplete>-->\n<!--                            </div>-->\n<!--                            <div fxLayout=\"row\" fxLayout.xs=\"column\">-->\n<!--                                <tb-entity-select-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        [required]=\"true\"-->\n<!--                                        formControlName=\"relatedEntity\">-->\n<!--                                </tb-entity-select>-->\n<!--                            </div>-->\n<!--                        </div>-->\n<!--                        <div fxLayout=\"column\" fxLayoutAlign=\"center center\">-->\n<!--                            <button mat-icon-button color=\"primary\"-->\n<!--                                    aria-label=\"Remove\"-->\n<!--                                    type=\"button\"-->\n<!--                                    (click)=\"removeRelation(i)\"-->\n<!--                                    matTooltip=\"Remove relation\"-->\n<!--                                    matTooltipPosition=\"above\">-->\n<!--                                <mat-icon>close</mat-icon>-->\n<!--                            </button>-->\n<!--                        </div>-->\n<!--                    </div>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--            <div>-->\n<!--                <button mat-raised-button color=\"primary\"-->\n<!--                        type=\"button\"-->\n<!--                        (click)=\"addRelation()\"-->\n<!--                        matTooltip=\"Add Relation\"-->\n<!--                        matTooltipPosition=\"above\">-->\n<!--                    Add-->\n<!--                </button>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--    </div>-->\n<!--    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">-->\n<!--        <button mat-button color=\"primary\"-->\n<!--                type=\"button\"-->\n<!--                [disabled]=\"(isLoading$ | async)\"-->\n<!--                (click)=\"cancel()\" cdkFocusInitial>-->\n<!--            Cancel-->\n<!--        </button>-->\n<!--        <button mat-button mat-raised-button color=\"primary\"-->\n<!--                type=\"submit\"-->\n<!--                [disabled]=\"(isLoading$ | async) || addEntityForm.invalid || !addEntityForm.dirty\">-->\n<!--            Create-->\n<!--        </button>-->\n<!--    </div>-->\n<!--</form>-->\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "/*=======================================================================*/\n/*=====  There are three examples: for delete, edit and add entity  =====*/\n/*=======================================================================*/\n/*=======================  Delete entity example  =======================*/\n/*=======================================================================*/\n//\n//let $injector = widgetContext.$scope.$injector;\n//let dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\n//let assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n//let deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\n//\n//openDeleteEntityDialog();\n//\n//function openDeleteEntityDialog() {\n//    let title = 'Delete ' + entityId.entityType.toLowerCase() + ' ' +\n//                 entityName;\n//    let content = 'Are you sure you want to delete the ' +\n//                  entityId.entityType.toLowerCase() + ' ' + entityName + '?';\n//    dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n//        function(result) {\n//            if (result) {\n//                deleteEntity();\n//            }\n//        }\n//    );\n//}\n//\n//function deleteEntity() {\n//    deleteEntityObservable(entityId).subscribe(\n//        function success() {\n//            widgetContext.updateAliases();\n//        },\n//        function fail() {\n//            showErrorDialog();\n//        }\n//    );\n//}\n//\n//function deleteEntityObservable(entityId) {\n//    if (entityId.entityType == \"ASSET\") {\n//        return assetService.deleteAsset(entityId.id);\n//    } else if (entityId.entityType == \"DEVICE\") {\n//        return deviceService.deleteDevice(entityId.id);\n//    }\n//}\n//\n//function showErrorDialog() {\n//    let title = 'Error';\n//    let content = 'An error occurred while deleting the entity. Please try again.';\n//    dialogs.alert(title, content, 'CLOSE').subscribe(\n//        function(result) {}\n//    );\n//}\n//\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n//\n//let $injector = widgetContext.$scope.$injector;\n//let customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\n//let entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\n//let assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n//let deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\n//let attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n//let entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\n//\n//openEditEntityDialog();\n//\n//function openEditEntityDialog() {\n//    customDialog.customDialog(htmlTemplate, EditEntityDialogController).subscribe();\n//}\n//\n//function EditEntityDialogController(instance) {\n//    let vm = instance;\n//\n//    vm.entityName = entityName;\n//    vm.entityType = entityId.entityType;\n//    vm.entitySearchDirection = {\n//        from: \"FROM\",\n//        to: \"TO\"\n//    };\n//    vm.attributes = {};\n//    vm.oldRelationsData = [];\n//    vm.relationsToDelete = [];\n//    vm.entity = {};\n//\n//    vm.editEntityFormGroup = vm.fb.group({\n//        entityName: ['', [vm.validators.required]],\n//        entityType: [null],\n//        entityLabel: [null],\n//        type: ['', [vm.validators.required]],\n//        attributes: vm.fb.group({\n//            latitude: [null],\n//            longitude: [null],\n//            address: [null],\n//            owner: [null],\n//            number: [null, [vm.validators.pattern(/^-?[0-9]+$/)]],\n//            booleanValue: [false]\n//        }),\n//        oldRelations: vm.fb.array([]),\n//        relations: vm.fb.array([])\n//    });\n//\n//    getEntityInfo();\n//\n//    vm.cancel = function() {\n//        vm.dialogRef.close(null);\n//    };\n//\n//    vm.relations = function() {\n//        return vm.editEntityFormGroup.get('relations');\n//    };\n//\n//    vm.oldRelations = function() {\n//        return vm.editEntityFormGroup.get('oldRelations');\n//    };\n//\n//    vm.addRelation = function() {\n//        vm.relations().push(vm.fb.group({\n//            relatedEntity: [null, [vm.validators.required]],\n//            relationType: [null, [vm.validators.required]],\n//            direction: [null, [vm.validators.required]]\n//        }));\n//    };\n//\n//    function addOldRelation() {\n//        vm.oldRelations().push(vm.fb.group({\n//            relatedEntity: [{value: null, disabled: true}, [vm.validators.required]],\n//            relationType: [{value: null, disabled: true}, [vm.validators.required]],\n//            direction: [{value: null, disabled: true}, [vm.validators.required]]\n//        }));\n//    }\n//\n//    vm.removeRelation = function(index) {\n//        vm.relations().removeAt(index);\n//        vm.relations().markAsDirty();\n//    };\n//\n//    vm.removeOldRelation = function(index, relation) {\n//        vm.oldRelations().removeAt(index);\n//        vm.relationsToDelete.push(relation);\n//        vm.oldRelations().markAsDirty();\n//    };\n//\n//    vm.save = function() {\n//        vm.editEntityFormGroup.markAsPristine();\n//        widgetContext.rxjs.forkJoin([\n//            saveAttributes(entityId),\n//            saveRelations(entityId),\n//            saveEntity()\n//        ]).subscribe(\n//            function () {\n//                widgetContext.updateAliases();\n//                vm.dialogRef.close(null);\n//            }\n//        );\n//    };\n//\n//    function getEntityAttributes(attributes) {\n//        for (var i = 0; i < attributes.length; i++) {\n//            vm.attributes[attributes[i].key] = attributes[i].value;\n//        }\n//    }\n//\n//    function getEntityRelations(relations) {\n//        let relationsFrom = relations[0];\n//        let relationsTo = relations[1];\n//        for (let i=0; i < relationsFrom.length; i++) {\n//            let relation = {\n//                direction: 'FROM',\n//                relationType: relationsFrom[i].type,\n//                relatedEntity: relationsFrom[i].to\n//            };\n//            vm.oldRelationsData.push(relation);\n//            addOldRelation();\n//        }\n//        for (let i=0; i < relationsTo.length; i++) {\n//            let relation = {\n//                direction: 'TO',\n//                relationType: relationsTo[i].type,\n//                relatedEntity: relationsTo[i].from\n//            };\n//            vm.oldRelationsData.push(relation);\n//            addOldRelation();\n//        }\n//    }\n//\n//    function getEntityInfo() {\n//         widgetContext.rxjs.forkJoin([\n//             entityRelationService.findInfoByFrom(entityId),\n//             entityRelationService.findInfoByTo(entityId),\n//             attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE'),\n//             entityService.getEntity(entityId.entityType, entityId.id)\n//         ]).subscribe(\n//             function (data) {\n//                 getEntityRelations(data.slice(0,2));\n//                 getEntityAttributes(data[2]);\n//                 vm.entity = data[3];\n//                 vm.editEntityFormGroup.patchValue({\n//                     entityName: vm.entity.name,\n//                     entityType: vm.entityType,\n//                     entityLabel: vm.entity.label,\n//                     type: vm.entity.type,\n//                     attributes: vm.attributes,\n//                     oldRelations: vm.oldRelationsData\n//                 }, {emitEvent: false});\n//             }\n//         );\n//     }\n//\n//    function saveEntity() {\n//        const formValues = vm.editEntityFormGroup.value;\n//        if (vm.entity.label !== formValues.entityLabel){\n//            vm.entity.label = formValues.entityLabel;\n//            if (formValues.entityType == 'ASSET') {\n//                return assetService.saveAsset(vm.entity);\n//            } else if (formValues.entityType == 'DEVICE') {\n//                return deviceService.saveDevice(vm.entity);\n//            }\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//\n//    function saveAttributes(entityId) {\n//        let attributes = vm.editEntityFormGroup.get('attributes').value;\n//        let attributesArray = [];\n//        for (let key in attributes) {\n//            if (attributes[key] !== vm.attributes[key]) {\n//                attributesArray.push({key: key, value: attributes[key]});\n//            }\n//        }\n//        if (attributesArray.length > 0) {\n//            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//\n//    function saveRelations(entityId) {\n//        let relations = vm.editEntityFormGroup.get('relations').value;\n//        let tasks = [];\n//        for(let i=0; i < relations.length; i++) {\n//            let relation = {\n//                type: relations[i].relationType,\n//                typeGroup: 'COMMON'\n//            };\n//            if (relations[i].direction == 'FROM') {\n//                relation.to = relations[i].relatedEntity;\n//                relation.from = entityId;\n//            } else {\n//                relation.to = entityId;\n//                relation.from = relations[i].relatedEntity;\n//            }\n//            tasks.push(entityRelationService.saveRelation(relation));\n//        }\n//        for (let i=0; i < vm.relationsToDelete.length; i++) {\n//            let relation = {\n//                type: vm.relationsToDelete[i].relationType\n//            };\n//            if (vm.relationsToDelete[i].direction == 'FROM') {\n//                relation.to = vm.relationsToDelete[i].relatedEntity;\n//                relation.from = entityId;\n//            } else {\n//                relation.to = entityId;\n//                relation.from = vm.relationsToDelete[i].relatedEntity;\n//            }\n//            tasks.push(entityRelationService.deleteRelation(relation.from, relation.type, relation.to));\n//        }\n//        if (tasks.length > 0) {\n//            return widgetContext.rxjs.forkJoin(tasks);\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//}\n//\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n//\n//let $injector = widgetContext.$scope.$injector;\n//let customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\n//let assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n//let deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\n//let attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n//let entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\n//\n//openAddEntityDialog();\n//\n//function openAddEntityDialog() {\n//    customDialog.customDialog(htmlTemplate, AddEntityDialogController).subscribe();\n//}\n//\n//function AddEntityDialogController(instance) {\n//    let vm = instance;\n//\n//    vm.allowedEntityTypes = ['ASSET', 'DEVICE'];\n//    vm.entitySearchDirection = {\n//        from: \"FROM\",\n//        to: \"TO\"\n//    }\n//\n//    vm.addEntityFormGroup = vm.fb.group({\n//      entityName: ['', [vm.validators.required]],\n//      entityType: ['DEVICE'],\n//      entityLabel: [null],\n//      type: ['', [vm.validators.required]],\n//      attributes: vm.fb.group({\n//          latitude: [null],\n//          longitude: [null],\n//          address: [null],\n//          owner: [null],\n//          number: [null, [vm.validators.pattern(/^-?[0-9]+$/)]],\n//          booleanValue: [null]\n//      }),\n//      relations: vm.fb.array([])\n//    });\n//\n//    vm.cancel = function() {\n//        vm.dialogRef.close(null);\n//    };\n//\n//    vm.relations = function() {\n//        return vm.addEntityFormGroup.get('relations');\n//    };\n//\n//    vm.addRelation = function() {\n//        vm.relations().push(vm.fb.group({\n//          relatedEntity: [null, [vm.validators.required]],\n//          relationType: [null, [vm.validators.required]],\n//          direction: [null, [vm.validators.required]]\n//        }));\n//    };\n//\n//    vm.removeRelation = function(index) {\n//        vm.relations().removeAt(index);\n//        vm.relations().markAsDirty();\n//    };\n//\n//    vm.save = function() {\n//        vm.addEntityFormGroup.markAsPristine();\n//        saveEntityObservable().subscribe(\n//            function (entity) {\n//                widgetContext.rxjs.forkJoin([\n//                    saveAttributes(entity.id),\n//                    saveRelations(entity.id)\n//                ]).subscribe(\n//                    function () {\n//                        widgetContext.updateAliases();\n//                        vm.dialogRef.close(null);\n//                    }\n//                );\n//            }\n//        );\n//    };\n//\n//    function saveEntityObservable() {\n//        const formValues = vm.addEntityFormGroup.value;\n//        let entity = {\n//            name: formValues.entityName,\n//            type: formValues.type,\n//            label: formValues.entityLabel\n//        };\n//        if (formValues.entityType == 'ASSET') {\n//            return assetService.saveAsset(entity);\n//        } else if (formValues.entityType == 'DEVICE') {\n//            return deviceService.saveDevice(entity);\n//        }\n//    }\n//\n//    function saveAttributes(entityId) {\n//        let attributes = vm.addEntityFormGroup.get('attributes').value;\n//        let attributesArray = [];\n//        for (let key in attributes) {\n//            if(attributes[key] !== null) {\n//                attributesArray.push({key: key, value: attributes[key]});\n//            }\n//        }\n//        if (attributesArray.length > 0) {\n//            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//\n//    function saveRelations(entityId) {\n//        let relations = vm.addEntityFormGroup.get('relations').value;\n//        let tasks = [];\n//        for(let i=0; i < relations.length; i++) {\n//            let relation = {\n//                type: relations[i].relationType,\n//                typeGroup: 'COMMON'\n//            };\n//            if (relations[i].direction == 'FROM') {\n//                relation.to = relations[i].relatedEntity;\n//                relation.from = entityId;\n//            } else {\n//                relation.to = entityId;\n//                relation.from = relations[i].relatedEntity;\n//            }\n//            tasks.push(entityRelationService.saveRelation(relation));\n//        }\n//        if (tasks.length > 0) {\n//            return widgetContext.rxjs.forkJoin(tasks);\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "de8b83e9-cadb-9935-a0a3-45e634805302"
              }
            ]
          },
          "showTitleIcon": false,
          "titleIcon": "list",
          "iconColor": null,
          "titleFont": null,
          "titleColor": null,
          "enableDataExport": true,
          "desktopHide": true
        },
        "row": 0,
        "col": 0,
        "id": "3c990db9-ab04-d3a5-ae24-bc58de2fbc94"
      },
      "a6772b51-aa31-a7a7-3c81-ed0107747969": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "filterId": null,
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "var MeasurementState;\r\nconsole.log(JSON.stringify(data));\r\nif (data && data.length && data[0]['entityId']) {\r\n    MeasurementState = true;\r\n} else {\r\n    MeasurementState = false;\r\n}\r\n\r\nvar typeSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24\" viewBox=\"0 -960 960 960\" width=\"24\"><path d=\"M160-80q-33 0-56.5-23.5T80-160v-480q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v480q0 33-23.5 56.5T800-80H160Zm240-640h160v-80H400v80Zm40 360v120h80v-120h120v-80H520v-120h-80v120H320v80h120Z\"/></svg>';\r\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\r\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\r\n\r\nvar header = '<div class=\"header\" fxLayout=\"row\" fxLayoutAlign=\"start stretch\" fxLayoutGap=\"8px\">' +\r\n                '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><button id=\"go-back\" matTooltip=\"Go back\" type=\"button\" mat-icon-button><mat-icon>arrow_back</mat-icon></button></div>' +\r\n                '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><img style=\"vertical-align: middle;\" class=\"title-icon mat-icon\" src=\"'+ typeSvgUrl +'\"></div>' +\r\n                '<div fxFlex fxLayout=\"column\" fxLayoutAlign=\"center\">' +\r\n                   '<div class=\"title\">Edit Measurement: {{ ctx.stateController.getStateParams().selectedDoktorkit?.entityName }}</div>' +\r\n                '</div>' +\r\n                '<div fxLayout=\"column\" fxLayoutAlign=\"start\"><button id=\"add-Kit\" type=\"button\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">devices_other</mat-icon><span></span></button></div>' +\r\n                '<div fxLayout=\"column\" fxLayoutAlign=\"start\"><button id=\"Doktorkits\" type=\"button\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">devices_other</mat-icon><span>Doktorkits</span></button></div>' +\r\n                '<div fxLayout=\"column\" fxLayoutAlign=\"start\"><button id=\"Sensorkits\" type=\"button\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">sensors</mat-icon><span>Sensorkits</span></button></div>' +\r\n                '<div fxLayout=\"column\" fxLayoutAlign=\"start\"><button id=\"get-location\" type=\"button\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">location_on</mat-icon></button></div>' +\r\n                '<div fxLayout=\"column\" fxLayoutAlign=\"start\" style=\"padding-right: 24px;\"><button id=\"delete-Measurement\" type=\"button\" mat-raised-button color=\"accent\"><mat-icon class=\"tb-mat-20\">delete</mat-icon><span>Delete</span></button></div>' +\r\n             '</div>';\r\n             \r\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\r\n          (MeasurementState \r\n            ? (header +\r\n               '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"edit_measurements_card\"></tb-dashboard-state>') \r\n            : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"measurements_card_all\"></tb-dashboard-state>') +\r\n       '</div>';\r\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n.main-layout .header {\n    height: 60px;\n    margin: 4px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 12px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedMeasurement'] = null;\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "116515c2-d9bd-80b6-7a34-97373a802806"
              },
              {
                "name": "add-Kit",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addKitFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 800px;\">\r\n\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Add Kit</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-form-field class=\"mat-block\">\r\n      <mat-label>Kit</mat-label>\r\n      <mat-select formControlName=\"kit\" required>\r\n        <mat-select-trigger>\r\n          <div class=\"kit-item\" fxLayout=\"row\">\r\n            <div fxLayout=\"column\" fxFlex>\r\n              <div>{{addKitFormGroup.get('kit').value?.label}}</div>\r\n              <div class=\"kit-name\">{{addKitFormGroup.get('kit').value?.name}}</div>\r\n            </div>\r\n            <div class=\"kit-type\">{{addKitFormGroup.get('kit').value?.type}}</div>\r\n          </div>\r\n        </mat-select-trigger>\r\n        <mat-option *ngFor=\"let kit of availableKit\" [value]=\"kit\">\r\n          <div class=\"kit-item\" fxLayout=\"row\">\r\n            <div fxLayout=\"column\" fxFlex>\r\n              <div>{{kit?.label}}</div>\r\n              <div class=\"kit-name\">{{kit?.name}}</div>\r\n            </div>\r\n            <div class=\"kit-type\">{{kit?.type}}</div>\r\n          </div>\r\n          <mat-divider></mat-divider>\r\n        </mat-option>\r\n        <mat-option *ngIf=\"!availableKit?.length\" disabled [value]=\"null\">\r\n          <div class=\"kit-item\">No kits available</div>\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"addKitFormGroup.get('kit').hasError('required')\">\r\n        Kit is required.\r\n      </mat-error>\r\n    </mat-form-field>\r\n\r\n    <mat-form-field class=\"mat-block\">\r\n      <mat-label>Label</mat-label>\r\n      <input matInput formControlName=\"label\">\r\n      <mat-error *ngIf=\"addKitFormGroup.get('label').hasError('required')\">\r\n        Kit label is required.\r\n      </mat-error>\r\n    </mat-form-field>\r\n\r\n    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n      <button mat-button color=\"primary\"\r\n              type=\"button\"\r\n              [disabled]=\"(isLoading$ | async)\"\r\n              (click)=\"cancel()\" cdkFocusInitial>\r\n        Cancel\r\n      </button>\r\n      <button mat-button color=\"primary\" type=\"submit\">\r\n        Save\r\n      </button>\r\n    </div>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\n\r\nif (additionalParams.source === \"replace Kit\") {\r\n    if (additionalParams.choice === true) {\r\n        openAddKitDialog();\r\n    } else {\r\n        // Handle other cases if needed\r\n    }\r\n} else if (additionalParams.source !== \"replace Kit\") {\r\n    openAddKitDialog();\r\n}\r\n\r\nfunction openAddKitDialog() {\r\n    customDialog.customDialog(htmlTemplate, AddKitDialogController).subscribe();\r\n}\r\n\r\nfunction AddKitDialogController(instance) {\r\n    let vm = instance;\r\n\r\n    vm.addKitFormGroup = vm.fb.group({\r\n        kit: [null, [vm.validators.required]],\r\n        label: [{ value: null, disabled: true }]\r\n    });\r\n\r\n    vm.addKitFormGroup.get('kit').valueChanges.subscribe((kit) => {\r\n        vm.addKitFormGroup.get('label').patchValue(kit.label, { emitEvent: false });\r\n        vm.addKitFormGroup.get('label').enable({ emitEvent: false });\r\n        vm.addKitFormGroup.get('label').updateValueAndValidity({ onlySelf: true });\r\n    });\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        var MeasurementId = widgetContext.stateController.getStateParams().selectedMeasurement.entityId;\r\n        vm.addKitFormGroup.markAsPristine();\r\n        var kit = vm.addKitFormGroup.value.kit;\r\n        var label = vm.addKitFormGroup.value.label;\r\n        var kitId = kit.kitId;\r\n        \r\n        widgetContext.rxjs.forkJoin([\r\n            entityGroupService.removeEntityFromEntityGroup(vm.unassignedKitGroup.id.id, kitId.id),\r\n            saveKitToMeasurementRelation(MeasurementId, kitId),\r\n            updateKitLabel(kit, label)\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedKitGroup = null;\r\n        vm.availableKit = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'ASSET').subscribe((entityGroups) => {\r\n            vm.unassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n            if (vm.unassignedKitGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'ASSET',\r\n                        entityGroup: vm.unassignedKitGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    vm.availableKit = data.data.map((entityData) => {\r\n                        return {\r\n                            kitId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                });\r\n            }\r\n            if (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Kit\") {\r\n                checkAdditionalParams();\r\n            }\r\n        });\r\n    }\r\n\r\n    function saveKitToMeasurementRelation(MeasurementId, KitId) {\r\n        var relation = {\r\n            from: MeasurementId,\r\n            to: KitId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Contains'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function updateKitLabel(kit, label) {\r\n        if (kit.label !== label) {\r\n            return deviceService.getDevice(kit.kitId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origKit) => {\r\n                    origKit.label = label;\r\n                    return deviceService.saveDevice(origKit);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableKit = vm.availableKit.find(kit => kit.name === additionalParams.code);\r\n        const matchingAssignedKit = vm.assignedKits.find(kit => kit.name === additionalParams.code);\r\n\r\n        if (!matchingAvailableKit && !matchingAssignedKit) {\r\n            widgetContext.dialogs.alert(\"Kit doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedKit && !matchingAvailableKit) {\r\n            getMeasurement(additionalParams.code);\r\n        }\r\n        if (matchingAvailableKit && matchingAssignedKit) {\r\n            vm.addKitFormGroup.patchValue({ kit: matchingAvailableKit }, { emitEvent: false });\r\n            vm.addKitFormGroup.get('kit').markAsDirty();\r\n            vm.addKitFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('mat-select[formControlName=\"kit\"]');\r\n                if (selectElement) {\r\n                    selectElement.dispatchEvent(new Event('change'));\r\n                }\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n    \r\n    function getMeasurement(code) {\r\n        vm.kitEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToMeasurement = null;\r\n\r\n        deviceService.findByName(code)\r\n            .pipe(\r\n                widgetContext.rxjs.map((origKit) => {\r\n                    vm.kitEntityId = origKit.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.kitEntityId, 'entityType': 'ASSET' }).pipe(\r\n                    widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations).pipe(\r\n                        widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToMeasurement = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-kit\");\r\n                        let params = {\r\n                            \"measurement\": vm.assignedToMeasurement,\r\n                            \"kit\": vm.kitEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "c61ba3c6-e65b-ef52-6948-2ead8dc5a2dc"
              },
              {
                "name": "Doktorkits",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkits",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f921410a-47b7-5884-1c63-d010a39064a4"
              },
              {
                "name": "Sensorkits",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Sensorkits",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e4559805-877a-3f46-e336-b23cc1c27407"
              },
              {
                "name": "delete-Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenDeleteMeasurementDialog();\n\nfunction openDeleteMeasurementDialog() {\n  var title = 'Are you sure you want to delete the Measurement ' + entityName + '?';\n  var content = 'Be careful, after the confirmation, the Measurement will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteMeasurement();\n      }\n    }\n  );\n}\n\nfunction deleteMeasurement() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteMeasurementToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Measurement Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Measurement Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteMeasurementToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1af63269-0a95-b82e-0703-86bd8daf9356"
              },
              {
                "name": "get-location",
                "icon": "location_on",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "getLocation",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Get location action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to get phone location', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processLocationFunction": "// Function body to process current location of the phone. \n// - latitude - phone location latitude\n// - longitude - phone location longitude\nlet $injector = widgetContext.$scope.$injector;\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\n//showLocationDialog('Location', latitude, longitude);\nsaveEntityLocationAttributes('latitude', 'longitude', latitude, longitude);\nfunction getSelectedKitId() {\n    let stateParams = widgetContext.stateController.getStateParams();\n    return stateParams.selectedDoktorkit.entityId;\n}\n\nfunction saveEntityLocationAttributes(latitudeAttributeName, longitudeAttributeName, latitude, longitude) {\n    let entityId = getSelectedKitId();\n    if (entityId) {\n        let attributes = [\n            { key: \"latitude\", value: latitude },\n            { key: \"longitude\", value: longitude }\n        ];\n        attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributes).subscribe(\n        widgetContext.dialogs.alert('Location attributes saved!\\nLatitude: ' + latitude + '\\nLongitude: ' + longitude),\n           function() {\n               widgetContext.showSuccessToast('Location attributes saved!');\n           },\n           function(error) {\n               widgetContext.dialogs.alert('Location attributes save failed', JSON.stringify(error));\n           }\n        );\n    }\n}\n\n\nfunction showLocationDialog(title, latitude, longitude) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Latitude: '+latitude+'<br>Longitude: ' + longitude).subscribe();\n    }, 100);\n}"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "94c2e448-3356-0d9d-d976-d11a0ac2165c"
              }
            ],
            "headerButton": []
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "a6772b51-aa31-a7a7-3c81-ed0107747969",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "0a63a6e0-cb6e-5d7b-7971-642221547ca4": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\n     <div fxLayout=\"row\" style=\"width: 100%; height: 60px;\" fxLayoutAlign=\"center start\">\n        <h5 fxFlex class=\"market-title\">Measurements</h5>\n        <button id=\"add-Measurement\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">add</mat-icon><span>Add Measurement</span></button>\n     </div>\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"measurements_map_all\"></tb-dashboard-state>\n    </div>\n</div>",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-container .tb-widget .tb-multiple-input {\n    background-color: #FAFAFA;\n    border-radius: 4px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .input-field {\n    padding-right: 30px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input mat-slide-toggle {\n    margin-top: 15px !important;\n    margin-bottom: 0 !important;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-slide-toggle-content {\n    width: 120px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-bar {\n    width: 42px;\n    height: 24px;\n    border-radius: 16px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb-container {\n    top: 2px;\n    left: 2px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-thumb-container {\n    transform: translate3d(18px, 0, 0);\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb {\n    background-color: #fafafa;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-bar {\n    background-color: #F2994A;\n}\n",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "add-Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addMeasurementFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 350px;\">\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\n    <h2>Add Measurement</h2>\n    <span fxFlex></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content fxLayout=\"column\">\n    <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">\n      <mat-form-field fxFlex class=\"mat-block\">\n        <mat-label>Measurement title</mat-label>\n        <input matInput formControlName=\"name\" required>\n        <mat-error *ngIf=\"addMeasurementFormGroup.get('name').hasError('required')\">\n          Measurement title is required.\n        </mat-error>\n      </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      Cancel\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addMeasurementFormGroup.invalid || !addMeasurementFormGroup.dirty\">\n      Add Measurement\n    </button>\n  </div>\n</form>\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap\n    .get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap\n    .get('assetService'));\nlet entityGroupService = $injector.get(widgetContext\n    .servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext\n    .servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext\n    .servicesMap.get('entityRelationService'));\n\nopenAddMeasurementDialog();\n\nfunction openAddMeasurementDialog() {\n    customDialog.customDialog(htmlTemplate,\n        AddMeasurementDialogController).subscribe();\n}\n\nfunction AddMeasurementDialogController(instance) {\n    let vm = instance;\n    let projectName = widgetContext.stateController.getStateParams().selectedProject.entityName;\n    vm.addMeasurementFormGroup = vm.fb.group({\n        name: [projectName+\"_\", [vm.validators.required]]\n    });\n\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n\n    vm.save = function() {\n        const stateParams = widgetContext\n            .stateController.getStateParams();\n        var customerId;\n        var projectId;\n        projectId = {\n            id: (stateParams.selectedProject &&\n                    stateParams.selectedProject\n                    .entityId && stateParams\n                    .selectedProject.entityId.id) ?\n                stateParams.selectedProject.entityId\n                .id : '',\n            entityType: 'ASSET'\n        };\n        console.log(JSON.stringify(projectId));\n        if (widgetContext.currentUser.authority ===\n            'TENANT_ADMIN') {\n            customerId = widgetContext.stateController\n                .getStateParams().entityId;\n        } else {\n            customerId = {\n                id: widgetContext.currentUser\n                    .customerId,\n                entityType: 'CUSTOMER'\n            };\n        }\n        vm.addMeasurementFormGroup.markAsPristine();\n        saveMeasurementObservable(customerId).subscribe(\n            function(Measurement) {\n                const observables = [\n                    saveCustomerToMeasurementRelation(\n                        customerId, Measurement\n                        .id),\n                    saveAttributes(Measurement\n                        .id)\n                ];\n\n                // Add saveProjectToMeasurementRelation to observables if projectId is not empty\n                if (projectId.id !== \"\") {\n                    observables.push(\n                        saveProjectToMeasurementRelation(\n                            projectId,\n                            Measurement.id));\n                }\n                widgetContext.rxjs.forkJoin(observables).subscribe(\n                    function() {\n                        var params =\n                            widgetContext\n                            .stateController\n                            .getStateParams();\n                        var selectedMeasurement =\n                            params[\n                                'selectedMeasurement'\n                                ];\n                        params[\n                            'selectedMeasurement'] = {\n                            entityId: Measurement\n                                .id,\n                            entityName: Measurement\n                                .name,\n                            entityLabel: ''\n                        };\n                        widgetContext\n                            .updateAliases();\n                        vm.dialogRef.close(\n                        null);\n                    }\n                );\n            }\n        );\n    };\n\n    function saveMeasurementObservable(customerId) {\n        return getMeasurementsGroup(customerId).pipe(\n            widgetContext.rxjs.switchMap((\n                MeasurementsGroup) => {\n                const formValues = vm\n                    .addMeasurementFormGroup.value;\n                let Measurement = {\n                    name: formValues.name,\n                    type: 'Measurement',\n                    customerId: customerId\n                };\n                return assetService.saveAsset(\n                    Measurement,\n                    MeasurementsGroup.id.id)\n            })\n        );\n    }\n\n    function getMeasurementsGroup(customerId) {\n        return entityGroupService.getEntityGroupsByOwnerId(\n            customerId.entityType, customerId.id,\n            'ASSET').pipe(\n            widgetContext.rxjs.switchMap((\n                entityGroups) => {\n                    var MeasurementsGroup = entityGroups\n                        .find(group => group.name ===\n                            'Measurements');\n                    if (MeasurementsGroup) {\n                        return widgetContext.rxjs.of(\n                            MeasurementsGroup);\n                    } else {\n                        MeasurementsGroup = {\n                            type: 'ASSET',\n                            name: 'Measurements',\n                            ownerId: customerId\n                        };\n                        return entityGroupService\n                            .saveEntityGroup(\n                                MeasurementsGroup);\n                    }\n                })\n        );\n    }\n\n    function saveCustomerToMeasurementRelation(customerId,\n        MeasurementId) {\n        var relation = {\n            from: customerId,\n            to: MeasurementId,\n            typeGroup: 'COMMON',\n            type: 'Owns'\n        };\n        return entityRelationService.saveRelation(relation);\n    }\n\n    function saveProjectToMeasurementRelation(projectId,\n        MeasurementId) {\n        var relation = {\n            from: projectId,\n            to: MeasurementId,\n            typeGroup: 'COMMON',\n            type: 'Owns'\n        };\n        return entityRelationService.saveRelation(relation);\n    }\n\n    function saveAttributes(entityId) {\n        let attributesArray = [{\n                key: 'latitude',\n                value: 48.1406022\n            },\n            {\n                key: 'longitude',\n                value: 16.2932688\n            },\n            {\n                key: 'alias',\n                value: 'N/A'\n            },\n            {\n                key: 'address',\n                value: 'N/A'\n            },\n            {\n                key: 'state',\n                value: 'in preparation'\n            }, \n            {\n                key: 'active',\n                value: 'true'\n            },\n            {\n                key: 'units',\n                value: 'metric'\n            },\n            {\n                key: 'floorplan',\n                value: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCEtLSBDcmVhdGVkIHdpdGggSW5rc2NhcGUgKGh0dHA6Ly93d3cuaW5rc2NhcGUub3JnLykgLS0+Cjxzdmcgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc5LjM3NSA3OS4zNzUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiA8cmVjdCB4PSIyLjcwMTkiIHk9IjIuNzAxOSIgd2lkdGg9IjczLjk3MSIgaGVpZ2h0PSI3My45NzEiIGZpbGw9IiNmZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9Ii4xMTIxIiBzdHlsZT0icGFpbnQtb3JkZXI6bWFya2VycyBmaWxsIHN0cm9rZSIvPgogPGcgdHJhbnNmb3JtPSJtYXRyaXgoLjI2NDU4IDAgMCAuMjY0NTggMi42MzUgLTIuODgzNCkiIHN0cm9rZS13aWR0aD0iMXB4IiBzdHlsZT0ic2hhcGUtaW5zaWRlOnVybCgjcmVjdDQ4MzYpO3doaXRlLXNwYWNlOnByZSIgYXJpYS1sYWJlbD0iICAgTm8gcGxhbiBjb25maWd1cmVkIj4KICA8cGF0aCBkPSJtMTAxLjY3IDExOC4yOXYyOC40MzhoLTMuNzg5MWwtMTQuMzE2LTIxLjkzNHYyMS45MzRoLTMuNzY5NXYtMjguNDM4aDMuNzY5NWwxNC4zNzUgMjEuOTkydi0yMS45OTJ6Ii8+CiAgPHBhdGggZD0ibTEwNi44MyAxMzUuOTVxMC00LjU4OTggMi41NzgxLTcuNjU2MiAyLjU3ODEtMy4wODU5IDcuMDExNy0zLjA4NTl0Ny4wMTE3IDMuMDI3M3EyLjU3ODEgMy4wMDc4IDIuNjM2NyA3LjUxOTV2MC42NDQ1M3EwIDQuNTg5OC0yLjU5NzcgNy42NTYyLTIuNTc4MSAzLjA2NjQtNy4wMTE3IDMuMDY2NC00LjQ1MzEgMC03LjA1MDgtMy4wNjY0LTIuNTc4MS0zLjA2NjQtMi41NzgxLTcuNjU2MnptMy42MTMzIDAuNDQ5MjJxMCAzLjE0NDUgMS40ODQ0IDUuNDQ5MiAxLjUwMzkgMi4zMDQ3IDQuNTMxMiAyLjMwNDcgMi45NDkyIDAgNC40NTMxLTIuMjY1NiAxLjUwMzktMi4yODUyIDEuNTIzNC01LjQyOTd2LTAuNTA3ODFxMC0zLjEwNTUtMS41MDM5LTUuNDI5Ny0xLjUwMzktMi4zNDM4LTQuNTExNy0yLjM0MzgtMi45ODgzIDAtNC40OTIyIDIuMzQzOC0xLjQ4NDQgMi4zMjQyLTEuNDg0NCA1LjQyOTd6Ii8+CiAgPHBhdGggZD0ibTE1MC4xNyAxNDcuMTJxLTMuODA4NiAwLTYuMDM1Mi0yLjQ0MTR2MTAuMTc2aC0zLjYzMjh2LTI5LjI1OGgzLjMyMDNsMC4xNzU3OCAyLjMyNDJxMi4yMjY2LTIuNzE0OCA2LjExMzMtMi43MTQ4IDQuMDAzOSAwIDYuMTMyOCAyLjk2ODggMi4xMjg5IDIuOTY4OCAyLjEyODkgNy44MTI1djAuNDEwMTZxMCA0LjYyODktMi4xNDg0IDcuNjc1OC0yLjEyODkgMy4wNDY5LTYuMDU0NyAzLjA0Njl6bS0xLjExMzMtMTguODY3cS0zLjI4MTIgMC00LjkyMTkgMi45MTAydjEwLjExN3ExLjY2MDIgMi44NzExIDQuOTYwOSAyLjg3MTEgMi45Mjk3IDAgNC4yNzczLTIuMzA0NyAxLjM2NzItMi4zMDQ3IDEuMzY3Mi01LjQ0OTJ2LTAuNDEwMTZxMC0zLjE0NDUtMS4zNjcyLTUuNDI5Ny0xLjM0NzYtMi4zMDQ3LTQuMzE2NC0yLjMwNDd6Ii8+CiAgPHBhdGggZD0ibTE2Ni45MSAxMTYuNzN2MzBoLTMuNjMyOHYtMzB6Ii8+CiAgPHBhdGggZD0ibTE4NS43NSAxNDYuNzNxLTAuMzUxNTctMC43NjE3Mi0wLjUwNzgyLTIuMjI2Ni0xLjAxNTYgMS4wNzQyLTIuNTM5MSAxLjg1NTUtMS41MjM0IDAuNzYxNzItMy40NzY2IDAuNzYxNzItMy4yNDIyIDAtNS4xOTUzLTEuODE2NC0xLjk1MzEtMS44MTY0LTEuOTUzMS00LjQ1MzEgMC0zLjM5ODQgMi41NzgxLTUuMTU2MiAyLjU3ODEtMS43NzczIDYuOTMzNi0xLjc3NzNoMy41NzQydi0xLjY3OTdxMC0xLjg3NS0xLjEzMjgtMi45ODgzLTEuMTEzMy0xLjEzMjgtMy4zMjAzLTEuMTMyOC0yLjA1MDggMC0zLjMyMDMgMS4wMTU2LTEuMjUgMC45OTYxLTEuMjUgMi4zMjQyaC0zLjYxMzNxMC0yLjI2NTYgMi4yODUyLTQuMjU3OCAyLjI4NTItMS45OTIyIDYuMTEzMy0xLjk5MjIgMy40Mzc1IDAgNS42NDQ1IDEuNzU3OCAyLjIwNyAxLjc1NzggMi4yMDcgNS4zMTI1djkuNDkyMnEwIDIuOTI5NyAwLjc0MjE5IDQuNjQ4NHYwLjMxMjV6bS01Ljk5NjEtMi43NzM0cTEuOTUzMSAwIDMuMzc4OS0wLjk3NjU2IDEuNDQ1My0wLjk3NjU2IDIuMDMxMi0yLjE2OHYtNC4zNTU1aC0zLjM1OTRxLTYuMDkzOCAwLjExNzE5LTYuMDkzOCAzLjkwNjIgMCAxLjUwMzkgMS4wMTU2IDIuNTU4NiAxLjAxNTYgMS4wMzUyIDMuMDI3MyAxLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTIwMy4yMyAxMjguMjVxLTEuNzM4MyAwLTMuMDY2NCAwLjkzNzUtMS4zMjgxIDAuOTM3NS0yLjA4OTggMi40NDE0djE1LjA5OGgtMy42MTMzdi0yMS4xMzNoMy40MThsMC4xMTcxOSAyLjYzNjdxMi40MDIzLTMuMDI3MyA2LjMwODYtMy4wMjczIDMuMTA1NSAwIDQuOTIxOSAxLjczODMgMS44MzU5IDEuNzM4MyAxLjg1NTUgNS44Mzk4djEzLjk0NWgtMy42MzI4di0xMy44ODdxMC0yLjQ4MDUtMS4wOTM4LTMuNTM1Mi0xLjA3NDItMS4wNTQ3LTMuMTI1LTEuMDU0N3oiLz4KICA8cGF0aCBkPSJtNTcuOTQxIDE5NC4xNXExLjkzMzYgMCAzLjM3ODktMS4xNTIzIDEuNDY0OC0xLjE1MjMgMS42MDE2LTIuOTQ5MmgzLjQzNzVxLTAuMTM2NzIgMi44MzItMi41OTc3IDQuOTYwOS0yLjQ2MDkgMi4xMDk0LTUuODIwMyAyLjEwOTQtNC43NjU2IDAtNy4wODk4LTMuMTQ0NS0yLjMwNDctMy4xNDQ1LTIuMzA0Ny03LjQwMjN2LTAuODIwMzFxMC00LjI1NzggMi4zMDQ3LTcuNDAyNCAyLjMyNDItMy4xNDQ1IDcuMDg5OC0zLjE0NDUgMy43MTA5IDAgNS45OTYxIDIuMjA3IDIuMjg1MiAyLjE4NzUgMi40MjE5IDUuNDQ5MmgtMy40Mzc1cS0wLjEzNjcyLTEuOTUzMS0xLjQ4NDQtMy4zMjAzLTEuMzI4MS0xLjM2NzItMy40OTYxLTEuMzY3Mi0yLjIyNjYgMC0zLjQ5NjEgMS4xMzI4LTEuMjUgMS4xMzI4LTEuNzc3MyAyLjg3MTEtMC41MDc4MSAxLjczODMtMC41MDc4MSAzLjU3NDJ2MC44MjAzMXEwIDEuODU1NSAwLjUwNzgxIDMuNTkzOCAwLjUwNzgxIDEuNzM4MyAxLjc1NzggMi44NzExIDEuMjY5NSAxLjExMzMgMy41MTU2IDEuMTEzM3oiLz4KICA8cGF0aCBkPSJtNjkuNDY1IDE4NS45NXEwLTQuNTg5OCAyLjU3ODEtNy42NTYyIDIuNTc4MS0zLjA4NTkgNy4wMTE3LTMuMDg1OSA0LjQzMzYgMCA3LjAxMTcgMy4wMjczIDIuNTc4MSAzLjAwNzggMi42MzY3IDcuNTE5NXYwLjY0NDUzcTAgNC41ODk4LTIuNTk3NyA3LjY1NjItMi41NzgxIDMuMDY2NC03LjAxMTcgMy4wNjY0LTQuNDUzMSAwLTcuMDUwOC0zLjA2NjQtMi41NzgxLTMuMDY2NC0yLjU3ODEtNy42NTYyem0zLjYxMzMgMC40NDkyMnEwIDMuMTQ0NSAxLjQ4NDQgNS40NDkyIDEuNTAzOSAyLjMwNDcgNC41MzEyIDIuMzA0NyAyLjk0OTIgMCA0LjQ1MzEtMi4yNjU2IDEuNTAzOS0yLjI4NTIgMS41MjM0LTUuNDI5N3YtMC41MDc4MXEwLTMuMTA1NS0xLjUwMzktNS40Mjk3LTEuNTAzOS0yLjM0MzgtNC41MTE3LTIuMzQzOC0yLjk4ODMgMC00LjQ5MjIgMi4zNDM4LTEuNDg0NCAyLjMyNDItMS40ODQ0IDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTAyIDE3OC4yNXEtMS43MzgzIDAtMy4wNjY0IDAuOTM3NS0xLjMyODEgMC45Mzc1LTIuMDg5OCAyLjQ0MTR2MTUuMDk4aC0zLjYxMzN2LTIxLjEzM2gzLjQxOGwwLjExNzE5IDIuNjM2N3EyLjQwMjMtMy4wMjczIDYuMzA4Ni0zLjAyNzMgMy4xMDU1IDAgNC45MjE5IDEuNzM4MyAxLjgzNTkgMS43MzgzIDEuODU1NSA1LjgzOTh2MTMuOTQ1aC0zLjYzMjh2LTEzLjg4N3EwLTIuNDgwNS0xLjA5MzgtMy41MzUyLTEuMDc0Mi0xLjA1NDctMy4xMjUtMS4wNTQ3eiIvPgogIDxwYXRoIGQ9Im0xMjQuNDYgMTc4LjM3aC00LjMxNjR2MTguMzU5aC0zLjYxMzN2LTE4LjM1OWgtMy4zMzk4di0yLjc3MzRoMy4zMzk4di0xLjgzNTlxMC0zLjU5MzggMi4wNzAzLTUuNTA3OCAyLjA3MDMtMS45MzM2IDUuNjY0MS0xLjkzMzYgMi4xODc1IDAgNS41MjczIDEuMTkxNGwtMC42MDU0NiAzLjA0NjlxLTIuNTM5MS0wLjk5NjA5LTQuNjY4LTAuOTk2MDktMi4zMjQyIDAtMy4zNTk0IDEuMDU0Ny0xLjAxNTYgMS4wMzUyLTEuMDE1NiAzLjE0NDV2MS44MzU5aDQuMzE2NHptNy4xMDk0LTIuNzczNHYyMS4xMzNoLTMuNjEzM3YtMjEuMTMzeiIvPgogIDxwYXRoIGQ9Im0xNDUuNTIgMjA1LjA3cS0xLjY0MDYgMC00LjAyMzQtMC44MDA3OC0yLjM4MjgtMC44MDA3OC0zLjgwODYtMi44NzExbDEuODk0NS0yLjE0ODRxMi4zNDM4IDIuODUxNiA1LjY2NDEgMi44NTE2IDIuNTU4NiAwIDQuMDgyLTEuNDQ1MyAxLjUyMzQtMS40MjU4IDEuNTIzNC00LjE5OTJ2LTEuODU1NXEtMi4xNDg0IDIuNTE5NS01LjkxOCAyLjUxOTUtMy44MDg2IDAtNi4wNTQ3LTMuMDQ2OS0yLjI0NjEtMy4wNDY5LTIuMjQ2MS03LjY3NTh2LTAuNDEwMTZxMC00Ljg0MzggMi4yMjY2LTcuODEyNSAyLjI0NjEtMi45Njg4IDYuMTEzMy0yLjk2ODggMy44ODY3IDAgNi4wMzUyIDIuNzM0NGwwLjE3NTc4LTIuMzQzOGgzLjI4MTJ2MjAuNjg0cTAgNC4xOTkyLTIuNSA2LjQ4NDQtMi41IDIuMzA0Ny02LjQ0NTMgMi4zMDQ3em0tNS4yNzM0LTE4LjY3MnEwIDMuMTQ0NSAxLjMwODYgNS40MTAyIDEuMzI4MSAyLjI0NjEgNC4yNTc4IDIuMjQ2MSAzLjQzNzUgMCA1LjAzOTEtMy4xMjV2LTkuNjI4OXEtMC42ODM1OS0xLjMwODYtMS44OTQ1LTIuMTY4LTEuMjEwOS0wLjg3ODktMy4xMDU1LTAuODc4OS0yLjk0OTIgMC00LjI3NzMgMi4zMDQ3LTEuMzI4MSAyLjI4NTItMS4zMjgxIDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTczLjA2IDE5Ni43My0wLjA3ODEtMi4wODk4cS0yLjA3MDMgMi40ODA1LTYuMTcxOSAyLjQ4MDUtMy4xMDU1IDAtNS4wMTk1LTEuODM1OS0xLjkxNDEtMS44MzU5LTEuOTE0MS02LjA1NDd2LTEzLjYzM2gzLjYxMzN2MTMuNjcycTAgMi44NTE2IDEuMTkxNCAzLjgyODEgMS4yMTA5IDAuOTU3MDMgMi42OTUzIDAuOTU3MDMgNC4wODIgMCA1LjUwNzgtMy4wNjY0di0xNS4zOTFoMy42MzI4djIxLjEzM3oiLz4KICA8cGF0aCBkPSJtMTkwLjQ0IDE3OC42OHEtMy41MzUyIDAtNC44MjQyIDMuMDQ2OXYxNWgtMy42MTMzdi0yMS4xMzNoMy41MTU2bDAuMDc4MSAyLjQyMTlxMS43MzgzLTIuODEyNSA1LjAxOTUtMi44MTI1IDEuMDE1NiAwIDEuNjAxNiAwLjI3MzQ0bC0wLjAxOTUgMy4zNTk0cS0wLjgwMDc4LTAuMTU2MjUtMS43NTc4LTAuMTU2MjV6Ii8+CiAgPHBhdGggZD0ibTIxMS45MSAxOTMuMDRxLTEuMDM1MiAxLjU2MjUtMi45Mjk3IDIuODMyLTEuODk0NSAxLjI1LTUuMDE5NSAxLjI1LTQuNDE0MSAwLTcuMDcwMy0yLjg3MTEtMi42MzY3LTIuODcxMS0yLjYzNjctNy4zNDM4di0wLjgyMDMxcTAtMy40NTcgMS4zMDg2LTUuODc4OSAxLjMyODEtMi40NDE0IDMuNDM3NS0zLjcxMDkgMi4xMDk0LTEuMjg5MSA0LjQ5MjItMS4yODkxIDQuNTMxMiAwIDYuNjAxNiAyLjk2ODggMi4wODk4IDIuOTQ5MiAyLjA4OTggNy4zODI4djEuNjIxMWgtMTQuMjk3cTAuMDc4MSAyLjkxMDIgMS43MTg4IDQuOTYwOSAxLjY2MDIgMi4wMzEyIDQuNTUwOCAyLjAzMTIgMS45MTQxIDAgMy4yNDIyLTAuNzgxMjUgMS4zMjgxLTAuNzgxMjUgMi4zMjQyLTIuMDg5OHptLTguNDE4LTE0Ljg2M3EtMi4xNDg0IDAtMy42MzI4IDEuNTYyNS0xLjQ4NDQgMS41NjI1LTEuODU1NSA0LjQ5MjJoMTAuNTY2di0wLjI3MzQ0cS0wLjEzNjcyLTIuMTA5NC0xLjIzMDUtMy45NDUzLTEuMDc0Mi0xLjgzNTktMy44NDc3LTEuODM1OXoiLz4KICA8cGF0aCBkPSJtMjMwLjAzIDE5Ni43My0wLjE3NTc4LTIuMjY1NnEtMi4xNjggMi42NTYyLTYuMDM1MiAyLjY1NjItMy43MTA5IDAtNS45OTYxLTMuMDA3OC0yLjI4NTItMy4wMDc4LTIuMzI0Mi03LjU1ODZ2LTAuNTY2NDFxMC00Ljg0MzggMi4yODUyLTcuODEyNSAyLjMwNDctMi45Njg4IDYuMDc0Mi0yLjk2ODggMy43MzA1IDAgNS44NTk0IDIuNXYtMTAuOTc3aDMuNjMyOHYzMHptLTEwLjg5OC0xMC4zMzJxMCAzLjE0NDUgMS4zMjgxIDUuNDEwMiAxLjMyODEgMi4yNDYxIDQuMjU3OCAyLjI0NjEgMy4zNTk0IDAgNS0zLjA2NjR2LTkuNzI2NnEtMS42MjExLTMuMDA3OC00Ljk2MDktMy4wMDc4LTIuOTQ5MiAwLTQuMjk2OSAyLjMwNDctMS4zMjgxIDIuMjg1Mi0xLjMyODEgNS40Mjk3eiIvPgogPC9nPgo8L3N2Zz4K'\n            }\n        ];\n        return attributeService.saveEntityAttributes(\n            entityId, \"SERVER_SCOPE\", attributesArray);\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7cad1c71-0765-4277-32a8-c87808a0c689"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "0a63a6e0-cb6e-5d7b-7971-642221547ca4",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "c247004e-34a4-57ee-cac3-8a661aa8da5a": {
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7a3ac371-a996-ee2e-8652-6fab5a79027c",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "latitude",
                  "type": "attribute",
                  "label": "latitude",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.862061599769905
                },
                {
                  "name": "longitude",
                  "type": "attribute",
                  "label": "longitude",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.017864596400994026
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "latitude",
                  "type": "attribute",
                  "label": "selectedDoktorkit",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.5292772206260663,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": true,
                  "postFuncBody": "if (value !== '') {\n    return true;\n} else {\n    return false;\n}"
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "provider": "openstreet-map",
            "gmApiKey": "AIzaSyDoEx2kaGz3PxwbI9T7ccTSg5xjdw8Nw8Q",
            "gmDefaultMapType": "roadmap",
            "mapProvider": "CartoDB.Positron",
            "useCustomProvider": false,
            "customProviderTileUrl": "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            "mapProviderHere": "HERE.normalDay",
            "credentials": {
              "useV3": false,
              "app_id": "AhM6TzD9ThyK78CT3ptx",
              "app_code": "p6NPiITB3Vv0GMUFnkLOOg",
              "apiKey": "kVXykxAfZ6LS4EbCTO02soFVfjA7HoBzNVVH9u7nzoE"
            },
            "mapImageUrl": "tb-image;/api/images/system/here_map_system_widget_map_image.svg",
            "imageEntityAlias": "",
            "imageUrlAttribute": "",
            "tmApiKey": "84d6d83e0e51e481e50454ccbe8986b",
            "tmDefaultMapType": "roadmap",
            "latKeyName": "latitude",
            "lngKeyName": "longitude",
            "xPosKeyName": "xPos",
            "yPosKeyName": "yPos",
            "defaultZoomLevel": 18,
            "defaultCenterPosition": "0,0",
            "disableScrollZooming": false,
            "disableDoubleClickZooming": false,
            "disableZoomControl": false,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "mapPageSize": 16384,
            "markerOffsetX": 0.5,
            "markerOffsetY": 1,
            "posFunction": "return {x: origXPos, y: origYPos};",
            "draggableMarker": true,
            "showLabel": true,
            "useLabelFunction": false,
            "label": "${entityName}",
            "labelFunction": null,
            "showTooltip": true,
            "showTooltipAction": "click",
            "autocloseTooltip": true,
            "useTooltipFunction": false,
            "tooltipPattern": "<b>${entityName}</b><br/><br/><link-act name='Assigned Devices'>Assigned devices</link-act><br/><br/><link-act name='delete-Measurement'>Delete</link-act>",
            "tooltipFunction": null,
            "tooltipOffsetX": 0,
            "tooltipOffsetY": -1,
            "color": "#fe7569",
            "useColorFunction": false,
            "colorFunction": null,
            "useMarkerImageFunction": true,
            "markerImage": null,
            "markerImageSize": 34,
            "markerImageFunction": "var selectedDoktorkit = data['selectedDoktorkit'] === true;\nvar selectedMode = dsData.filter(function (data) { return data['selectedDoktorkit'] === true; }).length > 0;\n\nvar width = 30;\nvar svgStr = getDoktorkitSvg(width, selectedDoktorkit);\nvar encodedSvg = encodeURIComponent(svgStr);\nvar svgUrl = 'data:image/svg+xml,' + encodedSvg;\n\nif (selectedDoktorkit) {\n    width += 8;\n}\n\nreturn {\n    url: svgUrl,\n    size: width,\n    markerOffset: [width / 2, width / 2],\n    tooltipOffset: [width * 0.5 - width / 2, - (width / 2)]\n};\n\nfunction getDoktorkitSvg(width, isSelected) {\n    var shape = '<path d=\"m18.636 15.8c0.59978 0 1.1276-0.32788 1.3995-0.82369l2.8629-5.1901c0.29589-0.5278-0.08796-1.1836-0.69574-1.1836h-11.836l-0.75172-1.5994h-2.615v1.5994h1.5994l2.8789 6.0697-1.0796 1.9513c-0.58378 1.0716 0.18393 2.3751 1.3995 2.3751h9.5964v-1.5994h-9.5964l0.87967-1.5994zm-7.5092-5.5979h9.7164l-2.2072 3.9985h-5.6139zm0.67175 9.5964c-0.87967 0-1.5914 0.71973-1.5914 1.5994s0.71174 1.5994 1.5914 1.5994 1.5994-0.71973 1.5994-1.5994-0.71973-1.5994-1.5994-1.5994zm7.997 0c-0.87967 0-1.5914 0.71973-1.5914 1.5994s0.71174 1.5994 1.5914 1.5994c0.87967 0 1.5994-0.71973 1.5994-1.5994s-0.71973-1.5994-1.5994-1.5994z\" fill=\"white\" stroke-width=\".7997\"/>';\n    var color = '#1F8B4D';\n    var background = getBackground(color);\n    var svgWidth = isSelected ? (width + 8) : width;\n    var svgHeight = isSelected ? 38 : 30;\n    \n    var opacity = selectedMode && !isSelected ? 0.4 : 1;\n    \n    var DoktorkitSvg = '<svg opacity=\"' + opacity + '\" width=\"' + svgWidth + '\" height=\"' + svgHeight + '\" viewBox=\"0 0 ' + svgWidth + ' ' + svgHeight + '\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                    wrapIfSelected(background + shape, isSelected);\n    if (isSelected) {\n        DoktorkitSvg += getDoktorkitSelectionStroke();\n    }\n    DoktorkitSvg += '</svg>';\n    return DoktorkitSvg;    \n}\n\nfunction wrapIfSelected(svg, isSelected) {\n    if (isSelected) {\n        return '<g transform=\"translate(4 4)\">' + svg + '</g>';\n    } else {\n        return svg;\n    }\n}\n\nfunction getBackground(color) {\n     return '<circle cx=\"15\" cy=\"15\" r=\"15\" fill=\"'+ color +'\"/>';\n}\n\nfunction getDoktorkitSelectionStroke() {\n     return '<circle cx=\"19\" cy=\"19\" r=\"18\" stroke=\"#D5C21B\" stroke-width=\"2\"/>';\n}\n",
            "markerImages": [],
            "showPolygon": false,
            "polygonKeyName": "perimeter",
            "editablePolygon": false,
            "showPolygonLabel": false,
            "usePolygonLabelFunction": false,
            "polygonLabel": "${entityName}",
            "polygonLabelFunction": null,
            "showPolygonTooltip": false,
            "showPolygonTooltipAction": "click",
            "autoClosePolygonTooltip": true,
            "usePolygonTooltipFunction": false,
            "polygonTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "polygonTooltipFunction": null,
            "polygonColor": "#3388ff",
            "polygonOpacity": 0.2,
            "usePolygonColorFunction": false,
            "polygonColorFunction": null,
            "polygonStrokeColor": "#3388ff",
            "polygonStrokeOpacity": 1,
            "polygonStrokeWeight": 3,
            "usePolygonStrokeColorFunction": false,
            "polygonStrokeColorFunction": null,
            "showCircle": false,
            "circleKeyName": "perimeter",
            "editableCircle": false,
            "showCircleLabel": false,
            "useCircleLabelFunction": false,
            "circleLabel": "${entityName}",
            "circleLabelFunction": null,
            "showCircleTooltip": false,
            "showCircleTooltipAction": "click",
            "autoCloseCircleTooltip": true,
            "useCircleTooltipFunction": false,
            "circleTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "circleTooltipFunction": null,
            "circleFillColor": "#3388ff",
            "circleFillColorOpacity": 0.2,
            "useCircleFillColorFunction": false,
            "circleFillColorFunction": null,
            "circleStrokeColor": "#3388ff",
            "circleStrokeOpacity": 1,
            "circleStrokeWeight": 3,
            "useCircleStrokeColorFunction": false,
            "circleStrokeColorFunction": null,
            "snappable": false,
            "initDragMode": true,
            "hideAllControlButton": true,
            "hideDrawControlButton": false,
            "hideEditControlButton": false,
            "hideRemoveControlButton": false,
            "useClusterMarkers": false,
            "zoomOnClick": true,
            "maxZoom": null,
            "maxClusterRadius": 80,
            "animate": true,
            "spiderfyOnMaxZoom": false,
            "showCoverageOnHover": true,
            "chunkedLoading": false,
            "removeOutsideVisibleBounds": true,
            "useIconCreateFunction": false,
            "clusterMarkerFunction": null
          },
          "title": "Doktorkits map",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "widgetStyle": {},
          "actions": {
            "markerClick": [
              {
                "name": "Select Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nvar selectedMeasurement = params['selectedMeasurement'];\nif (selectedMeasurement && selectedMeasurement.entityId.id === entityId.id) {\n    params['selectedMeasurement'] = null;\n} else {\n    params['selectedMeasurement'] = { entityId: entityId, entityName: entityName, entityLabel: entityLabel };\n}\nwidgetContext.stateController.updateState(null, params);\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "4de7962b-a1de-5cb1-cd78-993dc7863614"
              }
            ],
            "tooltipAction": [
              {
                "name": "Assigned Devices",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = JSON.parse(JSON.stringify(widgetContext.stateController.getStateParams()));\nparams['selectedMeasurement'] = {\n        entityId: entityId,\n        entityName: entityName,\n        entityLabel: entityLabel,\n};\nparams['targetEntityParamName'] = 'selectedMeasurement';\nparams['selectedDevice'] = null;\n\nwidgetContext.stateController.openState('measurement_devices', params);\t",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1ca54350-817a-27b3-26a7-3572544d8523"
              },
              {
                "name": "delete-Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenDeleteMeasurementDialog();\n\nfunction openDeleteMeasurementDialog() {\n  var title = 'Are you sure you want to delete the Measurement ' + entityName + '?';\n  var content = 'Be careful, after the confirmation, the Measurement will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteMeasurement();\n      }\n    }\n  );\n}\n\nfunction deleteMeasurement() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, customerId, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, customerId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteMeasurementToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Measurement Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Measurement Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteMeasurementToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "89d67b54-a78e-f190-3832-1aae29cee395"
              }
            ]
          },
          "showTitleIcon": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "titleTooltip": "",
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "c247004e-34a4-57ee-cac3-8a661aa8da5a",
        "typeFullFqn": "system.maps_v2.openstreetmap"
      },
      "2622a940-17ce-c92f-5caf-3e7781beb04b": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Measurements",
            "enableSearch": true,
            "enableSelectColumnDisplay": true,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": true,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Measurements",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7a3ac371-a996-ee2e-8652-6fab5a79027c",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "Address",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "70%",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.1345774127559587,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "locationName",
                  "type": "attribute",
                  "label": "Location Alias",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.7448728411727017,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "Select Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "updateDashboardState",
                "targetDashboardStateId": null,
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "5e50c296-0eac-8841-a69a-1cbbfe04d1c5"
              }
            ],
            "actionCellButton": [
              {
                "name": "Open Doktorkits",
                "icon": "devices_other",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkits",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "71c478b6-a4b1-e569-e99a-85d5562cc721"
              },
              {
                "name": "Delete Measurement",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenDeleteMeasurementDialog();\n\nfunction openDeleteMeasurementDialog() {\n  var title = 'Are you sure you want to delete the Measurement ' + entityName + '?';\n  var content = 'Be careful, after the confirmation, the Measurement will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteMeasurement();\n      }\n    }\n  );\n}\n\nfunction deleteMeasurement() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteMeasurementToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Measurement Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Measurement Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteMeasurementToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "338d9fd7-c752-eb0e-4687-2c2e32ca1a32"
              }
            ],
            "headerButton": [
              {
                "name": "Add Measurement",
                "icon": "add",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addMeasurementFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 350px;\">\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\n    <h2>Add Measurement</h2>\n    <span fxFlex></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content fxLayout=\"column\">\n    <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">\n      <mat-form-field fxFlex class=\"mat-block\">\n        <mat-label>Measurement title</mat-label>\n        <input matInput formControlName=\"name\" required>\n        <mat-error *ngIf=\"addMeasurementFormGroup.get('name').hasError('required')\">\n          Measurement title is required.\n        </mat-error>\n      </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      Cancel\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addMeasurementFormGroup.invalid || !addMeasurementFormGroup.dirty\">\n      Add Measurement\n    </button>\n  </div>\n</form>\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap\n    .get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap\n    .get('assetService'));\nlet entityGroupService = $injector.get(widgetContext\n    .servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext\n    .servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext\n    .servicesMap.get('entityRelationService'));\n\nopenAddMeasurementDialog();\n\nfunction openAddMeasurementDialog() {\n    customDialog.customDialog(htmlTemplate,\n        AddMeasurementDialogController).subscribe();\n}\n\nfunction AddMeasurementDialogController(instance) {\n    let vm = instance;\n    let projectName = widgetContext.stateController.getStateParams().selectedProject.entityName;\n    vm.addMeasurementFormGroup = vm.fb.group({\n        name: [projectName+\"_\", [vm.validators.required]]\n    });\n\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n\n    vm.save = function() {\n        const stateParams = widgetContext\n            .stateController.getStateParams();\n        var customerId;\n        var projectId;\n        projectId = {\n            id: (stateParams.selectedProject &&\n                    stateParams.selectedProject\n                    .entityId && stateParams\n                    .selectedProject.entityId.id) ?\n                stateParams.selectedProject.entityId\n                .id : '',\n            entityType: 'ASSET'\n        };\n        console.log(JSON.stringify(projectId));\n        if (widgetContext.currentUser.authority ===\n            'TENANT_ADMIN') {\n            customerId = widgetContext.stateController\n                .getStateParams().entityId;\n        } else {\n            customerId = {\n                id: widgetContext.currentUser\n                    .customerId,\n                entityType: 'CUSTOMER'\n            };\n        }\n        vm.addMeasurementFormGroup.markAsPristine();\n        saveMeasurementObservable(customerId).subscribe(\n            function(Measurement) {\n                const observables = [\n                    saveCustomerToMeasurementRelation(\n                        customerId, Measurement\n                        .id),\n                    saveAttributes(Measurement\n                        .id)\n                ];\n\n                // Add saveProjectToMeasurementRelation to observables if projectId is not empty\n                if (projectId.id !== \"\") {\n                    observables.push(\n                        saveProjectToMeasurementRelation(\n                            projectId,\n                            Measurement.id));\n                }\n                widgetContext.rxjs.forkJoin(observables).subscribe(\n                    function() {\n                        var params =\n                            widgetContext\n                            .stateController\n                            .getStateParams();\n                        var selectedMeasurement =\n                            params[\n                                'selectedMeasurement'\n                                ];\n                        params[\n                            'selectedMeasurement'] = {\n                            entityId: Measurement\n                                .id,\n                            entityName: Measurement\n                                .name,\n                            entityLabel: ''\n                        };\n                        widgetContext\n                            .updateAliases();\n                        vm.dialogRef.close(\n                        null);\n                    }\n                );\n            }\n        );\n    };\n\n    function saveMeasurementObservable(customerId) {\n        return getMeasurementsGroup(customerId).pipe(\n            widgetContext.rxjs.switchMap((\n                MeasurementsGroup) => {\n                const formValues = vm\n                    .addMeasurementFormGroup.value;\n                let Measurement = {\n                    name: formValues.name,\n                    type: 'Measurement',\n                    customerId: customerId\n                };\n                return assetService.saveAsset(\n                    Measurement,\n                    MeasurementsGroup.id.id)\n            })\n        );\n    }\n\n    function getMeasurementsGroup(customerId) {\n        return entityGroupService.getEntityGroupsByOwnerId(\n            customerId.entityType, customerId.id,\n            'ASSET').pipe(\n            widgetContext.rxjs.switchMap((\n                entityGroups) => {\n                    var MeasurementsGroup = entityGroups\n                        .find(group => group.name ===\n                            'Measurements');\n                    if (MeasurementsGroup) {\n                        return widgetContext.rxjs.of(\n                            MeasurementsGroup);\n                    } else {\n                        MeasurementsGroup = {\n                            type: 'ASSET',\n                            name: 'Measurements',\n                            ownerId: customerId\n                        };\n                        return entityGroupService\n                            .saveEntityGroup(\n                                MeasurementsGroup);\n                    }\n                })\n        );\n    }\n\n    function saveCustomerToMeasurementRelation(customerId,\n        MeasurementId) {\n        var relation = {\n            from: customerId,\n            to: MeasurementId,\n            typeGroup: 'COMMON',\n            type: 'Owns'\n        };\n        return entityRelationService.saveRelation(relation);\n    }\n\n    function saveProjectToMeasurementRelation(projectId,\n        MeasurementId) {\n        var relation = {\n            from: projectId,\n            to: MeasurementId,\n            typeGroup: 'COMMON',\n            type: 'Owns'\n        };\n        return entityRelationService.saveRelation(relation);\n    }\n\n    function saveAttributes(entityId) {\n        let attributesArray = [{\n                key: 'latitude',\n                value: 48.1406022\n            },\n            {\n                key: 'longitude',\n                value: 16.2932688\n            },\n            {\n                key: 'alias',\n                value: 'N/A'\n            },\n            {\n                key: 'address',\n                value: 'N/A'\n            },\n            {\n                key: 'state',\n                value: 'in preparation'\n            }, \n            {\n                key: 'active',\n                value: 'true'\n            },\n            {\n                key: 'units',\n                value: 'metric'\n            },\n            {\n                key: 'floorplan',\n                value: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCEtLSBDcmVhdGVkIHdpdGggSW5rc2NhcGUgKGh0dHA6Ly93d3cuaW5rc2NhcGUub3JnLykgLS0+Cjxzdmcgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc5LjM3NSA3OS4zNzUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiA8cmVjdCB4PSIyLjcwMTkiIHk9IjIuNzAxOSIgd2lkdGg9IjczLjk3MSIgaGVpZ2h0PSI3My45NzEiIGZpbGw9IiNmZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9Ii4xMTIxIiBzdHlsZT0icGFpbnQtb3JkZXI6bWFya2VycyBmaWxsIHN0cm9rZSIvPgogPGcgdHJhbnNmb3JtPSJtYXRyaXgoLjI2NDU4IDAgMCAuMjY0NTggMi42MzUgLTIuODgzNCkiIHN0cm9rZS13aWR0aD0iMXB4IiBzdHlsZT0ic2hhcGUtaW5zaWRlOnVybCgjcmVjdDQ4MzYpO3doaXRlLXNwYWNlOnByZSIgYXJpYS1sYWJlbD0iICAgTm8gcGxhbiBjb25maWd1cmVkIj4KICA8cGF0aCBkPSJtMTAxLjY3IDExOC4yOXYyOC40MzhoLTMuNzg5MWwtMTQuMzE2LTIxLjkzNHYyMS45MzRoLTMuNzY5NXYtMjguNDM4aDMuNzY5NWwxNC4zNzUgMjEuOTkydi0yMS45OTJ6Ii8+CiAgPHBhdGggZD0ibTEwNi44MyAxMzUuOTVxMC00LjU4OTggMi41NzgxLTcuNjU2MiAyLjU3ODEtMy4wODU5IDcuMDExNy0zLjA4NTl0Ny4wMTE3IDMuMDI3M3EyLjU3ODEgMy4wMDc4IDIuNjM2NyA3LjUxOTV2MC42NDQ1M3EwIDQuNTg5OC0yLjU5NzcgNy42NTYyLTIuNTc4MSAzLjA2NjQtNy4wMTE3IDMuMDY2NC00LjQ1MzEgMC03LjA1MDgtMy4wNjY0LTIuNTc4MS0zLjA2NjQtMi41NzgxLTcuNjU2MnptMy42MTMzIDAuNDQ5MjJxMCAzLjE0NDUgMS40ODQ0IDUuNDQ5MiAxLjUwMzkgMi4zMDQ3IDQuNTMxMiAyLjMwNDcgMi45NDkyIDAgNC40NTMxLTIuMjY1NiAxLjUwMzktMi4yODUyIDEuNTIzNC01LjQyOTd2LTAuNTA3ODFxMC0zLjEwNTUtMS41MDM5LTUuNDI5Ny0xLjUwMzktMi4zNDM4LTQuNTExNy0yLjM0MzgtMi45ODgzIDAtNC40OTIyIDIuMzQzOC0xLjQ4NDQgMi4zMjQyLTEuNDg0NCA1LjQyOTd6Ii8+CiAgPHBhdGggZD0ibTE1MC4xNyAxNDcuMTJxLTMuODA4NiAwLTYuMDM1Mi0yLjQ0MTR2MTAuMTc2aC0zLjYzMjh2LTI5LjI1OGgzLjMyMDNsMC4xNzU3OCAyLjMyNDJxMi4yMjY2LTIuNzE0OCA2LjExMzMtMi43MTQ4IDQuMDAzOSAwIDYuMTMyOCAyLjk2ODggMi4xMjg5IDIuOTY4OCAyLjEyODkgNy44MTI1djAuNDEwMTZxMCA0LjYyODktMi4xNDg0IDcuNjc1OC0yLjEyODkgMy4wNDY5LTYuMDU0NyAzLjA0Njl6bS0xLjExMzMtMTguODY3cS0zLjI4MTIgMC00LjkyMTkgMi45MTAydjEwLjExN3ExLjY2MDIgMi44NzExIDQuOTYwOSAyLjg3MTEgMi45Mjk3IDAgNC4yNzczLTIuMzA0NyAxLjM2NzItMi4zMDQ3IDEuMzY3Mi01LjQ0OTJ2LTAuNDEwMTZxMC0zLjE0NDUtMS4zNjcyLTUuNDI5Ny0xLjM0NzYtMi4zMDQ3LTQuMzE2NC0yLjMwNDd6Ii8+CiAgPHBhdGggZD0ibTE2Ni45MSAxMTYuNzN2MzBoLTMuNjMyOHYtMzB6Ii8+CiAgPHBhdGggZD0ibTE4NS43NSAxNDYuNzNxLTAuMzUxNTctMC43NjE3Mi0wLjUwNzgyLTIuMjI2Ni0xLjAxNTYgMS4wNzQyLTIuNTM5MSAxLjg1NTUtMS41MjM0IDAuNzYxNzItMy40NzY2IDAuNzYxNzItMy4yNDIyIDAtNS4xOTUzLTEuODE2NC0xLjk1MzEtMS44MTY0LTEuOTUzMS00LjQ1MzEgMC0zLjM5ODQgMi41NzgxLTUuMTU2MiAyLjU3ODEtMS43NzczIDYuOTMzNi0xLjc3NzNoMy41NzQydi0xLjY3OTdxMC0xLjg3NS0xLjEzMjgtMi45ODgzLTEuMTEzMy0xLjEzMjgtMy4zMjAzLTEuMTMyOC0yLjA1MDggMC0zLjMyMDMgMS4wMTU2LTEuMjUgMC45OTYxLTEuMjUgMi4zMjQyaC0zLjYxMzNxMC0yLjI2NTYgMi4yODUyLTQuMjU3OCAyLjI4NTItMS45OTIyIDYuMTEzMy0xLjk5MjIgMy40Mzc1IDAgNS42NDQ1IDEuNzU3OCAyLjIwNyAxLjc1NzggMi4yMDcgNS4zMTI1djkuNDkyMnEwIDIuOTI5NyAwLjc0MjE5IDQuNjQ4NHYwLjMxMjV6bS01Ljk5NjEtMi43NzM0cTEuOTUzMSAwIDMuMzc4OS0wLjk3NjU2IDEuNDQ1My0wLjk3NjU2IDIuMDMxMi0yLjE2OHYtNC4zNTU1aC0zLjM1OTRxLTYuMDkzOCAwLjExNzE5LTYuMDkzOCAzLjkwNjIgMCAxLjUwMzkgMS4wMTU2IDIuNTU4NiAxLjAxNTYgMS4wMzUyIDMuMDI3MyAxLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTIwMy4yMyAxMjguMjVxLTEuNzM4MyAwLTMuMDY2NCAwLjkzNzUtMS4zMjgxIDAuOTM3NS0yLjA4OTggMi40NDE0djE1LjA5OGgtMy42MTMzdi0yMS4xMzNoMy40MThsMC4xMTcxOSAyLjYzNjdxMi40MDIzLTMuMDI3MyA2LjMwODYtMy4wMjczIDMuMTA1NSAwIDQuOTIxOSAxLjczODMgMS44MzU5IDEuNzM4MyAxLjg1NTUgNS44Mzk4djEzLjk0NWgtMy42MzI4di0xMy44ODdxMC0yLjQ4MDUtMS4wOTM4LTMuNTM1Mi0xLjA3NDItMS4wNTQ3LTMuMTI1LTEuMDU0N3oiLz4KICA8cGF0aCBkPSJtNTcuOTQxIDE5NC4xNXExLjkzMzYgMCAzLjM3ODktMS4xNTIzIDEuNDY0OC0xLjE1MjMgMS42MDE2LTIuOTQ5MmgzLjQzNzVxLTAuMTM2NzIgMi44MzItMi41OTc3IDQuOTYwOS0yLjQ2MDkgMi4xMDk0LTUuODIwMyAyLjEwOTQtNC43NjU2IDAtNy4wODk4LTMuMTQ0NS0yLjMwNDctMy4xNDQ1LTIuMzA0Ny03LjQwMjN2LTAuODIwMzFxMC00LjI1NzggMi4zMDQ3LTcuNDAyNCAyLjMyNDItMy4xNDQ1IDcuMDg5OC0zLjE0NDUgMy43MTA5IDAgNS45OTYxIDIuMjA3IDIuMjg1MiAyLjE4NzUgMi40MjE5IDUuNDQ5MmgtMy40Mzc1cS0wLjEzNjcyLTEuOTUzMS0xLjQ4NDQtMy4zMjAzLTEuMzI4MS0xLjM2NzItMy40OTYxLTEuMzY3Mi0yLjIyNjYgMC0zLjQ5NjEgMS4xMzI4LTEuMjUgMS4xMzI4LTEuNzc3MyAyLjg3MTEtMC41MDc4MSAxLjczODMtMC41MDc4MSAzLjU3NDJ2MC44MjAzMXEwIDEuODU1NSAwLjUwNzgxIDMuNTkzOCAwLjUwNzgxIDEuNzM4MyAxLjc1NzggMi44NzExIDEuMjY5NSAxLjExMzMgMy41MTU2IDEuMTEzM3oiLz4KICA8cGF0aCBkPSJtNjkuNDY1IDE4NS45NXEwLTQuNTg5OCAyLjU3ODEtNy42NTYyIDIuNTc4MS0zLjA4NTkgNy4wMTE3LTMuMDg1OSA0LjQzMzYgMCA3LjAxMTcgMy4wMjczIDIuNTc4MSAzLjAwNzggMi42MzY3IDcuNTE5NXYwLjY0NDUzcTAgNC41ODk4LTIuNTk3NyA3LjY1NjItMi41NzgxIDMuMDY2NC03LjAxMTcgMy4wNjY0LTQuNDUzMSAwLTcuMDUwOC0zLjA2NjQtMi41NzgxLTMuMDY2NC0yLjU3ODEtNy42NTYyem0zLjYxMzMgMC40NDkyMnEwIDMuMTQ0NSAxLjQ4NDQgNS40NDkyIDEuNTAzOSAyLjMwNDcgNC41MzEyIDIuMzA0NyAyLjk0OTIgMCA0LjQ1MzEtMi4yNjU2IDEuNTAzOS0yLjI4NTIgMS41MjM0LTUuNDI5N3YtMC41MDc4MXEwLTMuMTA1NS0xLjUwMzktNS40Mjk3LTEuNTAzOS0yLjM0MzgtNC41MTE3LTIuMzQzOC0yLjk4ODMgMC00LjQ5MjIgMi4zNDM4LTEuNDg0NCAyLjMyNDItMS40ODQ0IDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTAyIDE3OC4yNXEtMS43MzgzIDAtMy4wNjY0IDAuOTM3NS0xLjMyODEgMC45Mzc1LTIuMDg5OCAyLjQ0MTR2MTUuMDk4aC0zLjYxMzN2LTIxLjEzM2gzLjQxOGwwLjExNzE5IDIuNjM2N3EyLjQwMjMtMy4wMjczIDYuMzA4Ni0zLjAyNzMgMy4xMDU1IDAgNC45MjE5IDEuNzM4MyAxLjgzNTkgMS43MzgzIDEuODU1NSA1LjgzOTh2MTMuOTQ1aC0zLjYzMjh2LTEzLjg4N3EwLTIuNDgwNS0xLjA5MzgtMy41MzUyLTEuMDc0Mi0xLjA1NDctMy4xMjUtMS4wNTQ3eiIvPgogIDxwYXRoIGQ9Im0xMjQuNDYgMTc4LjM3aC00LjMxNjR2MTguMzU5aC0zLjYxMzN2LTE4LjM1OWgtMy4zMzk4di0yLjc3MzRoMy4zMzk4di0xLjgzNTlxMC0zLjU5MzggMi4wNzAzLTUuNTA3OCAyLjA3MDMtMS45MzM2IDUuNjY0MS0xLjkzMzYgMi4xODc1IDAgNS41MjczIDEuMTkxNGwtMC42MDU0NiAzLjA0NjlxLTIuNTM5MS0wLjk5NjA5LTQuNjY4LTAuOTk2MDktMi4zMjQyIDAtMy4zNTk0IDEuMDU0Ny0xLjAxNTYgMS4wMzUyLTEuMDE1NiAzLjE0NDV2MS44MzU5aDQuMzE2NHptNy4xMDk0LTIuNzczNHYyMS4xMzNoLTMuNjEzM3YtMjEuMTMzeiIvPgogIDxwYXRoIGQ9Im0xNDUuNTIgMjA1LjA3cS0xLjY0MDYgMC00LjAyMzQtMC44MDA3OC0yLjM4MjgtMC44MDA3OC0zLjgwODYtMi44NzExbDEuODk0NS0yLjE0ODRxMi4zNDM4IDIuODUxNiA1LjY2NDEgMi44NTE2IDIuNTU4NiAwIDQuMDgyLTEuNDQ1MyAxLjUyMzQtMS40MjU4IDEuNTIzNC00LjE5OTJ2LTEuODU1NXEtMi4xNDg0IDIuNTE5NS01LjkxOCAyLjUxOTUtMy44MDg2IDAtNi4wNTQ3LTMuMDQ2OS0yLjI0NjEtMy4wNDY5LTIuMjQ2MS03LjY3NTh2LTAuNDEwMTZxMC00Ljg0MzggMi4yMjY2LTcuODEyNSAyLjI0NjEtMi45Njg4IDYuMTEzMy0yLjk2ODggMy44ODY3IDAgNi4wMzUyIDIuNzM0NGwwLjE3NTc4LTIuMzQzOGgzLjI4MTJ2MjAuNjg0cTAgNC4xOTkyLTIuNSA2LjQ4NDQtMi41IDIuMzA0Ny02LjQ0NTMgMi4zMDQ3em0tNS4yNzM0LTE4LjY3MnEwIDMuMTQ0NSAxLjMwODYgNS40MTAyIDEuMzI4MSAyLjI0NjEgNC4yNTc4IDIuMjQ2MSAzLjQzNzUgMCA1LjAzOTEtMy4xMjV2LTkuNjI4OXEtMC42ODM1OS0xLjMwODYtMS44OTQ1LTIuMTY4LTEuMjEwOS0wLjg3ODktMy4xMDU1LTAuODc4OS0yLjk0OTIgMC00LjI3NzMgMi4zMDQ3LTEuMzI4MSAyLjI4NTItMS4zMjgxIDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTczLjA2IDE5Ni43My0wLjA3ODEtMi4wODk4cS0yLjA3MDMgMi40ODA1LTYuMTcxOSAyLjQ4MDUtMy4xMDU1IDAtNS4wMTk1LTEuODM1OS0xLjkxNDEtMS44MzU5LTEuOTE0MS02LjA1NDd2LTEzLjYzM2gzLjYxMzN2MTMuNjcycTAgMi44NTE2IDEuMTkxNCAzLjgyODEgMS4yMTA5IDAuOTU3MDMgMi42OTUzIDAuOTU3MDMgNC4wODIgMCA1LjUwNzgtMy4wNjY0di0xNS4zOTFoMy42MzI4djIxLjEzM3oiLz4KICA8cGF0aCBkPSJtMTkwLjQ0IDE3OC42OHEtMy41MzUyIDAtNC44MjQyIDMuMDQ2OXYxNWgtMy42MTMzdi0yMS4xMzNoMy41MTU2bDAuMDc4MSAyLjQyMTlxMS43MzgzLTIuODEyNSA1LjAxOTUtMi44MTI1IDEuMDE1NiAwIDEuNjAxNiAwLjI3MzQ0bC0wLjAxOTUgMy4zNTk0cS0wLjgwMDc4LTAuMTU2MjUtMS43NTc4LTAuMTU2MjV6Ii8+CiAgPHBhdGggZD0ibTIxMS45MSAxOTMuMDRxLTEuMDM1MiAxLjU2MjUtMi45Mjk3IDIuODMyLTEuODk0NSAxLjI1LTUuMDE5NSAxLjI1LTQuNDE0MSAwLTcuMDcwMy0yLjg3MTEtMi42MzY3LTIuODcxMS0yLjYzNjctNy4zNDM4di0wLjgyMDMxcTAtMy40NTcgMS4zMDg2LTUuODc4OSAxLjMyODEtMi40NDE0IDMuNDM3NS0zLjcxMDkgMi4xMDk0LTEuMjg5MSA0LjQ5MjItMS4yODkxIDQuNTMxMiAwIDYuNjAxNiAyLjk2ODggMi4wODk4IDIuOTQ5MiAyLjA4OTggNy4zODI4djEuNjIxMWgtMTQuMjk3cTAuMDc4MSAyLjkxMDIgMS43MTg4IDQuOTYwOSAxLjY2MDIgMi4wMzEyIDQuNTUwOCAyLjAzMTIgMS45MTQxIDAgMy4yNDIyLTAuNzgxMjUgMS4zMjgxLTAuNzgxMjUgMi4zMjQyLTIuMDg5OHptLTguNDE4LTE0Ljg2M3EtMi4xNDg0IDAtMy42MzI4IDEuNTYyNS0xLjQ4NDQgMS41NjI1LTEuODU1NSA0LjQ5MjJoMTAuNTY2di0wLjI3MzQ0cS0wLjEzNjcyLTIuMTA5NC0xLjIzMDUtMy45NDUzLTEuMDc0Mi0xLjgzNTktMy44NDc3LTEuODM1OXoiLz4KICA8cGF0aCBkPSJtMjMwLjAzIDE5Ni43My0wLjE3NTc4LTIuMjY1NnEtMi4xNjggMi42NTYyLTYuMDM1MiAyLjY1NjItMy43MTA5IDAtNS45OTYxLTMuMDA3OC0yLjI4NTItMy4wMDc4LTIuMzI0Mi03LjU1ODZ2LTAuNTY2NDFxMC00Ljg0MzggMi4yODUyLTcuODEyNSAyLjMwNDctMi45Njg4IDYuMDc0Mi0yLjk2ODggMy43MzA1IDAgNS44NTk0IDIuNXYtMTAuOTc3aDMuNjMyOHYzMHptLTEwLjg5OC0xMC4zMzJxMCAzLjE0NDUgMS4zMjgxIDUuNDEwMiAxLjMyODEgMi4yNDYxIDQuMjU3OCAyLjI0NjEgMy4zNTk0IDAgNS0zLjA2NjR2LTkuNzI2NnEtMS42MjExLTMuMDA3OC00Ljk2MDktMy4wMDc4LTIuOTQ5MiAwLTQuMjk2OSAyLjMwNDctMS4zMjgxIDIuMjg1Mi0xLjMyODEgNS40Mjk3eiIvPgogPC9nPgo8L3N2Zz4K'\n            }\n        ];\n        return attributeService.saveEntityAttributes(\n            entityId, \"SERVER_SCOPE\", attributesArray);\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e965b8a1-a6ac-5ae4-fd79-2b7220b91ed1"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "2622a940-17ce-c92f-5caf-3e7781beb04b",
        "typeFullFqn": "system.cards.entities_table"
      },
      "6d854f9b-bcf2-99f0-8f2c-5230b9d04615": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "2519c941-a1b9-45bd-9821-88acf22e10af",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Name",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.1072369718797117
                },
                {
                  "name": "subscriptionId",
                  "type": "attribute",
                  "label": "subscriptionId",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.9753269761535099
                },
                {
                  "name": "kitType",
                  "type": "attribute",
                  "label": "kitType",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.1596562162042412
                },
                {
                  "name": "sessionIdKitBuy",
                  "type": "attribute",
                  "label": "sessionIdKitBuy",
                  "color": "#607d8b",
                  "settings": {},
                  "_hash": 0.8441880619528996
                },
                {
                  "name": "invoiceIdKitBuy",
                  "type": "attribute",
                  "label": "invoiceIdKitBuy",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.6504209600017694
                },
                {
                  "name": "sessionIdLicense",
                  "type": "attribute",
                  "label": "sessionIdLicense",
                  "color": "#8bc34a",
                  "settings": {},
                  "_hash": 0.9721073635188919
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "////////////////////////////////////////////////////////////////////////////////\r\n// Initialization of Services and Variables\r\n////////////////////////////////////////////////////////////////////////////////\r\n\r\nlet $injector = ctx.$scope.$injector;\r\nlet PageLink = ctx.pageLink;\r\nlet customDialog = $injector.get(ctx.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(ctx.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(ctx.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(ctx.servicesMap.get('attributeService'));\r\nlet assetProfileService = $injector.get(ctx.servicesMap.get('assetProfileService'));\r\nvar customer;\r\nif (ctx.currentUser.authority !== 'CUSTOMER_USER'){\r\n  customer = ctx.stateController.getStateParams().entityId;  \r\n}else{\r\n    customer = {entityType:\"CUSTOMER\",id: ctx.currentUser.customerId};\r\n}\r\nlet tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\r\nlet stripeSecretKey;\r\nsaveEntityAttribute(customer.id, \"checkSubscriptionStatus\", \"check\");\r\n////////////////////////////////////////////////////////////////////////////////\r\n// Entry Point\r\n////////////////////////////////////////////////////////////////////////////////\r\n\r\nfunction init() {\r\n    // 1) Fetch Stripe Secret Key for the tenant\r\n    attributeService\r\n        .getEntityAttributes(customer, \"SERVER_SCOPE\", [\"stripeKey\"])\r\n        .subscribe(async (attr) => {\r\n            stripeSecretKey = attr[0].value;\r\n\r\n            // 2) If 'data' is an array of kits, process each\r\n            if (Array.isArray(data) && data.length > 0) {\r\n                for (const kit of data) {\r\n                    await processKit(kit);\r\n                }\r\n            }\r\n        }, (error) => {\r\n            console.error(\"Error fetching Stripe Secret Key:\", error);\r\n        });\r\n}\r\n\r\n//init();\r\n\r\n////////////////////////////////////////////////////////////////////////////////\r\n// Main Logic for Each Kit\r\n////////////////////////////////////////////////////////////////////////////////\r\n\r\nasync function processKit(kit) {\r\n    const kitId = kit.entityId;\r\n    const kitType = kit.kitType;  // e.g. \"basis\", \"extension\", \"loraWan\"\r\n\r\n    // We'll set defaults:\r\n    let activation = false;              // overall activation\r\n    let licenseActivationStatus = false; // subscription-based license\r\n    let boughtKitStatus = false;         // kit purchase paid?\r\n\r\n    try {\r\n        //////////////////////////////////////////////////////////////////////////\r\n        // 1) kitType === \"basis\"\r\n        //////////////////////////////////////////////////////////////////////////\r\n        if (kitType === \"basis\" || \"loraWan\") {\r\n            // a) Check subscription (via subscriptionId or sessionIdLicense)\r\n            let subscriptionActive = false;\r\n\r\n            if (kit.subscriptionId && kit.subscriptionId.trim().length > 0) {\r\n                // We already have subscriptionId, check it\r\n                subscriptionActive = await checkSubscriptionStatus(kit.subscriptionId);\r\n            } else if (kit.sessionIdLicense && kit.sessionIdLicense.trim().length > 0) {\r\n                // We have a sessionId for the license. Fetch session, see if paid, and get subscriptionId\r\n                const licenseSession = await fetchCheckoutSession(kit.sessionIdLicense);\r\n                if (licenseSession.payment_status === \"paid\" && licenseSession.subscription) {\r\n                    // Save subscriptionId to the kit\r\n                    await saveEntityAttribute(kitId, \"subscriptionId\", licenseSession.subscription);\r\n                    // Then check subscription status\r\n                    subscriptionActive = await checkSubscriptionStatus(licenseSession.subscription);\r\n                }\r\n            }\r\n            // Set the attribute for licenseActivationStatus\r\n            licenseActivationStatus = subscriptionActive;\r\n\r\n            // b) Check kit purchase (via sessionIdKitBuy or invoiceIdKitBuy)\r\n            //boughtKitStatus = await checkKitPurchase(kit);\r\n\r\n            // c) Overall activation = subscriptionActive AND kitPurchasePaid\r\n            if (subscriptionActive /*&& boughtKitStatus*/) {\r\n                activation = true;\r\n            }\r\n\r\n        //////////////////////////////////////////////////////////////////////////\r\n        // 2) kitType === \"extension\" or \"loraWan\"\r\n        //////////////////////////////////////////////////////////////////////////\r\n        } /*else if (kitType === \"extension\" || kitType === \"loraWan\") {\r\n            // In these scenarios, no subscription check (so licenseActivationStatus remains false).\r\n            // We only check if the kit purchase is paid.\r\n            boughtKitStatus = await checkKitPurchase(kit);\r\n\r\n            // Overall activation = kitPurchasePaid\r\n            if (boughtKitStatus) {\r\n                activation = true;\r\n            }\r\n        }*/\r\n    } catch (err) {\r\n        console.error(`Error processing kit ${kitId}:`, err);\r\n        // We'll simply leave activation, licenseActivationStatus, boughtKitStatus as false\r\n    }\r\n\r\n    // Now we save all three attributes:\r\n    // activation, licenseActivationStatus, boughtKitStatus\r\n    await saveEntityAttribute(kitId, \"activation\", activation);\r\n    await saveEntityAttribute(kitId, \"licenseActivationStatus\", licenseActivationStatus);\r\n    //await saveEntityAttribute(kitId, \"boughtKitStatus\", boughtKitStatus);\r\n}\r\n\r\n////////////////////////////////////////////////////////////////////////////////\r\n// Helper: Check Subscription Status\r\n////////////////////////////////////////////////////////////////////////////////\r\n\r\n/**\r\n * checkSubscriptionStatus(subscriptionId)\r\n * - Returns `true` if subscription is \"active\", otherwise `false`.\r\n */\r\nasync function checkSubscriptionStatus(subscriptionId) {\r\n    if (!subscriptionId || subscriptionId.trim().length === 0) {\r\n        return false;\r\n    }\r\n    try {\r\n        const response = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n            method: \"GET\",\r\n            headers: {\r\n                'Authorization': `Bearer ${stripeSecretKey}`,\r\n                'Content-Type': 'application/json'\r\n            }\r\n        });\r\n        if (!response.ok) {\r\n            throw new Error(`Error fetching subscription details: ${response.statusText}`);\r\n        }\r\n        const subscription = await response.json();\r\n        return (subscription.status === \"active\");\r\n    } catch (error) {\r\n        console.error(\"Error in checkSubscriptionStatus:\", error);\r\n        return false;\r\n    }\r\n}\r\n\r\n////////////////////////////////////////////////////////////////////////////////\r\n// Helper: Check Kit Purchase (via sessionIdKitBuy or invoiceIdKitBuy)\r\n////////////////////////////////////////////////////////////////////////////////\r\n\r\n/**\r\n * checkKitPurchase(kit)\r\n * - Looks for kit.sessionIdKitBuy or kit.invoiceIdKitBuy\r\n * - Returns `true` if the purchase was paid, otherwise `false`.\r\n */\r\nasync function checkKitPurchase(kit) {\r\n    try {\r\n        // 1) Check sessionIdKitBuy\r\n        if (kit.sessionIdKitBuy && kit.sessionIdKitBuy.trim().length > 0) {\r\n            const session = await fetchCheckoutSession(kit.sessionIdKitBuy);\r\n            // A paid Checkout Session => session.payment_status === 'paid'\r\n            return (session.payment_status === 'paid');\r\n        }\r\n        // 2) If no sessionIdKitBuy, check invoiceIdKitBuy\r\n        else if (kit.invoiceIdKitBuy && kit.invoiceIdKitBuy.trim().length > 0) {\r\n            const invoiceId = kit.invoiceIdKitBuy;\r\n            const invoice = await fetchInvoice(invoiceId);\r\n            // A paid invoice => invoice.status === \"paid\"\r\n            return (invoice.status === \"paid\");\r\n        }\r\n        // 3) If neither is present, consider it not purchased\r\n        else {\r\n            return false;\r\n        }\r\n    } catch (error) {\r\n        console.error(\"Error in checkKitPurchase:\", error);\r\n        return false;\r\n    }\r\n}\r\n\r\n////////////////////////////////////////////////////////////////////////////////\r\n// Helper: Fetch Checkout Session\r\n////////////////////////////////////////////////////////////////////////////////\r\n\r\n/**\r\n * fetchCheckoutSession(sessionId)\r\n * - Returns a Stripe Checkout Session object\r\n */\r\nasync function fetchCheckoutSession(sessionId) {\r\n    const response = await fetch(`https://api.stripe.com/v1/checkout/sessions/${sessionId}`, {\r\n        method: \"GET\",\r\n        headers: { \r\n            'Authorization': `Bearer ${stripeSecretKey}`,\r\n            'Content-Type': 'application/json'\r\n        }\r\n    });\r\n    if (!response.ok) {\r\n        throw new Error(`Error fetching Checkout Session: ${response.statusText}`);\r\n    }\r\n    return response.json();\r\n}\r\n\r\n////////////////////////////////////////////////////////////////////////////////\r\n// Helper: Fetch Invoice\r\n////////////////////////////////////////////////////////////////////////////////\r\n\r\n/**\r\n * fetchInvoice(invoiceId)\r\n * - Returns a Stripe Invoice object\r\n */\r\nasync function fetchInvoice(invoiceId) {\r\n    const response = await fetch(`https://api.stripe.com/v1/invoices/${invoiceId}`, {\r\n        method: \"GET\",\r\n        headers: { \r\n            'Authorization': `Bearer ${stripeSecretKey}`,\r\n            'Content-Type': 'application/json'\r\n        }\r\n    });\r\n    if (!response.ok) {\r\n        throw new Error(`Error fetching Invoice: ${response.statusText}`);\r\n    }\r\n    return response.json();\r\n}\r\n\r\n////////////////////////////////////////////////////////////////////////////////\r\n// Helper: Save an Entity Attribute\r\n////////////////////////////////////////////////////////////////////////////////\r\n\r\n/**\r\n * saveEntityAttribute(entityId, key, value)\r\n * - Saves a single SERVER_SCOPE attribute on the kit (asset).\r\n */\r\nasync function saveEntityAttribute(entityId, key, value) {\r\n    const attributes = [{ key, value }];\r\n    return attributeService\r\n        .saveEntityAttributes({ entityType: \"CUSTOMER\", id: entityId }, \"SERVER_SCOPE\", attributes)\r\n        .toPromise();\r\n}\r\n\r\n\r\nvar typeSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24\" viewBox=\"0 -960 960 960\" width=\"24\"><path d=\"M160-80q-33 0-56.5-23.5T80-160v-480q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v480q0 33-23.5 56.5T800-80H160Zm240-640h160v-80H400v80Zm40 360v120h80v-120h120v-80H520v-120h-80v120H320v80h120Z\"/></svg>';\r\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\r\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\r\n\r\nvar header = '<div class=\"header\" fxLayout=\"column\" fxLayoutAlign=\"start stretch\" fxLayoutGap=\"8px\">' +\r\n                '<div fxLayout=\"row\" fxLayoutAlign=\"start stretch\">' +\r\n                  '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><button id=\"go-back\" matTooltip=\"Go back\" type=\"button\" mat-icon-button><mat-icon>arrow_back</mat-icon></button></div>' +\r\n                 /* '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><img style=\"vertical-align: middle;\" class=\"title-icon mat-icon\" src=\"'+ typeSvgUrl +'\"></div>' +*/\r\n                  '<div fxFlex fxLayout=\"column\" fxLayoutAlign=\"center\">' +\r\n                     '<div class=\"title\">Edit Doktorkit: {{ ctx.stateController.getStateParams().selectedDoktorkit?.entityName }}</div>' +\r\n                  '</div>' +\r\n                '</div>' +\r\n                '<div fxLayout=\"row\" fxLayoutAlign=\"stretch stretch\" fxLayoutGap=\"8px\">' +\r\n                  /*'<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"add-Kit\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">add_circle</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"Doktorkits\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">devices_other</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"Sensorkits\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">sensors</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +*/\r\n                  '<div fxFlex=\"50\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"get-location\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">location_on</mat-icon>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"50\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"delete-Doktorkit\" type=\"button\" mat-raised-button color=\"accent\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">delete</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                '</div>' +\r\n             '</div>';\r\n             \r\n/*return '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\r\n          (DoktorkitState \r\n            ? (header +\r\n               '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"edit_Doktorkit_card\"></tb-dashboard-state>') \r\n            : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"doktorkits_card_all\"></tb-dashboard-state>') +\r\n       '</div>';*/\r\n       \r\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\r\n            '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"doktorkits_card_all\"></tb-dashboard-state>' +\r\n       '</div>';",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n.main-layout .header {\n    height: 100px;\n    margin: 6px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n.main-layout .tb-mat-20 {\n    width: 1px;\n    height: 2px;\n    margin: 2px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 12px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedDoktorkit'] = null;\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "116515c2-d9bd-80b6-7a34-97373a802806"
              },
              {
                "name": "Doktorkit-devices",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f921410a-47b7-5884-1c63-d010a39064a4"
              },
              {
                "name": "delete-Doktorkit",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenDeleteDoktorkitDialog();\n\nfunction openDeleteDoktorkitDialog() {\n  var title = 'Are you sure you want to delete the Doktorkit ' + entityName + '?';\n  var content = 'Be careful, after the confirmation, the Doktorkit will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteDoktorkit();\n      }\n    }\n  );\n}\n\nfunction deleteDoktorkit() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteDoktorkitToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Doktorkit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Doktorkit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDoktorkitToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1af63269-0a95-b82e-0703-86bd8daf9356"
              },
              {
                "name": "get-location",
                "icon": "location_on",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "getLocation",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Get location action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to get phone location', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processLocationFunction": "// Function body to process current location of the phone. \n// - latitude - phone location latitude\n// - longitude - phone location longitude\nlet $injector = widgetContext.$scope.$injector;\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\n//showLocationDialog('Location', latitude, longitude);\nsaveEntityLocationAttributes('latitude', 'longitude', latitude, longitude);\nfunction getSelectedKitId() {\n    let stateParams = widgetContext.stateController.getStateParams();\n    return stateParams.selectedDoktorkit.entityId;\n}\n\nfunction saveEntityLocationAttributes(latitudeAttributeName, longitudeAttributeName, latitude, longitude) {\n    let entityId = getSelectedKitId();\n    if (entityId) {\n        let attributes = [\n            { key: \"latitude\", value: latitude },\n            { key: \"longitude\", value: longitude }\n        ];\n        attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributes).subscribe(\n        widgetContext.dialogs.alert('Location attributes saved!\\nLatitude: ' + latitude + '\\nLongitude: ' + longitude),\n           function() {\n               widgetContext.showSuccessToast('Location attributes saved!');\n           },\n           function(error) {\n               widgetContext.dialogs.alert('Location attributes save failed', JSON.stringify(error));\n           }\n        );\n    }\n}\n\n\nfunction showLocationDialog(title, latitude, longitude) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Latitude: '+latitude+'<br>Longitude: ' + longitude).subscribe();\n    }, 100);\n}"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "94c2e448-3356-0d9d-d976-d11a0ac2165c"
              }
            ],
            "headerButton": []
          },
          "pageSize": 1024,
          "useDashboardTimewindow": true,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "6d854f9b-bcf2-99f0-8f2c-5230b9d04615",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "fc9715d4-d47c-468c-9ccd-6be629cd0d53": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\n     <div fxLayout=\"row\" style=\"width: 100%; height: 60px;\" fxLayoutAlign=\"center start\">\n        <h5 fxFlex class=\"market-title\">Doktorkits</h5>\n        <button id=\"add-Doktorkit\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">add</mat-icon><span>Add Doktorkit</span></button>\n     </div>\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"doktorkits_map_all\"></tb-dashboard-state>\n    </div>\n</div>",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-container .tb-widget .tb-multiple-input {\n    background-color: #FAFAFA;\n    border-radius: 4px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .input-field {\n    padding-right: 30px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input mat-slide-toggle {\n    margin-top: 15px !important;\n    margin-bottom: 0 !important;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-slide-toggle-content {\n    width: 120px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-bar {\n    width: 42px;\n    height: 24px;\n    border-radius: 16px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb-container {\n    top: 2px;\n    left: 2px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-thumb-container {\n    transform: translate3d(18px, 0, 0);\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb {\n    background-color: #fafafa;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-bar {\n    background-color: #F2994A;\n}\n",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "add-Doktorkit",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDoktorkitFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 350px;\">\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\n    <h2>Add Doktorkit</h2>\n    <span fxFlex></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content fxLayout=\"column\">\n    <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">\n      <mat-form-field fxFlex class=\"mat-block\">\n        <mat-label>Doktorkit title</mat-label>\n        <input matInput formControlName=\"name\" required>\n        <mat-error *ngIf=\"addDoktorkitFormGroup.get('name').hasError('required')\">\n          Doktorkit title is required.\n        </mat-error>\n      </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      Cancel\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addDoktorkitFormGroup.invalid || !addDoktorkitFormGroup.dirty\">\n      Add Doktorkit\n    </button>\n  </div>\n</form>\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\n\r\nopenAddDoktorkitDialog();\r\n\r\nfunction openAddDoktorkitDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddDoktorkitDialogController).subscribe();\r\n}\r\n\r\nfunction AddDoktorkitDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.addDoktorkitFormGroup = vm.fb.group({\r\n    name: ['', [vm.validators.required]]\r\n  });\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    const stateParams = widgetContext.stateController.getStateParams();\r\n    var customerId;\r\n    var projectId;\r\n    var measurementId;\r\n    projectId = {id:(stateParams.selectedProject && stateParams.selectedProject.entityId && stateParams.selectedProject.entityId.id) ? stateParams.selectedProject.entityId.id : '',entityType: 'ASSET'}; \r\n    measurementId = {id:(stateParams.selectedMeasurement && stateParams.selectedMeasurement.entityId && stateParams.selectedMeasurement.entityId.id) ? stateParams.selectedMeasurement.entityId.id : '',entityType: 'ASSET'}; \r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        customerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n    vm.addDoktorkitFormGroup.markAsPristine();\r\n    saveDoktorkitObservable(customerId).subscribe(\r\n      function (Doktorkit) {\r\n        const observables = [\r\n        saveCustomerToDoktorkitRelation(customerId, Doktorkit.id),\r\n        saveAttributes(Doktorkit.id)\r\n        ];\r\n        // Add saveProjectToMeasurementRelation to observables if projectId is not empty\r\n        if(projectId.id !== \"\"){\r\n            observables.push(saveProjectToDoktorkitRelation(projectId, Doktorkit.id));\r\n        }\r\n        if(measurementId.id !== \"\"){\r\n            observables.push(saveMeasurementToDoktorkitRelation(measurementId, Doktorkit.id));\r\n        }\r\n          widgetContext.rxjs.forkJoin(observables).subscribe(\r\n              function () {\r\n                var params = widgetContext.stateController.getStateParams();\r\n                var selectedDoktorkit = params['selectedDoktorkit'];\r\n                params['selectedDoktorkit'] = { entityId: Doktorkit.id, entityName: Doktorkit.name, entityLabel: '' };\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              }\r\n        );\r\n      }\r\n    );\r\n  };\r\n\r\n  function saveDoktorkitObservable(customerId) {\r\n    return getDoktorkitsGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((DoktorkitsGroup) => {\r\n            return getUnassignedKitGroup(customerId).pipe(\r\n                widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\r\n                    const formValues = vm.addDoktorkitFormGroup.value;\r\n                    const Doktorkit = {\r\n                        name: formValues.name,\r\n                        type: 'Doktorkit',\r\n                        customerId: customerId\r\n                    };\r\n\r\n                    return assetService.saveAsset(Doktorkit, DoktorkitsGroup.id.id).pipe(\r\n                        widgetContext.rxjs.switchMap((savedAsset) => {\r\n                            // Ensure this line returns an observable\r\n                            return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, savedAsset.id.id).pipe(\r\n                                widgetContext.rxjs.map(() => {\r\n                                    return savedAsset; // Return the saved asset after adding to the entity group\r\n                                })\r\n                            );\r\n                        })\r\n                    );\r\n                })\r\n            );\r\n        })\r\n    );\r\n}\r\n\r\n\r\n  \r\n  function getDoktorkitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var DoktorkitsGroup = entityGroups.find(group => group.name === 'Doktorkits');\r\n              if (DoktorkitsGroup) {\r\n                  return widgetContext.rxjs.of(DoktorkitsGroup);\r\n              } else {\r\n                  DoktorkitsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Doktorkits',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(DoktorkitsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  function getUnassignedKitGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n              if (UnassignedKitGroup) {\r\n                  return widgetContext.rxjs.of(UnassignedKitGroup);\r\n              } else {\r\n                  UnassignedKitGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Unassigned Kit',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n\r\n  function saveCustomerToDoktorkitRelation(customerId, DoktorkitId) {\r\n      var relation = {\r\n          from: customerId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveProjectToDoktorkitRelation(projectId, DoktorkitId) {\r\n      var relation = {\r\n          from: projectId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveMeasurementToDoktorkitRelation(measurementId, DoktorkitId) {\r\n      var relation = {\r\n          from: measurementId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n        {\r\n            key: 'latitude',\r\n            value: 48.1406022\r\n        },\r\n        {\r\n            key: 'longitude',\r\n            value: 16.2932688\r\n        },\r\n        {\r\n            key: 'alias',\r\n            value: 'N/A'\r\n        },        \r\n        {\r\n            key: 'address',\r\n            value: 'N/A'\r\n        },\r\n        {\r\n            key: 'state',\r\n            value: 'normal'\r\n        },\r\n        {\r\n            key: 'units',\r\n            value: 'metric'\r\n        },\r\n        {\r\n            key: 'floorplan',\r\n            value: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCEtLSBDcmVhdGVkIHdpdGggSW5rc2NhcGUgKGh0dHA6Ly93d3cuaW5rc2NhcGUub3JnLykgLS0+Cjxzdmcgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc5LjM3NSA3OS4zNzUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiA8cmVjdCB4PSIyLjcwMTkiIHk9IjIuNzAxOSIgd2lkdGg9IjczLjk3MSIgaGVpZ2h0PSI3My45NzEiIGZpbGw9IiNmZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9Ii4xMTIxIiBzdHlsZT0icGFpbnQtb3JkZXI6bWFya2VycyBmaWxsIHN0cm9rZSIvPgogPGcgdHJhbnNmb3JtPSJtYXRyaXgoLjI2NDU4IDAgMCAuMjY0NTggMi42MzUgLTIuODgzNCkiIHN0cm9rZS13aWR0aD0iMXB4IiBzdHlsZT0ic2hhcGUtaW5zaWRlOnVybCgjcmVjdDQ4MzYpO3doaXRlLXNwYWNlOnByZSIgYXJpYS1sYWJlbD0iICAgTm8gcGxhbiBjb25maWd1cmVkIj4KICA8cGF0aCBkPSJtMTAxLjY3IDExOC4yOXYyOC40MzhoLTMuNzg5MWwtMTQuMzE2LTIxLjkzNHYyMS45MzRoLTMuNzY5NXYtMjguNDM4aDMuNzY5NWwxNC4zNzUgMjEuOTkydi0yMS45OTJ6Ii8+CiAgPHBhdGggZD0ibTEwNi44MyAxMzUuOTVxMC00LjU4OTggMi41NzgxLTcuNjU2MiAyLjU3ODEtMy4wODU5IDcuMDExNy0zLjA4NTl0Ny4wMTE3IDMuMDI3M3EyLjU3ODEgMy4wMDc4IDIuNjM2NyA3LjUxOTV2MC42NDQ1M3EwIDQuNTg5OC0yLjU5NzcgNy42NTYyLTIuNTc4MSAzLjA2NjQtNy4wMTE3IDMuMDY2NC00LjQ1MzEgMC03LjA1MDgtMy4wNjY0LTIuNTc4MS0zLjA2NjQtMi41NzgxLTcuNjU2MnptMy42MTMzIDAuNDQ5MjJxMCAzLjE0NDUgMS40ODQ0IDUuNDQ5MiAxLjUwMzkgMi4zMDQ3IDQuNTMxMiAyLjMwNDcgMi45NDkyIDAgNC40NTMxLTIuMjY1NiAxLjUwMzktMi4yODUyIDEuNTIzNC01LjQyOTd2LTAuNTA3ODFxMC0zLjEwNTUtMS41MDM5LTUuNDI5Ny0xLjUwMzktMi4zNDM4LTQuNTExNy0yLjM0MzgtMi45ODgzIDAtNC40OTIyIDIuMzQzOC0xLjQ4NDQgMi4zMjQyLTEuNDg0NCA1LjQyOTd6Ii8+CiAgPHBhdGggZD0ibTE1MC4xNyAxNDcuMTJxLTMuODA4NiAwLTYuMDM1Mi0yLjQ0MTR2MTAuMTc2aC0zLjYzMjh2LTI5LjI1OGgzLjMyMDNsMC4xNzU3OCAyLjMyNDJxMi4yMjY2LTIuNzE0OCA2LjExMzMtMi43MTQ4IDQuMDAzOSAwIDYuMTMyOCAyLjk2ODggMi4xMjg5IDIuOTY4OCAyLjEyODkgNy44MTI1djAuNDEwMTZxMCA0LjYyODktMi4xNDg0IDcuNjc1OC0yLjEyODkgMy4wNDY5LTYuMDU0NyAzLjA0Njl6bS0xLjExMzMtMTguODY3cS0zLjI4MTIgMC00LjkyMTkgMi45MTAydjEwLjExN3ExLjY2MDIgMi44NzExIDQuOTYwOSAyLjg3MTEgMi45Mjk3IDAgNC4yNzczLTIuMzA0NyAxLjM2NzItMi4zMDQ3IDEuMzY3Mi01LjQ0OTJ2LTAuNDEwMTZxMC0zLjE0NDUtMS4zNjcyLTUuNDI5Ny0xLjM0NzYtMi4zMDQ3LTQuMzE2NC0yLjMwNDd6Ii8+CiAgPHBhdGggZD0ibTE2Ni45MSAxMTYuNzN2MzBoLTMuNjMyOHYtMzB6Ii8+CiAgPHBhdGggZD0ibTE4NS43NSAxNDYuNzNxLTAuMzUxNTctMC43NjE3Mi0wLjUwNzgyLTIuMjI2Ni0xLjAxNTYgMS4wNzQyLTIuNTM5MSAxLjg1NTUtMS41MjM0IDAuNzYxNzItMy40NzY2IDAuNzYxNzItMy4yNDIyIDAtNS4xOTUzLTEuODE2NC0xLjk1MzEtMS44MTY0LTEuOTUzMS00LjQ1MzEgMC0zLjM5ODQgMi41NzgxLTUuMTU2MiAyLjU3ODEtMS43NzczIDYuOTMzNi0xLjc3NzNoMy41NzQydi0xLjY3OTdxMC0xLjg3NS0xLjEzMjgtMi45ODgzLTEuMTEzMy0xLjEzMjgtMy4zMjAzLTEuMTMyOC0yLjA1MDggMC0zLjMyMDMgMS4wMTU2LTEuMjUgMC45OTYxLTEuMjUgMi4zMjQyaC0zLjYxMzNxMC0yLjI2NTYgMi4yODUyLTQuMjU3OCAyLjI4NTItMS45OTIyIDYuMTEzMy0xLjk5MjIgMy40Mzc1IDAgNS42NDQ1IDEuNzU3OCAyLjIwNyAxLjc1NzggMi4yMDcgNS4zMTI1djkuNDkyMnEwIDIuOTI5NyAwLjc0MjE5IDQuNjQ4NHYwLjMxMjV6bS01Ljk5NjEtMi43NzM0cTEuOTUzMSAwIDMuMzc4OS0wLjk3NjU2IDEuNDQ1My0wLjk3NjU2IDIuMDMxMi0yLjE2OHYtNC4zNTU1aC0zLjM1OTRxLTYuMDkzOCAwLjExNzE5LTYuMDkzOCAzLjkwNjIgMCAxLjUwMzkgMS4wMTU2IDIuNTU4NiAxLjAxNTYgMS4wMzUyIDMuMDI3MyAxLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTIwMy4yMyAxMjguMjVxLTEuNzM4MyAwLTMuMDY2NCAwLjkzNzUtMS4zMjgxIDAuOTM3NS0yLjA4OTggMi40NDE0djE1LjA5OGgtMy42MTMzdi0yMS4xMzNoMy40MThsMC4xMTcxOSAyLjYzNjdxMi40MDIzLTMuMDI3MyA2LjMwODYtMy4wMjczIDMuMTA1NSAwIDQuOTIxOSAxLjczODMgMS44MzU5IDEuNzM4MyAxLjg1NTUgNS44Mzk4djEzLjk0NWgtMy42MzI4di0xMy44ODdxMC0yLjQ4MDUtMS4wOTM4LTMuNTM1Mi0xLjA3NDItMS4wNTQ3LTMuMTI1LTEuMDU0N3oiLz4KICA8cGF0aCBkPSJtNTcuOTQxIDE5NC4xNXExLjkzMzYgMCAzLjM3ODktMS4xNTIzIDEuNDY0OC0xLjE1MjMgMS42MDE2LTIuOTQ5MmgzLjQzNzVxLTAuMTM2NzIgMi44MzItMi41OTc3IDQuOTYwOS0yLjQ2MDkgMi4xMDk0LTUuODIwMyAyLjEwOTQtNC43NjU2IDAtNy4wODk4LTMuMTQ0NS0yLjMwNDctMy4xNDQ1LTIuMzA0Ny03LjQwMjN2LTAuODIwMzFxMC00LjI1NzggMi4zMDQ3LTcuNDAyNCAyLjMyNDItMy4xNDQ1IDcuMDg5OC0zLjE0NDUgMy43MTA5IDAgNS45OTYxIDIuMjA3IDIuMjg1MiAyLjE4NzUgMi40MjE5IDUuNDQ5MmgtMy40Mzc1cS0wLjEzNjcyLTEuOTUzMS0xLjQ4NDQtMy4zMjAzLTEuMzI4MS0xLjM2NzItMy40OTYxLTEuMzY3Mi0yLjIyNjYgMC0zLjQ5NjEgMS4xMzI4LTEuMjUgMS4xMzI4LTEuNzc3MyAyLjg3MTEtMC41MDc4MSAxLjczODMtMC41MDc4MSAzLjU3NDJ2MC44MjAzMXEwIDEuODU1NSAwLjUwNzgxIDMuNTkzOCAwLjUwNzgxIDEuNzM4MyAxLjc1NzggMi44NzExIDEuMjY5NSAxLjExMzMgMy41MTU2IDEuMTEzM3oiLz4KICA8cGF0aCBkPSJtNjkuNDY1IDE4NS45NXEwLTQuNTg5OCAyLjU3ODEtNy42NTYyIDIuNTc4MS0zLjA4NTkgNy4wMTE3LTMuMDg1OSA0LjQzMzYgMCA3LjAxMTcgMy4wMjczIDIuNTc4MSAzLjAwNzggMi42MzY3IDcuNTE5NXYwLjY0NDUzcTAgNC41ODk4LTIuNTk3NyA3LjY1NjItMi41NzgxIDMuMDY2NC03LjAxMTcgMy4wNjY0LTQuNDUzMSAwLTcuMDUwOC0zLjA2NjQtMi41NzgxLTMuMDY2NC0yLjU3ODEtNy42NTYyem0zLjYxMzMgMC40NDkyMnEwIDMuMTQ0NSAxLjQ4NDQgNS40NDkyIDEuNTAzOSAyLjMwNDcgNC41MzEyIDIuMzA0NyAyLjk0OTIgMCA0LjQ1MzEtMi4yNjU2IDEuNTAzOS0yLjI4NTIgMS41MjM0LTUuNDI5N3YtMC41MDc4MXEwLTMuMTA1NS0xLjUwMzktNS40Mjk3LTEuNTAzOS0yLjM0MzgtNC41MTE3LTIuMzQzOC0yLjk4ODMgMC00LjQ5MjIgMi4zNDM4LTEuNDg0NCAyLjMyNDItMS40ODQ0IDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTAyIDE3OC4yNXEtMS43MzgzIDAtMy4wNjY0IDAuOTM3NS0xLjMyODEgMC45Mzc1LTIuMDg5OCAyLjQ0MTR2MTUuMDk4aC0zLjYxMzN2LTIxLjEzM2gzLjQxOGwwLjExNzE5IDIuNjM2N3EyLjQwMjMtMy4wMjczIDYuMzA4Ni0zLjAyNzMgMy4xMDU1IDAgNC45MjE5IDEuNzM4MyAxLjgzNTkgMS43MzgzIDEuODU1NSA1LjgzOTh2MTMuOTQ1aC0zLjYzMjh2LTEzLjg4N3EwLTIuNDgwNS0xLjA5MzgtMy41MzUyLTEuMDc0Mi0xLjA1NDctMy4xMjUtMS4wNTQ3eiIvPgogIDxwYXRoIGQ9Im0xMjQuNDYgMTc4LjM3aC00LjMxNjR2MTguMzU5aC0zLjYxMzN2LTE4LjM1OWgtMy4zMzk4di0yLjc3MzRoMy4zMzk4di0xLjgzNTlxMC0zLjU5MzggMi4wNzAzLTUuNTA3OCAyLjA3MDMtMS45MzM2IDUuNjY0MS0xLjkzMzYgMi4xODc1IDAgNS41MjczIDEuMTkxNGwtMC42MDU0NiAzLjA0NjlxLTIuNTM5MS0wLjk5NjA5LTQuNjY4LTAuOTk2MDktMi4zMjQyIDAtMy4zNTk0IDEuMDU0Ny0xLjAxNTYgMS4wMzUyLTEuMDE1NiAzLjE0NDV2MS44MzU5aDQuMzE2NHptNy4xMDk0LTIuNzczNHYyMS4xMzNoLTMuNjEzM3YtMjEuMTMzeiIvPgogIDxwYXRoIGQ9Im0xNDUuNTIgMjA1LjA3cS0xLjY0MDYgMC00LjAyMzQtMC44MDA3OC0yLjM4MjgtMC44MDA3OC0zLjgwODYtMi44NzExbDEuODk0NS0yLjE0ODRxMi4zNDM4IDIuODUxNiA1LjY2NDEgMi44NTE2IDIuNTU4NiAwIDQuMDgyLTEuNDQ1MyAxLjUyMzQtMS40MjU4IDEuNTIzNC00LjE5OTJ2LTEuODU1NXEtMi4xNDg0IDIuNTE5NS01LjkxOCAyLjUxOTUtMy44MDg2IDAtNi4wNTQ3LTMuMDQ2OS0yLjI0NjEtMy4wNDY5LTIuMjQ2MS03LjY3NTh2LTAuNDEwMTZxMC00Ljg0MzggMi4yMjY2LTcuODEyNSAyLjI0NjEtMi45Njg4IDYuMTEzMy0yLjk2ODggMy44ODY3IDAgNi4wMzUyIDIuNzM0NGwwLjE3NTc4LTIuMzQzOGgzLjI4MTJ2MjAuNjg0cTAgNC4xOTkyLTIuNSA2LjQ4NDQtMi41IDIuMzA0Ny02LjQ0NTMgMi4zMDQ3em0tNS4yNzM0LTE4LjY3MnEwIDMuMTQ0NSAxLjMwODYgNS40MTAyIDEuMzI4MSAyLjI0NjEgNC4yNTc4IDIuMjQ2MSAzLjQzNzUgMCA1LjAzOTEtMy4xMjV2LTkuNjI4OXEtMC42ODM1OS0xLjMwODYtMS44OTQ1LTIuMTY4LTEuMjEwOS0wLjg3ODktMy4xMDU1LTAuODc4OS0yLjk0OTIgMC00LjI3NzMgMi4zMDQ3LTEuMzI4MSAyLjI4NTItMS4zMjgxIDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTczLjA2IDE5Ni43My0wLjA3ODEtMi4wODk4cS0yLjA3MDMgMi40ODA1LTYuMTcxOSAyLjQ4MDUtMy4xMDU1IDAtNS4wMTk1LTEuODM1OS0xLjkxNDEtMS44MzU5LTEuOTE0MS02LjA1NDd2LTEzLjYzM2gzLjYxMzN2MTMuNjcycTAgMi44NTE2IDEuMTkxNCAzLjgyODEgMS4yMTA5IDAuOTU3MDMgMi42OTUzIDAuOTU3MDMgNC4wODIgMCA1LjUwNzgtMy4wNjY0di0xNS4zOTFoMy42MzI4djIxLjEzM3oiLz4KICA8cGF0aCBkPSJtMTkwLjQ0IDE3OC42OHEtMy41MzUyIDAtNC44MjQyIDMuMDQ2OXYxNWgtMy42MTMzdi0yMS4xMzNoMy41MTU2bDAuMDc4MSAyLjQyMTlxMS43MzgzLTIuODEyNSA1LjAxOTUtMi44MTI1IDEuMDE1NiAwIDEuNjAxNiAwLjI3MzQ0bC0wLjAxOTUgMy4zNTk0cS0wLjgwMDc4LTAuMTU2MjUtMS43NTc4LTAuMTU2MjV6Ii8+CiAgPHBhdGggZD0ibTIxMS45MSAxOTMuMDRxLTEuMDM1MiAxLjU2MjUtMi45Mjk3IDIuODMyLTEuODk0NSAxLjI1LTUuMDE5NSAxLjI1LTQuNDE0MSAwLTcuMDcwMy0yLjg3MTEtMi42MzY3LTIuODcxMS0yLjYzNjctNy4zNDM4di0wLjgyMDMxcTAtMy40NTcgMS4zMDg2LTUuODc4OSAxLjMyODEtMi40NDE0IDMuNDM3NS0zLjcxMDkgMi4xMDk0LTEuMjg5MSA0LjQ5MjItMS4yODkxIDQuNTMxMiAwIDYuNjAxNiAyLjk2ODggMi4wODk4IDIuOTQ5MiAyLjA4OTggNy4zODI4djEuNjIxMWgtMTQuMjk3cTAuMDc4MSAyLjkxMDIgMS43MTg4IDQuOTYwOSAxLjY2MDIgMi4wMzEyIDQuNTUwOCAyLjAzMTIgMS45MTQxIDAgMy4yNDIyLTAuNzgxMjUgMS4zMjgxLTAuNzgxMjUgMi4zMjQyLTIuMDg5OHptLTguNDE4LTE0Ljg2M3EtMi4xNDg0IDAtMy42MzI4IDEuNTYyNS0xLjQ4NDQgMS41NjI1LTEuODU1NSA0LjQ5MjJoMTAuNTY2di0wLjI3MzQ0cS0wLjEzNjcyLTIuMTA5NC0xLjIzMDUtMy45NDUzLTEuMDc0Mi0xLjgzNTktMy44NDc3LTEuODM1OXoiLz4KICA8cGF0aCBkPSJtMjMwLjAzIDE5Ni43My0wLjE3NTc4LTIuMjY1NnEtMi4xNjggMi42NTYyLTYuMDM1MiAyLjY1NjItMy43MTA5IDAtNS45OTYxLTMuMDA3OC0yLjI4NTItMy4wMDc4LTIuMzI0Mi03LjU1ODZ2LTAuNTY2NDFxMC00Ljg0MzggMi4yODUyLTcuODEyNSAyLjMwNDctMi45Njg4IDYuMDc0Mi0yLjk2ODggMy43MzA1IDAgNS44NTk0IDIuNXYtMTAuOTc3aDMuNjMyOHYzMHptLTEwLjg5OC0xMC4zMzJxMCAzLjE0NDUgMS4zMjgxIDUuNDEwMiAxLjMyODEgMi4yNDYxIDQuMjU3OCAyLjI0NjEgMy4zNTk0IDAgNS0zLjA2NjR2LTkuNzI2NnEtMS42MjExLTMuMDA3OC00Ljk2MDktMy4wMDc4LTIuOTQ5MiAwLTQuMjk2OSAyLjMwNDctMS4zMjgxIDIuMjg1Mi0xLjMyODEgNS40Mjk3eiIvPgogPC9nPgo8L3N2Zz4K'\r\n        }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7cad1c71-0765-4277-32a8-c87808a0c689"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "fc9715d4-d47c-468c-9ccd-6be629cd0d53",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "d2cec1c0-f9bb-1c7c-25ae-ea8853bc3b7e": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Diagnostic Kits",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "false",
            "displayEntityName": false,
            "entityNameColumnTitle": "Doktorkit ID",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "Label",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "Diagnostic Kit ID",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Diagnostic Kits",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "2519c941-a1b9-45bd-9821-88acf22e10af",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Diagnostic Kit ID",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.5282490591409559,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.4511182927579178
                },
                {
                  "name": "kitType",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostic-kits.diagnostic-kit-type}",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "if(value==='basis'){\n    return 'Diagnostics Basis Kit';\n}\nif(value==='extension'){\n    return 'Diagnostics Extension Kit';\n}\nif(value==='loraWan'){\n    return 'Diagnostics LoRaWAN Kit';\n}",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.69568544537813,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "subscriptionStatus",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostic-kits.subscription-status}",
                  "color": "#607d8b",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar licenseStatus = value;\r\nif (licenseStatus == 'active') { // all key values here are strings\r\n  color = '#4caf50';\r\n} else if (licenseStatus == 'pending') { // all key values here are strings\r\n  color = '#ffeb3b';\r\n} else if (licenseStatus == 'no license') { // all key values here are strings\r\n  color = '#D3D3D3';\r\n} else {\r\n  color = '#f44336';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span> ' + licenseStatus;\r\n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7919897897079038,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "nextPaymentDate",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostic-kits.next-payment}",
                  "color": "#607d8b",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "function formatDate(value) {\r\n  const date = new Date(value);\r\n  if (isNaN(date.getTime())) {\r\n    return \"\"; // Return empty string if the date is invalid\r\n  }\r\n  date.setHours(0, 0, 0, 0);\r\n  const day = date.getDate().toString().padStart(2, '0');\r\n  const month = (date.getMonth() + 1).toString().padStart(2, '0');\r\n  const year = date.getFullYear();\r\n  return `${day}/${month}/${year}`;\r\n}\r\n\r\nconst date = new Date(value);\r\ndate.setHours(0, 0, 0, 0);\r\nreturn formatDate(date); // Outputs in DD/MM/YYYY format",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.18765907366705847,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "validTo",
                  "type": "attribute",
                  "label": "{i18n:custom.diagnostic-kits.valid-to}",
                  "color": "#9c27b0",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "function formatDate(value) {\r\n  const date = new Date(value);\r\n  if (isNaN(date.getTime())) {\r\n    return \"\"; // Return empty string if the date is invalid\r\n  }\r\n  date.setHours(0, 0, 0, 0);\r\n  const day = date.getDate().toString().padStart(2, '0');\r\n  const month = (date.getMonth() + 1).toString().padStart(2, '0');\r\n  const year = date.getFullYear();\r\n  return `${day}/${month}/${year}`;\r\n}\r\n\r\nconst date = new Date(value);\r\ndate.setHours(0, 0, 0, 0);\r\nreturn formatDate(date); // Outputs in DD/MM/YYYY format",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5643595879016474,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "{i18n:custom.diagnostic-kits.open-devices}",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "92ce5e29-82ad-9f6e-51be-7bf3e7ae613d"
              }
            ],
            "actionCellButton": [
              {
                "name": "{i18n:custom.diagnostic-kits.edit-diagnostic-kit}",
                "icon": "edit",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"editEntityFormGroup\"\r\n      (ngSubmit)=\"save()\" \r\n      class=\"edit-entity-form max-w-3xl mx-auto\">\r\n    \r\n   <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n         <h2 class=\"text-lg font-semibold\">{{'custom.diagnostic-kits.edit-diagnostic-kit' | translate}}</h2>\r\n        <span class=\"flex-1\"></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n            <mat-icon>close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n    <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n\r\n        <!-- First row: Name-->\r\n        <div class=\"flex w-full gap-2\">\r\n\r\n            <!-- Name (Top-level form control) -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Diagnostic Kit Id</mat-label>\r\n                <input matInput \r\n                       formControlName=\"entityName\" \r\n                       required readonly>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('entityName')?.hasError('required')\">\r\n                  {{'custom.diagnostic-kits.diagnostic-kit-id-is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n\r\n            <!-- Label -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Label</mat-label>\r\n                <input matInput formControlName=\"label\" required>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('label')?.hasError('required')\">\r\n                  {{'custom.diagnostic-kits.label-is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n        </div>\r\n\r\n        <!-- Second row: kitType -->\r\n         <div class=\"flex w-full\">\r\n            <!-- HIDE Installation Type if measurementType is 'loraWan' -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\"\r\n                            *ngIf=\"editEntityFormGroup.get('attributes.measurementType')?.value !== 'loraWan'\"\r\n                            [formGroup]=\"editEntityFormGroup.controls['attributes']\">\r\n                <mat-label>{{'custom.diagnostic-kits.installation-type' | translate}}</mat-label>\r\n                <mat-select formControlName=\"kitType\" required>\r\n                     <mat-option value=\"basis\">Diagnostics Basis Kit</mat-option>\r\n                     <mat-option value=\"extension\">Diagnostics Extension Kit</mat-option>\r\n                     <mat-option value=\"loraWan\">Diagnostics LoRaWAN Kit</mat-option>\r\n                </mat-select>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('attributes.installationType')?.hasError('required')\">\r\n                  {{'custom.diagnostic-kits.diagnostic-kit-type-is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n        </div>\r\n    </div>\r\n\r\n    <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n        <button mat-button\r\n                color=\"primary\"\r\n                type=\"button\"\r\n                [disabled]=\"(isLoading$ | async)\"\r\n                (click)=\"cancel()\"\r\n                cdkFocusInitial>\r\n             {{'action.cancel' | translate}}\r\n        </button>\r\n        <button mat-button\r\n                mat-raised-button\r\n                color=\"primary\"\r\n                type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid\">\r\n            {{'action.save' | translate}}\r\n        </button>\r\n    </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\n\r\nopenEditEntityDialog();\r\n\r\nfunction openEditEntityDialog() {\r\n    customDialog.customDialog(htmlTemplate, EditEntityDialogController).subscribe();\r\n}\r\n\r\nfunction EditEntityDialogController(instance) {\r\n    let vm = instance;\r\n    vm.entityName = entityName; \r\n    vm.label = entityLabel; \r\n    vm.attributes = {};\r\n    vm.entity = {};\r\n\r\n    // Build the form group with a nested 'attributes' group\r\n    vm.editEntityFormGroup = vm.fb.group({\r\n        entityName: ['', [vm.validators.required]],\r\n        label: ['', [vm.validators.required]],\r\n        attributes: vm.fb.group({\r\n            kitType: [null]\r\n        })\r\n    });\r\n\r\n    getEntityInfo();\r\n\r\n    vm.cancel = function() {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function() {\r\n        // Mark the form as pristine right before saving\r\n        vm.editEntityFormGroup.markAsPristine();\r\n\r\n        // Save both entity main fields and attributes\r\n        widgetContext.rxjs.forkJoin([\r\n            saveAttributes(entityId),\r\n            saveEntity()\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n    function getEntityInfo() {\r\n        // Retrieve attributes + entity info in parallel\r\n        widgetContext.rxjs.forkJoin([\r\n            attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE'),\r\n            entityService.getEntity(entityId.entityType, entityId.id)\r\n        ]).subscribe(([attrData, entityData]) => {\r\n            vm.attributes = {};\r\n            // Populate vm.attributes from server response\r\n            for (let i = 0; i < attrData.length; i++) {\r\n                vm.attributes[attrData[i].key] = attrData[i].value;\r\n            }\r\n\r\n            vm.entity = entityData;\r\n\r\n            // Patch form values. \r\n            // Note that 'attributes' is a nested form group, so we pass an object for it.\r\n            vm.editEntityFormGroup.patchValue({\r\n                entityName: vm.entity.name,\r\n                label: vm.entity.label,\r\n                attributes: {\r\n                    kitType: vm.attributes.kitType\r\n                }\r\n            }, { emitEvent: false });\r\n        });\r\n    }\r\n\r\n    function saveEntity() {\r\n        const formValues = vm.editEntityFormGroup.value;\r\n        \r\n        // Always update name & label (ensures \"Save\" works even if no change)\r\n        vm.entity.name = formValues.entityName;\r\n        vm.entity.label = formValues.label;\r\n        /*console.log(\"enitity\",vm.entity);*/\r\n        return assetService.saveAsset(vm.entity);\r\n        \r\n        // If some other type, or no changes, return an observable that completes.\r\n        return widgetContext.rxjs.of([]);\r\n    }\r\n\r\n    function saveAttributes(entityId) {\r\n        // Compare original vs. new values to only send changed attributes\r\n        const currentAttributes = vm.attributes;\r\n        const updatedAttributes = vm.editEntityFormGroup.value.attributes;\r\n        \r\n        let attributesArray = [];\r\n        for (let key in updatedAttributes) {\r\n            if (updatedAttributes.hasOwnProperty(key)) {\r\n                if (updatedAttributes[key] !== currentAttributes[key]) {\r\n                    attributesArray.push({ key: key, value: updatedAttributes[key] });\r\n                }\r\n            }\r\n        }\r\n\r\n        if (attributesArray.length > 0) {\r\n            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n        }\r\n        return widgetContext.rxjs.of([]);\r\n    }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "4ba82627-39fc-7ac8-015e-8bb5184d8c82"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.open-diagnostic-kit-devices}",
                "icon": "devices_other",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "71c478b6-a4b1-e569-e99a-85d5562cc721"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.license.management}",
                "icon": "verified",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addEntityFormGroup\" (ngSubmit)=\"checkout()\" class=\"add-entity-form\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.diagnostic-kits.manage-diagnostic-kits' | translate }}</h2>\r\n        <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <!-- If NO device is assigned, show this info text -->\r\n    <div *ngIf=\"!deviceFound\" class=\"info-text\">\r\n      {{ 'custom.diagnostic-kits.please-assign-pflow' | translate }}\r\n    </div>\r\n\r\n    <!-- MAIN VIEW -->\r\n    <div *ngIf=\"view === 'main'\" class=\"button-group flex flex-col gap-4\">\r\n      <!--<div *ngIf=\"kitActivated\" class=\"info-text\">\r\n        The Diagnostic Kit is already activated and cannot be purchased again.\r\n      </div>-->\r\n      <button mat-raised-button color=\"primary\" \r\n              (click)=\"activateLicense()\"\r\n              [disabled]=\"!deviceFound || !canActivateLicense\">\r\n        {{ 'custom.diagnostic-kits.activate-license' | translate }}\r\n      </button>\r\n      <button mat-raised-button color=\"primary\" \r\n              (click)=\"licenseStatus()\"\r\n              [disabled]=\"!deviceFound || !subscriptionExists\">\r\n        {{ 'custom.diagnostic-kits.license-status' | translate }}\r\n      </button>\r\n      <button mat-raised-button color=\"primary\" \r\n              (click)=\"cancelLicense()\"\r\n              [disabled]=\"!deviceFound || !subscriptionExists || cancelDisabled\">\r\n        {{ 'custom.diagnostic-kits.cancel-license' | translate }}\r\n      </button>\r\n    </div>\r\n\r\n    <!-- ACTIVATE LICENSE VIEW -->\r\n    <div *ngIf=\"view === 'activate'\" class=\"flex flex-col gap-4\">\r\n      <div class=\"flex justify-center items-center gap-8\">\r\n        <div class=\"flex flex-col\">\r\n          <div>{{ 'custom.diagnostic-kits.pay-by-invoice' | translate }}</div>\r\n          <mat-checkbox [checked]=\"isInvoice\" (change)=\"onSelectInvoice($event)\"></mat-checkbox>\r\n        </div>\r\n        <div class=\"flex flex-col\">\r\n          <div>{{ 'custom.diagnostic-kits.credit-card-alternative-payments' | translate }}</div>\r\n          <mat-checkbox [checked]=\"isCard\" (change)=\"onSelectCard($event)\"></mat-checkbox>\r\n        </div>\r\n      </div>\r\n      <div class=\"action-buttons\">\r\n        <button mat-raised-button color=\"primary\" type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || (!isInvoice && !isCard)\">\r\n          {{ 'custom.diagnostic-kits.checkout' | translate }}\r\n        </button>\r\n        <button mat-button color=\"primary\" type=\"button\" (click)=\"backToMain()\">{{ 'custom.diagnostic-kits.back' | translate }}</button>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- BUY DIAGNOSTICKIT VIEW (one-time purchase) -->\r\n    <div *ngIf=\"view === 'buy'\" class=\"flex flex-col gap-4\">\r\n      <div class=\"flex justify-center items-center gap-8\">\r\n        <div class=\"flex flex-col\">\r\n          <div>{{ 'custom.diagnostic-kits.pay-by-invoice' | translate }}</div>\r\n          <mat-checkbox [checked]=\"buyInvoice\" (change)=\"onSelectBuyInvoice($event)\"></mat-checkbox>\r\n        </div>\r\n        <div class=\"flex flex-col\">\r\n          <div>{{ 'custom.diagnostic-kits.credit-card-alternative-payments' | translate }}</div>\r\n          <mat-checkbox [checked]=\"buyCard\" (change)=\"onSelectBuyCard($event)\"></mat-checkbox>\r\n        </div>\r\n      </div>\r\n      <div class=\"action-buttons\">\r\n        <button mat-raised-button color=\"primary\" type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || (!buyInvoice && !buyCard)\">\r\n          {{ 'custom.diagnostic-kits.purchase' | translate }}\r\n        </button>\r\n        <button mat-button color=\"primary\" type=\"button\" (click)=\"backToMain()\">{{ 'custom.diagnostic-kits.back' | translate }}</button>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- LICENSE STATUS VIEW -->\r\n    <div *ngIf=\"view === 'licenseStatus'\" fxLayout=\"column\">\r\n      <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n      <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n        <table class=\"subscription-table\">\r\n          <thead>\r\n            <tr>\r\n              <th>{{ 'custom.diagnostic-kits.start-date' | translate }}</th>\r\n              <th>{{ 'custom.diagnostic-kits.price' | translate }}</th>\r\n              <th>{{ 'custom.diagnostic-kits.billing-cycle' | translate }}</th>\r\n              <th>{{ 'custom.diagnostic-kits.next-billing' | translate }}</th>\r\n              <th>{{ 'custom.diagnostic-kits.valid-to' | translate }}</th>\r\n              <th>Status</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            <tr>\r\n              <td>{{ subscriptionStartDate | date:'dd/MM/yyyy' }}</td>\r\n              <td>{{ subscriptionPrice }}</td>\r\n              <td>{{ billingCycle }}</td>\r\n              <!-- \r\n                If nextPaymentDate is 0, show empty string.\r\n                Otherwise, format it as a date.\r\n              -->\r\n              <td>{{ nextPaymentDate === 0 ? '' : (nextPaymentDate | date:'dd/MM/yyyy') }}</td>\r\n              <td>{{ validTill | date:'dd/MM/yyyy' }}</td>\r\n              <td>\r\n                <span class=\"status-label\"\r\n                      [ngClass]=\"{\r\n                        'status-active': subscriptionStatus === 'active',\r\n                        'status-open-payment': subscriptionStatus === 'pending',\r\n                        'status-inactive': subscriptionStatus === 'inactive',\r\n                        'status-canceled': subscriptionStatus === 'canceled'\r\n                      }\">\r\n                  {{ subscriptionStatus }}\r\n                </span>\r\n              </td>\r\n            </tr>\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n      <!-- Pay button if subscription is pending -->\r\n      <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n        <button mat-raised-button color=\"primary\" type=\"button\"\r\n                *ngIf=\"subscriptionStatus === 'pending' || subscriptionStatus === 'inactive'\"\r\n                [disabled]=\"(isLoading$ | async)\"\r\n                (click)=\"initiatePayment()\">\r\n          {{ 'custom.diagnostic-kits.pay' | translate }}\r\n        </button>\r\n        <button mat-button color=\"primary\" type=\"button\" (click)=\"backToMain()\">{{ 'action.back' | translate }}</button>\r\n        <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">{{ 'action.close' | translate }}</button>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- CANCEL LICENSE CONFIRMATION VIEW -->\r\n    <div *ngIf=\"view === 'cancelSubscription'\" class=\"flex flex-col gap-4\">\r\n      <div class=\"info-text\">\r\n        {{ cancelMessage }}\r\n      </div>\r\n      <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n        <button mat-raised-button color=\"primary\" type=\"button\" (click)=\"confirmCancelSubscription()\">\r\n          {{ 'custom.diagnostic-kits.confirm-cancellation' | translate }}\r\n        </button>\r\n        <button mat-button color=\"primary\" type=\"button\" (click)=\"backToMain()\">{{ 'action.cancel' | translate }}</button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n\r\n  <!-- FOOTER ACTIONS FOR MAIN VIEW ONLY -->\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\"\r\n       *ngIf=\"view !== 'activate' && view !== 'licenseStatus' && view !== 'cancelSubscription' && view !== 'buy'\">\r\n    <button mat-button color=\"primary\" type=\"button\" [disabled]=\"(isLoading$ | async)\" (click)=\"cancel()\" cdkFocusInitial>\r\n      {{ 'action.close' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n\n.subscription-table {\n    width: 100%;\n    border-collapse: collapse;\n    margin: 20px 0;\n    font-size: 16px;\n    text-align: left;\n}\n.subscription-table th, .subscription-table td {\n    border: 1px solid #ddd;\n    padding: 8px;\n}\n.subscription-table th {\n    background-color: #f2f2f2;\n    font-weight: bold;\n}\n.status-label {\n    padding: 5px 10px;\n    border-radius: 15px;\n    color: #fff;\n    font-weight: bold;\n    display: inline-block;\n}\n.status-active {\n    background-color: #4caf50; /* Green for active */\n}\n.status-open-payment {\n    background-color: #ffeb3b; /* Yellow for open payment */\n}\n.status-canceled {\n    background-color: #f44336; /* Red for canceled */\n}\n.status-inactive {\n    background-color: #f44336; /* Red for canceled */\n}\n.status-cancelled-trial {\n    background-color: #ff9800; /* Orange for cancelled at trial end */\n}",
                "customFunction": "// --------------------------------------------------\r\n// JS CODE - ADAPTED FOR REST FETCH CALLS WITH OPEN PAYMENTS\r\n// NEXT BILLING FIELD IS EMPTY IF nextPaymentDate = 0\r\n// --------------------------------------------------\r\n\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet PageLink = widgetContext.pageLink;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet assetProfileService = $injector.get(widgetContext.servicesMap.get('assetProfileService'));\r\n\r\n// Tenant and entity references\r\nlet tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\r\nlet doctorkitId = entityId;\r\nvar customer;\r\nif (widgetContext.currentUser.authority !== 'CUSTOMER_USER') {\r\n  customer = widgetContext.stateController.getStateParams().entityId;\r\n} else {\r\n  customer = { entityType: \"CUSTOMER\", id: widgetContext.currentUser.customerId };\r\n}\r\n\r\n// Stripe / Payment\r\nlet stripeSecretKey;\r\nlet sessionId = '';\r\nlet customerId;\r\nlet customerStripeId;\r\nlet subscriptionId;\r\n\r\n// Deadlines\r\nlet cancelDeadline;\r\nlet paymentDeadline;\r\n\r\n// Product-related\r\nlet products = [];\r\nlet filteredProducts = [];\r\nlet selectedProductId = '';\r\nlet selectedLicenseType = '';\r\n\r\n// Subscription details variables for License Status view\r\nlet subscriptionStartDate = 0;\r\nlet subscriptionPrice = '';\r\nlet billingCycle = '';\r\nlet nextPaymentDate = 0;       // If this is 0, the HTML shows an empty string\r\nlet subscriptionEndDate = 0;\r\nlet subscriptionStatus = '';   // active, pending, inactive, canceled, or \"no subscription\"\r\nlet lastInvoiceStatus = '';\r\nlet nextPaymentAttempt = null;\r\nlet unpaidInvoiceToPay = null;\r\nlet hostedInvoiceUrl = '';\r\nlet validTill = 0;\r\nlet pendingValidTill = 0;\r\n\r\n// Dialog view management and flags\r\nlet view = 'main';\r\nlet deviceFound = false;\r\nlet subscriptionActive = false;\r\nlet subscriptionExists = false;\r\nlet kitBought = false;\r\nlet kitName = '';\r\nlet kitType = '';\r\nlet buyInvoice = false;\r\nlet buyCard = false;\r\nlet assignedDevices = [];\r\nlet loraRoomSensorsCount = 0;\r\nlet currentUrl = window.location.href;\r\nlet bearerToken = '';\r\n\r\n// Query for \"Product\" assets\r\nlet query = {\r\n  \"parameters\": {\r\n    \"rootId\": customer.id,\r\n    \"rootType\": \"CUSTOMER\",\r\n    \"direction\": \"FROM\",\r\n    \"relationTypeGroup\": \"COMMON\",\r\n    \"maxLevel\": 1073741824,\r\n    \"fetchLastLevelOnly\": true\r\n  },\r\n  \"relationType\": \"Contains\",\r\n  \"assetTypes\": [\"Product\"]\r\n};\r\n\r\nlet cancelMessage = '';\r\n\r\n// ---------------------------------------------------\r\n// NEW FUNCTION: Calculate Cancellation Information\r\n// ---------------------------------------------------\r\nasync function calculateCancellationInfo() {\r\n  if (!stripeSecretKey || !subscriptionId) {\r\n    throw new Error('Missing required information to check cancellation details.');\r\n  }\r\n  try {\r\n    const response = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error fetching subscription: ${response.statusText}`);\r\n    }\r\n    const subscription = await response.json();\r\n    const currentPeriodEnd = subscription.current_period_end;\r\n    const currentPeriodStart = subscription.current_period_start;\r\n    const currentTime = Math.floor(Date.now() / 1000);\r\n    const cycleLength = currentPeriodEnd - currentPeriodStart;\r\n    const cancellationDeadlineSeconds = cancelDeadline * 24 * 60 * 60;\r\n    const bufferSeconds = 10;\r\n    let cancelAtTimestamp, infoMessage;\r\n    \r\n    if ((currentPeriodEnd - currentTime) <= cancellationDeadlineSeconds) {\r\n      // Inside cancellation deadline: renew one more cycle before canceling.\r\n      cancelAtTimestamp = currentPeriodEnd + cycleLength - bufferSeconds;\r\n      infoMessage = `You are within the cancellation deadline. Your subscription will renew for one more cycle and cancel at the end of the next cycle on ${new Date(cancelAtTimestamp * 1000).toLocaleDateString()}.`;\r\n    } else {\r\n      // Outside the deadline: cancel at the end of the current cycle.\r\n      cancelAtTimestamp = currentPeriodEnd - bufferSeconds;\r\n      infoMessage = `You are outside the cancellation deadline. Your subscription will cancel at the end of the current cycle on ${new Date(cancelAtTimestamp * 1000).toLocaleDateString()}.`;\r\n    }\r\n    \r\n    return infoMessage;\r\n  } catch (error) {\r\n    console.error(\"Error in calculateCancellationInfo:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------\r\n// INITIAL LOGIC - always open the dialog\r\n// ---------------------------------------------------\r\nassetService.getAssetInfo(doctorkitId.id).subscribe(info => {\r\n  kitName = info.name;\r\n  customerId = info.customerId;\r\n  attributeService.getEntityAttributes(customer, \"SERVER_SCOPE\", ['stripeKey','cancelDeadline','paymentDeadline']).subscribe(attribute => {\r\n    // Read stripe secret key\r\n    stripeSecretKey = attribute[0].value;\r\n    // Read cancelDeadline (in days) - default to 90 if not set\r\n    const cancelDeadlineObj = attribute.find(item => item.key === \"cancelDeadline\");\r\n    cancelDeadline = cancelDeadlineObj ? cancelDeadlineObj.value : 90;\r\n    // Read paymentDeadline (in days) - default to 14 if not set\r\n    const paymentDeadlineObj = attribute.find(item => item.key === \"paymentDeadline\");\r\n    paymentDeadline = paymentDeadlineObj ? paymentDeadlineObj.value : 14;\r\n    \r\n    // Fetch additional attributes\r\n    attributeService.getEntityAttributes(doctorkitId, \"SERVER_SCOPE\", ['subscriptionId', 'subscriptionStatus', 'validTo', 'kitType', 'activated', 'boughtKitStatus']).subscribe(attributes => {\r\n      let subscriptionAttr = attributes.find(a => a.key === 'subscriptionId');\r\n      subscriptionId = subscriptionAttr?.value || null;\r\n      \r\n      let subStatusAttr = attributes.find(a => a.key === 'subscriptionStatus');\r\n      subscriptionStatus = subStatusAttr ? subStatusAttr.value : \"no subscription\";\r\n      \r\n      let validToAttr = attributes.find(a => a.key === 'validTo');\r\n      validTill = validToAttr ? Number(validToAttr.value) : 0;\r\n      \r\n      let kitTypeAttr = attributes.find(a => a.key === 'kitType');\r\n      kitType = kitTypeAttr?.value || null;\r\n      let activatedAttr = attributes.find(a => a.key === 'activated');\r\n      let kitActivated = activatedAttr ? (activatedAttr.value === true || activatedAttr.value === 'true') : false;\r\n      let kitBoughtAttr = attributes.find(a => a.key === 'boughtKitStatus');\r\n      kitBought = kitBoughtAttr ? (kitBoughtAttr.value === true || kitBoughtAttr.value === 'true') : false;\r\n      subscriptionExists = !!subscriptionId;\r\n      let isBasisKit = (kitType === 'basis');\r\n      if (subscriptionId) {\r\n        checkSubscriptionStatus(subscriptionId)\r\n          .then(subscriptionData => {\r\n            if (subscriptionData && subscriptionData.status === 'active') {\r\n              subscriptionActive = true;\r\n            }\r\n            fetchCustomerStripeId(() => fetchAssignedAssetsAndDevices(doctorkitId.id, kitActivated, isBasisKit));\r\n          })\r\n          .catch(error => {\r\n            console.error(\"Error fetching subscription status:\", error);\r\n            fetchCustomerStripeId(() => fetchAssignedAssetsAndDevices(doctorkitId.id, kitActivated, isBasisKit));\r\n          });\r\n      } else {\r\n        fetchCustomerStripeId(() => fetchAssignedAssetsAndDevices(doctorkitId.id, kitActivated, isBasisKit));\r\n      }\r\n    });\r\n  });\r\n});\r\n\r\nfunction fetchCustomerStripeId(callback) {\r\n  attributeService.getEntityAttributes(customerId, \"SERVER_SCOPE\", ['stripe_id']).subscribe(stripeId => {\r\n    customerStripeId = stripeId?.[0]?.value || null;\r\n    callback();\r\n  });\r\n}\r\n\r\n// ---------------------------------------------------\r\n// FETCH ASSIGNED DEVICES\r\n// ---------------------------------------------------\r\nfunction fetchAssignedAssetsAndDevices(doktorkitId, kitActivated, isBasisKit) {\r\n  const deviceSearchQuery = {\r\n    parameters: {\r\n      rootId: doktorkitId,\r\n      rootType: \"ASSET\",\r\n      direction: \"FROM\",\r\n      relationTypeGroup: \"COMMON\",\r\n      maxLevel: 100,\r\n      fetchLastLevelOnly: false\r\n    },\r\n    relationType: \"Contains\",\r\n    deviceTypes: [\"P-Flow D116\", \"Temperature Sensor\", \"Room Sensor T\", \"Room Sensor CO2\"]\r\n  };\r\n  deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n    (deviceList) => {\r\n      deviceFound = !!(deviceList && deviceList.length > 0);\r\n      assignedDevices = deviceList || [];\r\n      loraRoomSensorsCount = 0;\r\n      assignedDevices.forEach(dev => {\r\n        if (dev.type === \"Room Sensor T\" || dev.type === \"Room Sensor CO2\") {\r\n          loraRoomSensorsCount++;\r\n        }\r\n      });\r\n      fetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          \"username\": \"belimo.api@pke-iot.expert\",\r\n          \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n        })\r\n      })\r\n      .then(resp => resp.json())\r\n      .then(loginData => {\r\n        bearerToken = loginData.token;\r\n        fetchProductsAndOpenDialog(kitActivated, isBasisKit);\r\n      })\r\n      .catch(err => {\r\n        console.error(\"Error fetching bearer token for product queries:\", err);\r\n        openAddEntityDialog(kitActivated, isBasisKit);\r\n      });\r\n    },\r\n    (error) => {\r\n      console.error(\"Error fetching assigned devices:\", error);\r\n      fetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          \"username\": \"belimo.api@pke-iot.expert\",\r\n          \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n        })\r\n      })\r\n      .then(resp => resp.json())\r\n      .then(loginData => {\r\n        bearerToken = loginData.token;\r\n        fetchProductsAndOpenDialog(kitActivated, isBasisKit);\r\n      })\r\n      .catch(err2 => {\r\n        console.error(\"Error fetching bearer token:\", err2);\r\n        openAddEntityDialog(kitActivated, isBasisKit);\r\n      });\r\n    }\r\n  );\r\n}\r\n\r\n// ---------------------------------------------------\r\n// FETCH PRODUCTS (via REST) AND THEN OPEN DIALOG\r\n// ---------------------------------------------------\r\nfunction fetchProductsAndOpenDialog(kitActivated, isBasisKit) {\r\n  fetch('https://cloud.pke-iot.expert/api/assets', {\r\n    method: 'POST',\r\n    headers: {\r\n      'accept': 'application/json',\r\n      'Content-Type': 'application/json',\r\n      'X-Authorization': 'Bearer ' + bearerToken\r\n    },\r\n    body: JSON.stringify(query)\r\n  })\r\n  .then(resp => resp.json())\r\n  .then(assetList => {\r\n    let fetches = assetList.map(asset => {\r\n      return new Promise((resolve) => {\r\n        fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${asset.id.id}/values/attributes?keys=prodType`, {\r\n          method: 'GET',\r\n          headers: {\r\n            'accept': 'application/json',\r\n            'X-Authorization': 'Bearer ' + bearerToken\r\n          }\r\n        })\r\n        .then(resp2 => resp2.json())\r\n        .then(prodTypeAttr => {\r\n          asset.prodType = (prodTypeAttr && prodTypeAttr.length > 0 && prodTypeAttr[0].key === 'prodType') ? prodTypeAttr[0].value : null;\r\n          products.push(asset);\r\n          resolve();\r\n        })\r\n        .catch(err => {\r\n          console.error(\"Error fetching prodType for asset:\", asset.id.id, err);\r\n          resolve();\r\n        });\r\n      });\r\n    });\r\n    Promise.all(fetches).then(() => {\r\n      openAddEntityDialog(kitActivated, isBasisKit);\r\n    });\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching product assets:\", error);\r\n    openAddEntityDialog(kitActivated, isBasisKit);\r\n  });\r\n}\r\n\r\nasync function checkSubscriptionStatus(subscriptionId) {\r\n  try {\r\n    const response = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error fetching subscription details: ${response.statusText}`);\r\n    }\r\n    return await response.json();\r\n  } catch (error) {\r\n    console.error('Error fetching subscription:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------\r\n// CANCEL SUBSCRIPTION LOGIC\r\n// ---------------------------------------------------\r\nasync function cancelSubscriptionWithCalculatedDate() {\r\n  if (!stripeSecretKey || !subscriptionId) {\r\n    console.error('Missing required information to cancel subscription.');\r\n    return;\r\n  }\r\n  try {\r\n    const response = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error fetching subscription: ${response.statusText}`);\r\n    }\r\n    const subscription = await response.json();\r\n    const currentPeriodEnd = subscription.current_period_end;\r\n    const currentPeriodStart = subscription.current_period_start;\r\n    const currentTime = Math.floor(Date.now() / 1000);\r\n    const cycleLength = currentPeriodEnd - currentPeriodStart;\r\n    const cancellationDeadlineSeconds = cancelDeadline * 24 * 60 * 60;\r\n    const bufferSeconds = 10;\r\n    let cancelAtTimestamp, cancelInfo;\r\n    \r\n    if ((currentPeriodEnd - currentTime) <= cancellationDeadlineSeconds) {\r\n      cancelAtTimestamp = currentPeriodEnd + cycleLength - bufferSeconds;\r\n      cancelInfo = `Your subscription will renew for one more cycle and cancel at the end of the next cycle on ${new Date(cancelAtTimestamp * 1000).toLocaleDateString()}.`;\r\n    } else {\r\n      cancelAtTimestamp = currentPeriodEnd - bufferSeconds;\r\n      cancelInfo = `Your subscription will cancel at the end of the current cycle on ${new Date(cancelAtTimestamp * 1000).toLocaleDateString()}.`;\r\n    }\r\n    \r\n    const updateResponse = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: new URLSearchParams({ 'cancel_at': cancelAtTimestamp.toString() })\r\n    });\r\n    if (!updateResponse.ok) {\r\n      throw new Error(`Error updating subscription cancellation: ${updateResponse.statusText}`);\r\n    }\r\n    await updateResponse.json();\r\n    return cancelInfo;\r\n  } catch (error) {\r\n    console.error(\"Error in cancelSubscriptionWithCalculatedDate:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------\r\n// LICENSE STATUS LOGIC\r\n// ---------------------------------------------------\r\nasync function handleSubscriptionDetails(subscriptionId) {\r\n  try {\r\n    const subscriptionResponse = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}`, 'Content-Type': 'application/json' }\r\n    });\r\n    const subscription = await subscriptionResponse.json();\r\n    // Save dates as Unix timestamps (in ms)\r\n    subscriptionStartDate = subscription.start_date * 1000;\r\n    nextPaymentDate = subscription.current_period_end * 1000;\r\n    subscriptionPrice = (subscription.plan.amount / 100).toFixed(2) + ' ' + subscription.plan.currency.toUpperCase();\r\n    billingCycle = subscription.plan.interval;\r\n    \r\n    let tempValidTill = nextPaymentDate;\r\n    if (subscription.cancel_at) {\r\n      if (subscription.status === 'canceled') {\r\n        subscriptionEndDate = subscription.canceled_at * 1000;\r\n        subscriptionStatus = 'canceled';\r\n        tempValidTill = 0;\r\n      } else {\r\n        subscriptionEndDate = subscription.cancel_at * 1000;\r\n        subscriptionStatus = 'canceled';\r\n        tempValidTill = subscriptionEndDate;\r\n      }\r\n    } else if (subscription.status === 'canceled') {\r\n      subscriptionEndDate = subscription.canceled_at * 1000;\r\n      subscriptionStatus = 'canceled';\r\n      tempValidTill = 0;\r\n    } else if (subscription.status === 'active') {\r\n      subscriptionStatus = 'active';\r\n      tempValidTill = nextPaymentDate;\r\n    }\r\n    validTill = tempValidTill;\r\n    if (subscriptionStatus === 'canceled' && validTill === nextPaymentDate) {\r\n      // We consider it canceled and remove the next payment date\r\n      nextPaymentDate = 0;\r\n    }\r\n  } catch (error) {\r\n    console.error('Error fetching subscription details:', error);\r\n  }\r\n}\r\n\r\nasync function handleUnpaidInvoices(subscriptionId, customerStripeId) {\r\n  try {\r\n    const invoiceResponse = await fetch(`https://api.stripe.com/v1/invoices?subscription=${subscriptionId}&limit=100`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}`, 'Content-Type': 'application/json' }\r\n    });\r\n    const invoices = await invoiceResponse.json();\r\n    if (invoices.data.length === 0) {\r\n      lastInvoiceStatus = 'paid';\r\n      return;\r\n    }\r\n    const unpaidInvoices = invoices.data.filter(invoice => invoice.status === 'open');\r\n    let currentTime = Math.floor(Date.now() / 1000);\r\n    if (unpaidInvoices.length > 0) {\r\n      let inv = unpaidInvoices[0];\r\n      hostedInvoiceUrl = inv.hosted_invoice_url || '';\r\n      let invoiceCreated = inv.created;\r\n      let deadline = invoiceCreated + (paymentDeadline * 24 * 60 * 60);\r\n      pendingValidTill = deadline * 1000;\r\n      lastInvoiceStatus = currentTime > deadline ? 'inactive' : 'pending';\r\n    } else {\r\n      lastInvoiceStatus = 'paid';\r\n    }\r\n  } catch (error) {\r\n    console.error('Error handling unpaid invoices:', error);\r\n  }\r\n}\r\n\r\nfunction determineSubscriptionStatus() {\r\n  if (subscriptionStatus === 'canceled') {\r\n    return;\r\n  } else if (lastInvoiceStatus === 'inactive') {\r\n    subscriptionStatus = 'inactive';\r\n    validTill = 0;\r\n  } else if (lastInvoiceStatus === 'pending') {\r\n    subscriptionStatus = 'pending';\r\n    validTill = pendingValidTill;\r\n  } else if (lastInvoiceStatus === 'paid' || lastInvoiceStatus === 'draft') {\r\n    subscriptionStatus = 'active';\r\n    validTill = nextPaymentDate;\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------\r\n// Save Subscription Attributes to Doctorkit\r\n// ---------------------------------------------------\r\nfunction saveSubscriptionAttributes() {\r\n  let attrsToSave = [\r\n    { key: \"subscriptionStartDate\", value: subscriptionStartDate },\r\n    { key: \"subscriptionPrice\", value: subscriptionPrice },\r\n    { key: \"billingCycle\", value: billingCycle },\r\n    { key: \"nextPaymentDate\", value: nextPaymentDate },\r\n    { key: \"validTo\", value: validTill },\r\n    { key: \"subscriptionStatus\", value: subscriptionStatus }\r\n  ];\r\n  attributeService.saveEntityAttributes(doctorkitId, \"SERVER_SCOPE\", attrsToSave).subscribe(\r\n    () => { console.log(\"Subscription attributes saved successfully.\"); },\r\n    error => { console.error(\"Error saving subscription attributes:\", error); }\r\n  );\r\n}\r\n\r\n// ---------------------------------------------------\r\n// OPEN DIALOG\r\n// ---------------------------------------------------\r\nfunction openAddEntityDialog(kitActivated, isBasisKit) {\r\n  customDialog.customDialog(htmlTemplate, (instance) => AddEntityDialogController(instance, kitActivated, isBasisKit)).subscribe();\r\n}\r\n\r\nfunction AddEntityDialogController(instance, kitActivated, isBasisKit) {\r\n  let vm = instance;\r\n  vm.view = view;\r\n  vm.deviceFound = deviceFound;\r\n  vm.subscriptionActive = subscriptionActive;\r\n  vm.subscriptionExists = subscriptionExists;\r\n  vm.kitName = kitName;\r\n  vm.kitType = kitType;\r\n  vm.kitActivated = kitActivated;\r\n  vm.isBasisKit = isBasisKit;\r\n  vm.kitBought = kitBought;\r\n  \r\n  vm.isInvoice = false;\r\n  vm.isCard = false;\r\n  vm.buyInvoice = buyInvoice;\r\n  vm.buyCard = buyCard;\r\n  vm.addEntityFormGroup = vm.fb.group({});\r\n  \r\n  // Determine if Activate License button should be enabled:\r\n  vm.canActivateLicense = (subscriptionStatus === 'no subscription' || (subscriptionStatus === 'canceled' && validTill < Date.now()));\r\n  \r\n  if (subscriptionId && customerStripeId) {\r\n    handleSubscriptionDetails(subscriptionId).then(() => {\r\n      vm.cancelDisabled = (subscriptionStatus === 'pending' || subscriptionStatus === 'inactive' || subscriptionStatus === 'canceled');\r\n    }).catch(() => {\r\n      vm.cancelDisabled = false;\r\n    });\r\n  } else {\r\n    vm.cancelDisabled = true;\r\n  }\r\n  \r\n  vm.buyDiagnostickit = function () {\r\n    filterBuyProducts();\r\n    if (!filteredProducts.length) {\r\n      alert(\"No product found for kitType = \" + vm.kitType);\r\n    } else {\r\n      vm.view = 'buy';\r\n    }\r\n  };\r\n  \r\n  vm.activateLicense = function () {\r\n    vm.view = 'activate';\r\n    filterSubscriptionProducts();\r\n    if (filteredProducts.length > 0) {\r\n      selectedProductId = filteredProducts[0].id.id;\r\n    } else {\r\n      alert(vm.kitType === 'loraWan' ? \"No product with prodType = 'loraSimLicense' found!\" : \"No product with prodType = 'datalicense' found!\");\r\n    }\r\n  };\r\n  \r\n  vm.licenseStatus = function () {\r\n    vm.view = 'licenseStatus';\r\n    if (subscriptionId && customerStripeId) {\r\n      handleSubscriptionDetails(subscriptionId).then(() => {\r\n        handleUnpaidInvoices(subscriptionId, customerStripeId).then(() => {\r\n          determineSubscriptionStatus();\r\n          vm.cancelDisabled = (subscriptionStatus === 'pending' || subscriptionStatus === 'inactive' || subscriptionStatus === 'canceled');\r\n          vm.subscriptionStartDate = subscriptionStartDate;\r\n          vm.subscriptionPrice = subscriptionPrice;\r\n          vm.billingCycle = billingCycle;\r\n          vm.nextPaymentDate = nextPaymentDate;\r\n          vm.nextPaymentAttempt = nextPaymentAttempt;\r\n          vm.subscriptionStatus = subscriptionStatus;\r\n          vm.validTill = validTill;\r\n          saveSubscriptionAttributes();\r\n        });\r\n      });\r\n    } else {\r\n      alert(\"There is no completed subscription for this Doctorkit.\");\r\n    }\r\n  };\r\n  \r\n  // Show cancellation info before confirmation\r\n  vm.cancelLicense = function () {\r\n    if (vm.cancelDisabled) {\r\n      alert(\"Your subscription is already scheduled for cancellation or has been cancelled.\");\r\n      return;\r\n    }\r\n    vm.view = 'cancelSubscription';\r\n    calculateCancellationInfo()\r\n      .then(info => {\r\n        vm.cancelMessage = `Are you sure you want to cancel the subscription for \"${vm.kitName}\"?\\n\\n${info}`;\r\n      })\r\n      .catch(err => {\r\n        vm.cancelMessage = `Are you sure you want to cancel the subscription for \"${vm.kitName}\"? (Error determining cancellation details)`;\r\n      });\r\n  };\r\n  \r\n  // Actually cancel after confirmation\r\n  vm.confirmCancelSubscription = function () {\r\n    cancelSubscriptionWithCalculatedDate()\r\n      .then(info => {\r\n        alert(info);\r\n        vm.dialogRef.close(null);\r\n      })\r\n      .catch(err => {\r\n        alert(\"Error processing cancellation. Please try again.\");\r\n        vm.dialogRef.close(null);\r\n      });\r\n  };\r\n  \r\n  vm.backToMain = function () {\r\n    vm.view = 'main';\r\n  };\r\n  \r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.onSelectInvoice = function (event) {\r\n    vm.isInvoice = event.checked;\r\n    if (vm.isInvoice) { vm.isCard = false; }\r\n  };\r\n  vm.onSelectCard = function (event) {\r\n    vm.isCard = event.checked;\r\n    if (vm.isCard) { vm.isInvoice = false; }\r\n  };\r\n  vm.onSelectBuyInvoice = function (event) {\r\n    vm.buyInvoice = event.checked;\r\n    if (vm.buyInvoice) { vm.buyCard = false; }\r\n  };\r\n  vm.onSelectBuyCard = function (event) {\r\n    vm.buyCard = event.checked;\r\n    if (vm.buyCard) { vm.buyInvoice = false; }\r\n  };\r\n  \r\n  function filterSubscriptionProducts() {\r\n    filteredProducts = vm.kitType === 'loraWan' \r\n      ? products.filter(p => p.prodType === 'loraSimLicense')\r\n      : products.filter(p => p.prodType === 'datalicense');\r\n  }\r\n  \r\n  function filterBuyProducts() {\r\n    if (!vm.kitType) return;\r\n    let desiredProdType = vm.kitType === 'basis' ? 'basisKit'\r\n                        : vm.kitType === 'extension' ? 'extensionKit'\r\n                        : vm.kitType === 'loraWan' ? 'loraWanKit'\r\n                        : '';\r\n    filteredProducts = products.filter(p => p.prodType === desiredProdType);\r\n  }\r\n  \r\n  vm.checkout = function () {\r\n    vm.addEntityFormGroup.markAsPristine();\r\n    if (vm.view === 'activate') {\r\n      if (!vm.isInvoice && !vm.isCard) {\r\n        alert(\"Please select a payment method first.\");\r\n        return;\r\n      }\r\n      if (!filteredProducts.length) {\r\n        alert(\"No available product found to proceed!\");\r\n        return;\r\n      }\r\n      let selectedProduct = filteredProducts[0];\r\n      if (!selectedProduct) {\r\n        alert(\"No product found to activate.\");\r\n        return;\r\n      }\r\n      selectedProductId = selectedProduct.id.id;\r\n      selectedLicenseType = /base/i.test(selectedProduct.name) ? 'Base'\r\n                         : /pro/i.test(selectedProduct.name) ? 'Pro'\r\n                         : 'Unknown';\r\n      fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${selectedProductId}/values/attributes?keys=price_stripe_id`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'accept': 'application/json',\r\n          'X-Authorization': 'Bearer ' + bearerToken\r\n        }\r\n      })\r\n      .then(resp => resp.json())\r\n      .then(attrData => {\r\n        let priceAttr = attrData.find(a => a.key === 'price_stripe_id');\r\n        if (priceAttr) {\r\n          const priceId = priceAttr.value;\r\n          if (vm.isInvoice) {\r\n            createSubscriptionInvoiceMethod(priceId, vm);\r\n          } else if (vm.isCard) {\r\n            createCheckoutSession(priceId, vm);\r\n          }\r\n        } else {\r\n          console.error('Price ID not found for the selected product.');\r\n          alert(\"Unable to proceed. The selected product has no price_stripe_id.\");\r\n        }\r\n      })\r\n      .catch(err => {\r\n        console.error(\"Error fetching subscription price_stripe_id:\", err);\r\n        alert(\"Unable to fetch the product price. Please try again.\");\r\n      });\r\n    } else if (vm.view === 'buy') {\r\n      if (!vm.buyInvoice && !vm.buyCard) {\r\n        alert(\"Please select a payment method first.\");\r\n        return;\r\n      }\r\n      if (!filteredProducts.length) {\r\n        alert(\"No available product found to proceed!\");\r\n        return;\r\n      }\r\n      let selectedProduct = filteredProducts[0];\r\n      if (!selectedProduct) {\r\n        alert(\"No product found for your kit type.\");\r\n        return;\r\n      }\r\n      selectedProductId = selectedProduct.id.id;\r\n      selectedLicenseType = /basisKit/i.test(selectedProduct.name) ? 'basisKit'\r\n                         : /extensionKit/i.test(selectedProduct.name) ? 'extensionKit'\r\n                         : /loraWanKit/i.test(selectedProduct.name) ? 'loraWanKit'\r\n                         : 'unknownKitType';\r\n      fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${selectedProductId}/values/attributes?keys=price_stripe_id`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'accept': 'application/json',\r\n          'X-Authorization': 'Bearer ' + bearerToken\r\n        }\r\n      })\r\n      .then(resp => resp.json())\r\n      .then(async (attrData) => {\r\n        let priceAttr = attrData.find(a => a.key === 'price_stripe_id');\r\n        if (!priceAttr) {\r\n          console.error('Price ID not found for the selected product.');\r\n          alert(\"Unable to proceed. The selected kit has no price_stripe_id.\");\r\n          return;\r\n        }\r\n        const kitPriceId = priceAttr.value;\r\n        let sensorCount = vm.kitType === 'loraWan' ? loraRoomSensorsCount : 0;\r\n        let co2SensorProduct = products.find(p => p.prodType === 'co2RoomSensor');\r\n        if (vm.buyInvoice) {\r\n          await createOneTimeInvoiceWithSensors(kitPriceId, co2SensorProduct, sensorCount, vm);\r\n        } else if (vm.buyCard) {\r\n          await createOneTimeCheckoutSessionWithSensors(kitPriceId, co2SensorProduct, sensorCount, vm);\r\n        }\r\n      })\r\n      .catch(err => {\r\n        console.error('Error fetching kit price_stripe_id:', err);\r\n        alert(\"Failed to fetch kit price. Please try again.\");\r\n      });\r\n    }\r\n  };\r\n  \r\n  vm.initiatePayment = function() {\r\n    if (hostedInvoiceUrl) {\r\n      window.location.href = hostedInvoiceUrl;\r\n    } else {\r\n      alert(\"No open invoice available for payment.\");\r\n    }\r\n  };\r\n}\r\n\r\n// ---------------------------------------------------\r\n// STRIPE PAYMENT METHODS (SUBSCRIPTION)\r\n// ---------------------------------------------------\r\nasync function createCheckoutSession(priceId, instance) {\r\n  try {\r\n    const priceResponse = await fetch(`https://api.stripe.com/v1/prices/${priceId}?expand[]=product`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!priceResponse.ok) {\r\n      throw new Error(`Error fetching price details: ${priceResponse.statusText}`);\r\n    }\r\n    const priceData = await priceResponse.json();\r\n    const isRecurring = !!priceData.recurring;\r\n    const mode = isRecurring ? 'subscription' : 'payment';\r\n    const successUrl = currentUrl;\r\n    const cancelUrl = currentUrl;\r\n    const bodyParams = new URLSearchParams({\r\n      'success_url': successUrl,\r\n      'cancel_url': cancelUrl,\r\n      'payment_method_types[]': 'card',\r\n      'line_items[0][price]': priceId,\r\n      'line_items[0][quantity]': '1',\r\n      'mode': mode,\r\n      'customer': customerStripeId\r\n    });\r\n    const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: bodyParams\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error creating checkout session: ${response.statusText}`);\r\n    }\r\n    const data = await response.json();\r\n    if (data.id) {\r\n      const preAttrs = [\r\n        { key: \"sessionIdLicense\", value: data.id }\r\n      ];\r\n      await new Promise((resolve, reject) => {\r\n        attributeService.saveEntityAttributes(doctorkitId, \"SERVER_SCOPE\", preAttrs).subscribe(\r\n          () => resolve(),\r\n          (error) => {\r\n            console.error(\"Error saving sessionId:\", error);\r\n            reject(error);\r\n          }\r\n        );\r\n      });\r\n    }\r\n    if (data.url) {\r\n      window.location.href = data.url;\r\n    } else {\r\n      console.error('Checkout session URL not found in response');\r\n      alert(\"No checkout URL found. Unable to proceed to payment.\");\r\n    }\r\n  } catch (error) {\r\n    console.error('Error creating checkout session:', error);\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\nasync function createSubscriptionInvoiceMethod(priceId, instance) {\r\n  try {\r\n    let subParams = new URLSearchParams({\r\n      customer: customerStripeId,\r\n      'items[0][price]': priceId,\r\n      'items[0][quantity]': '1',\r\n      collection_method: 'send_invoice',\r\n      days_until_due: paymentDeadline.toString(),\r\n      'expand[]': 'latest_invoice'\r\n    });\r\n    const subResp = await fetch('https://api.stripe.com/v1/subscriptions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: subParams\r\n    });\r\n    if (!subResp.ok) {\r\n      throw new Error(`Error creating subscription with invoice: ${subResp.statusText}`);\r\n    }\r\n    const subscriptionData = await subResp.json();\r\n    let latestInvoice = subscriptionData.latest_invoice;\r\n    if (latestInvoice && latestInvoice.id) {\r\n      const finalizeResp = await fetch(`https://api.stripe.com/v1/invoices/${latestInvoice.id}/finalize?auto_advance=true`, {\r\n        method: 'POST',\r\n        headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n      });\r\n      if (!finalizeResp.ok) {\r\n        throw new Error(`Error finalizing invoice: ${finalizeResp.statusText}`);\r\n      }\r\n      await finalizeResp.json();\r\n    }\r\n    const attrs = [\r\n      { key: \"licenseActivationStatus\", value: false },\r\n      { key: \"subscriptionId\", value: subscriptionData.id }\r\n    ];\r\n    attributeService.saveEntityAttributes(doctorkitId, \"SERVER_SCOPE\", attrs).subscribe(\r\n      () => {\r\n        alert(\"Subscription created via invoice. Invoice sent immediately!\");\r\n        instance.dialogRef.close(null);\r\n      },\r\n      (error) => {\r\n        console.error('Error saving invoice attributes:', error);\r\n        instance.dialogRef.close(null);\r\n      }\r\n    );\r\n  } catch (error) {\r\n    console.error(\"Error in createSubscriptionInvoiceMethod:\", error);\r\n    alert(\"Invoice creation failed. Please try again.\");\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------\r\n// ONE-TIME PURCHASE METHODS\r\n// ---------------------------------------------------\r\nasync function createOneTimeCheckoutSessionWithSensors(kitPriceId, co2SensorProduct, sensorCount, instance) {\r\n  try {\r\n    let lineItemCount = 0;\r\n    const bodyParams = new URLSearchParams();\r\n    bodyParams.append('success_url', currentUrl);\r\n    bodyParams.append('cancel_url', currentUrl);\r\n    bodyParams.append('payment_method_types[]', 'card');\r\n    bodyParams.append('mode', 'payment');\r\n    bodyParams.append('customer', customerStripeId);\r\n    bodyParams.append(`line_items[${lineItemCount}][price]`, kitPriceId);\r\n    bodyParams.append(`line_items[${lineItemCount}][quantity]`, '1');\r\n    lineItemCount++;\r\n    if (co2SensorProduct && sensorCount > 0) {\r\n      let sensorPriceAttrResp = await fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${co2SensorProduct.id.id}/values/attributes?keys=price_stripe_id`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'accept': 'application/json',\r\n          'X-Authorization': 'Bearer ' + bearerToken\r\n        }\r\n      });\r\n      let sensorPriceAttrData = await sensorPriceAttrResp.json();\r\n      let sensorAttr = sensorPriceAttrData.find(a => a.key === 'price_stripe_id');\r\n      if (sensorAttr) {\r\n        let sensorPriceId = sensorAttr.value;\r\n        bodyParams.append(`line_items[${lineItemCount}][price]`, sensorPriceId);\r\n        bodyParams.append(`line_items[${lineItemCount}][quantity]`, sensorCount.toString());\r\n        lineItemCount++;\r\n      }\r\n    }\r\n    const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: bodyParams\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error creating one-time checkout session: ${response.statusText}`);\r\n    }\r\n    const data = await response.json();\r\n    if (data.id) {\r\n      const preAttrs = [\r\n        { key: \"sessionIdKitBuy\", value: data.id }\r\n      ];\r\n      await new Promise((resolve, reject) => {\r\n        attributeService.saveEntityAttributes(doctorkitId, \"SERVER_SCOPE\", preAttrs).subscribe(\r\n          () => resolve(),\r\n          (error) => {\r\n            console.error(\"Error saving one-time session attributes:\", error);\r\n            reject(error);\r\n          }\r\n        );\r\n      });\r\n    }\r\n    if (data.url) {\r\n      window.location.href = data.url;\r\n    } else {\r\n      console.error('One-time checkout session URL not found in response');\r\n      alert(\"No checkout URL found. Unable to proceed to payment.\");\r\n    }\r\n  } catch (error) {\r\n    console.error('Error creating one-time checkout session with sensors:', error);\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\nasync function createOneTimeInvoiceWithSensors(kitPriceId, co2SensorProduct, sensorCount, instance) {\r\n  try {\r\n    const kitPriceResp = await fetch(`https://api.stripe.com/v1/prices/${kitPriceId}`, {\r\n      method: 'GET',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!kitPriceResp.ok) {\r\n      throw new Error(`Error fetching kit price details: ${kitPriceResp.statusText}`);\r\n    }\r\n    const kitPriceData = await kitPriceResp.json();\r\n    const kitAmount = kitPriceData.unit_amount;\r\n    const kitCurrency = kitPriceData.currency;\r\n    let invoiceBody = new URLSearchParams({\r\n      customer: customerStripeId,\r\n      auto_advance: 'false',\r\n      collection_method: 'send_invoice',\r\n      days_until_due: paymentDeadline.toString()\r\n    });\r\n    const invoiceResp = await fetch('https://api.stripe.com/v1/invoices', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: invoiceBody\r\n    });\r\n    if (!invoiceResp.ok) {\r\n      throw new Error(`Error creating draft invoice: ${invoiceResp.statusText}`);\r\n    }\r\n    const invoiceData = await invoiceResp.json();\r\n    let kitItemBody = new URLSearchParams({\r\n      customer: customerStripeId,\r\n      invoice: invoiceData.id,\r\n      amount: kitAmount.toString(),\r\n      currency: kitCurrency,\r\n      description: `One-time kit purchase: ${selectedLicenseType}`\r\n    });\r\n    const kitItemResp = await fetch('https://api.stripe.com/v1/invoiceitems', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: kitItemBody\r\n    });\r\n    if (!kitItemResp.ok) {\r\n      throw new Error(`Error creating kit invoice item: ${kitItemResp.statusText}`);\r\n    }\r\n    if (co2SensorProduct && sensorCount > 0) {\r\n      let sensorPriceAttrResp = await fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${co2SensorProduct.id.id}/values/attributes?keys=price_stripe_id`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'accept': 'application/json',\r\n          'X-Authorization': 'Bearer ' + bearerToken\r\n        }\r\n      });\r\n      let sensorPriceAttrData = await sensorPriceAttrResp.json();\r\n      let sensorAttr = sensorPriceAttrData.find(a => a.key === 'price_stripe_id');\r\n      if (sensorAttr) {\r\n        let sensorPriceId = sensorAttr.value;\r\n        const sensorPriceResp = await fetch(`https://api.stripe.com/v1/prices/${sensorPriceId}`, {\r\n          method: 'GET',\r\n          headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n        });\r\n        if (!sensorPriceResp.ok) {\r\n          throw new Error(`Error fetching sensor price details: ${sensorPriceResp.statusText}`);\r\n        }\r\n        const sensorPriceData = await sensorPriceResp.json();\r\n        let sensorAmount = sensorPriceData.unit_amount;\r\n        let sensorCurrency = sensorPriceData.currency;\r\n        let sensorItemBody = new URLSearchParams({\r\n          customer: customerStripeId,\r\n          invoice: invoiceData.id,\r\n          amount: (sensorAmount * sensorCount).toString(),\r\n          currency: sensorCurrency,\r\n          description: `One-time purchase: ${sensorCount} CO2/Room Sensors`\r\n        });\r\n        const sensorItemResp = await fetch('https://api.stripe.com/v1/invoiceitems', {\r\n          method: 'POST',\r\n          headers: {\r\n            'Authorization': `Bearer ${stripeSecretKey}`,\r\n            'Content-Type': 'application/x-www-form-urlencoded'\r\n          },\r\n          body: sensorItemBody\r\n        });\r\n        if (!sensorItemResp.ok) {\r\n          throw new Error(`Error creating sensor invoice item: ${sensorItemResp.statusText}`);\r\n        }\r\n      }\r\n    }\r\n    const finalizeResp = await fetch(`https://api.stripe.com/v1/invoices/${invoiceData.id}/finalize`, {\r\n      method: 'POST',\r\n      headers: { 'Authorization': `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!finalizeResp.ok) {\r\n      throw new Error(`Error finalizing invoice: ${finalizeResp.statusText}`);\r\n    }\r\n    await finalizeResp.json();\r\n    const attributes = [\r\n      { key: \"invoiceIdKitBuy\", value: invoiceData.id }\r\n    ];\r\n    attributeService.saveEntityAttributes(doctorkitId, \"SERVER_SCOPE\", attributes).subscribe(\r\n      () => {\r\n        alert(\"Invoice created and sent for one-time purchase!\");\r\n        instance.dialogRef.close(null);\r\n      },\r\n      (error) => {\r\n        console.error('Error updating one-time invoice attributes:', error);\r\n        instance.dialogRef.close(null);\r\n      }\r\n    );\r\n  } catch (err) {\r\n    console.error(\"Error creating one-time invoice with sensors:\", err);\r\n    alert(\"Failed to create invoice. Please try again.\");\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------\r\n// (Optional) For open payments in detail\r\n// ---------------------------------------------------\r\nfunction manageOpenPayments(instance) {\r\n  let vm = instance;\r\n  vm.lastInvoiceStatus = lastInvoiceStatus;\r\n  vm.nextPaymentDate = nextPaymentDate;\r\n  vm.subscriptionStartDate = subscriptionStartDate;\r\n  vm.subscriptionPrice = subscriptionPrice;\r\n  vm.billingCycle = billingCycle;\r\n  vm.nextPaymentAttempt = nextPaymentAttempt;\r\n  vm.subscriptionStatus = subscriptionStatus;\r\n  vm.subscriptionEndDate = subscriptionEndDate;\r\n  vm.initiatePayment = async function() {\r\n    if (hostedInvoiceUrl) { window.location.href = hostedInvoiceUrl; }\r\n  };\r\n  vm.cancel = function() { vm.dialogRef.close(null); };\r\n  window.addEventListener('focus', checkSessionStatusOnce);\r\n  function checkSessionStatusOnce() {\r\n    if (sessionId) {\r\n      fetch(`https://api.stripe.com/v1/invoices/${sessionId}`, {\r\n        method: 'GET',\r\n        headers: { 'Authorization': `Bearer ${stripeSecretKey}`, 'Content-Type': 'application/json' }\r\n      })\r\n      .then(response => response.json())\r\n      .then(invoice => {\r\n        if (invoice.status === 'paid' || invoice.status === 'open') { vm.dialogRef.close(null); }\r\n      })\r\n      .catch(error => {\r\n        console.error('Error checking invoice status:', error);\r\n        vm.dialogRef.close(null);\r\n      });\r\n    }\r\n    window.removeEventListener('focus', checkSessionStatusOnce);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "51144411-138c-66a2-5449-82564dca8d2f"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.open-payments}",
                "icon": "payments",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false\r\n",
                "type": "customPretty",
                "customHtml": "<form #paymentForm=\"ngForm\" (ngSubmit)=\"initiatePayment()\" class=\"add-entity-form\">\r\n    <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n        <h2>Subscription Status</h2>\r\n        <span fxFlex></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\" style=\"position: absolute; right: 0;\">\r\n            <mat-icon class=\"material-icons\">close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n    <div mat-dialog-content fxLayout=\"column\">\r\n        <table class=\"subscription-table\">\r\n            <thead>\r\n                <tr>\r\n                    <th>Start Date</th>\r\n                    <th>Price</th>\r\n                    <th>Billing Cycle</th>\r\n                    <th>Next Billing</th>\r\n                    <th *ngIf=\"nextPaymentAttempt\">Next Payment Attempt</th>\r\n                    <th *ngIf=\"subscriptionStatus === 'canceled' || subscriptionStatus === 'cancelled_at_trial_end'\">Subscription End</th>\r\n                    <th>Status</th>\r\n                </tr>\r\n            </thead>\r\n            <tbody>\r\n                <tr>\r\n                    <td>{{ subscriptionStartDate }}</td>\r\n                    <td>{{ subscriptionPrice }}</td>\r\n                    <td>{{ billingCycle }}</td>\r\n                    <td>{{ nextPaymentDate }}</td>\r\n                    <td *ngIf=\"nextPaymentAttempt\">{{ nextPaymentAttempt }}</td>\r\n                    <td *ngIf=\"subscriptionStatus === 'canceled' || subscriptionStatus === 'cancelled_at_trial_end'\">{{ subscriptionEndDate }}</td>\r\n                    <td>\r\n                        <span class=\"status-label\" [ngClass]=\"{\r\n                            'status-active': subscriptionStatus === 'active',\r\n                            'status-open-payment': subscriptionStatus === 'open',\r\n                            'status-canceled': subscriptionStatus === 'canceled',\r\n                            'status-cancelled-trial': subscriptionStatus === 'cancelled_at_trial_end'\r\n                        }\">\r\n                            {{ subscriptionStatus }}\r\n                        </span>\r\n                    </td>\r\n                </tr>\r\n            </tbody>\r\n        </table>\r\n    </div>\r\n    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n        <button mat-button color=\"primary\" type=\"button\" [disabled]=\"(isLoading$ | async)\" (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n        </button>\r\n        <button mat-raised-button color=\"primary\" type=\"submit\" *ngIf=\"subscriptionStatus === 'open'\" [disabled]=\"(isLoading$ | async)\">\r\n            Pay\r\n        </button>\r\n    </div>\r\n</form>",
                "customCss": ".edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n\n.subscription-table {\n    width: 100%;\n    border-collapse: collapse;\n    margin: 20px 0;\n    font-size: 16px;\n    text-align: left;\n}\n.subscription-table th, .subscription-table td {\n    border: 1px solid #ddd;\n    padding: 8px;\n}\n.subscription-table th {\n    background-color: #f2f2f2;\n    font-weight: bold;\n}\n.status-label {\n    padding: 5px 10px;\n    border-radius: 15px;\n    color: #fff;\n    font-weight: bold;\n    display: inline-block;\n}\n.status-active {\n    background-color: #4caf50; /* Green for active */\n}\n.status-open-payment {\n    background-color: #ffeb3b; /* Yellow for open payment */\n}\n.status-canceled {\n    background-color: #f44336; /* Red for canceled */\n}\n.status-cancelled-trial {\n    background-color: #ff9800; /* Orange for cancelled at trial end */\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet assetProfileService = $injector.get(widgetContext.servicesMap.get('assetProfileService'));\nlet tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\nlet stripeSecretKey;\nlet sessionId = ''; // Store the session ID globally\nlet doctorkitId = entityId;\nlet customerId;\nlet customerStripeId;\nlet subscriptionId;\nlet lastInvoiceStatus;\nlet hostedInvoiceUrl;\nlet nextPaymentDate;\nlet subscriptionStartDate;\nlet subscriptionPrice;\nlet billingCycle;\nlet nextPaymentAttempt;\nlet subscriptionStatus;\nlet subscriptionEndDate;\nlet unpaidInvoiceToPay;\n\nassetService.getAssetInfo(doctorkitId.id).subscribe(info => {\n    console.log(\"CustomerID\", info.customerId);\n    customerId = info.customerId;\n\n    attributeService.getEntityAttributes({ entityType: 'TENANT', id: tenantId }, \"SERVER_SCOPE\", ['stripeKey']).subscribe(attribute => {\n        console.log(\"Attribute\", attribute);\n        stripeSecretKey = attribute[0].value;\n\n        attributeService.getEntityAttributes(doctorkitId, \"SERVER_SCOPE\", ['subscriptionId']).subscribe(subscription => {\n            console.log(\"subscription\", subscription);\n            subscriptionId = subscription?.[0]?.value || null;\n            console.log(\"subscriptionId\", subscriptionId);\n            attributeService.getEntityAttributes(customerId, \"SERVER_SCOPE\", ['stripe_id']).subscribe(stripeId => {\n                customerStripeId = stripeId?.[0]?.value || null;\n                console.log(\"customerStripeId\", customerStripeId);\n\n                if (subscriptionId && customerStripeId) {\n                    handleSubscriptionDetails(subscriptionId).then(() => {\n                        handleUnpaidInvoices(subscriptionId, customerStripeId).then(() => {\n                            determineSubscriptionStatus();\n                            openAddEntityDialog();\n                        });\n                    });\n                }\n                else {\n                    //toast(\"There is no subscription completed for this Doctorkit\");\n                }\n            });\n        });\n    });\n});\n\nasync function handleSubscriptionDetails(subscriptionId) {\n    try {\n        // Fetch the subscription details from Stripe\n        const subscriptionResponse = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\n            method: 'GET',\n            headers: {\n                'Authorization': `Bearer ${stripeSecretKey}`,\n                'Content-Type': 'application/json'\n            }\n        });\n        const subscription = await subscriptionResponse.json();\n        console.log('Subscription details:', subscription);\n        // Extract next payment date, subscription start date, price, and billing cycle\n        subscriptionStartDate = new Date(subscription.start_date * 1000).toLocaleDateString();\n        nextPaymentDate = new Date(subscription.current_period_end * 1000).toLocaleDateString();\n        subscriptionPrice = (subscription.plan.amount / 100).toFixed(2) + ' ' + subscription.plan.currency.toUpperCase();\n        billingCycle = subscription.plan.interval;\n\n        if (subscription.cancel_at_period_end) {\n            subscriptionEndDate = new Date(subscription.current_period_end * 1000).toLocaleDateString();\n            const currentDate = new Date().setHours(0, 0, 0, 0);\n            const endDate = new Date(subscription.current_period_end).setHours(0, 0, 0, 0);\n\n            if (subscription.status === 'canceled' && endDate < currentDate) {\n                subscriptionStatus = 'canceled';\n            } else {\n                subscriptionStatus = 'cancelled_at_trial_end';\n            }\n        } else if (subscription.status === 'canceled') {\n            subscriptionEndDate = new Date(subscription.canceled_at * 1000).toLocaleDateString();\n            subscriptionStatus = 'canceled';\n        } else if (subscription.status === 'active') {\n            subscriptionStatus = 'active';\n        }\n    } catch (error) {\n        console.error('Error fetching subscription details:', error);\n    }\n}\n\nasync function handleUnpaidInvoices(subscriptionId, customerStripeId) {\n    try {\n        // Retrieve all invoices for the subscription\n        const invoiceResponse = await fetch(`https://api.stripe.com/v1/invoices?subscription=${subscriptionId}&limit=100`, {\n            method: 'GET',\n            headers: {\n                'Authorization': `Bearer ${stripeSecretKey}`,\n                'Content-Type': 'application/json'\n            }\n        });\n\n        const invoices = await invoiceResponse.json();\n\n        if (invoices.data.length === 0) {\n            console.log('No invoices found for the specified subscription.');\n            return;\n        }\n\n        // Check for any invoices with the status \"open\"\n        const unpaidInvoices = invoices.data.filter(invoice => invoice.status === 'open');\n        \n        if (unpaidInvoices.length > 0) {\n            console.log('There are unpaid invoices:', unpaidInvoices);\n            lastInvoiceStatus = 'open';\n            unpaidInvoiceToPay = unpaidInvoices[0];\n            nextPaymentAttempt = unpaidInvoiceToPay.next_payment_attempt\n                ? new Date(unpaidInvoiceToPay.next_payment_attempt * 1000).toLocaleDateString()\n                : null;\n            hostedInvoiceUrl = unpaidInvoiceToPay.hosted_invoice_url;\n        } else {\n            console.log('No unpaid invoices found.');\n            lastInvoiceStatus = 'paid';\n        }\n    } catch (error) {\n        console.error('Error handling unpaid invoices:', error);\n    }\n}\n\nfunction determineSubscriptionStatus() {\n    if (subscriptionStatus === 'cancelled_at_trial_end' || subscriptionStatus === 'canceled') {\n        // Do not override if already canceled or set to cancel at end of trial\n        return;\n    }\n\n    if (lastInvoiceStatus === 'paid' || lastInvoiceStatus === 'draft') {\n        subscriptionStatus = 'active';\n    } else if (lastInvoiceStatus === 'open') {\n        subscriptionStatus = 'open';\n    }\n}\n\nfunction openAddEntityDialog() {\n    customDialog.customDialog(htmlTemplate, (instance) => manageOpenPayments(instance)).subscribe();\n}\n\nfunction manageOpenPayments(instance) {\n    let vm = instance;\n    vm.lastInvoiceStatus = lastInvoiceStatus;\n    vm.nextPaymentDate = nextPaymentDate;\n    vm.subscriptionStartDate = subscriptionStartDate;\n    vm.subscriptionPrice = subscriptionPrice;\n    vm.billingCycle = billingCycle;\n    vm.nextPaymentAttempt = nextPaymentAttempt;\n    vm.subscriptionStatus = subscriptionStatus;\n    vm.subscriptionEndDate = subscriptionEndDate;\n    vm.initiatePayment = async function() {\n        if (hostedInvoiceUrl) {\n            window.open(hostedInvoiceUrl, '_blank');\n            /*try {\n                // Retrieve the unpaid invoice to check if the payment was done\n                const invoiceResponse = await fetch(`https://api.stripe.com/v1/invoices/${unpaidInvoiceToPay.id}`, {\n                    method: 'GET',\n                    headers: {\n                        'Authorization': `Bearer ${stripeSecretKey}`,\n                        'Content-Type': 'application/json'\n                    }\n                });\n\n                const invoice = await invoiceResponse.json();\n\n                console.log('Invoice retrieved after payment attempt:', invoice);\n                console.log('Invoice status:', invoice.status);\n\n                if (invoice.status === 'paid') {\n                    //alert('Payment successful.');\n                    console.log('Payment successful.');\n                    const attributes = [\n                        { key: \"licenseActitivationStatus\", value: true },\n                    ];\n                    attributeService.saveEntityAttributes(\n                        doctorkitId,\n                        \"SERVER_SCOPE\",\n                        attributes\n                    ).subscribe(\n                        () => {\n                            console.log('Analysis attribute saved successfully.');\n                            vm.dialogRef.close(null);\n                        },\n                        (error) => {\n                            console.error('Error saving licenseActivationStatus attribute:', error);\n                        }\n                    );\n                } else if (invoice.status === 'open') {\n                    console.log('Payment not completed.');\n                    //alert('Payment not completed.');\n                    vm.dialogRef.close(null);\n                }\n            } catch (error) {\n                console.error('Error checking invoice status:', error);\n                alert('Error checking invoice status:', error);\n            }*/\n        }\n    };\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n    window.addEventListener('focus', checkSessionStatusOnce);\n\n    // Check session status when user returns to the tab\n    function checkSessionStatusOnce() {\n        if (sessionId) {\n            fetch(`https://api.stripe.com/v1/invoices/${sessionId}`, {\n                method: 'GET',\n                headers: {\n                    'Authorization': `Bearer ${stripeSecretKey}`,\n                    'Content-Type': 'application/json'\n                }\n            })\n                .then(response => response.json())\n                .then(invoice => {\n                    console.log('Invoice status:', invoice.status);\n\n                    if (invoice.status === 'paid') {\n                        console.log('Payment successful.');\n                        //alert('Payment successful.');\n                        attributeService.saveEntityAttributes(\n                            doctorkitId,\n                            \"SERVER_SCOPE\",\n                            attributes\n                        ).subscribe(\n                            () => {\n                                console.log('Analysis attribute saved successfully.');\n                                vm.dialogRef.close(null);\n                            },\n                            (error) => {\n                                console.error('Error saving licenseActivationStatus attribute:', error);\n                            }\n                        );\n                        vm.dialogRef.close(null);\n                    } else if (invoice.status === 'open') {\n                        console.log('Payment not completed.');\n                        //alert('Payment not completed.');\n                        vm.dialogRef.close(null);\n                    }\n                })\n                .catch(error => {\n                    console.error('Error checking invoice status:', error);\n                    //alert('Error checking invoice status:', error);\n                    vm.dialogRef.close(null);\n                });\n        }\n        window.removeEventListener('focus', checkSessionStatusOnce);\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "169c33f1-a2e4-c0ab-8558-7fed9e3755f9"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.cancel-subscription}",
                "icon": "cancel",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;\n",
                "type": "custom",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\r\nlet stripeSecretKey;\r\nlet subscriptionId;\r\n\r\nattributeService.getEntityAttributes({ entityType: 'TENANT', id: tenantId }, \"SERVER_SCOPE\", ['stripeKey']).subscribe(attribute => {\r\n  console.log(\"Attribute\", attribute);\r\n  if (attribute && attribute.length > 0 && attribute[0].hasOwnProperty('value')) {\r\n    stripeSecretKey = attribute[0].value;\r\n    attributeService.getEntityAttributes(entityId, \"SERVER_SCOPE\", ['subscriptionId']).subscribe(attribute => {\r\n      if (attribute && attribute.length > 0 && attribute[0].hasOwnProperty('value')) {\r\n        subscriptionId = attribute[0].value || null;\r\n      }\r\n\r\n      if (subscriptionId) {\r\n        openCancelSubscriptionDialog();\r\n      } else {\r\n        alert(\"Doktorkit has no active Subscription!\");\r\n      }\r\n    });\r\n  } else {\r\n    alert(\"Stripe key not found for tenant!\");\r\n  }\r\n});\r\n\r\nfunction openCancelSubscriptionDialog() {\r\n  var title = 'Are you sure you want to cancel the subscription for ' + entityName + '?';\r\n  var content = 'Be careful, after confirmation, the subscription will be set to cancel at the end of the current period!';\r\n  dialogs.confirm(title, content, 'Cancel', 'Confirm Cancellation').subscribe(\r\n    function(result) {\r\n      if (result) {\r\n        cancelSubscriptionAtPeriodEnd();\r\n      }\r\n    }\r\n  );\r\n}\r\n\r\nasync function cancelSubscriptionAtPeriodEnd() {\r\n  if (!stripeSecretKey || !subscriptionId) {\r\n    console.error('Missing required information to cancel subscription.');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const url = `https://api.stripe.com/v1/subscriptions/${subscriptionId}`;\r\n    const headers = {\r\n      'Authorization': `Bearer ${stripeSecretKey}`,\r\n      'Content-Type': 'application/x-www-form-urlencoded'\r\n    };\r\n    const body = 'cancel_at_period_end=true';\r\n\r\n    const response = await fetch(url, {\r\n      method: 'POST',\r\n      headers: headers,\r\n      body: body\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error('Failed to set subscription to cancel at period end');\r\n    }\r\n\r\n    const responseData = await response.json();\r\n    console.log('Subscription set to cancel at period end successfully:', responseData);\r\n    alert('Subscription set to cancel at the end of the current period successfully!');\r\n    widgetContext.updateAliases();\r\n  } catch (error) {\r\n    console.error('Failed to set subscription to cancel at period end:', error);\r\n  }\r\n}\r\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7c7d6f3d-6cbd-7c01-b7d0-75c94fa8d94e"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.next-delete-diagnostic-kit}",
                "icon": "delete",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteDiagnostickitDialog();\n\nfunction openDeleteDiagnostickitDialog() {\n  let titleTranslation = translationService.instant(\n    'custom.diagnostic-kits.delete.title',\n    { entityName: entityName }\n  );\n\n  let contentTranslation = translationService.instant(\n    'custom.diagnostic-kits.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteDiagnostickit();\n    }\n  });\n}\n\nfunction deleteDiagnostickit() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteDiagnostickitToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Diagnostickit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Diagnostickit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDiagnostickitToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "338d9fd7-c752-eb0e-4687-2c2e32ca1a32"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:action.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n//params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "86c3f72e-d682-b95b-e997-3167fc8c83cd"
              },
              {
                "name": "Activate Multiple Kits",
                "icon": "verified",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "/*var userRole = widgetContext.stateController.getStateParams().userRole;\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\"&& userRole !== \"ECO Administrator\"){\n    return true;\n}else{\n    return false;\n}*/\nreturn false;",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"addEntityFormGroup\" (ngSubmit)=\"onSubmit()\" class=\"add-entity-form\">\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\n    <h2>Manage Doktorkits</h2>\n    <span fxFlex></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n\n  <!-- Alert Messages Container -->\n  <div *ngIf=\"alerts && alerts.length\">\n    <div\n      *ngFor=\"let alert of alerts; let i = index\"\n      class=\"alert\"\n      [ngClass]=\"{\n        'alert-error': alert.type === 'error',\n        'alert-warning': alert.type === 'warning',\n        'alert-success': alert.type === 'success'\n      }\"\n    >\n      {{ alert.message }}\n      <span class=\"close-btn\" (click)=\"removeAlert(i)\">&times;</span>\n    </div>\n  </div>\n\n  <div mat-dialog-content fxLayout=\"column\">\n    <ng-container *ngIf=\"currentStep === 1\">\n      <!-- STEP 1: Select Kits -->\n      <div fxLayout=\"column\" fxLayoutGap=\"8px\">\n        <mat-form-field class=\"mat-block\">\n          <mat-label>Select Doktorkits</mat-label>\n          <mat-select formControlName=\"selectedKits\" multiple>\n            <mat-option *ngFor=\"let kit of kits\" [value]=\"kit.id.id\">\n              {{ kit.name }}\n            </mat-option>\n          </mat-select>\n          <mat-error *ngIf=\"addEntityFormGroup.get('selectedKits')?.errors?.required\">\n            Please select at least one Doktorkit\n          </mat-error>\n        </mat-form-field>\n      </div>\n    </ng-container>\n\n    <ng-container *ngIf=\"currentStep === 2\">\n      <!-- STEP 2: Product + Invoice Option -->\n      <div fxLayout=\"column\" fxLayoutGap=\"8px\">\n        <mat-form-field class=\"mat-block\">\n          <mat-label>Select Product</mat-label>\n          <mat-select formControlName=\"product\" required>\n            <mat-option *ngFor=\"let product of products\" [value]=\"product.id.id\">\n              {{ product.name }}\n            </mat-option>\n          </mat-select>\n          <mat-error *ngIf=\"addEntityFormGroup.get('product')?.errors?.required\">\n            Product selection is required\n          </mat-error>\n        </mat-form-field>\n\n        <mat-checkbox formControlName=\"invoice\">\n          Pay by Invoice (send invoice to customer email)\n        </mat-checkbox>\n      </div>\n    </ng-container>\n  </div>\n\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\n    <button mat-button color=\"primary\" type=\"button\" (click)=\"onPrevious()\" *ngIf=\"currentStep === 2\">\n      Previous\n    </button>\n    <button mat-button color=\"primary\" type=\"button\" (click)=\"onNext()\" *ngIf=\"currentStep === 1\">\n      Next\n    </button>\n    <button\n      mat-button\n      mat-raised-button\n      color=\"primary\"\n      type=\"submit\"\n      *ngIf=\"currentStep === 2\"\n      [disabled]=\"(isLoading$ | async) || addEntityFormGroup.invalid\"\n    >\n      Complete\n    </button>\n    <button mat-button color=\"primary\" type=\"button\" [disabled]=\"(isLoading$ | async)\" (click)=\"cancel()\">\n      Cancel\n    </button>\n  </div>\n</form>",
                "customCss": " /* Base alert styling */\n  .alert {\n    display: flex;\n    align-items: center;\n    padding: 1rem;\n    margin: 0.5rem 0;\n    border-radius: 4px;\n    color: #fff;\n    font-weight: 500;\n    font-family: sans-serif;\n    position: relative;\n  }\n\n  .alert .close-btn {\n    margin-left: auto;\n    cursor: pointer;\n    font-weight: bold;\n    padding: 0 0.5rem;\n    opacity: 0.8;\n  }\n  .alert .close-btn:hover {\n    opacity: 1;\n  }\n\n  /* Error (Red) */\n  .alert-error {\n    background-color: #f44336;\n    border-left: 6px solid #d32f2f;\n  }\n\n  /* Success (Green) */\n  .alert-success {\n    background-color: #4caf50;\n    border-left: 6px solid #388e3c;\n  }\n\n  /* Warning (Orange) */\n  .alert-warning {\n    background-color: #ff9800;\n    border-left: 6px solid #f57c00;\n  }",
                "customFunction": "// Initialize necessary services and variables\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet PageLink = widgetContext.pageLink;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet assetProfileService = $injector.get(widgetContext.servicesMap.get('assetProfileService'));\r\n\r\nlet tenantId = \"efb63c10-b576-11ee-a6c2-a149ed03c64d\";\r\nlet stripeSecretKey;\r\nlet sessionId = '';\r\nlet products = [];\r\nlet kits = [];\r\nlet selectedKits = [];\r\nlet selectedProductId = '';\r\nlet selectedLicenseType = '';\r\nlet customer = widgetContext.stateController.getStateParams().entityId.id; \r\nlet customerId;\r\nlet customerStripeId;\r\nlet subscriptionId;\r\nlet kitMap = {};\r\n\r\nvar pageLink = PageLink(50, 0);\r\n\r\n// Define queries\r\nvar query = {\r\n  parameters: {\r\n    rootId: tenantId,\r\n    rootType: \"TENANT\",\r\n    direction: \"FROM\",\r\n    relationTypeGroup: \"COMMON\",\r\n    maxLevel: 1073741824,\r\n    fetchLastLevelOnly: true\r\n  },\r\n  relationType: \"Contains\",\r\n  assetTypes: [\"Product\"]\r\n};\r\n\r\nvar queryKit = {\r\n  parameters: {\r\n    rootId: customer,\r\n    rootType: \"CUSTOMER\",\r\n    direction: \"FROM\",\r\n    relationTypeGroup: \"COMMON\",\r\n    maxLevel: 1,\r\n    fetchLastLevelOnly: false\r\n  },\r\n  relationType: \"Owns\",\r\n  assetTypes: [\"Doktorkit\"]\r\n};\r\n\r\n// Initialization function\r\nfunction init() {\r\n  fetchProductsKitsAndOpenDialog();\r\n}\r\ninit();\r\n\r\n// Fetch products and kits, then open dialog\r\nfunction fetchProductsKitsAndOpenDialog() {\r\n  attributeService\r\n    .getEntityAttributes({ entityType: \"TENANT\", id: tenantId }, \"SERVER_SCOPE\", [\"stripeKey\"])\r\n    .subscribe((attr) => {\r\n      stripeSecretKey = attr[0].value;\r\n      /*console.log(\"Fetched Stripe Secret Key:\", stripeSecretKey);*/\r\n\r\n      assetService.findByQuery(queryKit).subscribe((allKits) => {\r\n        kits = allKits;\r\n        kits.forEach((k) => {\r\n          kitMap[k.id.id] = { name: k.name, id: k.id.id };\r\n        });\r\n\r\n        assetService.findByQuery(query).subscribe((assets) => {\r\n          let filteredProducts = [];\r\n          let productFetches = assets.map((asset) => {\r\n            return attributeService\r\n              .getEntityAttributes(asset.id, \"SERVER_SCOPE\", [\"prodType\"])\r\n              .toPromise()\r\n              .then((attributes) => {\r\n                if (\r\n                  attributes.length > 0 &&\r\n                  attributes[0].key === \"prodType\" &&\r\n                  attributes[0].value === \"doktorkit\"\r\n                ) {\r\n                  filteredProducts.push(asset);\r\n                }\r\n              });\r\n          });\r\n          Promise.all(productFetches).then(() => {\r\n            products = filteredProducts;\r\n            openAddEntityDialog();\r\n          });\r\n        });\r\n      });\r\n    }, (error) => {\r\n      console.error(\"Error fetching tenant attributes:\", error);\r\n    });\r\n}\r\n\r\n// Open the dialog\r\nfunction openAddEntityDialog(billingCycleAnchor = null) {\r\n  customDialog.customDialog(htmlTemplate, (instance) => \r\n    AddEntityDialogController(instance, billingCycleAnchor)\r\n  ).subscribe();\r\n}\r\n\r\n// Dialog Controller\r\nfunction AddEntityDialogController(instance, billingCycleAnchor) {\r\n  let vm = instance;\r\n  vm.currentStep = 1;\r\n  vm.kits = kits;\r\n  vm.products = products;\r\n  vm.selectedKits = [];\r\n\r\n  // Store multiple alerts\r\n  vm.alerts = [];\r\n\r\n  // Initialize form\r\n  vm.addEntityFormGroup = vm.fb.group({\r\n    selectedKits: [[], [vm.validators.required]],\r\n    product: [\"\", [vm.validators.required]],\r\n    invoice: [false]\r\n  });\r\n\r\n  // Cancel function\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  // Next step\r\n  vm.onNext = function () {\r\n    let next = true;  \r\n    vm.selectedKits = vm.addEntityFormGroup.value.selectedKits;\r\n    if (!vm.selectedKits || !vm.selectedKits.length) {\r\n      addAlert(\"Please select at least one Doktorkit\", \"error\");\r\n      return;\r\n    }\r\n    checkKitsValidity(vm.selectedKits).then((result) => {\r\n      let { validKitIds, noDeviceKits, activeSubKits } = result;\r\n\r\n      if (noDeviceKits.length > 0) {\r\n        addAlert(\r\n          `These selected kits have no assigned devices: ${noDeviceKits.map((id) => kitMap[id].name).join(\", \")}`,\r\n          \"warning\"\r\n        );\r\n        next = false;\r\n      }\r\n      if (activeSubKits.length > 0) {\r\n        addAlert(\r\n          `These selected kits already have an active subscription: ${activeSubKits.map((id) => kitMap[id].name).join(\", \")}`,\r\n          \"warning\"\r\n        );\r\n        next = false;\r\n      }\r\n      if(next){\r\n          vm.currentStep = 2;\r\n      }\r\n    });\r\n  };\r\n\r\n  // Previous step\r\n  vm.onPrevious = function () {\r\n    vm.currentStep = 1;\r\n  };\r\n\r\n  // Submit function\r\n  vm.onSubmit = function () {\r\n    const formValues = vm.addEntityFormGroup.value;\r\n    selectedProductId = formValues.product;\r\n    selectedKits = formValues.selectedKits;\r\n    let payByInvoice = formValues.invoice;\r\n\r\n    const selectedProduct = vm.products.find((p) => p.id.id === selectedProductId);\r\n    if (selectedProduct) {\r\n      if (/base/i.test(selectedProduct.name)) {\r\n        selectedLicenseType = \"Base\";\r\n      } else if (/pro/i.test(selectedProduct.name)) {\r\n        selectedLicenseType = \"Pro\";\r\n      } else {\r\n        selectedLicenseType = \"Unknown\";\r\n      }\r\n    } else {\r\n      selectedLicenseType = \"Unknown\";\r\n    }\r\n\r\n    attributeService\r\n      .getEntityAttributes({ entityType: \"ASSET\", id: selectedProductId }, \"SERVER_SCOPE\", [\"price_stripe_id\"])\r\n      .subscribe((attributes) => {\r\n        if (attributes.length > 0 && attributes[0].key === \"price_stripe_id\") {\r\n          const priceId = attributes[0].value;\r\n\r\n          if (payByInvoice) {\r\n            createSubscriptionInvoiceMethod(selectedKits, priceId).then((subscriptionData) => {\r\n              if (subscriptionData) {\r\n                let subId = subscriptionData.id;\r\n                let updates = selectedKits.map((kitId) => {\r\n                  let attrs = [\r\n                    { key: \"subscriptionId\", value: subId },\r\n                    { key: \"licenseActivationStatus\", value: false },\r\n                    { key: \"licenseType\", value: selectedLicenseType }\r\n                  ];\r\n                  return attributeService\r\n                    .saveEntityAttributes({ entityType: \"ASSET\", id: kitId }, \"SERVER_SCOPE\", attrs)\r\n                    .toPromise();\r\n                });\r\n                Promise.all(updates)\r\n                  .then(() => {\r\n                    addAlert(\"Subscription created via invoice. Invoice sent immediately!\", \"success\");\r\n                    vm.dialogRef.close(null);\r\n                  })\r\n                  .catch((err) => {\r\n                    console.error(\"Error saving invoice attributes:\", err);\r\n                    addAlert(\"Failed to save invoice attributes.\", \"error\");\r\n                    vm.dialogRef.close(null);\r\n                  });\r\n              } else {\r\n                addAlert(\"Invoice subscription creation failed. Please try again.\", \"error\");\r\n              }\r\n            });\r\n          } else {\r\n            createCheckoutSessionForAllKits(selectedKits, priceId, vm, billingCycleAnchor);\r\n          }\r\n        } else {\r\n          addAlert(\"Price ID not found for the selected product.\", \"error\");\r\n        }\r\n      }, (error) => {\r\n        console.error(\"Error fetching price attributes:\", error);\r\n        addAlert(\"Error fetching price details.\", \"error\");\r\n      });\r\n  };\r\n\r\n  // Remove alert\r\n  vm.removeAlert = function (index) {\r\n    vm.alerts.splice(index, 1);\r\n  };\r\n\r\n  // Add alert\r\n  function addAlert(message, type) {\r\n    vm.alerts.push({ message, type });\r\n  }\r\n\r\n  // Check validity of selected kits\r\n  async function checkKitsValidity(kitIds) {\r\n    let validKitIds = [];\r\n    let noDeviceKits = [];\r\n    let activeSubKits = [];\r\n\r\n    for (let kitId of kitIds) {\r\n      let { isValid, reason } = await validateKit(kitId);\r\n      if (isValid) {\r\n        validKitIds.push(kitId);\r\n      } else {\r\n        if (reason === \"no-devices\") {\r\n          noDeviceKits.push(kitId);\r\n        } else if (reason === \"active-sub\") {\r\n          activeSubKits.push(kitId);\r\n        }\r\n      }\r\n    }\r\n    return { validKitIds, noDeviceKits, activeSubKits };\r\n  }\r\n\r\n  // Validate individual kit\r\n  async function validateKit(kitId) {\r\n    try {\r\n      let kitInfo = await assetService.getAssetInfo(kitId).toPromise();\r\n      customerId = kitInfo.customerId;\r\n\r\n      const deviceSearchQuery = {\r\n        parameters: {\r\n          rootId: kitId,\r\n          rootType: \"ASSET\",\r\n          direction: \"FROM\",\r\n          relationTypeGroup: \"COMMON\",\r\n          maxLevel: 100,\r\n          fetchLastLevelOnly: false\r\n        },\r\n        relationType: \"Contains\",\r\n        deviceTypes: [\"P-Flow D116\"]\r\n      };\r\n      let devices = await deviceService.findByQuery(deviceSearchQuery).toPromise();\r\n\r\n      if (devices && devices.length > 0) {\r\n        let existingSub = await attributeService\r\n          .getEntityAttributes({ entityType: \"ASSET\", id: kitId }, \"SERVER_SCOPE\", [\"subscriptionId\"])\r\n          .toPromise();\r\n        subscriptionId = existingSub?.[0]?.value || null;\r\n\r\n        if (subscriptionId) {\r\n          let subscriptionData = await checkSubscriptionStatus(subscriptionId);\r\n          if (subscriptionData && subscriptionData.status === \"active\") {\r\n            if (subscriptionData.cancel_at_period_end) {\r\n              return { isValid: true };\r\n            } else {\r\n              return { isValid: false, reason: \"active-sub\" };\r\n            }\r\n          } else {\r\n            return { isValid: true };\r\n          }\r\n        } else {\r\n          return { isValid: true };\r\n        }\r\n      } else {\r\n        return { isValid: false, reason: \"no-devices\" };\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Error validating kit:\", err);\r\n      return { isValid: false, reason: \"error\" };\r\n    }\r\n  }\r\n}\r\n\r\n// Function to create subscription via invoice\r\nasync function createSubscriptionInvoiceMethod(kitIds, priceId) {\r\n  try {\r\n    let firstKitInfo = await assetService.getAssetInfo(kitIds[0]).toPromise();\r\n    let tbCustId = firstKitInfo.customerId;\r\n\r\n    let attributeStripeKey = await attributeService\r\n      .getEntityAttributes({ entityType: \"TENANT\", id: tenantId }, \"SERVER_SCOPE\", [\"stripeKey\"])\r\n      .toPromise();\r\n    stripeSecretKey = attributeStripeKey?.[0]?.value || null;\r\n\r\n    let custStripeAttr = await attributeService\r\n      .getEntityAttributes(\r\n        { entityType: \"CUSTOMER\", id: tbCustId.id ? tbCustId.id : tbCustId },\r\n        \"SERVER_SCOPE\",\r\n        [\"stripe_id\"]\r\n      )\r\n      .toPromise();\r\n    let stripeCustomerId = custStripeAttr?.[0]?.value || null;\r\n    if (!stripeCustomerId) {\r\n      console.error(\"No stripe_id found for this customer. Cannot create subscription!\");\r\n      return null;\r\n    }\r\n\r\n    let quantity = kitIds.length;\r\n    let subParams = new URLSearchParams({\r\n      customer: stripeCustomerId,\r\n      \"items[0][price]\": priceId,\r\n      \"items[0][quantity]\": quantity.toString(),\r\n      collection_method: \"send_invoice\",\r\n      days_until_due: \"14\",\r\n      \"expand[]\": \"latest_invoice\"\r\n    });\r\n\r\n    const subResp = await fetch(\"https://api.stripe.com/v1/subscriptions\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        Authorization: `Bearer ${stripeSecretKey}`,\r\n        \"Content-Type\": \"application/x-www-form-urlencoded\"\r\n      },\r\n      body: subParams\r\n    });\r\n    if (!subResp.ok) {\r\n      throw new Error(`Error creating subscription with invoice: ${subResp.statusText}`);\r\n    }\r\n    const subscriptionData = await subResp.json();\r\n\r\n    let latestInvoice = subscriptionData.latest_invoice;\r\n    if (latestInvoice && latestInvoice.id) {\r\n      let finalizeUrl = `https://api.stripe.com/v1/invoices/${latestInvoice.id}/finalize?auto_advance=true`;\r\n      const finalizeResp = await fetch(finalizeUrl, {\r\n        method: \"POST\",\r\n        headers: {\r\n          Authorization: `Bearer ${stripeSecretKey}`\r\n        }\r\n      });\r\n      if (!finalizeResp.ok) {\r\n        throw new Error(`Error finalizing invoice: ${finalizeResp.statusText}`);\r\n      }\r\n      await finalizeResp.json();\r\n    }\r\n    return subscriptionData;\r\n  } catch (error) {\r\n    console.error(\"Error in createSubscriptionInvoiceMethod:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\n// Function to create checkout session for all kits\r\nasync function createCheckoutSessionForAllKits(kitIds, priceId, instance, billingCycleAnchor = null) {\r\n  try {\r\n    let firstKitInfo = await assetService.getAssetInfo(kitIds[0]).toPromise();\r\n    customerId = firstKitInfo.customerId;\r\n\r\n    let attributeStripeKey = await attributeService\r\n      .getEntityAttributes({ entityType: \"TENANT\", id: tenantId }, \"SERVER_SCOPE\", [\"stripeKey\"])\r\n      .toPromise();\r\n    stripeSecretKey = attributeStripeKey?.[0]?.value || null;\r\n\r\n    let priceDataResp = await fetch(`https://api.stripe.com/v1/prices/${priceId}`, {\r\n      method: \"GET\",\r\n      headers: { Authorization: `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!priceDataResp.ok) {\r\n      throw new Error(`Error fetching price details: ${priceDataResp.statusText}`);\r\n    }\r\n    let priceData = await priceDataResp.json();\r\n    let isRecurring = priceData.recurring !== null;\r\n    let mode = isRecurring ? \"subscription\" : \"payment\";\r\n\r\n    let stripeIdAttr = await attributeService\r\n      .getEntityAttributes(customerId, \"SERVER_SCOPE\", [\"stripe_id\"])\r\n      .toPromise();\r\n    customerStripeId = stripeIdAttr?.[0]?.value || null;\r\n\r\n    // Fetch current URL for success and cancel URLs\r\n    let currentUrl = window.location.href;\r\n    const successUrl = currentUrl;\r\n    const cancelUrl = currentUrl;\r\n\r\n    let bodyParams = new URLSearchParams({\r\n      success_url: successUrl,\r\n      cancel_url: cancelUrl,\r\n      \"payment_method_types[]\": \"card\",\r\n      \"line_items[0][price]\": priceId,\r\n      \"line_items[0][quantity]\": kitIds.length.toString(),\r\n      mode: mode\r\n    });\r\n\r\n    if (customerStripeId) {\r\n      bodyParams.append(\"customer\", customerStripeId);\r\n    }\r\n    if (isRecurring && billingCycleAnchor) {\r\n      bodyParams.append(\"subscription_data[billing_cycle_anchor]\", billingCycleAnchor);\r\n      bodyParams.append(\"subscription_data[proration_behavior]\", \"none\");\r\n    }\r\n\r\n    let response = await fetch(\"https://api.stripe.com/v1/checkout/sessions\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        Authorization: `Bearer ${stripeSecretKey}`,\r\n        \"Content-Type\": \"application/x-www-form-urlencoded\"\r\n      },\r\n      body: bodyParams\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error creating checkout session: ${response.statusText}`);\r\n    }\r\n    let data = await response.json();\r\n\r\n    if (data.id && data.url) {\r\n      sessionId = data.id;\r\n      selectedLicenseType = selectedLicenseType; // Ensure licenseType is set\r\n\r\n      /*console.log(\"Checkout Session ID:\", sessionId);*/\r\n\r\n      // Save licenseType and sessionId to each selected kit before redirecting\r\n      let updates = kitIds.map((kitId) => {\r\n        let attrs = [\r\n          { key: \"licenseType\", value: selectedLicenseType },\r\n          { key: \"sessionId\", value: sessionId }\r\n        ];\r\n        return attributeService\r\n          .saveEntityAttributes({ entityType: \"ASSET\", id: kitId }, \"SERVER_SCOPE\", attrs)\r\n          .toPromise()\r\n          .then(() => {\r\n            /*console.log(`Saved licenseType and sessionId to kit ${kitId}.`);*/\r\n          })\r\n          .catch((err) => {\r\n            console.error(`Error saving attributes to kit ${kitId}:`, err);\r\n          });\r\n      });\r\n\r\n      // Wait for all updates to complete\r\n      await Promise.all(updates);\r\n\r\n      // Redirect to Stripe Checkout in the same tab\r\n      window.location.href = data.url;\r\n    } else {\r\n      console.error(\"Checkout session response does not contain id or url.\");\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error in createCheckoutSessionForAllKits:\", error);\r\n    addAlert(\"Failed to create checkout session. Please try again.\", \"error\");\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\n// Function to check payment status for all kits (if needed)\r\nasync function checkPaymentStatusForAllKits(sessionId, kitIds, licenseType, instance) {\r\n  try {\r\n    const response = await fetch(`https://api.stripe.com/v1/checkout/sessions/${sessionId}`, {\r\n      method: \"GET\",\r\n      headers: { Authorization: `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error: ${response.statusText}`);\r\n    }\r\n    const data = await response.json();\r\n\r\n    if (data.payment_status === \"paid\") {\r\n      alert(\"Payment completed successfully!\");\r\n      let subId = data.subscription || null;\r\n\r\n      let updates = kitIds.map(async (kitId) => {\r\n        let attributes = [\r\n          { key: \"licenseActivationStatus\", value: true },\r\n          { key: \"licenseType\", value: licenseType }\r\n        ];\r\n        if (subId) {\r\n          attributes.push({ key: \"subscriptionId\", value: subId });\r\n        }\r\n        return attributeService\r\n          .saveEntityAttributes({ entityType: \"ASSET\", id: kitId }, \"SERVER_SCOPE\", attributes)\r\n          .toPromise();\r\n      });\r\n\r\n      await Promise.all(updates);\r\n      instance.dialogRef.close(null);\r\n      return \"paid\";\r\n    } else {\r\n      instance.dialogRef.close(null);\r\n      alert(\"Payment was not successful. Please try again.\");\r\n      return data.payment_status;\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error checking payment status for all kits:\", error);\r\n    return \"error\";\r\n  }\r\n}\r\n\r\n// Function to check subscription status via Stripe\r\nasync function checkSubscriptionStatus(subscriptionId) {\r\n  try {\r\n    const response = await fetch(`https://api.stripe.com/v1/subscriptions/${subscriptionId}`, {\r\n      method: \"GET\",\r\n      headers: { Authorization: `Bearer ${stripeSecretKey}` }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error fetching subscription details: ${response.statusText}`);\r\n    }\r\n    return await response.json();\r\n  } catch (error) {\r\n    console.error(\"Error fetching subscription:\", error);\r\n    throw error;\r\n  }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "9b81f168-6fff-da00-7bac-427fd0220fed"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.add-diagnostic-kit}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<!-- HTML Template for the \"Add Diagnostickit\" Dialog -->\r\n<form\r\n  #addEntityForm=\"ngForm\"\r\n  [formGroup]=\"addDiagnostickitFormGroup\"\r\n  (ngSubmit)=\"save()\"\r\n  class=\"add-entity-form max-w-3xl mx-auto\"\r\n  style=\"width: 350px;\"\r\n>\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.diagnostic-kits.add-diagnostic-kit' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar\r\n    color=\"warn\"\r\n    mode=\"indeterminate\"\r\n    *ngIf=\"isLoading$ | async\"\r\n  ></mat-progress-bar>\r\n\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <div class=\"flex flex-col gap-0 sm:gap-2\">\r\n      \r\n      <!-- Diagnostickit Name / ID -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>Diagnostickit ID</mat-label>\r\n        <input matInput formControlName=\"name\" required/>\r\n        <mat-error *ngIf=\"addDiagnostickitFormGroup.get('name').hasError('required')\">\r\n          {{ 'custom.diagnostic-kits.diagnostic-kit-id-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Label -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>Label</mat-label>\r\n        <input matInput formControlName=\"label\"/>\r\n        <mat-error *ngIf=\"addDiagnostickitFormGroup.get('label').hasError('required')\">\r\n          {{ 'custom.diagnostic-kits.label-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Diagnostic Kit Type -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{ 'custom.diagnostic-kits.diagnostic-kit-type' | translate }}</mat-label>\r\n        <mat-select formControlName=\"kitType\" required>\r\n          <mat-option value=\"basis\">Diagnostics Basis Kit</mat-option>\r\n          <!--<mat-option value=\"extension\">Diagnostics Extension Kit</mat-option>-->\r\n          <mat-option value=\"loraWan\">Diagnostics LoRaWAN Kit</mat-option>\r\n        </mat-select>\r\n        <mat-error *ngIf=\"addDiagnostickitFormGroup.get('kitType')?.hasError('required')\">\r\n          {{ 'custom.diagnostic-kits.diagnostic-kit-type-is-required' | translate }}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button\r\n      mat-button\r\n      color=\"primary\"\r\n      type=\"button\"\r\n      [disabled]=\"(isLoading$ | async)\"\r\n      (click)=\"cancel()\"\r\n      cdkFocusInitial\r\n    >\r\n      {{ 'action.cancel' | translate }}\r\n    </button>\r\n    <button\r\n      mat-button\r\n      mat-raised-button\r\n      color=\"primary\"\r\n      type=\"submit\"\r\n      [disabled]=\"(isLoading$ | async)\"\r\n    >\r\n      {{ 'custom.diagnostic-kits.add-diagnostic-kit' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "// JS/Typescript Code\r\n\r\nlet $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nconst rxjs = widgetContext.rxjs;\r\nlet customerId;\r\nlet diagnostickitsAll = []; // Will store all Diagnostickits across customers\r\n\r\n// Determine which customer ID to use\r\nlet customerName = widgetContext.stateController.getStateParams().entityName;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n    customerId = widgetContext.stateController.getStateParams().entityId;\r\n} else {\r\n    customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n}\r\n\r\n// Page link to fetch customers\r\nconst pageLink = widgetContext.pageLink(100, 0, null, null); // PageSize: 100, PageNumber: 0\r\n\r\n// Fetch all customers, then fetch all their Diagnostickits\r\n/*customerService.getCustomers(pageLink).subscribe(customers => {\r\n  //console.log(\"customers:\", customers);\r\n\r\n  // Track how many customer queries have completed\r\n  let processed = 0;\r\n  const totalCustomers = customers.data.length;\r\n\r\n  customers.data.map(customer => {\r\n    // Build our query for this specific customer's ID\r\n    const assetSearchQuery = {\r\n      parameters: {\r\n        rootId: customer.id.id,       \r\n        rootType: 'CUSTOMER',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Diagnostickit']\r\n    };\r\n\r\n    assetService.findByQuery(assetSearchQuery).subscribe(diagnostickits => {\r\n      //console.log(\"diagnostickits of customer:\", customer.name, diagnostickits);    \r\n      // Merge these Diagnostickits into our master array\r\n      diagnostickitsAll.push(...diagnostickits);\r\n\r\n      // Increment the processed counter\r\n      processed++;\r\n      // If we've processed all customers, open the dialog\r\n      if (processed === totalCustomers) {\r\n        //console.log('All Diagnostickits across all customers:', diagnostickitsAll);\r\n        openAddDiagnostickitDialog(diagnostickitsAll);\r\n      }\r\n    });\r\n  });\r\n});*/\r\nopenAddDiagnostickitDialog(diagnostickitsAll);\r\n// Opens the custom dialog, passing in the collected diagnostickitsAll\r\nfunction openAddDiagnostickitDialog(diagnostickitsAll) {\r\n  customDialog.customDialog(htmlTemplate, AddDiagnostickitDialogController, { diagnostickitsAll }).subscribe();\r\n}\r\n\r\n// The Dialog Controller\r\nfunction AddDiagnostickitDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  // We have access to diagnostickitsAll via instance.data\r\n  vm.diagnostickitsAll = instance.data.diagnostickitsAll || [];\r\n\r\n  // Reactive form definition\r\n  vm.addDiagnostickitFormGroup = vm.fb.group({\r\n    name: [null, [vm.validators.required]],\r\n    label: [null],\r\n    kitType: ['basis', [vm.validators.required]]\r\n  });\r\n\r\n /*function generateDiagnostickitName(kitType) {\r\n  // Current 2-digit year\r\n  const year = (new Date().getFullYear() % 100).toString().padStart(2, '0');\r\n\r\n  // Determine the prefix for the *new* kit\r\n  const prefix = kitType === 'basis' ? 'DBKIT' : 'DEKIT';\r\n\r\n  // Single pattern to match either DBKIT or DEKIT, ignoring the year for the counter\r\n  // Explanation:\r\n  //   ^D(B|E)KIT         => Must start with DBKIT or DEKIT\r\n  //   \\d{2}             => Then two digits (the year)\r\n  //   EU-               => Then 'EU-'\r\n  //   (\\d{4})           => Capture the 4-digit counter\r\n  const pattern = /^D(B|E)KIT\\d{2}EU-(\\d{4})$/;\r\n\r\n  let maxNumber = 0;\r\n\r\n  // Find the max counter among all kits that match DBKITyyEU-#### or DEKITyyEU-####\r\n  vm.diagnostickitsAll.forEach(d => {\r\n    const match = d.name.match(pattern);\r\n    if (match) {\r\n      // match[2] should contain the 4-digit counter\r\n      const currentNum = parseInt(match[2], 10);\r\n      if (currentNum > maxNumber) {\r\n        maxNumber = currentNum;\r\n      }\r\n    }\r\n  });\r\n\r\n  // Next counter (increment by 1)\r\n  const nextNumber = (maxNumber + 1).toString().padStart(4, '0');\r\n\r\n  // Construct new name with correct prefix, current year, and the incremented counter\r\n  return `${prefix}${year}EU-${nextNumber}`;\r\n}*/\r\n\r\n\r\n\r\n  // Whenever the kitType changes, regenerate the name\r\n  /*vm.addDiagnostickitFormGroup.get('kitType').valueChanges.subscribe((newKitType) => {\r\n    const newName = generateDiagnostickitName(newKitType);\r\n    vm.addDiagnostickitFormGroup.patchValue(\r\n      { name: newName },\r\n      { emitEvent: false } // avoid infinite loop\r\n    );\r\n  });*/\r\n\r\n  // Initialize the name based on the default kitType ('basis')\r\n  /*vm.addDiagnostickitFormGroup.patchValue({\r\n    name: generateDiagnostickitName(vm.addDiagnostickitFormGroup.get('kitType').value)\r\n  }, { emitEvent: false });*/\r\n\r\n  // Cancel / close the dialog\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  // Save action\r\n  vm.save = function () {\r\n    const stateParams = widgetContext.stateController.getStateParams();\r\n    var projectId, measurementId;\r\n\r\n    projectId = {\r\n      id: (stateParams.selectedProject && stateParams.selectedProject.entityId && stateParams.selectedProject.entityId.id)\r\n        ? stateParams.selectedProject.entityId.id\r\n        : '',\r\n      entityType: 'ASSET'\r\n    };\r\n\r\n    measurementId = {\r\n      id: (stateParams.selectedMeasurement && stateParams.selectedMeasurement.entityId && stateParams.selectedMeasurement.entityId.id)\r\n        ? stateParams.selectedMeasurement.entityId.id\r\n        : '',\r\n      entityType: 'ASSET'\r\n    };\r\n    \r\n    let localCustomerId;\r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        localCustomerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        localCustomerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n\r\n    vm.addDiagnostickitFormGroup.markAsPristine();\r\n\r\n    // Save the Diagnostickit asset, then link it\r\n    saveDiagnostickitObservable(localCustomerId).subscribe(\r\n      function (Diagnostickit) {\r\n        const observables = [\r\n          saveCustomerToDiagnostickitRelation(localCustomerId, Diagnostickit.id),\r\n          saveAttributes(Diagnostickit.id)\r\n        ];\r\n\r\n        // If there's a selected project, relate it\r\n        if(projectId.id !== \"\"){\r\n            observables.push(saveProjectToDiagnostickitRelation(projectId, Diagnostickit.id));\r\n        }\r\n        // If there's a selected measurement, relate it\r\n        if(measurementId.id !== \"\"){\r\n            observables.push(saveMeasurementToDiagnostickitRelation(measurementId, Diagnostickit.id));\r\n        }\r\n\r\n        widgetContext.rxjs.forkJoin(observables).subscribe(\r\n          function () {\r\n            var params = widgetContext.stateController.getStateParams();\r\n            // Update selectedDiagnostickit in state params\r\n            params['selectedDiagnostickit'] = {\r\n              entityId: Diagnostickit.id,\r\n              entityName: Diagnostickit.name\r\n            };\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n          }\r\n        );\r\n      }\r\n    );\r\n  };\r\n\r\n  // -------------- Helper Functions -------------- //\r\n\r\n  // Save Diagnostickit asset inside the 'Diagnostickits' group and also add it to 'Unassigned Kit' group\r\n  function saveDiagnostickitObservable(customerId) {\r\n    return getDiagnostickitsGroup(customerId).pipe(\r\n      widgetContext.rxjs.switchMap((DiagnostickitsGroup) => {\r\n        return getUnassignedKitGroup(customerId).pipe(\r\n          widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\r\n            const formValues = vm.addDiagnostickitFormGroup.value;\r\n            const Diagnostickit = {\r\n              name: formValues.name,\r\n              label: formValues.label,\r\n              type: 'Diagnostickit',\r\n              customerId: customerId\r\n            };\r\n\r\n            return assetService.saveAsset(Diagnostickit, DiagnostickitsGroup.id.id).pipe(\r\n              widgetContext.rxjs.switchMap((savedAsset) => {\r\n                // Add the new Diagnostickit to the \"Unassigned Kit\" group\r\n                return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, savedAsset.id.id).pipe(\r\n                  widgetContext.rxjs.map(() => {\r\n                    return savedAsset; \r\n                  })\r\n                );\r\n              })\r\n            );\r\n          })\r\n        );\r\n      })\r\n    );\r\n  }\r\n\r\n  // Get or create the \"Diagnostickits\" group\r\n  function getDiagnostickitsGroup(customerId) {\r\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n      widgetContext.rxjs.switchMap((entityGroups) => {\r\n        var DiagnostickitsGroup = entityGroups.find(group => group.name === 'Diagnostickits');\r\n        if (DiagnostickitsGroup) {\r\n          return widgetContext.rxjs.of(DiagnostickitsGroup);\r\n        } else {\r\n          DiagnostickitsGroup = {\r\n            type: 'ASSET',\r\n            name: 'Diagnostickits',\r\n            ownerId: customerId\r\n          };\r\n          return entityGroupService.saveEntityGroup(DiagnostickitsGroup);\r\n        }\r\n      })\r\n    );\r\n  }\r\n\r\n  // Get or create the \"Unassigned Kit\" group\r\n  function getUnassignedKitGroup(customerId) {\r\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n      widgetContext.rxjs.switchMap((entityGroups) => {\r\n        var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n        if (UnassignedKitGroup) {\r\n          return widgetContext.rxjs.of(UnassignedKitGroup);\r\n        } else {\r\n          UnassignedKitGroup = {\r\n            type: 'ASSET',\r\n            name: 'Unassigned Kit',\r\n            ownerId: customerId\r\n          };\r\n          return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n        }\r\n      })\r\n    );\r\n  }\r\n\r\n  // Create relation: Customer -> Diagnostickit\r\n  function saveCustomerToDiagnostickitRelation(customerId, DiagnostickitId) {\r\n    var relation = {\r\n      from: customerId,\r\n      to: DiagnostickitId,\r\n      typeGroup: 'COMMON',\r\n      type: 'Owns'\r\n    };\r\n    return entityRelationService.saveRelation(relation);\r\n  }\r\n\r\n  // Create relation: Project -> Diagnostickit\r\n  function saveProjectToDiagnostickitRelation(projectId, DiagnostickitId) {\r\n    var relation = {\r\n      from: projectId,\r\n      to: DiagnostickitId,\r\n      typeGroup: 'COMMON',\r\n      type: 'Owns'\r\n    };\r\n    return entityRelationService.saveRelation(relation);\r\n  }\r\n\r\n  // Create relation: Measurement -> Diagnostickit\r\n  function saveMeasurementToDiagnostickitRelation(measurementId, DiagnostickitId) {\r\n    var relation = {\r\n      from: measurementId,\r\n      to: DiagnostickitId,\r\n      typeGroup: 'COMMON',\r\n      type: 'Owns'\r\n    };\r\n    return entityRelationService.saveRelation(relation);\r\n  }\r\n\r\n  // Save attributes for the newly created Diagnostickit\r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n      {\r\n        key: 'state',\r\n        value: 'normal'\r\n      },\r\n      {\r\n        key: 'kitType',\r\n        value: vm.addDiagnostickitFormGroup.get('kitType').value\r\n      }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e965b8a1-a6ac-5ae4-fd79-2b7220b91ed1"
              },
              {
                "name": "{i18n:custom.diagnostic-kits.transfer-kit}",
                "buttonType": "icon",
                "icon": "mdi:swap-horizontal",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form #transferKitForm=\"ngForm\" [formGroup]=\"transferKitFormGroup\" (ngSubmit)=\"save()\" class=\"transferKitFormGroup max-w-3xl mx-auto\" style=\"width: 800px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.diagnostic-kits.transfer-kit' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n   <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n      <mat-label>Kit</mat-label>\r\n      <mat-select formControlName=\"kit\" required (selectionChange)=\"onKitSelected($event)\">\r\n        <mat-option *ngFor=\"let kit of kits\" [value]=\"kit\">\r\n          {{ kit.name }}\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"transferKitFormGroup.get('kit')?.hasError('required')\">\r\n        {{ 'custom.diagnostic-kits.kit-is-required' | translate }}\r\n      </mat-error>\r\n    </mat-form-field>\r\n    \r\n    <div class=\"flex justify-center items-center\" style=\"padding-bottom: 10px;\">\r\n      <mat-icon>arrow_downward</mat-icon>\r\n    </div>\r\n\r\n   <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n      <mat-label>{{ 'custom.diagnostic-kits.customer' | translate }}</mat-label>\r\n      <mat-select formControlName=\"customer\" required (selectionChange)=\"onCustomerSelected($event)\">\r\n        <mat-option *ngFor=\"let cust of customers\" [value]=\"cust\">\r\n          {{ cust.title }}\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"transferKitFormGroup.get('customer')?.hasError('required')\">\r\n        {{ 'custom.diagnostic-kits.customer-is-required' | translate }}\r\n      </mat-error>\r\n    </mat-form-field>\r\n    \r\n    <div *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" class=\"flex justify-center items-center pb-5\">\r\n      <mat-icon>arrow_downward</mat-icon>\r\n    </div>\r\n      \r\n    <fieldset *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" class=\"fieldset\" style=\"margin-bottom: 16px;\">\r\n      <div class=\"flex flex-row justify-start items-center py-2.5\">\r\n        <div style=\"width: 40px; display: flex; justify-content: center; align-items: center;\">\r\n          <mat-icon>info</mat-icon>\r\n        </div>\r\n        <div class=\"flex-1\">\r\n          <p style=\"font-size: 15px; margin: 0;\">\r\n            {{ 'custom.diagnostic-kits.kit-has-assigned-measurement-warning' | translate }}\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </fieldset>\r\n    \r\n    <div *ngIf=\"foundProject\" class=\"flex justify-start items-center\" style=\"margin-top:10px;\">\r\n      <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n        <mat-label>{{ 'custom.diagnostic-kits.found-project' | translate }}</mat-label>\r\n        <input matInput formControlName=\"foundProject\" readonly>\r\n      </mat-form-field>\r\n      \r\n      <div style=\"padding: 0 10px;\">\r\n        <mat-icon>arrow_right_alt</mat-icon>\r\n      </div>\r\n      \r\n      <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n        <mat-label>{{ 'custom.diagnostic-kits.transferred-project' | translate }}Transferred Project</mat-label>\r\n        <input matInput formControlName=\"transferredProject\" readonly>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div *ngIf=\"projectMeasurements && projectMeasurements.length > 0\" style=\"margin-top:10px;\">\r\n      <div *ngFor=\"let measurement of projectMeasurements; let i = index\" class=\"flex flex-row justify-start items-center\" style=\"margin-bottom:8px;\">\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.found-measurement' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'measurement' + i\" readonly>\r\n        </mat-form-field>\r\n        <div style=\"padding: 0 10px;\">\r\n          <mat-icon>arrow_right_alt</mat-icon>\r\n        </div>\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.transferred-measurement' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'transferredMeasurement' + i\" readonly>\r\n        </mat-form-field>\r\n      </div>\r\n    </div>\r\n\r\n    <div *ngIf=\"allDevices && allDevices.length > 0\" style=\"margin-top:10px;\">\r\n      <div *ngFor=\"let device of allDevices; let i = index\" class=\"flex flex-row justify-start items-center\" style=\"margin-bottom:8px;\">\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.found-device' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'device' + i\" readonly>\r\n        </mat-form-field>\r\n        <div style=\"padding: 0 10px;\">\r\n          <mat-icon>arrow_right_alt</mat-icon>\r\n        </div>\r\n        <mat-form-field class=\"flex-none\" style=\"width: 50%;\">\r\n          <mat-label>{{ 'custom.diagnostic-kits.transferred-device' | translate }}</mat-label>\r\n          <input matInput [formControlName]=\"'transferredDevice' + i\" readonly>\r\n        </mat-form-field>\r\n      </div>\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">{{ 'action.cancel' | translate }}</button>\r\n    <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"transferKitFormGroup.invalid\">\r\n      {{ 'action.save' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.transferKitFormGroup .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.transferKitFormGroup .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.transferKitFormGroup\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.transferKitFormGroup\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet dialogs = injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\nlet customerId, customer;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet pageLink = {\r\n  pageSize: 100, page: 0, textSearch: '', sortOrder: 'ASC', sortProperty: 'title',\r\n  toQuery: function () {\r\n    let q = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) q += '&textSearch=' + encodeURIComponent(this.textSearch);\r\n    if (this.sortProperty) q += '&sortProperty=' + encodeURIComponent(this.sortProperty);\r\n    if (this.sortOrder) q += '&sortOrder=' + encodeURIComponent(this.sortOrder);\r\n    return q;\r\n  }\r\n};\r\n\r\nlet kits = [];\r\nlet customers = [];\r\nlet kitsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (kitsLoaded && customersLoaded) openTransferKitDialog(kits, customers);\r\n}\r\n\r\nlet kitSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id, rootType: 'CUSTOMER', direction: 'FROM',\r\n    relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Diagnostickit']\r\n};\r\n\r\nassetService.findByQuery(kitSearchQuery).subscribe(\r\n  result => { kits = result; kitsLoaded = true; checkAndOpenDialog(); },\r\n  () => { kits = []; kitsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\n// NOTE: credentials come from your original snippet\r\nlet bearerToken = '';\r\nfetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n  method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n  body: JSON.stringify({ \"username\": \"belimo.api@pke-iot.expert\", \"password\": \"vfx3cvr@VMJ3bxk3urg\" })\r\n})\r\n  .then(resp => resp.json())\r\n  .then(loginData => {\r\n    bearerToken = loginData.token;\r\n    return fetch('https://cloud.pke-iot.expert/api/customers?pageSize=100&page=0', {\r\n      method: 'GET',\r\n      headers: { 'accept': 'application/json', 'X-Authorization': 'Bearer ' + bearerToken }\r\n    });\r\n  })\r\n  .then(resp2 => resp2.json())\r\n  .then(customersList => {\r\n    customers = customersList.data;\r\n    if (customer) customers = customers.filter(cust => cust.title !== customer);\r\n    customersLoaded = true; checkAndOpenDialog();\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching customers:\", error);\r\n    alert('Failed to fetch customers.');\r\n  });\r\n\r\nfunction openTransferKitDialog(kits, customers) {\r\n  customDialog.customDialog(htmlTemplate, TransferKitDialogController, { kits, customers }).subscribe();\r\n}\r\n\r\nfunction TransferKitDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.kits = data.kits || [];\r\n  vm.customers = data.customers || [];\r\n\r\n  vm.transferKitFormGroup = vm.fb.group({\r\n    kit: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n  vm.transferKitFormGroup.addControl('transferredProject', vm.fb.control({ value: '', disabled: true }));\r\n\r\n  vm.allDevices = [];\r\n  vm.devicesWithMeasurements = [];\r\n  vm.foundProject = null;\r\n  vm.projectMeasurements = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n     vm.measurementRenameMap = new Map();\r\n\r\n\r\n  const groupCache = new Map(); // key: ownerId|scope|name -> Observable(group)\r\n  function ensureGroup(ownerIdObj, scopeType, name) {\r\n    const key = ownerIdObj.id + '|' + scopeType + '|' + name;\r\n    if (groupCache.has(key)) return groupCache.get(key);\r\n\r\n    const obs = entityGroupService.getEntityGroupsByOwnerId(ownerIdObj.entityType, ownerIdObj.id, scopeType).pipe(\r\n      widgetContext.rxjs.switchMap(groups => {\r\n        let g = (groups || []).find(x => x.name === name);\r\n        if (g) return widgetContext.rxjs.of(g);\r\n        const payload = { type: scopeType, name, ownerId: ownerIdObj };\r\n        return entityGroupService.saveEntityGroup(payload).pipe(\r\n          // If backend races and says \"already exists\", re-fetch once\r\n          widgetContext.rxjs.catchError(err => {\r\n            if (err && err.status === 400) {\r\n              return entityGroupService.getEntityGroupsByOwnerId(ownerIdObj.entityType, ownerIdObj.id, scopeType).pipe(\r\n                widgetContext.rxjs.map(gs => (gs || []).find(x => x.name === name))\r\n              );\r\n            }\r\n            return widgetContext.rxjs.throwError(err);\r\n          })\r\n        );\r\n      }),\r\n      widgetContext.rxjs.shareReplay(1)\r\n    );\r\n    groupCache.set(key, obs);\r\n    return obs;\r\n  }\r\n\r\n  function addToGroupSafe(groupId, entityId) {\r\n    return entityGroupService.addEntitiesToEntityGroup(groupId, [entityId]).pipe(\r\n      widgetContext.rxjs.catchError(err => {\r\n        // tolerate duplicate-membership/409/400 responses\r\n        return widgetContext.rxjs.of(null);\r\n      })\r\n    );\r\n  }\r\n\r\n  function getProjectsGroup(owner)                { return ensureGroup(owner, 'ASSET',  'Projects'); }\r\n  function getMeasurementsGroup(owner)            { return ensureGroup(owner, 'ASSET',  'Measurements'); }\r\n  function getDiagnostickitsGroup(owner)          { return ensureGroup(owner, 'ASSET',  'Diagnostickits'); }\r\n  function getGatewaysGroup(owner)                { return ensureGroup(owner, 'DEVICE', 'Gateways'); }\r\n  function getDiagnostickitDevicesGroup(owner)    { return ensureGroup(owner, 'DEVICE', 'Diagnostickit Devices'); }\r\n  function getUnassignedMeasurementDevicesGroup(owner) { return ensureGroup(owner, 'DEVICE', 'Unassigned Measurement Devices'); }\r\n\r\n  vm.transferKitFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId, rootType: 'CUSTOMER', direction: 'FROM',\r\n          relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { vm.transferredProject = null; vm.customerShortName = null; }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null; vm.customerShortName = null;\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        if (vm.transferKitFormGroup.get('transferredMeasurement' + index)) {\r\n          vm.transferKitFormGroup.get('transferredMeasurement' + index).setValue('');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  vm.onKitSelected = function (event) {\r\n    let selectedKit = event.value;\r\n    vm.allDevices = [];\r\n    vm.devicesWithMeasurements = [];\r\n    vm.foundProject = null;\r\n    vm.projectMeasurements = [];\r\n\r\n    Object.keys(vm.transferKitFormGroup.controls)\r\n      .filter(n => n.startsWith('measurement') || n.startsWith('transferredMeasurement') || n.startsWith('device') || n.startsWith('transferredDevice'))\r\n      .forEach(n => vm.transferKitFormGroup.removeControl(n));\r\n    \r\n    let selectedCustomer = vm.transferKitFormGroup.get('customer').value;\r\n    if (!selectedKit || !selectedCustomer) {\r\n      console.warn(\"Kit or customer not selected yet.\");\r\n      return;\r\n    }\r\n    \r\n    let selectedKitId = selectedKit.id.id ? selectedKit.id.id : selectedKit.id;\r\n\r\n    let deviceSearchQuery = {\r\n      parameters: {\r\n        rootId: selectedKitId, rootType: 'ASSET', direction: 'FROM',\r\n        relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: true\r\n      },\r\n      relationType: 'Contains',\r\n      deviceTypes: ['P-Flow D116','Room Sensor CO2','Temperature Sensor','RESI','Gateway','LTE Status']\r\n    };\r\n    \r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n      devices => {\r\n        vm.allDevices = devices || [];\r\n        if (vm.allDevices.length === 0) return;\r\n\r\n        vm.allDevices.forEach((device, index) => {\r\n          vm.transferKitFormGroup.addControl('device' + index, vm.fb.control({ value: device.name, disabled: true }));\r\n          vm.transferKitFormGroup.addControl('transferredDevice' + index, vm.fb.control({ value: device.name, disabled: true }));\r\n        });\r\n\r\n        let measurementChecks = vm.allDevices.map(device => {\r\n          let measurementQuery = {\r\n            parameters: {\r\n              rootId: (device.id.id ? device.id.id : device.id), rootType: 'DEVICE', direction: 'TO',\r\n              relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: false\r\n            },\r\n            relationType: 'Measurement',\r\n            assetTypes: ['Measurement']\r\n          };\r\n          return assetService.findByQuery(measurementQuery).pipe(\r\n            widgetContext.rxjs.map(measurements => ({ device, measurements: measurements || [] }))\r\n          );\r\n        });\r\n\r\n        widgetContext.rxjs.forkJoin(measurementChecks).subscribe(\r\n          measurementResults => {\r\n            vm.devicesWithMeasurements = measurementResults.filter(r => r.measurements.length > 0);\r\n            let projectChecks = [];\r\n            vm.devicesWithMeasurements.forEach(item => {\r\n              item.measurements.forEach(meas => {\r\n                let projectQuery = {\r\n                  parameters: {\r\n                    rootId: (meas.id.id ? meas.id.id : meas.id), rootType: 'ASSET', direction: 'TO',\r\n                    relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: 'Owns',\r\n                  assetTypes: ['Project']\r\n                };\r\n                projectChecks.push(assetService.findByQuery(projectQuery).pipe(\r\n                  widgetContext.rxjs.map(projects => ({ measurement: meas, projects: projects || [] }))\r\n                ));\r\n              });\r\n            });\r\n            if (projectChecks.length === 0) return;\r\n\r\n            widgetContext.rxjs.forkJoin(projectChecks).subscribe(\r\n              projectResults => {\r\n                let found = projectResults.find(r => r.projects.length > 0);\r\n                if (found) {\r\n                  vm.foundProject = found.projects[0];\r\n                  if (!vm.transferKitFormGroup.get('foundProject')) {\r\n                    vm.transferKitFormGroup.addControl('foundProject', vm.fb.control({ value: vm.foundProject.name, disabled: true }));\r\n                  } else {\r\n                    vm.transferKitFormGroup.get('foundProject').setValue(vm.foundProject.name);\r\n                  }\r\n                  searchMeasurementsForProject(vm.foundProject);\r\n                }\r\n              },\r\n              err => console.error(\"Error during project queries:\", err)\r\n            );\r\n          },\r\n          err => console.error(\"Error in measurement checks:\", err)\r\n        );\r\n      },\r\n      err => console.error(\"Error finding devices for kit:\", err)\r\n    );\r\n  };\r\n\r\n  vm.onCustomerSelected = function () {\r\n    let kit = vm.transferKitFormGroup.get('kit').value;\r\n    if (kit) vm.onKitSelected({ value: kit });\r\n  };\r\n\r\n  function updateFoundProjectName(customerShortName, existingProjects) {\r\n    if (!customerShortName) return;\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) { maxNumericSuffix = parsedNum; }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    vm.transferredProject = candidate;\r\n    vm.transferKitFormGroup.get('transferredProject').setValue(candidate);\r\n  }\r\n\r\n  function renameProjectMeasurements() {\r\n    if (!vm.customerShortName) return;\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n      let newProjectNameCtrl = vm.transferKitFormGroup.get('transferredProject');\r\n      let oldName = measurement.name;\r\n      let parts = oldName.split('_');\r\n      let newName = newProjectNameCtrl.value + '_' + parts[2];\r\n      let control = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n      if (control) control.setValue(newName);\r\n    });\r\n  }\r\n\r\n  function searchMeasurementsForProject(project) {\r\n    let projectId = project.id.id ? project.id.id : project.id;\r\n    let projectMeasurementQuery = {\r\n      parameters: {\r\n        rootId: projectId, rootType: 'ASSET', direction: 'FROM',\r\n        relationTypeGroup: 'COMMON', maxLevel: 1073741824, fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Measurement']\r\n    };\r\n    assetService.findByQuery(projectMeasurementQuery).subscribe(\r\n      measurements => {\r\n        vm.projectMeasurements = measurements || [];\r\n        Object.keys(vm.transferKitFormGroup.controls)\r\n          .filter(n => n.startsWith('measurement') || n.startsWith('transferredMeasurement'))\r\n          .forEach(n => vm.transferKitFormGroup.removeControl(n));\r\n        (measurements || []).forEach((measurement, index) => {\r\n          vm.transferKitFormGroup.addControl('measurement' + index, vm.fb.control({ value: measurement.name, disabled: true }));\r\n          vm.transferKitFormGroup.addControl('transferredMeasurement' + index, vm.fb.control({ value: '', disabled: true }));\r\n        });\r\n        renameProjectMeasurements();\r\n      },\r\n      err => console.error(\"Error finding measurements for project:\", err)\r\n    );\r\n  }\r\n\r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      }),\r\n      widgetContext.rxjs.catchError(() => widgetContext.rxjs.of(null)) // tolerate if old relation missing\r\n    );\r\n  }\r\n\r\n  function getVrDevicesForDevice(deviceId) {\r\n    return entityRelationService.findByTo({ id: deviceId, entityType: 'DEVICE' }).pipe(\r\n      widgetContext.rxjs.map(rels =>\r\n        (rels || [])\r\n          .filter(r => r.typeGroup === 'COMMON' && r.type === 'VR' && r.from?.entityType === 'DEVICE')\r\n          .map(r => (r.from.id.id ? r.from.id.id : r.from.id)) // return VR device UUIDs\r\n      )\r\n    );\r\n  }\r\n\r\n  function computeNewVrName(oldVrName) {\r\n      const original = (oldVrName || '').trim();\r\n      if (!original) { \r\n        console.debug('[VR Rename] Empty VR name; skip');\r\n        return null;\r\n      }\r\n    \r\n      // 1) Primary: precise map-based rename (oldMeasName or oldMeasName_)\r\n      if (vm.measurementRenameMap && vm.measurementRenameMap.size > 0) {\r\n        const entries = Array.from(vm.measurementRenameMap.entries())\r\n          .sort((a, b) => b[0].length - a[0].length); // longest first\r\n    \r\n        for (const [oldMeasNameRaw, newMeasNameRaw] of entries) {\r\n          const oldMeas = String(oldMeasNameRaw || '').trim();\r\n          const newMeas = String(newMeasNameRaw || '').trim();\r\n          if (!oldMeas || !newMeas) continue;\r\n    \r\n          // exact match\r\n          if (original === oldMeas) {\r\n            const renamed = newMeas;\r\n            console.debug('[VR Rename] Exact match:', { original, oldMeas, newMeas, renamed });\r\n            return renamed;\r\n          }\r\n          // prefix match \"<oldMeas>_<suffix>\"\r\n          const prefix = oldMeas + '_';\r\n          if (original.startsWith(prefix)) {\r\n            const suffix = original.substring(prefix.length);\r\n            const renamed = newMeas + '_' + suffix;\r\n            console.debug('[VR Rename] Prefix match:', { original, oldMeas, newMeas, suffix, renamed });\r\n            return renamed;\r\n          }\r\n        }\r\n      } else {\r\n        console.debug('[VR Rename] Empty measurementRenameMap; will try ECO fallback for', original);\r\n      }\r\n    \r\n      // 2) Fallback: if we can’t match the old measurement name, but there is exactly ONE new measurement name,\r\n      //    replace everything BEFORE \"_ECO_\" with that name.\r\n      //    This gives:  \"<anything>_ECO_...\" -> \"<singleNewMeas>_ECO_...\"\r\n      const newNames = vm.measurementRenameMap ? Array.from(vm.measurementRenameMap.values()).map(v => String(v || '').trim()).filter(Boolean) : [];\r\n      if (newNames.length === 1) {\r\n        const soleNew = newNames[0];\r\n        // Typical delimiter in your VR naming: \"_ECO_\"\r\n        const ecoIdx = original.indexOf('_ECO_');\r\n        if (ecoIdx > 0) {\r\n          const suffixFromEco = original.substring(ecoIdx + 1); // keep \"ECO_...\"\r\n          const renamed = soleNew + '_' + suffixFromEco;\r\n          console.debug('[VR Rename] Fallback via _ECO_:',\r\n            { original, soleNew, suffixFromEco, renamed });\r\n          return renamed;\r\n        }\r\n        // If \"_ECO_\" is not present, as a safer generic fallback: replace up to the 3rd underscore (common in \"X_Y_Z_...\")\r\n        const parts = original.split('_');\r\n        if (parts.length >= 3) {\r\n          const suffix = parts.slice(3).join('_'); // keep everything after first 3 segments\r\n          const renamed = suffix ? (soleNew + '_' + suffix) : soleNew;\r\n          console.debug('[VR Rename] Fallback via 3-seg prefix:',\r\n            { original, soleNew, suffix, renamed });\r\n          return renamed;\r\n        }\r\n      }\r\n    \r\n      console.debug('[VR Rename] No matching rule for', original);\r\n      return null; // no rename\r\n    }\r\n\r\n\r\n\r\n\r\n  function transferVrDevice(vrDeviceId, newOwner, hasProjectMeasurements) {\r\n    return deviceService.getDevice(vrDeviceId).pipe(\r\n      widgetContext.rxjs.switchMap(vr => {\r\n        const maybeNewName = computeNewVrName(vr.name);\r\n        if (maybeNewName && maybeNewName !== vr.name) vr.name = maybeNewName;\r\n        return deviceService.saveDevice(vr).pipe(\r\n          widgetContext.rxjs.switchMap(updatedVr => {\r\n            const vrEntity = updatedVr.id && updatedVr.id.entityType\r\n              ? updatedVr.id\r\n              : { id: updatedVr.id, entityType: 'DEVICE' };\r\n\r\n            return entityGroupService.changeEntityOwner(newOwner, vrEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() =>\r\n                (updatedVr.type === 'Gateway VR')\r\n                  ? getGatewaysGroup(newOwner).pipe(\r\n                      widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, vrEntity.id))\r\n                    )\r\n                  : widgetContext.rxjs.of(null)\r\n              ),\r\n              widgetContext.rxjs.switchMap(() =>\r\n                (!hasProjectMeasurements)\r\n                  ? getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                      widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, vrEntity.id))\r\n                    )\r\n                  : widgetContext.rxjs.of(null)\r\n              )\r\n            );\r\n\r\n          })\r\n        );\r\n      })\r\n    );\r\n  }\r\n\r\n  function transferVrsForPhysicalDevice(physicalDeviceId, newOwner, hasProjectMeasurements) {\r\n    return getVrDevicesForDevice(physicalDeviceId).pipe(\r\n      widgetContext.rxjs.switchMap(vrIds => {\r\n        if (!vrIds || vrIds.length === 0) return widgetContext.rxjs.of(null);\r\n        const ops = vrIds.map(vrId => transferVrDevice(vrId, newOwner, hasProjectMeasurements));\r\n        return widgetContext.rxjs.forkJoin(ops);\r\n      })\r\n    );\r\n  }\r\n\r\n  vm.save = function () {\r\n    const formValue = vm.transferKitFormGroup.value;\r\n    const selectedCustomer = formValue.customer;\r\n    if (!selectedCustomer || !selectedCustomer.id) { console.warn('No customer selected.'); return; }\r\n\r\n    if (!vm.customerShortName) vm.customerShortName = selectedCustomer.title;\r\n    const selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n    const newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n\r\n    const saveObservables = [];\r\n    const hasProjectMeasurements = vm.foundProject || (vm.projectMeasurements && vm.projectMeasurements.length > 0);\r\n    const selectedKit = formValue.kit;\r\n    if (!selectedKit.name) { console.warn(\"Selected kit has no name. Aborting save.\"); return; }\r\n    \r\n      vm.measurementRenameMap = new Map();\r\n      if (Array.isArray(vm.projectMeasurements) && vm.projectMeasurements.length > 0) {\r\n        vm.projectMeasurements.forEach((measurement, index) => {\r\n          const ctrl = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n          const newName = ctrl ? String(ctrl.value || '').trim() : '';\r\n          const oldName = String(measurement.name || '').trim();\r\n          if (oldName && newName) {\r\n            vm.measurementRenameMap.set(oldName, newName);\r\n            console.debug('[VR Rename] map:', oldName, '→', newName);\r\n          }\r\n        });\r\n      } else {\r\n        console.debug('[VR Rename] No project measurements; VR renames may be skipped.');\r\n      }\r\n\r\n\r\n    const preEnsure$ = widgetContext.rxjs.forkJoin([\r\n      getDiagnostickitsGroup(newOwner),\r\n      getDiagnostickitDevicesGroup(newOwner),\r\n      getGatewaysGroup(newOwner),\r\n      getUnassignedMeasurementDevicesGroup(newOwner),\r\n      getProjectsGroup(newOwner),\r\n      getMeasurementsGroup(newOwner)\r\n    ]).pipe(widgetContext.rxjs.catchError(() => widgetContext.rxjs.of(null)));\r\n\r\n\r\n    preEnsure$.subscribe(() => {\r\n      // KIT\r\n      let kitSave$ = assetService.saveAsset(selectedKit).pipe(\r\n        widgetContext.rxjs.switchMap(updatedKit => {\r\n          let kitEntity = updatedKit.id && updatedKit.id.entityType ? updatedKit.id : { id: updatedKit.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n            widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, kitEntity)),\r\n            widgetContext.rxjs.switchMap(() =>\r\n              getDiagnostickitsGroup(newOwner).pipe(\r\n                widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, kitEntity.id))\r\n              )\r\n            )\r\n          );\r\n        })\r\n      );\r\n      saveObservables.push(kitSave$);\r\n\r\n\r\n      if (vm.foundProject) {\r\n        let project = vm.foundProject;\r\n        let candidate = (vm.transferredProject && vm.transferredProject.trim()) || ((vm.customerShortName || selectedCustomer.title) + '_Project_1');\r\n        vm.transferredProject = candidate;\r\n        project.name = candidate;\r\n        if (!project.type || !project.type.trim()) project.type = \"Project\";\r\n\r\n        let projectSave$ = assetService.saveAsset(project).pipe(\r\n          widgetContext.rxjs.switchMap(updatedProject => {\r\n            let projectEntity = updatedProject.id && updatedProject.id.entityType ? updatedProject.id : { id: updatedProject.id, entityType: 'ASSET' };\r\n            return entityGroupService.changeEntityOwner(newOwner, projectEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, projectEntity)),\r\n              widgetContext.rxjs.switchMap(() => getProjectsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, projectEntity.id))\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(projectSave$);\r\n      }\r\n\r\n\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        let newMeasurementName = vm.transferKitFormGroup.get('transferredMeasurement' + index).value;\r\n        if (!newMeasurementName || !newMeasurementName.trim()) return;\r\n\r\n        measurement.name = newMeasurementName.trim();\r\n        let measurementSave$ = assetService.saveAsset(measurement).pipe(\r\n          widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n            let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType ? updatedMeasurement.id : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n            return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, measurementEntity)),\r\n              widgetContext.rxjs.switchMap(() => getMeasurementsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, measurementEntity.id))\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(measurementSave$);\r\n      });\r\n\r\n\r\n      vm.allDevices.forEach((device, index) => {\r\n        let newDeviceName = vm.transferKitFormGroup.get('transferredDevice' + index).value;\r\n        if (!newDeviceName || !newDeviceName.trim()) return;\r\n        device.name = newDeviceName.trim();\r\n\r\n        let deviceSave$ = deviceService.saveDevice(device).pipe(\r\n          widgetContext.rxjs.switchMap(updatedDevice => {\r\n            const deviceEntity = updatedDevice.id && updatedDevice.id.entityType ? updatedDevice.id : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n            return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() =>\r\n                getDiagnostickitDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                )\r\n              ),\r\n              widgetContext.rxjs.switchMap(() => {\r\n                if (updatedDevice.type === 'RESI' || updatedDevice.type === 'Gateway') {\r\n                  return getGatewaysGroup(newOwner).pipe(\r\n                    widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                  );\r\n                }\r\n                return widgetContext.rxjs.of(null);\r\n              }),\r\n              widgetContext.rxjs.switchMap(() => {\r\n                if (!hasProjectMeasurements) {\r\n                  return getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                    widgetContext.rxjs.switchMap(group => addToGroupSafe(group.id.id, deviceEntity.id))\r\n                  );\r\n                }\r\n                return widgetContext.rxjs.of(null);\r\n              }),\r\n\r\n              widgetContext.rxjs.switchMap(() =>\r\n                transferVrsForPhysicalDevice(deviceEntity.id, newOwner, hasProjectMeasurements)\r\n              )\r\n            );\r\n          })\r\n        );\r\n        saveObservables.push(deviceSave$);\r\n      });\r\n\r\n      widgetContext.rxjs.forkJoin(saveObservables).subscribe(\r\n        () => { widgetContext.updateAliases(); vm.dialogRef.close(formValue); },\r\n        err => { console.error('Error updating assets:', err); }\r\n      );\r\n    });\r\n  };\r\n\r\n  vm.cancel = function () { vm.dialogRef.close(null); };\r\n}\r\n\r\n\r\n\r\n/*let injector = widgetContext.$scope.$injector;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet dialogs = injector.get(widgetContext.servicesMap.get('dialogs'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\nlet customerId, customer;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n  customer = widgetContext.stateController.getStateParams().entityName;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\nlet pageLink = {\r\n  pageSize: 100,\r\n  page: 0,\r\n  textSearch: '',\r\n  sortOrder: 'ASC',\r\n  sortProperty: 'title',\r\n  toQuery: function () {\r\n    let query = '?pageSize=' + this.pageSize + '&page=' + this.page;\r\n    if (this.textSearch) { query += '&textSearch=' + encodeURIComponent(this.textSearch); }\r\n    if (this.sortProperty) { query += '&sortProperty=' + encodeURIComponent(this.sortProperty); }\r\n    if (this.sortOrder) { query += '&sortOrder=' + encodeURIComponent(this.sortOrder); }\r\n    return query;\r\n  }\r\n};\r\n\r\nlet kits = [];\r\nlet customers = [];\r\nlet kitsLoaded = false;\r\nlet customersLoaded = false;\r\n\r\nfunction checkAndOpenDialog() {\r\n  if (kitsLoaded && customersLoaded) {\r\n    openTransferKitDialog(kits, customers);\r\n  }\r\n}\r\n\r\nlet kitSearchQuery = {\r\n  parameters: {\r\n    rootId: customerId.id,\r\n    rootType: 'CUSTOMER',\r\n    direction: 'FROM',\r\n    relationTypeGroup: 'COMMON',\r\n    maxLevel: 10,\r\n    fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes: ['Diagnostickit']\r\n};\r\n\r\nassetService.findByQuery(kitSearchQuery).subscribe(\r\n  result => { kits = result; kitsLoaded = true; checkAndOpenDialog(); },\r\n  () => { kits = []; kitsLoaded = true; checkAndOpenDialog(); }\r\n);\r\n\r\nlet bearerToken = '';\r\nfetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n  method: 'POST',\r\n  headers: {\r\n    'Content-Type': 'application/json'\r\n  },\r\n  body: JSON.stringify({\r\n    \"username\": \"belimo.api@pke-iot.expert\",\r\n    \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n  })\r\n})\r\n  .then(resp => resp.json())\r\n  .then(loginData => {\r\n    bearerToken = loginData.token;\r\n    return fetch('https://cloud.pke-iot.expert/api/customers?pageSize=100&page=0', {\r\n      method: 'GET',\r\n      headers: {\r\n        'accept': 'application/json',\r\n        'X-Authorization': 'Bearer ' + bearerToken\r\n      }\r\n    });\r\n  })\r\n  .then(resp2 => resp2.json())\r\n  .then(customersList => {\r\n    // Process the customers data here.\r\n    customers = customersList.data;\r\n    if (customer) { customers = customers.filter(cust => cust.title !== customer); }\r\n    customersLoaded = true;\r\n    checkAndOpenDialog();\r\n  })\r\n  .catch(error => {\r\n    console.error(\"Error fetching customers:\", error);\r\n    alert('Failed to fetch customers.');\r\n  });\r\n\r\n\r\nfunction openTransferKitDialog(kits, customers) {\r\n  customDialog.customDialog(htmlTemplate, TransferKitDialogController, {\r\n    kits: kits,\r\n    customers: customers\r\n  }).subscribe();\r\n}\r\n\r\nfunction TransferKitDialogController(instance) {\r\n  let vm = instance;\r\n  let data = vm.data || {};\r\n  vm.kits = data.kits || [];\r\n  vm.customers = data.customers || [];\r\n\r\n  vm.transferKitFormGroup = vm.fb.group({\r\n    kit: ['', [vm.validators.required]],\r\n    customer: ['', [vm.validators.required]]\r\n  });\r\n  vm.transferKitFormGroup.addControl('transferredProject', vm.fb.control({ value: '', disabled: true }));\r\n\r\n  vm.allDevices = [];\r\n  vm.devicesWithMeasurements = [];\r\n  vm.foundProject = null;\r\n  vm.projectMeasurements = [];\r\n  vm.customerShortName = null;\r\n  vm.transferredProject = null;\r\n\r\n  vm.transferKitFormGroup.get('customer').valueChanges.subscribe(selectedCustomer => {\r\n    if (selectedCustomer && selectedCustomer.id) {\r\n      let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n      let assetQuery = {\r\n        parameters: {\r\n          rootId: selectedCustomerId,\r\n          rootType: 'CUSTOMER',\r\n          direction: 'FROM',\r\n          relationTypeGroup: 'COMMON',\r\n          maxLevel: 10,\r\n          fetchLastLevelOnly: false\r\n        },\r\n        relationType: 'Owns',\r\n        assetTypes: ['Project']\r\n      };\r\n      assetService.findByQuery(assetQuery).subscribe(\r\n        existingProjects => {\r\n          let customerEntity = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n          attributeService.getEntityAttributes(customerEntity, 'SERVER_SCOPE', ['shortName']).subscribe(\r\n            attributes => {\r\n              let shortNameAttr = attributes.find(attr => attr.key === 'shortName');\r\n              vm.customerShortName = shortNameAttr ? shortNameAttr.value : selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            },\r\n            () => {\r\n              vm.customerShortName = selectedCustomer.title;\r\n              updateFoundProjectName(vm.customerShortName, existingProjects);\r\n            }\r\n          );\r\n        },\r\n        () => { \r\n          vm.transferredProject = null; \r\n          vm.customerShortName = null; \r\n        }\r\n      );\r\n    } else {\r\n      vm.transferredProject = null;\r\n      vm.customerShortName = null;\r\n      // Clear out the transferred measurements when no customer is selected.\r\n      vm.projectMeasurements.forEach((measurement, index) => {\r\n        if (vm.transferKitFormGroup.get('transferredMeasurement' + index)) {\r\n          vm.transferKitFormGroup.get('transferredMeasurement' + index).setValue('');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  vm.onKitSelected = function (event) {\r\n    let selectedKit = event.value;\r\n    vm.allDevices = [];\r\n    vm.devicesWithMeasurements = [];\r\n    vm.foundProject = null;\r\n    vm.projectMeasurements = [];\r\n\r\n    // Remove previous measurement and device controls.\r\n    Object.keys(vm.transferKitFormGroup.controls)\r\n      .filter(controlName => controlName.startsWith('measurement') ||\r\n                             controlName.startsWith('transferredMeasurement') ||\r\n                             controlName.startsWith('device') ||\r\n                             controlName.startsWith('transferredDevice'))\r\n      .forEach(controlName => {\r\n        vm.transferKitFormGroup.removeControl(controlName);\r\n      });\r\n    \r\n    let selectedCustomer = vm.transferKitFormGroup.get('customer').value;\r\n    if (!selectedKit || !selectedCustomer) {\r\n      console.warn(\"Kit or customer not selected yet.\");\r\n      return;\r\n    }\r\n    \r\n    let selectedKitId = selectedKit.id.id ? selectedKit.id.id : selectedKit.id;\r\n\r\n    let deviceSearchQuery = {\r\n      parameters: {\r\n        rootId: selectedKitId,\r\n        rootType: 'ASSET',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: true\r\n      },\r\n      relationType: 'Contains',\r\n      deviceTypes: [\r\n          'P-Flow D116',\r\n          'Room Sensor CO2',\r\n          'Temperature Sensor',\r\n          'RESI',\r\n          'Gateway',\r\n          'LTE Status'\r\n      ]\r\n    };\r\n    \r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n      devices => {\r\n        vm.allDevices = devices || [];\r\n        \r\n        if (vm.allDevices.length === 0) {\r\n          console.warn(\"No devices found in selected kit.\");\r\n          return;\r\n        }\r\n        // For each device, add two controls: one showing the original device name, and one for transferred device,\r\n        // which is automatically set to the same name as the found device.\r\n        vm.allDevices.forEach((device, index) => {\r\n          vm.transferKitFormGroup.addControl(\r\n            'device' + index,\r\n            vm.fb.control({ value: device.name, disabled: true })\r\n          );\r\n          vm.transferKitFormGroup.addControl(\r\n            'transferredDevice' + index,\r\n            vm.fb.control({ value: device.name, disabled: true })\r\n          );\r\n        });\r\n\r\n        let measurementChecks = vm.allDevices.map(device => {\r\n          let measurementQuery = {\r\n            parameters: {\r\n              rootId: (device.id.id ? device.id.id : device.id),\r\n              rootType: 'DEVICE',\r\n              direction: 'TO',\r\n              relationTypeGroup: 'COMMON',\r\n              maxLevel: 1073741824,\r\n              fetchLastLevelOnly: false\r\n            },\r\n            relationType: 'Measurement',\r\n            assetTypes: ['Measurement']\r\n          };\r\n          return assetService.findByQuery(measurementQuery).pipe(\r\n            widgetContext.rxjs.map(measurements => {\r\n              return { device: device, measurements: measurements || [] };\r\n            })\r\n          );\r\n        });\r\n        widgetContext.rxjs.forkJoin(measurementChecks).subscribe(\r\n          measurementResults => {\r\n            vm.devicesWithMeasurements = measurementResults.filter(r => r.measurements.length > 0);\r\n            let projectChecks = [];\r\n            vm.devicesWithMeasurements.forEach(item => {\r\n              item.measurements.forEach(meas => {\r\n                let projectQuery = {\r\n                  parameters: {\r\n                    rootId: (meas.id.id ? meas.id.id : meas.id),\r\n                    rootType: 'ASSET',\r\n                    direction: 'TO',\r\n                    relationTypeGroup: 'COMMON',\r\n                    maxLevel: 10,\r\n                    fetchLastLevelOnly: false\r\n                  },\r\n                  relationType: 'Owns',\r\n                  assetTypes: ['Project']\r\n                };\r\n                projectChecks.push(\r\n                  assetService.findByQuery(projectQuery).pipe(\r\n                    widgetContext.rxjs.map(projects => {\r\n                      return { measurement: meas, projects: projects || [] };\r\n                    })\r\n                  )\r\n                );\r\n              });\r\n            });\r\n            if (projectChecks.length === 0) {\r\n              return;\r\n            }\r\n            widgetContext.rxjs.forkJoin(projectChecks).subscribe(\r\n              projectResults => {\r\n                let found = projectResults.find(r => r.projects.length > 0);\r\n                if (found) {\r\n                  vm.foundProject = found.projects[0];\r\n                  if (!vm.transferKitFormGroup.get('foundProject')) {\r\n                    vm.transferKitFormGroup.addControl(\r\n                      'foundProject',\r\n                      vm.fb.control({ value: vm.foundProject.name, disabled: true })\r\n                    );\r\n                  } else {\r\n                    vm.transferKitFormGroup.get('foundProject').setValue(vm.foundProject.name);\r\n                  }\r\n                  searchMeasurementsForProject(vm.foundProject);\r\n                }\r\n              },\r\n              err => {\r\n                console.error(\"Error during project queries:\", err);\r\n              }\r\n            );\r\n          },\r\n          err => {\r\n            console.error(\"Error in measurement checks:\", err);\r\n          }\r\n        );\r\n      },\r\n      err => {\r\n        console.error(\"Error finding devices for kit:\", err);\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.onCustomerSelected = function (event) {\r\n    let kit = vm.transferKitFormGroup.get('kit').value;\r\n    if (kit) {\r\n      vm.onKitSelected({ value: kit });\r\n    }\r\n  };\r\n\r\n  function updateFoundProjectName(customerShortName, existingProjects) {\r\n    if (!customerShortName) {\r\n      console.warn(\"Customer short name is not defined.\");\r\n      return;\r\n    }\r\n    let base = customerShortName + '_';\r\n    let existingNames = existingProjects.map(p => p.name);\r\n    let maxNumericSuffix = 0;\r\n    existingNames.forEach(name => {\r\n      if (name.startsWith(base)) {\r\n        let suffixPart = name.substring(base.length);\r\n        let parsedNum = parseInt(suffixPart, 10);\r\n        if (!isNaN(parsedNum) && parsedNum > maxNumericSuffix) {\r\n          maxNumericSuffix = parsedNum;\r\n        }\r\n      }\r\n    });\r\n    let candidate = base + (maxNumericSuffix + 1);\r\n    vm.transferredProject = candidate;\r\n    vm.transferKitFormGroup.get('transferredProject').setValue(candidate);\r\n    // Device names remain as set.\r\n  }\r\n\r\n  function renameProjectMeasurements() {\r\n    if (!vm.customerShortName) {\r\n      console.warn(\"Customer short name not set. Skipping measurement rename.\");\r\n      return;\r\n    }\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n    let newProjectName = vm.transferKitFormGroup.get('transferredProject');\r\n      let oldName = measurement.name;\r\n      let parts = oldName.split('_');\r\n      let newName = newProjectName.value + '_' + parts[2];\r\n      let control = vm.transferKitFormGroup.get('transferredMeasurement' + index);\r\n      if (control) {\r\n        control.setValue(newName);\r\n      }\r\n    });\r\n  }\r\n\r\n  function searchMeasurementsForProject(project) {\r\n    let projectId = project.id.id ? project.id.id : project.id;\r\n    let projectMeasurementQuery = {\r\n      parameters: {\r\n        rootId: projectId,\r\n        rootType: 'ASSET',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Measurement']\r\n    };\r\n    assetService.findByQuery(projectMeasurementQuery).subscribe(\r\n      measurements => {\r\n        vm.projectMeasurements = measurements || [];\r\n\r\n        // Remove old measurement controls.\r\n        Object.keys(vm.transferKitFormGroup.controls)\r\n          .filter(controlName => controlName.startsWith('measurement') ||\r\n                                 controlName.startsWith('transferredMeasurement'))\r\n          .forEach(controlName => {\r\n            vm.transferKitFormGroup.removeControl(controlName);\r\n          });\r\n\r\n        (measurements || []).forEach((measurement, index) => {\r\n          vm.transferKitFormGroup.addControl(\r\n            'measurement' + index,\r\n            vm.fb.control({ value: measurement.name, disabled: true })\r\n          );\r\n          // Create transferred measurement control as disabled.\r\n          vm.transferKitFormGroup.addControl(\r\n            'transferredMeasurement' + index,\r\n            vm.fb.control({ value: '', disabled: true })\r\n          );\r\n        });\r\n\r\n        renameProjectMeasurements();\r\n      },\r\n      err => {\r\n        console.error(\"Error finding measurements for project:\", err);\r\n      }\r\n    );\r\n  }\r\n\r\n  function updateEntityRelation(newOwner, asset) {\r\n    return entityRelationService.deleteRelation(customerId, 'Owns', asset).pipe(\r\n      widgetContext.rxjs.switchMap(() => {\r\n        let newRelation = { from: newOwner, to: asset, type: 'Owns', typeGroup: 'COMMON' };\r\n        return entityRelationService.saveRelation(newRelation);\r\n      })\r\n    );\r\n  }\r\n  \r\n  // --- Group helper functions ---\r\n    function getProjectsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let projectsGroup = groups.find(g => g.name === 'Projects');\r\n          if (projectsGroup) {\r\n            return widgetContext.rxjs.of(projectsGroup);\r\n          } else {\r\n            projectsGroup = { type: 'ASSET', name: 'Projects', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(projectsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getMeasurementsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let measurementsGroup = groups.find(g => g.name === 'Measurements');\r\n          if (measurementsGroup) {\r\n            return widgetContext.rxjs.of(measurementsGroup);\r\n          } else {\r\n            measurementsGroup = { type: 'ASSET', name: 'Measurements', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(measurementsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    function getDiagnostickitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let kitsGroup = groups.find(g => g.name === 'Diagnostickits');\r\n          if (kitsGroup) {\r\n            return widgetContext.rxjs.of(kitsGroup);\r\n          } else {\r\n            kitsGroup = { type: 'ASSET', name: 'Diagnostickits', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(kitsGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    // Modified getGatewaysGroup: Removed the type check\r\n    function getGatewaysGroup(customerId, updatedDevice) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let devicesGroup = groups.find(g => g.name === 'Gateways');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = { type: 'DEVICE', name: 'Gateways', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n    \r\n    function getDiagnostickitDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let devicesGroup = groups.find(g => g.name === 'Diagnostickit Devices');\r\n          if (devicesGroup) {\r\n            return widgetContext.rxjs.of(devicesGroup);\r\n          } else {\r\n            devicesGroup = { type: 'DEVICE', name: 'Diagnostickit Devices', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(devicesGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n    \r\n    \r\n    function getUnassignedMeasurementDevicesGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          let unassignedGroup = groups.find(g => g.name === 'Unassigned Measurement Devices');\r\n          if (unassignedGroup) {\r\n            return widgetContext.rxjs.of(unassignedGroup);\r\n          } else {\r\n            unassignedGroup = { type: 'DEVICE', name: 'Unassigned Measurement Devices', ownerId: customerId };\r\n            return entityGroupService.saveEntityGroup(unassignedGroup);\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n  vm.save = function () {\r\n    let formValue = vm.transferKitFormGroup.value;\r\n    let selectedCustomer = formValue.customer;\r\n    if (!selectedCustomer || !selectedCustomer.id) {\r\n      console.warn('No customer selected.');\r\n      return;\r\n    }\r\n\r\n    if (!vm.customerShortName) {\r\n      vm.customerShortName = selectedCustomer.title;\r\n    }\r\n    let selectedCustomerId = selectedCustomer.id.id ? selectedCustomer.id.id : selectedCustomer.id;\r\n    let newOwner = { id: selectedCustomerId, entityType: 'CUSTOMER' };\r\n\r\n    let saveObservables = [];\r\n    \r\n    let hasProjectMeasurements = vm.foundProject || (vm.projectMeasurements && vm.projectMeasurements.length > 0);\r\n    \r\n    let selectedKit = formValue.kit;\r\n    if (!selectedKit.name) {\r\n      console.warn(\"Selected kit has no name. Aborting save.\");\r\n      return;\r\n    }\r\n    let kitSave$ = assetService.saveAsset(selectedKit).pipe(\r\n      widgetContext.rxjs.switchMap(updatedKit => {\r\n        let kitEntity = updatedKit.id && updatedKit.id.entityType \r\n                          ? updatedKit.id \r\n                          : { id: updatedKit.id, entityType: 'ASSET' };\r\n        return entityGroupService.changeEntityOwner(newOwner, kitEntity).pipe(\r\n            widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, kitEntity)),\r\n            // Always assign to Diagnostickits group\r\n            widgetContext.rxjs.switchMap(() => \r\n              getDiagnostickitsGroup(newOwner).pipe(\r\n                widgetContext.rxjs.switchMap(group => \r\n                  entityGroupService.addEntitiesToEntityGroup(group.id.id, [kitEntity.id])\r\n                )\r\n              )\r\n            ),\r\n            // If no project/measurements, also add to Unassigned Kit Group\r\n         );\r\n      })\r\n    );\r\n    saveObservables.push(kitSave$);\r\n\r\n    if (vm.foundProject) {\r\n      let project = vm.foundProject;\r\n      let candidate = vm.transferredProject && vm.transferredProject.trim();\r\n      if (!candidate) {\r\n        console.warn(\"Transferred project name was empty.\");\r\n        candidate = (vm.customerShortName || selectedCustomer.title) + '_Project_1';\r\n        formValue.transferredProject = candidate;\r\n        console.warn(\"Using fallback: \" + candidate);\r\n      }\r\n      project.name = candidate;\r\n      if (!project.type || project.type.trim() === \"\") {\r\n        project.type = \"Project\";\r\n      }\r\n      let projectSave$ = assetService.saveAsset(project).pipe(\r\n        widgetContext.rxjs.switchMap(updatedProject => {\r\n          let projectEntity = updatedProject.id && updatedProject.id.entityType \r\n                              ? updatedProject.id \r\n                              : { id: updatedProject.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, projectEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, projectEntity)),\r\n              widgetContext.rxjs.switchMap(() => getProjectsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(projectsGroup =>\r\n                entityGroupService.addEntitiesToEntityGroup(projectsGroup.id.id, [projectEntity.id])\r\n              )\r\n            );\r\n        })\r\n      );\r\n      saveObservables.push(projectSave$);\r\n    }\r\n\r\n    vm.projectMeasurements.forEach((measurement, index) => {\r\n      let newMeasurementName = vm.transferKitFormGroup.get('transferredMeasurement' + index).value;\r\n      if (!newMeasurementName || newMeasurementName.trim() === \"\") {\r\n        console.warn(`New name for measurement at index ${index} is empty. Skipping update.`);\r\n        return;\r\n      }\r\n      measurement.name = newMeasurementName.trim();\r\n      let measurementSave$ = assetService.saveAsset(measurement).pipe(\r\n        widgetContext.rxjs.switchMap(updatedMeasurement => {\r\n          let measurementEntity = updatedMeasurement.id && updatedMeasurement.id.entityType \r\n                                  ? updatedMeasurement.id \r\n                                  : { id: updatedMeasurement.id, entityType: 'ASSET' };\r\n          return entityGroupService.changeEntityOwner(newOwner, measurementEntity).pipe(\r\n              widgetContext.rxjs.switchMap(() => updateEntityRelation(newOwner, measurementEntity)),\r\n              widgetContext.rxjs.switchMap(() => getMeasurementsGroup(newOwner)),\r\n              widgetContext.rxjs.switchMap(measurementsGroup =>\r\n                entityGroupService.addEntitiesToEntityGroup(measurementsGroup.id.id, [measurementEntity.id])\r\n              )\r\n            );\r\n        })\r\n      );\r\n      saveObservables.push(measurementSave$);\r\n    });\r\n\r\n    // For each device, update its name with the value from the transferred device control.\r\n    // In the vm.save function, within the device update chain:\r\n    vm.allDevices.forEach((device, index) => {\r\n      let newDeviceName = vm.transferKitFormGroup.get('transferredDevice' + index).value;\r\n      if (!newDeviceName || newDeviceName.trim() === \"\") {\r\n        console.warn(`New name for device at index ${index} is empty. Skipping update.`);\r\n        return;\r\n      }\r\n      device.name = newDeviceName.trim();\r\n      let deviceSave$ = deviceService.saveDevice(device).pipe(\r\n        widgetContext.rxjs.switchMap(updatedDevice => {\r\n          let deviceEntity = updatedDevice.id && updatedDevice.id.entityType \r\n                             ? updatedDevice.id \r\n                             : { id: updatedDevice.id, entityType: 'DEVICE' };\r\n          return entityGroupService.changeEntityOwner(newOwner, deviceEntity).pipe(\r\n            // Always assign to Diagnostickit Devices group\r\n            widgetContext.rxjs.switchMap(() => {\r\n              return getDiagnostickitDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(devicesGroup =>\r\n                    entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n            }\r\n            ),\r\n            // Conditionally assign to Gateways group if updatedDevice.type is 'RESI' or 'Gateway'\r\n            widgetContext.rxjs.switchMap(() => {\r\n              if (updatedDevice.type === 'RESI' || updatedDevice.type === 'Gateway') {\r\n                return getGatewaysGroup(newOwner, updatedDevice).pipe(\r\n                  widgetContext.rxjs.switchMap(devicesGroup =>\r\n                    entityGroupService.addEntitiesToEntityGroup(devicesGroup.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n              } else {\r\n                return widgetContext.rxjs.of(null);\r\n              }\r\n            }),\r\n            // Additionally, if no project/measurements exist, assign to Unassigned Measurement Devices\r\n            widgetContext.rxjs.switchMap(() => {\r\n              if (!hasProjectMeasurements) {\r\n                return getUnassignedMeasurementDevicesGroup(newOwner).pipe(\r\n                  widgetContext.rxjs.switchMap(group =>\r\n                    entityGroupService.addEntitiesToEntityGroup(group.id.id, [deviceEntity.id])\r\n                  )\r\n                );\r\n              } else {\r\n                return widgetContext.rxjs.of(null);\r\n              }\r\n            })\r\n          );\r\n        })\r\n      );\r\n      saveObservables.push(deviceSave$);\r\n    });\r\n\r\n\r\n    widgetContext.rxjs.forkJoin(saveObservables).subscribe(\r\n      () => {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(formValue);\r\n      },\r\n      err => {\r\n        console.error('Error updating assets:', err);\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n}\r\n*/",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "20030896-36ba-fa5d-814d-09bac156d398"
              },
              {
                "name": "Refresh",
                "icon": "refresh",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "3218fb1e-c187-8197-670e-0ffb20e33283"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "d2cec1c0-f9bb-1c7c-25ae-ea8853bc3b7e",
        "typeFullFqn": "system.cards.entities_table"
      },
      "c779ff45-4c69-b749-51b0-400f54ebf350": {
        "typeFullFqn": "system.cards.entities_table",
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1713435502260,
                "endTimeMs": 1713521902260
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Kit Devices",
            "enableSearch": true,
            "enableSelectColumnDisplay": true,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": true,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "Label",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "name",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Entities table",
          "dropShadow": true,
          "enableFullscreen": true,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "d13f6078-0d81-ec59-529c-64acbbcaf470",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "active",
                  "type": "attribute",
                  "label": "{i18n:custom.kit-device.active}",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar active = value;\r\nif (active == 'true') { // all key values here are strings\r\n  color = '#27AE60';\r\n} else {\r\n  color = '#EB5757';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span>';\r\n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.8128568406469565,
                  "decimals": 0,
                  "aggregationType": null,
                  "units": null,
                  "funcBody": null,
                  "usePostProcessing": false,
                  "postFuncBody": null
                },
                {
                  "name": "state",
                  "type": "attribute",
                  "label": "{i18n:custom.kit-device.state}",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.2732149466989249,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "type",
                  "type": "entityField",
                  "label": "{i18n:custom.kit-device.type}",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.41194127454705587,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "displayTimewindow": false,
          "configMode": "advanced",
          "actions": {
            "actionCellButton": [
              {
                "name": "{i18n:custom.kit-device.remove-device-from-diagnostic-kit}",
                "icon": "remove_circle",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenRemoveDeviceDialog();\n\nfunction openRemoveDeviceDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.kit-device.remove.device.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.kit-device.remove.device.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('custom.kit-device.remove-device')\n  ).subscribe(function(result) {\n    if (result) {\n      doRemoveDevice();\n    }\n  });\n}\n\nfunction doRemoveDevice() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var DoktorkitId = widgetContext.stateController.getStateParams().selectedDoktorkit.entityId;\n  removeDevice(entityId, DoktorkitId, customerId).subscribe(() => {\n      widgetContext.updateAliases();\n  });\n}\n\nfunction removeDevice(deviceId, DoktorkitId, customerId) {\n    return getUnassignedDevicesGroup(customerId).pipe(\n        widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n            return widgetContext.rxjs.forkJoin([\n                entityGroupService.addEntityToEntityGroup(unassignedDevicesGroup.id.id, deviceId.id),\n                deleteDoktorkitToDeviceRelation(DoktorkitId, deviceId),\n                removePositionAttributes(deviceId)\n            ]);\n        })\n    );\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Diagnostickit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Diagnostickit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDoktorkitToDeviceRelation(DoktorkitId, deviceId) {\n    return entityRelationService.deleteRelation(DoktorkitId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(deviceId) {\n    return attributeService.deleteEntityAttributes(deviceId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "09f01c72-16c1-8d80-accd-ce150e7ae0be"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.kit-device.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n\r\n/*params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten*/\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e79e8b0e-bcf5-cb52-675f-55495e280f04"
              },
              {
                "name": "{i18n:custom.kit-device.assign-device}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDeviceFormGroup\"\r\n      (ngSubmit)=\"save()\"  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 800px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.kit-device.assign-device' | translate }}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <mat-horizontal-stepper formGroupName=\"stepper\" linear>\r\n      <mat-step formGroupName=\"assignmentStep\" label=\"Assignment\">\r\n        <ng-template matStepLabel>{{ 'custom.kit-device.assignment' | translate }}</ng-template>\r\n        <fieldset *ngIf=\"pFlowLimit || CO2Limit\" class=\"fieldset\" style=\"margin-bottom: 16px;\">\r\n          <div class=\"flex flex-col gap-0 sm:gap-2\">\r\n            <div class=\"flex flex-row justify-start items-center\">\r\n              <mat-icon *ngIf=\"pFlowLimit\" style=\"margin-right: 8px;\">info</mat-icon>\r\n              <p *ngIf=\"pFlowLimit\" style=\"font-size: 15px; margin: 0;\">\r\n                {{ 'custom.kit-device.max-p-flows-reached' | translate }}\r\n              </p>\r\n            </div>\r\n            <div class=\"flex flex-row justify-start items-center\">\r\n              <mat-icon *ngIf=\"CO2Limit\" style=\"margin-right: 8px;\">info</mat-icon>\r\n              <p *ngIf=\"CO2Limit\" style=\"font-size: 15px; margin: 0;\">\r\n                {{ 'custom.kit-device.max-co2-sensors-reached' | translate }}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </fieldset>\r\n\r\n\r\n\r\n        <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n          <mat-label>{{ 'custom.kit-device.device' | translate }}</mat-label>\r\n          <input type=\"text\"\r\n                 matInput\r\n                 formControlName=\"device\"\r\n                 [matAutocomplete]=\"auto\"\r\n                 (keyup)=\"filterDevices()\"\r\n                 (focus)=\"resetFilter()\"\r\n                 required>\r\n          <mat-autocomplete #auto=\"matAutocomplete\" [displayWith]=\"displayDevice\">\r\n            <mat-option *ngFor=\"let device of filteredDevices\" [value]=\"device\">\r\n              <div class=\"device-item\" fxLayout=\"column\" fxLayoutGap=\"4px\">\r\n                <div fxLayout=\"row\">\r\n                  <div>{{ device?.name }}</div>\r\n                </div>\r\n                <div fxLayout=\"row\" fxLayoutAlign=\"space-between center\">\r\n                  <div class=\"device-type\">{{ device?.type }}</div>\r\n                  <div class=\"device-label\">{{ device?.label }}</div>\r\n                </div>\r\n              </div>\r\n              <mat-divider></mat-divider>\r\n            </mat-option>\r\n          </mat-autocomplete>\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').hasError('required')\">\r\n            {{ 'custom.kit-device.device-is-required' | translate }}\r\n          </mat-error>\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').hasError('invalidDevice')\">\r\n            {{ 'custom.kit-device.select-valid-device' | translate }}\r\n          </mat-error>\r\n        </mat-form-field>\r\n\r\n\r\n\r\n\r\n        <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n          <mat-label>Label</mat-label>\r\n          <input matInput formControlName=\"label\">\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.label').hasError('required')\">\r\n            {{ 'custom.kit-device.device-label-required' | translate }}\r\n          </mat-error>\r\n        </mat-form-field>\r\n\r\n        <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n          <button mat-button color=\"primary\"\r\n                  type=\"button\"\r\n                  [disabled]=\"(isLoading$ | async)\"\r\n                  (click)=\"cancel()\" cdkFocusInitial>\r\n            {{ 'action.cancel' | translate }}\r\n          </button>\r\n          <button mat-button mat-raised-button color=\"primary\"\r\n                  type=\"submit\"\r\n                  [disabled]=\"(isLoading$ | async) || addDeviceFormGroup.invalid\">\r\n            {{ 'action.save' | translate }}\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>",
                "customCss": "\n.device-item {\n    line-height: 24px;\n    width: 100%;\n    padding-top: 8px;\n    padding-bottom: 8px;\n}\n\n.device-item .device-name {\n    font-size: 12px;\n    opacity: 0.7;\n}\n\n.device-item .device-type {\n    font-size: 14px;\n    opacity: 0.7;\n}\n\nmat-option {\n    height: auto !important;\n    white-space: normal !important;\n}\n\n.mat-select-value-text {\n    display: block;\n    width: 100%;\n}\n\n/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\n\r\nconst doktorkitId = widgetContext.stateController.getStateParams()?.selectedDoktorkit?.entityId;\r\n\r\nif (!doktorkitId || !doktorkitId.id) {\r\n    console.error(\"Ungültige doktorkitId:\", doktorkitId);\r\n} else {\r\n    checkAssignedDevices(doktorkitId.id);\r\n}\r\n\r\nfunction checkAssignedDevices(doktorkitId) {\r\n    const deviceSearchQuery = {\r\n        parameters: {\r\n            rootId: doktorkitId,\r\n            rootType: \"ASSET\",\r\n            direction: \"FROM\",\r\n            relationTypeGroup: \"COMMON\",\r\n            maxLevel: 100,\r\n            fetchLastLevelOnly: false,\r\n        },\r\n        relationType: \"Contains\",\r\n        deviceTypes: [\"P-Flow D116\", \"Room Sensor CO2\", \"LTE Status\"]\r\n    };\r\n\r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n        (devices) => {\r\n            let maxLimitPFlows = false;\r\n            let maxLimitRoomSensorCO2 = false;\r\n\r\n            const pFlows = devices.filter(device => device.type === \"P-Flow D116\");\r\n            const roomSensorCO2 = devices.filter(device => device.type === \"Room Sensor CO2\");\r\n            \r\n            /*console.log(devices);*/\r\n            if (pFlows.length > 99) {\r\n                maxLimitPFlows = true;\r\n            }\r\n            if (roomSensorCO2.length > 99) {\r\n                maxLimitRoomSensorCO2 = true;\r\n            }\r\n\r\n            openAddDeviceDialog(maxLimitPFlows, maxLimitRoomSensorCO2);\r\n        },\r\n        (error) => {\r\n            console.error(\"Fehler beim Abrufen der Geräte:\", error);\r\n            openAddDeviceDialog(false, false);\r\n        }\r\n    );\r\n}\r\n\r\n/*if (additionalParams.source === \"replace Device\") {\r\n    if (additionalParams.choice === true) {\r\n        openAddDeviceDialog();\r\n    } else {\r\n        // Handle other cases if needed\r\n    }\r\n} else if (additionalParams.source !== \"replace Device\") {\r\n    openAddDeviceDialog();\r\n}*/\r\n\r\nfunction openAddDeviceDialog(maxLimitPFlows, maxLimitRoomSensorCO2) {\r\n    customDialog.customDialog(htmlTemplate, AddDeviceDialogController, {\r\n        doktorkitId,\r\n        maxLimitPFlows,\r\n        maxLimitRoomSensorCO2,\r\n    }).subscribe();\r\n}\r\n\r\nfunction AddDeviceDialogController(instance) {\r\n    let vm = instance;\r\n    const {\r\n        doktorkitId,\r\n        maxLimitPFlows,\r\n        maxLimitRoomSensorCO2,\r\n    } = vm.data || {};\r\n    \r\n    vm.pFlowLimit = !!maxLimitPFlows;\r\n    vm.CO2Limit = !!maxLimitRoomSensorCO2;\r\n    \r\n    function deviceSelectionValidator(control) {\r\n       if (!control.value) {\r\n            return null;\r\n       }\r\n       return (typeof control.value === 'object' && control.value !== null)\r\n         ? null\r\n         : { invalidDevice: true };\r\n    }\r\n    \r\n    vm.addDeviceFormGroup = vm.fb.group({\r\n        stepper: vm.fb.group({\r\n            assignmentStep: vm.fb.group({\r\n                device: [null, [vm.validators.required, deviceSelectionValidator]],\r\n                label: [{ value: null, disabled: false }]\r\n            })\r\n        })\r\n    });\r\n\r\n    // Define the displayDevice function for mat-autocomplete\r\n    vm.displayDevice = function(device) {\r\n        return device ? `${device.label} - ${device.name} (${device.type})` : '';\r\n    };\r\n    \r\n     vm.filterDevices = function () {\r\n        const searchValue = vm.addDeviceFormGroup.get('stepper.assignmentStep.device').value;\r\n        const filterValue = (typeof searchValue === 'string' ? searchValue.toLowerCase() : '');\r\n        \r\n        if (!filterValue) {\r\n            vm.filteredDevices = vm.availableDevices.slice();\r\n            return;\r\n        }\r\n    \r\n        vm.filteredDevices = vm.availableDevices.filter(device =>\r\n            device.name.toLowerCase().includes(filterValue) || \r\n            device.label.toLowerCase().includes(filterValue) ||\r\n            device.type.toLowerCase().includes(filterValue)\r\n        );\r\n    };\r\n    \r\n    vm.resetFilter = function () {\r\n        vm.filteredDevices = vm.availableDevices.slice();\r\n    };\r\n    \r\n    vm.addDeviceFormGroup.get('stepper.assignmentStep.device').valueChanges.subscribe(value => {\r\n        if (typeof value === 'string') {\r\n            // While typing, just disable the label field without clearing the device\r\n            vm.addDeviceFormGroup.get('stepper.assignmentStep.label').disable();\r\n        } else if (value) {\r\n            vm.addDeviceFormGroup.get('stepper.assignmentStep.label').enable();\r\n            vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { label: value.label } } }, { emitEvent: false });\r\n        }\r\n    });\r\n\r\n    \r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        var DoktorkitId = widgetContext.stateController.getStateParams().selectedDoktorkit.entityId;\r\n        vm.addDeviceFormGroup.markAsPristine();\r\n        var device = vm.addDeviceFormGroup.value.stepper.assignmentStep.device;\r\n        var label = vm.addDeviceFormGroup.value.stepper.assignmentStep.label;\r\n        var deviceId = device.deviceId;\r\n        \r\n        widgetContext.rxjs.forkJoin([\r\n            entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n            saveDeviceToDoktorkitRelation(DoktorkitId, deviceId),\r\n            updateDeviceLabel(device, label)\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedDevicesGroup = null;\r\n        vm.assignedDevicesGroup = null;\r\n        vm.allDevices = [];\r\n        vm.availableDevices = [];\r\n        vm.filteredDevices = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'DEVICE').subscribe((entityGroups) => {\r\n            vm.customerDevicesGroups = entityGroups;\r\n            vm.unassignedDevicesGroup = entityGroups.find(group => group.name === 'Unassigned Diagnostickit Devices');\r\n            vm.assignedDevicesGroup = entityGroups.find(group => group.name === 'Diagnostickit Devices');\r\n            if (vm.unassignedDevicesGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.unassignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    vm.allDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            deviceId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                    \r\n                    if (maxLimitPFlows === true) {\r\n                        vm.allDevices = vm.allDevices.filter(device => device.type !== \"P-Flow D116\");\r\n                    }\r\n                    \r\n                    /*console.log(\"limit sensor:\", maxLimitRoomSensorCO2);*/\r\n                    if (maxLimitRoomSensorCO2 === true) {\r\n                        vm.allDevices = vm.allDevices.filter(device => device.type !== \"Room Sensor CO2\");\r\n                    }\r\n                    \r\n                    vm.availableDevices = vm.allDevices;\r\n\r\n                    // Initialize filteredDevices\r\n                    vm.addDeviceFormGroup.get('stepper.assignmentStep.device').valueChanges\r\n                        .pipe(\r\n                            widgetContext.rxjs.startWith(''),\r\n                            widgetContext.rxjs.map(value => typeof value === 'string' ? value : value?.name),\r\n                            widgetContext.rxjs.map(name => name ? filterDevices(name) : vm.availableDevices.slice())\r\n                        )\r\n                        .subscribe(filtered => {\r\n                            vm.filteredDevices = filtered;\r\n                        });\r\n                    // Subscribe to value changes to update the label field\r\n                    vm.addDeviceFormGroup.get('stepper.assignmentStep.device').valueChanges.subscribe(value => {\r\n                        if (typeof value === 'string') {\r\n                            // Just disable the label field while typing\r\n                            vm.addDeviceFormGroup.get('stepper.assignmentStep.label').disable();\r\n                        } else if (value) {\r\n                            vm.addDeviceFormGroup.get('stepper.assignmentStep.label').enable();\r\n                            vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { label: value.label } } }, { emitEvent: false });\r\n                        }\r\n                    });\r\n\r\n                    \r\n                });\r\n                \r\n            }\r\n            if (vm.assignedDevicesGroup) {\r\n                var query2 = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.assignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query2).subscribe((data) => {\r\n                    vm.assignedDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            deviceId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                    if (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Device\") {\r\n                        checkAdditionalParams();\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    function filterDevices(name) {\r\n        const filterValue = name.toLowerCase();\r\n        return vm.allDevices.filter(device => \r\n            device.name.toLowerCase().includes(filterValue) || \r\n            device.label.toLowerCase().includes(filterValue) ||\r\n            device.type.toLowerCase().includes(filterValue)\r\n        );\r\n    }\r\n\r\n    function saveDeviceToDoktorkitRelation(DoktorkitId, deviceId) {\r\n        var relation = {\r\n            from: DoktorkitId,\r\n            to: deviceId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Contains'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n\r\n    function updateDeviceLabel(device, label) {\r\n        if (device.label !== label) {\r\n            return deviceService.getDevice(device.deviceId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origDevice) => {\r\n                    origDevice.label = label;\r\n                    return deviceService.saveDevice(origDevice);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableDevice = vm.availableDevices.find(device => device.name === additionalParams.code);\r\n        const matchingAssignedDevice = vm.assignedDevices.find(device => device.name === additionalParams.code);\r\n\r\n        if (!matchingAvailableDevice && !matchingAssignedDevice) {\r\n            widgetContext.dialogs.alert(\"Device doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedDevice && !matchingAvailableDevice) {\r\n            getDoktorkit(additionalParams.code);\r\n        }\r\n        if (matchingAvailableDevice && matchingAssignedDevice) {\r\n            vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { device: matchingAvailableDevice } } }, { emitEvent: false });\r\n            vm.addDeviceFormGroup.get('stepper.assignmentStep.device').markAsDirty();\r\n            vm.addDeviceFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('input[formControlName=\"device\"]');\r\n                if (selectElement) {\r\n                    selectElement.dispatchEvent(new Event('input'));\r\n                }\r\n\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n\r\n    function getDoktorkit(code) {\r\n        vm.deviceEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToDoktorkit = null;\r\n\r\n        deviceService.findByName(code)\r\n            .pipe(\r\n                widgetContext.rxjs.map((origDevice) => {\r\n                    vm.deviceEntityId = origDevice.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.deviceEntityId, 'entityType': 'DEVICE' }).pipe(\r\n                    widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations).pipe(\r\n                        widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToDoktorkit = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-device\");\r\n                        let params = {\r\n                            \"doktorkit\": vm.assignedToDoktorkit,\r\n                            \"device\": vm.deviceEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "628f2502-26dd-276f-8193-a0467dcdc695"
              },
              {
                "name": "Add Device with QR",
                "icon": "qr_code_scanner",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "scanQrCode",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Scan QR code action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to scan QR code', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processQrCodeFunction": "// Function body to process result of QR code scanning. \n// - code - scanned QR code\n// - format - scanned QR code format\n//widgetContext.actionsApi.qrCodeCallback(code);\nlet $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\nlet qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"add-device\");\n\nlet params = {\n    source: \"qrcode\",\n    code: code\n}\ntry {\n    widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\n} catch (error) {\n    widgetContext.dialogs.alert('Error handling widget action:', error);\n}\n\n//showQrCodeDialog(\"Code\", code, format);\nfunction showQrCodeDialog(title, code, format) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Code: ['+code+']<br>Format: ' + format).subscribe();\n    }, 100);\n}\n\n"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "822d20eb-76b0-1464-e924-07f3abc70722"
              }
            ]
          },
          "showTitleIcon": false,
          "titleIcon": "list",
          "iconColor": null,
          "titleFont": null,
          "titleColor": null,
          "enableDataExport": false,
          "desktopHide": true,
          "titleTooltip": "",
          "widgetStyle": {},
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": ""
        },
        "row": 0,
        "col": 0,
        "id": "c779ff45-4c69-b749-51b0-400f54ebf350"
      },
      "4890652b-3208-1522-fbf6-850ba92526cf": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "filterId": null,
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "var DoktorkitState;\r\nif (data && data.length && data[0]['entityId']) {\r\n    DoktorkitState = true;\r\n} else {\r\n    DoktorkitState = false;\r\n}\r\n\r\nvar typeSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24\" viewBox=\"0 -960 960 960\" width=\"24\"><path d=\"M160-80q-33 0-56.5-23.5T80-160v-480q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v480q0 33-23.5 56.5T800-80H160Zm240-640h160v-80H400v80Zm40 360v120h80v-120h120v-80H520v-120h-80v120H320v80h120Z\"/></svg>';\r\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\r\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\r\n\r\nvar header = '<div class=\"header\" fxLayout=\"column\" fxLayoutAlign=\"start stretch\" fxLayoutGap=\"8px\">' +\r\n                '<div fxLayout=\"row\" fxLayoutAlign=\"start stretch\">' +\r\n                  '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><button id=\"go-back\" matTooltip=\"Go back\" type=\"button\" mat-icon-button><mat-icon>arrow_back</mat-icon></button></div>' +\r\n                 /* '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><img style=\"vertical-align: middle;\" class=\"title-icon mat-icon\" src=\"'+ typeSvgUrl +'\"></div>' +*/\r\n                  '<div fxFlex fxLayout=\"column\" fxLayoutAlign=\"center\">' +\r\n                     '<div class=\"title\">Edit Doktorkit: {{ ctx.stateController.getStateParams().selectedDoktorkit?.entityName }}</div>' +\r\n                  '</div>' +\r\n                '</div>' +\r\n                '<div fxLayout=\"row\" fxLayoutAlign=\"stretch stretch\" fxLayoutGap=\"8px\">' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"add-Kit\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">add_circle</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"Doktorkits\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">devices_other</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"Sensorkits\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">sensors</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"get-location\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">location_on</mat-icon>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"delete-Doktorkit\" type=\"button\" mat-raised-button color=\"accent\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">delete</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                '</div>' +\r\n             '</div>';\r\n             \r\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\r\n          (DoktorkitState \r\n            ? (header +\r\n               '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"edit_Doktorkit_card\"></tb-dashboard-state>') \r\n            : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"kits_card_all\"></tb-dashboard-state>') +\r\n       '</div>';\r\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n.main-layout .header {\n    height: 100px;\n    margin: 6px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n.main-layout .tb-mat-20 {\n    width: 1px;\n    height: 2px;\n    margin: 2px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 12px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedDoktorkit'] = null;\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "116515c2-d9bd-80b6-7a34-97373a802806"
              },
              {
                "name": "Doktorkit-devices",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f921410a-47b7-5884-1c63-d010a39064a4"
              },
              {
                "name": "delete-Doktorkit",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenDeleteDoktorkitDialog();\n\nfunction openDeleteDoktorkitDialog() {\n  var title = 'Are you sure you want to delete the Doktorkit ' + entityName + '?';\n  var content = 'Be careful, after the confirmation, the Doktorkit will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteDoktorkit();\n      }\n    }\n  );\n}\n\nfunction deleteDoktorkit() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteDoktorkitToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Doktorkit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Doktorkit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDoktorkitToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1af63269-0a95-b82e-0703-86bd8daf9356"
              },
              {
                "name": "get-location",
                "icon": "location_on",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "getLocation",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Get location action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to get phone location', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processLocationFunction": "// Function body to process current location of the phone. \n// - latitude - phone location latitude\n// - longitude - phone location longitude\nlet $injector = widgetContext.$scope.$injector;\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\n//showLocationDialog('Location', latitude, longitude);\nsaveEntityLocationAttributes('latitude', 'longitude', latitude, longitude);\nfunction getSelectedKitId() {\n    let stateParams = widgetContext.stateController.getStateParams();\n    return stateParams.selectedDoktorkit.entityId;\n}\n\nfunction saveEntityLocationAttributes(latitudeAttributeName, longitudeAttributeName, latitude, longitude) {\n    let entityId = getSelectedKitId();\n    if (entityId) {\n        let attributes = [\n            { key: \"latitude\", value: latitude },\n            { key: \"longitude\", value: longitude }\n        ];\n        attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributes).subscribe(\n        widgetContext.dialogs.alert('Location attributes saved!\\nLatitude: ' + latitude + '\\nLongitude: ' + longitude),\n           function() {\n               widgetContext.showSuccessToast('Location attributes saved!');\n           },\n           function(error) {\n               widgetContext.dialogs.alert('Location attributes save failed', JSON.stringify(error));\n           }\n        );\n    }\n}\n\n\nfunction showLocationDialog(title, latitude, longitude) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Latitude: '+latitude+'<br>Longitude: ' + longitude).subscribe();\n    }, 100);\n}"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "94c2e448-3356-0d9d-d976-d11a0ac2165c"
              }
            ],
            "headerButton": []
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "4890652b-3208-1522-fbf6-850ba92526cf",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "73232f79-2115-af4e-4ad8-50f156b3cb16": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Kits",
            "enableSearch": true,
            "enableSelectColumnDisplay": true,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": true,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Doktorkits",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "89a624d9-5882-ac3f-5001-e709d73e75f1",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "Address",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "70%",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.1345774127559587,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "locationName",
                  "type": "attribute",
                  "label": "Location Alias",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.7448728411727017,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "type",
                  "type": "entityField",
                  "label": "Kit Type",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.27735201814549115,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "Select Doktorkit",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "updateDashboardState",
                "targetDashboardStateId": null,
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "5e50c296-0eac-8841-a69a-1cbbfe04d1c5"
              }
            ],
            "actionCellButton": [
              {
                "name": "Open devices",
                "icon": "devices_other",
                "useShowWidgetActionFunction": false,
                "showWidgetActionFunction": "return data[\"Kit Type\"] === 'Doktorkit';",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "71c478b6-a4b1-e569-e99a-85d5562cc721"
              },
              {
                "name": "Edit Kit",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "edit_Doktorkit_card",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "247f3295-d483-4c18-2637-4029d1daa487"
              },
              {
                "name": "Delete Kit",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenDeleteDoktorkitDialog();\n\nfunction openDeleteDoktorkitDialog() {\n  var title = 'Are you sure you want to delete the Doktorkit ' + entityName + '?';\n  var content = 'Be careful, after the confirmation, the Doktorkit will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteDoktorkit();\n      }\n    }\n  );\n}\n\nfunction deleteDoktorkit() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteDoktorkitToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Doktorkit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Doktorkit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDoktorkitToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "338d9fd7-c752-eb0e-4687-2c2e32ca1a32"
              }
            ],
            "headerButton": [
              {
                "name": "Add Doktorkit",
                "icon": "add",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDoktorkitFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 350px;\">\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\n    <h2>Add Doktorkit</h2>\n    <span fxFlex></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content fxLayout=\"column\">\n    <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">\n      <mat-form-field fxFlex class=\"mat-block\">\n        <mat-label>Doktorkit title</mat-label>\n        <input matInput formControlName=\"name\" required>\n        <mat-error *ngIf=\"addDoktorkitFormGroup.get('name').hasError('required')\">\n          Doktorkit title is required.\n        </mat-error>\n      </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      Cancel\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addDoktorkitFormGroup.invalid || !addDoktorkitFormGroup.dirty\">\n      Add Doktorkit\n    </button>\n  </div>\n</form>\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\n\r\nopenAddDoktorkitDialog();\r\n\r\nfunction openAddDoktorkitDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddDoktorkitDialogController).subscribe();\r\n}\r\n\r\nfunction AddDoktorkitDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.addDoktorkitFormGroup = vm.fb.group({\r\n    name: ['', [vm.validators.required]]\r\n  });\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    const stateParams = widgetContext.stateController.getStateParams();\r\n    var customerId;\r\n    var projectId;\r\n    var measurementId;\r\n    projectId = {id:(stateParams.selectedProject && stateParams.selectedProject.entityId && stateParams.selectedProject.entityId.id) ? stateParams.selectedProject.entityId.id : '',entityType: 'ASSET'}; \r\n    measurementId = {id:(stateParams.selectedMeasurement && stateParams.selectedMeasurement.entityId && stateParams.selectedMeasurement.entityId.id) ? stateParams.selectedMeasurement.entityId.id : '',entityType: 'ASSET'}; \r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        customerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n    vm.addDoktorkitFormGroup.markAsPristine();\r\n    saveDoktorkitObservable(customerId).subscribe(\r\n      function (Doktorkit) {\r\n        const observables = [\r\n        saveCustomerToDoktorkitRelation(customerId, Doktorkit.id),\r\n        saveAttributes(Doktorkit.id)\r\n        ];\r\n        // Add saveProjectToMeasurementRelation to observables if projectId is not empty\r\n        if(projectId.id !== \"\"){\r\n            observables.push(saveProjectToDoktorkitRelation(projectId, Doktorkit.id));\r\n        }\r\n        if(measurementId.id !== \"\"){\r\n            observables.push(saveMeasurementToDoktorkitRelation(measurementId, Doktorkit.id));\r\n        }\r\n          widgetContext.rxjs.forkJoin(observables).subscribe(\r\n              function () {\r\n                var params = widgetContext.stateController.getStateParams();\r\n                var selectedDoktorkit = params['selectedDoktorkit'];\r\n                params['selectedDoktorkit'] = { entityId: Doktorkit.id, entityName: Doktorkit.name, entityLabel: '' };\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              }\r\n        );\r\n      }\r\n    );\r\n  };\r\n\r\n  function saveDoktorkitObservable(customerId) {\r\n    return getDoktorkitsGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((DoktorkitsGroup) => {\r\n            return getUnassignedKitGroup(customerId).pipe(\r\n                widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\r\n                    const formValues = vm.addDoktorkitFormGroup.value;\r\n                    const Doktorkit = {\r\n                        name: formValues.name,\r\n                        type: 'Doktorkit',\r\n                        customerId: customerId\r\n                    };\r\n\r\n                    return assetService.saveAsset(Doktorkit, DoktorkitsGroup.id.id).pipe(\r\n                        widgetContext.rxjs.switchMap((savedAsset) => {\r\n                            // Ensure this line returns an observable\r\n                            return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, savedAsset.id.id).pipe(\r\n                                widgetContext.rxjs.map(() => {\r\n                                    return savedAsset; // Return the saved asset after adding to the entity group\r\n                                })\r\n                            );\r\n                        })\r\n                    );\r\n                })\r\n            );\r\n        })\r\n    );\r\n}\r\n\r\n\r\n  \r\n  function getDoktorkitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var DoktorkitsGroup = entityGroups.find(group => group.name === 'Doktorkits');\r\n              if (DoktorkitsGroup) {\r\n                  return widgetContext.rxjs.of(DoktorkitsGroup);\r\n              } else {\r\n                  DoktorkitsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Doktorkits',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(DoktorkitsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  function getUnassignedKitGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n              if (UnassignedKitGroup) {\r\n                  return widgetContext.rxjs.of(UnassignedKitGroup);\r\n              } else {\r\n                  UnassignedKitGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Unassigned Kit',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n\r\n  function saveCustomerToDoktorkitRelation(customerId, DoktorkitId) {\r\n      var relation = {\r\n          from: customerId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveProjectToDoktorkitRelation(projectId, DoktorkitId) {\r\n      var relation = {\r\n          from: projectId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveMeasurementToDoktorkitRelation(measurementId, DoktorkitId) {\r\n      var relation = {\r\n          from: measurementId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n        {\r\n            key: 'state',\r\n            value: 'normal'\r\n        }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e965b8a1-a6ac-5ae4-fd79-2b7220b91ed1"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "configMode": "advanced",
          "titleFont": null,
          "titleColor": null,
          "titleIcon": null,
          "iconColor": null
        },
        "row": 0,
        "col": 0,
        "id": "73232f79-2115-af4e-4ad8-50f156b3cb16",
        "typeFullFqn": "system.cards.entities_table"
      },
      "9351f221-5ed8-ae9f-a593-d8c7bf85c675": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\r\n     <div fxLayout=\"row\" style=\"width: 100%; height: 40px; justify-content: flex-start;\" fxLayoutAlign=\"start start\">\r\n        <h5 fxFlex class=\"market-title\">Devices</h5>\r\n        <div style=\"margin-right: 30px;\">\r\n        <button id=\"add-device\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">add</mat-icon><span>Add device manually</span></button>\r\n        <button id=\"replace-device\" mat-raised-button color=\"primary\" style=\"display: none;\">\r\n                <mat-icon class=\"tb-mat-20\">add</mat-icon>\r\n                <span>Replace Device</span>\r\n        </button>\r\n        </div> \r\n     </div>\r\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\r\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"doktorkit_devices_header_buttons\"></tb-dashboard-state>\r\n    </div>\r\n</div>\r\n",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-container .tb-widget .tb-multiple-input {\n    background-color: #FAFAFA;\n    border-radius: 4px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .input-field {\n    padding-right: 30px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input mat-slide-toggle {\n    margin-top: 15px !important;\n    margin-bottom: 0 !important;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-slide-toggle-content {\n    width: 120px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-bar {\n    width: 42px;\n    height: 24px;\n    border-radius: 16px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb-container {\n    top: 2px;\n    left: 2px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-thumb-container {\n    transform: translate3d(18px, 0, 0);\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb {\n    background-color: #fafafa;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-bar {\n    background-color: #F2994A;\n}\n",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "add-device",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDeviceFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 800px;\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Add Sensor</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-horizontal-stepper formGroupName=\"stepper\" linear>\r\n      <mat-step formGroupName=\"assignmentStep\" label=\"Assignment\">\r\n        <ng-template matStepLabel>Assignment</ng-template>\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Sensor</mat-label>\r\n          <mat-select formControlName=\"device\" required>\r\n            <mat-select-trigger>\r\n              <div class=\"device-item\" fxLayout=\"row\">\r\n                <div fxLayout=\"column\" fxFlex>\r\n                  <div>{{addDeviceFormGroup.get('stepper.assignmentStep.device').value?.label}}</div>\r\n                  <div class=\"device-name\">{{addDeviceFormGroup.get('stepper.assignmentStep.device').value?.name}}</div>\r\n                </div>\r\n                <div class=\"device-type\">{{addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type}}</div>\r\n              </div>\r\n            </mat-select-trigger>\r\n            <mat-option *ngFor=\"let device of availableDevices\" [value]=\"device\">\r\n              <div class=\"device-item\" fxLayout=\"row\">\r\n                <div fxLayout=\"column\" fxFlex>\r\n                  <div>{{device?.label}}</div>\r\n                  <div class=\"device-name\">{{device?.name}}</div>\r\n                </div>\r\n                <div class=\"device-type\">{{device?.type}}</div>\r\n              </div>\r\n              <mat-divider></mat-divider>\r\n            </mat-option>\r\n            <mat-option *ngIf=\"!availableDevices?.length\" disabled [value]=\"null\">\r\n              <div class=\"device-item\">\r\n                No devices available\r\n              </div>\r\n            </mat-option>\r\n          </mat-select>\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').hasError('required')\">\r\n            Sensor is required.\r\n          </mat-error>\r\n        </mat-form-field>\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Label</mat-label>\r\n          <input matInput formControlName=\"label\" required>\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.label').hasError('required')\">\r\n            Sensor label is required.\r\n          </mat-error>\r\n        </mat-form-field>\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\"\r\n                  type=\"button\"\r\n                  [disabled]=\"(isLoading$ | async)\"\r\n                  (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n          </button>\r\n          <button mat-button matStepperNext color=\"primary\" type=\"button\">\r\n            Next\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <mat-step formGroupName=\"alarmThresholdsStep\" label=\"Alarm Thresholds\">\r\n        <ng-template matStepLabel>Alarm Thresholds</ng-template>\r\n\r\n        <!-- Additional fields for Room Sensor CO2 type -->\r\n        <div *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type === 'Room Sensor CO2'\">\r\n          <div fxLayout=\"row\" fxLayoutGap=\"24px\">\r\n            <div fxFlex=\"50%\">\r\n              <mat-form-field class=\"mat-block\">\r\n                <mat-label>High CO2 Threshold for critical alarm</mat-label>\r\n                <input matInput formControlName=\"highCo2CriticalThreshold\" type=\"number\" required>\r\n              </mat-form-field>\r\n            </div>\r\n            <div fxFlex=\"50%\">\r\n              <mat-form-field class=\"mat-block\">\r\n                <mat-label>High CO2 Threshold for major alarm</mat-label>\r\n                <input matInput formControlName=\"highCo2MajorThreshold\" type=\"number\" required>\r\n              </mat-form-field>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Additional fields for Room Sensor T type -->\r\n        <div *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type === 'Room Sensor T' || addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type === 'Room Sensor CO2'\">\r\n          <div fxLayout=\"row\" fxLayoutGap=\"24px\">\r\n            <div fxFlex=\"50%\">\r\n              <mat-form-field class=\"mat-block\">\r\n                <mat-label>High Temperature Critical Threshold</mat-label>\r\n                <input matInput formControlName=\"highTemperatureCriticalThreshold\" type=\"number\" required>\r\n              </mat-form-field>\r\n              <mat-form-field class=\"mat-block\">\r\n                <mat-label>High Humidity Critical Threshold</mat-label>\r\n                <input matInput formControlName=\"highHumidityCriticalThreshold\" type=\"number\" required>\r\n              </mat-form-field>\r\n            </div>\r\n            <div fxFlex=\"50%\">\r\n              <mat-form-field class=\"mat-block\">\r\n                <mat-label>High Temperature Major Threshold</mat-label>\r\n                <input matInput formControlName=\"highTemperatureMajorThreshold\" type=\"number\" required>\r\n              </mat-form-field>\r\n              <mat-form-field class=\"mat-block\">\r\n                <mat-label>High Humidity Major Threshold</mat-label>\r\n                <input matInput formControlName=\"highHumidityMajorThreshold\" type=\"number\" required>\r\n              </mat-form-field>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\"\r\n                  type=\"button\"\r\n                  [disabled]=\"(isLoading$ | async)\"\r\n                  (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n          </button>\r\n          <button mat-button matStepperPrevious color=\"primary\" type=\"button\">\r\n            Back\r\n          </button>\r\n          <button mat-button mat-raised-button color=\"primary\"\r\n                  type=\"submit\"\r\n                  [disabled]=\"(isLoading$ | async) || addDeviceFormGroup.invalid\">\r\n            Save\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>\r\n",
                "customCss": "\n.device-item {\n    line-height: 24px;\n    width: 100%;\n    padding-top: 8px;\n    padding-bottom: 8px;\n}\n\n.device-item .device-name {\n    font-size: 12px;\n    opacity: 0.7;\n}\n\n.device-item .device-type {\n    font-size: 14px;\n    opacity: 0.7;\n}\n\nmat-option {\n    height: auto !important;\n    white-space: normal !important;\n}\n\n.mat-select-value-text {\n    display: block;\n    width: 100%;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\n\r\nif (additionalParams.source === \"replace Device\") {\r\n    if (additionalParams.choice === true) {\r\n        openAddDeviceDialog();\r\n    } else {\r\n        // Handle other cases if needed\r\n    }\r\n} else if (additionalParams.source !== \"replace Device\") {\r\n    openAddDeviceDialog();\r\n}\r\n\r\nfunction openAddDeviceDialog() {\r\n    customDialog.customDialog(htmlTemplate, AddDeviceDialogController).subscribe();\r\n}\r\n\r\nfunction AddDeviceDialogController(instance) {\r\n    let vm = instance;\r\n\r\n    vm.addDeviceFormGroup = vm.fb.group({\r\n        stepper: vm.fb.group({\r\n            assignmentStep: vm.fb.group({\r\n                device: [null, [vm.validators.required]],\r\n                label: [{ value: null, disabled: true }]\r\n            }),\r\n            \r\n            alarmThresholdsStep: vm.fb.group({\r\n                // Additional fields for Room Sensor CO2 type\r\n                highCo2CriticalThreshold: [null],\r\n                highCo2MajorThreshold: [null],\r\n                // Additional fields for Room Sensor T type\r\n                highTemperatureCriticalThreshold: [null],\r\n                highHumidityCriticalThreshold: [null],\r\n                highTemperatureMajorThreshold: [null],\r\n                highHumidityMajorThreshold: [null]\r\n            })\r\n        })\r\n    });\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n    var SensorkitId = widgetContext.stateController.getStateParams().selectedSensorkit.entityId;\r\n    vm.addDeviceFormGroup.markAsPristine();\r\n    var device = vm.addDeviceFormGroup.value.stepper.assignmentStep.device;\r\n    var label = vm.addDeviceFormGroup.value.stepper.assignmentStep.label;\r\n    var highCo2CriticalThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.highCo2CriticalThreshold;\r\n    var highCo2MajorThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.highCo2MajorThreshold;\r\n    var highTemperatureCriticalThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.highTemperatureCriticalThreshold;\r\n    var highHumidityCriticalThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.highHumidityCriticalThreshold;\r\n    var highTemperatureMajorThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.highTemperatureMajorThreshold;\r\n    var highHumidityMajorThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.highHumidityMajorThreshold;\r\n\r\n    var deviceId = device.deviceId;\r\n    \r\n    widgetContext.rxjs.forkJoin([\r\n        entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n        saveDeviceToSensorkitRelation(SensorkitId, deviceId),\r\n        saveAttributes(\r\n            deviceId,\r\n            highCo2CriticalThreshold,\r\n            highCo2MajorThreshold,\r\n            highTemperatureCriticalThreshold,\r\n            highHumidityCriticalThreshold,\r\n            highTemperatureMajorThreshold,\r\n            highHumidityMajorThreshold\r\n        ),\r\n        updateDeviceLabel(device, label)\r\n    ]).subscribe(() => {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n    });\r\n};\r\n\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedDevicesGroup = null;\r\n        vm.assignedDevicesGroup = null;\r\n        vm.availableDevices = [];\r\n        vm.assignedDevices = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'DEVICE').subscribe((entityGroups) => {\r\n            vm.customerDevicesGroups = entityGroups;\r\n            vm.unassignedDevicesGroup = entityGroups.find(group => group.name === 'Unassigned Sensorkit Devices');\r\n            vm.assignedDevicesGroup = entityGroups.find(group => group.name === 'Sensorkit Devices');\r\n            if (vm.unassignedDevicesGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.unassignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    vm.availableDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            deviceId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n\r\n                });\r\n            }\r\n            if (vm.assignedDevicesGroup) {\r\n                var query2 = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.assignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query2).subscribe((data) => {\r\n                    vm.assignedDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            deviceId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                    if (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Device\") {\r\n                        checkAdditionalParams();\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    function saveDeviceToSensorkitRelation(SensorkitId, deviceId) {\r\n        var relation = {\r\n            from: SensorkitId,\r\n            to: deviceId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Contains'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function saveAttributes(entityId, highCo2CriticalThreshold, highCo2MajorThreshold, highTemperatureCriticalThreshold, highHumidityCriticalThreshold, highTemperatureMajorThreshold, highHumidityMajorThreshold) {\r\n    let attributesArray = [\r\n        { key: 'xPos', value: 0.5 },\r\n        { key: 'yPos', value: 0.5 },\r\n        { key: 'highCo2CriticalThreshold', value: highCo2CriticalThreshold },\r\n        { key: 'highCo2MajorThreshold', value: highCo2MajorThreshold },\r\n        { key: 'highHumidityCriticalThreshold', value: highHumidityCriticalThreshold },\r\n        { key: 'highHumidityMajorThreshold', value: highHumidityMajorThreshold },\r\n        { key: 'highTemperatureCriticalThreshold', value: highTemperatureCriticalThreshold },\r\n        { key: 'highTemperatureMajorThreshold', value: highTemperatureMajorThreshold }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n}\r\n\r\n\r\n    function updateDeviceLabel(device, label) {\r\n        if (device.label !== label) {\r\n            return deviceService.getDevice(device.deviceId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origDevice) => {\r\n                    origDevice.label = label;\r\n                    return deviceService.saveDevice(origDevice);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableDevice = vm.availableDevices.find(device => device.name === additionalParams.code);\r\n        const matchingAssignedDevice = vm.assignedDevices.find(device => device.name === additionalParams.code);\r\n\r\n                if (!matchingAvailableDevice && !matchingAssignedDevice) {\r\n            widgetContext.dialogs.alert(\"Device doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedDevice && !matchingAvailableDevice) {\r\n            getSensorkit(additionalParams.code);\r\n        }\r\n        if (matchingAvailableDevice && matchingAssignedDevice) {\r\n            vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { device: matchingAvailableDevice } } }, { emitEvent: false });\r\n            vm.addDeviceFormGroup.get('stepper.assignmentStep.device').markAsDirty();\r\n            vm.addDeviceFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('mat-select[formControlName=\"device\"]');\r\n                if (selectElement) {\r\n                    selectElement.dispatchEvent(new Event('change'));\r\n                }\r\n\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n\r\n    function getSensorkit(code) {\r\n        vm.deviceEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToSensorkit = null;\r\n\r\n        deviceService.findByName(code)\r\n            .pipe(\r\n                widgetContext.rxjs.map((origDevice) => {\r\n                    vm.deviceEntityId = origDevice.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.deviceEntityId, 'entityType': 'DEVICE' }).pipe(\r\n                    widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations).pipe(\r\n                        widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToSensorkit = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-device\");\r\n                        let params = {\r\n                            \"sensorkit\": vm.assignedToSensorkit,\r\n                            \"device\": vm.deviceEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7cad1c71-0765-4277-32a8-c87808a0c689"
              },
              {
                "name": "replace-device",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<!-- replace-device-dialog.component.html -->\r\n<div class=\"replace-device-dialog-form\" style=\"width: 400px;\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Replace Device</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-dialog-content fxLayout=\"column\" class=\"mat-typography\">\r\n    <p>{{ confirmationMessage }}</p>\r\n  </mat-dialog-content>\r\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n    <button mat-button color=\"primary\" (click)=\"cancel()\" type=\"button\" cdkFocusInitial>\r\n      No\r\n    </button>\r\n    <button mat-button mat-raised-button color=\"primary\" (click)=\"confirm()\" type=\"button\">\r\n      Yes\r\n    </button>\r\n  </div>\r\n</div>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\nlet qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"add-device\");\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\n\nopenReplaceDeviceDialog();\n\nfunction openReplaceDeviceDialog() {\n    customDialog.customDialog(htmlTemplate, ReplaceDeviceDialogController).subscribe();\n}\n\nfunction returnSelection(replaceDevice) {\n    let params = {\n        source: \"replace Device\",\n        choice: replaceDevice // Use event.replaceDevice instead of replaceDevice directly\n    };\n    //widgetContext.dialogs.alert(\"User selected 2\" + replaceDevice.toString() + \"!\");\n    try {\n        widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\n    } catch (error) {\n        widgetContext.dialogs.alert('Error handling widget action:', error);\n    }\n}\n\nfunction ReplaceDeviceDialogController(instance) {\n    let vm = instance;\n    let replaceDevice;\n    //widgetContext.dialogs.alert(\"Aditional Params: \" + JSON.stringify(additionalParams) + additionalParams.device);\n\n    vm.confirmationMessage = \"Device is already assigned to \" + additionalParams.doktorkit + \"!\\n\" +\n        \"Do you want to remove it from \" + additionalParams.doktorkit + \" and assign it to the current one?\";\n\n    vm.cancel = function() {\n        replaceDevice = false; // Set replaceDevice to false\n        vm.handleConfirm({ replaceDevice: replaceDevice });\n    };\n\n    vm.confirm = function() {\n        let entityId = { 'id': additionalParams.device, 'entityType': 'DEVICE' };\n        let entityGroupId = \"684410d0-bfae-11ee-8196-b3999b4a11b6\";\n        //widgetContext.dialogs.alert(\"Additional Params: \" + JSON.stringify(entityId));\n        try {\n            entityRelationService.deleteRelations(entityId).subscribe(\n                () => {\n                    try {\n                        entityGroupService.addEntityToEntityGroup(entityGroupId, entityId.id).subscribe(\n                            () => {\n                                replaceDevice = true; // Set replaceDevice to true\n                                vm.handleConfirm({ replaceDevice: replaceDevice });\n                            },\n                            error => {\n                                widgetContext.dialogs.alert('Error handling add to Group action: ' + JSON.stringify(error));\n                            }\n                        );\n                    } catch (error) {\n                        widgetContext.dialogs.alert('Error initiating addEntityToEntityGroup: ' + JSON.stringify(error));\n                    }\n                },\n                error => {\n                    widgetContext.dialogs.alert('Error handling deleteRelations: ' + JSON.stringify(error));\n                }\n            );\n        } catch (error) {\n            widgetContext.dialogs.alert('Error initiating deleteRelations: ' + JSON.stringify(error));\n        }\n    };\n\n    vm.handleConfirm = function(event) {\n        vm.dialogRef.close(event);\n        let params = {\n            source: \"replace Device\",\n            choice: event.replaceDevice, // Use event.replaceDevice instead of replaceDevice directly\n            device: additionalParams.device,\n            code: additionalParams.code\n        };\n        try {\n            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\n        } catch (error) {\n            widgetContext.dialogs.alert('Error handling widget action:', error);\n        }\n    };\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "c45ba341-9bcd-8608-b0f5-15317d44eb8a"
              }
            ],
            "headerButton": [
              {
                "name": "qr-code",
                "icon": "qr_code_scanner",
                "useShowWidgetActionFunction": false,
                "showWidgetActionFunction": "return true;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "scanQrCode",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Scan QR code action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to scan QR code', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processQrCodeFunction": "// Function body to process result of QR code scanning. \n// - code - scanned QR code\n// - format - scanned QR code format\n//widgetContext.actionsApi.qrCodeCallback(code);\nlet $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\nlet qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"add-device\");\n\nlet params = {\n    source: \"qrcode\",\n    code: code\n}\ntry {\n    widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\n} catch (error) {\n    widgetContext.dialogs.alert('Error handling widget action:', error);\n}\n\n//showQrCodeDialog(\"Code\", code, format);\nfunction showQrCodeDialog(title, code, format) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Code: ['+code+']<br>Format: ' + format).subscribe();\n    }, 100);\n}\n\n"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "01671463-1c6c-41bb-da25-4eb5ee1ef842"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "9351f221-5ed8-ae9f-a593-d8c7bf85c675",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "298ac1a0-d9bc-068d-9f2d-2019aee5b38b": {
        "typeFullFqn": "system.cards.entities_table",
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1713435502260,
                "endTimeMs": 1713521902260
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "enableSearch": true,
            "enableSelectColumnDisplay": true,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "displayEntityLabel": false,
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "name",
            "useRowStyleFunction": false,
            "entitiesTitle": "Entities"
          },
          "title": "Entities table",
          "dropShadow": true,
          "enableFullscreen": true,
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400,
            "padding": "5px 10px 5px 10px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "186b00f3-5c8d-7cab-7654-f96a15d58d64",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Name",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.1849002505353028
                },
                {
                  "name": "active",
                  "type": "attribute",
                  "label": "active",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.8128568406469565,
                  "decimals": 0
                },
                {
                  "name": "type",
                  "type": "entityField",
                  "label": "Type",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.3089029814236317,
                  "decimals": 0
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "Label",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.9719730919393044,
                  "decimals": 0
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "displayTimewindow": false,
          "configMode": "advanced",
          "actions": {
            "actionCellButton": [
              {
                "name": "Add Device to Doctorkit",
                "icon": "medical_services",
                "useShowWidgetActionFunction": false,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<!--=======================================================================-->\n<!--=====  There are two example templates: for edit and add entity   =====-->\n<!--=======================================================================-->\n<!--========================  Edit entity example  ========================-->\n<!--=======================================================================-->\n<!-- -->\n<!--<form #editEntityForm=\"ngForm\" [formGroup]=\"editEntityFormGroup\"-->\n<!--      (ngSubmit)=\"save()\"  class=\"edit-entity-form\">-->\n<!--    <mat-toolbar fxLayout=\"row\" color=\"primary\">-->\n<!--        <h2>Edit {{entityType.toLowerCase()}} {{entityName}}</h2>-->\n<!--        <span fxFlex></span>-->\n<!--        <button mat-icon-button (click)=\"cancel()\" type=\"button\">-->\n<!--            <mat-icon class=\"material-icons\">close</mat-icon>-->\n<!--        </button>-->\n<!--    </mat-toolbar>-->\n<!--    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">-->\n<!--    </mat-progress-bar>-->\n<!--    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>-->\n<!--    <div mat-dialog-content fxLayout=\"column\">-->\n<!--        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Name</mat-label>-->\n<!--                <input matInput formControlName=\"entityName\" required readonly=\"\">-->\n<!--            </mat-form-field>-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Label</mat-label>-->\n<!--                <input matInput formControlName=\"entityLabel\">-->\n<!--            </mat-form-field>-->\n<!--        </div>-->\n<!--        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Type</mat-label>-->\n<!--                <input matInput formControlName=\"entityType\" readonly>-->\n<!--            </mat-form-field>-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Type</mat-label>-->\n<!--                <input matInput formControlName=\"type\" readonly>-->\n<!--            </mat-form-field>-->\n<!--        </div>-->\n<!--        <div formGroupName=\"attributes\" fxLayout=\"column\">-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Latitude</mat-label>-->\n<!--                    <input type=\"number\" step=\"any\" matInput formControlName=\"latitude\">-->\n<!--                </mat-form-field>-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Longitude</mat-label>-->\n<!--                    <input type=\"number\" step=\"any\" matInput formControlName=\"longitude\">-->\n<!--                </mat-form-field>-->\n<!--            </div>-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Address</mat-label>-->\n<!--                    <input matInput formControlName=\"address\">-->\n<!--                </mat-form-field>-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Owner</mat-label>-->\n<!--                    <input matInput formControlName=\"owner\">-->\n<!--                </mat-form-field>-->\n<!--            </div>-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Integer Value</mat-label>-->\n<!--                    <input type=\"number\" step=\"1\" matInput formControlName=\"number\">-->\n<!--                    <mat-error *ngIf=\"editEntityFormGroup.get('attributes.number').hasError('pattern')\">-->\n<!--                        Invalid integer value.-->\n<!--                    </mat-error>-->\n<!--                </mat-form-field>-->\n<!--                <div class=\"boolean-value-input\" fxLayout=\"column\" fxLayoutAlign=\"center start\" fxFlex>-->\n<!--                    <label class=\"checkbox-label\">Boolean Value</label>-->\n<!--                    <mat-checkbox formControlName=\"booleanValue\" style=\"margin-bottom: 40px;\">-->\n<!--                        {{ (editEntityFormGroup.get('attributes.booleanValue').value ? \"value.true\" : \"value.false\") | translate }}-->\n<!--                    </mat-checkbox>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--        <div class=\"relations-list old-relations\">-->\n<!--            <div class=\"mat-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">Relations</div>-->\n<!--            <div class=\"body\" [fxShow]=\"oldRelations().length\">-->\n<!--                <div class=\"row\" fxLayout=\"row\" fxLayoutAlign=\"start center\" formArrayName=\"oldRelations\" -->\n<!--                     *ngFor=\"let relation of oldRelations().controls; let i = index;\">-->\n<!--                    <div [formGroupName]=\"i\" class=\"mat-elevation-z2\" fxFlex fxLayout=\"row\" style=\"padding: 5px 0 5px 5px;\">-->\n<!--                        <div fxFlex fxLayout=\"column\">-->\n<!--                            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                                <mat-form-field class=\"mat-block\" style=\"min-width: 100px;\">-->\n<!--                                    <mat-label>Direction</mat-label>-->\n<!--                                    <mat-select formControlName=\"direction\" name=\"direction\">-->\n<!--                                        <mat-option *ngFor=\"let direction of entitySearchDirection | keyvalue\" [value]=\"direction.value\">-->\n<!--                                            {{ (\"relation.search-direction.\" + direction.value) | translate}}-->\n<!--                                        </mat-option>-->\n<!--                                    </mat-select>-->\n<!--                                    <mat-error *ngIf=\"relation.get('direction').hasError('required')\">-->\n<!--                                        Relation direction is required.-->\n<!--                                    </mat-error>-->\n<!--                                </mat-form-field>-->\n<!--                                <tb-relation-type-autocomplete-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        formControlName=\"relationType\"-->\n<!--                                        required=\"true\">-->\n<!--                                </tb-relation-type-autocomplete>-->\n<!--                            </div>-->\n<!--                            <div fxLayout=\"row\" fxLayout.xs=\"column\">-->\n<!--                                <tb-entity-select-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        required=\"true\"-->\n<!--                                        formControlName=\"relatedEntity\">-->\n<!--                                </tb-entity-select>-->\n<!--                            </div>-->\n<!--                        </div>-->\n<!--                        <div fxLayout=\"column\" fxLayoutAlign=\"center center\">-->\n<!--                            <button mat-icon-button color=\"primary\"-->\n<!--                                    aria-label=\"Remove\"-->\n<!--                                    type=\"button\"-->\n<!--                                    (click)=\"removeOldRelation(i, relation.value)\"-->\n<!--                                    matTooltip=\"Remove relation\"-->\n<!--                                    matTooltipPosition=\"above\">-->\n<!--                                <mat-icon>close</mat-icon>-->\n<!--                            </button>-->\n<!--                        </div>-->\n<!--                    </div>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--        <div class=\"relations-list\">-->\n<!--            <div class=\"mat-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">New Relations</div>-->\n<!--            <div class=\"body\" [fxShow]=\"relations().length\">-->\n<!--                <div class=\"row\" fxLayout=\"row\" fxLayoutAlign=\"start center\" formArrayName=\"relations\" *ngFor=\"let relation of relations().controls; let i = index;\">-->\n<!--                    <div [formGroupName]=\"i\" class=\"mat-elevation-z2\" fxFlex fxLayout=\"row\" style=\"padding: 5px 0 5px 5px;\">-->\n<!--                        <div fxFlex fxLayout=\"column\">-->\n<!--                            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                                <mat-form-field class=\"mat-block\" style=\"min-width: 100px;\">-->\n<!--                                    <mat-label>Direction</mat-label>-->\n<!--                                    <mat-select formControlName=\"direction\" name=\"direction\">-->\n<!--                                        <mat-option *ngFor=\"let direction of entitySearchDirection | keyvalue\" [value]=\"direction.value\">-->\n<!--                                            {{ (\"relation.search-direction.\" + direction.value) | translate}}-->\n<!--                                        </mat-option>-->\n<!--                                    </mat-select>-->\n<!--                                    <mat-error *ngIf=\"relation.get('direction').hasError('required')\">-->\n<!--                                        Relation direction is required.-->\n<!--                                    </mat-error>-->\n<!--                                </mat-form-field>-->\n<!--                                <tb-relation-type-autocomplete-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        formControlName=\"relationType\"-->\n<!--                                        [required]=\"true\">-->\n<!--                                </tb-relation-type-autocomplete>-->\n<!--                            </div>-->\n<!--                            <div fxLayout=\"row\" fxLayout.xs=\"column\">-->\n<!--                                <tb-entity-select-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        [required]=\"true\"-->\n<!--                                        formControlName=\"relatedEntity\">-->\n<!--                                </tb-entity-select>-->\n<!--                            </div>-->\n<!--                        </div>-->\n<!--                        <div fxLayout=\"column\" fxLayoutAlign=\"center center\">-->\n<!--                            <button mat-icon-button color=\"primary\"-->\n<!--                                    aria-label=\"Remove\"-->\n<!--                                    type=\"button\"-->\n<!--                                    (click)=\"removeRelation(i)\"-->\n<!--                                    matTooltip=\"Remove relation\"-->\n<!--                                    matTooltipPosition=\"above\">-->\n<!--                                <mat-icon>close</mat-icon>-->\n<!--                            </button>-->\n<!--                        </div>-->\n<!--                    </div>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--            <div>-->\n<!--                <button mat-raised-button color=\"primary\"-->\n<!--                        type=\"button\"-->\n<!--                        (click)=\"addRelation()\"-->\n<!--                        matTooltip=\"Add Relation\"-->\n<!--                        matTooltipPosition=\"above\">-->\n<!--                    Add-->\n<!--                </button>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--    </div>-->\n<!--    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">-->\n<!--        <button mat-button color=\"primary\"-->\n<!--                type=\"button\"-->\n<!--                [disabled]=\"(isLoading$ | async)\"-->\n<!--                (click)=\"cancel()\" cdkFocusInitial>-->\n<!--            Cancel-->\n<!--        </button>-->\n<!--        <button mat-button mat-raised-button color=\"primary\"-->\n<!--                type=\"submit\"-->\n<!--                [disabled]=\"(isLoading$ | async) || editEntityForm.invalid || !editEntityForm.dirty\">-->\n<!--            Save-->\n<!--        </button>-->\n<!--    </div>-->\n<!--</form>-->\n<!---->\n<!--========================================================================-->\n<!--=========================  Add entity example  =========================-->\n<!--========================================================================-->\n<!---->\n<!--<form #addEntityForm=\"ngForm\" [formGroup]=\"addEntityFormGroup\"-->\n<!--      (ngSubmit)=\"save()\" class=\"add-entity-form\">-->\n<!--    <mat-toolbar fxLayout=\"row\" color=\"primary\">-->\n<!--        <h2>Add entity</h2>-->\n<!--        <span fxFlex></span>-->\n<!--        <button mat-icon-button (click)=\"cancel()\" type=\"button\">-->\n<!--            <mat-icon class=\"material-icons\">close</mat-icon>-->\n<!--        </button>-->\n<!--    </mat-toolbar>-->\n<!--    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">-->\n<!--    </mat-progress-bar>-->\n<!--    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>-->\n<!--    <div mat-dialog-content fxLayout=\"column\">-->\n<!--        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Name</mat-label>-->\n<!--                <input matInput formControlName=\"entityName\" required>-->\n<!--                <mat-error *ngIf=\"addEntityFormGroup.get('entityName').hasError('required')\">-->\n<!--                    Entity name is required.-->\n<!--                </mat-error>-->\n<!--            </mat-form-field>-->\n<!--            <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                <mat-label>Entity Label</mat-label>-->\n<!--                <input matInput formControlName=\"entityLabel\" >-->\n<!--            </mat-form-field>-->\n<!--        </div>-->\n<!--        <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--            <tb-entity-type-select-->\n<!--                    class=\"mat-block\"-->\n<!--                    formControlName=\"entityType\"-->\n<!--                    [showLabel]=\"true\"-->\n<!--                    [allowedEntityTypes]=\"allowedEntityTypes\"-->\n<!--            ></tb-entity-type-select>-->\n<!--            <tb-entity-subtype-autocomplete-->\n<!--                    fxFlex *ngIf=\"addEntityFormGroup.get('entityType').value == 'ASSET'\"-->\n<!--                    class=\"mat-block\"-->\n<!--                    formControlName=\"type\"-->\n<!--                    [required]=\"true\"-->\n<!--                    [entityType]=\"'ASSET'\"-->\n<!--            ></tb-entity-subtype-autocomplete>-->\n<!--            <tb-entity-subtype-autocomplete-->\n<!--                    fxFlex *ngIf=\"addEntityFormGroup.get('entityType').value != 'ASSET'\"-->\n<!--                    class=\"mat-block\"-->\n<!--                    formControlName=\"type\"-->\n<!--                    [required]=\"true\"-->\n<!--                    [entityType]=\"'DEVICE'\"-->\n<!--            ></tb-entity-subtype-autocomplete>-->\n<!--        </div>-->\n<!--        <div formGroupName=\"attributes\" fxLayout=\"column\">-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Latitude</mat-label>-->\n<!--                    <input type=\"number\" step=\"any\" matInput formControlName=\"latitude\">-->\n<!--                </mat-form-field>-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Longitude</mat-label>-->\n<!--                    <input type=\"number\" step=\"any\" matInput formControlName=\"longitude\">-->\n<!--                </mat-form-field>-->\n<!--            </div>-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Address</mat-label>-->\n<!--                    <input matInput formControlName=\"address\">-->\n<!--                </mat-form-field>-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Owner</mat-label>-->\n<!--                    <input matInput formControlName=\"owner\">-->\n<!--                </mat-form-field>-->\n<!--            </div>-->\n<!--            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                <mat-form-field fxFlex class=\"mat-block\">-->\n<!--                    <mat-label>Integer Value</mat-label>-->\n<!--                    <input type=\"number\" step=\"1\" matInput formControlName=\"number\">-->\n<!--                    <mat-error *ngIf=\"addEntityFormGroup.get('attributes.number').hasError('pattern')\">-->\n<!--                        Invalid integer value.-->\n<!--                    </mat-error>-->\n<!--                </mat-form-field>-->\n<!--                <div class=\"boolean-value-input\" fxLayout=\"column\" fxLayoutAlign=\"center start\" fxFlex>-->\n<!--                    <label class=\"checkbox-label\">Boolean Value</label>-->\n<!--                    <mat-checkbox formControlName=\"booleanValue\" style=\"margin-bottom: 40px;\">-->\n<!--                        {{ (addEntityFormGroup.get('attributes.booleanValue').value ? \"value.true\" : \"value.false\") | translate }}-->\n<!--                    </mat-checkbox>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--        <div class=\"relations-list\">-->\n<!--            <div class=\"mat-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">Relations</div>-->\n<!--            <div class=\"body\" [fxShow]=\"relations().length\">-->\n<!--                <div class=\"row\" fxLayout=\"row\" fxLayoutAlign=\"start center\" formArrayName=\"relations\" *ngFor=\"let relation of relations().controls; let i = index;\">-->\n<!--                    <div [formGroupName]=\"i\" class=\"mat-elevation-z2\" fxFlex fxLayout=\"row\" style=\"padding: 5px 0 5px 5px;\">-->\n<!--                        <div fxFlex fxLayout=\"column\">-->\n<!--                            <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">-->\n<!--                                <mat-form-field class=\"mat-block\" style=\"min-width: 100px;\">-->\n<!--                                    <mat-label>Direction</mat-label>-->\n<!--                                    <mat-select formControlName=\"direction\" name=\"direction\">-->\n<!--                                        <mat-option *ngFor=\"let direction of entitySearchDirection | keyvalue\" [value]=\"direction.value\">-->\n<!--                                            {{ (\"relation.search-direction.\" + direction.value) | translate}}-->\n<!--                                        </mat-option>-->\n<!--                                    </mat-select>-->\n<!--                                    <mat-error *ngIf=\"relation.get('direction').hasError('required')\">-->\n<!--                                        Relation direction is required.-->\n<!--                                    </mat-error>-->\n<!--                                </mat-form-field>-->\n<!--                                <tb-relation-type-autocomplete-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        formControlName=\"relationType\"-->\n<!--                                        [required]=\"true\">-->\n<!--                                </tb-relation-type-autocomplete>-->\n<!--                            </div>-->\n<!--                            <div fxLayout=\"row\" fxLayout.xs=\"column\">-->\n<!--                                <tb-entity-select-->\n<!--                                        fxFlex class=\"mat-block\"-->\n<!--                                        [required]=\"true\"-->\n<!--                                        formControlName=\"relatedEntity\">-->\n<!--                                </tb-entity-select>-->\n<!--                            </div>-->\n<!--                        </div>-->\n<!--                        <div fxLayout=\"column\" fxLayoutAlign=\"center center\">-->\n<!--                            <button mat-icon-button color=\"primary\"-->\n<!--                                    aria-label=\"Remove\"-->\n<!--                                    type=\"button\"-->\n<!--                                    (click)=\"removeRelation(i)\"-->\n<!--                                    matTooltip=\"Remove relation\"-->\n<!--                                    matTooltipPosition=\"above\">-->\n<!--                                <mat-icon>close</mat-icon>-->\n<!--                            </button>-->\n<!--                        </div>-->\n<!--                    </div>-->\n<!--                </div>-->\n<!--            </div>-->\n<!--            <div>-->\n<!--                <button mat-raised-button color=\"primary\"-->\n<!--                        type=\"button\"-->\n<!--                        (click)=\"addRelation()\"-->\n<!--                        matTooltip=\"Add Relation\"-->\n<!--                        matTooltipPosition=\"above\">-->\n<!--                    Add-->\n<!--                </button>-->\n<!--            </div>-->\n<!--        </div>-->\n<!--    </div>-->\n<!--    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">-->\n<!--        <button mat-button color=\"primary\"-->\n<!--                type=\"button\"-->\n<!--                [disabled]=\"(isLoading$ | async)\"-->\n<!--                (click)=\"cancel()\" cdkFocusInitial>-->\n<!--            Cancel-->\n<!--        </button>-->\n<!--        <button mat-button mat-raised-button color=\"primary\"-->\n<!--                type=\"submit\"-->\n<!--                [disabled]=\"(isLoading$ | async) || addEntityForm.invalid || !addEntityForm.dirty\">-->\n<!--            Create-->\n<!--        </button>-->\n<!--    </div>-->\n<!--</form>-->\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "/*=======================================================================*/\n/*=====  There are three examples: for delete, edit and add entity  =====*/\n/*=======================================================================*/\n/*=======================  Delete entity example  =======================*/\n/*=======================================================================*/\n//\n//let $injector = widgetContext.$scope.$injector;\n//let dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\n//let assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n//let deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\n//\n//openDeleteEntityDialog();\n//\n//function openDeleteEntityDialog() {\n//    let title = 'Delete ' + entityId.entityType.toLowerCase() + ' ' +\n//                 entityName;\n//    let content = 'Are you sure you want to delete the ' +\n//                  entityId.entityType.toLowerCase() + ' ' + entityName + '?';\n//    dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n//        function(result) {\n//            if (result) {\n//                deleteEntity();\n//            }\n//        }\n//    );\n//}\n//\n//function deleteEntity() {\n//    deleteEntityObservable(entityId).subscribe(\n//        function success() {\n//            widgetContext.updateAliases();\n//        },\n//        function fail() {\n//            showErrorDialog();\n//        }\n//    );\n//}\n//\n//function deleteEntityObservable(entityId) {\n//    if (entityId.entityType == \"ASSET\") {\n//        return assetService.deleteAsset(entityId.id);\n//    } else if (entityId.entityType == \"DEVICE\") {\n//        return deviceService.deleteDevice(entityId.id);\n//    }\n//}\n//\n//function showErrorDialog() {\n//    let title = 'Error';\n//    let content = 'An error occurred while deleting the entity. Please try again.';\n//    dialogs.alert(title, content, 'CLOSE').subscribe(\n//        function(result) {}\n//    );\n//}\n//\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n//\n//let $injector = widgetContext.$scope.$injector;\n//let customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\n//let entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\n//let assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n//let deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\n//let attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n//let entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\n//\n//openEditEntityDialog();\n//\n//function openEditEntityDialog() {\n//    customDialog.customDialog(htmlTemplate, EditEntityDialogController).subscribe();\n//}\n//\n//function EditEntityDialogController(instance) {\n//    let vm = instance;\n//\n//    vm.entityName = entityName;\n//    vm.entityType = entityId.entityType;\n//    vm.entitySearchDirection = {\n//        from: \"FROM\",\n//        to: \"TO\"\n//    };\n//    vm.attributes = {};\n//    vm.oldRelationsData = [];\n//    vm.relationsToDelete = [];\n//    vm.entity = {};\n//\n//    vm.editEntityFormGroup = vm.fb.group({\n//        entityName: ['', [vm.validators.required]],\n//        entityType: [null],\n//        entityLabel: [null],\n//        type: ['', [vm.validators.required]],\n//        attributes: vm.fb.group({\n//            latitude: [null],\n//            longitude: [null],\n//            address: [null],\n//            owner: [null],\n//            number: [null, [vm.validators.pattern(/^-?[0-9]+$/)]],\n//            booleanValue: [false]\n//        }),\n//        oldRelations: vm.fb.array([]),\n//        relations: vm.fb.array([])\n//    });\n//\n//    getEntityInfo();\n//\n//    vm.cancel = function() {\n//        vm.dialogRef.close(null);\n//    };\n//\n//    vm.relations = function() {\n//        return vm.editEntityFormGroup.get('relations');\n//    };\n//\n//    vm.oldRelations = function() {\n//        return vm.editEntityFormGroup.get('oldRelations');\n//    };\n//\n//    vm.addRelation = function() {\n//        vm.relations().push(vm.fb.group({\n//            relatedEntity: [null, [vm.validators.required]],\n//            relationType: [null, [vm.validators.required]],\n//            direction: [null, [vm.validators.required]]\n//        }));\n//    };\n//\n//    function addOldRelation() {\n//        vm.oldRelations().push(vm.fb.group({\n//            relatedEntity: [{value: null, disabled: true}, [vm.validators.required]],\n//            relationType: [{value: null, disabled: true}, [vm.validators.required]],\n//            direction: [{value: null, disabled: true}, [vm.validators.required]]\n//        }));\n//    }\n//\n//    vm.removeRelation = function(index) {\n//        vm.relations().removeAt(index);\n//        vm.relations().markAsDirty();\n//    };\n//\n//    vm.removeOldRelation = function(index, relation) {\n//        vm.oldRelations().removeAt(index);\n//        vm.relationsToDelete.push(relation);\n//        vm.oldRelations().markAsDirty();\n//    };\n//\n//    vm.save = function() {\n//        vm.editEntityFormGroup.markAsPristine();\n//        widgetContext.rxjs.forkJoin([\n//            saveAttributes(entityId),\n//            saveRelations(entityId),\n//            saveEntity()\n//        ]).subscribe(\n//            function () {\n//                widgetContext.updateAliases();\n//                vm.dialogRef.close(null);\n//            }\n//        );\n//    };\n//\n//    function getEntityAttributes(attributes) {\n//        for (var i = 0; i < attributes.length; i++) {\n//            vm.attributes[attributes[i].key] = attributes[i].value;\n//        }\n//    }\n//\n//    function getEntityRelations(relations) {\n//        let relationsFrom = relations[0];\n//        let relationsTo = relations[1];\n//        for (let i=0; i < relationsFrom.length; i++) {\n//            let relation = {\n//                direction: 'FROM',\n//                relationType: relationsFrom[i].type,\n//                relatedEntity: relationsFrom[i].to\n//            };\n//            vm.oldRelationsData.push(relation);\n//            addOldRelation();\n//        }\n//        for (let i=0; i < relationsTo.length; i++) {\n//            let relation = {\n//                direction: 'TO',\n//                relationType: relationsTo[i].type,\n//                relatedEntity: relationsTo[i].from\n//            };\n//            vm.oldRelationsData.push(relation);\n//            addOldRelation();\n//        }\n//    }\n//\n//    function getEntityInfo() {\n//         widgetContext.rxjs.forkJoin([\n//             entityRelationService.findInfoByFrom(entityId),\n//             entityRelationService.findInfoByTo(entityId),\n//             attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE'),\n//             entityService.getEntity(entityId.entityType, entityId.id)\n//         ]).subscribe(\n//             function (data) {\n//                 getEntityRelations(data.slice(0,2));\n//                 getEntityAttributes(data[2]);\n//                 vm.entity = data[3];\n//                 vm.editEntityFormGroup.patchValue({\n//                     entityName: vm.entity.name,\n//                     entityType: vm.entityType,\n//                     entityLabel: vm.entity.label,\n//                     type: vm.entity.type,\n//                     attributes: vm.attributes,\n//                     oldRelations: vm.oldRelationsData\n//                 }, {emitEvent: false});\n//             }\n//         );\n//     }\n//\n//    function saveEntity() {\n//        const formValues = vm.editEntityFormGroup.value;\n//        if (vm.entity.label !== formValues.entityLabel){\n//            vm.entity.label = formValues.entityLabel;\n//            if (formValues.entityType == 'ASSET') {\n//                return assetService.saveAsset(vm.entity);\n//            } else if (formValues.entityType == 'DEVICE') {\n//                return deviceService.saveDevice(vm.entity);\n//            }\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//\n//    function saveAttributes(entityId) {\n//        let attributes = vm.editEntityFormGroup.get('attributes').value;\n//        let attributesArray = [];\n//        for (let key in attributes) {\n//            if (attributes[key] !== vm.attributes[key]) {\n//                attributesArray.push({key: key, value: attributes[key]});\n//            }\n//        }\n//        if (attributesArray.length > 0) {\n//            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//\n//    function saveRelations(entityId) {\n//        let relations = vm.editEntityFormGroup.get('relations').value;\n//        let tasks = [];\n//        for(let i=0; i < relations.length; i++) {\n//            let relation = {\n//                type: relations[i].relationType,\n//                typeGroup: 'COMMON'\n//            };\n//            if (relations[i].direction == 'FROM') {\n//                relation.to = relations[i].relatedEntity;\n//                relation.from = entityId;\n//            } else {\n//                relation.to = entityId;\n//                relation.from = relations[i].relatedEntity;\n//            }\n//            tasks.push(entityRelationService.saveRelation(relation));\n//        }\n//        for (let i=0; i < vm.relationsToDelete.length; i++) {\n//            let relation = {\n//                type: vm.relationsToDelete[i].relationType\n//            };\n//            if (vm.relationsToDelete[i].direction == 'FROM') {\n//                relation.to = vm.relationsToDelete[i].relatedEntity;\n//                relation.from = entityId;\n//            } else {\n//                relation.to = entityId;\n//                relation.from = vm.relationsToDelete[i].relatedEntity;\n//            }\n//            tasks.push(entityRelationService.deleteRelation(relation.from, relation.type, relation.to));\n//        }\n//        if (tasks.length > 0) {\n//            return widgetContext.rxjs.forkJoin(tasks);\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//}\n//\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n//\n//let $injector = widgetContext.$scope.$injector;\n//let customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\n//let assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\n//let deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\n//let attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n//let entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\n//\n//openAddEntityDialog();\n//\n//function openAddEntityDialog() {\n//    customDialog.customDialog(htmlTemplate, AddEntityDialogController).subscribe();\n//}\n//\n//function AddEntityDialogController(instance) {\n//    let vm = instance;\n//\n//    vm.allowedEntityTypes = ['ASSET', 'DEVICE'];\n//    vm.entitySearchDirection = {\n//        from: \"FROM\",\n//        to: \"TO\"\n//    }\n//\n//    vm.addEntityFormGroup = vm.fb.group({\n//      entityName: ['', [vm.validators.required]],\n//      entityType: ['DEVICE'],\n//      entityLabel: [null],\n//      type: ['', [vm.validators.required]],\n//      attributes: vm.fb.group({\n//          latitude: [null],\n//          longitude: [null],\n//          address: [null],\n//          owner: [null],\n//          number: [null, [vm.validators.pattern(/^-?[0-9]+$/)]],\n//          booleanValue: [null]\n//      }),\n//      relations: vm.fb.array([])\n//    });\n//\n//    vm.cancel = function() {\n//        vm.dialogRef.close(null);\n//    };\n//\n//    vm.relations = function() {\n//        return vm.addEntityFormGroup.get('relations');\n//    };\n//\n//    vm.addRelation = function() {\n//        vm.relations().push(vm.fb.group({\n//          relatedEntity: [null, [vm.validators.required]],\n//          relationType: [null, [vm.validators.required]],\n//          direction: [null, [vm.validators.required]]\n//        }));\n//    };\n//\n//    vm.removeRelation = function(index) {\n//        vm.relations().removeAt(index);\n//        vm.relations().markAsDirty();\n//    };\n//\n//    vm.save = function() {\n//        vm.addEntityFormGroup.markAsPristine();\n//        saveEntityObservable().subscribe(\n//            function (entity) {\n//                widgetContext.rxjs.forkJoin([\n//                    saveAttributes(entity.id),\n//                    saveRelations(entity.id)\n//                ]).subscribe(\n//                    function () {\n//                        widgetContext.updateAliases();\n//                        vm.dialogRef.close(null);\n//                    }\n//                );\n//            }\n//        );\n//    };\n//\n//    function saveEntityObservable() {\n//        const formValues = vm.addEntityFormGroup.value;\n//        let entity = {\n//            name: formValues.entityName,\n//            type: formValues.type,\n//            label: formValues.entityLabel\n//        };\n//        if (formValues.entityType == 'ASSET') {\n//            return assetService.saveAsset(entity);\n//        } else if (formValues.entityType == 'DEVICE') {\n//            return deviceService.saveDevice(entity);\n//        }\n//    }\n//\n//    function saveAttributes(entityId) {\n//        let attributes = vm.addEntityFormGroup.get('attributes').value;\n//        let attributesArray = [];\n//        for (let key in attributes) {\n//            if(attributes[key] !== null) {\n//                attributesArray.push({key: key, value: attributes[key]});\n//            }\n//        }\n//        if (attributesArray.length > 0) {\n//            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//\n//    function saveRelations(entityId) {\n//        let relations = vm.addEntityFormGroup.get('relations').value;\n//        let tasks = [];\n//        for(let i=0; i < relations.length; i++) {\n//            let relation = {\n//                type: relations[i].relationType,\n//                typeGroup: 'COMMON'\n//            };\n//            if (relations[i].direction == 'FROM') {\n//                relation.to = relations[i].relatedEntity;\n//                relation.from = entityId;\n//            } else {\n//                relation.to = entityId;\n//                relation.from = relations[i].relatedEntity;\n//            }\n//            tasks.push(entityRelationService.saveRelation(relation));\n//        }\n//        if (tasks.length > 0) {\n//            return widgetContext.rxjs.forkJoin(tasks);\n//        }\n//        return widgetContext.rxjs.of([]);\n//    }\n//}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "de8b83e9-cadb-9935-a0a3-45e634805302"
              }
            ]
          },
          "showTitleIcon": false,
          "titleIcon": "list",
          "iconColor": null,
          "titleFont": null,
          "titleColor": null,
          "enableDataExport": true,
          "desktopHide": true
        },
        "row": 0,
        "col": 0,
        "id": "298ac1a0-d9bc-068d-9f2d-2019aee5b38b"
      },
      "8fea4189-280f-2e44-cbe0-960041160a6d": {
        "typeFullFqn": "system.action_button",
        "type": "latest",
        "sizeX": 3,
        "sizeY": 1,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1718798104772,
                "endTimeMs": 1718884504772
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#FFFFFF01",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "activatedState": {
              "action": "GET_DASHBOARD_STATE",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": "Doktorkit_devices_table",
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              },
              "executeRpc": {
                "method": null,
                "requestTimeout": null,
                "requestPersistent": null,
                "persistentPollingInterval": null
              }
            },
            "disabledState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "appearance": {
              "type": "outlined",
              "showLabel": true,
              "label": "Manage Gateways",
              "showIcon": true,
              "icon": "router",
              "iconSize": 24,
              "iconSizeUnit": "px",
              "mainColor": "#3D9BE9",
              "backgroundColor": "#FFFFFF",
              "autoScale": true,
              "customStyle": {
                "enabled": null,
                "hovered": null,
                "pressed": null,
                "activated": null,
                "disabled": null
              }
            }
          },
          "title": "Action button",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "borderRadius": "4px",
          "configMode": "advanced",
          "actions": {
            "click": [
              {
                "name": "onClick",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "updateDashboardState",
                "targetDashboardStateId": "Gateways_devices_table",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "bd80b787-5b71-a945-c4c6-b80018b0b9e6"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "8fea4189-280f-2e44-cbe0-960041160a6d"
      },
      "56a1ecae-2de0-84e3-30c9-84e00149a66a": {
        "typeFullFqn": "system.action_button",
        "type": "latest",
        "sizeX": 3,
        "sizeY": 1,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1718798104772,
                "endTimeMs": 1718884504772
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#FFFFFF01",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "activatedState": {
              "action": "GET_DASHBOARD_STATE",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": "Doktorkit_devices_plan",
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              },
              "executeRpc": {
                "method": null,
                "requestTimeout": null,
                "requestPersistent": null,
                "persistentPollingInterval": null
              }
            },
            "disabledState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "appearance": {
              "type": "outlined",
              "showLabel": true,
              "label": "Manage Kit Devices",
              "showIcon": true,
              "icon": "devices_other",
              "iconSize": 24,
              "iconSizeUnit": "px",
              "mainColor": "#3D9BE9",
              "backgroundColor": "#FFFFFF",
              "autoScale": true,
              "customStyle": {
                "enabled": null,
                "hovered": null,
                "pressed": null,
                "activated": null,
                "disabled": null
              }
            }
          },
          "title": "Action button",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "borderRadius": "4px",
          "configMode": "advanced",
          "actions": {
            "click": [
              {
                "name": "onClick",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "updateDashboardState",
                "targetDashboardStateId": "kit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "bd80b787-5b71-a945-c4c6-b80018b0b9e6"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "56a1ecae-2de0-84e3-30c9-84e00149a66a"
      },
      "6f741a6d-8f2a-948e-1375-4aa557212d48": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\r\n     <div fxLayout=\"row\" style=\"width: 100%; height: 40px; justify-content: flex-start;\" fxLayoutAlign=\"start start\">\r\n        <h5 fxFlex class=\"market-title\">Devices</h5>\r\n        <div style=\"margin-right: 30px;\">\r\n        <button id=\"add-device\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">add</mat-icon><span>Add device manually</span></button>\r\n        <button id=\"replace-device\" mat-raised-button color=\"primary\" style=\"display: none;\">\r\n                <mat-icon class=\"tb-mat-20\">add</mat-icon>\r\n                <span>Replace Device</span>\r\n        </button>\r\n        </div> \r\n     </div>\r\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\r\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"doktorkit_devices_header_buttons\"></tb-dashboard-state>\r\n    </div>\r\n</div>\r\n",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-container .tb-widget .tb-multiple-input {\n    background-color: #FAFAFA;\n    border-radius: 4px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .input-field {\n    padding-right: 30px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input mat-slide-toggle {\n    margin-top: 15px !important;\n    margin-bottom: 0 !important;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-slide-toggle-content {\n    width: 120px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-bar {\n    width: 42px;\n    height: 24px;\n    border-radius: 16px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb-container {\n    top: 2px;\n    left: 2px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-thumb-container {\n    transform: translate3d(18px, 0, 0);\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb {\n    background-color: #fafafa;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-bar {\n    background-color: #F2994A;\n}\n",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "add-device",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDeviceFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 800px;\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Add device</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-horizontal-stepper formGroupName=\"stepper\" linear>\r\n      <mat-step formGroupName=\"assignmentStep\" label=\"Assignment\">\r\n        <ng-template matStepLabel>Assignment</ng-template>\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Device</mat-label>\r\n          <mat-select formControlName=\"device\" required>\r\n            <mat-select-trigger>\r\n              <div class=\"device-item\" fxLayout=\"row\">\r\n                <div fxLayout=\"column\" fxFlex>\r\n                  <div>{{addDeviceFormGroup.get('stepper.assignmentStep.device').value?.label}}</div>\r\n                  <div class=\"device-name\">{{addDeviceFormGroup.get('stepper.assignmentStep.device').value?.name}}</div>\r\n                </div>\r\n                <div class=\"device-type\">{{addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type}}</div>\r\n              </div>\r\n            </mat-select-trigger>\r\n            <mat-option *ngFor=\"let device of availableDevices\" [value]=\"device\">\r\n              <div class=\"device-item\" fxLayout=\"row\">\r\n                <div fxLayout=\"column\" fxFlex>\r\n                  <div>{{device?.label}}</div>\r\n                  <div class=\"device-name\">{{device?.name}}</div>\r\n                </div>\r\n                <div class=\"device-type\">{{device?.type}}</div>\r\n              </div>\r\n              <mat-divider></mat-divider>\r\n            </mat-option>\r\n            <mat-option *ngIf=\"!availableDevices?.length\" disabled [value]=\"null\">\r\n              <div class=\"device-item\">\r\n                No devices available\r\n              </div>\r\n            </mat-option>\r\n          </mat-select>\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').hasError('required')\">\r\n            Device is required.\r\n          </mat-error>\r\n        </mat-form-field>\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Label</mat-label>\r\n          <input matInput formControlName=\"label\">\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.label').hasError('required')\">\r\n            Device label is required.\r\n          </mat-error>\r\n        </mat-form-field>\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\"\r\n                  type=\"button\"\r\n                  [disabled]=\"(isLoading$ | async)\"\r\n                  (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n          </button>\r\n          <button mat-button matStepperNext color=\"primary\" type=\"button\">\r\n            Next\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n      <mat-step formGroupName=\"attributesStep\" label=\"Attributes\" *ngIf=\"showAttributesStep\">\r\n        <ng-template matStepLabel>Attributes</ng-template>\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Installation Type</mat-label>\r\n          <mat-select formControlName=\"installationType\" required>\r\n            <mat-option value=\"heating\">Heating</mat-option>\r\n            <mat-option value=\"cooling\">Cooling</mat-option>\r\n          </mat-select>\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationType').hasError('required')\">\r\n            Installation Type is required.\r\n          </mat-error>\r\n        </mat-form-field>\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Outside Temperature Threshold</mat-label>\r\n          <input matInput formControlName=\"loadCourseAnalysisTemperature\" type=\"number\">\r\n        </mat-form-field>\r\n        <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n          <mat-form-field class=\"mat-block\" fxFlex>\r\n            <mat-label>Outside Temperature Threshold Setting</mat-label>\r\n            <mat-select formControlName=\"loadCourseFilterTemperature\" required>\r\n              <mat-option value=\"above\">Above</mat-option>\r\n              <mat-option value=\"below\">Below</mat-option>\r\n            </mat-select>\r\n            <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.loadCourseFilterTemperature').hasError('required')\">\r\n              Temperature Condition is required.\r\n            </mat-error>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"mat-block\" fxFlex>\r\n            <mat-label>Outside Temperature Threshold</mat-label>\r\n            <input matInput formControlName=\"loadCourseFilterTemperatureValue\" type=\"number\">\r\n          </mat-form-field>\r\n        </div>\r\n        <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n        <mat-form-field class=\"mat-block\" fxFlex>\r\n          <mat-label>Maximum Power Threshold</mat-label>\r\n          <input matInput formControlName=\"loadCourseFilterMaxPower\" type=\"number\">\r\n        </mat-form-field>\r\n        <mat-form-field class=\"mat-block\" fxFlex>\r\n          <mat-label>Nominal Flow</mat-label>\r\n          <input matInput formControlName=\"nominalFlow\" type=\"number\">\r\n        </mat-form-field>\r\n        </div>\r\n        <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n          <mat-form-field class=\"mat-block\" fxFlex>\r\n            <mat-label>Delta T</mat-label>\r\n            <input matInput formControlName=\"deltaT\" type=\"number\">\r\n          </mat-form-field>\r\n          <mat-form-field class=\"mat-block\" fxFlex>\r\n            <mat-label>Circulation Pump Energy Consumption</mat-label>\r\n            <input matInput formControlName=\"deltaTAnalysisPumpEnergy\" type=\"number\">\r\n          </mat-form-field>\r\n          <mat-form-field class=\"mat-block\" fxFlex>\r\n            <mat-label>Floor Volume (l/h)</mat-label>\r\n            <input matInput formControlName=\"deltaTAnalysisFloorVolume\" type=\"number\">\r\n          </mat-form-field>\r\n        </div>\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\"\r\n                  type=\"button\"\r\n                  [disabled]=\"(isLoading$ | async)\"\r\n                  (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n          </button>\r\n          <button mat-button matStepperPrevious color=\"primary\" type=\"button\">\r\n            Back\r\n          </button>\r\n          <button mat-button matStepperNext color=\"primary\" type=\"button\">\r\n            Next\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n      <mat-step formGroupName=\"alarmThresholdsStep\" label=\"Alarm Thresholds\">\r\n        <ng-template matStepLabel>Alarm Thresholds</ng-template>\r\n        <div *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type === 'P-Flow D116'\">\r\n        <div fxLayout=\"row\" fxLayoutGap=\"24px\">\r\n          <div fxFlex=\"50%\">\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Volume Flow Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"maxVolumeFlowCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Energy Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"maxEnergyCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Min Temperature Difference Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"minTemperatureDifferenceCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n          <div fxFlex=\"50%\">\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Volume Flow Major Threshold</mat-label>\r\n              <input matInput formControlName=\"maxVolumeFlowMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Energy Major Threshold</mat-label>\r\n              <input matInput formControlName=\"maxEnergyMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Min Temperature Difference Major Threshold</mat-label>\r\n              <input matInput formControlName=\"minTemperatureDifferenceMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n        </div>\r\n        </div>\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\"\r\n                  type=\"button\"\r\n                  [disabled]=\"(isLoading$ | async)\"\r\n                  (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n          </button>\r\n          <button mat-button matStepperPrevious color=\"primary\" type=\"button\">\r\n            Back\r\n          </button>\r\n          <button mat-button mat-raised-button color=\"primary\"\r\n                  type=\"submit\"\r\n                  [disabled]=\"(isLoading$ | async) || addDeviceFormGroup.invalid\">\r\n            Save\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>\r\n\r\n",
                "customCss": "\n.device-item {\n    line-height: 24px;\n    width: 100%;\n    padding-top: 8px;\n    padding-bottom: 8px;\n}\n\n.device-item .device-name {\n    font-size: 12px;\n    opacity: 0.7;\n}\n\n.device-item .device-type {\n    font-size: 14px;\n    opacity: 0.7;\n}\n\nmat-option {\n    height: auto !important;\n    white-space: normal !important;\n}\n\n.mat-select-value-text {\n    display: block;\n    width: 100%;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\n\r\nif (additionalParams.source === \"replace Device\") {\r\n    if (additionalParams.choice === true) {\r\n        openAddDeviceDialog();\r\n    } else {\r\n        // Handle other cases if needed\r\n    }\r\n} else if (additionalParams.source !== \"replace Device\") {\r\n    openAddDeviceDialog();\r\n}\r\n\r\nfunction openAddDeviceDialog() {\r\n    customDialog.customDialog(htmlTemplate, AddDeviceDialogController).subscribe();\r\n}\r\n\r\nfunction AddDeviceDialogController(instance) {\r\n    let vm = instance;\r\n\r\n    vm.addDeviceFormGroup = vm.fb.group({\r\n        stepper: vm.fb.group({\r\n            assignmentStep: vm.fb.group({\r\n                device: [null, [vm.validators.required]],\r\n                label: [{ value: null, disabled: true }]\r\n            }),\r\n            attributesStep: vm.fb.group({\r\n                installationType: ['heating', [vm.validators.required]],\r\n                loadCourseAnalysisTemperature: [null],\r\n                loadCourseFilterTemperature: ['above', [vm.validators.required]],\r\n                loadCourseFilterTemperatureValue: [null],\r\n                loadCourseFilterMaxPower: [null],\r\n                nominalFlow: [null],\r\n                deltaT: [null],\r\n                deltaTAnalysisPumpEnergy: [null],\r\n                deltaTAnalysisFloorVolume: [null],\r\n            }),\r\n            alarmThresholdsStep: vm.fb.group({\r\n                maxVolumeFlowCriticalThreshold: [null],\r\n                maxVolumeFlowMajorThreshold: [null],\r\n                maxEnergyCriticalThreshold: [null],\r\n                maxEnergyMajorThreshold: [null],\r\n                minTemperatureDifferenceCriticalThreshold: [null],\r\n                minTemperatureDifferenceMajorThreshold: [null],\r\n            })\r\n        })\r\n    });\r\n    \r\n     // Set initial deltaT based on default installationType\r\n    let initialInstallationType = vm.addDeviceFormGroup.get('stepper.attributesStep.installationType').value;\r\n    if (initialInstallationType === 'heating') {\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.deltaT').patchValue(15);\r\n    } else if (initialInstallationType === 'cooling') {\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.deltaT').patchValue(6);\r\n    }\r\n    \r\n    // Watch for changes in installationType to set default deltaT value\r\n    vm.addDeviceFormGroup.get('stepper.attributesStep.installationType').valueChanges.subscribe((installationType) => {\r\n        if (installationType === 'heating') {\r\n            vm.addDeviceFormGroup.get('stepper.attributesStep.deltaT').patchValue(15);\r\n        } else if (installationType === 'cooling') {\r\n            vm.addDeviceFormGroup.get('stepper.attributesStep.deltaT').patchValue(6);\r\n        }\r\n    });\r\n    // Additional state to control the visibility of the attributes step\r\n    vm.showAttributesStep = true;\r\n\r\n    vm.addDeviceFormGroup.get('stepper.assignmentStep.device').valueChanges.subscribe((device) => {\r\n        vm.addDeviceFormGroup.get('stepper.assignmentStep.label').patchValue(device.label, { emitEvent: false });\r\n        vm.addDeviceFormGroup.get('stepper.assignmentStep.label').enable({ emitEvent: false });\r\n        vm.addDeviceFormGroup.get('stepper.assignmentStep.label').updateValueAndValidity({ onlySelf: true });\r\n    });\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n    var DoktorkitId = widgetContext.stateController.getStateParams().selectedDoktorkit.entityId;\r\n    vm.addDeviceFormGroup.markAsPristine();\r\n    var device = vm.addDeviceFormGroup.value.stepper.assignmentStep.device;\r\n    var label = vm.addDeviceFormGroup.value.stepper.assignmentStep.label;\r\n    var installationType = vm.addDeviceFormGroup.value.stepper.attributesStep.installationType;\r\n    var maxVolumeFlowCriticalThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.maxVolumeFlowCriticalThreshold;\r\n    var maxVolumeFlowMajorThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.maxVolumeFlowMajorThreshold;\r\n    var loadCourseAnalysisTemperature = vm.addDeviceFormGroup.value.stepper.attributesStep.loadCourseAnalysisTemperature;\r\n    var loadCourseFilterTemperature = vm.addDeviceFormGroup.value.stepper.attributesStep.loadCourseFilterTemperature;\r\n    var loadCourseFilterTemperatureValue = vm.addDeviceFormGroup.value.stepper.attributesStep.loadCourseFilterTemperatureValue;\r\n    var loadCourseFilterMaxPower = vm.addDeviceFormGroup.value.stepper.attributesStep.loadCourseFilterMaxPower;\r\n    var nominalFlow = vm.addDeviceFormGroup.value.stepper.attributesStep.nominalFlow;\r\n    var deltaT = vm.addDeviceFormGroup.value.stepper.attributesStep.deltaT;\r\n    var deltaTAnalysisPumpEnergy = vm.addDeviceFormGroup.value.stepper.attributesStep.deltaTAnalysisPumpEnergy;\r\n    var deltaTAnalysisFloorVolume = vm.addDeviceFormGroup.value.stepper.attributesStep.deltaTAnalysisFloorVolume;\r\n    var maxEnergyCriticalThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.maxEnergyCriticalThreshold;\r\n    var maxEnergyMajorThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.maxEnergyMajorThreshold;\r\n    var minTemperatureDifferenceCriticalThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.minTemperatureDifferenceCriticalThreshold;\r\n    var minTemperatureDifferenceMajorThreshold = vm.addDeviceFormGroup.value.stepper.alarmThresholdsStep.minTemperatureDifferenceMajorThreshold;\r\n    var deviceId = device.deviceId;\r\n    \r\n    widgetContext.rxjs.forkJoin([\r\n        entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n        saveDeviceToDoktorkitRelation(DoktorkitId, deviceId),\r\n        saveAttributes(\r\n            deviceId,\r\n            installationType,\r\n            maxVolumeFlowCriticalThreshold,\r\n            maxVolumeFlowMajorThreshold,\r\n            loadCourseAnalysisTemperature,\r\n            loadCourseFilterTemperature,\r\n            loadCourseFilterTemperatureValue,\r\n            loadCourseFilterMaxPower,\r\n            nominalFlow,\r\n            deltaT,\r\n            deltaTAnalysisPumpEnergy,\r\n            deltaTAnalysisFloorVolume,\r\n            maxEnergyCriticalThreshold,\r\n            maxEnergyMajorThreshold,\r\n            minTemperatureDifferenceCriticalThreshold,\r\n            minTemperatureDifferenceMajorThreshold\r\n        ),\r\n        updateDeviceLabel(device, label)\r\n    ]).subscribe(() => {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n    });\r\n};\r\n\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedDevicesGroup = null;\r\n        vm.assignedDevicesGroup = null;\r\n        vm.availableDevices = [];\r\n        vm.assignedDevices = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'DEVICE').subscribe((entityGroups) => {\r\n            vm.customerDevicesGroups = entityGroups;\r\n            vm.unassignedDevicesGroup = entityGroups.find(group => group.name === 'Unassigned Doktorkit Devices');\r\n            vm.assignedDevicesGroup = entityGroups.find(group => group.name === 'Doktorkit Devices');\r\n            if (vm.unassignedDevicesGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.unassignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    vm.availableDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            deviceId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n\r\n                });\r\n            }\r\n            if (vm.assignedDevicesGroup) {\r\n                var query2 = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.assignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query2).subscribe((data) => {\r\n                    vm.assignedDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            deviceId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                    if (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Device\") {\r\n                        checkAdditionalParams();\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    function saveDeviceToDoktorkitRelation(DoktorkitId, deviceId) {\r\n        var relation = {\r\n            from: DoktorkitId,\r\n            to: deviceId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Contains'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function saveAttributes(entityId, installationType, maxVolumeFlowCriticalThreshold, maxVolumeFlowMajorThreshold, loadCourseAnalysisTemperature, loadCourseFilterTemperature, loadCourseFilterTemperatureValue, loadCourseFilterMaxPower, nominalFlow,deltaT, deltaTAnalysisPumpEnergy, deltaTAnalysisFloorVolume, maxEnergyCriticalThreshold, maxEnergyMajorThreshold, minTemperatureDifferenceCriticalThreshold, minTemperatureDifferenceMajorThreshold, highCo2CriticalThreshold, highCo2MajorThreshold, highTemperatureCriticalThreshold, highHumidityCriticalThreshold, highTemperatureMajorThreshold, highHumidityMajorThreshold) {\r\n    let attributesArray = [\r\n        { key: 'xPos', value: 0.5 },\r\n        { key: 'yPos', value: 0.5 },\r\n        { key: 'installationType', value: installationType },\r\n        { key: 'maxVolumeFlowCriticalThreshold', value: maxVolumeFlowCriticalThreshold },\r\n        { key: 'maxVolumeFlowMajorThreshold', value: maxVolumeFlowMajorThreshold },\r\n        { key: 'loadCourseAnalysisTemperature', value: loadCourseAnalysisTemperature },\r\n        { key: 'loadCourseFilterTemperature', value: loadCourseFilterTemperature },\r\n        { key: 'loadCourseFilterTemperatureValue', value: loadCourseFilterTemperatureValue },\r\n        { key: 'loadCourseFilterMaxPower', value: loadCourseFilterMaxPower },\r\n        { key: 'nominalFlow', value: nominalFlow },\r\n        { key: 'deltaT', value: deltaT },\r\n        { key: 'deltaTAnalysisPumpEnergy', value: deltaTAnalysisPumpEnergy },\r\n        { key: 'deltaTAnalysisFloorVolume', value: deltaTAnalysisFloorVolume },\r\n        { key: 'maxEnergyCriticalThreshold', value: maxEnergyCriticalThreshold },\r\n        { key: 'maxEnergyMajorThreshold', value: maxEnergyMajorThreshold },\r\n        { key: 'minTemperatureDifferenceCriticalThreshold', value: minTemperatureDifferenceCriticalThreshold },\r\n        { key: 'minTemperatureDifferenceMajorThreshold', value: minTemperatureDifferenceMajorThreshold }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n}\r\n\r\n\r\n    function updateDeviceLabel(device, label) {\r\n        if (device.label !== label) {\r\n            return deviceService.getDevice(device.deviceId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origDevice) => {\r\n                    origDevice.label = label;\r\n                    return deviceService.saveDevice(origDevice);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableDevice = vm.availableDevices.find(device => device.name === additionalParams.code);\r\n        const matchingAssignedDevice = vm.assignedDevices.find(device => device.name === additionalParams.code);\r\n\r\n                if (!matchingAvailableDevice && !matchingAssignedDevice) {\r\n            widgetContext.dialogs.alert(\"Device doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedDevice && !matchingAvailableDevice) {\r\n            getDoktorkit(additionalParams.code);\r\n        }\r\n        if (matchingAvailableDevice && matchingAssignedDevice) {\r\n            vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { device: matchingAvailableDevice } } }, { emitEvent: false });\r\n            vm.addDeviceFormGroup.get('stepper.assignmentStep.device').markAsDirty();\r\n            vm.addDeviceFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('mat-select[formControlName=\"device\"]');\r\n                if (selectElement) {\r\n                    selectElement.dispatchEvent(new Event('change'));\r\n                }\r\n\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n\r\n    function getDoktorkit(code) {\r\n        vm.deviceEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToDoktorkit = null;\r\n\r\n        deviceService.findByName(code)\r\n            .pipe(\r\n                widgetContext.rxjs.map((origDevice) => {\r\n                    vm.deviceEntityId = origDevice.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.deviceEntityId, 'entityType': 'DEVICE' }).pipe(\r\n                    widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations).pipe(\r\n                        widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToDoktorkit = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-device\");\r\n                        let params = {\r\n                            \"doktorkit\": vm.assignedToDoktorkit,\r\n                            \"device\": vm.deviceEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7cad1c71-0765-4277-32a8-c87808a0c689"
              },
              {
                "name": "replace-device",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<!-- replace-device-dialog.component.html -->\r\n<div class=\"replace-device-dialog-form\" style=\"width: 400px;\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Replace Device</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-dialog-content fxLayout=\"column\" class=\"mat-typography\">\r\n    <p>{{ confirmationMessage }}</p>\r\n  </mat-dialog-content>\r\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n    <button mat-button color=\"primary\" (click)=\"cancel()\" type=\"button\" cdkFocusInitial>\r\n      No\r\n    </button>\r\n    <button mat-button mat-raised-button color=\"primary\" (click)=\"confirm()\" type=\"button\">\r\n      Yes\r\n    </button>\r\n  </div>\r\n</div>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\nlet qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"add-device\");\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\n\nopenReplaceDeviceDialog();\n\nfunction openReplaceDeviceDialog() {\n    customDialog.customDialog(htmlTemplate, ReplaceDeviceDialogController).subscribe();\n}\n\nfunction returnSelection(replaceDevice) {\n    let params = {\n        source: \"replace Device\",\n        choice: replaceDevice // Use event.replaceDevice instead of replaceDevice directly\n    };\n    //widgetContext.dialogs.alert(\"User selected 2\" + replaceDevice.toString() + \"!\");\n    try {\n        widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\n    } catch (error) {\n        widgetContext.dialogs.alert('Error handling widget action:', error);\n    }\n}\n\nfunction ReplaceDeviceDialogController(instance) {\n    let vm = instance;\n    let replaceDevice;\n    //widgetContext.dialogs.alert(\"Aditional Params: \" + JSON.stringify(additionalParams) + additionalParams.device);\n\n    vm.confirmationMessage = \"Device is already assigned to \" + additionalParams.doktorkit + \"!\\n\" +\n        \"Do you want to remove it from \" + additionalParams.doktorkit + \" and assign it to the current one?\";\n\n    vm.cancel = function() {\n        replaceDevice = false; // Set replaceDevice to false\n        vm.handleConfirm({ replaceDevice: replaceDevice });\n    };\n\n    vm.confirm = function() {\n        let entityId = { 'id': additionalParams.device, 'entityType': 'DEVICE' };\n        let entityGroupId = \"684410d0-bfae-11ee-8196-b3999b4a11b6\";\n        //widgetContext.dialogs.alert(\"Additional Params: \" + JSON.stringify(entityId));\n        try {\n            entityRelationService.deleteRelations(entityId).subscribe(\n                () => {\n                    try {\n                        entityGroupService.addEntityToEntityGroup(entityGroupId, entityId.id).subscribe(\n                            () => {\n                                replaceDevice = true; // Set replaceDevice to true\n                                vm.handleConfirm({ replaceDevice: replaceDevice });\n                            },\n                            error => {\n                                widgetContext.dialogs.alert('Error handling add to Group action: ' + JSON.stringify(error));\n                            }\n                        );\n                    } catch (error) {\n                        widgetContext.dialogs.alert('Error initiating addEntityToEntityGroup: ' + JSON.stringify(error));\n                    }\n                },\n                error => {\n                    widgetContext.dialogs.alert('Error handling deleteRelations: ' + JSON.stringify(error));\n                }\n            );\n        } catch (error) {\n            widgetContext.dialogs.alert('Error initiating deleteRelations: ' + JSON.stringify(error));\n        }\n    };\n\n    vm.handleConfirm = function(event) {\n        vm.dialogRef.close(event);\n        let params = {\n            source: \"replace Device\",\n            choice: event.replaceDevice, // Use event.replaceDevice instead of replaceDevice directly\n            device: additionalParams.device,\n            code: additionalParams.code\n        };\n        try {\n            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\n        } catch (error) {\n            widgetContext.dialogs.alert('Error handling widget action:', error);\n        }\n    };\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "c45ba341-9bcd-8608-b0f5-15317d44eb8a"
              }
            ],
            "headerButton": [
              {
                "name": "qr-code",
                "icon": "qr_code_scanner",
                "useShowWidgetActionFunction": false,
                "showWidgetActionFunction": "return true;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "scanQrCode",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Scan QR code action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to scan QR code', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processQrCodeFunction": "// Function body to process result of QR code scanning. \n// - code - scanned QR code\n// - format - scanned QR code format\n//widgetContext.actionsApi.qrCodeCallback(code);\nlet $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\nlet qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"add-device\");\n\nlet params = {\n    source: \"qrcode\",\n    code: code\n}\ntry {\n    widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\n} catch (error) {\n    widgetContext.dialogs.alert('Error handling widget action:', error);\n}\n\n//showQrCodeDialog(\"Code\", code, format);\nfunction showQrCodeDialog(title, code, format) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Code: ['+code+']<br>Format: ' + format).subscribe();\n    }, 100);\n}\n\n"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "01671463-1c6c-41bb-da25-4eb5ee1ef842"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "6f741a6d-8f2a-948e-1375-4aa557212d48",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "e0b5a782-3ec3-af12-bfdd-6b097611aad3": {
        "typeFullFqn": "system.cards.markdown_card",
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "d13f6078-0d81-ec59-529c-64acbbcaf470",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1719396870991,
                "endTimeMs": 1719483270991
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\r\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\r\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_table_doktorkit\"></tb-dashboard-state>\r\n    </div>\r\n</div>\r\n",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "enableDataExport": false,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": ""
        },
        "row": 0,
        "col": 0,
        "id": "e0b5a782-3ec3-af12-bfdd-6b097611aad3"
      },
      "c0492355-0350-78f2-ad14-459ab9d07820": {
        "typeFullFqn": "system.input_widgets.update_multiple_attributes",
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "dataKeys": [
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "Kit ID",
                  "color": "#f44336",
                  "settings": {
                    "dataKeyHidden": false,
                    "dataKeyType": "server",
                    "dataKeyValueType": "string",
                    "required": false,
                    "isEditable": "readonly",
                    "disabledOnDataKey": "",
                    "appearance": "outline",
                    "subscriptSizing": "fixed",
                    "slideToggleLabelPosition": "after",
                    "selectOptions": [],
                    "step": 1,
                    "minValue": null,
                    "maxValue": null,
                    "requiredErrorMessage": "",
                    "minValueErrorMessage": "",
                    "maxValueErrorMessage": "",
                    "invalidDateErrorMessage": "",
                    "invalidJsonErrorMessage": "",
                    "dialogTitle": "",
                    "saveButtonLabel": "",
                    "cancelButtonLabel": "",
                    "useCustomIcon": false,
                    "icon": "",
                    "customIcon": "",
                    "useGetValueFunction": false,
                    "getValueFunctionBody": "",
                    "useSetValueFunction": false,
                    "setValueFunctionBody": ""
                  },
                  "_hash": 0.7261262741197994,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "measurementID",
                  "type": "attribute",
                  "label": "Measurement ID",
                  "color": "#607d8b",
                  "settings": {
                    "dataKeyHidden": false,
                    "dataKeyType": "server",
                    "dataKeyValueType": "string",
                    "required": false,
                    "isEditable": "readonly",
                    "disabledOnDataKey": "",
                    "appearance": "outline",
                    "subscriptSizing": "fixed",
                    "slideToggleLabelPosition": "after",
                    "selectOptions": [],
                    "step": 1,
                    "minValue": null,
                    "maxValue": null,
                    "requiredErrorMessage": "",
                    "minValueErrorMessage": "",
                    "maxValueErrorMessage": "",
                    "invalidDateErrorMessage": "",
                    "invalidJsonErrorMessage": "",
                    "dialogTitle": "",
                    "saveButtonLabel": "",
                    "cancelButtonLabel": "",
                    "useCustomIcon": false,
                    "icon": "",
                    "customIcon": "",
                    "useGetValueFunction": false,
                    "getValueFunctionBody": "",
                    "useSetValueFunction": false,
                    "setValueFunctionBody": ""
                  },
                  "_hash": 0.11964468670304629,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "installationLocation",
                  "type": "attribute",
                  "label": "Installation Location",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.9713428384988825,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1707571374578,
                "endTimeMs": 1707657774578
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": null,
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "40",
          "settings": {
            "widgetTitle": "Doktorkit Attributes",
            "showResultMessage": true,
            "showActionButtons": true,
            "updateAllValues": true,
            "saveButtonLabel": "Save",
            "resetButtonLabel": "Undo",
            "showGroupTitle": false,
            "groupTitle": "${entityName}",
            "fieldsAlignment": "row",
            "fieldsInRow": 2,
            "rowGap": 5,
            "columnGap": 10
          },
          "title": "Update Multiple Attributes",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "actions": {
            "headerButton": []
          },
          "displayTimewindow": true,
          "showTitleIcon": false,
          "titleTooltip": "",
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "titleIcon": null,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px"
        },
        "row": 0,
        "col": 0,
        "id": "c0492355-0350-78f2-ad14-459ab9d07820"
      },
      "62d3c5ad-3b0a-49c2-60b0-c3d2d78dcc46": {
        "typeFullFqn": "system.action_button",
        "type": "latest",
        "sizeX": 3,
        "sizeY": 1,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1718798104772,
                "endTimeMs": 1718884504772
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#FFFFFF01",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "activatedState": {
              "action": "GET_DASHBOARD_STATE",
              "defaultValue": false,
              "executeRpc": {
                "method": null,
                "requestTimeout": null,
                "requestPersistent": null,
                "persistentPollingInterval": null
              },
              "getAttribute": {
                "scope": null,
                "key": "state"
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;",
                "compareToValue": "Doktorkit_devices_table"
              }
            },
            "disabledState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "appearance": {
              "type": "outlined",
              "showLabel": true,
              "label": "Table",
              "showIcon": true,
              "icon": "insert_chart",
              "iconSize": 24,
              "iconSizeUnit": "px",
              "mainColor": "#3D9BE9",
              "backgroundColor": "#FFFFFF",
              "autoScale": true,
              "customStyle": {
                "enabled": null,
                "hovered": null,
                "pressed": null,
                "activated": null,
                "disabled": null
              }
            }
          },
          "title": "Action button",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "borderRadius": "4px",
          "configMode": "advanced",
          "actions": {
            "click": [
              {
                "name": "onClick",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "updateDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "bd80b787-5b71-a945-c4c6-b80018b0b9e6"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "62d3c5ad-3b0a-49c2-60b0-c3d2d78dcc46"
      },
      "e3259a6e-5292-1b14-0589-6910138536e4": {
        "typeFullFqn": "system.action_button",
        "type": "latest",
        "sizeX": 3,
        "sizeY": 1,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1718798104772,
                "endTimeMs": 1718884504772
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#FFFFFF01",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "activatedState": {
              "action": "GET_DASHBOARD_STATE",
              "defaultValue": false,
              "executeRpc": {
                "method": null,
                "requestTimeout": null,
                "requestPersistent": null,
                "persistentPollingInterval": null
              },
              "getAttribute": {
                "scope": null,
                "key": "state"
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;",
                "compareToValue": "Doktorkit_devices_plan"
              }
            },
            "disabledState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "appearance": {
              "type": "outlined",
              "showLabel": true,
              "label": "Plan",
              "showIcon": true,
              "icon": "insert_chart",
              "iconSize": 24,
              "iconSizeUnit": "px",
              "mainColor": "#3D9BE9",
              "backgroundColor": "#FFFFFF",
              "autoScale": true,
              "customStyle": {
                "enabled": null,
                "hovered": null,
                "pressed": null,
                "activated": null,
                "disabled": null
              }
            }
          },
          "title": "Action button",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "borderRadius": "4px",
          "configMode": "advanced",
          "actions": {
            "click": [
              {
                "name": "onClick",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "updateDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_plan",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "bd80b787-5b71-a945-c4c6-b80018b0b9e6"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "e3259a6e-5292-1b14-0589-6910138536e4"
      },
      "5edfc189-61b4-a221-d5b5-c57a2bcf7960": {
        "typeFullFqn": "system.cards.markdown_card",
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "d13f6078-0d81-ec59-529c-64acbbcaf470",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1719396870991,
                "endTimeMs": 1719483270991
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\r\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\r\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_table_doktorkit\"></tb-dashboard-state>\r\n    </div>\r\n</div>\r\n",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "enableDataExport": false,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "actions": {
            "headerButton": []
          }
        },
        "row": 0,
        "col": 0,
        "id": "5edfc189-61b4-a221-d5b5-c57a2bcf7960"
      },
      "421606e7-2c9a-a84b-e215-adfba9ba99e7": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "filterId": null,
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "var MeasurementState;\r\nif (data && data.length && data[0]['entityId']) {\r\n    MeasurementState = true;\r\n} else {\r\n    MeasurementState = false;\r\n}\r\n\r\nvar typeSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24\" viewBox=\"0 -960 960 960\" width=\"24\"><path d=\"M160-80q-33 0-56.5-23.5T80-160v-480q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v480q0 33-23.5 56.5T800-80H160Zm240-640h160v-80H400v80Zm40 360v120h80v-120h120v-80H520v-120h-80v120H320v80h120Z\"/></svg>';\r\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\r\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\r\n\r\nvar header = '<div class=\"header\" fxLayout=\"column\" fxLayoutAlign=\"start stretch\" fxLayoutGap=\"8px\">' +\r\n                '<div fxLayout=\"row\" fxLayoutAlign=\"start stretch\">' +\r\n                  '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><button id=\"go-back\" matTooltip=\"Go back\" type=\"button\" mat-icon-button><mat-icon>arrow_back</mat-icon></button></div>' +\r\n                 /* '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><img style=\"vertical-align: middle;\" class=\"title-icon mat-icon\" src=\"'+ typeSvgUrl +'\"></div>' +*/\r\n                  '<div fxFlex fxLayout=\"column\" fxLayoutAlign=\"center\">' +\r\n                     '<div class=\"title\">Edit Measurement: {{ ctx.stateController.getStateParams().selectedMeasurement?.entityName }}</div>' +\r\n                  '</div>' +\r\n                '</div>' +\r\n/*                '<div fxLayout=\"row\" fxLayoutAlign=\"stretch stretch\" fxLayoutGap=\"8px\">' +\r\n                  '<div fxFlex=\"25\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"add-Kit\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">add_circle</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"25\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"Doktorkits\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">medical_services</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"25\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"get-location\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">location_on</mat-icon>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"25\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"delete-Measurement\" type=\"button\" mat-raised-button color=\"accent\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">delete</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                '</div>' +*/\r\n             '</div>';\r\n             \r\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\r\n          (MeasurementState \r\n            ? (/*header + */\r\n               '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"edit_measurements_card\"></tb-dashboard-state>') \r\n            : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"measurements_card\"></tb-dashboard-state>') +\r\n       '</div>';\r\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n.main-layout .header {\n    height: 100px;\n    margin: 6px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n.main-layout .tb-mat-20 {\n    width: 1px;\n    height: 2px;\n    margin: 2px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 12px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "Sensorkits",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Sensorkits",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e4559805-877a-3f46-e336-b23cc1c27407"
              },
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedMeasurement'] = null;\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "116515c2-d9bd-80b6-7a34-97373a802806"
              }
            ],
            "headerButton": []
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "421606e7-2c9a-a84b-e215-adfba9ba99e7",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "255cd6bc-d63d-3ac5-6bf5-7f8f07a0aafe": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\n     <div fxLayout=\"row\" style=\"width: 100%; height: 60px;\" fxLayoutAlign=\"center start\">\n        <h5 fxFlex class=\"market-title\">Measurements</h5>\n        <button id=\"add-Measurement\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">add</mat-icon><span>Add Measurement</span></button>\n     </div>\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"measurements_map\"></tb-dashboard-state>\n    </div>\n</div>",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-container .tb-widget .tb-multiple-input {\n    background-color: #FAFAFA;\n    border-radius: 4px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .input-field {\n    padding-right: 30px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input mat-slide-toggle {\n    margin-top: 15px !important;\n    margin-bottom: 0 !important;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-slide-toggle-content {\n    width: 120px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-bar {\n    width: 42px;\n    height: 24px;\n    border-radius: 16px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb-container {\n    top: 2px;\n    left: 2px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-thumb-container {\n    transform: translate3d(18px, 0, 0);\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb {\n    background-color: #fafafa;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-bar {\n    background-color: #F2994A;\n}\n",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "add-Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addMeasurementFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 350px;\">\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\n    <h2>Add Measurement</h2>\n    <span fxFlex></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content fxLayout=\"column\">\n    <div fxLayout=\"column\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">\n        <mat-form-field fxFlex class=\"mat-block\">\n            <mat-label>Measurement title</mat-label>\n            <input matInput formControlName=\"name\" required readonly>\n            <mat-error *ngIf=\"addMeasurementFormGroup.get('name').hasError('required')\">\n              Measurement title is required.\n            </mat-error>\n        </mat-form-field>\n        <mat-form-field fxFlex class=\"mat-block\">\n            <mat-label>Measurement alias</mat-label>\n            <input matInput formControlName=\"locationName\">\n            <mat-error *ngIf=\"addMeasurementFormGroup.get('locationName').hasError('required')\">\n              Measurement alias is required.\n            </mat-error>\n        </mat-form-field>\n        <mat-form-field fxFlex class=\"mat-block\">\n            <mat-label>Installation type</mat-label>\n            <mat-select formControlName=\"installationType\">\n            <mat-option value=\"heating\" selected>Heating</mat-option>\n            <mat-option value=\"cooling\">Cooling</mat-option>\n            </mat-select>\n            <mat-error *ngIf=\"addMeasurementFormGroup.get('installationType').hasError('required')\">\n            Installation type is required.\n            </mat-error>\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      Cancel\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addMeasurementFormGroup.invalid || !addMeasurementFormGroup.dirty\">\n      Add Measurement\n    </button>\n  </div>\n</form>\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\n\nlet nextMeasurementId = 0;\n\nlet customerName = widgetContext.stateController.getStateParams().entityName;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n/*console.log(\"Customer EntityID: \" + customerId.id);*/\n\nlet projectEntityId = widgetContext.stateController.getStateParams().selectedProject.entityId.id;\n/*console.log(\"Project EntityID: \" + projectEntityId);*/\n\nlet assetSearchQuery = {\n  \"parameters\": {\n    \"rootId\": projectEntityId,\n    \"rootType\": \"ASSET\",\n    \"direction\": \"FROM\",\n    \"relationTypeGroup\": \"COMMON\",\n    \"maxLevel\": 10,\n    \"fetchLastLevelOnly\": false\n  },\n  \"relationType\": \"Owns\",\n  \"assetTypes\": [\n    \"Measurement\"\n  ]\n};\nassetService.findByQuery(assetSearchQuery).subscribe(measurements => {\n/*    console.log(measurements);*/\n    nextMeasurementId = getLastMeasurementId(measurements);\n/*    console.log(\"Next Measurement: \" + nextMeasurementId);*/\n    attributeService.getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName']).subscribe(attributes => {\n        shortNameAttr = attributes.find(attr => attr.key === 'shortName');\n        customerShortName = shortNameAttr ? shortNameAttr.value : customerName;\n        openAddMeasurementDialog();\n    });\n});\n\nfunction getLastMeasurementId(measurements) {\n    let maxNumber = 0;\n    measurements.forEach(item => {\n        const name = item.name;\n        const parts = name.split('_');\n        if (parts.length === 3) {\n            const number = parseInt(parts[2], 10);\n            if (number > maxNumber) {\n                maxNumber = number;\n            }\n        }\n    });\n    const nextMeasurementId = maxNumber + 1;\n    return nextMeasurementId;\n}\n\nfunction openAddMeasurementDialog() {\n    customDialog.customDialog(htmlTemplate,\n        AddMeasurementDialogController).subscribe();\n}\n\nfunction AddMeasurementDialogController(instance) {\n    let vm = instance;\n    let projectName = widgetContext.stateController.getStateParams().selectedProject.entityName;\n    vm.addMeasurementFormGroup = vm.fb.group({\n        name: [projectName + \"_\" + nextMeasurementId, [vm.validators.required]],\n        locationName: ['', [vm.validators.required]],\n        installationType: ['heating', [vm.validators.required]]\n    });\n\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n\n    vm.save = function() {\n        const stateParams = widgetContext\n            .stateController.getStateParams();\n        var customerId;\n        var projectId;\n        projectId = {\n            id: (stateParams.selectedProject &&\n                    stateParams.selectedProject\n                    .entityId && stateParams\n                    .selectedProject.entityId.id) ?\n                stateParams.selectedProject.entityId\n                .id : '',\n            entityType: 'ASSET'\n        };\n        console.log(JSON.stringify(projectId));\n        if (widgetContext.currentUser.authority ===\n            'TENANT_ADMIN') {\n            customerId = widgetContext.stateController\n                .getStateParams().entityId;\n        } else {\n            customerId = {\n                id: widgetContext.currentUser\n                    .customerId,\n                entityType: 'CUSTOMER'\n            };\n        }\n        vm.addMeasurementFormGroup.markAsPristine();\n        saveMeasurementObservable(customerId).subscribe(\n            function(Measurement) {\n                const observables = [\n                    saveCustomerToMeasurementRelation(\n                        customerId, Measurement\n                        .id),\n                    saveAttributes(Measurement\n                        .id)\n                ];\n\n                // Add saveProjectToMeasurementRelation to observables if projectId is not empty\n                if (projectId.id !== \"\") {\n                    observables.push(\n                        saveProjectToMeasurementRelation(\n                            projectId,\n                            Measurement.id));\n                }\n                widgetContext.rxjs.forkJoin(observables).subscribe(\n                    function() {\n                        var params =\n                            widgetContext\n                            .stateController\n                            .getStateParams();\n                        var selectedMeasurement =\n                            params[\n                                'selectedMeasurement'\n                                ];\n                        params[\n                            'selectedMeasurement'] = {\n                            entityId: Measurement\n                                .id,\n                            entityName: Measurement\n                                .name,\n                            entityLabel: ''\n                        };\n                        widgetContext\n                            .updateAliases();\n                        vm.dialogRef.close(\n                        null);\n                    }\n                );\n            }\n        );\n    };\n\n    function saveMeasurementObservable(customerId) {\n        return getMeasurementsGroup(customerId).pipe(\n            widgetContext.rxjs.switchMap((\n                MeasurementsGroup) => {\n                const formValues = vm\n                    .addMeasurementFormGroup.value;\n                let Measurement = {\n                    name: formValues.name,\n                    type: 'Measurement',\n                    customerId: customerId\n                };\n                return assetService.saveAsset(\n                    Measurement,\n                    MeasurementsGroup.id.id)\n            })\n        );\n    }\n\n    function getMeasurementsGroup(customerId) {\n        return entityGroupService.getEntityGroupsByOwnerId(\n            customerId.entityType, customerId.id,\n            'ASSET').pipe(\n            widgetContext.rxjs.switchMap((\n                entityGroups) => {\n                    var MeasurementsGroup = entityGroups\n                        .find(group => group.name ===\n                            'Measurements');\n                    if (MeasurementsGroup) {\n                        return widgetContext.rxjs.of(\n                            MeasurementsGroup);\n                    } else {\n                        MeasurementsGroup = {\n                            type: 'ASSET',\n                            name: 'Measurements',\n                            ownerId: customerId\n                        };\n                        return entityGroupService\n                            .saveEntityGroup(\n                                MeasurementsGroup);\n                    }\n                })\n        );\n    }\n\n    function saveCustomerToMeasurementRelation(customerId,\n        MeasurementId) {\n        var relation = {\n            from: customerId,\n            to: MeasurementId,\n            typeGroup: 'COMMON',\n            type: 'Owns'\n        };\n        return entityRelationService.saveRelation(relation);\n    }\n\n    function saveProjectToMeasurementRelation(projectId,\n        MeasurementId) {\n        var relation = {\n            from: projectId,\n            to: MeasurementId,\n            typeGroup: 'COMMON',\n            type: 'Owns'\n        };\n        return entityRelationService.saveRelation(relation);\n    }\n\n    function saveAttributes(entityId) {\n        const formValues = vm.addMeasurementFormGroup.value;\n        let attributesArray = [{\n                key: 'latitude',\n                value: 48.1406022\n            },\n            {\n                key: 'longitude',\n                value: 16.2932688\n            },\n            {\n                key: 'address',\n                value: 'N/A'\n            },\n            {\n                key: 'installationType',\n                value: formValues.installationType\n            },\n            {\n                key: 'locationName',\n                value: formValues.locationName\n            },\n            {\n                key: 'state',\n                value: 'normal' // normal, minor, major, critical\n            },            \n            {\n                key: 'progress',\n                value: 'in preparation' // in preparation, active, finished, aborted\n            }, \n            {\n                key: 'active',\n                value: 'true'\n            },\n            {\n                key: 'units',\n                value: 'metric'\n            },\n            {\n                key: 'floorplan',\n                value: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCEtLSBDcmVhdGVkIHdpdGggSW5rc2NhcGUgKGh0dHA6Ly93d3cuaW5rc2NhcGUub3JnLykgLS0+Cjxzdmcgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc5LjM3NSA3OS4zNzUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiA8cmVjdCB4PSIyLjcwMTkiIHk9IjIuNzAxOSIgd2lkdGg9IjczLjk3MSIgaGVpZ2h0PSI3My45NzEiIGZpbGw9IiNmZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9Ii4xMTIxIiBzdHlsZT0icGFpbnQtb3JkZXI6bWFya2VycyBmaWxsIHN0cm9rZSIvPgogPGcgdHJhbnNmb3JtPSJtYXRyaXgoLjI2NDU4IDAgMCAuMjY0NTggMi42MzUgLTIuODgzNCkiIHN0cm9rZS13aWR0aD0iMXB4IiBzdHlsZT0ic2hhcGUtaW5zaWRlOnVybCgjcmVjdDQ4MzYpO3doaXRlLXNwYWNlOnByZSIgYXJpYS1sYWJlbD0iICAgTm8gcGxhbiBjb25maWd1cmVkIj4KICA8cGF0aCBkPSJtMTAxLjY3IDExOC4yOXYyOC40MzhoLTMuNzg5MWwtMTQuMzE2LTIxLjkzNHYyMS45MzRoLTMuNzY5NXYtMjguNDM4aDMuNzY5NWwxNC4zNzUgMjEuOTkydi0yMS45OTJ6Ii8+CiAgPHBhdGggZD0ibTEwNi44MyAxMzUuOTVxMC00LjU4OTggMi41NzgxLTcuNjU2MiAyLjU3ODEtMy4wODU5IDcuMDExNy0zLjA4NTl0Ny4wMTE3IDMuMDI3M3EyLjU3ODEgMy4wMDc4IDIuNjM2NyA3LjUxOTV2MC42NDQ1M3EwIDQuNTg5OC0yLjU5NzcgNy42NTYyLTIuNTc4MSAzLjA2NjQtNy4wMTE3IDMuMDY2NC00LjQ1MzEgMC03LjA1MDgtMy4wNjY0LTIuNTc4MS0zLjA2NjQtMi41NzgxLTcuNjU2MnptMy42MTMzIDAuNDQ5MjJxMCAzLjE0NDUgMS40ODQ0IDUuNDQ5MiAxLjUwMzkgMi4zMDQ3IDQuNTMxMiAyLjMwNDcgMi45NDkyIDAgNC40NTMxLTIuMjY1NiAxLjUwMzktMi4yODUyIDEuNTIzNC01LjQyOTd2LTAuNTA3ODFxMC0zLjEwNTUtMS41MDM5LTUuNDI5Ny0xLjUwMzktMi4zNDM4LTQuNTExNy0yLjM0MzgtMi45ODgzIDAtNC40OTIyIDIuMzQzOC0xLjQ4NDQgMi4zMjQyLTEuNDg0NCA1LjQyOTd6Ii8+CiAgPHBhdGggZD0ibTE1MC4xNyAxNDcuMTJxLTMuODA4NiAwLTYuMDM1Mi0yLjQ0MTR2MTAuMTc2aC0zLjYzMjh2LTI5LjI1OGgzLjMyMDNsMC4xNzU3OCAyLjMyNDJxMi4yMjY2LTIuNzE0OCA2LjExMzMtMi43MTQ4IDQuMDAzOSAwIDYuMTMyOCAyLjk2ODggMi4xMjg5IDIuOTY4OCAyLjEyODkgNy44MTI1djAuNDEwMTZxMCA0LjYyODktMi4xNDg0IDcuNjc1OC0yLjEyODkgMy4wNDY5LTYuMDU0NyAzLjA0Njl6bS0xLjExMzMtMTguODY3cS0zLjI4MTIgMC00LjkyMTkgMi45MTAydjEwLjExN3ExLjY2MDIgMi44NzExIDQuOTYwOSAyLjg3MTEgMi45Mjk3IDAgNC4yNzczLTIuMzA0NyAxLjM2NzItMi4zMDQ3IDEuMzY3Mi01LjQ0OTJ2LTAuNDEwMTZxMC0zLjE0NDUtMS4zNjcyLTUuNDI5Ny0xLjM0NzYtMi4zMDQ3LTQuMzE2NC0yLjMwNDd6Ii8+CiAgPHBhdGggZD0ibTE2Ni45MSAxMTYuNzN2MzBoLTMuNjMyOHYtMzB6Ii8+CiAgPHBhdGggZD0ibTE4NS43NSAxNDYuNzNxLTAuMzUxNTctMC43NjE3Mi0wLjUwNzgyLTIuMjI2Ni0xLjAxNTYgMS4wNzQyLTIuNTM5MSAxLjg1NTUtMS41MjM0IDAuNzYxNzItMy40NzY2IDAuNzYxNzItMy4yNDIyIDAtNS4xOTUzLTEuODE2NC0xLjk1MzEtMS44MTY0LTEuOTUzMS00LjQ1MzEgMC0zLjM5ODQgMi41NzgxLTUuMTU2MiAyLjU3ODEtMS43NzczIDYuOTMzNi0xLjc3NzNoMy41NzQydi0xLjY3OTdxMC0xLjg3NS0xLjEzMjgtMi45ODgzLTEuMTEzMy0xLjEzMjgtMy4zMjAzLTEuMTMyOC0yLjA1MDggMC0zLjMyMDMgMS4wMTU2LTEuMjUgMC45OTYxLTEuMjUgMi4zMjQyaC0zLjYxMzNxMC0yLjI2NTYgMi4yODUyLTQuMjU3OCAyLjI4NTItMS45OTIyIDYuMTEzMy0xLjk5MjIgMy40Mzc1IDAgNS42NDQ1IDEuNzU3OCAyLjIwNyAxLjc1NzggMi4yMDcgNS4zMTI1djkuNDkyMnEwIDIuOTI5NyAwLjc0MjE5IDQuNjQ4NHYwLjMxMjV6bS01Ljk5NjEtMi43NzM0cTEuOTUzMSAwIDMuMzc4OS0wLjk3NjU2IDEuNDQ1My0wLjk3NjU2IDIuMDMxMi0yLjE2OHYtNC4zNTU1aC0zLjM1OTRxLTYuMDkzOCAwLjExNzE5LTYuMDkzOCAzLjkwNjIgMCAxLjUwMzkgMS4wMTU2IDIuNTU4NiAxLjAxNTYgMS4wMzUyIDMuMDI3MyAxLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTIwMy4yMyAxMjguMjVxLTEuNzM4MyAwLTMuMDY2NCAwLjkzNzUtMS4zMjgxIDAuOTM3NS0yLjA4OTggMi40NDE0djE1LjA5OGgtMy42MTMzdi0yMS4xMzNoMy40MThsMC4xMTcxOSAyLjYzNjdxMi40MDIzLTMuMDI3MyA2LjMwODYtMy4wMjczIDMuMTA1NSAwIDQuOTIxOSAxLjczODMgMS44MzU5IDEuNzM4MyAxLjg1NTUgNS44Mzk4djEzLjk0NWgtMy42MzI4di0xMy44ODdxMC0yLjQ4MDUtMS4wOTM4LTMuNTM1Mi0xLjA3NDItMS4wNTQ3LTMuMTI1LTEuMDU0N3oiLz4KICA8cGF0aCBkPSJtNTcuOTQxIDE5NC4xNXExLjkzMzYgMCAzLjM3ODktMS4xNTIzIDEuNDY0OC0xLjE1MjMgMS42MDE2LTIuOTQ5MmgzLjQzNzVxLTAuMTM2NzIgMi44MzItMi41OTc3IDQuOTYwOS0yLjQ2MDkgMi4xMDk0LTUuODIwMyAyLjEwOTQtNC43NjU2IDAtNy4wODk4LTMuMTQ0NS0yLjMwNDctMy4xNDQ1LTIuMzA0Ny03LjQwMjN2LTAuODIwMzFxMC00LjI1NzggMi4zMDQ3LTcuNDAyNCAyLjMyNDItMy4xNDQ1IDcuMDg5OC0zLjE0NDUgMy43MTA5IDAgNS45OTYxIDIuMjA3IDIuMjg1MiAyLjE4NzUgMi40MjE5IDUuNDQ5MmgtMy40Mzc1cS0wLjEzNjcyLTEuOTUzMS0xLjQ4NDQtMy4zMjAzLTEuMzI4MS0xLjM2NzItMy40OTYxLTEuMzY3Mi0yLjIyNjYgMC0zLjQ5NjEgMS4xMzI4LTEuMjUgMS4xMzI4LTEuNzc3MyAyLjg3MTEtMC41MDc4MSAxLjczODMtMC41MDc4MSAzLjU3NDJ2MC44MjAzMXEwIDEuODU1NSAwLjUwNzgxIDMuNTkzOCAwLjUwNzgxIDEuNzM4MyAxLjc1NzggMi44NzExIDEuMjY5NSAxLjExMzMgMy41MTU2IDEuMTEzM3oiLz4KICA8cGF0aCBkPSJtNjkuNDY1IDE4NS45NXEwLTQuNTg5OCAyLjU3ODEtNy42NTYyIDIuNTc4MS0zLjA4NTkgNy4wMTE3LTMuMDg1OSA0LjQzMzYgMCA3LjAxMTcgMy4wMjczIDIuNTc4MSAzLjAwNzggMi42MzY3IDcuNTE5NXYwLjY0NDUzcTAgNC41ODk4LTIuNTk3NyA3LjY1NjItMi41NzgxIDMuMDY2NC03LjAxMTcgMy4wNjY0LTQuNDUzMSAwLTcuMDUwOC0zLjA2NjQtMi41NzgxLTMuMDY2NC0yLjU3ODEtNy42NTYyem0zLjYxMzMgMC40NDkyMnEwIDMuMTQ0NSAxLjQ4NDQgNS40NDkyIDEuNTAzOSAyLjMwNDcgNC41MzEyIDIuMzA0NyAyLjk0OTIgMCA0LjQ1MzEtMi4yNjU2IDEuNTAzOS0yLjI4NTIgMS41MjM0LTUuNDI5N3YtMC41MDc4MXEwLTMuMTA1NS0xLjUwMzktNS40Mjk3LTEuNTAzOS0yLjM0MzgtNC41MTE3LTIuMzQzOC0yLjk4ODMgMC00LjQ5MjIgMi4zNDM4LTEuNDg0NCAyLjMyNDItMS40ODQ0IDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTAyIDE3OC4yNXEtMS43MzgzIDAtMy4wNjY0IDAuOTM3NS0xLjMyODEgMC45Mzc1LTIuMDg5OCAyLjQ0MTR2MTUuMDk4aC0zLjYxMzN2LTIxLjEzM2gzLjQxOGwwLjExNzE5IDIuNjM2N3EyLjQwMjMtMy4wMjczIDYuMzA4Ni0zLjAyNzMgMy4xMDU1IDAgNC45MjE5IDEuNzM4MyAxLjgzNTkgMS43MzgzIDEuODU1NSA1LjgzOTh2MTMuOTQ1aC0zLjYzMjh2LTEzLjg4N3EwLTIuNDgwNS0xLjA5MzgtMy41MzUyLTEuMDc0Mi0xLjA1NDctMy4xMjUtMS4wNTQ3eiIvPgogIDxwYXRoIGQ9Im0xMjQuNDYgMTc4LjM3aC00LjMxNjR2MTguMzU5aC0zLjYxMzN2LTE4LjM1OWgtMy4zMzk4di0yLjc3MzRoMy4zMzk4di0xLjgzNTlxMC0zLjU5MzggMi4wNzAzLTUuNTA3OCAyLjA3MDMtMS45MzM2IDUuNjY0MS0xLjkzMzYgMi4xODc1IDAgNS41MjczIDEuMTkxNGwtMC42MDU0NiAzLjA0NjlxLTIuNTM5MS0wLjk5NjA5LTQuNjY4LTAuOTk2MDktMi4zMjQyIDAtMy4zNTk0IDEuMDU0Ny0xLjAxNTYgMS4wMzUyLTEuMDE1NiAzLjE0NDV2MS44MzU5aDQuMzE2NHptNy4xMDk0LTIuNzczNHYyMS4xMzNoLTMuNjEzM3YtMjEuMTMzeiIvPgogIDxwYXRoIGQ9Im0xNDUuNTIgMjA1LjA3cS0xLjY0MDYgMC00LjAyMzQtMC44MDA3OC0yLjM4MjgtMC44MDA3OC0zLjgwODYtMi44NzExbDEuODk0NS0yLjE0ODRxMi4zNDM4IDIuODUxNiA1LjY2NDEgMi44NTE2IDIuNTU4NiAwIDQuMDgyLTEuNDQ1MyAxLjUyMzQtMS40MjU4IDEuNTIzNC00LjE5OTJ2LTEuODU1NXEtMi4xNDg0IDIuNTE5NS01LjkxOCAyLjUxOTUtMy44MDg2IDAtNi4wNTQ3LTMuMDQ2OS0yLjI0NjEtMy4wNDY5LTIuMjQ2MS03LjY3NTh2LTAuNDEwMTZxMC00Ljg0MzggMi4yMjY2LTcuODEyNSAyLjI0NjEtMi45Njg4IDYuMTEzMy0yLjk2ODggMy44ODY3IDAgNi4wMzUyIDIuNzM0NGwwLjE3NTc4LTIuMzQzOGgzLjI4MTJ2MjAuNjg0cTAgNC4xOTkyLTIuNSA2LjQ4NDQtMi41IDIuMzA0Ny02LjQ0NTMgMi4zMDQ3em0tNS4yNzM0LTE4LjY3MnEwIDMuMTQ0NSAxLjMwODYgNS40MTAyIDEuMzI4MSAyLjI0NjEgNC4yNTc4IDIuMjQ2MSAzLjQzNzUgMCA1LjAzOTEtMy4xMjV2LTkuNjI4OXEtMC42ODM1OS0xLjMwODYtMS44OTQ1LTIuMTY4LTEuMjEwOS0wLjg3ODktMy4xMDU1LTAuODc4OS0yLjk0OTIgMC00LjI3NzMgMi4zMDQ3LTEuMzI4MSAyLjI4NTItMS4zMjgxIDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTczLjA2IDE5Ni43My0wLjA3ODEtMi4wODk4cS0yLjA3MDMgMi40ODA1LTYuMTcxOSAyLjQ4MDUtMy4xMDU1IDAtNS4wMTk1LTEuODM1OS0xLjkxNDEtMS44MzU5LTEuOTE0MS02LjA1NDd2LTEzLjYzM2gzLjYxMzN2MTMuNjcycTAgMi44NTE2IDEuMTkxNCAzLjgyODEgMS4yMTA5IDAuOTU3MDMgMi42OTUzIDAuOTU3MDMgNC4wODIgMCA1LjUwNzgtMy4wNjY0di0xNS4zOTFoMy42MzI4djIxLjEzM3oiLz4KICA8cGF0aCBkPSJtMTkwLjQ0IDE3OC42OHEtMy41MzUyIDAtNC44MjQyIDMuMDQ2OXYxNWgtMy42MTMzdi0yMS4xMzNoMy41MTU2bDAuMDc4MSAyLjQyMTlxMS43MzgzLTIuODEyNSA1LjAxOTUtMi44MTI1IDEuMDE1NiAwIDEuNjAxNiAwLjI3MzQ0bC0wLjAxOTUgMy4zNTk0cS0wLjgwMDc4LTAuMTU2MjUtMS43NTc4LTAuMTU2MjV6Ii8+CiAgPHBhdGggZD0ibTIxMS45MSAxOTMuMDRxLTEuMDM1MiAxLjU2MjUtMi45Mjk3IDIuODMyLTEuODk0NSAxLjI1LTUuMDE5NSAxLjI1LTQuNDE0MSAwLTcuMDcwMy0yLjg3MTEtMi42MzY3LTIuODcxMS0yLjYzNjctNy4zNDM4di0wLjgyMDMxcTAtMy40NTcgMS4zMDg2LTUuODc4OSAxLjMyODEtMi40NDE0IDMuNDM3NS0zLjcxMDkgMi4xMDk0LTEuMjg5MSA0LjQ5MjItMS4yODkxIDQuNTMxMiAwIDYuNjAxNiAyLjk2ODggMi4wODk4IDIuOTQ5MiAyLjA4OTggNy4zODI4djEuNjIxMWgtMTQuMjk3cTAuMDc4MSAyLjkxMDIgMS43MTg4IDQuOTYwOSAxLjY2MDIgMi4wMzEyIDQuNTUwOCAyLjAzMTIgMS45MTQxIDAgMy4yNDIyLTAuNzgxMjUgMS4zMjgxLTAuNzgxMjUgMi4zMjQyLTIuMDg5OHptLTguNDE4LTE0Ljg2M3EtMi4xNDg0IDAtMy42MzI4IDEuNTYyNS0xLjQ4NDQgMS41NjI1LTEuODU1NSA0LjQ5MjJoMTAuNTY2di0wLjI3MzQ0cS0wLjEzNjcyLTIuMTA5NC0xLjIzMDUtMy45NDUzLTEuMDc0Mi0xLjgzNTktMy44NDc3LTEuODM1OXoiLz4KICA8cGF0aCBkPSJtMjMwLjAzIDE5Ni43My0wLjE3NTc4LTIuMjY1NnEtMi4xNjggMi42NTYyLTYuMDM1MiAyLjY1NjItMy43MTA5IDAtNS45OTYxLTMuMDA3OC0yLjI4NTItMy4wMDc4LTIuMzI0Mi03LjU1ODZ2LTAuNTY2NDFxMC00Ljg0MzggMi4yODUyLTcuODEyNSAyLjMwNDctMi45Njg4IDYuMDc0Mi0yLjk2ODggMy43MzA1IDAgNS44NTk0IDIuNXYtMTAuOTc3aDMuNjMyOHYzMHptLTEwLjg5OC0xMC4zMzJxMCAzLjE0NDUgMS4zMjgxIDUuNDEwMiAxLjMyODEgMi4yNDYxIDQuMjU3OCAyLjI0NjEgMy4zNTk0IDAgNS0zLjA2NjR2LTkuNzI2NnEtMS42MjExLTMuMDA3OC00Ljk2MDktMy4wMDc4LTIuOTQ5MiAwLTQuMjk2OSAyLjMwNDctMS4zMjgxIDIuMjg1Mi0xLjMyODEgNS40Mjk3eiIvPgogPC9nPgo8L3N2Zz4K'\n            }\n        ];\n        return attributeService.saveEntityAttributes(\n            entityId, \"SERVER_SCOPE\", attributesArray);\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7cad1c71-0765-4277-32a8-c87808a0c689"
              }
            ]
          },
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "255cd6bc-d63d-3ac5-6bf5-7f8f07a0aafe",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "56d2a93a-4e64-7513-8abd-f500eed9e95d": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "filterId": null,
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex stateId='edit_measurement_alias'></tb-dashboard-state>\n    <!--<tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex stateId='edit_measurement_location'></tb-dashboard-state>-->\n</div>",
            "markdownTextFunction": "return '# Some title\\\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": false,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "save-title",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "const targetElement = $($event.target).closest('#save-title', widgetContext.$container[0]);\n\nvar title = $(targetElement).attr('data-title');\n\nwidgetContext.assetService.getAsset(entityId.id, {ignoreLoading: true}).subscribe((Measurement) => {\n    Measurement.name = title;\n    widgetContext.assetService.saveAsset(Measurement, null, {ignoreLoading: true}).subscribe(() => {\n       var stateParams = widgetContext.stateController.getStateParams();\n       stateParams.selectedMeasurement.entityName = title;\n       widgetContext.stateController.updateState(null, stateParams);\n       /*if (widgetContext.parentDashboard) {\n           widgetContext.parentDashboard.aliasController.updateAliases();\n       }\n       widgetContext.updateAliases();*/\n    });\n});\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "088a4799-8551-7ab4-892f-2a08d6d40a7c"
              }
            ],
            "headerButton": []
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "56d2a93a-4e64-7513-8abd-f500eed9e95d",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "fbc43902-53ed-c5f2-76cd-8163a7752dc2": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "floorplan",
                  "type": "attribute",
                  "label": "{i18n:custom.projects.measurements.floorplan}",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.5234606901361916,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": true,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "5px",
          "settings": {
            "widgetTitle": "{i18n:custom.projects.measurements.floorplan}",
            "showResultMessage": false,
            "displayPreview": true,
            "displayClearButton": false,
            "displayApplyButton": false,
            "displayDiscardButton": true
          },
          "title": "Floor plan",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "font-size": "20px",
            "padding-bottom": "5px",
            "padding-left": "10px",
            "padding-top": "10px",
            "font-weight": "500"
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "actions": {},
          "showTitleIcon": false,
          "titleTooltip": "",
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "fbc43902-53ed-c5f2-76cd-8163a7752dc2",
        "typeFullFqn": "system.input_widgets.update_server_image_attribute"
      },
      "646559d6-c1a5-ccee-b3fb-552496a7521b": {
        "typeFullFqn": "system.action_button",
        "type": "latest",
        "sizeX": 3,
        "sizeY": 1,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "09a7d069-f810-fea9-8e3d-4309f4a424ae",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1727859232084,
                "endTimeMs": 1727945632084
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#FFFFFF01",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "activatedState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "disabledState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "appearance": {
              "type": "filled",
              "showLabel": true,
              "label": "Manage Projects",
              "showIcon": true,
              "icon": "assignment",
              "iconSize": 24,
              "iconSizeUnit": "px",
              "mainColor": "#435B63",
              "backgroundColor": "#FFFFFF",
              "autoScale": true,
              "customStyle": {
                "enabled": null,
                "hovered": null,
                "pressed": null,
                "activated": null,
                "disabled": null
              }
            }
          },
          "title": "Action button",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "borderRadius": "4px",
          "configMode": "advanced",
          "actions": {
            "click": [
              {
                "name": "onClick",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Projects",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "d3007368-0cff-035d-787f-9215e17323cb"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "646559d6-c1a5-ccee-b3fb-552496a7521b"
      },
      "9ce62891-046b-e732-060f-37704b7d8998": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
              "filterId": null,
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "var ProjectState;\nif (data && data.length && data[0]['entityId']) {\n    ProjectState = true;\n} else {\n    ProjectState = false;\n}\n\nvar typeSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24\" viewBox=\"0 -960 960 960\" width=\"24\"><path d=\"M160-80q-33 0-56.5-23.5T80-160v-480q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v480q0 33-23.5 56.5T800-80H160Zm240-640h160v-80H400v80Zm40 360v120h80v-120h120v-80H520v-120h-80v120H320v80h120Z\"/></svg>';\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\n\nvar header = '<div class=\"header\" fxLayout=\"row\" fxLayoutAlign=\"start stretch\" fxLayoutGap=\"8px\">' +\n                '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><button id=\"go-back\" matTooltip=\"Go back\" type=\"button\" mat-icon-button><mat-icon>arrow_back</mat-icon></button></div>' +\n                /*'<div fxLayout=\"column\" fxLayoutAlign=\"center\"><img style=\"vertical-align: middle;\" class=\"title-icon mat-icon\" src=\"'+ typeSvgUrl +'\"></div>' +*/\n                '<div fxFlex fxLayout=\"column\" fxLayoutAlign=\"center\">' +\n                   '<div class=\"title\">Edit Project: {{ ctx.stateController.getStateParams().selectedProject?.entityName }}</div>' +\n                '</div>' +\n                //'<div fxLayout=\"column\" class=\"button-margin-top\" fxLayoutAlign=\"start\"><button id=\"add-Measurement\" type=\"button\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">add_circle</mat-icon><span></span></button></div>' +\n                '<div fxLayout=\"column\" class=\"button-margin-top\" fxLayoutAlign=\"start\"><button id=\"Measurements\" type=\"button\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">devices_other</mat-icon><span></span></button></div>' +\n                '<div fxLayout=\"column\" class=\"button-margin-top\" fxLayoutAlign=\"start\"><button id=\"get-location\" type=\"button\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">location_on</mat-icon></button></div>' +\n                '<div fxLayout=\"column\" class=\"button-margin-top\" fxLayoutAlign=\"start\" style=\"padding-right: 24px;\"><button id=\"delete-Project\" type=\"button\" mat-raised-button color=\"accent\"><mat-icon class=\"tb-mat-20\">delete</mat-icon><span></span></button></div>' +\n             '</div>';\n             \nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\n          (ProjectState \n            ? (header +\n               '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"edit_project_card\"></tb-dashboard-state>') \n            : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"projects_card\"></tb-dashboard-state>') +\n       '</div>';",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n.main-layout .header {\n    height: 60px;\n    margin: 4px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n.main-layout .tb-mat-20 {\n    width: 1px;\n    height: 2px;\n    margin: 2px;\n}\n\n.button-margin-top {\n    margin-top: 10px; \n}\n\n\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 12px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedProject'] = null;\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "116515c2-d9bd-80b6-7a34-97373a802806"
              },
              {
                "name": "add-Measurement",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addMeasurementFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 800px;\">\r\n\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Add Measurement</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-form-field class=\"mat-block\">\r\n      <mat-label>Measurement</mat-label>\r\n      <mat-select formControlName=\"Measurement\" required>\r\n        <mat-select-trigger>\r\n          <div class=\"Measurement-item\" fxLayout=\"row\">\r\n            <div fxLayout=\"column\" fxFlex>\r\n              <div>{{addMeasurementFormGroup.get('Measurement').value?.label}}</div>\r\n              <div class=\"Measurement-name\">{{addMeasurementFormGroup.get('Measurement').value?.name}}</div>\r\n            </div>\r\n            <div class=\"Measurement-type\">{{addMeasurementFormGroup.get('Measurement').value?.type}}</div>\r\n          </div>\r\n        </mat-select-trigger>\r\n        <mat-option *ngFor=\"let Measurement of availableMeasurement\" [value]=\"Measurement\">\r\n          <div class=\"Measurement-item\" fxLayout=\"row\">\r\n            <div fxLayout=\"column\" fxFlex>\r\n              <div>{{Measurement?.label}}</div>\r\n              <div class=\"Measurement-name\">{{Measurement?.name}}</div>\r\n            </div>\r\n            <div class=\"Measurement-type\">{{Measurement?.type}}</div>\r\n          </div>\r\n          <mat-divider></mat-divider>\r\n        </mat-option>\r\n        <mat-option *ngIf=\"!availableMeasurement?.length\" disabled [value]=\"null\">\r\n          <div class=\"Measurement-item\">No Measurements available</div>\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"addMeasurementFormGroup.get('Measurement').hasError('required')\">\r\n        Measurement is required.\r\n      </mat-error>\r\n    </mat-form-field>\r\n\r\n    <mat-form-field class=\"mat-block\">\r\n      <mat-label>Label</mat-label>\r\n      <input matInput formControlName=\"label\">\r\n      <mat-error *ngIf=\"addMeasurementFormGroup.get('label').hasError('required')\">\r\n        Measurement label is required.\r\n      </mat-error>\r\n    </mat-form-field>\r\n\r\n    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n      <button mat-button color=\"primary\"\r\n              type=\"button\"\r\n              [disabled]=\"(isLoading$ | async)\"\r\n              (click)=\"cancel()\" cdkFocusInitial>\r\n        Cancel\r\n      </button>\r\n      <button mat-button color=\"primary\" type=\"submit\">\r\n        Save\r\n      </button>\r\n    </div>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\n\r\nif (additionalParams.source === \"replace Measurement\") {\r\n    if (additionalParams.choice === true) {\r\n        openAddMeasurementDialog();\r\n    } else {\r\n        // Handle other cases if needed\r\n    }\r\n} else if (additionalParams.source !== \"replace Measurement\") {\r\n    openAddMeasurementDialog();\r\n}\r\n\r\nfunction openAddMeasurementDialog() {\r\n    customDialog.customDialog(htmlTemplate, AddMeasurementDialogController).subscribe();\r\n}\r\n\r\nfunction AddMeasurementDialogController(instance) {\r\n    let vm = instance;\r\n\r\n    vm.addMeasurementFormGroup = vm.fb.group({\r\n        Measurement: [null, [vm.validators.required]],\r\n        label: [{ value: null, disabled: true }]\r\n    });\r\n\r\n    vm.addMeasurementFormGroup.get('Measurement').valueChanges.subscribe((Measurement) => {\r\n        vm.addMeasurementFormGroup.get('label').patchValue(Measurement.label, { emitEvent: false });\r\n        vm.addMeasurementFormGroup.get('label').enable({ emitEvent: false });\r\n        vm.addMeasurementFormGroup.get('label').updateValueAndValidity({ onlySelf: true });\r\n    });\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        var ProjectId = widgetContext.stateController.getStateParams().selectedProject.entityId;\r\n        vm.addMeasurementFormGroup.markAsPristine();\r\n        var Measurement = vm.addMeasurementFormGroup.value.Measurement;\r\n        var label = vm.addMeasurementFormGroup.value.label;\r\n        var MeasurementId = Measurement.MeasurementId;\r\n        \r\n        widgetContext.rxjs.forkJoin([\r\n            entityGroupService.removeEntityFromEntityGroup(vm.unassignedMeasurementGroup.id.id, MeasurementId.id),\r\n            saveMeasurementToProjectRelation(ProjectId, MeasurementId),\r\n            updateMeasurementLabel(Measurement, label)\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedMeasurementGroup = null;\r\n        vm.availableMeasurement = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'ASSET').subscribe((entityGroups) => {\r\n            vm.unassignedMeasurementGroup = entityGroups.find(group => group.name === 'Unassigned Measurement');\r\n            if (vm.unassignedMeasurementGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'ASSET',\r\n                        entityGroup: vm.unassignedMeasurementGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    vm.availableMeasurement = data.data.map((entityData) => {\r\n                        return {\r\n                            MeasurementId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                });\r\n            }\r\n            if (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Measurement\") {\r\n                checkAdditionalParams();\r\n            }\r\n        });\r\n    }\r\n\r\n    function saveMeasurementToProjectRelation(ProjectId, MeasurementId) {\r\n        var relation = {\r\n            from: ProjectId,\r\n            to: MeasurementId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Owns'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function updateMeasurementLabel(Measurement, label) {\r\n        if (Measurement.label !== label) {\r\n            return deviceService.getDevice(Measurement.MeasurementId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origMeasurement) => {\r\n                    origMeasurement.label = label;\r\n                    return deviceService.saveDevice(origMeasurement);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableMeasurement = vm.availableMeasurement.find(Measurement => Measurement.name === additionalParams.code);\r\n        const matchingAssignedMeasurement = vm.assignedMeasurements.find(Measurement => Measurement.name === additionalParams.code);\r\n\r\n        if (!matchingAvailableMeasurement && !matchingAssignedMeasurement) {\r\n            widgetContext.dialogs.alert(\"Measurement doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedMeasurement && !matchingAvailableMeasurement) {\r\n            getProject(additionalParams.code);\r\n        }\r\n        if (matchingAvailableMeasurement && matchingAssignedMeasurement) {\r\n            vm.addMeasurementFormGroup.patchValue({ Measurement: matchingAvailableMeasurement }, { emitEvent: false });\r\n            vm.addMeasurementFormGroup.get('Measurement').markAsDirty();\r\n            vm.addMeasurementFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('mat-select[formControlName=\"Measurement\"]');\r\n                if (selectElement) {\r\n                    selectElement.dispatchEvent(new Event('change'));\r\n                }\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n    \r\n    function getProject(code) {\r\n        vm.MeasurementEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToProject = null;\r\n\r\n        deviceService.findByName(code)\r\n            .pipe(\r\n                widgetContext.rxjs.map((origMeasurement) => {\r\n                    vm.MeasurementEntityId = origMeasurement.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.MeasurementEntityId, 'entityType': 'ASSET' }).pipe(\r\n                    widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations).pipe(\r\n                        widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToProject = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-Measurement\");\r\n                        let params = {\r\n                            \"Project\": vm.assignedToProject,\r\n                            \"Measurement\": vm.MeasurementEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1adbc23d-7aa4-6282-d555-61ab94b71e7e"
              },
              {
                "name": "Measurements",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Measurements",
                "setEntityId": true,
                "stateEntityParamName": "selectedProject",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f921410a-47b7-5884-1c63-d010a39064a4"
              },
              {
                "name": "delete-Project",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenDeleteDoktorkitDialog();\n\nfunction openDeleteDoktorkitDialog() {\n  var title = 'Are you sure you want to delete the Doktorkit ' + entityName + '?';\n  var content = 'Be careful, after the confirmation, the Doktorkit will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteDoktorkit();\n      }\n    }\n  );\n}\n\nfunction deleteDoktorkit() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      var removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  var removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteDoktorkitToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Doktorkit Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Doktorkit Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteDoktorkitToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "1af63269-0a95-b82e-0703-86bd8daf9356"
              },
              {
                "name": "get-location",
                "icon": "location_on",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "getLocation",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Get location action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to get phone location', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processLocationFunction": "// Function body to process current location of the phone. \n// - latitude - phone location latitude\n// - longitude - phone location longitude\nlet $injector = widgetContext.$scope.$injector;\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\n//showLocationDialog('Location', latitude, longitude);\nsaveEntityLocationAttributes('latitude', 'longitude', latitude, longitude);\nfunction getSelectedKitId() {\n    let stateParams = widgetContext.stateController.getStateParams();\n    return stateParams.selectedDoktorkit.entityId;\n}\n\nfunction saveEntityLocationAttributes(latitudeAttributeName, longitudeAttributeName, latitude, longitude) {\n    let entityId = getSelectedKitId();\n    if (entityId) {\n        let attributes = [\n            { key: \"latitude\", value: latitude },\n            { key: \"longitude\", value: longitude }\n        ];\n        attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributes).subscribe(\n        widgetContext.dialogs.alert('Location attributes saved!\\nLatitude: ' + latitude + '\\nLongitude: ' + longitude),\n           function() {\n               widgetContext.showSuccessToast('Location attributes saved!');\n           },\n           function(error) {\n               widgetContext.dialogs.alert('Location attributes save failed', JSON.stringify(error));\n           }\n        );\n    }\n}\n\n\nfunction showLocationDialog(title, latitude, longitude) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Latitude: '+latitude+'<br>Longitude: ' + longitude).subscribe();\n    }, 100);\n}"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "94c2e448-3356-0d9d-d976-d11a0ac2165c"
              }
            ],
            "headerButton": []
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "9ce62891-046b-e732-060f-37704b7d8998",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "5cf98db3-81f6-ad77-e161-e6e0f569a851": {
        "typeFullFqn": "system.action_button",
        "type": "latest",
        "sizeX": 3,
        "sizeY": 1,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1727860414250,
                "endTimeMs": 1727946814250
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#FFFFFF01",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "activatedState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "disabledState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "appearance": {
              "type": "filled",
              "showLabel": true,
              "label": "Manage Users",
              "showIcon": true,
              "icon": "people",
              "iconSize": 24,
              "iconSizeUnit": "px",
              "mainColor": "#435B63",
              "backgroundColor": "#FFFFFF",
              "autoScale": true,
              "customStyle": {
                "enabled": null,
                "hovered": null,
                "pressed": null,
                "activated": null,
                "disabled": null
              }
            }
          },
          "title": "Action button",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "borderRadius": "4px",
          "configMode": "advanced",
          "actions": {
            "click": [
              {
                "name": "onClick",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "user",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "c1e9b3b8-a83d-1c1d-79bb-cef18f277e62"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "5cf98db3-81f6-ad77-e161-e6e0f569a851"
      },
      "d0614cb8-3793-26e6-571c-61236d1a3252": {
        "typeFullFqn": "system.action_button",
        "type": "latest",
        "sizeX": 3,
        "sizeY": 1,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "09a7d069-f810-fea9-8e3d-4309f4a424ae",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1727860640000,
                "endTimeMs": 1727947040000
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#FFFFFF01",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "activatedState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "disabledState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "appearance": {
              "type": "filled",
              "showLabel": true,
              "label": "Manage Gateways",
              "showIcon": true,
              "icon": "router",
              "iconSize": 24,
              "iconSizeUnit": "px",
              "mainColor": "#435B63",
              "backgroundColor": "#FFFFFF",
              "autoScale": true,
              "customStyle": {
                "enabled": null,
                "hovered": null,
                "pressed": null,
                "activated": null,
                "disabled": null
              }
            }
          },
          "title": "Action button",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "borderRadius": "4px",
          "configMode": "advanced",
          "actions": {
            "click": [
              {
                "name": "onClick",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "gateways",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "bb7463c6-ee9e-d30e-5bed-101118692f2b"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "d0614cb8-3793-26e6-571c-61236d1a3252"
      },
      "fe3556b7-73a1-0009-cd3c-a9c6680ccd7a": {
        "typeFullFqn": "system.action_button",
        "type": "latest",
        "sizeX": 3,
        "sizeY": 1,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "entityAliasId": "09a7d069-f810-fea9-8e3d-4309f4a424ae",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1727859232084,
                "endTimeMs": 1727945632084
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#FFFFFF01",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "activatedState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "disabledState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "appearance": {
              "type": "filled",
              "showLabel": true,
              "label": "Manage Kits",
              "showIcon": true,
              "icon": "medical_services",
              "iconSize": 24,
              "iconSizeUnit": "px",
              "mainColor": "#435B63",
              "backgroundColor": "#FFFFFF",
              "autoScale": true,
              "customStyle": {
                "enabled": null,
                "hovered": null,
                "pressed": null,
                "activated": null,
                "disabled": null
              }
            }
          },
          "title": "Action button",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "borderRadius": "4px",
          "configMode": "advanced",
          "actions": {
            "click": [
              {
                "name": "onClick",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "doktorkits_all",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "d3007368-0cff-035d-787f-9215e17323cb"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "fe3556b7-73a1-0009-cd3c-a9c6680ccd7a"
      },
      "ed6cf40c-1c37-2fe9-4436-22c669817f3e": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "filterId": null,
              "dataKeys": []
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "useMarkdownTextFunction": true,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n    <section *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex fxLayout=\"column\">\n\t<h5 class=\"market-title\">{{ ctx.stateController.getStateParams().selectedDoktorkit.entityName }}</h5>\n\t<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"devices_card\"></tb-dashboard-state>\n    </section>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" stateId=\"Doktorkits_card\"></tb-dashboard-state>\n    <mat-divider style=\"margin-top: 10px; margin-bottom: 10px;\"></mat-divider>\n    <tb-dashboard-state *ngIf=\"ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"Doktorkit_alarms\"></tb-dashboard-state>\n    <tb-dashboard-state *ngIf=\"!ctx.stateController.getStateParams().selectedDoktorkit\" fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"false\" stateId=\"Doktorkits_alarms\"></tb-dashboard-state>\n</div>",
            "markdownTextFunction": "var DoktorkitState;\r\nif (data && data.length && data[0]['entityId']) {\r\n    DoktorkitState = true;\r\n} else {\r\n    DoktorkitState = false;\r\n}\r\n\r\nvar typeSvg = '<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24\" viewBox=\"0 -960 960 960\" width=\"24\"><path d=\"M160-80q-33 0-56.5-23.5T80-160v-480q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v480q0 33-23.5 56.5T800-80H160Zm240-640h160v-80H400v80Zm40 360v120h80v-120h120v-80H520v-120h-80v120H320v80h120Z\"/></svg>';\r\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\r\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\r\n\r\nvar header = '<div class=\"header\" fxLayout=\"column\" fxLayoutAlign=\"start stretch\" fxLayoutGap=\"8px\">' +\r\n                '<div fxLayout=\"row\" fxLayoutAlign=\"start stretch\">' +\r\n                  '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><button id=\"go-back\" matTooltip=\"Go back\" type=\"button\" mat-icon-button><mat-icon>arrow_back</mat-icon></button></div>' +\r\n                 /* '<div fxLayout=\"column\" fxLayoutAlign=\"center\"><img style=\"vertical-align: middle;\" class=\"title-icon mat-icon\" src=\"'+ typeSvgUrl +'\"></div>' +*/\r\n                  '<div fxFlex fxLayout=\"column\" fxLayoutAlign=\"center\">' +\r\n                     '<div class=\"title\">Edit Doktorkit: {{ ctx.stateController.getStateParams().selectedDoktorkit?.entityName }}</div>' +\r\n                  '</div>' +\r\n                '</div>' +\r\n                '<div fxLayout=\"row\" fxLayoutAlign=\"stretch stretch\" fxLayoutGap=\"8px\">' +\r\n                  /*'<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"add-Kit\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">add_circle</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"Doktorkits\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">devices_other</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"20\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"Sensorkits\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">sensors</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +*/\r\n                  '<div fxFlex=\"50\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"get-location\" type=\"button\" mat-raised-button color=\"primary\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">location_on</mat-icon>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                  '<div fxFlex=\"50\" fxLayout=\"column\" fxLayoutAlign=\"stretch stretch\">' +\r\n                    '<button id=\"delete-Doktorkit\" type=\"button\" mat-raised-button color=\"accent\">' +\r\n                      '<mat-icon class=\"tb-mat-20\">delete</mat-icon><span></span>' +\r\n                    '</button>' +\r\n                  '</div>' +\r\n                '</div>' +\r\n             '</div>';\r\n             \r\nreturn '<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">' +\r\n          (DoktorkitState \r\n            ? (header +\r\n               '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"edit_Doktorkit_card\"></tb-dashboard-state>') \r\n            : '<tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"doktorkits_card_all_customer\"></tb-dashboard-state>') +\r\n       '</div>';\r\n",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view table {\n    border: none;\n    border-radius: 0px;\n    overflow: auto;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n\n.tb-markdown-view .tb-widget-container > .tb-widget .tb-table-widget mat-toolbar {\n    height: 65px;\n    max-height: 65px;\n}\n\n\n.tb-markdown-view .tb-widget-container > .tb-widget.tb-has-timewindow .tb-table-widget mat-toolbar {\n    height: 100px;\n    max-height: 100px;\n}\n\n.main-layout .header {\n    height: 100px;\n    margin: 6px;\n} \n\n.main-layout .header .mat-icon.title-icon {\n    width: 40px;\n    height: 40px;\n}\n\n.main-layout .header .title {\n    font-size: 18px;\n    font-weight: 500;\n    color: #28232D;\n}\n\n.main-layout .header .subtitle {\n    font-size: 13px;\n    font-weight: normal;\n    color: #757575;\n}\n\n.main-layout .tb-mat-20 {\n    width: 1px;\n    height: 2px;\n    margin: 2px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-title {\n    align-items: stretch !important;\n    flex: 1;\n}\n\n.tb-widget-actions {\n    position: absolute;\n    top: 0;\n    right: 0;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow {\n    border: 1px solid rgba(0, 0, 0, 0.12);\n    border-radius: 4px;\n    padding: 8px 8px;\n    position: relative;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow span {\n    flex: 1;\n    line-height: 32px;\n}\n\n.tb-widget-title tb-timewindow .tb-timewindow::after {\n    font-family: \"Material Icons\";\n    content: 'expand_more';\n    position: absolute;\n    font-size: 24px;\n    top: 12px;\n    right: 12px;\n    z-index: -1;\n}",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "go-back",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nparams['selectedDoktorkit'] = null;\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "116515c2-d9bd-80b6-7a34-97373a802806"
              },
              {
                "name": "Doktorkit-devices",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f921410a-47b7-5884-1c63-d010a39064a4"
              }
            ],
            "headerButton": []
          }
        },
        "row": 0,
        "col": 0,
        "id": "ed6cf40c-1c37-2fe9-4436-22c669817f3e",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "4cc2a279-fbae-dce8-0827-5a24057fe53e": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"market-layout\" style=\"width: 100%; height: 100%; padding: 0;\" fxLayout=\"column\">\n     <div fxLayout=\"row\" style=\"width: 100%; height: 60px;\" fxLayoutAlign=\"center start\">\n        <h5 fxFlex class=\"market-title\">Doktorkits</h5>\n        <button id=\"add-Doktorkit\" mat-raised-button color=\"primary\"><mat-icon class=\"tb-mat-20\">add</mat-icon><span>Add Doktorkit</span></button>\n     </div>\n    <div fxFlex fxLayout=\"column\" style=\"position: relative;\">\n        <tb-dashboard-state fxFlex [ctx]=\"ctx\" [syncParentStateParams]=\"true\" stateId=\"doktorkits_map_all\"></tb-dashboard-state>\n    </div>\n</div>",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view > div {\n    padding: 0;\n}\n\n.market-layout {\n    position: relative;\n}\n\n.market-title {\n    font-size: 26px;\n    padding-bottom: 16px;\n    padding-left: 10px;\n    padding-top: 5px;\n}\n\n"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": ".tb-widget-container .tb-widget .tb-multiple-input {\n    background-color: #FAFAFA;\n    border-radius: 4px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .input-field {\n    padding-right: 30px;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input mat-slide-toggle {\n    margin-top: 15px !important;\n    margin-bottom: 0 !important;\n}\n\n.tb-widget-container .tb-widget .tb-multiple-input .mat-slide-toggle-content {\n    width: 120px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-bar {\n    width: 42px;\n    height: 24px;\n    border-radius: 16px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb-container {\n    top: 2px;\n    left: 2px;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-thumb-container {\n    transform: translate3d(18px, 0, 0);\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle-thumb {\n    background-color: #fafafa;\n}\n\n.tb-widget-container .tb-widget .mat-slide-toggle.mat-checked .mat-slide-toggle-bar {\n    background-color: #F2994A;\n}\n",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "add-Doktorkit",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDoktorkitFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 350px;\">\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\n    <h2>Add Doktorkit</h2>\n    <span fxFlex></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content fxLayout=\"column\">\n    <div fxLayout=\"row\" fxLayoutGap=\"8px\" fxLayout.xs=\"column\"  fxLayoutGap.xs=\"0\">\n      <mat-form-field fxFlex class=\"mat-block\">\n        <mat-label>Doktorkit title</mat-label>\n        <input matInput formControlName=\"name\" required>\n        <mat-error *ngIf=\"addDoktorkitFormGroup.get('name').hasError('required')\">\n          Doktorkit title is required.\n        </mat-error>\n      </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      Cancel\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addDoktorkitFormGroup.invalid || !addDoktorkitFormGroup.dirty\">\n      Add Doktorkit\n    </button>\n  </div>\n</form>\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\n\r\nopenAddDoktorkitDialog();\r\n\r\nfunction openAddDoktorkitDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddDoktorkitDialogController).subscribe();\r\n}\r\n\r\nfunction AddDoktorkitDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.addDoktorkitFormGroup = vm.fb.group({\r\n    name: ['', [vm.validators.required]]\r\n  });\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  vm.save = function () {\r\n    const stateParams = widgetContext.stateController.getStateParams();\r\n    var customerId;\r\n    var projectId;\r\n    var measurementId;\r\n    projectId = {id:(stateParams.selectedProject && stateParams.selectedProject.entityId && stateParams.selectedProject.entityId.id) ? stateParams.selectedProject.entityId.id : '',entityType: 'ASSET'}; \r\n    measurementId = {id:(stateParams.selectedMeasurement && stateParams.selectedMeasurement.entityId && stateParams.selectedMeasurement.entityId.id) ? stateParams.selectedMeasurement.entityId.id : '',entityType: 'ASSET'}; \r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        customerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n    vm.addDoktorkitFormGroup.markAsPristine();\r\n    saveDoktorkitObservable(customerId).subscribe(\r\n      function (Doktorkit) {\r\n        const observables = [\r\n        saveCustomerToDoktorkitRelation(customerId, Doktorkit.id),\r\n        saveAttributes(Doktorkit.id)\r\n        ];\r\n        // Add saveProjectToMeasurementRelation to observables if projectId is not empty\r\n        if(projectId.id !== \"\"){\r\n            observables.push(saveProjectToDoktorkitRelation(projectId, Doktorkit.id));\r\n        }\r\n        if(measurementId.id !== \"\"){\r\n            observables.push(saveMeasurementToDoktorkitRelation(measurementId, Doktorkit.id));\r\n        }\r\n          widgetContext.rxjs.forkJoin(observables).subscribe(\r\n              function () {\r\n                var params = widgetContext.stateController.getStateParams();\r\n                var selectedDoktorkit = params['selectedDoktorkit'];\r\n                params['selectedDoktorkit'] = { entityId: Doktorkit.id, entityName: Doktorkit.name, entityLabel: '' };\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              }\r\n        );\r\n      }\r\n    );\r\n  };\r\n\r\n  function saveDoktorkitObservable(customerId) {\r\n    return getDoktorkitsGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((DoktorkitsGroup) => {\r\n            return getUnassignedKitGroup(customerId).pipe(\r\n                widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\r\n                    const formValues = vm.addDoktorkitFormGroup.value;\r\n                    const Doktorkit = {\r\n                        name: formValues.name,\r\n                        type: 'Doktorkit',\r\n                        customerId: customerId\r\n                    };\r\n\r\n                    return assetService.saveAsset(Doktorkit, DoktorkitsGroup.id.id).pipe(\r\n                        widgetContext.rxjs.switchMap((savedAsset) => {\r\n                            // Ensure this line returns an observable\r\n                            return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, savedAsset.id.id).pipe(\r\n                                widgetContext.rxjs.map(() => {\r\n                                    return savedAsset; // Return the saved asset after adding to the entity group\r\n                                })\r\n                            );\r\n                        })\r\n                    );\r\n                })\r\n            );\r\n        })\r\n    );\r\n}\r\n\r\n\r\n  \r\n  function getDoktorkitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var DoktorkitsGroup = entityGroups.find(group => group.name === 'Doktorkits');\r\n              if (DoktorkitsGroup) {\r\n                  return widgetContext.rxjs.of(DoktorkitsGroup);\r\n              } else {\r\n                  DoktorkitsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Doktorkits',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(DoktorkitsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  function getUnassignedKitGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n              if (UnassignedKitGroup) {\r\n                  return widgetContext.rxjs.of(UnassignedKitGroup);\r\n              } else {\r\n                  UnassignedKitGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Unassigned Kit',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n\r\n  function saveCustomerToDoktorkitRelation(customerId, DoktorkitId) {\r\n      var relation = {\r\n          from: customerId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveProjectToDoktorkitRelation(projectId, DoktorkitId) {\r\n      var relation = {\r\n          from: projectId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveMeasurementToDoktorkitRelation(measurementId, DoktorkitId) {\r\n      var relation = {\r\n          from: measurementId,\r\n          to: DoktorkitId,\r\n          typeGroup: 'COMMON',\r\n          type: 'Owns'\r\n      };\r\n      return entityRelationService.saveRelation(relation);\r\n  }\r\n  function saveAttributes(entityId) {\r\n    let attributesArray = [\r\n        {\r\n            key: 'latitude',\r\n            value: 48.1406022\r\n        },\r\n        {\r\n            key: 'longitude',\r\n            value: 16.2932688\r\n        },\r\n        {\r\n            key: 'alias',\r\n            value: 'N/A'\r\n        },        \r\n        {\r\n            key: 'address',\r\n            value: 'N/A'\r\n        },\r\n        {\r\n            key: 'state',\r\n            value: 'normal'\r\n        },\r\n        {\r\n            key: 'units',\r\n            value: 'metric'\r\n        },\r\n        {\r\n            key: 'floorplan',\r\n            value: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCEtLSBDcmVhdGVkIHdpdGggSW5rc2NhcGUgKGh0dHA6Ly93d3cuaW5rc2NhcGUub3JnLykgLS0+Cjxzdmcgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc5LjM3NSA3OS4zNzUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiA8cmVjdCB4PSIyLjcwMTkiIHk9IjIuNzAxOSIgd2lkdGg9IjczLjk3MSIgaGVpZ2h0PSI3My45NzEiIGZpbGw9IiNmZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9Ii4xMTIxIiBzdHlsZT0icGFpbnQtb3JkZXI6bWFya2VycyBmaWxsIHN0cm9rZSIvPgogPGcgdHJhbnNmb3JtPSJtYXRyaXgoLjI2NDU4IDAgMCAuMjY0NTggMi42MzUgLTIuODgzNCkiIHN0cm9rZS13aWR0aD0iMXB4IiBzdHlsZT0ic2hhcGUtaW5zaWRlOnVybCgjcmVjdDQ4MzYpO3doaXRlLXNwYWNlOnByZSIgYXJpYS1sYWJlbD0iICAgTm8gcGxhbiBjb25maWd1cmVkIj4KICA8cGF0aCBkPSJtMTAxLjY3IDExOC4yOXYyOC40MzhoLTMuNzg5MWwtMTQuMzE2LTIxLjkzNHYyMS45MzRoLTMuNzY5NXYtMjguNDM4aDMuNzY5NWwxNC4zNzUgMjEuOTkydi0yMS45OTJ6Ii8+CiAgPHBhdGggZD0ibTEwNi44MyAxMzUuOTVxMC00LjU4OTggMi41NzgxLTcuNjU2MiAyLjU3ODEtMy4wODU5IDcuMDExNy0zLjA4NTl0Ny4wMTE3IDMuMDI3M3EyLjU3ODEgMy4wMDc4IDIuNjM2NyA3LjUxOTV2MC42NDQ1M3EwIDQuNTg5OC0yLjU5NzcgNy42NTYyLTIuNTc4MSAzLjA2NjQtNy4wMTE3IDMuMDY2NC00LjQ1MzEgMC03LjA1MDgtMy4wNjY0LTIuNTc4MS0zLjA2NjQtMi41NzgxLTcuNjU2MnptMy42MTMzIDAuNDQ5MjJxMCAzLjE0NDUgMS40ODQ0IDUuNDQ5MiAxLjUwMzkgMi4zMDQ3IDQuNTMxMiAyLjMwNDcgMi45NDkyIDAgNC40NTMxLTIuMjY1NiAxLjUwMzktMi4yODUyIDEuNTIzNC01LjQyOTd2LTAuNTA3ODFxMC0zLjEwNTUtMS41MDM5LTUuNDI5Ny0xLjUwMzktMi4zNDM4LTQuNTExNy0yLjM0MzgtMi45ODgzIDAtNC40OTIyIDIuMzQzOC0xLjQ4NDQgMi4zMjQyLTEuNDg0NCA1LjQyOTd6Ii8+CiAgPHBhdGggZD0ibTE1MC4xNyAxNDcuMTJxLTMuODA4NiAwLTYuMDM1Mi0yLjQ0MTR2MTAuMTc2aC0zLjYzMjh2LTI5LjI1OGgzLjMyMDNsMC4xNzU3OCAyLjMyNDJxMi4yMjY2LTIuNzE0OCA2LjExMzMtMi43MTQ4IDQuMDAzOSAwIDYuMTMyOCAyLjk2ODggMi4xMjg5IDIuOTY4OCAyLjEyODkgNy44MTI1djAuNDEwMTZxMCA0LjYyODktMi4xNDg0IDcuNjc1OC0yLjEyODkgMy4wNDY5LTYuMDU0NyAzLjA0Njl6bS0xLjExMzMtMTguODY3cS0zLjI4MTIgMC00LjkyMTkgMi45MTAydjEwLjExN3ExLjY2MDIgMi44NzExIDQuOTYwOSAyLjg3MTEgMi45Mjk3IDAgNC4yNzczLTIuMzA0NyAxLjM2NzItMi4zMDQ3IDEuMzY3Mi01LjQ0OTJ2LTAuNDEwMTZxMC0zLjE0NDUtMS4zNjcyLTUuNDI5Ny0xLjM0NzYtMi4zMDQ3LTQuMzE2NC0yLjMwNDd6Ii8+CiAgPHBhdGggZD0ibTE2Ni45MSAxMTYuNzN2MzBoLTMuNjMyOHYtMzB6Ii8+CiAgPHBhdGggZD0ibTE4NS43NSAxNDYuNzNxLTAuMzUxNTctMC43NjE3Mi0wLjUwNzgyLTIuMjI2Ni0xLjAxNTYgMS4wNzQyLTIuNTM5MSAxLjg1NTUtMS41MjM0IDAuNzYxNzItMy40NzY2IDAuNzYxNzItMy4yNDIyIDAtNS4xOTUzLTEuODE2NC0xLjk1MzEtMS44MTY0LTEuOTUzMS00LjQ1MzEgMC0zLjM5ODQgMi41NzgxLTUuMTU2MiAyLjU3ODEtMS43NzczIDYuOTMzNi0xLjc3NzNoMy41NzQydi0xLjY3OTdxMC0xLjg3NS0xLjEzMjgtMi45ODgzLTEuMTEzMy0xLjEzMjgtMy4zMjAzLTEuMTMyOC0yLjA1MDggMC0zLjMyMDMgMS4wMTU2LTEuMjUgMC45OTYxLTEuMjUgMi4zMjQyaC0zLjYxMzNxMC0yLjI2NTYgMi4yODUyLTQuMjU3OCAyLjI4NTItMS45OTIyIDYuMTEzMy0xLjk5MjIgMy40Mzc1IDAgNS42NDQ1IDEuNzU3OCAyLjIwNyAxLjc1NzggMi4yMDcgNS4zMTI1djkuNDkyMnEwIDIuOTI5NyAwLjc0MjE5IDQuNjQ4NHYwLjMxMjV6bS01Ljk5NjEtMi43NzM0cTEuOTUzMSAwIDMuMzc4OS0wLjk3NjU2IDEuNDQ1My0wLjk3NjU2IDIuMDMxMi0yLjE2OHYtNC4zNTU1aC0zLjM1OTRxLTYuMDkzOCAwLjExNzE5LTYuMDkzOCAzLjkwNjIgMCAxLjUwMzkgMS4wMTU2IDIuNTU4NiAxLjAxNTYgMS4wMzUyIDMuMDI3MyAxLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTIwMy4yMyAxMjguMjVxLTEuNzM4MyAwLTMuMDY2NCAwLjkzNzUtMS4zMjgxIDAuOTM3NS0yLjA4OTggMi40NDE0djE1LjA5OGgtMy42MTMzdi0yMS4xMzNoMy40MThsMC4xMTcxOSAyLjYzNjdxMi40MDIzLTMuMDI3MyA2LjMwODYtMy4wMjczIDMuMTA1NSAwIDQuOTIxOSAxLjczODMgMS44MzU5IDEuNzM4MyAxLjg1NTUgNS44Mzk4djEzLjk0NWgtMy42MzI4di0xMy44ODdxMC0yLjQ4MDUtMS4wOTM4LTMuNTM1Mi0xLjA3NDItMS4wNTQ3LTMuMTI1LTEuMDU0N3oiLz4KICA8cGF0aCBkPSJtNTcuOTQxIDE5NC4xNXExLjkzMzYgMCAzLjM3ODktMS4xNTIzIDEuNDY0OC0xLjE1MjMgMS42MDE2LTIuOTQ5MmgzLjQzNzVxLTAuMTM2NzIgMi44MzItMi41OTc3IDQuOTYwOS0yLjQ2MDkgMi4xMDk0LTUuODIwMyAyLjEwOTQtNC43NjU2IDAtNy4wODk4LTMuMTQ0NS0yLjMwNDctMy4xNDQ1LTIuMzA0Ny03LjQwMjN2LTAuODIwMzFxMC00LjI1NzggMi4zMDQ3LTcuNDAyNCAyLjMyNDItMy4xNDQ1IDcuMDg5OC0zLjE0NDUgMy43MTA5IDAgNS45OTYxIDIuMjA3IDIuMjg1MiAyLjE4NzUgMi40MjE5IDUuNDQ5MmgtMy40Mzc1cS0wLjEzNjcyLTEuOTUzMS0xLjQ4NDQtMy4zMjAzLTEuMzI4MS0xLjM2NzItMy40OTYxLTEuMzY3Mi0yLjIyNjYgMC0zLjQ5NjEgMS4xMzI4LTEuMjUgMS4xMzI4LTEuNzc3MyAyLjg3MTEtMC41MDc4MSAxLjczODMtMC41MDc4MSAzLjU3NDJ2MC44MjAzMXEwIDEuODU1NSAwLjUwNzgxIDMuNTkzOCAwLjUwNzgxIDEuNzM4MyAxLjc1NzggMi44NzExIDEuMjY5NSAxLjExMzMgMy41MTU2IDEuMTEzM3oiLz4KICA8cGF0aCBkPSJtNjkuNDY1IDE4NS45NXEwLTQuNTg5OCAyLjU3ODEtNy42NTYyIDIuNTc4MS0zLjA4NTkgNy4wMTE3LTMuMDg1OSA0LjQzMzYgMCA3LjAxMTcgMy4wMjczIDIuNTc4MSAzLjAwNzggMi42MzY3IDcuNTE5NXYwLjY0NDUzcTAgNC41ODk4LTIuNTk3NyA3LjY1NjItMi41NzgxIDMuMDY2NC03LjAxMTcgMy4wNjY0LTQuNDUzMSAwLTcuMDUwOC0zLjA2NjQtMi41NzgxLTMuMDY2NC0yLjU3ODEtNy42NTYyem0zLjYxMzMgMC40NDkyMnEwIDMuMTQ0NSAxLjQ4NDQgNS40NDkyIDEuNTAzOSAyLjMwNDcgNC41MzEyIDIuMzA0NyAyLjk0OTIgMCA0LjQ1MzEtMi4yNjU2IDEuNTAzOS0yLjI4NTIgMS41MjM0LTUuNDI5N3YtMC41MDc4MXEwLTMuMTA1NS0xLjUwMzktNS40Mjk3LTEuNTAzOS0yLjM0MzgtNC41MTE3LTIuMzQzOC0yLjk4ODMgMC00LjQ5MjIgMi4zNDM4LTEuNDg0NCAyLjMyNDItMS40ODQ0IDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTAyIDE3OC4yNXEtMS43MzgzIDAtMy4wNjY0IDAuOTM3NS0xLjMyODEgMC45Mzc1LTIuMDg5OCAyLjQ0MTR2MTUuMDk4aC0zLjYxMzN2LTIxLjEzM2gzLjQxOGwwLjExNzE5IDIuNjM2N3EyLjQwMjMtMy4wMjczIDYuMzA4Ni0zLjAyNzMgMy4xMDU1IDAgNC45MjE5IDEuNzM4MyAxLjgzNTkgMS43MzgzIDEuODU1NSA1LjgzOTh2MTMuOTQ1aC0zLjYzMjh2LTEzLjg4N3EwLTIuNDgwNS0xLjA5MzgtMy41MzUyLTEuMDc0Mi0xLjA1NDctMy4xMjUtMS4wNTQ3eiIvPgogIDxwYXRoIGQ9Im0xMjQuNDYgMTc4LjM3aC00LjMxNjR2MTguMzU5aC0zLjYxMzN2LTE4LjM1OWgtMy4zMzk4di0yLjc3MzRoMy4zMzk4di0xLjgzNTlxMC0zLjU5MzggMi4wNzAzLTUuNTA3OCAyLjA3MDMtMS45MzM2IDUuNjY0MS0xLjkzMzYgMi4xODc1IDAgNS41MjczIDEuMTkxNGwtMC42MDU0NiAzLjA0NjlxLTIuNTM5MS0wLjk5NjA5LTQuNjY4LTAuOTk2MDktMi4zMjQyIDAtMy4zNTk0IDEuMDU0Ny0xLjAxNTYgMS4wMzUyLTEuMDE1NiAzLjE0NDV2MS44MzU5aDQuMzE2NHptNy4xMDk0LTIuNzczNHYyMS4xMzNoLTMuNjEzM3YtMjEuMTMzeiIvPgogIDxwYXRoIGQ9Im0xNDUuNTIgMjA1LjA3cS0xLjY0MDYgMC00LjAyMzQtMC44MDA3OC0yLjM4MjgtMC44MDA3OC0zLjgwODYtMi44NzExbDEuODk0NS0yLjE0ODRxMi4zNDM4IDIuODUxNiA1LjY2NDEgMi44NTE2IDIuNTU4NiAwIDQuMDgyLTEuNDQ1MyAxLjUyMzQtMS40MjU4IDEuNTIzNC00LjE5OTJ2LTEuODU1NXEtMi4xNDg0IDIuNTE5NS01LjkxOCAyLjUxOTUtMy44MDg2IDAtNi4wNTQ3LTMuMDQ2OS0yLjI0NjEtMy4wNDY5LTIuMjQ2MS03LjY3NTh2LTAuNDEwMTZxMC00Ljg0MzggMi4yMjY2LTcuODEyNSAyLjI0NjEtMi45Njg4IDYuMTEzMy0yLjk2ODggMy44ODY3IDAgNi4wMzUyIDIuNzM0NGwwLjE3NTc4LTIuMzQzOGgzLjI4MTJ2MjAuNjg0cTAgNC4xOTkyLTIuNSA2LjQ4NDQtMi41IDIuMzA0Ny02LjQ0NTMgMi4zMDQ3em0tNS4yNzM0LTE4LjY3MnEwIDMuMTQ0NSAxLjMwODYgNS40MTAyIDEuMzI4MSAyLjI0NjEgNC4yNTc4IDIuMjQ2MSAzLjQzNzUgMCA1LjAzOTEtMy4xMjV2LTkuNjI4OXEtMC42ODM1OS0xLjMwODYtMS44OTQ1LTIuMTY4LTEuMjEwOS0wLjg3ODktMy4xMDU1LTAuODc4OS0yLjk0OTIgMC00LjI3NzMgMi4zMDQ3LTEuMzI4MSAyLjI4NTItMS4zMjgxIDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTczLjA2IDE5Ni43My0wLjA3ODEtMi4wODk4cS0yLjA3MDMgMi40ODA1LTYuMTcxOSAyLjQ4MDUtMy4xMDU1IDAtNS4wMTk1LTEuODM1OS0xLjkxNDEtMS44MzU5LTEuOTE0MS02LjA1NDd2LTEzLjYzM2gzLjYxMzN2MTMuNjcycTAgMi44NTE2IDEuMTkxNCAzLjgyODEgMS4yMTA5IDAuOTU3MDMgMi42OTUzIDAuOTU3MDMgNC4wODIgMCA1LjUwNzgtMy4wNjY0di0xNS4zOTFoMy42MzI4djIxLjEzM3oiLz4KICA8cGF0aCBkPSJtMTkwLjQ0IDE3OC42OHEtMy41MzUyIDAtNC44MjQyIDMuMDQ2OXYxNWgtMy42MTMzdi0yMS4xMzNoMy41MTU2bDAuMDc4MSAyLjQyMTlxMS43MzgzLTIuODEyNSA1LjAxOTUtMi44MTI1IDEuMDE1NiAwIDEuNjAxNiAwLjI3MzQ0bC0wLjAxOTUgMy4zNTk0cS0wLjgwMDc4LTAuMTU2MjUtMS43NTc4LTAuMTU2MjV6Ii8+CiAgPHBhdGggZD0ibTIxMS45MSAxOTMuMDRxLTEuMDM1MiAxLjU2MjUtMi45Mjk3IDIuODMyLTEuODk0NSAxLjI1LTUuMDE5NSAxLjI1LTQuNDE0MSAwLTcuMDcwMy0yLjg3MTEtMi42MzY3LTIuODcxMS0yLjYzNjctNy4zNDM4di0wLjgyMDMxcTAtMy40NTcgMS4zMDg2LTUuODc4OSAxLjMyODEtMi40NDE0IDMuNDM3NS0zLjcxMDkgMi4xMDk0LTEuMjg5MSA0LjQ5MjItMS4yODkxIDQuNTMxMiAwIDYuNjAxNiAyLjk2ODggMi4wODk4IDIuOTQ5MiAyLjA4OTggNy4zODI4djEuNjIxMWgtMTQuMjk3cTAuMDc4MSAyLjkxMDIgMS43MTg4IDQuOTYwOSAxLjY2MDIgMi4wMzEyIDQuNTUwOCAyLjAzMTIgMS45MTQxIDAgMy4yNDIyLTAuNzgxMjUgMS4zMjgxLTAuNzgxMjUgMi4zMjQyLTIuMDg5OHptLTguNDE4LTE0Ljg2M3EtMi4xNDg0IDAtMy42MzI4IDEuNTYyNS0xLjQ4NDQgMS41NjI1LTEuODU1NSA0LjQ5MjJoMTAuNTY2di0wLjI3MzQ0cS0wLjEzNjcyLTIuMTA5NC0xLjIzMDUtMy45NDUzLTEuMDc0Mi0xLjgzNTktMy44NDc3LTEuODM1OXoiLz4KICA8cGF0aCBkPSJtMjMwLjAzIDE5Ni43My0wLjE3NTc4LTIuMjY1NnEtMi4xNjggMi42NTYyLTYuMDM1MiAyLjY1NjItMy43MTA5IDAtNS45OTYxLTMuMDA3OC0yLjI4NTItMy4wMDc4LTIuMzI0Mi03LjU1ODZ2LTAuNTY2NDFxMC00Ljg0MzggMi4yODUyLTcuODEyNSAyLjMwNDctMi45Njg4IDYuMDc0Mi0yLjk2ODggMy43MzA1IDAgNS44NTk0IDIuNXYtMTAuOTc3aDMuNjMyOHYzMHptLTEwLjg5OC0xMC4zMzJxMCAzLjE0NDUgMS4zMjgxIDUuNDEwMiAxLjMyODEgMi4yNDYxIDQuMjU3OCAyLjI0NjEgMy4zNTk0IDAgNS0zLjA2NjR2LTkuNzI2NnEtMS42MjExLTMuMDA3OC00Ljk2MDktMy4wMDc4LTIuOTQ5MiAwLTQuMjk2OSAyLjMwNDctMS4zMjgxIDIuMjg1Mi0xLjMyODEgNS40Mjk3eiIvPgogPC9nPgo8L3N2Zz4K'\r\n        }\r\n    ];\r\n    return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\r\n  }\r\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "7cad1c71-0765-4277-32a8-c87808a0c689"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "4cc2a279-fbae-dce8-0827-5a24057fe53e",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "af8bd4a6-39c7-d8a5-2894-64840ac87fdd": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Doktorkits",
            "enableSearch": true,
            "enableSelectColumnDisplay": true,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": true,
            "entityNameColumnTitle": "Doktorkit ID",
            "displayEntityLabel": true,
            "entityLabelColumnTitle": "Label",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Doktorkits",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "2519c941-a1b9-45bd-9821-88acf22e10af",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "Address",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "70%",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.1345774127559587,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "locationName",
                  "type": "attribute",
                  "label": "Location Alias",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.7448728411727017,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "Open devices",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "92ce5e29-82ad-9f6e-51be-7bf3e7ae613d"
              }
            ],
            "actionCellButton": [
              {
                "name": "Open Doktorkit devices",
                "icon": "devices_other",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "Doktorkit_devices_table",
                "setEntityId": true,
                "stateEntityParamName": "selectedDoktorkit",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "71c478b6-a4b1-e569-e99a-85d5562cc721"
              }
            ],
            "headerButton": [
              {
                "name": "Refresh",
                "icon": "refresh",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nwidgetContext.stateController.updateState(null, params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "3218fb1e-c187-8197-670e-0ffb20e33283"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "af8bd4a6-39c7-d8a5-2894-64840ac87fdd",
        "typeFullFqn": "system.cards.entities_table"
      },
      "70c3a394-8f22-3d3b-ccb3-ab1bf7bba2f4": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
              "filterId": null,
              "dataKeys": []
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div style=\"width: 100%; height: 100%;\" fxLayout=\"row\" class=\"attribute-update-form\" style=\"padding: 0 8px;\">\n    <div fxFlex fxLayout=\"column\">\n        <mat-form-field class=\"mat-block\" style=\"width: 100%;\">\n              <mat-label>Label</mat-label>\n              <input #labelInput #labelInputCtrl=\"ngModel\" required matInput [(ngModel)]=\"labelInput.value\"\n                     value=\"${entityLabel}\" (keyUp.enter)=\"labelInput.value !== '${entityLabel}' ? saveTitleButton._elementRef.nativeElement.click() : return;\"\n                     (keyUp.escape)=\"labelInput.value = '${entityLabel}';\"/>\n              <mat-error *ngIf=\"!labelInputCtrl.valid\">Label is required</mat-error>         \n        </mat-form-field>\n    </div>\n    <div class=\"input-buttons\">\n        <button #saveTitleButton id=\"save-title\" [disabled]=\"labelInput.value === '${entityLabel}' || !labelInputCtrl.valid\" [attr.data-title]=\"labelInput.value\" type=\"button\" mat-icon-button>\n            <mat-icon>check</mat-icon>\n        </button> \n        <button [disabled]=\"labelInput.value === '${entityLabel}'\" type=\"button\" mat-icon-button (click)=\"labelInput.value = '${entityLabel}';\">\n            <mat-icon>close</mat-icon>\n        </button>\n    </div>\n</div>\n",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ".tb-markdown-view > div {\n    padding: 0;\n}\n\n.tb-markdown-view  .grid__element:last-child {\n    margin-top: 19px;\n    margin-left: 7px;\n}\n\n.tb-markdown-view  .attribute-update-form .mat-icon-button {\n    width: 32px;\n    min-width: 32px;\n    height: 32px;\n    min-height: 32px;\n    padding: 0 !important;\n    margin: 0 !important;\n    line-height: 20px;\n}\n\n.tb-markdown-view  .attribute-update-form .mat-icon-button mat-icon {\n    width: 20px;\n    min-width: 20px;\n    height: 20px;\n    min-height: 20px;\n    font-size: 20px;\n}\n\n.tb-markdown-view .attribute-update-form .input-buttons {\n    margin-top: 19px;\n    margin-left: 7px;\n    display: flex;\n}"
          },
          "title": "New Markdown/HTML Card",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "save-title",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "const targetElement = $($event.target).closest('#save-title', widgetContext.$container[0]);\n\nvar title = $(targetElement).attr('data-title');\n\nwidgetContext.assetService.getAsset(entityId.id, {ignoreLoading: true}).subscribe((Doktorkit) => {\n    Doktorkit.name = title;\n    widgetContext.assetService.saveAsset(Doktorkit, null, {ignoreLoading: true}).subscribe(() => {\n       widgetContext.stateController.getStateParams().selectedDoktorkit.entityName = title;\n       widgetContext.updateAliases();\n    });\n});\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "088a4799-8551-7ab4-892f-2a08d6d40a7c"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "70c3a394-8f22-3d3b-ccb3-ab1bf7bba2f4",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "150eb2dc-f5f1-9ade-8ba7-b3246a205ec0": {
        "typeFullFqn": "system.cards.entities_table",
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1713435502260,
                "endTimeMs": 1713521902260
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "{i18n:custom.projects.measurements.assigned-devices}",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": true,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "Label",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "pageStepCount": 3,
            "pageStepIncrement": 10,
            "defaultSortOrder": "name",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Entities table",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "11f99ccd-3fff-0e24-7f43-355d961fffcb",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "{i18n:custom.projects.measurement.device-label}",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.3781033986280151,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "active",
                  "type": "attribute",
                  "label": "{i18n:custom.projects.measurements.activity}",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar active = value;\r\nif (active == 'true') { // all key values here are strings\r\n  color = '#27AE60';\r\n} else {\r\n  color = '#EB5757';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span>';\r\n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.2732149466989249,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastActivityTime",
                  "type": "attribute",
                  "label": "{i18n:custom.projects.measurements.last-aktivity}",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.675079934696714,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": true,
                  "postFuncBody": "if (value) {\r\n  return moment(value).format(\"DD.MM.YYYY HH:mm:ss\");\r\n}\r\nreturn '';\r\n"
                },
                {
                  "name": "type",
                  "type": "entityField",
                  "label": "{i18n:custom.projects.measurements.type}",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.41194127454705587,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "displayTimewindow": false,
          "configMode": "advanced",
          "actions": {
            "actionCellButton": [
              {
                "name": "{i18n:custom.diagnostics.measurement-devices.set-measurement-label.title}",
                "icon": "label",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return !(data[\"Type\"] === 'P-Flow D116' || \r\n         data[\"Type\"] === 'LTE Status' || \r\n         data[\"Type\"] === 'LoRaWAN GAteway' || \r\n         data[\"Type\"] === 'RESI');\r\n",
                "type": "custom",
                "customFunction": {
                  "body": "utils.setRelatedEntityLabel(widgetContext, entityId);",
                  "modules": {
                    "utils": "tb-resource;/api/resource/js_module/tenant/ECO Utils JS.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f2036f56-b25e-e353-7db5-65beed935224"
              },
              {
                "name": "{i18n:custom.diagnostics.measurement-devices.remove-device.title}",
                "icon": "remove_circle",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\nlet deviceVR;\ngetRelatedVRDevice(entityId.id).subscribe(result => {\n  deviceVR = result[0];\n  //console.log(\"device VR\", deviceVR);\n  openRemoveDeviceDialog();\n});\n\nfunction openRemoveDeviceDialog() {\n  const title = translationService.instant(\n    'custom.projects.measurements.assigned.devices.delete.title',\n    { entityName: entityName }\n  );\n\n  const content = translationService.instant(\n    'custom.projects.measurements.assigned.devices.delete.content'\n  );\n\n  dialogs.confirm(\n    title,\n    content,\n    translationService.instant('action.cancel'),\n    translationService.instant('custom.projects.measurements.assigned.devices.delete.remove-device')\n  ).subscribe(function(result) {\n    if (result) {\n      doRemoveDevice();\n    }\n  });\n}\n\n\nfunction doRemoveDevice() {\n  var customerId;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n  var MeasurementId = widgetContext.stateController.getStateParams().selectedMeasurement.entityId;\n  removeDevice(entityId, MeasurementId, customerId).subscribe(() => {\n      widgetContext.updateAliases();\n  });\n}\n\nfunction removeDevice(deviceId, MeasurementId, customerId) {\n    return getUnassignedDevicesGroup(customerId).pipe(\n        widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n            return widgetContext.rxjs.forkJoin([\n                entityGroupService.addEntityToEntityGroup(unassignedDevicesGroup.id.id, deviceId.id),\n                deleteMeasurementToDeviceRelation(MeasurementId, deviceId),\n                deleteVRDeviceToDeviceRelation(deviceVR.id, deviceId),\n                deleteAttributes(deviceId)\n                //removePositionAttributes(deviceId)\n            ]);\n        })\n    );\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  var unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Measurement Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Measurement Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteMeasurementToDeviceRelation(MeasurementId, deviceId) {\n    return entityRelationService.deleteRelation(MeasurementId, 'Measurement', deviceId);\n}\nfunction deleteVRDeviceToDeviceRelation(deviceVRId, deviceId) {\n    return entityRelationService.deleteRelation(deviceVRId, 'VR', deviceId);\n}\nfunction deleteAttributes(deviceId){\n    return attributeService.deleteEntityAttributes(deviceId,\"SERVER_SCOPE\",[{ key: \"measurement\" }, { key: \"project\" }]);\n}\nfunction getRelatedVRDevice(deviceId) {\n  return deviceService.getDevice(deviceId).pipe(\n    widgetContext.rxjs.switchMap(device => {\n      //console.log(\"device\", device);\n      let type = device.type;\n      let typeVR = (type !== \"RESI\" && type !== \"IoT Gateway\") ? type + \" VR\" : \"Gateway VR\";\n      //console.log(\"typeVR\", typeVR);\n      let query = {\n        \"parameters\": {\n          \"rootId\": deviceId,\n          \"rootType\": \"DEVICE\",\n          \"direction\": \"TO\",\n          \"relationTypeGroup\": \"COMMON\",\n          \"maxLevel\": 1073741824,\n          \"fetchLastLevelOnly\": false\n        },\n        \"relationType\": \"VR\",\n        \"deviceTypes\": [typeVR]\n      };\n      return deviceService.findByQuery(query);\n    })\n  );\n}\n\nfunction removePositionAttributes(deviceId) {\n    return attributeService.deleteEntityAttributes(deviceId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "09f01c72-16c1-8d80-accd-ce150e7ae0be"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.diagnostics.measurement-devices.go-back.title}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n/*params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten*/\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "fe464fca-d685-01a5-f49f-f6b68bfe1dec"
              },
              {
                "name": "{i18n:custom.diagnostics.measurement-devices.add-device.title}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<!-- HTML Template -->\r\n<form #addEntityForm=\"ngForm\" [formGroup]=\"addDeviceFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form mx-auto\" style=\"width: 800px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2>{{'custom.projects.measurements.assigned.devices.add-devices.add-device' | translate}}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  \r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <!-- Warning message displayed on top -->\r\n    <div *ngIf=\"warningMessage\" style=\"color: #d32f2f; font-size: 14px; margin-bottom: 10px; border: 1px solid #d32f2f; padding: 8px; border-radius: 4px;\">\r\n      {{ warningMessage }}\r\n    </div>\r\n    \r\n    <mat-horizontal-stepper formGroupName=\"stepper\" linear>\r\n      <mat-step formGroupName=\"assignmentStep\" label=\"Assignment\">\r\n        <ng-template matStepLabel>{{'custom.projects.measurements.assigned.devices.add-devices.assignment' | translate}}</ng-template>\r\n        <fieldset *ngIf=\"pFlowLimit || CO2Limit\" class=\"fieldset\" style=\"margin-bottom: 16px;\">\r\n          <div class=\"flex flex-col p-4 space-y-4\">\r\n            \r\n            <div class=\"flex w-full\">\r\n              <mat-icon *ngIf=\"pFlowLimit\" style=\"margin-right: 8px;\">info</mat-icon>\r\n              <p *ngIf=\"pFlowLimit\" style=\"font-size: 15px; margin: 0;\">\r\n                {{'custom.projects.measurements.assigned.devices.add-devices.limit-p-flows' | translate}}\r\n              </p>\r\n            </div>\r\n            <div class=\"flex w-full\">\r\n              <mat-icon *ngIf=\"CO2Limit\" style=\"margin-right: 8px;\">info</mat-icon>\r\n              <p *ngIf=\"CO2Limit\" style=\"font-size: 15px; margin: 0;\">\r\n                {{'custom.projects.measurements.assigned.devices.add-devices.limit-co2-sensors' | translate}}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </fieldset>\r\n\r\n        <!-- Device Input with Autocomplete and Filtering -->\r\n        <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n          <mat-label>{{'custom.projects.measurements.assigned.devices.add-devices.device' | translate}}</mat-label>\r\n          <input type=\"text\"\r\n                 matInput\r\n                 formControlName=\"device\"\r\n                 [matAutocomplete]=\"auto\"\r\n                 (keyup)=\"filterDevices()\"\r\n                 (focus)=\"resetFilter()\"\r\n                 required>\r\n          <mat-autocomplete #auto=\"matAutocomplete\" [displayWith]=\"displayDevice\">\r\n            <mat-option *ngFor=\"let device of filteredDevices\" [value]=\"device\">\r\n              <div class=\"device-item flex flex-col gap-1\">\r\n\r\n                <div class=\"flex flex-row\">\r\n\r\n                  <div>{{ device?.name }}</div>\r\n                </div>\r\n                <div class=\"flex flex-row justify-between items-center\">\r\n                  <div class=\"device-type\">{{ device?.type }}</div>\r\n                  <div class=\"device-label\">{{ device?.label }}</div>\r\n                </div>\r\n              </div>\r\n              <mat-divider></mat-divider>\r\n            </mat-option>\r\n          </mat-autocomplete>\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').hasError('required')\">\r\n            {{'custom.projects.measurements.assigned.devices.add-devices.device-required' | translate}}\r\n          </mat-error>\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').hasError('invalidDevice')\">\r\n            {{'custom.projects.measurements.assigned.devices.add-devices.select-valid-device' | translate}}\r\n          </mat-error>\r\n        </mat-form-field>\r\n\r\n        <!-- Label Input Field -->\r\n        <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n          <mat-label>{{'custom.projects.measurements.assigned.devices.add-devices.measurement-label' | translate}}</mat-label>\r\n          <input matInput formControlName=\"label\">\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.label').hasError('required')\">\r\n            {{'custom.projects.measurements.assigned.devices.add-devices.device-label-required' | translate}}\r\n          </mat-error>\r\n        </mat-form-field>\r\n        \r\n        <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n          <mat-label>{{'custom.projects.measurements.assigned.devices.add-devices.assigned-kit' | translate}}</mat-label>\r\n          <input matInput formControlName=\"kit\" disabled>\r\n        </mat-form-field>\r\n\r\n        <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n          <button mat-button color=\"primary\"\r\n                  type=\"button\"\r\n                  [disabled]=\"(isLoading$ | async)\"\r\n                  (click)=\"cancel()\" cdkFocusInitial>\r\n            {{'action.cancel' | translate}}\r\n          </button>\r\n          <button mat-button mat-raised-button color=\"primary\"\r\n                  type=\"submit\"\r\n                  [disabled]=\"(isLoading$ | async) || addDeviceFormGroup.invalid\">\r\n            {{'action.save' | translate}}\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*.mat-form-field input[disabled] {\n  background-color: #f5f5f5;\n  cursor: not-allowed; \n  color: #9e9e9e;\n  \n}*/",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet asignedDevicesVr;\r\nconst measurementId = widgetContext.stateController.getStateParams()?.selectedMeasurement?.entityId;\r\n\r\nif (!measurementId || !measurementId.id) {\r\n    console.error(\"Invalid measurementId:\", measurementId);\r\n} else {\r\n    checkAssignedDevices(measurementId.id);\r\n}\r\n\r\nfunction deleteVirtualDevice(deviceVR) {\r\n    // Assumes deviceVR.id.id is the proper identifier.\r\n    return deviceService.deleteDevice(deviceVR.id.id);\r\n}\r\n\r\nfunction getRelatedVRPflows(measurementId) {\r\n    // Adapted query to fetch multiple device types.\r\n    let query = {\r\n        \"parameters\": {\r\n            \"rootId\": measurementId,\r\n            \"rootType\": \"ASSET\",\r\n            \"direction\": \"FROM\",\r\n            \"relationTypeGroup\": \"COMMON\",\r\n            \"maxLevel\": 1073741824,\r\n            \"fetchLastLevelOnly\": false\r\n        },\r\n        \"relationType\": \"Measurement VR\",\r\n        \"deviceTypes\": [\"P-Flow D116 VR\", \"Room Sensor CO2 VR\", \"Gateway VR\", \"Temperature Sensor VR\"]\r\n    };\r\n    return deviceService.findByQuery(query);\r\n}\r\n\r\nfunction getRelatedKit(deviceId) {\r\n    let query = {\r\n        \"parameters\": {\r\n            \"rootId\": deviceId,\r\n            \"rootType\": \"DEVICE\",\r\n            \"direction\": \"TO\",\r\n            \"relationTypeGroup\": \"COMMON\",\r\n            \"maxLevel\": 1073741824,\r\n            \"fetchLastLevelOnly\": false\r\n        },\r\n        \"relationType\": \"Contains\",\r\n        \"assetTypes\": [\"Diagnostickit\"]\r\n    };\r\n    return assetService.findByQuery(query);\r\n}\r\n\r\n// Helper function to get kit subscription info.\r\nfunction getKitInfo(kitId) {\r\n    return attributeService.getEntityAttributes(kitId, 'SERVER_SCOPE', ['subscriptionStatus', 'validTo']);\r\n}\r\n\r\nfunction checkAssignedDevices(measurementId) {\r\n    const deviceSearchQuery = {\r\n        parameters: {\r\n            rootId: measurementId,\r\n            rootType: \"ASSET\",\r\n            direction: \"FROM\",\r\n            relationTypeGroup: \"COMMON\",\r\n            maxLevel: 100,\r\n            fetchLastLevelOnly: false,\r\n        },\r\n        relationType: \"Measurement\",\r\n        deviceTypes: [\"P-Flow D116\", \"Room Sensor CO2\", \"Temperature Sensor\", \"RESI\", \"IoT Gateway\"]\r\n    };\r\n\r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n        (devices) => {\r\n            getRelatedVRPflows(measurementId).subscribe(result => {\r\n                // Rename pFlowsVr to asignedDevicesVr.\r\n                asignedDevicesVr = result;\r\n                let maxLimitPFlows = false;\r\n                let maxLimitRoomSensorCO2 = false;\r\n                const pFlows = devices.filter(device => device.type === \"P-Flow D116\");\r\n                const roomSensorCO2 = devices.filter(device => device.type === \"Room Sensor CO2\");\r\n\r\n                if (pFlows.length > 0) {\r\n                    maxLimitPFlows = true;\r\n                }\r\n                if (roomSensorCO2.length > 99) {\r\n                    maxLimitRoomSensorCO2 = true;\r\n                }\r\n\r\n                openAddDeviceDialog(maxLimitPFlows, maxLimitRoomSensorCO2, asignedDevicesVr);\r\n            },\r\n            (error) => {\r\n                console.error(\"Error fetching devices:\", error);\r\n                openAddDeviceDialog(false, false, []);\r\n            });\r\n        }\r\n    );\r\n}\r\n\r\nfunction openAddDeviceDialog(maxLimitPFlows, maxLimitRoomSensorCO2, asignedDevicesVr) {\r\n    customDialog.customDialog(htmlTemplate, AddDeviceDialogController, {\r\n        measurementId,\r\n        maxLimitPFlows,\r\n        maxLimitRoomSensorCO2,\r\n        asignedDevicesVr\r\n    }).subscribe();\r\n}\r\n\r\nfunction AddDeviceDialogController(instance) {\r\n    let vm = instance;\r\n    const {\r\n        measurementId,\r\n        maxLimitPFlows,\r\n        maxLimitRoomSensorCO2,\r\n        asignedDevicesVr\r\n    } = vm.data || {};\r\n\r\n    vm.pFlowLimit = !!maxLimitPFlows;\r\n    vm.CO2Limit = !!maxLimitRoomSensorCO2;\r\n    vm.asignedDevicesVr = asignedDevicesVr; // Array of virtual devices\r\n\r\n    // This property will hold any warning message regarding kit expiry.\r\n    vm.warningMessage = null;\r\n\r\n    // Filtering/search variables\r\n    vm.availableDevices = [];\r\n    vm.filteredDevices = [];\r\n\r\n    // Device selection validator.\r\n    function deviceSelectionValidator(control) {\r\n       if (!control.value) { return null; }\r\n       return (typeof control.value === 'object' && control.value !== null)\r\n         ? null\r\n         : { invalidDevice: true };\r\n    }\r\n    \r\n    vm.addDeviceFormGroup = vm.fb.group({\r\n        stepper: vm.fb.group({\r\n            assignmentStep: vm.fb.group({\r\n                device: [null, [vm.validators.required, deviceSelectionValidator]],\r\n                label: [{ value: null, disabled: false }],\r\n                kit: [{ value: null, disabled: true }]\r\n            })\r\n        })\r\n    });\r\n\r\n    vm.displayDevice = function(device) {\r\n        return device ? `${device.name} (${device.type})` : '';\r\n    };\r\n\r\n    vm.filterDevices = function () {\r\n        const searchValue = vm.addDeviceFormGroup.get('stepper.assignmentStep.device').value;\r\n        const filterValue = (typeof searchValue === 'string' ? searchValue.toLowerCase() : '');\r\n        if (!filterValue) {\r\n            vm.filteredDevices = vm.availableDevices.slice();\r\n            return;\r\n        }\r\n        vm.filteredDevices = vm.availableDevices.filter(device =>\r\n            device.name.toLowerCase().includes(filterValue) || \r\n            device.label.toLowerCase().includes(filterValue) ||\r\n            device.type.toLowerCase().includes(filterValue)\r\n        );\r\n    };\r\n    \r\n    vm.resetFilter = function () {\r\n        vm.filteredDevices = vm.availableDevices.slice();\r\n    };\r\n\r\n    vm.addDeviceFormGroup.get('stepper.assignmentStep.device').valueChanges.subscribe(value => {\r\n        vm.warningMessage = null;\r\n        if (typeof value === 'string') {\r\n            vm.addDeviceFormGroup.get('stepper.assignmentStep.label').disable();\r\n            vm.addDeviceFormGroup.get('stepper.assignmentStep.kit').setValue(null);\r\n        } else if (value) {\r\n            vm.addDeviceFormGroup.get('stepper.assignmentStep.label').enable();\r\n            vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { label: value.label } } }, { emitEvent: false });\r\n            \r\n            let selectedDeviceId = value.deviceId.id;\r\n            let kitSearchQuery = {\r\n                parameters: {\r\n                    rootId: selectedDeviceId,\r\n                    rootType: 'DEVICE',\r\n                    direction: 'TO',\r\n                    relationTypeGroup: 'COMMON',\r\n                    maxLevel: 1073741824,\r\n                    fetchLastLevelOnly: false\r\n                },\r\n                relationType: 'Contains',\r\n                assetTypes: ['Diagnostickit']\r\n            };\r\n\r\n            assetService.findByQuery(kitSearchQuery).subscribe((kitData) => {\r\n                if (kitData && kitData.length > 0) {\r\n                    let kitName = kitData[0].name;\r\n                    vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { kit: kitName } } }, { emitEvent: false });\r\n                    let kitId = kitData[0].id;\r\n                    getKitInfo(kitId).subscribe(kitAttributes => {\r\n                        const subAttr = kitAttributes.find(attr => attr.key === 'subscriptionStatus');\r\n                        const validToAttr = kitAttributes.find(attr => attr.key === 'validTo');\r\n                        const status = subAttr ? subAttr.value.toLowerCase() : null;\r\n                        if ((status === 'canceled' || status === 'cancelled') && validToAttr) {\r\n                            let validToDate = new Date(validToAttr.value);\r\n                            let now = new Date();\r\n                            if (validToDate > now) {\r\n                                let diffDays = Math.ceil((validToDate - now) / (1000 * 3600 * 24));\r\n                                if (diffDays < 31) {\r\n                                    vm.warningMessage = `The diagnostic kit license for the selected device will expire in ${diffDays} days. Please refrain from assigning this device if the measurement duration exceeds this period to prevent potential data loss.`;\r\n                                }\r\n                            }\r\n                        }\r\n                    });\r\n                } else {\r\n                    vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { kit: '' } } }, { emitEvent: false });\r\n                }\r\n            }, (error) => {\r\n                console.error(\"Error fetching kit data:\", error);\r\n                vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { kit: '' } } }, { emitEvent: false });\r\n            });\r\n        }\r\n    });\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        // Retrieve selected device.\r\n        var device = vm.addDeviceFormGroup.value.stepper.assignmentStep.device;\r\n        if (!device) { return; }\r\n        // Compute measurementName and expected virtual device name.\r\n        var measurementName = widgetContext.stateController.getStateParams().selectedMeasurement.entityName;\r\n        var expectedVrName = measurementName + \"_\" + device.name;\r\n\r\n        // Check if a virtual device already exists with the expected name.\r\n        var existingVr = vm.asignedDevicesVr ? vm.asignedDevicesVr.find(vrDevice => vrDevice.name === expectedVrName) : null;\r\n\r\n        // If found, do not show confirm, just create relation from selected device to the existing VR device.\r\n        if (existingVr) {\r\n            saveAttributes(device.deviceId).subscribe();\r\n            createRelationToExistingVR(existingVr);\r\n            return;\r\n        }\r\n\r\n        // Otherwise, for P-Flow D116, check if any conflicting VR exists.\r\n        if (device.type === \"P-Flow D116\") {\r\n            var conflictingVr = vm.asignedDevicesVr ? vm.asignedDevicesVr.find(vrDevice => vrDevice.type === \"P-Flow D116 VR\") : null;\r\n            if (conflictingVr) {\r\n                // Show confirmation if a conflicting VR (of type \"P-Flow D116 VR\") exists.\r\n                let title = 'Confirm Removal of conflicting Data';\r\n                let content = 'A Device that conflicts with selected one was already assigned ones to this measurement. ' +\r\n                              'Would you like to remove the existing data related to old device and assign the new one? ' +\r\n                              'Please note that all Data regarding the old device will be removed from this Measurement and that this action is irreversible.';\r\n                widgetContext.dialogs.confirm(title, content, 'Cancel', 'Remove and Assign').subscribe(function(result) {\r\n                    if (result) {\r\n                        deleteVirtualDevice(conflictingVr).subscribe(() => {\r\n                            proceedWithSave();\r\n                        }, (error) => {\r\n                            console.error(\"Error deleting virtual device:\", error);\r\n                        });\r\n                    } else {\r\n                        return;\r\n                    }\r\n                });\r\n                return;\r\n            }\r\n        }\r\n        // For non-P-Flow devices or if no conflict exists, create a new VR device.\r\n        proceedWithSave();\r\n\r\n        function createRelationToExistingVR(existingVr) {\r\n            var measurementId = widgetContext.stateController.getStateParams().selectedMeasurement.entityId;\r\n            var customerId = widgetContext.stateController.getStateParams().entityId;\r\n            var deviceId = device.deviceId;\r\n            widgetContext.rxjs.forkJoin([\r\n                entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n                saveDeviceToMeasurementRelation(measurementId, deviceId),\r\n                saveDeviceVRToMeasurementRelation(measurementId, existingVr.id),\r\n                saveDeviceToVrDeviceRelation(existingVr.id, deviceId),\r\n                saveAttributes(existingVr.id)\r\n            ]).subscribe(() => {\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n            });\r\n        }\r\n\r\n        function proceedWithSave() {\r\n            var measurementId = widgetContext.stateController.getStateParams().selectedMeasurement.entityId;\r\n            var customerId = widgetContext.stateController.getStateParams().entityId;\r\n            var deviceId = device.deviceId;\r\n            var deviceNameVR = measurementName + \"_\" + device.name;\r\n            var deviceProfileVR = (device.type !== \"RESI\" && device.type !== \"IoT Gateway\") ? device.type + \" VR\" : \"Gateway VR\";\r\n            let deviceVR = {\r\n                name: deviceNameVR,\r\n                type: deviceProfileVR,\r\n                label: vm.addDeviceFormGroup.value.stepper.assignmentStep.label,\r\n                customerId: customerId,\r\n            };\r\n            deviceService.saveDevice(deviceVR).subscribe(savedDevice => {\r\n                widgetContext.rxjs.forkJoin([\r\n                    entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n                    saveDeviceToMeasurementRelation(measurementId, deviceId),\r\n                    saveDeviceVRToMeasurementRelation(measurementId, savedDevice.id),\r\n                    saveDeviceToVrDeviceRelation(savedDevice.id, deviceId),\r\n                    saveAttributes(savedDevice.id),\r\n                    saveAttributes(deviceId)\r\n                ]).subscribe(() => {\r\n                    widgetContext.updateAliases();\r\n                    vm.dialogRef.close(null);\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedDevicesGroup = null;\r\n        vm.assignedDevicesGroup = null;\r\n        vm.availableDevices = [];\r\n        vm.assignedDevices = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'DEVICE').subscribe((entityGroups) => {\r\n            vm.customerDevicesGroups = entityGroups;\r\n            vm.unassignedDevicesGroup = entityGroups.find(group => group.name === 'Unassigned Measurement Devices');\r\n            vm.assignedDevicesGroup = entityGroups.find(group => group.name === 'Measurement Devices');\r\n            const unassignedDiagnostickitGroup = entityGroups.find(group => group.name === 'Unassigned Diagnostickit Devices');\r\n\r\n            if (vm.unassignedDevicesGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.unassignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: { pageSize: 1000, page: 0 },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    vm.availableDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value,\r\n                            deviceId: entityData.entityId\r\n                        };\r\n                    });\r\n                    if (unassignedDiagnostickitGroup) {\r\n                        var kitQuery = {\r\n                            entityFilter: {\r\n                                type: 'entityGroup',\r\n                                groupType: 'DEVICE',\r\n                                entityGroup: unassignedDiagnostickitGroup.id.id\r\n                            },\r\n                            pageLink: { pageSize: 1000, page: 0 },\r\n                            entityFields: [{ key: 'name', type: 'ENTITY_FIELD' }]\r\n                        };\r\n                        entityService.findEntityDataByQuery(kitQuery).subscribe((kitData) => {\r\n                            const diagnostickitDeviceIds = kitData.data.map(entityData => entityData.entityId.id);\r\n                            vm.availableDevices = vm.availableDevices.filter(device => !diagnostickitDeviceIds.includes(device.deviceId.id));\r\n                            finalizeDevices();\r\n                        });\r\n                    } else {\r\n                        finalizeDevices();\r\n                    }\r\n                });\r\n            }\r\n            \r\n            function finalizeDevices() {\r\n                if (maxLimitPFlows === true) {\r\n                    vm.availableDevices = vm.availableDevices.filter(device => device.type !== \"P-Flow D116\");\r\n                }\r\n                if (maxLimitRoomSensorCO2 === true) {\r\n                    vm.availableDevices = vm.availableDevices.filter(device => device.type !== \"Room Sensor CO2\");\r\n                }\r\n                vm.availableDevices.sort(function (a, b) {\r\n                    const hexPattern = /^ECO_([0-9A-Fa-f]{8})/;\r\n                    const matchA = a.name.match(hexPattern);\r\n                    const matchB = b.name.match(hexPattern);\r\n                    if (matchA && matchB) {\r\n                        const numA = parseInt(matchA[1], 16);\r\n                        const numB = parseInt(matchB[1], 16);\r\n                        return numA - numB;\r\n                    } else {\r\n                        return a.name.localeCompare(b.name);\r\n                    }\r\n                });\r\n                \r\n                const filteredDevicesObservables = vm.availableDevices.map(device => {\r\n                    return getRelatedKit(device.deviceId.id).pipe(\r\n                        widgetContext.rxjs.switchMap(kitData => {\r\n                            if (kitData && kitData.length > 0) {\r\n                                const kitId = kitData[0].id;\r\n                                return getKitInfo(kitId).pipe(\r\n                                    widgetContext.rxjs.map(kitAttributes => {\r\n                                        const subAttr = kitAttributes.find(attr => attr.key === 'subscriptionStatus');\r\n                                        const validToAttr = kitAttributes.find(attr => attr.key === 'validTo');\r\n                                        const status = subAttr ? subAttr.value.toLowerCase() : null;\r\n                                        if ((status === 'canceled' || status === 'cancelled')) {\r\n                                            if (validToAttr) {\r\n                                                let validToDate = new Date(validToAttr.value);\r\n                                                let now = new Date();\r\n                                                if (validToDate > now) { return device; }\r\n                                            }\r\n                                            return null;\r\n                                        } else if (status === 'no subscription' || status === 'inactive') { // Anpassen!\r\n                                            return device;\r\n                                        } else {\r\n                                            return device;\r\n                                        }\r\n                                    })\r\n                                );\r\n                            } else {\r\n                                return widgetContext.rxjs.of(device);\r\n                            }\r\n                        })\r\n                    );\r\n                });\r\n                \r\n                widgetContext.rxjs.forkJoin(filteredDevicesObservables).subscribe(results => {\r\n                    vm.availableDevices = results.filter(device => device !== null);\r\n                    filterDevicesByMeasurementType(measurementId);\r\n                    vm.filteredDevices = vm.availableDevices.slice();\r\n                });\r\n            }\r\n\r\n            if (vm.assignedDevicesGroup) {\r\n                var query2 = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.assignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: { pageSize: 100, page: 0 },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query2).subscribe((data) => {\r\n                    vm.assignedDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            deviceId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                    if (additionalParams && (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Device\")) {\r\n                        checkAdditionalParams();\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n    \r\n    function filterDevicesByMeasurementType(measurementId) {\r\n        attributeService.getEntityAttributes(measurementId, 'SERVER_SCOPE').subscribe(\r\n            (attributes) => {\r\n                const measurementTypeAttr = attributes.find(attr => attr.key === 'measurementType');\r\n                if (!measurementTypeAttr) {\r\n                    console.warn(\"Measurement type attribute not found; no filtering applied.\");\r\n                    return;\r\n                }\r\n                const measurementType = measurementTypeAttr.value;\r\n                if (measurementType === 'ultrasonic') {\r\n                    vm.availableDevices = vm.availableDevices.filter(device =>\r\n                        ['P-Flow D116', 'Temperature Sensor', 'RESI'].includes(device.type)\r\n                    );\r\n                } else if (measurementType === 'loraWan') {\r\n                    vm.availableDevices = vm.availableDevices.filter(device =>\r\n                        device.type === 'Room Sensor CO2'\r\n                    );\r\n                }\r\n                vm.filteredDevices = vm.availableDevices.slice();\r\n            },\r\n            (error) => {\r\n                console.error(\"Error fetching measurement attributes:\", error);\r\n            }\r\n        );\r\n    }\r\n\r\n    function saveAttributes(deviceId) {\r\n        const attributesArray = [\r\n            { key: \"xPos\", value: \"0\" },\r\n            { key: \"yPos\", value: \"0\" },\r\n            { key: \"measurement\", value: widgetContext.stateController.getStateParams()?.selectedMeasurement?.entityName },\r\n            { key: \"project\", value: widgetContext.stateController.getStateParams()?.selectedProject?.entityName}\r\n        ];\r\n        return attributeService.saveEntityAttributes(deviceId, 'SERVER_SCOPE', attributesArray);\r\n    }\r\n\r\n    function saveDeviceToMeasurementRelation(measurementId, deviceId) {\r\n        var relation = { from: measurementId, to: deviceId, typeGroup: 'COMMON', type: 'Measurement' };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n    function saveDeviceVRToMeasurementRelation(measurementId, deviceVRId) {\r\n        var relation = { from: measurementId, to: deviceVRId, typeGroup: 'COMMON', type: 'Measurement VR' };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n    function saveDeviceToVrDeviceRelation(deviceVRId, deviceId) {\r\n        var relation = { from: deviceVRId, to: deviceId, typeGroup: 'COMMON', type: 'VR' };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function updateDeviceLabel(device, label) {\r\n        if (device.label !== label) {\r\n            return deviceService.getDevice(device.deviceId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origDevice) => {\r\n                    origDevice.label = label;\r\n                    return deviceService.saveDevice(origDevice);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableDevice = vm.availableDevices.find(device => device.name === additionalParams.code);\r\n        const matchingAssignedDevice = vm.assignedDevices.find(device => device.name === additionalParams.code);\r\n        if (!matchingAvailableDevice && !matchingAssignedDevice) {\r\n            widgetContext.dialogs.alert(\"Device doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedDevice && !matchingAvailableDevice) {\r\n            getMeasurement(additionalParams.code);\r\n        }\r\n        if (matchingAvailableDevice && matchingAssignedDevice) {\r\n            vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { device: matchingAvailableDevice } } }, { emitEvent: false });\r\n            vm.addDeviceFormGroup.get('stepper.assignmentStep.device').markAsDirty();\r\n            vm.addDeviceFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('input[formControlName=\"device\"]');\r\n                if (selectElement) { selectElement.dispatchEvent(new Event('input')); }\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n\r\n    function getMeasurement(code) {\r\n        vm.deviceEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToMeasurement = null;\r\n        deviceService.findByName(code)\r\n            .pipe(widgetContext.rxjs.map((origDevice) => {\r\n                    vm.deviceEntityId = origDevice.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.deviceEntityId, 'entityType': 'DEVICE' })\r\n                    .pipe(widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations)\r\n                        .pipe(widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToMeasurement = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-device\");\r\n                        let params = {\r\n                            \"measurement\": vm.assignedToMeasurement,\r\n                            \"device\": vm.deviceEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "628f2502-26dd-276f-8193-a0467dcdc695"
              },
              {
                "name": "Add Device with QR",
                "icon": "qr_code_scanner",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "scanQrCode",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Scan QR code action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to scan QR code', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processQrCodeFunction": "// Function body to process result of QR code scanning. \n// - code - scanned QR code\n// - format - scanned QR code format\n//widgetContext.actionsApi.qrCodeCallback(code);\nlet $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\nlet qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"add-device\");\n\nlet params = {\n    source: \"qrcode\",\n    code: code\n}\ntry {\n    widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\n} catch (error) {\n    widgetContext.dialogs.alert('Error handling widget action:', error);\n}\n\n//showQrCodeDialog(\"Code\", code, format);\nfunction showQrCodeDialog(title, code, format) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Code: ['+code+']<br>Format: ' + format).subscribe();\n    }, 100);\n}\n\n"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "822d20eb-76b0-1464-e924-07f3abc70722"
              }
            ]
          },
          "showTitleIcon": false,
          "titleIcon": "list",
          "iconColor": null,
          "titleFont": null,
          "titleColor": null,
          "enableDataExport": false,
          "desktopHide": true,
          "titleTooltip": "",
          "widgetStyle": {},
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": ""
        },
        "row": 0,
        "col": 0,
        "id": "150eb2dc-f5f1-9ade-8ba7-b3246a205ec0"
      },
      "c12ec825-a7ef-cc4d-da3d-064fba7cc7d7": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1694019264779,
                "endTimeMs": 1694105664779
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Users",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "email",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Users",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "fbfce281-668f-0ad0-d8f4-6870d3ef679f",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "Email",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5669544029828533
                },
                {
                  "name": "firstName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.first-name}",
                  "color": "#4caf50",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.835575628975763,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.last-name}",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7276117794959098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [],
            "actionCellButton": [
              {
                "name": "{i18n:custom.user-management.edit-user}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editUserFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.user-management.edit-smart-retail-user' | translate }}</h2>\n     <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('required')\">\n            {{ 'custom.user-management.email-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('pattern')\">\n            {{ 'custom.user-management.invalid-value-format' | translate }}\n        </mat-error>\n    </mat-form-field>\n    <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.first-name' | translate }}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.last-name' | translate }}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editUserFormGroup.invalid || !editUserFormGroup.dirty\">\n      {{ 'custom.user-management.save-user' | translate }}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\n\nopenEditUserDialog();\n\nfunction openEditUserDialog() {\n  customDialog.customDialog(htmlTemplate, EditUserDialogController).subscribe();\n}\n\nfunction EditUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.user = {};\n  \n  vm.editUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null]\n  });\n  \n  getUser();\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    vm.editUserFormGroup.markAsPristine();\n    saveUserObservable().subscribe(\n      function () {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      }\n    );\n  };\n  \n  function getUser() {\n      userService.getUser(entityId.id).subscribe(\n          (user) => {\n                vm.user = user;          \n                vm.editUserFormGroup.patchValue({\n                  email: vm.user.email,\n                  firstName: vm.user.firstName,\n                  lastName: vm.user.lastName\n                }, {emitEvent: false});\n          }\n    );\n  }\n  \n  function saveUserObservable() {\n      const formValues = vm.editUserFormGroup.value;\n      vm.user.email = formValues.email;\n      vm.user.firstName = formValues.firstName;\n      vm.user.lastName = formValues.lastName;\n      return userService.saveUser(vm.user);\n  }\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.user-management.delete-user}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteUserDialog();\n\nfunction openDeleteUserDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.user-management.delete.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.user-management.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteUser();\n    }\n  });\n}\n\n\nfunction deleteUser() {\n  userService.deleteUser(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.user-management.add-user}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addUserFormGroup\"\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.user-management.add-smart-retail-user' | translate }}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n            {{ 'custom.user-management.email-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n            {{ 'custom.user-management.invalid-value-format' | translate }}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.first-name' | translate }}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.last-name' | translate }}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>{{ 'custom.user-management.activation-method' | translate }}</mat-label>\n        <mat-select formControlName=\"userActivationMethod\">\n            <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n                {{ method.name }}\n            </mat-option>\n        </mat-select>\n    </mat-form-field>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      {{ 'custom.user-management.add-user' | translate }}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.activationMethods = [\n        {\n            value: 'displayActivationLink',\n            name: translationService.instant('custom.user-management.display-activation-link')\n        },\n        {\n            value: 'sendActivationMail',\n            name: translationService.instant('custom.user-management.send-activation-email')\n        }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    userActivationMethod: ['displayActivationLink']\n  });\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    var customerId;\n/*    var authority = widgetContext.currentUser.authority;\n    var stateParams = widgetContext.stateController.getStateParams();*/\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n    vm.addUserFormGroup.markAsPristine();\n/*    console.log(\"Customer ID: \" + customerId);\n    console.log(\"Authority: \" + authority);\n    console.log(\"State Params: \" + JSON.stringify(stateParams));*/\n    \n    const formValues = vm.addUserFormGroup.value;\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n    const sendActivationMail = (formValues.userActivationMethod === 'sendActivationMail');\n    \n    widgetContext.rxjs.forkJoin([\n        getTargetUserGroup(customerId), \n        getDashboardByName('Smart Diagnostics')\n    ]).pipe(\n        widgetContext.rxjs.switchMap((data) => {\n            var userGroup = data[0];\n            var defaultDashboard = data[1];\n            /*console.log(defaultDashboard);*/\n            if (defaultDashboard) {\n                user.additionalInfo = {\n                    defaultDashboardId: defaultDashboard.id.id,\n                    defaultDashboardFullscreen: true\n                };\n            }\n            /*console.log(\"user\", user);*/\n            return saveUserObservable(userGroup, user, sendActivationMail);\n        }),\n        // Added switchMap to save the 'role' attribute after the user is saved\n        widgetContext.rxjs.switchMap((savedUser) => {\n            // Define the attribute to be saved\n            const roleAttribute = {\n                key: 'role',\n                value: 'Belimo Retrofit Users'\n            };\n            \n            // Call the attributeService to save the attribute\n            return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n                // Pass the savedUser to the next operator\n                widgetContext.rxjs.map(() => savedUser)\n            );\n        })\n    ).subscribe((user) => {\n        widgetContext.updateAliases();\n        if (formValues.userActivationMethod === 'displayActivationLink') {\n            userService.getActivationLink(user.id.id).subscribe(\n                (activationLink) => {\n                    displayActivationLink(activationLink).subscribe(\n                        () => {\n                            vm.dialogRef.close(null);\n                        }\n                    );\n                }\n            );\n        } else {\n            vm.dialogRef.close(null);\n        }\n    });\n  };\n  \n  function saveUserObservable(userGroup, user, sendActivationMail) {\n      return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n  \n  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Users', customerId);\n          })\n      );\n  }\n  \n/*  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerAndType(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Users', customerId);\n          })\n      );\n  }*/\n  \n  function getOrCreateUserGroup(groups, groupName, customerId) {\n      var usersGroup = groups.find(group => group.name === groupName);\n      if (usersGroup) {\n          return widgetContext.rxjs.of(usersGroup);\n      } else {\n          usersGroup = {\n              type: 'USER',\n              name: groupName,\n              ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(usersGroup);\n      }\n  }\n  \n  function getDashboardByName(dashboardName) {\n      var dashboardsPageLink = widgetContext.pageLink(100, 0, dashboardName);\n      return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n          widgetContext.rxjs.map((data) => {\n            if (data.data.length) {\n                return data.data.find((dashboard) => dashboard.name === dashboardName);\n            } else {\n                return null;\n            }\n          })\n      );\n  }\n  \n    function displayActivationLink(activationLink) {\n        const template = '<form style=\"min-width: 400px;\">\\n' +\n            '  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\\n' +\n            '    <h2 translate>user.activation-link</h2>\\n' +\n            '        <span class=\"flex-1\"></span>\\n' +\n            '    <button mat-icon-button\\n' +\n            '            (click)=\"close()\"\\n' +\n            '            type=\"button\">\\n' +\n            '      <mat-icon class=\"material-icons\">close</mat-icon>\\n' +\n            '    </button>\\n' +\n            '  </mat-toolbar>\\n' +\n            '  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\\n' +\n            '  </mat-progress-bar>\\n' +\n            '  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\\n' +\n            '  <div mat-dialog-content tb-toast toastTarget=\"activationLinkDialogContent\">\\n' +\n            '    <div class=\"flex flex-col gap-0 sm:gap-2\">\\n' +\n            '      <span [innerHTML]=\"\\'user.activation-link-text\\' | translate: {activationLink: activationLink}\"></span>\\n' +\n            '      <div class=\"flex justify-center items-center\">\\n' +\n            '        <pre class=\"tb-highlight\" class=\"flex\"><code>{{ activationLink }}</code></pre>\\n' +\n            '        <button mat-icon-button\\n' +\n            '                color=\"primary\"\\n' +\n            '                ngxClipboard\\n' +\n            '                cbContent=\"{{ activationLink }}\"\\n' +\n            '                (cbOnSuccess)=\"onActivationLinkCopied()\"\\n' +\n            '                matTooltip=\"{{ \\'user.copy-activation-link\\' | translate }}\"\\n' +\n            '                matTooltipPosition=\"above\">\\n' +\n            '          <mat-icon svgIcon=\"mdi:clipboard-arrow-left\"></mat-icon>\\n' +\n            '        </button>\\n' +\n            '      </div>\\n' +\n            '    </div>\\n' +\n            '  </div>\\n' +\n            '  <div mat-dialog-actions class=\"flex justify-end gap-2\">\\n' +\n            '    <button mat-button color=\"primary\"\\n' +\n            '            type=\"button\"\\n' +\n            '            cdkFocusInitial\\n' +\n            '            [disabled]=\"(isLoading$ | async)\"\\n' +\n            '            (click)=\"close()\">\\n' +\n            '      {{ \\'action.ok\\' | translate }}\\n' +\n            '    </button>\\n' +\n            '  </div>\\n' +\n            '</form>';\n        return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink});\n    }\n\n    function ActivationLinkDialogController(instance) {\n        var vm = instance;\n\n        vm.activationLink = instance.data.activationLink;\n\n        vm.onActivationLinkCopied = onActivationLinkCopied;\n        vm.close = close;\n\n        function onActivationLinkCopied(){\n            widgetContext.showSuccessToast(translate.instant('user.activation-link-copied-message'), 1000, 'bottom', 'left', 'activationLinkDialogContent');\n        }\n\n        function close() {\n            vm.dialogRef.close(null);\n        }\n    }\n  \n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "c12ec825-a7ef-cc4d-da3d-064fba7cc7d7",
        "typeFullFqn": "system.cards.entities_table"
      },
      "b687c65c-76de-dd49-b3b9-51eacf22114c": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1694019264779,
                "endTimeMs": 1694105664779
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Administrators",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "email",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Administrators",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "1cab31a1-6ad5-e39d-7798-e0dfee1cd61c",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "Email",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5669544029828533
                },
                {
                  "name": "firstName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.first-name}",
                  "color": "#4caf50",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.835575628975763,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.last-name}",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7276117794959098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [],
            "actionCellButton": [
              {
                "name": "{i18n:custom.user-management.edit-user}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editUserFormGroup\"\n      (ngSubmit)=\"save()\"  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n     <h2 class=\"text-lg font-semibold\">{{'custom.user-management.edit-smart-retail-administrator' | translate}}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('required')\">\n            {{'custom.user-management.email-is-required' | translate}}\n        </mat-error>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('pattern')\">\n            {{'custom.user-management.invalid-value-format' | translate}}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.first-name' | translate}}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.last-name' | translate}}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{'action.cancel' | translate}}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editUserFormGroup.invalid || !editUserFormGroup.dirty\">\n      {{'custom.user-management.save-user' | translate}}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\n\nopenEditUserDialog();\n\nfunction openEditUserDialog() {\n  customDialog.customDialog(htmlTemplate, EditUserDialogController).subscribe();\n}\n\nfunction EditUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.user = {};\n  \n  vm.editUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null]\n  });\n  \n  getUser();\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    vm.editUserFormGroup.markAsPristine();\n    saveUserObservable().subscribe(\n      function () {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      }\n    );\n  };\n  \n  function getUser() {\n      userService.getUser(entityId.id).subscribe(\n          (user) => {\n                vm.user = user;          \n                vm.editUserFormGroup.patchValue({\n                  email: vm.user.email,\n                  firstName: vm.user.firstName,\n                  lastName: vm.user.lastName\n                }, {emitEvent: false});\n          }\n    );\n  }\n  \n  function saveUserObservable() {\n      const formValues = vm.editUserFormGroup.value;\n      vm.user.email = formValues.email;\n      vm.user.firstName = formValues.firstName;\n      vm.user.lastName = formValues.lastName;\n      return userService.saveUser(vm.user);\n  }\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.user-management.delete-user}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteUserDialog();\n\nfunction openDeleteUserDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.user-management.delete.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.user-management.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteUser();\n    }\n  });\n}\n\nfunction deleteUser() {\n  userService.deleteUser(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.user-management.add-administrator}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addUserFormGroup\"\n      (ngSubmit)=\"save()\"  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.user-management.add-smart-retail-administrator' | translate }}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n            {{ 'custom.user-management.email-is-required' | translate }}\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n            {{ 'custom.user-management.invalid-value-format' | translate }}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.first-name' | translate }}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{ 'custom.user-management.last-name' | translate }}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>{{ 'custom.user-management.activation-method' | translate }}</mat-label>\n        <mat-select formControlName=\"userActivationMethod\">\n            <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n                {{ method.name }}\n            </mat-option>\n        </mat-select>\n    </mat-form-field>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{ 'action.cancel' | translate }}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      {{ 'custom.user-management.add-user' | translate }}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.activationMethods = [\n        {\n            value: 'displayActivationLink',\n            name: translationService.instant('custom.user-management.display-activation-link')\n        },\n        {\n            value: 'sendActivationMail',\n            name: translationService.instant('custom.user-management.send-activation-email')\n        }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    userActivationMethod: ['displayActivationLink']\n  });\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    var customerId;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n    vm.addUserFormGroup.markAsPristine();\n    \n    const formValues = vm.addUserFormGroup.value;\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n    const sendActivationMail = (formValues.userActivationMethod === 'sendActivationMail');\n    \n    widgetContext.rxjs.forkJoin([\n        getTargetUserGroup(customerId), \n        getDashboardByName('Smart Diagnostic Administration')\n    ]).pipe(\n        widgetContext.rxjs.switchMap((data) => {\n            /*console.log(data[1]);*/\n            var userGroup = data[0];\n            var defaultDashboard = data[1];\n            if (defaultDashboard) {\n                user.additionalInfo = {\n                    defaultDashboardId: defaultDashboard.id.id,\n                    defaultDashboardFullscreen: true\n                };\n            }\n            /*console.log(\"user\", user);*/\n            return saveUserObservable(userGroup, user, sendActivationMail);\n        }),\n        // Added switchMap to save the 'role' attribute after the user is saved\n        widgetContext.rxjs.switchMap((savedUser) => {\n            // Define the attribute to be saved\n            const roleAttribute = {\n                key: 'role',\n                value: 'Belimo Retrofit Administrators'\n            };\n            \n            // Call the attributeService to save the attribute\n            return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n                // Pass the savedUser to the next operator\n                widgetContext.rxjs.map(() => savedUser)\n            );\n        })\n    ).subscribe((user) => {\n        widgetContext.updateAliases();\n        if (formValues.userActivationMethod === 'displayActivationLink') {\n            userService.getActivationLink(user.id.id).subscribe(\n                (activationLink) => {\n                    displayActivationLink(activationLink).subscribe(\n                        () => {\n                            vm.dialogRef.close(null);\n                        }\n                    );\n                }\n            );\n        } else {\n            vm.dialogRef.close(null);\n        }\n    });\n  };\n  \n  function saveUserObservable(userGroup, user, sendActivationMail) {\n      return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n  \n  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Administrators', customerId);\n          })\n      );\n  }\n  \n  function getOrCreateUserGroup(groups, groupName, customerId) {\n      var usersGroup = groups.find(group => group.name === groupName);\n      if (usersGroup) {\n          return widgetContext.rxjs.of(usersGroup);\n      } else {\n          usersGroup = {\n              type: 'USER',\n              name: groupName,\n              ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(usersGroup);\n      }\n  }\n  \n  function getDashboardByName(dashboardName) {\n      var dashboardsPageLink = widgetContext.pageLink(10, 0, dashboardName);\n      return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n          widgetContext.rxjs.map((data) => {\n            if (data.data.length) {\n                return data.data.find((dashboard) => dashboard.name === dashboardName);\n            } else {\n                return null;\n            }\n          })\n      );\n  }\n  \n    function displayActivationLink(activationLink) {\n        const template = '<form style=\"min-width: 400px;\">\\n' +\n            '  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\\n' +\n            '    <h2 translate>user.activation-link</h2>\\n' +\n            '        <span class=\"flex-1\"></span>\\n' +\n            '    <button mat-icon-button\\n' +\n            '            (click)=\"close()\"\\n' +\n            '            type=\"button\">\\n' +\n            '      <mat-icon class=\"material-icons\">close</mat-icon>\\n' +\n            '    </button>\\n' +\n            '  </mat-toolbar>\\n' +\n            '  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\\n' +\n            '  </mat-progress-bar>\\n' +\n            '  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\\n' +\n            '  <div mat-dialog-content tb-toast toastTarget=\"activationLinkDialogContent\">\\n' +\n            '    <div class=\"flex flex-col gap-0 sm:gap-2\">\\n' +\n            '      <span [innerHTML]=\"\\'user.activation-link-text\\' | translate: {activationLink: activationLink}\"></span>\\n' +\n            '      <div class=\"flex justify-center items-center\">\\n' +\n            '        <pre class=\"tb-highlight\" class=\"flex\"><code>{{ activationLink }}</code></pre>\\n' +\n            '        <button mat-icon-button\\n' +\n            '                color=\"primary\"\\n' +\n            '                ngxClipboard\\n' +\n            '                cbContent=\"{{ activationLink }}\"\\n' +\n            '                (cbOnSuccess)=\"onActivationLinkCopied()\"\\n' +\n            '                matTooltip=\"{{ \\'user.copy-activation-link\\' | translate }}\"\\n' +\n            '                matTooltipPosition=\"above\">\\n' +\n            '          <mat-icon svgIcon=\"mdi:clipboard-arrow-left\"></mat-icon>\\n' +\n            '        </button>\\n' +\n            '      </div>\\n' +\n            '    </div>\\n' +\n            '  </div>\\n' +\n            '  <div mat-dialog-actions class=\"flex justify-end gap-2\">\\n' +\n            '    <button mat-button color=\"primary\"\\n' +\n            '            type=\"button\"\\n' +\n            '            cdkFocusInitial\\n' +\n            '            [disabled]=\"(isLoading$ | async)\"\\n' +\n            '            (click)=\"close()\">\\n' +\n            '      {{ \\'action.ok\\' | translate }}\\n' +\n            '    </button>\\n' +\n            '  </div>\\n' +\n            '</form>';\n        return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink});\n    }\n\n    function ActivationLinkDialogController(instance) {\n        var vm = instance;\n\n        vm.activationLink = instance.data.activationLink;\n\n        vm.onActivationLinkCopied = onActivationLinkCopied;\n        vm.close = close;\n\n        function onActivationLinkCopied(){\n            widgetContext.showSuccessToast(translate.instant('user.activation-link-copied-message'), 1000, 'bottom', 'left', 'activationLinkDialogContent');\n        }\n\n        function close() {\n            vm.dialogRef.close(null);\n        }\n    }\n  \n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "b687c65c-76de-dd49-b3b9-51eacf22114c",
        "typeFullFqn": "system.cards.entities_table"
      },
      "6ec365fc-fe7f-18c5-0bfe-72fa77050c10": {
        "typeFullFqn": "system.action_button",
        "type": "latest",
        "sizeX": 3,
        "sizeY": 1,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1727860640000,
                "endTimeMs": 1727947040000
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": false,
          "backgroundColor": "#FFFFFF01",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "activatedState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "disabledState": {
              "action": "DO_NOTHING",
              "defaultValue": false,
              "getAttribute": {
                "key": "state",
                "scope": null
              },
              "getTimeSeries": {
                "key": "state"
              },
              "dataToValue": {
                "type": "NONE",
                "compareToValue": true,
                "dataToValueFunction": "/* Should return boolean value */\nreturn data;"
              }
            },
            "appearance": {
              "type": "filled",
              "showLabel": true,
              "label": "Manage Reports",
              "showIcon": true,
              "icon": "mdi:file-chart",
              "iconSize": 24,
              "iconSizeUnit": "px",
              "mainColor": "#435B63",
              "backgroundColor": "#FFFFFF",
              "autoScale": true,
              "customStyle": {
                "enabled": null,
                "hovered": null,
                "pressed": null,
                "activated": null,
                "disabled": null
              }
            }
          },
          "title": "Action button",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "borderRadius": "4px",
          "configMode": "basic",
          "actions": {
            "click": [
              {
                "id": "bb7463c6-ee9e-d30e-5bed-101118692f2b",
                "name": "onClick",
                "icon": "more_horiz",
                "type": "openURL",
                "targetDashboardStateId": "payments",
                "setEntityId": true,
                "stateEntityParamName": null,
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "openNewBrowserTab": true,
                "url": "https://www.ecoenergygroup.com/"
              }
            ]
          }
        },
        "row": 0,
        "col": 0,
        "id": "6ec365fc-fe7f-18c5-0bfe-72fa77050c10"
      },
      "8a5a3b08-5990-7d43-feca-892f176bff4c": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1694019264779,
                "endTimeMs": 1694105664779
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "Engineer",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": false,
            "entityNameColumnTitle": "Name",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "defaultSortOrder": "email",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Engineers",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "4128d7f0-9e28-5c7d-cf9a-b43cfe893568",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "email",
                  "type": "entityField",
                  "label": "Email",
                  "color": "#2196f3",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.5669544029828533
                },
                {
                  "name": "firstName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.first-name}",
                  "color": "#4caf50",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.835575628975763,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "lastName",
                  "type": "entityField",
                  "label": "{i18n:custom.user-management.last-name}",
                  "color": "#f44336",
                  "settings": {
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7276117794959098,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [],
            "actionCellButton": [
              {
                "name": "{i18n:custom.user-management.edit-user}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"editUserFormGroup\"\n      (ngSubmit)=\"save()\"   class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{'custom.user-management.edit-smart-retail-engineer' | translate}}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('required')\">\n            {{'custom.user-management.email-is-required' | translate}}\n        </mat-error>\n        <mat-error *ngIf=\"editUserFormGroup.get('email').hasError('pattern')\">\n            {{'custom.user-management.invalid-value-format' | translate}}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.first-name' | translate}}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.last-name' | translate}}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{'action.cancel' | translate}}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || editUserFormGroup.invalid || !editUserFormGroup.dirty\">\n      {{'custom.user-management.save-user' | translate}}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\n\nopenEditUserDialog();\n\nfunction openEditUserDialog() {\n  customDialog.customDialog(htmlTemplate, EditUserDialogController).subscribe();\n}\n\nfunction EditUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.user = {};\n  \n  vm.editUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null]\n  });\n  \n  getUser();\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    vm.editUserFormGroup.markAsPristine();\n    saveUserObservable().subscribe(\n      function () {\n        widgetContext.updateAliases();\n        vm.dialogRef.close(null);\n      }\n    );\n  };\n  \n  function getUser() {\n      userService.getUser(entityId.id).subscribe(\n          (user) => {\n                vm.user = user;          \n                vm.editUserFormGroup.patchValue({\n                  email: vm.user.email,\n                  firstName: vm.user.firstName,\n                  lastName: vm.user.lastName\n                }, {emitEvent: false});\n          }\n    );\n  }\n  \n  function saveUserObservable() {\n      const formValues = vm.editUserFormGroup.value;\n      vm.user.email = formValues.email;\n      vm.user.firstName = formValues.firstName;\n      vm.user.lastName = formValues.lastName;\n      return userService.saveUser(vm.user);\n  }\n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "449af9be-1767-a18a-2e1b-cfba5b6ee674"
              },
              {
                "name": "{i18n:custom.user-management.delete-user}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenDeleteUserDialog();\n\nfunction openDeleteUserDialog() {\n  const titleTranslation = translationService.instant(\n    'custom.user-management.delete.title',\n    { entityName: entityName }\n  );\n\n  const contentTranslation = translationService.instant(\n    'custom.user-management.delete.content'\n  );\n\n  dialogs.confirm(\n    titleTranslation,\n    contentTranslation,\n    translationService.instant('action.cancel'),\n    translationService.instant('action.delete')\n  ).subscribe(function(result) {\n    if (result) {\n      deleteUser();\n    }\n  });\n}\n\nfunction deleteUser() {\n  userService.deleteUser(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "b8747e47-5bc7-db5a-8f81-816c24eec09a"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.user-management.add-engineer}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addUserFormGroup\"\n      (ngSubmit)=\"save()\"   class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 600px;\">\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\n    <h2 class=\"text-lg font-semibold\">{{'custom.user-management.add-smart-retail-engineer' | translate}}</h2>\n    <span class=\"flex-1\"></span>\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\n      <mat-icon class=\"material-icons\">close</mat-icon>\n    </button>\n  </mat-toolbar>\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\n  </mat-progress-bar>\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>Email</mat-label>\n        <input matInput formControlName=\"email\" type=\"email\" required>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('required')\">\n            {{'custom.user-management.email-is-required' | translate}}\n        </mat-error>\n        <mat-error *ngIf=\"addUserFormGroup.get('email').hasError('pattern')\">\n            {{'custom.user-management.invalid-value-format' | translate}}\n        </mat-error>\n    </mat-form-field>\n     <div class=\"flex w-full gap-2\">\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.first-name' | translate}}</mat-label>\n            <input matInput formControlName=\"firstName\">\n        </mat-form-field>\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\n            <mat-label>{{'custom.user-management.last-name' | translate}}</mat-label>\n            <input matInput formControlName=\"lastName\" >\n        </mat-form-field>\n    </div>\n    <mat-form-field appearance=\"fill\" class=\"flex-1\">\n        <mat-label>{{'custom.user-management.activation-method' | translate}}</mat-label>\n        <mat-select formControlName=\"userActivationMethod\">\n            <mat-option *ngFor=\"let method of activationMethods\" [value]=\"method.value\">\n                {{ method.name }}\n            </mat-option>\n        </mat-select>\n    </mat-form-field>\n  </div>\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\n    <button mat-button color=\"primary\"\n            type=\"button\"\n            [disabled]=\"(isLoading$ | async)\"\n            (click)=\"cancel()\" cdkFocusInitial>\n      {{'action.cancel' | translate}}\n    </button>\n    <button mat-button mat-raised-button color=\"primary\"\n            type=\"submit\"\n            [disabled]=\"(isLoading$ | async) || addUserFormGroup.invalid || !addUserFormGroup.dirty\">\n      {{'custom.user-management.save-user' | translate}}\n    </button>\n  </div>\n</form>\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\n\nopenAddUserDialog();\n\nfunction openAddUserDialog() {\n  customDialog.customDialog(htmlTemplate, AddUserDialogController).subscribe();\n}\n\nfunction AddUserDialogController(instance) {\n  let vm = instance;\n  \n  vm.activationMethods = [\n        {\n            value: 'displayActivationLink',\n            name: translationService.instant('custom.user-management.display-activation-link')\n        },\n        {\n            value: 'sendActivationMail',\n            name: translationService.instant('custom.user-management.send-activation-email')\n        }\n  ];\n\n  vm.addUserFormGroup = vm.fb.group({\n    email: ['', [vm.validators.required, vm.validators.pattern(/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\_\\-0-9]+\\.)+[a-zA-Z]{2,}))$/)]],\n    firstName: [null],\n    lastName: [null],\n    userActivationMethod: ['displayActivationLink']\n  });\n  \n  vm.cancel = function () {\n    vm.dialogRef.close(null);\n  };\n  \n  vm.save = function () {\n    var customerId;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n    vm.addUserFormGroup.markAsPristine();\n    \n    const formValues = vm.addUserFormGroup.value;\n    let user = {\n      email: formValues.email,\n      firstName: formValues.firstName,\n      lastName: formValues.lastName,\n      authority: 'CUSTOMER_USER',\n      customerId: customerId\n    };\n    const sendActivationMail = (formValues.userActivationMethod === 'sendActivationMail');\n    \n    widgetContext.rxjs.forkJoin([\n        getTargetUserGroup(customerId), \n        getDashboardByName('Smart Diagnostics')\n    ]).pipe(\n        widgetContext.rxjs.switchMap((data) => {\n            /*console.log(data[1]);*/\n            var userGroup = data[0];\n            var defaultDashboard = data[1];\n            if (defaultDashboard) {\n                user.additionalInfo = {\n                    defaultDashboardId: defaultDashboard.id.id,\n                    defaultDashboardFullscreen: true\n                };\n            }\n            /*console.log(\"user\", user);*/\n            return saveUserObservable(userGroup, user, sendActivationMail);\n        }),\n        // Added switchMap to save the 'role' attribute after the user is saved\n        widgetContext.rxjs.switchMap((savedUser) => {\n            // Define the attribute to be saved\n            const roleAttribute = {\n                key: 'role',\n                value: 'Belimo Retrofit Engineer'\n            };\n            \n            // Call the attributeService to save the attribute\n            return attributeService.saveEntityAttributes(savedUser.id, 'SERVER_SCOPE', [roleAttribute]).pipe(\n                // Pass the savedUser to the next operator\n                widgetContext.rxjs.map(() => savedUser)\n            );\n        })\n    ).subscribe((user) => {\n        widgetContext.updateAliases();\n        if (formValues.userActivationMethod === 'displayActivationLink') {\n            userService.getActivationLink(user.id.id).subscribe(\n                (activationLink) => {\n                    displayActivationLink(activationLink).subscribe(\n                        () => {\n                            vm.dialogRef.close(null);\n                        }\n                    );\n                }\n            );\n        } else {\n            vm.dialogRef.close(null);\n        }\n    });\n  };\n  \n  function saveUserObservable(userGroup, user, sendActivationMail) {\n      return userService.saveUser(user, sendActivationMail, userGroup.id.id);\n  }\n  \n  function getTargetUserGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'USER').pipe(\n          widgetContext.rxjs.switchMap((groups) => {\n              return getOrCreateUserGroup(groups, 'Belimo Retrofit Engineer', customerId);\n          })\n      );\n  }\n  \n  function getOrCreateUserGroup(groups, groupName, customerId) {\n      var usersGroup = groups.find(group => group.name === groupName);\n      if (usersGroup) {\n          return widgetContext.rxjs.of(usersGroup);\n      } else {\n          usersGroup = {\n              type: 'USER',\n              name: groupName,\n              ownerId: customerId\n          };\n          return entityGroupService.saveEntityGroup(usersGroup);\n      }\n  }\n  \n  function getDashboardByName(dashboardName) {\n      var dashboardsPageLink = widgetContext.pageLink(10, 0, dashboardName);\n      return dashboardService.getUserDashboards(null, null, dashboardsPageLink, {ignoreLoading: true}).pipe(\n          widgetContext.rxjs.map((data) => {\n            if (data.data.length) {\n                return data.data.find((dashboard) => dashboard.name === dashboardName);\n            } else {\n                return null;\n            }\n          })\n      );\n  }\n  \n    function displayActivationLink(activationLink) {\n        const template = '<form style=\"min-width: 400px;\">\\n' +\n            '  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\\n' +\n            '    <h2 translate>user.activation-link</h2>\\n' +\n            '        <span class=\"flex-1\"></span>\\n' +\n            '    <button mat-icon-button\\n' +\n            '            (click)=\"close()\"\\n' +\n            '            type=\"button\">\\n' +\n            '      <mat-icon class=\"material-icons\">close</mat-icon>\\n' +\n            '    </button>\\n' +\n            '  </mat-toolbar>\\n' +\n            '  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\\n' +\n            '  </mat-progress-bar>\\n' +\n            '  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\\n' +\n            '  <div mat-dialog-content tb-toast toastTarget=\"activationLinkDialogContent\">\\n' +\n            '    <div class=\"flex flex-col gap-0 sm:gap-2\">\\n' +\n            '      <span [innerHTML]=\"\\'user.activation-link-text\\' | translate: {activationLink: activationLink}\"></span>\\n' +\n            '      <div class=\"flex justify-center items-center\">\\n' +\n            '        <pre class=\"tb-highlight\" class=\"flex\"><code>{{ activationLink }}</code></pre>\\n' +\n            '        <button mat-icon-button\\n' +\n            '                color=\"primary\"\\n' +\n            '                ngxClipboard\\n' +\n            '                cbContent=\"{{ activationLink }}\"\\n' +\n            '                (cbOnSuccess)=\"onActivationLinkCopied()\"\\n' +\n            '                matTooltip=\"{{ \\'user.copy-activation-link\\' | translate }}\"\\n' +\n            '                matTooltipPosition=\"above\">\\n' +\n            '          <mat-icon svgIcon=\"mdi:clipboard-arrow-left\"></mat-icon>\\n' +\n            '        </button>\\n' +\n            '      </div>\\n' +\n            '    </div>\\n' +\n            '  </div>\\n' +\n            '  <div mat-dialog-actions class=\"flex justify-end gap-2\">\\n' +\n            '    <button mat-button color=\"primary\"\\n' +\n            '            type=\"button\"\\n' +\n            '            cdkFocusInitial\\n' +\n            '            [disabled]=\"(isLoading$ | async)\"\\n' +\n            '            (click)=\"close()\">\\n' +\n            '      {{ \\'action.ok\\' | translate }}\\n' +\n            '    </button>\\n' +\n            '  </div>\\n' +\n            '</form>';\n        return customDialog.customDialog(template, ActivationLinkDialogController, {activationLink: activationLink});\n    }\n\n    function ActivationLinkDialogController(instance) {\n        var vm = instance;\n\n        vm.activationLink = instance.data.activationLink;\n\n        vm.onActivationLinkCopied = onActivationLinkCopied;\n        vm.close = close;\n\n        function onActivationLinkCopied(){\n            widgetContext.showSuccessToast(translate.instant('user.activation-link-copied-message'), 1000, 'bottom', 'left', 'activationLinkDialogContent');\n        }\n\n        function close() {\n            vm.dialogRef.close(null);\n        }\n    }\n  \n}\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f089248b-5725-30f6-58dd-64e50dfb0496"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "pageSize": 1024,
          "displayTimewindow": true
        },
        "row": 0,
        "col": 0,
        "id": "8a5a3b08-5990-7d43-feca-892f176bff4c",
        "typeFullFqn": "system.cards.entities_table"
      },
      "1e47b3eb-3599-35fc-6166-ad5b61d8be98": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "floorplan",
                  "type": "attribute",
                  "label": "floorplan",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.5234606901361916
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": true,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "widgetTitle": "Floor plan",
            "showResultMessage": false,
            "displayPreview": true,
            "displayClearButton": true,
            "displayApplyButton": false,
            "displayDiscardButton": true
          },
          "title": "Floor plan",
          "dropShadow": false,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "actions": {
            "headerButton": [
              {
                "name": "Go Back",
                "icon": "arrow_back",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\n//params['selectedLocation'] = null;\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "d4d6f5a6-11f6-f943-0558-026041524b5d"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "titleFont": {
            "size": 24,
            "sizeUnit": "px",
            "family": "Roboto",
            "weight": "500",
            "style": "normal"
          },
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "1e47b3eb-3599-35fc-6166-ad5b61d8be98",
        "typeFullFqn": "system.input_widgets.update_server_image_attribute"
      },
      "7abc3362-5ae6-3da5-cfc1-3fc4cd8db230": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 6.5,
        "config": {
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 86400000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "entitiesTitle": "{i18n:custom.diagnostics.measurements.title}",
            "enableSearch": true,
            "enableSelectColumnDisplay": false,
            "enableStickyHeader": true,
            "enableStickyAction": true,
            "showCellActionsMenu": true,
            "reserveSpaceForHiddenAction": "true",
            "displayEntityName": true,
            "entityNameColumnTitle": "ID",
            "displayEntityLabel": false,
            "entityLabelColumnTitle": "",
            "displayEntityType": false,
            "displayPagination": true,
            "defaultPageSize": 10,
            "pageStepCount": 3,
            "pageStepIncrement": 10,
            "defaultSortOrder": "entityName",
            "useRowStyleFunction": false,
            "rowStyleFunction": ""
          },
          "title": "Measurements",
          "dropShadow": false,
          "enableFullscreen": true,
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px",
            "height": "60px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f765d469-eafe-c53b-d010-c75a39278cad",
              "filterId": null,
              "dataKeys": [
                {
                  "name": "locationName",
                  "type": "attribute",
                  "label": "Alias",
                  "color": "#4caf50",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "74px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.7448728411727017,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "address",
                  "type": "attribute",
                  "label": "{i18n:custom.projects.measurements.address}",
                  "color": "#2196f3",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "00%",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": false,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible"
                  },
                  "_hash": 0.1345774127559587,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null,
                  "aggregationType": null
                },
                {
                  "name": "measurementType",
                  "type": "attribute",
                  "label": "{i18n:custom.projects.measurements.type}",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.4433748223281291,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "{i18n:custom.projects.measurements.progress}",
                  "color": "#607d8b",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar description;\r\nvar state = value;\r\nif (state == 'active') { // all key values here are strings\r\n  color = '#f3de61'; // Yellow\r\n  description = '{i18n:custom.diagnostics.state-filter.active.title}';\r\n} else if (state == 'in preparation') {\r\n  /*color = '#005757';*/\r\n  /*color = '#eef30b';*/\r\n  color = '#CAC1D2';// Grey\r\n   description = '{i18n:custom.diagnostics.state-filter.preparation.title}';\r\n}else if (state == 'aborted') {\r\n  /*color = '#005757';*/\r\n  /*color = '#eef30b';*/\r\n  color = '#EB5757';// Grey\r\n   description = '{i18n:custom.diagnostics.state-filter.aborted.title}';\r\n}\r\nelse {\r\n  color = '#27AE60';//Green\r\n  description = '{i18n:custom.diagnostics.state-filter.finished.title}';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span>' + ' ' + description;\r\n",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.1587339209875296,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "detailReport",
                  "type": "attribute",
                  "label": "{i18n:custom.projects.measurements.report}",
                  "color": "#ffc107",
                  "settings": {
                    "customTitle": "",
                    "columnWidth": "0px",
                    "useCellStyleFunction": false,
                    "cellStyleFunction": "",
                    "useCellContentFunction": true,
                    "useCellContentFunctionOnExport": true,
                    "cellContentFunction": "var color;\r\nvar detailReport = value;\r\nvar status;\r\nif (detailReport == 'true') { // all key values here are strings\r\n  color = '#27AE60';\r\n  status = '{i18n:custom.measurement.administration.report.paid}';\r\n} else {\r\n  color = '#EB5757';\r\n  status = '{i18n:custom.measurement.administration.report.inactive}';\r\n}\r\nreturn '<span style=\"font-size: 18px; color: ' + color + '\">&#11044;</span>' + ' ' + status;",
                    "defaultColumnVisibility": "visible",
                    "columnSelectionToDisplay": "enabled",
                    "columnExportOption": "onlyVisible",
                    "disableSorting": false
                  },
                  "_hash": 0.29479841337619983,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "actions": {
            "rowClick": [
              {
                "name": "{i18n:custom.projects.measurements.select-measurement}",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "measurement_devices",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "51fa170e-1231-e3db-29ba-d6f5f02ce918"
              }
            ],
            "actionCellButton": [
              {
                "name": "{i18n:custom.projects.measurements.select-measurement}",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "openDashboardState",
                "targetDashboardStateId": "edit_measurements_card_proj",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "5e50c296-0eac-8841-a69a-1cbbfe04d1c5"
              },
              {
                "name": "{i18n:custom.projects.measurements.unlock-report}",
                "icon": "verified",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\"){\n    return true;\n}else{\n    return false;\n}",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" (ngSubmit)=\"checkout()\" class=\"add-entity-form\" [formGroup]=\"addEntityFormGroup\">\r\n    <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n        <h2 class=\"text-lg font-semibold\">{{'custom.measurement.administration.unlock-report.payment-options' | translate }}</h2>\r\n        <span class=\"flex-1\"></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n            <mat-icon class=\"material-icons\">close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n    <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n        <div class=\"flex justify-center items-center gap-8\">\r\n            <div class=\"flex flex-col\">\r\n                <div>{{'custom.measurement.administration.unlock-report.pay-by-invoice' | translate }}</div>\r\n                <mat-checkbox [checked]=\"buyInvoice\" (change)=\"onSelectBuyInvoice($event)\"></mat-checkbox>\r\n            </div>\r\n            <div class=\"flex flex-col\">\r\n                <div>{{ 'custom.measurement.administration.unlock-report.credit-card.alternative-payments' | translate }}</div>\r\n                <mat-checkbox [checked]=\"buyCard\" (change)=\"onSelectBuyCard($event)\"></mat-checkbox>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n        <button mat-button color=\"primary\" type=\"button\" [disabled]=\"(isLoading$ | async)\" (click)=\"cancel()\" cdkFocusInitial>\r\n            {{ 'action.cancel' | translate }}\r\n        </button>\r\n        <button mat-button mat-raised-button color=\"primary\" type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || (!buyInvoice && !buyCard)\">\r\n            {{ 'custom.measurement.administration.unlock-report.checkout' | translate }}\r\n        </button>\r\n    </div>\r\n</form>",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let injector = widgetContext.$scope.$injector;\r\nlet PageLink = widgetContext.pageLink;\r\nlet customDialog = injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet assetService = injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet assetProfileService = injector.get(widgetContext.servicesMap.get('assetProfileService'));\r\nlet customerService = injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet translationService = injector.get(widgetContext.servicesMap.get('translate'));\r\n\r\nlet stripeSecretKey;\r\nlet sessionId = '';\r\nlet products = [];\r\nlet measurementId = entityId.id;\r\nlet customerId;\r\nlet customerStripeId;\r\nlet measurementName = '';\r\nlet bearerToken = '';\r\nlet sensors;\r\nlet measurementType; // new global variable to store measurement type\r\nvar url = window.location.href;\r\nvar customer;\r\nif (widgetContext.currentUser.authority !== 'CUSTOMER_USER') {\r\n  customer = widgetContext.stateController.getStateParams().entityId;  \r\n} else {\r\n  customer = { entityType: \"CUSTOMER\", id: widgetContext.currentUser.customerId };\r\n}\r\n\r\nfunction getRelatedSensors(measurementId){\r\n    let deviceQuery = {\r\n      parameters: {\r\n        rootId: measurementId,\r\n        rootType: \"ASSET\",\r\n        direction: \"FROM\",\r\n        relationTypeGroup: \"COMMON\",\r\n        maxLevel: 1073741824,\r\n        fetchLastLevelOnly: true\r\n      },\r\n      relationType: \"Measurement\",\r\n      deviceTypes: [\"Room Sensor CO2\"]\r\n    }\r\n    return deviceService.findByQuery(deviceQuery);\r\n}\r\n\r\nfunction getQueryParam(param) {\r\n  const urlParams = new URLSearchParams(window.location.search);\r\n  return urlParams.get(param);\r\n}\r\n\r\nconst sessionIdFromUrl = getQueryParam('session_id');\r\nif (sessionIdFromUrl) {\r\n  window.history.replaceState({}, document.title, window.location.pathname);\r\n  localStorage.removeItem('selectedmeasurementId');\r\n  checkPaymentStatus(sessionIdFromUrl, measurementId);\r\n} else {\r\n  initialize();\r\n}\r\n\r\nfunction initialize() {\r\n  // First, fetch the measurementType for our current project (entityId)\r\n  attributeService.getEntityAttributes(\r\n    { entityType: 'ASSET', id: measurementId },\r\n    \"SERVER_SCOPE\",\r\n    [\"measurementType\"]\r\n  ).subscribe(mtAttributes => {\r\n    let measurementTypeVal = (mtAttributes && mtAttributes.length && mtAttributes[0].value) ? mtAttributes[0].value : null;\r\n    measurementType = measurementTypeVal; // save measurement type globally\r\n\r\n    // Decide which prodType is needed based on measurementType\r\n    if (measurementTypeVal === \"ultrasonic\") {\r\n      requiredProdType = \"detailReportUltrasonic\";\r\n    } else if (measurementTypeVal === \"loraWan\") {\r\n      requiredProdType = \"detailReportLoraWan\";\r\n    } else {\r\n      requiredProdType = null; \r\n    }\r\n\r\n    // Retrieve standard project info to get customerId, etc.\r\n    assetService.getAssetInfo(measurementId).subscribe(info => {\r\n      customerId = info.customerId;\r\n      measurementName = info.name || measurementId;\r\n\r\n      checkSingleProjectStatus(measurementId).then(result => {\r\n        if (result === 'paid') {\r\n          alert(translationService.instant('custom.payment.alert.report-already-activated'));\r\n        } else if (result === 'openInvoice') {\r\n          alert(translationService.instant('custom.payment.alert.open-invoice'));\r\n        } else {\r\n          attributeService.getEntityAttributes(customerId, \"SERVER_SCOPE\", ['stripe_id']).subscribe(stripeId => {\r\n            customerStripeId = stripeId[0].value;\r\n            attributeService.getEntityAttributes(customer, \"SERVER_SCOPE\", ['stripeKey'])\r\n              .subscribe(attribute => {\r\n                stripeSecretKey = attribute[0].value;\r\n\r\n                // Login to fetch bearer token for further asset & attribute API calls\r\n                fetch('https://cloud.pke-iot.expert/api/auth/login', {\r\n                  method: 'POST',\r\n                  headers: {\r\n                    'Content-Type': 'application/json'\r\n                  },\r\n                  body: JSON.stringify({\r\n                    \"username\": \"belimo.api@pke-iot.expert\",\r\n                    \"password\": \"vfx3cvr@VMJ3bxk3urg\"\r\n                  })\r\n                })\r\n                .then(resp => resp.json())\r\n                .then(loginData => {\r\n                  bearerToken = loginData.token;\r\n\r\n                  // We'll fetch all potential \"Product\" assets via REST\r\n                  const query = {\r\n                    parameters: {\r\n                      rootId: customer.id,\r\n                      rootType: \"CUSTOMER\",\r\n                      direction: \"FROM\",\r\n                      relationTypeGroup: \"COMMON\",\r\n                      maxLevel: 1073741824,\r\n                      fetchLastLevelOnly: true\r\n                    },\r\n                    relationType: \"Contains\",\r\n                    assetTypes: [\"Product\"]\r\n                  };\r\n\r\n                  return fetch('https://cloud.pke-iot.expert/api/assets', {\r\n                    method: 'POST',\r\n                    headers: {\r\n                      'accept': 'application/json',\r\n                      'Content-Type': 'application/json',\r\n                      'X-Authorization': 'Bearer ' + bearerToken\r\n                    },\r\n                    body: JSON.stringify(query)\r\n                  });\r\n                })\r\n                .then(resp2 => resp2.json())\r\n                .then(assets => {\r\n                  console.log(\"All fetched products:\", assets);\r\n                  let filteredProducts = [];\r\n                  let productFetches = assets.map(asset => {\r\n                    return new Promise((resolve) => {\r\n                      fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${asset.id.id}/values/attributes?keys=prodType`, {\r\n                        method: 'GET',\r\n                        headers: {\r\n                          'accept': 'application/json',\r\n                          'X-Authorization': 'Bearer ' + bearerToken\r\n                        }\r\n                      })\r\n                      .then(resp3 => resp3.json())\r\n                      .then(attributes => {\r\n                        // Filter by requiredProdType\r\n                        let prodTypeAttr = attributes.find(a => a.key === 'prodType');\r\n                        if (prodTypeAttr && prodTypeAttr.value === requiredProdType) {\r\n                          filteredProducts.push(asset);\r\n                        }\r\n                        resolve();\r\n                      })\r\n                      .catch(err => {\r\n                        console.error(\"Error fetching prodType:\", err);\r\n                        resolve();\r\n                      });\r\n                    });\r\n                  });\r\n                  Promise.all(productFetches).then(() => {\r\n                    console.log(\"Filtered products:\", filteredProducts);\r\n                    products = filteredProducts;\r\n                    openAddEntityDialog();\r\n                  });\r\n                })\r\n                .catch(error => {\r\n                  console.error(\"Error fetching products:\", error);\r\n                  alert(translationService.instant('custom.payment.alert.failed-to-fetch'));\r\n                });\r\n              });\r\n          });\r\n        }\r\n      }).catch(err => {\r\n        console.error('Error checking project status:', err);\r\n        alert(translationService.instant('custom.payment.alert.failed-to-check'));\r\n      });\r\n    });\r\n  }, error => {\r\n    console.error('Failed to fetch measurementType:', error);\r\n    alert(translationService.instant('custom.payment.alert.unable-to-determine'));\r\n  });\r\n}\r\n\r\nfunction openAddEntityDialog() {\r\n  getRelatedSensors(measurementId).subscribe(response =>{\r\n    sensors = response;\r\n    customDialog.customDialog(htmlTemplate, AddEntityDialogController).subscribe();\r\n  });\r\n}\r\n\r\nfunction AddEntityDialogController(instance) {\r\n  let vm = instance;\r\n  vm.products = products;\r\n  vm.buyInvoice = false;\r\n  vm.buyCard = false;\r\n\r\n  vm.addEntityFormGroup = vm.fb.group({});\r\n\r\n  vm.onSelectBuyInvoice = function(event) {\r\n    vm.buyInvoice = event.checked;\r\n    if (vm.buyInvoice) {\r\n      vm.buyCard = false;\r\n    }\r\n  };\r\n\r\n  vm.onSelectBuyCard = function(event) {\r\n    vm.buyCard = event.checked;\r\n    if (vm.buyCard) {\r\n      vm.buyInvoice = false;\r\n    }\r\n  };\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  vm.checkout = function () {\r\n    if (!vm.products.length) {\r\n      alert(translationService.instant('custom.payment.alert.no-product-found'));\r\n      vm.dialogRef.close(null);\r\n      return;\r\n    }\r\n    // We'll just pick the first product from the filtered list\r\n    const productId = vm.products[0].id.id;\r\n\r\n    // Fetch price_stripe_id via REST\r\n    fetch(`https://cloud.pke-iot.expert/api/plugins/telemetry/ASSET/${productId}/values/attributes?keys=price_stripe_id`, {\r\n      method: 'GET',\r\n      headers: {\r\n        'accept': 'application/json',\r\n        'X-Authorization': 'Bearer ' + bearerToken\r\n      }\r\n    })\r\n    .then(resp => resp.json())\r\n    .then(attributes => {\r\n      let priceIdObj = attributes.find(attr => attr.key === 'price_stripe_id');\r\n      if (priceIdObj) {\r\n        const priceId = priceIdObj.value;\r\n        if (vm.buyInvoice) {\r\n          createInvoiceForOneTimePurchase(priceId, instance);\r\n        } else if (vm.buyCard) {\r\n          createCheckoutSession(priceId, instance);\r\n        } else {\r\n          alert(translationService.instant('custom.payment.alert.payment.method'));\r\n        }\r\n      } else {\r\n        console.error('Price ID not found for the product.');\r\n        vm.dialogRef.close(null);\r\n      }\r\n    })\r\n    .catch(err => {\r\n      console.error('Error fetching price_stripe_id:', err);\r\n      vm.dialogRef.close(null);\r\n    });\r\n  };\r\n}\r\n\r\nasync function createInvoiceForOneTimePurchase(priceId, instance) {\r\n  try {\r\n    const priceResp = await fetch(`https://api.stripe.com/v1/prices/${priceId}`, {\r\n      method: 'GET',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`\r\n      }\r\n    });\r\n    if (!priceResp.ok) {\r\n      throw new Error(`Error fetching price details: ${priceResp.statusText}`);\r\n    }\r\n    const priceData = await priceResp.json();\r\n\r\n    // Determine sensor count multiplier (default to 1)\r\n    let sensorCount = 1;\r\n    if (measurementType === \"loraWan\" && Array.isArray(sensors)) {\r\n      sensorCount = sensors.length;\r\n    }\r\n\r\n    // Multiply unit_amount by sensor count if needed\r\n    const amount = priceData.unit_amount * sensorCount;\r\n    const currency = priceData.currency;\r\n\r\n    let invoiceBody = new URLSearchParams({\r\n      customer: customerStripeId,\r\n      auto_advance: 'false',\r\n      collection_method: 'send_invoice',\r\n      days_until_due: '14'\r\n    });\r\n    const invoiceResp = await fetch('https://api.stripe.com/v1/invoices', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: invoiceBody\r\n    });\r\n    if (!invoiceResp.ok) {\r\n      throw new Error(`Error creating draft invoice: ${invoiceResp.statusText}`);\r\n    }\r\n    const invoiceData = await invoiceResp.json();\r\n\r\n    let invoiceItemBody = new URLSearchParams({\r\n      customer: customerStripeId,\r\n      invoice: invoiceData.id,\r\n      amount: amount.toString(),\r\n      currency: currency,\r\n      description: `One-time purchase for project: ${measurementName} (x${sensorCount} sensors)`\r\n    });\r\n    const invoiceItemResp = await fetch('https://api.stripe.com/v1/invoiceitems', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: invoiceItemBody\r\n    });\r\n    if (!invoiceItemResp.ok) {\r\n      throw new Error(`Error creating invoice item: ${invoiceItemResp.statusText}`);\r\n    }\r\n    await invoiceItemResp.json();\r\n\r\n    const finalizeResp = await fetch(`https://api.stripe.com/v1/invoices/${invoiceData.id}/finalize`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`\r\n      }\r\n    });\r\n    if (!finalizeResp.ok) {\r\n      throw new Error(`Error finalizing invoice: ${finalizeResp.statusText}`);\r\n    }\r\n    await finalizeResp.json();\r\n\r\n    const attributes = [\r\n      { key: \"generalReport\", value: false },\r\n      { key: \"invoiceId\", value: invoiceData.id }\r\n    ];\r\n    attributeService.saveEntityAttributes(\r\n      { entityType: 'ASSET', id: measurementId },\r\n      \"SERVER_SCOPE\",\r\n      attributes\r\n    ).subscribe(\r\n      () => {\r\n        alert(translationService.instant('custom.payment.alert.invoice-created-and-sent'));\r\n        instance.dialogRef.close(null);\r\n      },\r\n      (error) => {\r\n        console.error('Error updating attributes:', error);\r\n        instance.dialogRef.close(null);\r\n      }\r\n    );\r\n  } catch (err) {\r\n    console.error(\"Error creating invoice:\", err);\r\n    alert(translationService.instant('custom.payment.alert.failed-to-create-invoice'));\r\n    instance.dialogRef.close(null);\r\n  }\r\n}\r\n\r\nasync function createCheckoutSession(priceId, instance) {\r\n  try {\r\n    const priceResponse = await fetch(`https://api.stripe.com/v1/prices/${priceId}`, {\r\n      method: 'GET',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`\r\n      }\r\n    });\r\n    if (!priceResponse.ok) {\r\n      throw new Error(`Error fetching price details: ${priceResponse.statusText}`);\r\n    }\r\n    const priceData = await priceResponse.json();\r\n    const isRecurring = priceData.recurring !== null;\r\n    const mode = isRecurring ? 'subscription' : 'payment';\r\n    const successUrl = url;\r\n    const cancelUrl = url;\r\n\r\n    // Determine sensor count multiplier (default to 1)\r\n    let sensorCount = 1;\r\n    if (measurementType === \"loraWan\" && Array.isArray(sensors)) {\r\n      sensorCount = sensors.length;\r\n    }\r\n\r\n    const bodyParams = new URLSearchParams({\r\n      'success_url': successUrl,\r\n      'cancel_url': cancelUrl,\r\n      'payment_method_types[]': 'card',\r\n      'mode': mode,\r\n      'customer': customerStripeId\r\n    });\r\n    bodyParams.append('line_items[0][price_data][currency]', priceData.currency);\r\n    bodyParams.append('line_items[0][price_data][unit_amount]', String(priceData.unit_amount));\r\n    bodyParams.append('line_items[0][price_data][product_data][name]', `One-time purchase for: ${measurementName} (x${sensorCount} sensors)`);\r\n    bodyParams.append('line_items[0][quantity]', String(sensorCount));\r\n\r\n    const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`,\r\n        'Content-Type': 'application/x-www-form-urlencoded'\r\n      },\r\n      body: bodyParams\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error: ${response.statusText}`);\r\n    }\r\n    const data = await response.json();\r\n    if (data.url) {\r\n      sessionId = data.id;\r\n      localStorage.setItem('sessionId', sessionId);\r\n      await new Promise((resolve, reject) => {\r\n        attributeService.saveEntityAttributes(\r\n          { entityType: 'ASSET', id: measurementId },\r\n          \"SERVER_SCOPE\",\r\n          [{ key: \"sessionId\", value: sessionId }]\r\n        ).subscribe(\r\n          () => resolve(),\r\n          (error) => {\r\n            console.error('Error saving session ID attribute:', error);\r\n            reject(error);\r\n          }\r\n        );\r\n      });\r\n      instance.dialogRef.close(null);\r\n      window.location.href = data.url;\r\n    } else {\r\n      console.error('Checkout session URL not found in response');\r\n    }\r\n  } catch (error) {\r\n    console.error('Error creating checkout session:', error);\r\n  }\r\n}\r\n\r\nasync function checkPaymentStatus(sessionId, entityId) {\r\n  try {\r\n    if (!stripeSecretKey || !customerStripeId) {\r\n      await fetchStripeKeysAndCustomerId();\r\n    }\r\n    const response = await fetch(`https://api.stripe.com/v1/checkout/sessions/${sessionId}`, {\r\n      method: 'GET',\r\n      headers: {\r\n        'Authorization': `Bearer ${stripeSecretKey}`\r\n      }\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Error: ${response.statusText}`);\r\n    }\r\n    const data = await response.json();\r\n    if (data.payment_status === 'paid') {\r\n      alert(translationService.instant('custom.payment.alert.payment-completed-successfully'));\r\n      const attributes = [\r\n        { key: \"generalReport\", value: true }\r\n      ];\r\n      attributeService.saveEntityAttributes(\r\n        { entityType: 'ASSET', id: measurementId },\r\n        \"SERVER_SCOPE\",\r\n        attributes\r\n      ).subscribe(\r\n        () => {},\r\n        (error) => {\r\n          console.error('Error saving report attribute:', error);\r\n        }\r\n      );\r\n      return 'paid';\r\n    } else {\r\n      alert(translationService.instant('custom.payment.alert.payment-was-not-successful'));\r\n      return data.payment_status;\r\n    }\r\n  } catch (error) {\r\n    console.error('Error checking payment status:', error);\r\n    return 'error';\r\n  }\r\n}\r\n\r\nasync function fetchStripeKeysAndCustomerId() {\r\n  return new Promise((resolve, reject) => {\r\n    assetService.getAssetInfo(measurementId).subscribe(info => {\r\n      customerId = info.customerId;\r\n      measurementName = info.name || measurementId;\r\n      attributeService.getEntityAttributes(customerId, \"SERVER_SCOPE\", ['stripe_id']).subscribe(stripeId => {\r\n        customerStripeId = stripeId[0].value;\r\n        attributeService.getEntityAttributes(customer, \"SERVER_SCOPE\", ['stripeKey']).subscribe(attribute => {\r\n          stripeSecretKey = attribute[0].value;\r\n          resolve();\r\n        }, reject);\r\n      }, reject);\r\n    }, reject);\r\n  });\r\n}\r\n\r\nfunction checkSingleProjectStatus(mId) {\r\n  return new Promise((resolve, reject) => {\r\n    attributeService.getEntityAttributes(\r\n      { entityType: 'ASSET', id: mId },\r\n      \"SERVER_SCOPE\",\r\n      ['generalReport','invoiceId','sessionId']\r\n    ).subscribe(attrs => {\r\n      let generalReportVal = false;\r\n      let invoiceIdVal = null;\r\n      let sessionIdVal = null;\r\n      attrs.forEach(a => {\r\n        if (a.key === 'generalReport') generalReportVal = a.value;\r\n        if (a.key === 'invoiceId') invoiceIdVal = a.value;\r\n        if (a.key === 'sessionId') sessionIdVal = a.value;\r\n      });\r\n      if (generalReportVal === true) {\r\n        resolve(\"paid\");\r\n      } else {\r\n        if (sessionIdVal) {\r\n          checkStripeSessionPaid(sessionIdVal).then(isSessionPaid => {\r\n            if (isSessionPaid) {\r\n              resolve(\"paid\");\r\n            } else if (invoiceIdVal) {\r\n              checkStripeInvoice(invoiceIdVal).then(invStatus => {\r\n                if (invStatus === 'paid') resolve(\"paid\");\r\n                else if (invStatus === 'open') resolve(\"openInvoice\");\r\n                else resolve(\"unpaid\");\r\n              }).catch(() => reject());\r\n            } else {\r\n              resolve(\"unpaid\");\r\n            }\r\n          }).catch(() => reject());\r\n        } else if (invoiceIdVal) {\r\n          checkStripeInvoice(invoiceIdVal).then(invStatus => {\r\n            if (invStatus === 'paid') resolve(\"paid\");\r\n            else if (invStatus === 'open') resolve(\"openInvoice\");\r\n            else resolve(\"unpaid\");\r\n          }).catch(() => reject());\r\n        } else {\r\n          resolve(\"unpaid\");\r\n        }\r\n      }\r\n    }, err => reject(err));\r\n  });\r\n}\r\n\r\nfunction checkStripeSessionPaid(sid) {\r\n  return new Promise((resolve, reject) => {\r\n    fetchStripeKeysAndCustomerId().then(() => {\r\n      fetch(`https://api.stripe.com/v1/checkout/sessions/${sid}`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Authorization': `Bearer ${stripeSecretKey}`\r\n        }\r\n      })\r\n      .then(r => r.json())\r\n      .then(d => {\r\n        if (d.payment_status === 'paid') resolve(true);\r\n        else resolve(false);\r\n      })\r\n      .catch(() => reject());\r\n    }).catch(() => reject());\r\n  });\r\n}\r\n\r\nfunction checkStripeInvoice(invoiceIdVal) {\r\n  return new Promise((resolve, reject) => {\r\n    fetchStripeKeysAndCustomerId().then(() => {\r\n      fetch(`https://api.stripe.com/v1/invoices/${invoiceIdVal}`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Authorization': `Bearer ${stripeSecretKey}`\r\n        }\r\n      })\r\n      .then(r => r.json())\r\n      .then(d => {\r\n        if (d.status === 'paid') {\r\n          resolve('paid');\r\n        } else if (d.status === 'open' || d.status === 'draft') {\r\n          resolve('open');\r\n        } else {\r\n          resolve(d.status);\r\n        }\r\n      })\r\n      .catch(() => reject());\r\n    }).catch(() => reject());\r\n  });\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "02cc94da-5c66-9abd-5caa-653fb4663450"
              },
              {
                "name": "{i18n:custom.projects.measurements.assigned-devices}",
                "icon": "medical_services",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "measurement_devices",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "71c478b6-a4b1-e569-e99a-85d5562cc721"
              },
              {
                "name": "{i18n:custom.projects.measurements.measurement-parameters}",
                "icon": "settings",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form\r\n  [formGroup]=\"addDeviceFormGroup\"\r\n  (ngSubmit)=\"save()\"\r\n  class=\"add-entity-form w-11/12 max-w-3xl mx-auto\">\r\n\r\n  <mat-toolbar class=\"flex items-center justify-between bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{ 'custom.diagnostics.action.edit-measurement-parameters.title' | translate }}</h2>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar\r\n    color=\"warn\"\r\n    mode=\"indeterminate\"\r\n    *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <mat-horizontal-stepper formGroupName=\"stepper\" linear class=\"space-y-4\">\r\n\r\n      <!-- Assignment Step -->\r\n      <mat-step formGroupName=\"assignmentStep\" label=\"Assignment\">\r\n        <ng-template matStepLabel>{{ 'custom.diagnostics.action.edit-measurement-parameters.assignment.title' | translate }}</ng-template>\r\n\r\n        <!-- Assigned Devices -->\r\n        <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n          <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.assigned-devices.title' | translate }}</mat-label>\r\n          <mat-chip-grid\r\n            #chipList\r\n            aria-label=\"Assigned Devices\"\r\n            class=\"flex flex-wrap gap-2 mt-2\">\r\n            <mat-chip-row *ngFor=\"let dev of assignedDevices\" color=\"primary\" selected disableRipple>\r\n              {{ dev.name }}\r\n            </mat-chip-row>\r\n          </mat-chip-grid>\r\n            <input\r\n              matInput\r\n              [matChipInputFor]=\"chipList\"\r\n              readonly\r\n              [placeholder]=\"assignedDevices?.length ? '' : ('custom.diagnostics.action.edit-measurement-parameters.assigned-devices.error' | translate)\"/>\r\n        </mat-form-field>\r\n\r\n        <!-- Progress -->\r\n        <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n          <mat-label>{{ 'custom.diagnostics.measurement-progress.title' | translate }}</mat-label>\r\n          <mat-select formControlName=\"progress\">\r\n            <mat-option value=\"in preparation\">{{ 'custom.diagnostics.state-filter.preparation.title' | translate }}</mat-option>\r\n            <mat-option value=\"active\">{{ 'custom.diagnostics.state-filter.active.title' | translate }}</mat-option>\r\n            <mat-option value=\"finished\">{{ 'custom.diagnostics.state-filter.finished.title' | translate }}</mat-option>\r\n            <mat-option value=\"aborted\">{{ 'custom.diagnostics.state-filter.aborted.title' | translate }}</mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n\r\n        <!-- Start/End DateTime -->\r\n        <div class=\"flex w-full gap-2\">\r\n          <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n            <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.start-date.title' | translate }}</mat-label>\r\n            <mat-datetimepicker-toggle [for]=\"startDatePicker\" matPrefix></mat-datetimepicker-toggle>\r\n            <mat-datetimepicker #startDatePicker type=\"date\" openOnFocus=\"true\"></mat-datetimepicker>\r\n            <input matInput formControlName=\"startDate\" [matDatetimepicker]=\"startDatePicker\"/>\r\n          </mat-form-field>\r\n          <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n            <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.start-time.title' | translate }}</mat-label>\r\n            <mat-datetimepicker-toggle [for]=\"startTimePicker\" matPrefix></mat-datetimepicker-toggle>\r\n            <mat-datetimepicker #startTimePicker type=\"time\" openOnFocus=\"true\"></mat-datetimepicker>\r\n            <input matInput formControlName=\"startTime\" [matDatetimepicker]=\"startTimePicker\"/>\r\n          </mat-form-field>\r\n        </div>\r\n\r\n        <div class=\"flex w-full gap-2\">\r\n          <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n            <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.end-date.title' | translate }}</mat-label>\r\n            <mat-datetimepicker-toggle [for]=\"endDatePicker\" matPrefix></mat-datetimepicker-toggle>\r\n            <mat-datetimepicker #endDatePicker type=\"date\" openOnFocus=\"true\"></mat-datetimepicker>\r\n            <input matInput formControlName=\"endDate\" [matDatetimepicker]=\"endDatePicker\"/>\r\n          </mat-form-field>\r\n          <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n            <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.end-time.title' | translate }}</mat-label>\r\n            <mat-datetimepicker-toggle [for]=\"endTimePicker\" matPrefix></mat-datetimepicker-toggle>\r\n            <mat-datetimepicker #endTimePicker type=\"time\" openOnFocus=\"true\"></mat-datetimepicker>\r\n            <input matInput formControlName=\"endTime\" [matDatetimepicker]=\"endTimePicker\"/>\r\n          </mat-form-field>\r\n        </div>\r\n\r\n        <!-- Actions -->\r\n        <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n          <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">{{ 'action.cancel' | translate }}</button>\r\n          <button\r\n            mat-button\r\n            matStepperNext\r\n            type=\"button\"\r\n            color=\"primary\"\r\n            *ngIf=\"showAttributesStep\"\r\n            [disabled]=\"!assignedDevicesAvailable\">\r\n            {{ 'custom.diagnostics.action.next.title' | translate }}\r\n          </button>\r\n          <button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            type=\"submit\"\r\n            *ngIf=\"!showAttributesStep\"\r\n            [disabled]=\"addDeviceFormGroup.pristine || addDeviceFormGroup.invalid\">\r\n            {{ 'action.save' | translate }}\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <!-- Attributes Step -->\r\n      <mat-step formGroupName=\"attributesStep\" label=\"Attributes\" *ngIf=\"showAttributesStep\">\r\n        <ng-template matStepLabel>{{ 'custom.diagnostics.action.edit-measurement-parameters.default-parameters.title' | translate }}</ng-template>\r\n\r\n        <div class=\"flex flex-col gap-2\">\r\n\r\n          <!-- Dimension -->\r\n          <fieldset class=\"fieldset\">\r\n            <legend class=\"fieldset-legend\">Dimension</legend>\r\n            <div class=\"flex w-full gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.dimension.title' | translate }}</mat-label>\r\n                <mat-select formControlName=\"dimension\" required>\r\n                  <mat-option *ngFor=\"let dim of dimensionOptions\" [value]=\"dim\">{{ dim }}</mat-option>\r\n                </mat-select>\r\n                <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.dimension').hasError('required')\">\r\n                  {{ 'custom.diagnostics.action.edit-measurement-parameters.dimension.error' | translate }}\r\n                </mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.nominal-flow.title' | translate }}</mat-label>\r\n                <input matInput formControlName=\"nominalFlow\" type=\"number\" readonly/>\r\n              </mat-form-field>\r\n            </div>\r\n            <div class=\"flex gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.floor-volume.title' | translate }}</mat-label>\r\n                <input matInput formControlName=\"deltaTAnalysisFloorVolume\" type=\"number\"/>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.pump-power.title' | translate }}</mat-label>\r\n                <input matInput formControlName=\"deltaTAnalysisPumpEnergy\" type=\"number\"/>\r\n              </mat-form-field>\r\n            </div>\r\n          </fieldset>\r\n\r\n          <!-- Installation -->\r\n          <fieldset class=\"fieldset\">\r\n            <legend class=\"fieldset-legend\">Installation</legend>\r\n            <div class=\"flex gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type.title' | translate }}</mat-label>\r\n                <mat-select formControlName=\"installationType\" required>\r\n                  <mat-option value=\"heating\">{{ 'custom.diagnostics.measurement-type.heating.title' | translate }}</mat-option>\r\n                  <mat-option value=\"cooling\">{{ 'custom.diagnostics.measurement-type.cooling.title' | translate }}</mat-option>\r\n                </mat-select>\r\n                <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationType').hasError('required')\">\r\n                  {{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type.error' | translate }}\r\n                </mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type-options.title' | translate }}</mat-label>\r\n                <mat-select formControlName=\"installationTypeOptions\" required>\r\n                  <ng-container\r\n                    *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationType').value === 'heating'\">\r\n                    <mat-option value=\"radiatorHeating\">{{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type-options.radiator-heating.title' | translate }}</mat-option>\r\n                    <mat-option value=\"floorHeating\">{{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type-options.floor-heating.title' | translate }}</mat-option>\r\n                    <mat-option value=\"districtHeating\">{{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type-options.district-heating.title' | translate }}</mat-option>\r\n                    <mat-option value=\"heatingOther\">{{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type-options.heating-other.title' | translate }}</mat-option>\r\n                  </ng-container>\r\n                  <ng-container\r\n                    *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationType').value === 'cooling'\">\r\n                    <mat-option value=\"coolingCircuit\">{{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type-options.cooling-circuit.title' | translate }}</mat-option>\r\n                    <mat-option value=\"coolingCeiling\">{{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type-options.cooling-ceiling.title' | translate }}</mat-option>\r\n                    <mat-option value=\"chiller\">{{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type-options.chiller.title' | translate }}</mat-option>\r\n                    <mat-option value=\"coolingOther\">{{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type-options.cooling-other.title' | translate }}</mat-option>\r\n                  </ng-container>\r\n                </mat-select>\r\n                <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationTypeOptions').hasError('required')\">\r\n                  {{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type-options.error' | translate }}\r\n                </mat-error>\r\n              </mat-form-field>\r\n            </div>\r\n          </fieldset>\r\n\r\n\r\n          <!-- Analysis -->\r\n          <fieldset class=\"fieldset\">\r\n            <legend class=\"fieldset-legend\">{{'custom.diagnostics.action.edit-measurement-parameters.analysis.title' | translate}}</legend>\r\n            <div class=\"flex gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.analysis.standard-outdoor-temperature' | translate }}</mat-label>\r\n                <input matInput formControlName=\"standardOutdoorTemperature\" type=\"number\"/>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Delta T</mat-label>\r\n                <input matInput formControlName=\"deltaT\" type=\"number\"/>\r\n              </mat-form-field>\r\n            </div>\r\n            <div class=\"flex gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.analysis.standard-outdoor-temperature-threshold-setting' | translate }}</mat-label>\r\n                <mat-select formControlName=\"loadCourseFilterTemperature\" required>\r\n                  <mat-option value=\"above\">{{ 'custom.diagnostics.action.edit-measurement-parameters.analysis.selection.above' | translate }}</mat-option>\r\n                  <mat-option value=\"below\">{{ 'custom.diagnostics.action.edit-measurement-parameters.analysis.selection.below' | translate }}</mat-option>\r\n                </mat-select>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.analysis.standard-outdoor-temperature-threshold' | translate }}</mat-label>\r\n                <input matInput formControlName=\"loadCourseFilterTemperatureValue\" type=\"number\"/>\r\n              </mat-form-field>\r\n            </div>\r\n            <div class=\"flex gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.analysis.maximum-power-threshold' | translate }}</mat-label>\r\n                <input matInput formControlName=\"loadCourseFilterMaxPower\" type=\"number\"/>\r\n              </mat-form-field>\r\n            </div>\r\n            <div class=\"flex gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{'unit.measures.area' | translate}}</mat-label>\r\n                <input matInput formControlName=\"area\" type=\"number\"/>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'filter.unit' | translate}}</mat-label>\r\n                <input matInput formControlName=\"unit\" type=\"text\"/>\r\n              </mat-form-field>\r\n            </div>\r\n          </fieldset>\r\n\r\n          <!-- Weekly Operating Schedule -->\r\n          <fieldset class=\"fieldset\">\r\n            <legend class=\"fieldset-legend\">{{ 'custom.diagnostics.action.edit-measurement-parameters.timings.weekly-schedule.title' | translate }}</legend>\r\n            <div\r\n              formGroupName=\"weeklyOperatingSchedule\"\r\n              class=\"flex justify-between items-center gap-2\">\r\n              <mat-checkbox formControlName=\"monday\">{{ 'scheduler.monday-label' | translate }}</mat-checkbox>\r\n              <mat-checkbox formControlName=\"tuesday\">{{ 'scheduler.tuesday-label' | translate }}</mat-checkbox>\r\n              <mat-checkbox formControlName=\"wednesday\">{{ 'scheduler.wednesday-label' | translate }}</mat-checkbox>\r\n              <mat-checkbox formControlName=\"thursday\">{{ 'scheduler.thursday-label' | translate }}</mat-checkbox>\r\n              <mat-checkbox formControlName=\"friday\">{{ 'scheduler.friday-label' | translate }}</mat-checkbox>\r\n              <mat-checkbox formControlName=\"saturday\">{{ 'scheduler.saturday-label' | translate }}</mat-checkbox>\r\n              <mat-checkbox formControlName=\"sunday\">{{ 'scheduler.sunday-label' | translate }}</mat-checkbox>\r\n            </div>\r\n          </fieldset>\r\n\r\n        </div>\r\n\r\n        <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n          <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\"> {{ 'action.cancel' | translate }}</button>\r\n          <button mat-button matStepperPrevious color=\"primary\"> {{ 'action.back' | translate }}</button>\r\n          <button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"addDeviceFormGroup.pristine || addDeviceFormGroup.invalid\">\r\n             {{ 'action.save' | translate }}\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <!-- Alarm Thresholds Step (Commented Out) -->\r\n      <!-- … -->\r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*.mat-form-field input[disabled] {\n  background-color: #f5f5f5;\n  cursor: not-allowed; \n  color: #9e9e9e;\n  \n}*/",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nconst {\r\n    customDialog,\r\n    entityService,\r\n    deviceService,\r\n    entityGroupService,\r\n    attributeService,\r\n    entityRelationService,\r\n    assetService,\r\n} = [\r\n    'customDialog',\r\n    'entityService',\r\n    'deviceService',\r\n    'entityGroupService',\r\n    'attributeService',\r\n    'entityRelationService',\r\n    'assetService'\r\n].reduce((services, name) => {\r\n    services[name] = $injector.get(widgetContext.servicesMap.get(name));\r\n    return services;\r\n}, {});\r\n\r\nconst measurementId = entityId;\r\n\r\nif (!measurementId || !measurementId.id) {\r\n    console.error(\"Invalid measurementId:\", measurementId);\r\n} else {\r\n    fetchAssignedDevices(measurementId.id);\r\n}\r\n\r\nfunction fetchAssignedDevices(measurementId) {\r\n    const deviceSearchQuery = {\r\n        parameters: {\r\n            rootId: measurementId,\r\n            rootType: \"ASSET\",\r\n            direction: \"FROM\",\r\n            relationTypeGroup: \"COMMON\",\r\n            maxLevel: 100,\r\n            fetchLastLevelOnly: false,\r\n        },\r\n        relationType: \"Measurement\",\r\n        deviceTypes: [\"P-Flow D116\", \"Room Sensor CO2\", \"Temperature Sensor\", \"RESI\"],\r\n    };\r\n\r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n        (devices) => {\r\n            fetchAttributes(devices);\r\n        },\r\n        (error) => {\r\n            console.error(\"Error while fetching devices:\", error);\r\n            fetchAttributes([]);\r\n        }\r\n    );\r\n}\r\n\r\nfunction fetchAttributes(assignedDevices) {\r\n    attributeService.getEntityAttributes(measurementId).subscribe(\r\n        (attributes) => {\r\n            openAddDeviceDialog(assignedDevices, attributes);\r\n        },\r\n        (error) => {\r\n            console.error(\"Error while fetching attributes:\", error);\r\n            openAddDeviceDialog(assignedDevices, []);\r\n        }\r\n    );\r\n}\r\n\r\nfunction openAddDeviceDialog(assignedDevices, attributes) {\r\n    customDialog.customDialog(htmlTemplate, AddDeviceDialogController, {\r\n        measurementId,\r\n        assignedDevices,\r\n        attributes,\r\n    }).subscribe();\r\n}\r\n\r\nfunction AddDeviceDialogController(instance) {\r\n    const vm = instance;\r\n    // Retrieve data from vm.data provided to the controller\r\n    const {\r\n        measurementId,\r\n        assignedDevices = [],\r\n        attributes = [],\r\n    } = vm.data || {};\r\n    vm.assignedDevices = assignedDevices;\r\n\r\n    vm.measurementId = measurementId;\r\n    vm.attributes = attributes;\r\n\r\n    // Retrieve measurementType and progress attribute values\r\n    const measurementTypeAttr = attributes.find(attr => attr.key === 'measurementType');\r\n    const progressAttr = attributes.find(attr => attr.key === 'progress');\r\n    const measurementType = measurementTypeAttr ? measurementTypeAttr.value : null;\r\n    // Default progress to \"in preparation\" if not found\r\n    const progressValue = progressAttr ? progressAttr.value : 'in preparation';\r\n\r\n    // Allow editing if there are assigned devices OR if progress is not \"in preparation\"\r\n    vm.assignedDevicesAvailable = (assignedDevices.length > 0) || (progressValue !== 'in preparation');\r\n\r\n    // If you show a \"No devices assigned!\" text, update the condition accordingly.\r\n    // e.g., vm.showNoDevicesMessage = (assignedDevices.length === 0 && progressValue === 'in preparation');\r\n\r\n    // For additional UI logic – show attributes step only when devices are available and measurementType is 'ultrasonic'\r\n    vm.showAttributesStep = vm.assignedDevicesAvailable && (measurementType === 'ultrasonic');\r\n    /*vm.showAlarmThresholdsStep = vm.assignedDevicesAvailable;*/\r\n\r\n    vm.weekDays = [\r\n        { key: 'monday', label: 'Monday' },\r\n        { key: 'tuesday', label: 'Tuesday' },\r\n        { key: 'wednesday', label: 'Wednesday' },\r\n        { key: 'thursday', label: 'Thursday' },\r\n        { key: 'friday', label: 'Friday' },\r\n        { key: 'saturday', label: 'Saturday' },\r\n        { key: 'sunday', label: 'Sunday' },\r\n    ];\r\n    vm.heatingOptions = ['radiatorHeating', 'floorHeating', 'districtHeating', 'heatingOther'];\r\n    vm.coolingOptions = ['coolingCircuit', 'coolingCeiling', 'chiller', 'coolingOther'];\r\n    vm.dimensionOptions = ['DN15', 'DN20', 'DN25', 'DN32', 'DN40', 'DN50', 'DN65', 'DN80', 'DN100', 'DN125', 'DN150'];\r\n\r\n    vm.addDeviceFormGroup = vm.fb.group({\r\n        stepper: vm.fb.group({\r\n            assignmentStep: vm.fb.group({\r\n                progress: [{ value: progressValue, disabled: !vm.assignedDevicesAvailable }, [vm.validators.required]],\r\n                startDate: [{ value: null, disabled: !vm.assignedDevicesAvailable }],\r\n                startTime: [{ value: null, disabled: !vm.assignedDevicesAvailable }],\r\n                endDate: [{ value: null, disabled: !vm.assignedDevicesAvailable }],\r\n                endTime: [{ value: null, disabled: !vm.assignedDevicesAvailable }],\r\n            }),\r\n            attributesStep: vm.fb.group({\r\n                installationType: [null, [vm.validators.required]],\r\n                installationTypeOptions: ['', [vm.validators.required]],\r\n                standardOutdoorTemperature: [null],\r\n                loadCourseAnalysisTemperature: [null],\r\n                loadCourseFilterTemperature: [null, [vm.validators.required]],\r\n                loadCourseFilterTemperatureValue: [null],\r\n                loadCourseFilterMaxPower: [null],\r\n                nominalFlow: [null],\r\n                deltaT: [null],\r\n                deltaTAnalysisPumpEnergy: [null],\r\n                deltaTAnalysisFloorVolume: [null],\r\n                dimension: [null],\r\n                area: [null],\r\n                unit: [null],\r\n                weeklyOperatingSchedule: vm.fb.group(\r\n                    vm.weekDays.reduce((acc, day) => {\r\n                        acc[day.key] = [false];\r\n                        return acc;\r\n                    }, {})\r\n                ),\r\n            }),\r\n            /*alarmThresholdsStep: vm.fb.group({\r\n                maxVolumeFlowCriticalThreshold: [null],\r\n                maxVolumeFlowMajorThreshold: [null],\r\n                maxEnergyCriticalThreshold: [null],\r\n                maxEnergyMajorThreshold: [null],\r\n                minTemperatureDifferenceCriticalThreshold: [null],\r\n                minTemperatureDifferenceMajorThreshold: [null],\r\n                highCo2CriticalThreshold: [null],\r\n                highCo2MajorThreshold: [null],\r\n                highTemperatureCriticalThreshold: [null],\r\n                highHumidityCriticalThreshold: [null],\r\n                highTemperatureMajorThreshold: [null],\r\n                highHumidityMajorThreshold: [null],\r\n            }),*/\r\n        }),\r\n    });\r\n\r\n    initializeFormValues();\r\n    setupFormSubscriptions();\r\n\r\n    function initializeFormValues() {\r\n        // Map known attribute keys to form controls\r\n        const attributeToFormControlMap = {\r\n            'installationType': 'installationType',\r\n            'installationTypeOptions': 'installationTypeOptions',\r\n            'loadCourseFilterTemperature': 'loadCourseFilterTemperature',\r\n            'loadCourseFilterTemperatureValue': 'loadCourseFilterTemperatureValue',\r\n            'dimension': 'dimension',\r\n            'nominalFlow': 'nominalFlow',\r\n            'pumpPower': 'deltaTAnalysisPumpEnergy',\r\n            'standardOutsideTemperature': 'standardOutdoorTemperature',\r\n            'loadCourseFilterMaxPower': 'loadCourseFilterMaxPower',\r\n            'deltaT': 'deltaT',\r\n            'deltaTAnalysisFloorVolume': 'deltaTAnalysisFloorVolume',\r\n            'loadCourseAnalysisTemperature': 'loadCourseAnalysisTemperature',\r\n            'progress': 'progress',\r\n        };\r\n\r\n        attributes.forEach((attr) => {\r\n            const formControlName = attributeToFormControlMap[attr.key];\r\n            if (formControlName) {\r\n                // Place 'progress' in assignmentStep; otherwise, in attributesStep\r\n                const stepGroup = (formControlName === 'progress') ? 'assignmentStep' : 'attributesStep';\r\n                vm.addDeviceFormGroup.get(`stepper.${stepGroup}.${formControlName}`).setValue(attr.value);\r\n            }\r\n            // Start/end times\r\n            else if (attr.key === 'startTimeMs' || attr.key === 'endTimeMs') {\r\n                if (attr.value) {\r\n                    const dateTime = new Date(Number(attr.value));\r\n                    const dateControlName = (attr.key === 'startTimeMs') ? 'startDate' : 'endDate';\r\n                    const timeControlName = (attr.key === 'startTimeMs') ? 'startTime' : 'endTime';\r\n                    vm.addDeviceFormGroup.get(`stepper.assignmentStep.${dateControlName}`).setValue(dateTime);\r\n                    vm.addDeviceFormGroup.get(`stepper.assignmentStep.${timeControlName}`).setValue(dateTime);\r\n                }\r\n            }\r\n            // Weekly schedule\r\n            else if (attr.key === 'weeklySchedule') {\r\n                if (attr.value) {\r\n                    Object.keys(attr.value).forEach((day) => {\r\n                        vm.addDeviceFormGroup.get(`stepper.attributesStep.weeklyOperatingSchedule.${day}`)\r\n                            .setValue(attr.value[day]);\r\n                    });\r\n                }\r\n            }\r\n            // Additional mapping for alarm threshold attributes can be added similarly.\r\n        });\r\n\r\n        updateProgressControl();\r\n    }\r\n\r\n    let lastProgressValue = null;\r\n\r\n    function setupFormSubscriptions() {\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.installationType').valueChanges.subscribe(() => {\r\n            updateInstallationTypeOptions();\r\n        });\r\n\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.installationTypeOptions').valueChanges.subscribe((val) => {\r\n            setDefaultDeltaT(val);\r\n        });\r\n\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.dimension').valueChanges.subscribe((dimension) => {\r\n            const nominalFlow = getNominalFlowByDimension(dimension);\r\n            vm.addDeviceFormGroup.get('stepper.attributesStep.nominalFlow').setValue(nominalFlow);\r\n        });\r\n\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.nominalFlow').valueChanges.subscribe((val) => {\r\n            if (val) {\r\n                // Example: floor volume as 2% of nominalFlow\r\n                const floorVal = (val * 0.02).toFixed(3);\r\n                vm.addDeviceFormGroup.get('stepper.attributesStep.deltaTAnalysisFloorVolume').setValue(floorVal);\r\n            }\r\n        });\r\n\r\n        vm.addDeviceFormGroup.get('stepper.assignmentStep.progress').valueChanges.subscribe((newValue) => {\r\n            if (newValue !== lastProgressValue) {\r\n                lastProgressValue = newValue;\r\n                updateProgressControl();\r\n            }\r\n        });\r\n    }\r\n\r\n    function updateProgressControl() {\r\n        const progressControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.progress');\r\n        const startDateControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.startDate');\r\n        const startTimeControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.startTime');\r\n        const endDateControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.endDate');\r\n        const endTimeControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.endTime');\r\n\r\n        if (!vm.showAttributesStep) {\r\n            vm.addDeviceFormGroup.get('stepper.attributesStep').disable();\r\n        } else {\r\n            vm.addDeviceFormGroup.get('stepper.attributesStep').enable();\r\n        }\r\n\r\n        if (!vm.assignedDevicesAvailable) {\r\n            progressControl.disable();\r\n            startDateControl.disable();\r\n            startTimeControl.disable();\r\n            endDateControl.disable();\r\n            endTimeControl.disable();\r\n        } else {\r\n            progressControl.enable();\r\n            startDateControl.enable();\r\n            startTimeControl.enable();\r\n            endDateControl.enable();\r\n            endTimeControl.enable();\r\n        }\r\n\r\n        // Auto-set start time if progress is active and not already set.\r\n        if (progressControl.value === 'active' && !startDateControl.value && !startTimeControl.value) {\r\n            const now = new Date();\r\n            startDateControl.setValue(now);\r\n            startTimeControl.setValue(now);\r\n        }\r\n        // Auto-set end time if progress indicates finished/aborted and no end time is set.\r\n        else if (\r\n            (progressControl.value === 'finished' || progressControl.value === 'aborted') &&\r\n            startDateControl.value && startTimeControl.value &&\r\n            !endDateControl.value && !endTimeControl.value\r\n        ) {\r\n            const now = new Date();\r\n            endDateControl.setValue(now);\r\n            endTimeControl.setValue(now);\r\n        }\r\n    }\r\n\r\n    function updateInstallationTypeOptions() {\r\n        const installationType = vm.addDeviceFormGroup.get('stepper.attributesStep.installationType').value;\r\n        let options = [];\r\n        if (installationType === 'heating') {\r\n            options = vm.heatingOptions;\r\n        } else if (installationType === 'cooling') {\r\n            options = vm.coolingOptions;\r\n        }\r\n        vm.filteredInstallationTypeOptions = options;\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.installationTypeOptions').setValue('');\r\n    }\r\n\r\n    function setDefaultDeltaT(installationTypeOptions) {\r\n        const deltaTValues = {\r\n            coolingCircuit: 6,\r\n            coolingCeiling: 3,\r\n            chiller: 6,\r\n            coolingOther: null,\r\n            radiatorHeating: 15,\r\n            floorHeating: 5,\r\n            districtHeating: 25,\r\n            heatingOther: null,\r\n        };\r\n        const defaultDelta = deltaTValues[installationTypeOptions] || null;\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.deltaT').setValue(defaultDelta);\r\n    }\r\n\r\n    function getNominalFlowByDimension(dimension) {\r\n        const dimensionToNominalFlow = {\r\n            DN15: 1.5,\r\n            DN20: 2.5,\r\n            DN25: 3.5,\r\n            DN32: 6,\r\n            DN40: 10,\r\n            DN50: 15,\r\n            DN65: 28.8,\r\n            DN80: 39.6,\r\n            DN100: 72,\r\n            DN125: 111.6,\r\n            DN150: 162,\r\n        };\r\n        return dimensionToNominalFlow[dimension] || null;\r\n    }\r\n\r\n    function parseDateTime(dateObj, timeObj) {\r\n        if (!dateObj || !timeObj) return null;\r\n        const date = new Date(dateObj);\r\n        const time = new Date(timeObj);\r\n        date.setHours(time.getHours(), time.getMinutes(), time.getSeconds(), time.getMilliseconds());\r\n        return date;\r\n    }\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        if (vm.addDeviceFormGroup.invalid) {\r\n            return;\r\n        }\r\n\r\n        const formData = vm.addDeviceFormGroup.value;\r\n        const assignmentStep = formData.stepper.assignmentStep;\r\n        const attributesStep = formData.stepper.attributesStep;\r\n        // const alarmThresholdsStep = formData.stepper.alarmThresholdsStep;  // if needed\r\n\r\n        // Convert date/time values to epoch timestamps\r\n        const startDateTime = parseDateTime(assignmentStep.startDate, assignmentStep.startTime);\r\n        const endDateTime = parseDateTime(assignmentStep.endDate, assignmentStep.endTime);\r\n        let attributesArray;\r\n        if (measurementType === 'ultrasonic') {\r\n            attributesArray = [\r\n                { key: 'xPos', value: 0.5 },\r\n                { key: 'yPos', value: 0.5 },\r\n                { key: 'installationType', value: attributesStep.installationType },\r\n                { key: 'installationTypeOptions', value: attributesStep.installationTypeOptions },\r\n                { key: 'progress', value: assignmentStep.progress },\r\n                { key: 'startTimeMs', value: startDateTime ? startDateTime.getTime() : null },\r\n                { key: 'endTimeMs', value: endDateTime ? endDateTime.getTime() : null },\r\n                { key: 'loadCourseAnalysisTemperature', value: attributesStep.loadCourseAnalysisTemperature },\r\n                { key: 'loadCourseFilterTemperature', value: attributesStep.loadCourseFilterTemperature },\r\n                { key: 'loadCourseFilterTemperatureValue', value: attributesStep.loadCourseFilterTemperatureValue },\r\n                { key: 'loadCourseFilterMaxPower', value: attributesStep.loadCourseFilterMaxPower },\r\n                {\r\n                    key: 'area',\r\n                    value: {\r\n                        value: attributesStep.area,\r\n                        unit: attributesStep.unit,\r\n                    },\r\n                },\r\n                { key: 'nominalFlow', value: attributesStep.nominalFlow },\r\n                { key: 'dimension', value: attributesStep.dimension },\r\n                { key: 'weeklySchedule', value: attributesStep.weeklyOperatingSchedule },\r\n                { key: 'deltaT', value: attributesStep.deltaT },\r\n                { key: 'deltaTAnalysisPumpEnergy', value: attributesStep.deltaTAnalysisPumpEnergy },\r\n                { key: 'deltaTAnalysisFloorVolume', value: attributesStep.deltaTAnalysisFloorVolume },\r\n            ];\r\n        } else {\r\n            attributesArray = [\r\n                { key: 'xPos', value: 0.5 },\r\n                { key: 'yPos', value: 0.5 },\r\n                { key: 'progress', value: assignmentStep.progress },\r\n                { key: 'startTimeMs', value: startDateTime ? startDateTime.getTime() : null },\r\n                { key: 'endTimeMs', value: endDateTime ? endDateTime.getTime() : null },\r\n            ];\r\n        }\r\n\r\n        attributeService.saveEntityAttributes(vm.measurementId, \"SERVER_SCOPE\", attributesArray).subscribe(\r\n            () => {\r\n                // Save successful; update aliases and close dialog\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n            },\r\n            (error) => {\r\n                console.error(\"Error while saving attributes:\", error);\r\n            }\r\n        );\r\n    };\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "70771e5e-d344-f1bd-7ced-fe431a6ccbf9"
              },
              {
                "name": "{i18n:custom.projects.measurements.edit-floorplan}",
                "icon": "mdi:floor-plan",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "devices_plan",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "ee96cff4-82cd-4863-66df-28854ba60585"
              },
              {
                "name": "{i18n:custom.projects.measurements.edit-measurement}",
                "icon": "edit",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"editEntityFormGroup\"\r\n      (ngSubmit)=\"save()\" \r\n      class=\"edit-entity-form max-w-3xl mx-auto\">\r\n    \r\n    <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n        <h2 class=\"text-lg font-semibold\">{{ 'custom.measurement.administration.action.edit-measurement' | translate}}</h2>\r\n        <span class=\"flex-1\"></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n            <mat-icon>close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n    <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n\r\n        <!-- First row: Name, Measurement alias -->\r\n        <div class=\"flex w-full gap-2\">\r\n\r\n            <!-- Name (Top-level form control) -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>{{ 'custom.measurement.administration.name.title' | translate}}</mat-label>\r\n                <input matInput \r\n                       formControlName=\"entityName\" \r\n                       required>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('entityName')?.hasError('required')\">\r\n                  {{'custom.measurement.administration.name.error.is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n\r\n            <!-- Measurement alias (Inside 'attributes' child form group) -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\" [formGroup]=\"editEntityFormGroup.controls['attributes']\">\r\n                <mat-label>{{'custom.measurement.administration.action.measurement-alias' | translate}}</mat-label>\r\n                <input matInput formControlName=\"locationName\">\r\n            </mat-form-field>\r\n        </div>\r\n\r\n        <!-- Second row: Address -->\r\n        <div class=\"flex w-full\">\r\n\r\n            <mat-form-field appearance=\"fill\" class=\"w-full\" [formGroup]=\"editEntityFormGroup.controls['attributes']\">\r\n                <mat-label>{{ 'custom.measurement.administration.address.title' | translate}}</mat-label>\r\n                <input matInput formControlName=\"address\">\r\n            </mat-form-field>\r\n        </div>\r\n\r\n        <!-- Third row: Installation Type, Measurement Type -->\r\n        <div class=\"flex w-full gap-2\">\r\n\r\n            <!-- HIDE Installation Type if measurementType is 'loraWan' -->\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\"\r\n                            *ngIf=\"editEntityFormGroup.get('attributes.measurementType')?.value !== 'loraWan'\"\r\n                            [formGroup]=\"editEntityFormGroup.controls['attributes']\">\r\n                <mat-label>{{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type.title' | translate}}</mat-label>\r\n                <mat-select formControlName=\"installationType\" required>\r\n                    <mat-option value=\"heating\">{{ 'custom.diagnostics.measurement-type.heating.title' | translate}}</mat-option>\r\n                    <mat-option value=\"cooling\">{{ 'custom.diagnostics.measurement-type.cooling.title' | translate}}</mat-option>\r\n                </mat-select>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('attributes.installationType')?.hasError('required')\">\r\n                 {{ 'custom.diagnostics.action.edit-measurement-parameters.installation-type.error' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n\r\n            <mat-form-field appearance=\"fill\" class=\"flex-1\" [formGroup]=\"editEntityFormGroup.controls['attributes']\">\r\n                <mat-label>{{ 'custom.measurement.administration.action.measurement-type.title' | translate}}</mat-label>\r\n                <mat-select formControlName=\"measurementType\" required>\r\n                    <mat-option value=\"ultrasonic\">{{ 'custom.diagnostics.measurement-type.ultrasonic.title' | translate}}</mat-option>\r\n                    <mat-option value=\"loraWan\">{{ 'custom.diagnostics.measurement-type.lorawan.title' | translate}}</mat-option>\r\n                </mat-select>\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('attributes.measurementType')?.hasError('required')\">\r\n                  {{ 'custom.measurement.administration.action.measurement-type.error.is-required' | translate}}\r\n                </mat-error>\r\n            </mat-form-field>\r\n        </div>\r\n    </div>\r\n\r\n    <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n        <button mat-button\r\n                color=\"primary\"\r\n                type=\"button\"\r\n                [disabled]=\"(isLoading$ | async)\"\r\n                (click)=\"cancel()\"\r\n                cdkFocusInitial>\r\n            {{ 'action.cancel' | translate }}\r\n        </button>\r\n        <button mat-button\r\n                mat-raised-button\r\n                color=\"primary\"\r\n                type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid\">\r\n            {{ 'action.save' | translate }}\r\n        </button>\r\n    </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\nopenEditEntityDialog();\n\nfunction openEditEntityDialog() {\n    customDialog.customDialog(htmlTemplate, EditEntityDialogController).subscribe();\n}\n\nfunction EditEntityDialogController(instance) {\n    let vm = instance;\n    vm.entityName = entityName; \n    vm.attributes = {};\n    vm.entity = {};\n\n    // Build the form group with a nested 'attributes' group\n    vm.editEntityFormGroup = vm.fb.group({\n        entityName: ['', [vm.validators.required]],\n        attributes: vm.fb.group({\n            locationName: [null],\n            address: [null],\n            installationType: [null],\n            measurementType: [null]\n        })\n    });\n\n    getEntityInfo();\n\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n\n    vm.save = function() {\n        // Mark the form as pristine right before saving\n        vm.editEntityFormGroup.markAsPristine();\n\n        // Save both entity main fields and attributes\n        widgetContext.rxjs.forkJoin([\n            saveAttributes(entityId),\n            saveEntity()\n        ]).subscribe(() => {\n            widgetContext.updateAliases();\n            vm.dialogRef.close(null);\n        });\n    };\n\n    function getEntityInfo() {\n        // Retrieve attributes + entity info in parallel\n        widgetContext.rxjs.forkJoin([\n            attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE'),\n            entityService.getEntity(entityId.entityType, entityId.id)\n        ]).subscribe(([attrData, entityData]) => {\n            vm.attributes = {};\n            // Populate vm.attributes from server response\n            for (let i = 0; i < attrData.length; i++) {\n                vm.attributes[attrData[i].key] = attrData[i].value;\n            }\n\n            vm.entity = entityData;\n\n            // Patch form values. \n            // Note that 'attributes' is a nested form group, so we pass an object for it.\n            vm.editEntityFormGroup.patchValue({\n                entityName: vm.entity.name,\n                attributes: {\n                    locationName: vm.attributes.locationName,\n                    address: vm.attributes.address,\n                    installationType: vm.attributes.installationType,\n                    measurementType: vm.attributes.measurementType\n                }\n            }, { emitEvent: false });\n        });\n    }\n\n    function saveEntity() {\n        const formValues = vm.editEntityFormGroup.value;\n        \n        // Always update name & label (ensures \"Save\" works even if no change)\n        vm.entity.name = formValues.entityName;\n\n        if (vm.entityType === 'ASSET') {\n            return assetService.saveAsset(vm.entity);\n        } else if (vm.entityType === 'DEVICE') {\n            return deviceService.saveDevice(vm.entity);\n        }\n        \n        // If some other type, or no changes, return an observable that completes.\n        return widgetContext.rxjs.of([]);\n    }\n\n    function saveAttributes(entityId) {\n        // Compare original vs. new values to only send changed attributes\n        const currentAttributes = vm.attributes;\n        const updatedAttributes = vm.editEntityFormGroup.value.attributes;\n        \n        let attributesArray = [];\n        for (let key in updatedAttributes) {\n            if (updatedAttributes.hasOwnProperty(key)) {\n                if (updatedAttributes[key] !== currentAttributes[key]) {\n                    attributesArray.push({ key: key, value: updatedAttributes[key] });\n                }\n            }\n        }\n\n        if (attributesArray.length > 0) {\n            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n        }\n        return widgetContext.rxjs.of([]);\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "eae3b679-7c47-2acc-0632-24a07f2cc8fd"
              },
              {
                "name": "{i18n:custom.projects.measurements.delete-measurement}",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "// Injector & service setup\r\nconst $injector          = widgetContext.$scope.$injector;\r\nconst dialogs            = $injector.get(widgetContext.servicesMap.get('dialogs'));\r\nconst assetService       = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nconst deviceService      = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nconst entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\r\n\r\n// IDs & names\r\nconst measurementEntityId = entityId.id;\r\nconst measurementName     = entityName;\r\nlet customerId;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\n\r\n// Build the two device-search queries once\r\nconst vrQuery = {\r\n  parameters: {\r\n    rootId:             measurementEntityId,\r\n    rootType:           'ASSET',\r\n    direction:          'FROM',\r\n    relationTypeGroup:  'COMMON',\r\n    maxLevel:           10,\r\n    fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Measurement VR',\r\n  deviceTypes:  ['P-Flow D116 VR','Temperature Sensor VR','Room Sensor CO2 VR','Gateway VR']\r\n};\r\n\r\nconst devQuery = {\r\n  parameters: {\r\n    rootId:             measurementEntityId,\r\n    rootType:           'ASSET',\r\n    direction:          'FROM',\r\n    relationTypeGroup:  'COMMON',\r\n    maxLevel:           10,\r\n    fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Measurement',\r\n  deviceTypes:  ['P-Flow D116','Temperature Sensor','Room Sensor CO2','Gateway','RESI']\r\n};\r\n\r\n// 1) Load VR‐devices & devices in parallel\r\nwidgetContext.rxjs.forkJoin({\r\n  vrDevices:     deviceService.findByQuery(vrQuery),\r\n  devices:       deviceService.findByQuery(devQuery)\r\n})\r\n.subscribe(({ vrDevices, devices }) => {\r\n\r\n  // 2) Open confirmation dialog\r\n     const title = translationService.instant(\r\n     'custom.measurement.administration.action.delete-measurement-title',\r\n     { entityName }\r\n     );\r\n\r\n     const content = translationService.instant(\r\n     'custom.measurement.administration.action.delete-measurement-content'\r\n     );\r\n\r\n  dialogs.confirm(\r\n  title,\r\n  content,\r\n  translationService.instant('action.cancel'),\r\n  translationService.instant('action.delete')\r\n)\r\n\r\n    .pipe(widgetContext.rxjs.filter(Boolean))\r\n    .pipe(\r\n      // 3) assign, delete VR devices, then delete measurement asset\r\n      widgetContext.rxjs.switchMap(() =>\r\n        assignToUnassignedMeasurementsGroup(devices).pipe(\r\n          widgetContext.rxjs.catchError(err => {\r\n            console.warn('Could not assign devices—continuing delete anyway', err);\r\n            return widgetContext.rxjs.of(null);\r\n          })\r\n        )\r\n      ),\r\n      widgetContext.rxjs.switchMap(() =>\r\n        widgetContext.rxjs.forkJoin(\r\n          vrDevices.map(d =>\r\n            deviceService.deleteDevice(d.id.id).pipe(\r\n              widgetContext.rxjs.catchError(err => {\r\n                console.error(`Error deleting VR device ${d.id.id}:`, err);\r\n                return widgetContext.rxjs.of(null);\r\n              })\r\n            )\r\n          )\r\n        )\r\n      ),\r\n      widgetContext.rxjs.switchMap(() =>\r\n        assetService.deleteAsset(measurementEntityId).pipe(\r\n          widgetContext.rxjs.catchError(err => {\r\n            console.error(`Error deleting measurement ${measurementEntityId}:`, err);\r\n            return widgetContext.rxjs.of(null);\r\n          })\r\n        )\r\n      )\r\n    )\r\n    .subscribe({\r\n      next: () => widgetContext.updateAliases(),\r\n      error: err => console.error('Delete flow fatal error:', err)\r\n    });\r\n\r\n});\r\n\r\n// Helper: assign all devices into “Unassigned Measurement Devices” group\r\nfunction assignToUnassignedMeasurementsGroup(devices) {\r\n  return getUnassignedMeasurementGroup(customerId).pipe(\r\n    widgetContext.rxjs.switchMap(group => {\r\n      const adds = devices.map(d =>\r\n        entityGroupService.addEntityToEntityGroup(group.id.id, d.id.id).pipe(\r\n          widgetContext.rxjs.catchError(err => {\r\n            console.error(`Error assigning device ${d.id.id}:`, err);\r\n            return widgetContext.rxjs.of(null);\r\n          })\r\n        )\r\n      );\r\n      return widgetContext.rxjs.forkJoin(adds.length ? adds : [widgetContext.rxjs.of(null)]);\r\n    })\r\n  );\r\n}\r\n\r\n// Helper: get or create the “Unassigned Measurement Devices” group\r\nfunction getUnassignedMeasurementGroup(customerId) {\r\n  return entityGroupService\r\n    .getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE')\r\n    .pipe(\r\n      widgetContext.rxjs.switchMap(entityGroups => {\r\n        const grp = entityGroups.find(g => g.name === 'Unassigned Measurement Devices');\r\n        if (grp) {\r\n          return widgetContext.rxjs.of(grp);\r\n        } else {\r\n          const newGrp = { type: 'DEVICE', name: 'Unassigned Measurement Devices', ownerId: customerId };\r\n          return entityGroupService.saveEntityGroup(newGrp);\r\n        }\r\n      })\r\n    );\r\n}\r\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "338d9fd7-c752-eb0e-4687-2c2e32ca1a32"
              },
              {
                "name": "{i18n:custom.data-connector.title}",
                "icon": "mdi:database-plus-outline",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": {
                  "body": "utils.dataConnectorDialog(widgetContext, entityId, entityName);",
                  "modules": {
                    "utils": "tb-resource;/api/resource/js_module/tenant/ECO Data Importer.js"
                  }
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "940daffe-e3c1-f4b3-6261-80a209547e11"
              }
            ],
            "headerButton": [
              {
                "name": "{i18n:custom.projects.measurements.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nparams['selectedProject'] = null;\r\nwidgetContext.updateAliases();\r\nwidgetContext.stateController.updateState(\"Projects\", params);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "0e3af36e-58d2-1609-8e1a-f637992cee4e"
              },
              {
                "name": "{i18n:custom.projects.measurements.add-measurement}",
                "buttonType": "icon",
                "icon": "add",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"addMeasurementFormGroup\"\r\n      (ngSubmit)=\"save()\"\r\n       class=\"add-entity-form max-w-3xl mx-auto\"\r\n      style=\"width: 350px;\">\r\n\r\n  <!-- Optional if you're not mixing template-driven forms with reactive forms \r\n       <form #addEntityForm=\"ngForm\"> can be removed if not needed. -->\r\n\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{'custom.projects.measurements.add-measurement' | translate}}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <div class=\"flex flex-col gap-0 sm:gap-2\">\r\n\r\n      <!-- Measurement title -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{'custom.projects.measurements.measurement-title' | translate}}</mat-label>\r\n        <input matInput formControlName=\"name\" required readonly>\r\n        <mat-error *ngIf=\"addMeasurementFormGroup.get('name')?.hasError('required')\">\r\n          {{'custom.projects.measurements.measurement-title-required' | translate}}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Measurement alias -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{'custom.measurement.administration.action.measurement-alias.title' | translate}}</mat-label>\r\n        <input matInput formControlName=\"locationName\">\r\n        <mat-error *ngIf=\"addMeasurementFormGroup.get('locationName')?.hasError('required')\">\r\n          {{'custom.measurement.administration.action.measurement-alias.title' | translate}}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Address -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{'custom.measurement.administration.action.address.title' | translate}}</mat-label>\r\n        <input matInput formControlName=\"address\">\r\n        <!-- You can add an error check if required for \"address\" -->\r\n      </mat-form-field>\r\n\r\n      <!-- Installation type (HIDDEN if measurementType is loraWan) -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\"\r\n                      *ngIf=\"addMeasurementFormGroup.get('measurementType')?.value !== 'loraWan'\">\r\n        <mat-label>{{'custom.diagnostics.action.edit-measurement-parameters.installation-type.title' | translate}}</mat-label>\r\n        <mat-select formControlName=\"installationType\" required>\r\n          <mat-option value=\"heating\">{{'custom.diagnostics.measurement-type.heating.title' | translate}}</mat-option>\r\n          <mat-option value=\"cooling\">{{'custom.diagnostics.measurement-type.cooling.title' | translate}}</mat-option>\r\n        </mat-select>\r\n        <mat-error *ngIf=\"addMeasurementFormGroup.get('installationType')?.hasError('required')\">\r\n          {{'custom.diagnostics.action.edit-measurement-parameters.installation-type.error' | translate}}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n      <!-- Measurement type -->\r\n      <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n        <mat-label>{{'custom.measurement.administration.action.measurement-type.title' | translate}}</mat-label>\r\n        <mat-select formControlName=\"measurementType\" required>\r\n          <mat-option value=\"ultrasonic\">Ultrasonic</mat-option>\r\n          <mat-option value=\"loraWan\">LoRaWan</mat-option>\r\n        </mat-select>\r\n        <mat-error *ngIf=\"addMeasurementFormGroup.get('measurementType')?.hasError('required')\">\r\n          {{'custom.measurement.administration.action.measurement-type.error.is-required' | translate}}\r\n        </mat-error>\r\n      </mat-form-field>\r\n\r\n    </div>\r\n  </div>\r\n\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button mat-button\r\n            color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\"\r\n            cdkFocusInitial>\r\n      {{'action.cancel' | translate}}\r\n    </button>\r\n    <button mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(isLoading$ | async) || addMeasurementFormGroup.invalid || !addMeasurementFormGroup.dirty\">\r\n      {{'custom.projects.measurements.add-measurement' | translate}}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\r\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n/* make sure the disabled focus-overlay is tinted the same */\r\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\r\n  background-color: rgba(244, 249, 254, 0.5) !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n.add-entity-form\r\n  .mat-mdc-form-field-focus-overlay {\r\n  background-color: #F4F9FE !important;\r\n}\r\n\r\n\r\nmat-icon {\r\n    vertical-align: middle; /* or baseline, top, bottom */\r\n    margin-right: 4px; /* space between icon and text */\r\n}\r\n\r\n.fieldset {\r\n    border: 1px solid #e2e8f0;\r\n    background: #ffffff;\r\n    color: #334155;\r\n    border-radius: 6px;\r\n    padding-bottom: 1px;\r\n    padding-top: 1px;\r\n    padding-left: 10px;\r\n    padding-right: 10px;\r\n}\r\n.fieldset-legend {\r\n    margin-bottom: 0.375rem;\r\n    color: #334155;\r\n    background: #ffffff;\r\n    font-weight: 300;\r\n    border-radius: 6px;\r\n    padding: 2px;\r\n}\r\n.fieldset-container{\r\n    padding-bottom: 10px;\r\n}\r\n\r\n.disabled-checkbox {\r\n  pointer-events: none;\r\n  opacity: 0.5; /* To make it visually look disabled */\r\n}\r\n\r\n.disabled-fields {\r\n  pointer-events: none;   /* Prevents interaction */\r\n  opacity: 0.5;           /* Makes it look disabled */\r\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\n\nlet nextMeasurementId = 0;\nlet longitude;\nlet latitude;\nlet address;\nlet customerName = widgetContext.stateController.getStateParams().entityName;\n/*    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }*/\nlet userRole = widgetContext.stateController.getStateParams().userRole;\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN' || userRole === 'ECO Administrator') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\n/*console.log(\"Customer EntityID: \" + customerId.id);*/\n\nlet projectEntityId = widgetContext.stateController.getStateParams().selectedProject.entityId;\n/*console.log(\"Project EntityID: \" + projectEntityId);*/\n\nlet assetSearchQuery = {\n  \"parameters\": {\n    \"rootId\": projectEntityId.id,\n    \"rootType\": \"ASSET\",\n    \"direction\": \"FROM\",\n    \"relationTypeGroup\": \"COMMON\",\n    \"maxLevel\": 10,\n    \"fetchLastLevelOnly\": false\n  },\n  \"relationType\": \"Owns\",\n  \"assetTypes\": [\n    \"Measurement\"\n  ]\n};\nassetService.findByQuery(assetSearchQuery).subscribe(measurements => {\n/*    console.log(measurements);*/\n    nextMeasurementId = getLastMeasurementId(measurements);\n/*    console.log(\"Next Measurement: \" + nextMeasurementId);*/\n    attributeService.getEntityAttributes(projectEntityId,'SERVER_SCOPE',['longitude','latitude','address']).subscribe(projectatt => {\n        //console.log(\"projectatt\", projectatt);\n        longitude = projectatt[2].value;\n        latitude = projectatt[1].value;\n        address = projectatt[0].value;\n        attributeService.getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName']).subscribe(attributes => {\n            shortNameAttr = attributes.find(attr => attr.key === 'shortName');\n            customerShortName = shortNameAttr ? shortNameAttr.value : customerName;\n            openAddMeasurementDialog();\n        });\n    });\n});\n\nfunction getLastMeasurementId(measurements) {\n    let maxNumber = 0;\n    measurements.forEach(item => {\n        const name = item.name;\n        const parts = name.split('_');\n        if (parts.length === 3) {\n            const number = parseInt(parts[2], 10);\n            if (number > maxNumber) {\n                maxNumber = number;\n            }\n        }\n    });\n    const nextMeasurementId = maxNumber + 1;\n    return nextMeasurementId;\n}\n\nfunction openAddMeasurementDialog() {\n    customDialog.customDialog(htmlTemplate,\n        AddMeasurementDialogController).subscribe();\n}\n\nfunction AddMeasurementDialogController(instance) {\n    let vm = instance;\n    let projectName = widgetContext.stateController.getStateParams().selectedProject.entityName;\n    vm.addMeasurementFormGroup = vm.fb.group({\n        name: [projectName + \"_\" + nextMeasurementId, [vm.validators.required]],\n        locationName: ['', [vm.validators.required]],\n        address: [address, [vm.validators.required]],\n        installationType: ['heating', [vm.validators.required]],\n        measurementType: ['ultrasonic', [vm.validators.required]]\n    });\n\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n\n    vm.save = function() {\n        const stateParams = widgetContext\n            .stateController.getStateParams();\n        var customerId;\n        var projectId;\n        projectId = {\n            id: (stateParams.selectedProject &&\n                    stateParams.selectedProject\n                    .entityId && stateParams\n                    .selectedProject.entityId.id) ?\n                stateParams.selectedProject.entityId\n                .id : '',\n            entityType: 'ASSET'\n        };\n        //console.log(JSON.stringify(projectId));\n        if (widgetContext.currentUser.authority ===\n            'TENANT_ADMIN') {\n            customerId = widgetContext.stateController\n                .getStateParams().entityId;\n        } else {\n            customerId = {\n                id: widgetContext.currentUser\n                    .customerId,\n                entityType: 'CUSTOMER'\n            };\n        }\n        vm.addMeasurementFormGroup.markAsPristine();\n        saveMeasurementObservable(customerId).subscribe(\n            function(Measurement) {\n                const observables = [\n                    saveCustomerToMeasurementRelation(\n                        customerId, Measurement\n                        .id),\n                    saveAttributes(Measurement\n                        .id)\n                ];\n\n                // Add saveProjectToMeasurementRelation to observables if projectId is not empty\n                if (projectId.id !== \"\") {\n                    observables.push(\n                        saveProjectToMeasurementRelation(\n                            projectId,\n                            Measurement.id));\n                }\n                widgetContext.rxjs.forkJoin(observables).subscribe(\n                    function() {\n                        var params =\n                            widgetContext\n                            .stateController\n                            .getStateParams();\n                        var selectedMeasurement =\n                            params[\n                                'selectedMeasurement'\n                                ];\n                        params[\n                            'selectedMeasurement'] = {\n                            entityId: Measurement\n                                .id,\n                            entityName: Measurement\n                                .name,\n                            entityLabel: ''\n                        };\n                        widgetContext\n                            .updateAliases();\n                        vm.dialogRef.close(\n                        null);\n                    }\n                );\n            }\n        );\n    };\n\n    function saveMeasurementObservable(customerId) {\n        return getMeasurementsGroup(customerId).pipe(\n            widgetContext.rxjs.switchMap((\n                MeasurementsGroup) => {\n                const formValues = vm\n                    .addMeasurementFormGroup.value;\n                let Measurement = {\n                    name: formValues.name,\n                    type: 'Measurement',\n                    customerId: customerId\n                };\n                return assetService.saveAsset(\n                    Measurement,\n                    MeasurementsGroup.id.id)\n            })\n        );\n    }\n\n    function getMeasurementsGroup(customerId) {\n        return entityGroupService.getEntityGroupsByOwnerId(\n            customerId.entityType, customerId.id,\n            'ASSET').pipe(\n            widgetContext.rxjs.switchMap((\n                entityGroups) => {\n                    var MeasurementsGroup = entityGroups\n                        .find(group => group.name ===\n                            'Measurements');\n                    if (MeasurementsGroup) {\n                        return widgetContext.rxjs.of(\n                            MeasurementsGroup);\n                    } else {\n                        MeasurementsGroup = {\n                            type: 'ASSET',\n                            name: 'Measurements',\n                            ownerId: customerId\n                        };\n                        return entityGroupService\n                            .saveEntityGroup(\n                                MeasurementsGroup);\n                    }\n                })\n        );\n    }\n\n    function saveCustomerToMeasurementRelation(customerId,\n        MeasurementId) {\n        var relation = {\n            from: customerId,\n            to: MeasurementId,\n            typeGroup: 'COMMON',\n            type: 'Owns'\n        };\n        return entityRelationService.saveRelation(relation);\n    }\n\n    function saveProjectToMeasurementRelation(projectId,\n        MeasurementId) {\n        var relation = {\n            from: projectId,\n            to: MeasurementId,\n            typeGroup: 'COMMON',\n            type: 'Owns'\n        };\n        return entityRelationService.saveRelation(relation);\n    }\n\n    function saveAttributes(entityId) {\n        const formValues = vm.addMeasurementFormGroup.value;\n        let attributesArray = [{\n                key: 'latitude',\n                value: latitude\n            },\n            {\n                key: 'longitude',\n                value: longitude\n            },\n            {\n                key: 'address',\n                value: formValues.address\n            },\n            {\n                key: 'installationType',\n                value: formValues.installationType\n            },\n            {\n                key: 'locationName',\n                value: formValues.locationName\n            },\n            {\n                key: 'measurementType',\n                value: formValues.measurementType\n            },\n            {\n                key: 'state',\n                value: 'normal' // normal, minor, major, critical\n            },            \n            {\n                key: 'progress',\n                value: 'in preparation' // in preparation, active, finished, aborted\n            }, \n            {\n                key: 'active',\n                value: 'true'\n            },\n            {\n                key: 'units',\n                value: 'metric'\n            },\n            {\n                key: 'floorplan',\n                value: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCEtLSBDcmVhdGVkIHdpdGggSW5rc2NhcGUgKGh0dHA6Ly93d3cuaW5rc2NhcGUub3JnLykgLS0+Cjxzdmcgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc5LjM3NSA3OS4zNzUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiA8cmVjdCB4PSIyLjcwMTkiIHk9IjIuNzAxOSIgd2lkdGg9IjczLjk3MSIgaGVpZ2h0PSI3My45NzEiIGZpbGw9IiNmZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9Ii4xMTIxIiBzdHlsZT0icGFpbnQtb3JkZXI6bWFya2VycyBmaWxsIHN0cm9rZSIvPgogPGcgdHJhbnNmb3JtPSJtYXRyaXgoLjI2NDU4IDAgMCAuMjY0NTggMi42MzUgLTIuODgzNCkiIHN0cm9rZS13aWR0aD0iMXB4IiBzdHlsZT0ic2hhcGUtaW5zaWRlOnVybCgjcmVjdDQ4MzYpO3doaXRlLXNwYWNlOnByZSIgYXJpYS1sYWJlbD0iICAgTm8gcGxhbiBjb25maWd1cmVkIj4KICA8cGF0aCBkPSJtMTAxLjY3IDExOC4yOXYyOC40MzhoLTMuNzg5MWwtMTQuMzE2LTIxLjkzNHYyMS45MzRoLTMuNzY5NXYtMjguNDM4aDMuNzY5NWwxNC4zNzUgMjEuOTkydi0yMS45OTJ6Ii8+CiAgPHBhdGggZD0ibTEwNi44MyAxMzUuOTVxMC00LjU4OTggMi41NzgxLTcuNjU2MiAyLjU3ODEtMy4wODU5IDcuMDExNy0zLjA4NTl0Ny4wMTE3IDMuMDI3M3EyLjU3ODEgMy4wMDc4IDIuNjM2NyA3LjUxOTV2MC42NDQ1M3EwIDQuNTg5OC0yLjU5NzcgNy42NTYyLTIuNTc4MSAzLjA2NjQtNy4wMTE3IDMuMDY2NC00LjQ1MzEgMC03LjA1MDgtMy4wNjY0LTIuNTc4MS0zLjA2NjQtMi41NzgxLTcuNjU2MnptMy42MTMzIDAuNDQ5MjJxMCAzLjE0NDUgMS40ODQ0IDUuNDQ5MiAxLjUwMzkgMi4zMDQ3IDQuNTMxMiAyLjMwNDcgMi45NDkyIDAgNC40NTMxLTIuMjY1NiAxLjUwMzktMi4yODUyIDEuNTIzNC01LjQyOTd2LTAuNTA3ODFxMC0zLjEwNTUtMS41MDM5LTUuNDI5Ny0xLjUwMzktMi4zNDM4LTQuNTExNy0yLjM0MzgtMi45ODgzIDAtNC40OTIyIDIuMzQzOC0xLjQ4NDQgMi4zMjQyLTEuNDg0NCA1LjQyOTd6Ii8+CiAgPHBhdGggZD0ibTE1MC4xNyAxNDcuMTJxLTMuODA4NiAwLTYuMDM1Mi0yLjQ0MTR2MTAuMTc2aC0zLjYzMjh2LTI5LjI1OGgzLjMyMDNsMC4xNzU3OCAyLjMyNDJxMi4yMjY2LTIuNzE0OCA2LjExMzMtMi43MTQ4IDQuMDAzOSAwIDYuMTMyOCAyLjk2ODggMi4xMjg5IDIuOTY4OCAyLjEyODkgNy44MTI1djAuNDEwMTZxMCA0LjYyODktMi4xNDg0IDcuNjc1OC0yLjEyODkgMy4wNDY5LTYuMDU0NyAzLjA0Njl6bS0xLjExMzMtMTguODY3cS0zLjI4MTIgMC00LjkyMTkgMi45MTAydjEwLjExN3ExLjY2MDIgMi44NzExIDQuOTYwOSAyLjg3MTEgMi45Mjk3IDAgNC4yNzczLTIuMzA0NyAxLjM2NzItMi4zMDQ3IDEuMzY3Mi01LjQ0OTJ2LTAuNDEwMTZxMC0zLjE0NDUtMS4zNjcyLTUuNDI5Ny0xLjM0NzYtMi4zMDQ3LTQuMzE2NC0yLjMwNDd6Ii8+CiAgPHBhdGggZD0ibTE2Ni45MSAxMTYuNzN2MzBoLTMuNjMyOHYtMzB6Ii8+CiAgPHBhdGggZD0ibTE4NS43NSAxNDYuNzNxLTAuMzUxNTctMC43NjE3Mi0wLjUwNzgyLTIuMjI2Ni0xLjAxNTYgMS4wNzQyLTIuNTM5MSAxLjg1NTUtMS41MjM0IDAuNzYxNzItMy40NzY2IDAuNzYxNzItMy4yNDIyIDAtNS4xOTUzLTEuODE2NC0xLjk1MzEtMS44MTY0LTEuOTUzMS00LjQ1MzEgMC0zLjM5ODQgMi41NzgxLTUuMTU2MiAyLjU3ODEtMS43NzczIDYuOTMzNi0xLjc3NzNoMy41NzQydi0xLjY3OTdxMC0xLjg3NS0xLjEzMjgtMi45ODgzLTEuMTEzMy0xLjEzMjgtMy4zMjAzLTEuMTMyOC0yLjA1MDggMC0zLjMyMDMgMS4wMTU2LTEuMjUgMC45OTYxLTEuMjUgMi4zMjQyaC0zLjYxMzNxMC0yLjI2NTYgMi4yODUyLTQuMjU3OCAyLjI4NTItMS45OTIyIDYuMTEzMy0xLjk5MjIgMy40Mzc1IDAgNS42NDQ1IDEuNzU3OCAyLjIwNyAxLjc1NzggMi4yMDcgNS4zMTI1djkuNDkyMnEwIDIuOTI5NyAwLjc0MjE5IDQuNjQ4NHYwLjMxMjV6bS01Ljk5NjEtMi43NzM0cTEuOTUzMSAwIDMuMzc4OS0wLjk3NjU2IDEuNDQ1My0wLjk3NjU2IDIuMDMxMi0yLjE2OHYtNC4zNTU1aC0zLjM1OTRxLTYuMDkzOCAwLjExNzE5LTYuMDkzOCAzLjkwNjIgMCAxLjUwMzkgMS4wMTU2IDIuNTU4NiAxLjAxNTYgMS4wMzUyIDMuMDI3MyAxLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTIwMy4yMyAxMjguMjVxLTEuNzM4MyAwLTMuMDY2NCAwLjkzNzUtMS4zMjgxIDAuOTM3NS0yLjA4OTggMi40NDE0djE1LjA5OGgtMy42MTMzdi0yMS4xMzNoMy40MThsMC4xMTcxOSAyLjYzNjdxMi40MDIzLTMuMDI3MyA2LjMwODYtMy4wMjczIDMuMTA1NSAwIDQuOTIxOSAxLjczODMgMS44MzU5IDEuNzM4MyAxLjg1NTUgNS44Mzk4djEzLjk0NWgtMy42MzI4di0xMy44ODdxMC0yLjQ4MDUtMS4wOTM4LTMuNTM1Mi0xLjA3NDItMS4wNTQ3LTMuMTI1LTEuMDU0N3oiLz4KICA8cGF0aCBkPSJtNTcuOTQxIDE5NC4xNXExLjkzMzYgMCAzLjM3ODktMS4xNTIzIDEuNDY0OC0xLjE1MjMgMS42MDE2LTIuOTQ5MmgzLjQzNzVxLTAuMTM2NzIgMi44MzItMi41OTc3IDQuOTYwOS0yLjQ2MDkgMi4xMDk0LTUuODIwMyAyLjEwOTQtNC43NjU2IDAtNy4wODk4LTMuMTQ0NS0yLjMwNDctMy4xNDQ1LTIuMzA0Ny03LjQwMjN2LTAuODIwMzFxMC00LjI1NzggMi4zMDQ3LTcuNDAyNCAyLjMyNDItMy4xNDQ1IDcuMDg5OC0zLjE0NDUgMy43MTA5IDAgNS45OTYxIDIuMjA3IDIuMjg1MiAyLjE4NzUgMi40MjE5IDUuNDQ5MmgtMy40Mzc1cS0wLjEzNjcyLTEuOTUzMS0xLjQ4NDQtMy4zMjAzLTEuMzI4MS0xLjM2NzItMy40OTYxLTEuMzY3Mi0yLjIyNjYgMC0zLjQ5NjEgMS4xMzI4LTEuMjUgMS4xMzI4LTEuNzc3MyAyLjg3MTEtMC41MDc4MSAxLjczODMtMC41MDc4MSAzLjU3NDJ2MC44MjAzMXEwIDEuODU1NSAwLjUwNzgxIDMuNTkzOCAwLjUwNzgxIDEuNzM4MyAxLjc1NzggMi44NzExIDEuMjY5NSAxLjExMzMgMy41MTU2IDEuMTEzM3oiLz4KICA8cGF0aCBkPSJtNjkuNDY1IDE4NS45NXEwLTQuNTg5OCAyLjU3ODEtNy42NTYyIDIuNTc4MS0zLjA4NTkgNy4wMTE3LTMuMDg1OSA0LjQzMzYgMCA3LjAxMTcgMy4wMjczIDIuNTc4MSAzLjAwNzggMi42MzY3IDcuNTE5NXYwLjY0NDUzcTAgNC41ODk4LTIuNTk3NyA3LjY1NjItMi41NzgxIDMuMDY2NC03LjAxMTcgMy4wNjY0LTQuNDUzMSAwLTcuMDUwOC0zLjA2NjQtMi41NzgxLTMuMDY2NC0yLjU3ODEtNy42NTYyem0zLjYxMzMgMC40NDkyMnEwIDMuMTQ0NSAxLjQ4NDQgNS40NDkyIDEuNTAzOSAyLjMwNDcgNC41MzEyIDIuMzA0NyAyLjk0OTIgMCA0LjQ1MzEtMi4yNjU2IDEuNTAzOS0yLjI4NTIgMS41MjM0LTUuNDI5N3YtMC41MDc4MXEwLTMuMTA1NS0xLjUwMzktNS40Mjk3LTEuNTAzOS0yLjM0MzgtNC41MTE3LTIuMzQzOC0yLjk4ODMgMC00LjQ5MjIgMi4zNDM4LTEuNDg0NCAyLjMyNDItMS40ODQ0IDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTAyIDE3OC4yNXEtMS43MzgzIDAtMy4wNjY0IDAuOTM3NS0xLjMyODEgMC45Mzc1LTIuMDg5OCAyLjQ0MTR2MTUuMDk4aC0zLjYxMzN2LTIxLjEzM2gzLjQxOGwwLjExNzE5IDIuNjM2N3EyLjQwMjMtMy4wMjczIDYuMzA4Ni0zLjAyNzMgMy4xMDU1IDAgNC45MjE5IDEuNzM4MyAxLjgzNTkgMS43MzgzIDEuODU1NSA1LjgzOTh2MTMuOTQ1aC0zLjYzMjh2LTEzLjg4N3EwLTIuNDgwNS0xLjA5MzgtMy41MzUyLTEuMDc0Mi0xLjA1NDctMy4xMjUtMS4wNTQ3eiIvPgogIDxwYXRoIGQ9Im0xMjQuNDYgMTc4LjM3aC00LjMxNjR2MTguMzU5aC0zLjYxMzN2LTE4LjM1OWgtMy4zMzk4di0yLjc3MzRoMy4zMzk4di0xLjgzNTlxMC0zLjU5MzggMi4wNzAzLTUuNTA3OCAyLjA3MDMtMS45MzM2IDUuNjY0MS0xLjkzMzYgMi4xODc1IDAgNS41MjczIDEuMTkxNGwtMC42MDU0NiAzLjA0NjlxLTIuNTM5MS0wLjk5NjA5LTQuNjY4LTAuOTk2MDktMi4zMjQyIDAtMy4zNTk0IDEuMDU0Ny0xLjAxNTYgMS4wMzUyLTEuMDE1NiAzLjE0NDV2MS44MzU5aDQuMzE2NHptNy4xMDk0LTIuNzczNHYyMS4xMzNoLTMuNjEzM3YtMjEuMTMzeiIvPgogIDxwYXRoIGQ9Im0xNDUuNTIgMjA1LjA3cS0xLjY0MDYgMC00LjAyMzQtMC44MDA3OC0yLjM4MjgtMC44MDA3OC0zLjgwODYtMi44NzExbDEuODk0NS0yLjE0ODRxMi4zNDM4IDIuODUxNiA1LjY2NDEgMi44NTE2IDIuNTU4NiAwIDQuMDgyLTEuNDQ1MyAxLjUyMzQtMS40MjU4IDEuNTIzNC00LjE5OTJ2LTEuODU1NXEtMi4xNDg0IDIuNTE5NS01LjkxOCAyLjUxOTUtMy44MDg2IDAtNi4wNTQ3LTMuMDQ2OS0yLjI0NjEtMy4wNDY5LTIuMjQ2MS03LjY3NTh2LTAuNDEwMTZxMC00Ljg0MzggMi4yMjY2LTcuODEyNSAyLjI0NjEtMi45Njg4IDYuMTEzMy0yLjk2ODggMy44ODY3IDAgNi4wMzUyIDIuNzM0NGwwLjE3NTc4LTIuMzQzOGgzLjI4MTJ2MjAuNjg0cTAgNC4xOTkyLTIuNSA2LjQ4NDQtMi41IDIuMzA0Ny02LjQ0NTMgMi4zMDQ3em0tNS4yNzM0LTE4LjY3MnEwIDMuMTQ0NSAxLjMwODYgNS40MTAyIDEuMzI4MSAyLjI0NjEgNC4yNTc4IDIuMjQ2MSAzLjQzNzUgMCA1LjAzOTEtMy4xMjV2LTkuNjI4OXEtMC42ODM1OS0xLjMwODYtMS44OTQ1LTIuMTY4LTEuMjEwOS0wLjg3ODktMy4xMDU1LTAuODc4OS0yLjk0OTIgMC00LjI3NzMgMi4zMDQ3LTEuMzI4MSAyLjI4NTItMS4zMjgxIDUuNDI5N3oiLz4KICA8cGF0aCBkPSJtMTczLjA2IDE5Ni43My0wLjA3ODEtMi4wODk4cS0yLjA3MDMgMi40ODA1LTYuMTcxOSAyLjQ4MDUtMy4xMDU1IDAtNS4wMTk1LTEuODM1OS0xLjkxNDEtMS44MzU5LTEuOTE0MS02LjA1NDd2LTEzLjYzM2gzLjYxMzN2MTMuNjcycTAgMi44NTE2IDEuMTkxNCAzLjgyODEgMS4yMTA5IDAuOTU3MDMgMi42OTUzIDAuOTU3MDMgNC4wODIgMCA1LjUwNzgtMy4wNjY0di0xNS4zOTFoMy42MzI4djIxLjEzM3oiLz4KICA8cGF0aCBkPSJtMTkwLjQ0IDE3OC42OHEtMy41MzUyIDAtNC44MjQyIDMuMDQ2OXYxNWgtMy42MTMzdi0yMS4xMzNoMy41MTU2bDAuMDc4MSAyLjQyMTlxMS43MzgzLTIuODEyNSA1LjAxOTUtMi44MTI1IDEuMDE1NiAwIDEuNjAxNiAwLjI3MzQ0bC0wLjAxOTUgMy4zNTk0cS0wLjgwMDc4LTAuMTU2MjUtMS43NTc4LTAuMTU2MjV6Ii8+CiAgPHBhdGggZD0ibTIxMS45MSAxOTMuMDRxLTEuMDM1MiAxLjU2MjUtMi45Mjk3IDIuODMyLTEuODk0NSAxLjI1LTUuMDE5NSAxLjI1LTQuNDE0MSAwLTcuMDcwMy0yLjg3MTEtMi42MzY3LTIuODcxMS0yLjYzNjctNy4zNDM4di0wLjgyMDMxcTAtMy40NTcgMS4zMDg2LTUuODc4OSAxLjMyODEtMi40NDE0IDMuNDM3NS0zLjcxMDkgMi4xMDk0LTEuMjg5MSA0LjQ5MjItMS4yODkxIDQuNTMxMiAwIDYuNjAxNiAyLjk2ODggMi4wODk4IDIuOTQ5MiAyLjA4OTggNy4zODI4djEuNjIxMWgtMTQuMjk3cTAuMDc4MSAyLjkxMDIgMS43MTg4IDQuOTYwOSAxLjY2MDIgMi4wMzEyIDQuNTUwOCAyLjAzMTIgMS45MTQxIDAgMy4yNDIyLTAuNzgxMjUgMS4zMjgxLTAuNzgxMjUgMi4zMjQyLTIuMDg5OHptLTguNDE4LTE0Ljg2M3EtMi4xNDg0IDAtMy42MzI4IDEuNTYyNS0xLjQ4NDQgMS41NjI1LTEuODU1NSA0LjQ5MjJoMTAuNTY2di0wLjI3MzQ0cS0wLjEzNjcyLTIuMTA5NC0xLjIzMDUtMy45NDUzLTEuMDc0Mi0xLjgzNTktMy44NDc3LTEuODM1OXoiLz4KICA8cGF0aCBkPSJtMjMwLjAzIDE5Ni43My0wLjE3NTc4LTIuMjY1NnEtMi4xNjggMi42NTYyLTYuMDM1MiAyLjY1NjItMy43MTA5IDAtNS45OTYxLTMuMDA3OC0yLjI4NTItMy4wMDc4LTIuMzI0Mi03LjU1ODZ2LTAuNTY2NDFxMC00Ljg0MzggMi4yODUyLTcuODEyNSAyLjMwNDctMi45Njg4IDYuMDc0Mi0yLjk2ODggMy43MzA1IDAgNS44NTk0IDIuNXYtMTAuOTc3aDMuNjMyOHYzMHptLTEwLjg5OC0xMC4zMzJxMCAzLjE0NDUgMS4zMjgxIDUuNDEwMiAxLjMyODEgMi4yNDYxIDQuMjU3OCAyLjI0NjEgMy4zNTk0IDAgNS0zLjA2NjR2LTkuNzI2NnEtMS42MjExLTMuMDA3OC00Ljk2MDktMy4wMDc4LTIuOTQ5MiAwLTQuMjk2OSAyLjMwNDctMS4zMjgxIDIuMjg1Mi0xLjMyODEgNS40Mjk3eiIvPgogPC9nPgo8L3N2Zz4K'\n            }\n        ];\n        return attributeService.saveEntityAttributes(\n            entityId, \"SERVER_SCOPE\", attributesArray);\n    }\n}",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "e965b8a1-a6ac-5ae4-fd79-2b7220b91ed1"
              }
            ]
          },
          "showTitleIcon": false,
          "titleTooltip": "",
          "enableDataExport": false,
          "widgetStyle": {},
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "displayTimewindow": true,
          "pageSize": 1024,
          "configMode": "advanced",
          "titleFont": null,
          "titleColor": null,
          "titleIcon": null,
          "iconColor": null
        },
        "row": 0,
        "col": 0,
        "id": "7abc3362-5ae6-3da5-cfc1-3fc4cd8db230",
        "typeFullFqn": "system.cards.entities_table"
      },
      "d7ea3d50-1015-96d2-cee3-535aaf923958": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": null,
              "entityAliasId": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
              "filterId": null,
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1678197897861,
                "endTimeMs": 1678284297861
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 25000
            }
          },
          "showTitle": true,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "<div class=\"main-layout\" style=\"width: 100%; height: 100%;\" fxLayout=\"column\">\n<!--    <tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex=\"10\" stateId='edit_title'></tb-dashboard-state>\n    <tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex=\"10\" stateId='edit_label'></tb-dashboard-state>-->\n    <tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex=\"100\" stateId='edit_measurement_alias'></tb-dashboard-state>\n    <!--<tb-dashboard-state [ctx]=\"ctx\" [syncParentStateParams]=\"true\" fxFlex=\"20\" stateId='edit_measurement_plan'></tb-dashboard-state>-->\n</div>",
            "markdownTextFunction": "return '# Some title\\\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": false,
            "markdownCss": ".tb-markdown-view .tb-progress-cover, .tb-markdown-view .mat-drawer-container {\n    background-color: #fff;\n}\n.tb-markdown-view div, .tb-markdown-view p {\n    line-height: normal;\n}\n\n.tb-markdown-view .mat-toolbar.mat-primary div {\n    color: var(--tb-primary-contrast-500);\n}\n"
          },
          "title": "Edit Measurement",
          "showTitleIcon": false,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "font-size": "26px",
            "padding-bottom": "16px",
            "padding-left": "10px",
            "padding-top": "5px",
            "font-weight": "500"
          },
          "showLegend": false,
          "enableDataExport": false,
          "widgetCss": "",
          "noDataDisplayMessage": "",
          "actions": {
            "elementClick": [
              {
                "name": "save-title",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "const targetElement = $($event.target).closest('#save-title', widgetContext.$container[0]);\n\nvar title = $(targetElement).attr('data-title');\n\nwidgetContext.assetService.getAsset(entityId.id, {ignoreLoading: true}).subscribe((Measurement) => {\n    Measurement.name = title;\n    widgetContext.assetService.saveAsset(Measurement, null, {ignoreLoading: true}).subscribe(() => {\n       var stateParams = widgetContext.stateController.getStateParams();\n       stateParams.selectedMeasurement.entityName = title;\n       widgetContext.stateController.updateState(null, stateParams);\n       /*if (widgetContext.parentDashboard) {\n           widgetContext.parentDashboard.aliasController.updateAliases();\n       }\n       widgetContext.updateAliases();*/\n    });\n});\n",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "088a4799-8551-7ab4-892f-2a08d6d40a7c"
              }
            ],
            "headerButton": [
              {
                "name": "Go back",
                "icon": "arrow_back",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\nparams['selectedMeasurement'] = null;\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f391e279-5095-d69f-7420-1cd0102329e9"
              },
              {
                "name": "Add Devices",
                "icon": "add",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addDeviceFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 800px;\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Add device</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-horizontal-stepper formGroupName=\"stepper\" linear>\r\n      <mat-step formGroupName=\"assignmentStep\" label=\"Assignment\">\r\n        <ng-template matStepLabel>Assignment</ng-template>\r\n        <fieldset *ngIf=\"pFlowLimit || CO2Limit\" class=\"fieldset\" style=\"margin-bottom: 16px;\">\r\n            <div  fxLayout=\"column\" fxLayoutAlign=\"start start\" style=\"padding-top: 10px; padding-bottom: 10px;\">\r\n                <div fxLayout=\"row\" fxLayoutAlign=\"start center\" style=\"align-items: center;\">\r\n                    <mat-icon *ngIf=\"pFlowLimit\" style=\"margin-right: 8px;\">info</mat-icon>\r\n                    <p *ngIf=\"pFlowLimit\" style=\"font-size: 15px; margin: 0;\">You have reached the maximum Limit of P-Flows.</p>\r\n                </div>\r\n                <div fxLayout=\"row\" fxLayoutAlign=\"start center\" style=\"align-items: center;\">\r\n                    <mat-icon *ngIf=\"CO2Limit\" style=\"margin-right: 8px;\">info</mat-icon>\r\n                    <p *ngIf=\"CO2Limit\" style=\"font-size: 15px; margin: 0;\">You have reached the maximum Limit of CO2 Room Sensors.</p>\r\n                </div>\r\n            </div>\r\n        </fieldset>\r\n\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Device</mat-label>\r\n          <mat-select formControlName=\"device\" required>\r\n            <mat-select-trigger>\r\n              <div class=\"device-item\" fxLayout=\"column\" fxLayoutGap=\"4px\">\r\n                <!-- First Row: Device Name -->\r\n                <div fxLayout=\"row\">\r\n                  <div>{{ addDeviceFormGroup.get('stepper.assignmentStep.device').value?.name }}</div>\r\n                </div>\r\n                <!-- Second Row: Device Type on Left, Label on Right -->\r\n                <div fxLayout=\"row\" fxLayoutAlign=\"space-between center\">\r\n                  <div class=\"device-type\">{{ addDeviceFormGroup.get('stepper.assignmentStep.device').value?.type }}</div>\r\n                  <div class=\"device-label\">{{ addDeviceFormGroup.get('stepper.assignmentStep.device').value?.label }}</div>\r\n                </div>\r\n              </div>\r\n            </mat-select-trigger>\r\n\r\n            <mat-option *ngFor=\"let device of availableDevices\" [value]=\"device\">\r\n              <div class=\"device-item\" fxLayout=\"column\" fxLayoutGap=\"4px\">\r\n                <div fxLayout=\"row\">\r\n                  <div>{{ device?.name }}</div>\r\n                </div>\r\n                <div fxLayout=\"row\" fxLayoutAlign=\"space-between center\">\r\n                  <div class=\"device-type\">{{ device?.type }}</div>\r\n                  <div class=\"device-name\">{{ device?.label }}</div>\r\n                </div>\r\n              </div>\r\n              <mat-divider></mat-divider>\r\n            </mat-option>\r\n\r\n            <mat-option *ngIf=\"!availableDevices?.length\" disabled [value]=\"null\">\r\n              <div class=\"device-item\">\r\n                No devices available\r\n              </div>\r\n            </mat-option>\r\n          </mat-select>\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.device').hasError('required')\">\r\n            Device is required.\r\n          </mat-error>\r\n        </mat-form-field>\r\n\r\n        <!-- Label Input Field -->\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Label</mat-label>\r\n          <input matInput formControlName=\"label\">\r\n          <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.assignmentStep.label').hasError('required')\">\r\n            Device label is required.\r\n          </mat-error>\r\n        </mat-form-field>\r\n\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\"\r\n                  type=\"button\"\r\n                  [disabled]=\"(isLoading$ | async)\"\r\n                  (click)=\"cancel()\" cdkFocusInitial>\r\n            Cancel\r\n          </button>\r\n          <button mat-button mat-raised-button color=\"primary\"\r\n                  type=\"submit\"\r\n                  [disabled]=\"(isLoading$ | async) || addDeviceFormGroup.invalid\">\r\n            Save\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>\r\n",
                "customCss": ".fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.device-item {\n    line-height: 24px;\n    width: 100%;\n    padding-top: 8px;\n    padding-bottom: 8px;\n}\n\n.device-item .device-name {\n    font-size: 12px;\n    opacity: 0.7;\n}\n\n.device-item .device-type {\n    font-size: 14px;\n    opacity: 0.7;\n}\n\nmat-option {\n    height: auto !important;\n    white-space: normal !important;\n}\n\n.mat-select-value-text {\n    display: block;\n    width: 100%;\n}",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\n\r\nconst measurementId = widgetContext.stateController.getStateParams()?.selectedMeasurement?.entityId;\r\n\r\nif (!measurementId || !measurementId.id) {\r\n    console.error(\"Invalid measurementId:\", measurementId);\r\n} else {\r\n    checkAssignedDevices(measurementId.id);\r\n}\r\n\r\nfunction checkAssignedDevices(measurementId) {\r\n    const deviceSearchQuery = {\r\n        parameters: {\r\n            rootId: measurementId,\r\n            rootType: \"ASSET\",\r\n            direction: \"FROM\",\r\n            relationTypeGroup: \"COMMON\",\r\n            maxLevel: 100,\r\n            fetchLastLevelOnly: false,\r\n        },\r\n        relationType: \"Measurement\",\r\n        deviceTypes: [\"P-Flow D116\", \"Room Sensor CO2\", \"Temperature Sensor\"]\r\n    };\r\n\r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n        (devices) => {\r\n            let maxLimitPFlows = false;\r\n            let maxLimitRoomSensorCO2 = false;\r\n\r\n            const pFlows = devices.filter(device => device.type === \"P-Flow D116\");\r\n            const roomSensorCO2 = devices.filter(device => device.type === \"Room Sensor CO2\");\r\n\r\n            if (pFlows.length > 0) {\r\n                maxLimitPFlows = true;\r\n            }\r\n            if (roomSensorCO2.length > 99) {\r\n                maxLimitRoomSensorCO2 = true;\r\n            }\r\n\r\n            openAddDeviceDialog(maxLimitPFlows, maxLimitRoomSensorCO2);\r\n        },\r\n        (error) => {\r\n            console.error(\"Error fetching devices:\", error);\r\n            openAddDeviceDialog(false, false);\r\n        }\r\n    );\r\n}\r\n\r\nfunction openAddDeviceDialog(maxLimitPFlows, maxLimitRoomSensorCO2) {\r\n    customDialog.customDialog(htmlTemplate, AddDeviceDialogController, {\r\n        measurementId,\r\n        maxLimitPFlows,\r\n        maxLimitRoomSensorCO2,\r\n    }).subscribe();\r\n}\r\n\r\nfunction AddDeviceDialogController(instance) {\r\n    let vm = instance;\r\n    const {\r\n        measurementId,\r\n        maxLimitPFlows,\r\n        maxLimitRoomSensorCO2,\r\n    } = vm.data || {};\r\n\r\n    vm.pFlowLimit = !!maxLimitPFlows;\r\n    vm.CO2Limit = !!maxLimitRoomSensorCO2;\r\n\r\n    vm.addDeviceFormGroup = vm.fb.group({\r\n        stepper: vm.fb.group({\r\n            assignmentStep: vm.fb.group({\r\n                device: [null, [vm.validators.required]],\r\n                label: [{ value: null, disabled: false }]\r\n            }),\r\n        })\r\n    });\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        var measurementId = widgetContext.stateController.getStateParams().selectedMeasurement.entityId;\r\n        vm.addDeviceFormGroup.markAsPristine();\r\n        var device = vm.addDeviceFormGroup.value.stepper.assignmentStep.device;\r\n        var label = vm.addDeviceFormGroup.value.stepper.assignmentStep.label;\r\n        var deviceId = device.deviceId;\r\n\r\n        widgetContext.rxjs.forkJoin([\r\n            entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n            saveDeviceToMeasurementRelation(measurementId, deviceId),\r\n            saveAttributes(deviceId),\r\n            updateDeviceLabel(device, label)\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedDevicesGroup = null;\r\n        vm.assignedDevicesGroup = null;\r\n        vm.availableDevices = [];\r\n        vm.assignedDevices = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'DEVICE').subscribe((entityGroups) => {\r\n            vm.customerDevicesGroups = entityGroups;\r\n            vm.unassignedDevicesGroup = entityGroups.find(group => group.name === 'Unassigned Measurement Devices');\r\n            vm.assignedDevicesGroup = entityGroups.find(group => group.name === 'Measurement Devices');\r\n\r\n            if (vm.unassignedDevicesGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.unassignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 1000,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    //console.log(\"data\",data);\r\n                    vm.availableDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value,\r\n                            deviceId: entityData.entityId\r\n                        };\r\n                    });\r\n                    //console.log(\"avail\",vm.availableDevices);\r\n                    // Apply filters based on limits\r\n                    if (maxLimitPFlows === true) {\r\n                        vm.availableDevices = vm.availableDevices.filter(device => device.type !== \"P-Flow D116\");\r\n                    }\r\n                    if (maxLimitRoomSensorCO2 === true) {\r\n                        vm.availableDevices = vm.availableDevices.filter(device => device.type !== \"Room Sensor CO2\");\r\n                    }\r\n\r\n                    // Custom sorting based on hexadecimal IDs\r\n                    vm.availableDevices.sort(function (a, b) {\r\n                        const hexPattern = /^ECO_([0-9A-Fa-f]{8})/;\r\n\r\n                        const matchA = a.name.match(hexPattern);\r\n                        const matchB = b.name.match(hexPattern);\r\n\r\n                        if (matchA && matchB) {\r\n                            const hexA = matchA[1];\r\n                            const hexB = matchB[1];\r\n\r\n                            const numA = parseInt(hexA, 16);\r\n                            const numB = parseInt(hexB, 16);\r\n\r\n                            return numA - numB;\r\n                        } else {\r\n                            // Fallback to string comparison if pattern doesn't match\r\n                            return a.name.localeCompare(b.name);\r\n                        }\r\n                    });\r\n\r\n                    // Optional: Log the sorted device names for verification\r\n                    // console.log('Sorted Device Names:', vm.availableDevices.map(device => device.name));\r\n                });\r\n\r\n            }\r\n\r\n            if (vm.assignedDevicesGroup) {\r\n                var query2 = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'DEVICE',\r\n                        entityGroup: vm.assignedDevicesGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query2).subscribe((data) => {\r\n                    vm.assignedDevices = data.data.map((entityData) => {\r\n                        return {\r\n                            deviceId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                    // Handle additional parameters if needed\r\n                    if (additionalParams && (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Device\")) {\r\n                        checkAdditionalParams();\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    function saveAttributes(deviceId) {\r\n        const attributesArray = [\r\n            { key: \"xPos\", value: \"0\" },\r\n            { key: \"yPos\", value: \"0\" }\r\n        ];\r\n        return attributeService.saveEntityAttributes(deviceId, 'SERVER_SCOPE', attributesArray);\r\n    }\r\n\r\n    function saveDeviceToMeasurementRelation(measurementId, deviceId) {\r\n        var relation = {\r\n            from: measurementId,\r\n            to: deviceId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Measurement'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function updateDeviceLabel(device, label) {\r\n        if (device.label !== label) {\r\n            return deviceService.getDevice(device.deviceId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origDevice) => {\r\n                    origDevice.label = label;\r\n                    return deviceService.saveDevice(origDevice);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableDevice = vm.availableDevices.find(device => device.name === additionalParams.code);\r\n        const matchingAssignedDevice = vm.assignedDevices.find(device => device.name === additionalParams.code);\r\n\r\n        if (!matchingAvailableDevice && !matchingAssignedDevice) {\r\n            widgetContext.dialogs.alert(\"Device doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedDevice && !matchingAvailableDevice) {\r\n            getMeasurement(additionalParams.code);\r\n        }\r\n        if (matchingAvailableDevice && matchingAssignedDevice) {\r\n            vm.addDeviceFormGroup.patchValue({ stepper: { assignmentStep: { device: matchingAvailableDevice } } }, { emitEvent: false });\r\n            vm.addDeviceFormGroup.get('stepper.assignmentStep.device').markAsDirty();\r\n            vm.addDeviceFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('mat-select[formControlName=\"device\"]');\r\n                if (selectElement) {\r\n                    selectElement.dispatchEvent(new Event('change'));\r\n                }\r\n\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n\r\n    function getMeasurement(code) {\r\n        vm.deviceEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToMeasurement = null;\r\n\r\n        deviceService.findByName(code)\r\n            .pipe(\r\n                widgetContext.rxjs.map((origDevice) => {\r\n                    vm.deviceEntityId = origDevice.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.deviceEntityId, 'entityType': 'DEVICE' }).pipe(\r\n                    widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations).pipe(\r\n                        widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToMeasurement = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-device\");\r\n                        let params = {\r\n                            \"measurement\": vm.assignedToMeasurement,\r\n                            \"device\": vm.deviceEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "26feafc8-21d5-484c-979b-5dff1a5d69bb"
              },
              {
                "name": "Add Devices old",
                "icon": "add",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "customPretty",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addKitFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 800px;\">\r\n\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Add Kit</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div  mat-dialog-content fxLayout=\"column\">\r\n    <div *ngIf = \"kitAlreadyAssigned\" fxLayout=\"row\" fxLayoutAlign=\"start center\" style=\"align-items: center;\">\r\n        <mat-icon style=\"margin-right: 8px;\">info</mat-icon>\r\n        <p style=\"font-size: 20px; margin: 0;\">A Kit has already been assigned to this measurement.</p>\r\n    </div>\r\n    <mat-form-field *ngIf = \"!kitAlreadyAssigned\" class=\"mat-block\">\r\n      <mat-label>Kit</mat-label>\r\n      <mat-select formControlName=\"kit\" required>\r\n        <mat-select-trigger>\r\n          <div class=\"kit-item\" fxLayout=\"row\">\r\n            <div fxLayout=\"column\" fxFlex>\r\n              <div>{{addKitFormGroup.get('kit').value?.label}}</div>\r\n              <div class=\"kit-name\">{{addKitFormGroup.get('kit').value?.name}}</div>\r\n            </div>\r\n            <div class=\"kit-type\">{{addKitFormGroup.get('kit').value?.type}}</div>\r\n          </div>\r\n        </mat-select-trigger>\r\n        <mat-option *ngFor=\"let kit of availableKit\" [value]=\"kit\">\r\n          <div class=\"kit-item\" fxLayout=\"row\">\r\n            <div fxLayout=\"column\" fxFlex>\r\n              <div>{{kit?.label}}</div>\r\n              <div class=\"kit-name\">{{kit?.name}}</div>\r\n            </div>\r\n            <div class=\"kit-type\">{{kit?.type}}</div>\r\n          </div>\r\n          <mat-divider></mat-divider>\r\n        </mat-option>\r\n        <mat-option *ngIf=\"!availableKit?.length\" disabled [value]=\"null\">\r\n          <div class=\"kit-item\">No kits available</div>\r\n        </mat-option>\r\n      </mat-select>\r\n      <mat-error *ngIf=\"addKitFormGroup.get('kit').hasError('required')\">\r\n        Kit is required.\r\n      </mat-error>\r\n    </mat-form-field>\r\n\r\n    <mat-form-field *ngIf = \"!kitAlreadyAssigned\" class=\"mat-block\">\r\n      <mat-label>Label</mat-label>\r\n      <input matInput formControlName=\"label\">\r\n      <mat-error *ngIf=\"addKitFormGroup.get('label').hasError('required')\">\r\n        Kit label is required.\r\n      </mat-error>\r\n    </mat-form-field>\r\n\r\n    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n      <button mat-button color=\"primary\"\r\n              type=\"button\"\r\n              [disabled]=\"(isLoading$ | async)\"\r\n              (click)=\"cancel()\" cdkFocusInitial>\r\n        Cancel\r\n      </button>\r\n      <button *ngIf = \"!kitAlreadyAssigned\" mat-button color=\"primary\" type=\"submit\">\r\n        Save\r\n      </button>\r\n    </div>\r\n  </div>\r\n</form>\r\n",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\n\r\nconst measurementId = widgetContext.stateController.getStateParams()?.selectedMeasurement?.entityId;\r\n\r\nif (!measurementId || !measurementId.id) {\r\n    console.error(\"Ungültige measurementId:\", measurementId);\r\n} else {\r\n    fetchAssignedAssets(measurementId.id);\r\n}\r\n\r\nfunction fetchAssignedAssets(measurementId) {\r\n    const assetSearchQuery = {\r\n        parameters: {\r\n            rootId: measurementId,\r\n            rootType: \"ASSET\",\r\n            direction: \"FROM\",\r\n            relationTypeGroup: \"COMMON\",\r\n            maxLevel: 100,\r\n            fetchLastLevelOnly: false,\r\n        },\r\n        relationType: \"Owns\",\r\n        assetTypes: [\"Doktorkit\"],\r\n    };\r\n\r\n    assetService.findByQuery(assetSearchQuery).subscribe(\r\n        (doktorkits) => {\r\n            let assignedDoktorkitName = 'No Kit assigned!';\r\n            let doktorkitId = null;\r\n\r\n            if (doktorkits.length > 0) {\r\n                const assignedDoktorkit = doktorkits[0];\r\n                assignedDoktorkitName = assignedDoktorkit?.name || 'No Kit assigned!';\r\n                doktorkitId = assignedDoktorkit?.id?.id || null;\r\n            }\r\n        openAddKitDialog(assignedDoktorkitName);\r\n        },\r\n        (error) => {\r\n            console.error(\"Fehler beim Abrufen des Doktorkits:\", error);\r\n            fetchAttributes('No Kit assigned!', 'No P-Flow assigned!');\r\n        }\r\n    );\r\n}\r\n/*if (additionalParams.source === \"replace Kit\") {\r\n    if (additionalParams.choice === true) {\r\n        openAddKitDialog();\r\n    } else {\r\n        // Handle other cases if needed\r\n    }\r\n} else if (additionalParams.source !== \"replace Kit\") {\r\n    openAddKitDialog();\r\n}*/\r\n\r\nfunction openAddKitDialog(assignedDoktorkitName) {\r\n    customDialog.customDialog(htmlTemplate, AddKitDialogController, {\r\n        measurementId,\r\n        assignedDoktorkitName,\r\n    }).subscribe();\r\n}\r\n\r\nfunction AddKitDialogController(instance) {\r\n    let vm = instance;\r\n    const {\r\n        measurementId,\r\n        assignedDoktorkitName,\r\n    } = vm.data || {};\r\n    \r\n    \r\n    vm.measurementId = measurementId;\r\n    \r\n    if(assignedDoktorkitName !== 'No Kit assigned!') {\r\n        vm.kitAlreadyAssigned = true;\r\n    } else if (assignedDoktorkitName === 'No Kit assigned!') {\r\n        vm.kitAlreadyAssigned = false;\r\n    }\r\n    \r\n    console.log(\"Kit assigned:\", vm.kitAlreadyAssigned);\r\n    \r\n    vm.addKitFormGroup = vm.fb.group({\r\n        kit: [null, [vm.validators.required]],\r\n        label: [{ value: null, disabled: true }]\r\n    });\r\n\r\n    vm.addKitFormGroup.get('kit').valueChanges.subscribe((kit) => {\r\n        vm.addKitFormGroup.get('label').patchValue(kit.label, { emitEvent: false });\r\n        vm.addKitFormGroup.get('label').enable({ emitEvent: false });\r\n        vm.addKitFormGroup.get('label').updateValueAndValidity({ onlySelf: true });\r\n    });\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        var MeasurementId = widgetContext.stateController.getStateParams().selectedMeasurement.entityId;\r\n        vm.addKitFormGroup.markAsPristine();\r\n        var kit = vm.addKitFormGroup.value.kit;\r\n        var label = vm.addKitFormGroup.value.label;\r\n        var kitId = kit.kitId;\r\n        \r\n        widgetContext.rxjs.forkJoin([\r\n            entityGroupService.removeEntityFromEntityGroup(vm.unassignedKitGroup.id.id, kitId.id),\r\n            saveKitToMeasurementRelation(MeasurementId, kitId),\r\n            updateKitLabel(kit, label)\r\n        ]).subscribe(() => {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n        });\r\n    };\r\n\r\n    init();\r\n\r\n    function init() {\r\n        vm.unassignedKitGroup = null;\r\n        vm.availableKit = [];\r\n\r\n        if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n            vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n        } else {\r\n            vm.customerId = {\r\n                id: widgetContext.currentUser.customerId,\r\n                entityType: 'CUSTOMER'\r\n            };\r\n        }\r\n        entityGroupService.getEntityGroupsByOwnerId(vm.customerId.entityType, vm.customerId.id, 'ASSET').subscribe((entityGroups) => {\r\n            vm.unassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n            if (vm.unassignedKitGroup) {\r\n                var query = {\r\n                    entityFilter: {\r\n                        type: 'entityGroup',\r\n                        groupType: 'ASSET',\r\n                        entityGroup: vm.unassignedKitGroup.id.id\r\n                    },\r\n                    pageLink: {\r\n                        pageSize: 100,\r\n                        page: 0\r\n                    },\r\n                    entityFields: [\r\n                        { key: 'name', type: 'ENTITY_FIELD' },\r\n                        { key: 'type', type: 'ENTITY_FIELD' },\r\n                        { key: 'label', type: 'ENTITY_FIELD' }\r\n                    ]\r\n                };\r\n                entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n                    vm.availableKit = data.data.map((entityData) => {\r\n                        return {\r\n                            kitId: entityData.entityId,\r\n                            name: entityData.latest[\"ENTITY_FIELD\"].name.value,\r\n                            type: entityData.latest[\"ENTITY_FIELD\"].type.value,\r\n                            label: entityData.latest[\"ENTITY_FIELD\"].label.value\r\n                        };\r\n                    });\r\n                });\r\n            }\r\n            if (additionalParams.source === \"qrcode\" || additionalParams.source === \"replace Kit\") {\r\n                checkAdditionalParams();\r\n            }\r\n        });\r\n    }\r\n\r\n    function saveKitToMeasurementRelation(MeasurementId, KitId) {\r\n        var relation = {\r\n            from: MeasurementId,\r\n            to: KitId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Owns'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function updateKitLabel(kit, label) {\r\n        if (kit.label !== label) {\r\n            return deviceService.getDevice(kit.kitId.id).pipe(\r\n                widgetContext.rxjs.switchMap((origKit) => {\r\n                    origKit.label = label;\r\n                    return deviceService.saveDevice(origKit);\r\n                })\r\n            );\r\n        } else {\r\n            return widgetContext.rxjs.of(null);\r\n        }\r\n    }\r\n\r\n    function checkAdditionalParams() {\r\n        const matchingAvailableKit = vm.availableKit.find(kit => kit.name === additionalParams.code);\r\n        const matchingAssignedKit = vm.assignedKits.find(kit => kit.name === additionalParams.code);\r\n\r\n        if (!matchingAvailableKit && !matchingAssignedKit) {\r\n            widgetContext.dialogs.alert(\"Kit doesn't exist\").subscribe();\r\n        }\r\n        if (matchingAssignedKit && !matchingAvailableKit) {\r\n            getMeasurement(additionalParams.code);\r\n        }\r\n        if (matchingAvailableKit && matchingAssignedKit) {\r\n            vm.addKitFormGroup.patchValue({ kit: matchingAvailableKit }, { emitEvent: false });\r\n            vm.addKitFormGroup.get('kit').markAsDirty();\r\n            vm.addKitFormGroup.updateValueAndValidity();\r\n            setTimeout(() => {\r\n                const selectElement = document.querySelector('mat-select[formControlName=\"kit\"]');\r\n                if (selectElement) {\r\n                    selectElement.dispatchEvent(new Event('change'));\r\n                }\r\n                if (!vm.changeDetectorRef) {\r\n                    vm.changeDetectorRef = widgetContext.$scope.$injector.get('$rootScope').$root.$$childHead;\r\n                }\r\n                vm.changeDetectorRef.$applyAsync();\r\n            });\r\n        }\r\n    }\r\n    \r\n    function getMeasurement(code) {\r\n        vm.kitEntityId = null;\r\n        vm.relations = null;\r\n        vm.assignedToMeasurement = null;\r\n\r\n        deviceService.findByName(code)\r\n            .pipe(\r\n                widgetContext.rxjs.map((origKit) => {\r\n                    vm.kitEntityId = origKit.id.id;\r\n                })\r\n            ).subscribe(() => {\r\n                entityRelationService.findByTo({ 'id': vm.kitEntityId, 'entityType': 'ASSET' }).pipe(\r\n                    widgetContext.rxjs.map((origRelation) => {\r\n                        vm.relations = origRelation[0].from.id;\r\n                    })\r\n                ).subscribe(() => {\r\n                    assetService.getAsset(vm.relations).pipe(\r\n                        widgetContext.rxjs.map((origAsset) => {\r\n                            vm.assignedToMeasurement = origAsset.name;\r\n                        })\r\n                    ).subscribe(() => {\r\n                        let actionDescriptors = widgetContext.actionsApi.getActionDescriptors(\"elementClick\");\r\n                        let qrCodeActionDescriptor = actionDescriptors.find(descriptor => descriptor.name === \"replace-kit\");\r\n                        let params = {\r\n                            \"measurement\": vm.assignedToMeasurement,\r\n                            \"kit\": vm.kitEntityId,\r\n                            \"code\": additionalParams.code\r\n                        };\r\n                        try {\r\n                            vm.dialogRef.close(null);\r\n                            widgetContext.actionsApi.handleWidgetAction({}, qrCodeActionDescriptor, null, null, params);\r\n                        } catch (error) {\r\n                            widgetContext.dialogs.alert('Error handling widget action:', error);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n    }\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "27e85395-7e91-0ff2-68ae-ccf6d56e7c24"
              },
              {
                "name": "Measurement Parameters",
                "icon": "settings",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "customPretty",
                "customHtml": "<form [formGroup]=\"addDeviceFormGroup\" (ngSubmit)=\"save()\" class=\"add-entity-form\">\r\n  <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n    <h2>Edit Measurement Parameters</h2>\r\n    <span fxFlex></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n\r\n  <div mat-dialog-content fxLayout=\"column\">\r\n    <mat-horizontal-stepper formGroupName=\"stepper\" linear>\r\n\r\n      <mat-step formGroupName=\"assignmentStep\" label=\"Assignment\">\r\n        <ng-template matStepLabel>Assignment</ng-template>\r\n\r\n       <mat-form-field appearance=\"fill\" floatLabel=\"always\" class=\"mat-block\">\r\n  <mat-label>Assigned Devices</mat-label>\r\n  \r\n  <!-- Conditionally apply 'margin-top' and 'gap' only when assignedDevices exist -->\r\n  <mat-chip-list\r\n    #chipList\r\n    aria-label=\"Assigned Devices\"\r\n    [ngStyle]=\"{\r\n      'display': 'flex',\r\n      'flex-wrap': 'wrap',\r\n      'gap': assignedDevices?.length ? '8px' : '0px',\r\n      'margin-top': assignedDevices?.length ? '8px' : '0px'\r\n    }\"\r\n  >\r\n    <mat-chip\r\n      *ngFor=\"let dev of assignedDevices\"\r\n      color=\"primary\"\r\n      selected=\"true\"\r\n      selectable=\"false\"\r\n      removable=\"false\"\r\n    >\r\n      {{ dev.name }}\r\n    </mat-chip>\r\n  </mat-chip-list>\r\n\r\n  <input\r\n    matInput\r\n    [matChipInputFor]=\"chipList\"\r\n    readonly\r\n    [placeholder]=\"assignedDevices?.length ? '' : 'No devices assigned!'\"\r\n  />\r\n\r\n  <mat-error *ngIf=\"!assignedDevices?.length\">\r\n    No devices assigned!\r\n  </mat-error>\r\n</mat-form-field>\r\n\r\n\r\n        <mat-form-field class=\"mat-block\">\r\n          <mat-label>Progress</mat-label>\r\n          <mat-select formControlName=\"progress\">\r\n            <mat-option value=\"in preparation\">In Preparation</mat-option>\r\n            <mat-option value=\"active\">Active</mat-option>\r\n            <mat-option value=\"finished\">Finished</mat-option>\r\n            <mat-option value=\"aborted\">Aborted</mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n\r\n        <section fxLayout=\"row\" fxLayoutAlign=\"center center\" fxLayoutGap=\"16px\" style=\"width: 100%;\">\r\n          <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\r\n            <mat-label>Start Date</mat-label>\r\n            <mat-datetimepicker-toggle [for]=\"startDatePicker\" matPrefix></mat-datetimepicker-toggle>\r\n            <mat-datetimepicker #startDatePicker type=\"date\" openOnFocus=\"true\"></mat-datetimepicker>\r\n            <input matInput formControlName=\"startDate\" [matDatetimepicker]=\"startDatePicker\">\r\n          </mat-form-field>\r\n          <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\r\n            <mat-label>Start Time</mat-label>\r\n            <mat-datetimepicker-toggle [for]=\"startTimePicker\" matPrefix></mat-datetimepicker-toggle>\r\n            <mat-datetimepicker #startTimePicker type=\"time\" openOnFocus=\"true\"></mat-datetimepicker>\r\n            <input matInput formControlName=\"startTime\" [matDatetimepicker]=\"startTimePicker\">\r\n          </mat-form-field>\r\n        </section>\r\n\r\n        <section fxLayout=\"row\" fxLayoutAlign=\"center center\" fxLayoutGap=\"16px\" style=\"width: 100%;\">\r\n          <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\r\n            <mat-label>End Date</mat-label>\r\n            <mat-datetimepicker-toggle [for]=\"endDatePicker\" matPrefix></mat-datetimepicker-toggle>\r\n            <mat-datetimepicker #endDatePicker type=\"date\" openOnFocus=\"true\"></mat-datetimepicker>\r\n            <input matInput formControlName=\"endDate\" [matDatetimepicker]=\"endDatePicker\">\r\n          </mat-form-field>\r\n          <mat-form-field appearance=\"fill\" style=\"flex: 1;\">\r\n            <mat-label>End Time</mat-label>\r\n            <mat-datetimepicker-toggle [for]=\"endTimePicker\" matPrefix></mat-datetimepicker-toggle>\r\n            <mat-datetimepicker #endTimePicker type=\"time\" openOnFocus=\"true\"></mat-datetimepicker>\r\n            <input matInput formControlName=\"endTime\" [matDatetimepicker]=\"endTimePicker\">\r\n          </mat-form-field>\r\n        </section>\r\n\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">Cancel</button>\r\n          <button\r\n            mat-button\r\n            matStepperNext\r\n            color=\"primary\"\r\n            type=\"button\"\r\n            *ngIf=\"showAttributesStep\"\r\n            [disabled]=\"!assignedDevicesAvailable\"\r\n          >\r\n            Next\r\n          </button>\r\n           <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"addDeviceFormGroup.pristine || addDeviceFormGroup.invalid\" *ngIf=\"!showAttributesStep\">\r\n            Save\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <mat-step formGroupName=\"attributesStep\" label=\"Attributes\" *ngIf=\"showAttributesStep\">\r\n        <ng-template matStepLabel>Default Parameters</ng-template>\r\n\r\n        <fieldset class=\"fieldset\">\r\n          <legend>Dimension</legend>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Dimension</mat-label>\r\n              <mat-select formControlName=\"dimension\" required>\r\n                <mat-option *ngFor=\"let dimension of dimensionOptions\" [value]=\"dimension\">\r\n                  {{ dimension }}\r\n                </mat-option>\r\n              </mat-select>\r\n              <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.dimension').hasError('required')\">\r\n                Dimension is required.\r\n              </mat-error>\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Nominal Flow (m³/hr)</mat-label>\r\n              <input matInput formControlName=\"nominalFlow\" type=\"number\" readonly>\r\n            </mat-form-field>\r\n          </div>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" style=\"width:50%\">\r\n              <mat-label>Floor Volume (m³/hr)</mat-label>\r\n              <input matInput formControlName=\"deltaTAnalysisFloorVolume\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Pump Power (W)</mat-label>\r\n              <input matInput formControlName=\"deltaTAnalysisPumpEnergy\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n        </fieldset>\r\n\r\n        <fieldset class=\"fieldset\">\r\n          <legend>Installation</legend>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Installation Type</mat-label>\r\n              <mat-select formControlName=\"installationType\" required>\r\n                <mat-option value=\"heating\">Heating</mat-option>\r\n                <mat-option value=\"cooling\">Cooling</mat-option>\r\n              </mat-select>\r\n              <mat-error *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationType').hasError('required')\">\r\n                Installation Type is required.\r\n              </mat-error>\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Installation Type Options</mat-label>\r\n              <mat-select formControlName=\"installationTypeOptions\" required>\r\n                <ng-container *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationType').value === 'heating'\">\r\n                  <mat-option value=\"radiatorHeating\">Radiator Heating</mat-option>\r\n                  <mat-option value=\"floorHeating\">Floor Heating</mat-option>\r\n                  <mat-option value=\"districtHeating\">District Heating</mat-option>\r\n                  <mat-option value=\"heatingOther\">Heating Other</mat-option>\r\n                </ng-container>\r\n                <ng-container *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationType').value === 'cooling'\">\r\n                  <mat-option value=\"coolingCircuit\">Cooling Circuit</mat-option>\r\n                  <mat-option value=\"coolingCeiling\">Cooling Ceiling</mat-option>\r\n                  <mat-option value=\"chiller\">Chiller</mat-option>\r\n                  <mat-option value=\"coolingOther\">Cooling Other</mat-option>\r\n                </ng-container>\r\n              </mat-select>\r\n              <mat-error\r\n                *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.installationTypeOptions').hasError('required')\"\r\n              >\r\n                Installation Type Option is required.\r\n              </mat-error>\r\n            </mat-form-field>\r\n          </div>\r\n        </fieldset>\r\n\r\n        <fieldset class=\"fieldset\">\r\n          <legend>Analysis</legend>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Standard Outdoor Temperature</mat-label>\r\n              <input matInput formControlName=\"standardOutdoorTemperature\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Delta T</mat-label>\r\n              <input matInput formControlName=\"deltaT\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Outside Temperature Threshold Setting</mat-label>\r\n              <mat-select formControlName=\"loadCourseFilterTemperature\" required>\r\n                <mat-option value=\"above\">Above</mat-option>\r\n                <mat-option value=\"below\">Below</mat-option>\r\n              </mat-select>\r\n              <mat-error\r\n                *ngIf=\"addDeviceFormGroup.get('stepper.attributesStep.loadCourseFilterTemperature').hasError('required')\"\r\n              >\r\n                Temperature Condition is required.\r\n              </mat-error>\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Outside Temperature Threshold</mat-label>\r\n              <input matInput formControlName=\"loadCourseFilterTemperatureValue\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" fxFlex>\r\n              <mat-label>Maximum Power Threshold (%)</mat-label>\r\n              <input matInput formControlName=\"loadCourseFilterMaxPower\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n          <div fxLayout=\"row\" fxLayoutGap=\"10px\">\r\n            <mat-form-field class=\"mat-block\" style=\"width:50%\">\r\n              <mat-label>Area</mat-label>\r\n              <input matInput formControlName=\"area\" type=\"number\">\r\n            </mat-form-field>\r\n            <mat-form-field class=\"mat-block\" style=\"width:50%\">\r\n              <mat-label>Unit</mat-label>\r\n              <input matInput formControlName=\"unit\" type=\"text\">\r\n            </mat-form-field>\r\n          </div>\r\n        </fieldset>\r\n\r\n        <fieldset class=\"fieldset\">\r\n          <legend>Weekly Operating Schedule</legend>\r\n          <div\r\n            formGroupName=\"weeklyOperatingSchedule\"\r\n            fxLayout=\"row\"\r\n            fxLayoutGap=\"6px\"\r\n            fxLayoutAlign=\"space-between center\"\r\n          >\r\n            <mat-checkbox formControlName=\"monday\">Mon</mat-checkbox>\r\n            <mat-checkbox formControlName=\"tuesday\">Tue</mat-checkbox>\r\n            <mat-checkbox formControlName=\"wednesday\">Wed</mat-checkbox>\r\n            <mat-checkbox formControlName=\"thursday\">Thu</mat-checkbox>\r\n            <mat-checkbox formControlName=\"friday\">Fri</mat-checkbox>\r\n            <mat-checkbox formControlName=\"saturday\">Sat</mat-checkbox>\r\n            <mat-checkbox formControlName=\"sunday\">Sun</mat-checkbox>\r\n          </div>\r\n        </fieldset>\r\n\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">Cancel</button>\r\n          <button mat-button matStepperPrevious color=\"primary\" type=\"button\">Back</button>\r\n          <!--<button mat-button matStepperNext color=\"primary\" type=\"button\">\r\n            Next\r\n          </button>-->\r\n          <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"addDeviceFormGroup.pristine || addDeviceFormGroup.invalid\">\r\n            Save\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <!-- Alarm Thresholds Step -->\r\n      <!--<mat-step formGroupName=\"alarmThresholdsStep\" label=\"Alarm Thresholds\" *ngIf=\"showAlarmThresholdsStep\">\r\n        <ng-template matStepLabel>Alarm Thresholds</ng-template>\r\n\r\n        <div fxLayout=\"row\" fxLayoutGap=\"24px\">\r\n          <div fxFlex=\"50%\">\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Volume Flow Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"maxVolumeFlowCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Energy Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"maxEnergyCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Min Temperature Difference Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"minTemperatureDifferenceCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>High CO2 Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"highCo2CriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>High Temperature Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"highTemperatureCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>High Humidity Critical Threshold</mat-label>\r\n              <input matInput formControlName=\"highHumidityCriticalThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n          <div fxFlex=\"50%\">\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Volume Flow Major Threshold</mat-label>\r\n              <input matInput formControlName=\"maxVolumeFlowMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Max Energy Major Threshold</mat-label>\r\n              <input matInput formControlName=\"maxEnergyMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>Min Temperature Difference Major Threshold</mat-label>\r\n              <input matInput formControlName=\"minTemperatureDifferenceMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>High CO2 Major Threshold</mat-label>\r\n              <input matInput formControlName=\"highCo2MajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>High Temperature Major Threshold</mat-label>\r\n              <input matInput formControlName=\"highTemperatureMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n\r\n            <mat-form-field class=\"mat-block\">\r\n              <mat-label>High Humidity Major Threshold</mat-label>\r\n              <input matInput formControlName=\"highHumidityMajorThreshold\" type=\"number\">\r\n            </mat-form-field>\r\n          </div>\r\n        </div>\r\n\r\n        <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n          <button mat-button color=\"primary\" type=\"button\" (click)=\"cancel()\">Cancel</button>\r\n          <button mat-button matStepperPrevious color=\"primary\" type=\"button\">Back</button>\r\n          <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"addDeviceFormGroup.invalid\">\r\n            Save\r\n          </button>\r\n        </div>\r\n      </mat-step>-->\r\n\r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>\r\n",
                "customCss": ".mat-form-field input[disabled] {\n  background-color: #f5f5f5; /* Light grey background to indicate disabled state */\n  cursor: not-allowed; /* Change cursor to indicate non-interactive element */\n  color: #9e9e9e; /* Change text color to indicate disabled state */\n  \n}\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nconst {\r\n    customDialog,\r\n    entityService,\r\n    deviceService,\r\n    entityGroupService,\r\n    attributeService,\r\n    entityRelationService,\r\n    assetService,\r\n} = [\r\n    'customDialog',\r\n    'entityService',\r\n    'deviceService',\r\n    'entityGroupService',\r\n    'attributeService',\r\n    'entityRelationService',\r\n    'assetService'\r\n].reduce((services, name) => {\r\n    services[name] = $injector.get(widgetContext.servicesMap.get(name));\r\n    return services;\r\n}, {});\r\n\r\nconst measurementId = entityId;\r\n\r\nif (!measurementId || !measurementId.id) {\r\n    console.error(\"Invalid measurementId:\", measurementId);\r\n} else {\r\n    fetchAssignedDevices(measurementId.id);\r\n}\r\n\r\nfunction fetchAssignedDevices(measurementId) {\r\n    const deviceSearchQuery = {\r\n        parameters: {\r\n            rootId: measurementId,\r\n            rootType: \"ASSET\",\r\n            direction: \"FROM\",\r\n            relationTypeGroup: \"COMMON\",\r\n            maxLevel: 100,\r\n            fetchLastLevelOnly: false,\r\n        },\r\n        relationType: \"Measurement\",\r\n        deviceTypes: [\"P-Flow D116\", \"Room Sensor CO2\"],\r\n    };\r\n\r\n    deviceService.findByQuery(deviceSearchQuery).subscribe(\r\n        (devices) => {\r\n            fetchAttributes(devices);\r\n        },\r\n        (error) => {\r\n            console.error(\"Error while fetching devices:\", error);\r\n            fetchAttributes([]);\r\n        }\r\n    );\r\n}\r\n\r\nfunction fetchAttributes(assignedDevices) {\r\n    attributeService.getEntityAttributes(measurementId).subscribe(\r\n        (attributes) => {\r\n            openAddDeviceDialog(assignedDevices, attributes);\r\n        },\r\n        (error) => {\r\n            console.error(\"Error while fetching attributes:\", error);\r\n            openAddDeviceDialog(assignedDevices, []);\r\n        }\r\n    );\r\n}\r\n\r\nfunction openAddDeviceDialog(assignedDevices, attributes) {\r\n    customDialog.customDialog(htmlTemplate, AddDeviceDialogController, {\r\n        measurementId,\r\n        assignedDevices,\r\n        attributes,\r\n    }).subscribe();\r\n}\r\n\r\nfunction AddDeviceDialogController(instance) {\r\n    const vm = instance;\r\n    const measurementType = vm.data.attributes[0].value;\r\n    \r\n    const {\r\n        measurementId,\r\n        assignedDevices = [],\r\n        attributes = [],\r\n    } = vm.data || {};\r\n\r\n    vm.measurementId = measurementId;\r\n    vm.attributes = attributes;\r\n\r\n    vm.assignedDevices = assignedDevices;\r\n    vm.assignedDevicesAvailable = assignedDevices.length > 0;\r\n\r\n    vm.showAttributesStep = vm.assignedDevicesAvailable && (measurementType === 'ultrasonic');\r\n    /*vm.showAlarmThresholdsStep = vm.assignedDevicesAvailable;*/\r\n\r\n\r\n\r\n    vm.weekDays = [\r\n        { key: 'monday', label: 'Monday' },\r\n        { key: 'tuesday', label: 'Tuesday' },\r\n        { key: 'wednesday', label: 'Wednesday' },\r\n        { key: 'thursday', label: 'Thursday' },\r\n        { key: 'friday', label: 'Friday' },\r\n        { key: 'saturday', label: 'Saturday' },\r\n        { key: 'sunday', label: 'Sunday' },\r\n    ];\r\n    vm.heatingOptions = ['radiatorHeating', 'floorHeating', 'districtHeating', 'heatingOther'];\r\n    vm.coolingOptions = ['coolingCircuit', 'coolingCeiling', 'chiller', 'coolingOther'];\r\n    vm.dimensionOptions = ['DN15', 'DN20', 'DN25', 'DN32', 'DN40', 'DN50', 'DN65', 'DN80', 'DN100', 'DN125', 'DN150'];\r\n\r\n    vm.addDeviceFormGroup = vm.fb.group({\r\n        stepper: vm.fb.group({\r\n            assignmentStep: vm.fb.group({\r\n                progress: [{ value: 'in preparation', disabled: !vm.assignedDevicesAvailable }, [vm.validators.required]],\r\n                startDate: [{ value: null, disabled: !vm.assignedDevicesAvailable }],\r\n                startTime: [{ value: null, disabled: !vm.assignedDevicesAvailable }],\r\n                endDate: [{ value: null, disabled: !vm.assignedDevicesAvailable }],\r\n                endTime: [{ value: null, disabled: !vm.assignedDevicesAvailable }],\r\n            }),\r\n            attributesStep: vm.fb.group({\r\n                installationType: [null, [vm.validators.required]],\r\n                installationTypeOptions: ['', [vm.validators.required]],\r\n                standardOutdoorTemperature: [null],\r\n                loadCourseAnalysisTemperature: [null],\r\n                loadCourseFilterTemperature: [null, [vm.validators.required]],\r\n                loadCourseFilterTemperatureValue: [null],\r\n                loadCourseFilterMaxPower: [null],\r\n                nominalFlow: [null],\r\n                deltaT: [null],\r\n                deltaTAnalysisPumpEnergy: [null],\r\n                deltaTAnalysisFloorVolume: [null],\r\n                dimension: [null],\r\n                area: [null],\r\n                unit: [null],\r\n                weeklyOperatingSchedule: vm.fb.group(\r\n                    vm.weekDays.reduce((acc, day) => {\r\n                        acc[day.key] = [false];\r\n                        return acc;\r\n                    }, {})\r\n                ),\r\n            }),\r\n            /*alarmThresholdsStep: vm.fb.group({\r\n                maxVolumeFlowCriticalThreshold: [null],\r\n                maxVolumeFlowMajorThreshold: [null],\r\n                maxEnergyCriticalThreshold: [null],\r\n                maxEnergyMajorThreshold: [null],\r\n                minTemperatureDifferenceCriticalThreshold: [null],\r\n                minTemperatureDifferenceMajorThreshold: [null],\r\n                highCo2CriticalThreshold: [null],\r\n                highCo2MajorThreshold: [null],\r\n                highTemperatureCriticalThreshold: [null],\r\n                highHumidityCriticalThreshold: [null],\r\n                highTemperatureMajorThreshold: [null],\r\n                highHumidityMajorThreshold: [null],\r\n            }),*/\r\n        }),\r\n    });\r\n\r\n    initializeFormValues();\r\n    setupFormSubscriptions();\r\n\r\n    function initializeFormValues() {\r\n        // Map known attribute keys to form controls\r\n        const attributeToFormControlMap = {\r\n            'installationType': 'installationType',\r\n            'installationTypeOptions': 'installationTypeOptions',\r\n            'loadCourseFilterTemperature': 'loadCourseFilterTemperature',\r\n            'loadCourseFilterTemperatureValue': 'loadCourseFilterTemperatureValue',\r\n            'dimension': 'dimension',\r\n            'nominalFlow': 'nominalFlow',\r\n            'pumpPower': 'deltaTAnalysisPumpEnergy',\r\n            'standardOutsideTemperature': 'standardOutdoorTemperature',\r\n            'loadCourseFilterMaxPower': 'loadCourseFilterMaxPower',\r\n            'deltaT': 'deltaT',\r\n            'deltaTAnalysisFloorVolume': 'deltaTAnalysisFloorVolume',\r\n            'loadCourseAnalysisTemperature': 'loadCourseAnalysisTemperature',\r\n            'progress': 'progress',\r\n        };\r\n\r\n        attributes.forEach((attr) => {\r\n            const formControlName = attributeToFormControlMap[attr.key];\r\n            if (formControlName) {\r\n                // If it's 'progress', put in assignmentStep; else in attributesStep\r\n                const stepGroup =\r\n                    (formControlName === 'progress')\r\n                        ? 'assignmentStep'\r\n                        : 'attributesStep';\r\n\r\n                vm.addDeviceFormGroup\r\n                  .get(`stepper.${stepGroup}.${formControlName}`)\r\n                  .setValue(attr.value);\r\n            }\r\n            // Start/end times\r\n            else if (attr.key === 'startTimeMs' || attr.key === 'endTimeMs') {\r\n                if (attr.value) {\r\n                    const dateTime = new Date(Number(attr.value));\r\n                    const dateControlName = (attr.key === 'startTimeMs') ? 'startDate' : 'endDate';\r\n                    const timeControlName = (attr.key === 'startTimeMs') ? 'startTime' : 'endTime';\r\n\r\n                    vm.addDeviceFormGroup.get(`stepper.assignmentStep.${dateControlName}`).setValue(dateTime);\r\n                    vm.addDeviceFormGroup.get(`stepper.assignmentStep.${timeControlName}`).setValue(dateTime);\r\n                }\r\n            }\r\n            // Weekly schedule\r\n            else if (attr.key === 'weeklySchedule') {\r\n                if (attr.value) {\r\n                    Object.keys(attr.value).forEach((day) => {\r\n                        vm.addDeviceFormGroup\r\n                            .get(`stepper.attributesStep.weeklyOperatingSchedule.${day}`)\r\n                            .setValue(attr.value[day]);\r\n                    });\r\n                }\r\n            }\r\n            // If you had existing alarm threshold attributes, you could map them similarly\r\n            // e.g. if there's an attr.key === 'maxVolumeFlowCriticalThreshold', etc.\r\n        });\r\n\r\n        updateProgressControl();\r\n    }\r\n\r\n    let lastProgressValue = null;\r\n\r\n    function setupFormSubscriptions() {\r\n        vm.addDeviceFormGroup\r\n            .get('stepper.attributesStep.installationType')\r\n            .valueChanges.subscribe(() => {\r\n                updateInstallationTypeOptions();\r\n            });\r\n\r\n        vm.addDeviceFormGroup\r\n            .get('stepper.attributesStep.installationTypeOptions')\r\n            .valueChanges.subscribe((val) => {\r\n                setDefaultDeltaT(val);\r\n            });\r\n\r\n        vm.addDeviceFormGroup\r\n            .get('stepper.attributesStep.dimension')\r\n            .valueChanges.subscribe((dimension) => {\r\n                const nominalFlow = getNominalFlowByDimension(dimension);\r\n                vm.addDeviceFormGroup\r\n                    .get('stepper.attributesStep.nominalFlow')\r\n                    .setValue(nominalFlow);\r\n            });\r\n\r\n        vm.addDeviceFormGroup\r\n            .get('stepper.attributesStep.nominalFlow')\r\n            .valueChanges.subscribe((val) => {\r\n                if (val) {\r\n                    // Example: floorVolume is 2% of nominalFlow\r\n                    const floorVal = (val * 0.02).toFixed(3);\r\n                    vm.addDeviceFormGroup\r\n                        .get('stepper.attributesStep.deltaTAnalysisFloorVolume')\r\n                        .setValue(floorVal);\r\n                }\r\n            });\r\n\r\n        vm.addDeviceFormGroup\r\n            .get('stepper.assignmentStep.progress')\r\n            .valueChanges.subscribe((newValue) => {\r\n                if (newValue !== lastProgressValue) {\r\n                    lastProgressValue = newValue;\r\n                    updateProgressControl();\r\n                }\r\n            });\r\n    }\r\n\r\n    function updateProgressControl() {\r\n        const progressControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.progress');\r\n        const startDateControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.startDate');\r\n        const startTimeControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.startTime');\r\n        const endDateControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.endDate');\r\n        const endTimeControl = vm.addDeviceFormGroup.get('stepper.assignmentStep.endTime');\r\n            \r\n    if (!vm.showAttributesStep) {\r\n          // For the entire step:\r\n          vm.addDeviceFormGroup.get('stepper.attributesStep').disable();\r\n          // or remove required validators from each control\r\n        } else {\r\n          vm.addDeviceFormGroup.get('stepper.attributesStep').enable();\r\n        }\r\n\r\n        if (!vm.assignedDevicesAvailable) {\r\n            progressControl.disable();\r\n            startDateControl.disable();\r\n            startTimeControl.disable();\r\n            endDateControl.disable();\r\n            endTimeControl.disable();\r\n        } else {\r\n            progressControl.enable();\r\n            startDateControl.enable();\r\n            startTimeControl.enable();\r\n            endDateControl.enable();\r\n            endTimeControl.enable();\r\n        }\r\n\r\n        // If progress is active but no start time set, auto-set to now\r\n        if (progressControl.value === 'active' && !startDateControl.value && !startTimeControl.value) {\r\n            const now = new Date();\r\n            startDateControl.setValue(now);\r\n            startTimeControl.setValue(now);\r\n        }\r\n        // If progress is finished/aborted but no end time set (and we have a start), auto-set end to now\r\n        else if (\r\n            (progressControl.value === 'finished' || progressControl.value === 'aborted') &&\r\n            startDateControl.value && startTimeControl.value &&\r\n            !endDateControl.value && !endTimeControl.value\r\n        ) {\r\n            const now = new Date();\r\n            endDateControl.setValue(now);\r\n            endTimeControl.setValue(now);\r\n        }\r\n    }\r\n\r\n    function updateInstallationTypeOptions() {\r\n        const installationType = vm.addDeviceFormGroup.get('stepper.attributesStep.installationType').value;\r\n        let options = [];\r\n        if (installationType === 'heating') {\r\n            options = vm.heatingOptions;\r\n        } else if (installationType === 'cooling') {\r\n            options = vm.coolingOptions;\r\n        }\r\n        vm.filteredInstallationTypeOptions = options;\r\n        vm.addDeviceFormGroup.get('stepper.attributesStep.installationTypeOptions').setValue('');\r\n    }\r\n\r\n    function setDefaultDeltaT(installationTypeOptions) {\r\n        const deltaTValues = {\r\n            coolingCircuit: 6,\r\n            coolingCeiling: 3,\r\n            chiller: 6,\r\n            coolingOther: null,\r\n            radiatorHeating: 15,\r\n            floorHeating: 5,\r\n            districtHeating: 25,\r\n            heatingOther: null,\r\n        };\r\n        const defaultDelta = deltaTValues[installationTypeOptions] || null;\r\n        vm.addDeviceFormGroup\r\n            .get('stepper.attributesStep.deltaT')\r\n            .setValue(defaultDelta);\r\n    }\r\n\r\n    function getNominalFlowByDimension(dimension) {\r\n        const dimensionToNominalFlow = {\r\n            DN15: 1.5,\r\n            DN20: 2.5,\r\n            DN25: 3.5,\r\n            DN32: 6,\r\n            DN40: 10,\r\n            DN50: 15,\r\n            DN65: 28.8,\r\n            DN80: 39.6,\r\n            DN100: 72,\r\n            DN125: 111.6,\r\n            DN150: 162,\r\n        };\r\n        return dimensionToNominalFlow[dimension] || null;\r\n    }\r\n\r\n    function parseDateTime(dateObj, timeObj) {\r\n        if (!dateObj || !timeObj) return null;\r\n        const date = new Date(dateObj);\r\n        const time = new Date(timeObj);\r\n        date.setHours(time.getHours(), time.getMinutes(), time.getSeconds(), time.getMilliseconds());\r\n        return date;\r\n    }\r\n\r\n    vm.cancel = function () {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    vm.save = function () {\r\n        if (vm.addDeviceFormGroup.invalid) {\r\n            return;\r\n        }\r\n\r\n        const formData = vm.addDeviceFormGroup.value;\r\n        const assignmentStep = formData.stepper.assignmentStep;\r\n        const attributesStep = formData.stepper.attributesStep;\r\n/*        const alarmThresholdsStep = formData.stepper.alarmThresholdsStep;*/\r\n\r\n        // Convert date/time to epoch\r\n        const startDateTime = parseDateTime(assignmentStep.startDate, assignmentStep.startTime);\r\n        const endDateTime = parseDateTime(assignmentStep.endDate, assignmentStep.endTime);\r\n\r\n        const attributesArray = [\r\n            { key: 'xPos', value: 0.5 },\r\n            { key: 'yPos', value: 0.5 },\r\n            { key: 'installationType', value: attributesStep.installationType },\r\n            { key: 'installationTypeOptions', value: attributesStep.installationTypeOptions },\r\n            { key: 'progress', value: assignmentStep.progress },\r\n            { key: 'startTimeMs', value: startDateTime ? startDateTime.getTime() : null },\r\n            { key: 'endTimeMs', value: endDateTime ? endDateTime.getTime() : null },\r\n            { key: 'loadCourseAnalysisTemperature', value: attributesStep.loadCourseAnalysisTemperature },\r\n            { key: 'loadCourseFilterTemperature', value: attributesStep.loadCourseFilterTemperature },\r\n            { key: 'loadCourseFilterTemperatureValue', value: attributesStep.loadCourseFilterTemperatureValue },\r\n            { key: 'loadCourseFilterMaxPower', value: attributesStep.loadCourseFilterMaxPower },\r\n            {\r\n                key: 'area',\r\n                value: {\r\n                    value: attributesStep.area,\r\n                    unit: attributesStep.unit\r\n                }\r\n            },\r\n            { key: 'nominalFlow', value: attributesStep.nominalFlow },\r\n            { key: 'dimension', value: attributesStep.dimension },\r\n            { key: 'weeklySchedule', value: attributesStep.weeklyOperatingSchedule },\r\n            { key: 'deltaT', value: attributesStep.deltaT },\r\n            { key: 'deltaTAnalysisPumpEnergy', value: attributesStep.deltaTAnalysisPumpEnergy },\r\n            { key: 'deltaTAnalysisFloorVolume', value: attributesStep.deltaTAnalysisFloorVolume },\r\n\r\n            /*{ key: 'maxVolumeFlowCriticalThreshold', value: alarmThresholdsStep.maxVolumeFlowCriticalThreshold },\r\n            { key: 'maxVolumeFlowMajorThreshold', value: alarmThresholdsStep.maxVolumeFlowMajorThreshold },\r\n            { key: 'maxEnergyCriticalThreshold', value: alarmThresholdsStep.maxEnergyCriticalThreshold },\r\n            { key: 'maxEnergyMajorThreshold', value: alarmThresholdsStep.maxEnergyMajorThreshold },\r\n            { key: 'minTemperatureDifferenceCriticalThreshold', value: alarmThresholdsStep.minTemperatureDifferenceCriticalThreshold },\r\n            { key: 'minTemperatureDifferenceMajorThreshold', value: alarmThresholdsStep.minTemperatureDifferenceMajorThreshold },\r\n            { key: 'highCo2CriticalThreshold', value: alarmThresholdsStep.highCo2CriticalThreshold },\r\n            { key: 'highCo2MajorThreshold', value: alarmThresholdsStep.highCo2MajorThreshold },\r\n            { key: 'highTemperatureCriticalThreshold', value: alarmThresholdsStep.highTemperatureCriticalThreshold },\r\n            { key: 'highHumidityCriticalThreshold', value: alarmThresholdsStep.highHumidityCriticalThreshold },\r\n            { key: 'highTemperatureMajorThreshold', value: alarmThresholdsStep.highTemperatureMajorThreshold },\r\n            { key: 'highHumidityMajorThreshold', value: alarmThresholdsStep.highHumidityMajorThreshold },*/\r\n        ];\r\n\r\n        attributeService.saveEntityAttributes(vm.measurementId, \"SERVER_SCOPE\", attributesArray).subscribe(\r\n            () => {\r\n                // Save successful\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n            },\r\n            (error) => {\r\n                console.error(\"Error while saving attributes:\", error);\r\n            }\r\n        );\r\n    };\r\n}\r\n",
                "customResources": [],
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "dd61dc57-da78-0fae-80f1-2b36654bb87a"
              },
              {
                "name": "Assigned Devices",
                "icon": "medical_services",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "measurement_devices",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "d98a9e1b-838a-5be1-28c7-cd682de58ace"
              },
              {
                "name": "Edit Floor plan",
                "icon": "mdi:floor-plan",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "openDashboardState",
                "targetDashboardStateId": "devices_plan",
                "setEntityId": true,
                "stateEntityParamName": "selectedMeasurement",
                "openRightLayout": false,
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "41faf1fe-156b-0617-1683-b65717fbf8ae"
              },
              {
                "name": "Get Location",
                "icon": "location_on",
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "mobileAction",
                "mobileAction": {
                  "type": "getLocation",
                  "handleEmptyResultFunction": "// Optional function body to handle empty result. \n// Usually this happens when user cancels the action (for ex. by pressing phone back button). \n\nshowEmptyResultDialog('Get location action was canceled!');\n\nfunction showEmptyResultDialog(message) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert('Empty result', message).subscribe();\n    }, 100);\n}\n",
                  "handleErrorFunction": "// Optional function body to handle error occurred while mobile action execution \n// - error - Error message\n\nshowErrorDialog('Failed to get phone location', error);\n\nfunction showErrorDialog(title, error) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, error).subscribe();\n    }, 100);\n}\n",
                  "processLocationFunction": "// Function body to process current location of the phone. \n// - latitude - phone location latitude\n// - longitude - phone location longitude\nlet $injector = widgetContext.$scope.$injector;\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\n\n//showLocationDialog('Location', latitude, longitude);\nsaveEntityLocationAttributes('latitude', 'longitude', latitude, longitude);\nfunction getSelectedKitId() {\n    let stateParams = widgetContext.stateController.getStateParams();\n    return stateParams.selectedDoktorkit.entityId;\n}\n\nfunction saveEntityLocationAttributes(latitudeAttributeName, longitudeAttributeName, latitude, longitude) {\n    let entityId = getSelectedKitId();\n    if (entityId) {\n        let attributes = [\n            { key: \"latitude\", value: latitude },\n            { key: \"longitude\", value: longitude }\n        ];\n        attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributes).subscribe(\n        widgetContext.dialogs.alert('Location attributes saved!\\nLatitude: ' + latitude + '\\nLongitude: ' + longitude),\n           function() {\n               widgetContext.showSuccessToast('Location attributes saved!');\n           },\n           function(error) {\n               widgetContext.dialogs.alert('Location attributes save failed', JSON.stringify(error));\n           }\n        );\n    }\n}\n\n\nfunction showLocationDialog(title, latitude, longitude) {\n    setTimeout(function() {\n        widgetContext.dialogs.alert(title, 'Latitude: '+latitude+'<br>Longitude: ' + longitude).subscribe();\n    }, 100);\n}"
                },
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "2c3f1d4a-57f0-89d7-fc5f-8a5741a8a953"
              },
              {
                "name": "Delete Measurement",
                "icon": "delete",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "let $injector = widgetContext.$scope.$injector;\nlet dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet customerId;\nlet measurementEntityId = entityId.id;\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\n       customerId = widgetContext.stateController.getStateParams().entityId;\n  } else {\n       customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n  }\n\n\nlet doktorkitSearchQuery = {\n  \"parameters\": {\n    \"rootId\": measurementEntityId,\n    \"rootType\": \"ASSET\",\n    \"direction\": \"FROM\",\n    \"relationTypeGroup\": \"COMMON\",\n    \"maxLevel\": 10,\n    \"fetchLastLevelOnly\": false\n  },\n  \"relationType\": \"Owns\",\n  \"assetTypes\": [\n    \"Doktorkit\"\n  ]\n};\n\nassetService.findByQuery(doktorkitSearchQuery).subscribe(doktorkits => {\n        openDeleteMeasurementDialog(doktorkits);\n    });\n\n\nfunction addKitToUnassignedDoktorkits(doktorkits) {\n    return getUnassignedKitGroup(customerId).pipe(\n        widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\n            const addKitObservables = doktorkits.map((item) => {\n                \n                return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, item.id.id);\n            });\n            \n            return widgetContext.rxjs.forkJoin(addKitObservables);\n        })\n    );\n}\nfunction getUnassignedKitGroup(customerId) {\n  return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\n      widgetContext.rxjs.switchMap((entityGroups) => {\n          var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\n          if (UnassignedKitGroup) {\n              return widgetContext.rxjs.of(UnassignedKitGroup);\n          } else {\n              UnassignedKitGroup = {\n                  type: 'ASSET',\n                  name: 'Unassigned Kit',\n                  ownerId: customerId\n              };\n              return entityGroupService.saveEntityGroup(UnassignedKitGroup);\n          }\n      })\n  );\n}\nfunction openDeleteMeasurementDialog(doktorkits) {\n  let title = 'Are you sure you want to delete the Measurement ' + entityName + '?';\n  let content = 'Be careful, after the confirmation, the Measurement will be deleted and all related devices will be unassigned!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteMeasurement(doktorkits);\n      }\n    }\n  );\n}\n\nfunction deleteMeasurement(doktorkits) {\n  addKitToUnassignedDoktorkits(doktorkits).subscribe();\n  let relatedDevicesQuery = {\n      parameters: {\n          rootId: entityId.id,\n          rootType: entityId.entityType,\n          direction: 'FROM'\n      },\n      filters: [{ relationType: 'Contains', entityTypes: ['DEVICE'] }]\n  };\n  entityRelationService.findByQuery(relatedDevicesQuery).subscribe((relatedDevicesRelations) => {\n      let removeDevicesObservable;\n      if (relatedDevicesRelations.length) {\n          removeDevicesObservable = getUnassignedDevicesGroup(customerId).pipe(\n              widgetContext.rxjs.switchMap((unassignedDevicesGroup) => {\n                  let removeDevicesObservables = [];\n                  relatedDevicesRelations.forEach((deviceRelation) => {\n                     removeDevicesObservables.push(removeDevice(deviceRelation.to, unassignedDevicesGroup.id.id));\n                  });\n                  return widgetContext.rxjs.forkJoin(removeDevicesObservables);\n              })\n          );\n      } else {\n          removeDevicesObservable = widgetContext.rxjs.of(null);\n      }\n      removeDevicesObservable.subscribe(() => {\n          assetService.deleteAsset(entityId.id).subscribe(\n            function() {\n                widgetContext.updateAliases();\n            }\n          );\n      });\n  });\n}\n\nfunction removeDevice(deviceId, unassignedDevicesGroupId) {\n    return widgetContext.rxjs.forkJoin([\n        entityGroupService.addEntityToEntityGroup(unassignedDevicesGroupId, deviceId.id),\n        deleteMeasurementToDeviceRelation(deviceId),\n        removePositionAttributes(deviceId)\n    ]);\n}\n\nfunction getUnassignedDevicesGroup(customerId) {\n    return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE').pipe(\n        widgetContext.rxjs.switchMap((deviceEntityGroups) => {\n            return getOrCreateUnassignedDevicesGroup(customerId, deviceEntityGroups);\n        })\n    );\n}\n\nfunction getOrCreateUnassignedDevicesGroup(customerId, groups) {\n  let unassignedDevicesGroup = groups.find(group => group.name === 'Unassigned Measurement Devices');\n  if (unassignedDevicesGroup) {\n      return widgetContext.rxjs.of(unassignedDevicesGroup);\n  } else {\n      unassignedDevicesGroup = {\n          type: 'DEVICE',\n          name: 'Unassigned Measurement Devices',\n          ownerId: customerId\n      };\n      return entityGroupService.saveEntityGroup(unassignedDevicesGroup);\n  }\n}\n\nfunction deleteMeasurementToDeviceRelation(deviceId) {\n    return entityRelationService.deleteRelation(entityId, 'Contains', deviceId);\n}\n\nfunction removePositionAttributes(entityId) {\n    return attributeService.deleteEntityAttributes(entityId, \"SERVER_SCOPE\", [{key: 'xPos'},{key: 'yPos'}]);\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f1eb48d4-6320-03b7-440f-382a53375049"
              }
            ]
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "pageSize": 1024
        },
        "row": 0,
        "col": 0,
        "id": "d7ea3d50-1015-96d2-cee3-535aaf923958",
        "typeFullFqn": "system.cards.markdown_card"
      },
      "4f27f5c7-75b2-c14a-821f-ae5786bf1323": {
        "typeFullFqn": "system.cards.markdown_card",
        "type": "latest",
        "sizeX": 5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "04917190-aea7-e407-e308-4598f1671a71",
              "dataKeys": [],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1737447672095,
                "endTimeMs": 1737534072095
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": true,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "useMarkdownTextFunction": false,
            "markdownTextPattern": "",
            "markdownTextFunction": "return '# Some title\\n - Entity name: ' + data[0]['entityName'];",
            "applyDefaultMarkdownStyle": true,
            "markdownCss": ""
          },
          "title": "{i18n:custom.user-management.user-management}",
          "showTitleIcon": true,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "showLegend": false,
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "actions": {
            "headerButton": [
              {
                "name": "{i18n:action.go-back}",
                "buttonType": "icon",
                "icon": "arrow_back",
                "buttonColor": "rgba(0, 0, 0, 0.87)",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n/*params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten*/\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "f9a94ea9-abbd-daa2-234c-959b21e21b65"
              }
            ]
          },
          "enableDataExport": false,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "titleFont": {
            "size": 22,
            "sizeUnit": "px",
            "family": "Roboto",
            "weight": "500",
            "style": "normal"
          },
          "titleIcon": ""
        },
        "row": 0,
        "col": 0,
        "id": "4f27f5c7-75b2-c14a-821f-ae5786bf1323"
      },
      "b45a8ba5-3b00-23be-6d1c-5f110bc6d3a7": {
        "typeFullFqn": "system.input_widgets.markers_placement_openstreetmap",
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
              "dataKeys": [
                {
                  "name": "latitude",
                  "type": "attribute",
                  "label": "selectedProject",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.667860781840715,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": true,
                  "postFuncBody": "if (value) {\n    return true;\n} else {\n    return false;\n}"
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            },
            {
              "type": "entity",
              "entityAliasId": "df6ecbc0-0dae-bc9b-fbeb-96b5c11f9ebc",
              "dataKeys": [
                {
                  "name": "progress",
                  "type": "attribute",
                  "label": "progress",
                  "color": "#4caf50",
                  "settings": {},
                  "_hash": 0.009786807562707
                },
                {
                  "name": "name",
                  "type": "entityField",
                  "label": "name",
                  "color": "#f44336",
                  "settings": {},
                  "_hash": 0.9215225081760041,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                },
                {
                  "name": "latitude",
                  "type": "attribute",
                  "label": "latitude",
                  "color": "#ffc107",
                  "settings": {},
                  "_hash": 0.17822584732815216
                },
                {
                  "name": "longitude",
                  "type": "attribute",
                  "label": "longitude",
                  "color": "#607d8b",
                  "settings": {},
                  "_hash": 0.7962336603619105
                },
                {
                  "name": "label",
                  "type": "entityField",
                  "label": "label",
                  "color": "#9c27b0",
                  "settings": {},
                  "_hash": 0.08917116404033343,
                  "aggregationType": null,
                  "units": null,
                  "decimals": null,
                  "funcBody": null,
                  "usePostProcessing": null,
                  "postFuncBody": null
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1741792234579,
                "endTimeMs": 1741878634579
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "provider": "openstreet-map",
            "gmApiKey": "AIzaSyDoEx2kaGz3PxwbI9T7ccTSg5xjdw8Nw8Q",
            "gmDefaultMapType": "roadmap",
            "mapProvider": "CartoDB.Positron",
            "useCustomProvider": false,
            "customProviderTileUrl": "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            "mapProviderHere": "HERE.normalDay",
            "credentials": {
              "useV3": false,
              "app_id": "AhM6TzD9ThyK78CT3ptx",
              "app_code": "p6NPiITB3Vv0GMUFnkLOOg",
              "apiKey": "kVXykxAfZ6LS4EbCTO02soFVfjA7HoBzNVVH9u7nzoE"
            },
            "mapImageUrl": "tb-image;/api/images/system/here_map_system_widget_map_image.svg",
            "imageEntityAlias": "",
            "imageUrlAttribute": "",
            "tmApiKey": "84d6d83e0e51e481e50454ccbe8986b",
            "tmDefaultMapType": "roadmap",
            "latKeyName": "latitude",
            "lngKeyName": "longitude",
            "xPosKeyName": "xPos",
            "yPosKeyName": "yPos",
            "defaultZoomLevel": 5,
            "defaultCenterPosition": "0,0",
            "disableScrollZooming": false,
            "disableDoubleClickZooming": false,
            "disableZoomControl": false,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "mapPageSize": 16384,
            "markerOffsetX": 0.5,
            "markerOffsetY": 1,
            "posFunction": "return {x: origXPos, y: origYPos};",
            "draggableMarker": true,
            "showLabel": true,
            "useLabelFunction": false,
            "label": "${entityName}",
            "labelFunction": null,
            "showTooltip": true,
            "showTooltipAction": "click",
            "autocloseTooltip": true,
            "useTooltipFunction": false,
            "tooltipPattern": "<b>${entityName}</b><br/><br/><b>Latitude:</b> ${latitude:7}<br/><b>Longitude:</b> ${longitude:7}<br/><br/><link-act name='delete-Project'>{i18n:custom.projects.project.delete-project}</link-act>",
            "tooltipFunction": null,
            "tooltipOffsetX": 0,
            "tooltipOffsetY": -1,
            "color": "#fe7569",
            "useColorFunction": false,
            "colorFunction": null,
            "useMarkerImageFunction": true,
            "markerImage": null,
            "markerImageSize": 34,
            "markerImageFunction": "var progress = data['progress'];\r\nvar selectedProject = data['selectedProject'] === true;\r\nvar selectedMode = dsData.filter(function(data) { return data['selectedProject'] === true; }).length > 0;\r\n\r\nvar width = 30;\r\nvar svgStr = getDoktorkitSvg(progress, width, selectedProject);\r\nvar encodedSvg = encodeURIComponent(svgStr);\r\nvar svgUrl = 'data:image/svg+xml,' + encodedSvg;\r\nif (selectedProject) {\r\n  width += 8;\r\n}\r\nreturn {\r\n  url: svgUrl,\r\n  size: width,\r\n  markerOffset: [width / 2, width / 2],\r\n  tooltipOffset: [width * 0.5 - width / 2, -(width / 2)]\r\n};\r\n\r\nfunction getDoktorkitSvg(progress, width, isSelected) {\r\n    var color = getBackgroundColor(progress);\r\n    var background = getBackground(color);\r\n    var svgSize = isSelected ? (width + 8) : width;\r\n    var opacity = selectedMode && !isSelected ? 0.4 : 1;\r\n\r\n    // Home-Icon SVG (zentriert und skaliert)\r\n    var shape = '<g transform=\"translate(10,10) scale(0.8)\">' +\r\n                '<path d=\"M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z\" fill=\"white\"/>' +\r\n                '</g>';\r\n\r\n    var projectSvg = '<svg opacity=\"' + opacity + '\" width=\"' + svgSize + '\" height=\"' + svgSize + '\" viewBox=\"0 0 46 46\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\r\n                     wrapIfSelected(background + shape, isSelected);\r\n    if (isSelected) {\r\n        projectSvg += getProjectSelectionStroke();\r\n    }\r\n    projectSvg += '</svg>';\r\n    return projectSvg;\r\n}\r\n\r\nfunction wrapIfSelected(svg, isSelected) {\r\n    if (isSelected) {\r\n        return '<g transform=\"translate(4,4)\">' + svg + '</g>';\r\n    } else {\r\n        return svg;\r\n    }\r\n}\r\n\r\n// Hintergrundkreis genau mittig\r\nfunction getBackground(color) {\r\n    return '<circle cx=\"19\" cy=\"19\" r=\"15\" fill=\"'+ color +'\"/>';\r\n}\r\n\r\n// Selektionsring exakt um den Hintergrundkreis herum\r\nfunction getProjectSelectionStroke() {\r\n    return '<circle cx=\"23\" cy=\"23\" r=\"18\" stroke=\"#D5C21B\" stroke-width=\"2\"/>';\r\n}\r\n\r\nfunction getBackgroundColor(progress) {\r\n  switch(progress) {\r\n    case 'in preperation': \r\n        return '#CAC1D2'; // --> grau\r\n    case 'finished': \r\n        return '#27AE60'; // --> grün\r\n    case 'active': \r\n        return '#f3de61'; // --> gelb\r\n    default: \r\n        return '#CAC1D2'; // --> grau\r\n  }\r\n}",
            "markerImages": [],
            "showPolygon": false,
            "polygonKeyName": "coordinates",
            "editablePolygon": true,
            "showPolygonLabel": false,
            "usePolygonLabelFunction": false,
            "polygonLabel": "${entityName}",
            "polygonLabelFunction": null,
            "showPolygonTooltip": false,
            "showPolygonTooltipAction": "click",
            "autoClosePolygonTooltip": true,
            "usePolygonTooltipFunction": false,
            "polygonTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${coordinates|ts:7}<br/><br/><link-act name='delete'>Delete</link-act>",
            "polygonTooltipFunction": null,
            "polygonColor": "#3388ff",
            "polygonOpacity": 0.5,
            "usePolygonColorFunction": false,
            "polygonColorFunction": null,
            "polygonStrokeColor": "#3388ff",
            "polygonStrokeOpacity": 1,
            "polygonStrokeWeight": 1,
            "usePolygonStrokeColorFunction": false,
            "polygonStrokeColorFunction": null,
            "showCircle": false,
            "circleKeyName": "perimeter",
            "editableCircle": false,
            "showCircleLabel": false,
            "useCircleLabelFunction": false,
            "circleLabel": "${entityName}",
            "circleLabelFunction": null,
            "showCircleTooltip": false,
            "showCircleTooltipAction": "click",
            "autoCloseCircleTooltip": true,
            "useCircleTooltipFunction": false,
            "circleTooltipPattern": "<b>${entityName}</b><br/><br/><b>TimeStamp:</b> ${ts:7}",
            "circleTooltipFunction": null,
            "circleFillColor": "#3388ff",
            "circleFillColorOpacity": 0.2,
            "useCircleFillColorFunction": false,
            "circleFillColorFunction": null,
            "circleStrokeColor": "#3388ff",
            "circleStrokeOpacity": 1,
            "circleStrokeWeight": 3,
            "useCircleStrokeColorFunction": false,
            "circleStrokeColorFunction": null,
            "snappable": false,
            "initDragMode": false,
            "hideAllControlButton": false,
            "hideDrawControlButton": false,
            "hideEditControlButton": false,
            "hideRemoveControlButton": false,
            "useClusterMarkers": true,
            "zoomOnClick": true,
            "maxZoom": null,
            "maxClusterRadius": 80,
            "animate": true,
            "spiderfyOnMaxZoom": false,
            "showCoverageOnHover": true,
            "chunkedLoading": false,
            "removeOutsideVisibleBounds": true,
            "useIconCreateFunction": false,
            "clusterMarkerFunction": null
          },
          "title": "Markers Placement - OpenStreetMap",
          "dropShadow": false,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "widgetStyle": {},
          "actions": {
            "tooltipAction": [
              {
                "name": "delete-Project",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var $injector = widgetContext.$scope.$injector;\r\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\r\nvar assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nvar entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nvar entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet translationService = $injector.get(widgetContext.servicesMap.get('translate'));\r\n \r\n\r\nlet projectEntityId = entityId.id;\r\nlet customerId;\r\n\r\nlet customerName = widgetContext.stateController.getStateParams().entityName;\r\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n        customerId = widgetContext.stateController.getStateParams().entityId;\r\n    } else {\r\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\r\n    }\r\n\r\n\r\nlet assetSearchQuery = {\r\n  \"parameters\": {\r\n    \"rootId\": projectEntityId,\r\n    \"rootType\": \"ASSET\",\r\n    \"direction\": \"FROM\",\r\n    \"relationTypeGroup\": \"COMMON\",\r\n    \"maxLevel\": 10,\r\n    \"fetchLastLevelOnly\": false\r\n  },\r\n  \"relationType\": \"Owns\",\r\n  \"assetTypes\": [\r\n    \"Measurement\"\r\n  ]\r\n};\r\n\r\nlet doktorkitSearchQuery = {\r\n  \"parameters\": {\r\n    \"rootId\": projectEntityId,\r\n    \"rootType\": \"ASSET\",\r\n    \"direction\": \"FROM\",\r\n    \"relationTypeGroup\": \"COMMON\",\r\n    \"maxLevel\": 10,\r\n    \"fetchLastLevelOnly\": false\r\n  },\r\n  \"relationType\": \"Owns\",\r\n  \"assetTypes\": [\r\n    \"Doktorkit\"\r\n  ]\r\n};\r\n\r\nassetService.findByQuery(assetSearchQuery).subscribe(measurements => {\r\n    assetService.findByQuery(doktorkitSearchQuery).subscribe(doktorkits => {\r\n        openDeleteDoktorkitDialog(measurements, doktorkits);\r\n    })\r\n});\r\n\r\nfunction addKitToUnassignedDoktorkits(doktorkits) {\r\n    return getUnassignedKitGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap((UnassignedKitGroup) => {\r\n            const addKitObservables = doktorkits.map((item) => {\r\n                \r\n                return entityGroupService.addEntityToEntityGroup(UnassignedKitGroup.id.id, item.id.id);\r\n            });\r\n            \r\n            return widgetContext.rxjs.forkJoin(addKitObservables);\r\n        })\r\n    );\r\n}\r\n\r\n\r\nfunction openDeleteDoktorkitDialog(measurements, doktorkits) {\r\n  const title = translationService.instant(\r\n    'custom.doktorkits.delete.title',\r\n    { entityName: entityName }\r\n  );\r\n\r\n  const content = translationService.instant(\r\n    'custom.doktorkits.delete.content',\r\n    { count: measurements.length }\r\n  );\r\n\r\n  dialogs.confirm(\r\n    title,\r\n    content,\r\n    translationService.instant('action.cancel'),\r\n    translationService.instant('action.delete')\r\n  ).subscribe(function(result) {\r\n    if (result) {\r\n      deleteProject(measurements, doktorkits);\r\n    }\r\n  });\r\n}\r\n\r\n\r\nfunction deleteProject(measurements, doktorkits) {\r\n    addKitToUnassignedDoktorkits(doktorkits).subscribe();\r\n    deleteMeasurements(measurements);\r\n    assetService.deleteAsset(entityId.id).subscribe(\r\n        function() {\r\n            widgetContext.updateAliases();\r\n        }\r\n    );  \r\n}\r\n\r\nfunction deleteMeasurements(measurements) {\r\n    measurements.forEach(item => {\r\n        assetService.deleteAsset(item.id.id).subscribe(\r\n            function() {\r\n                widgetContext.updateAliases();\r\n            }\r\n        ); \r\n    })\r\n}\r\n\r\nfunction getUnassignedKitGroup(customerId) {\r\n  return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n      widgetContext.rxjs.switchMap((entityGroups) => {\r\n          var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n          if (UnassignedKitGroup) {\r\n              return widgetContext.rxjs.of(UnassignedKitGroup);\r\n          } else {\r\n              UnassignedKitGroup = {\r\n                  type: 'ASSET',\r\n                  name: 'Unassigned Kit',\r\n                  ownerId: customerId\r\n              };\r\n              return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n          }\r\n      })\r\n  );\r\n}",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "54c293c4-9ca6-e34f-dc6a-0271944c1c66"
              }
            ],
            "markerClick": [
              {
                "name": "Select Project",
                "icon": "more_horiz",
                "useShowWidgetActionFunction": null,
                "showWidgetActionFunction": "return true;",
                "type": "custom",
                "customFunction": "var params = widgetContext.stateController.getStateParams();\nvar selectedProject = params['selectedProject'];\nif (selectedProject && selectedProject.entityId.id === entityId.id) {\n    params['selectedProject'] = null;\n} else {\n    params['selectedProject'] = { entityId: entityId, entityName: entityName, entityLabel: entityLabel };\n}\nwidgetContext.stateController.updateState(null, params);\n/*console.log(\"Params 1: \" + JSON.stringify(params));*/",
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "a9e60950-7eeb-b93c-9044-05234423e0be"
              }
            ]
          },
          "showTitleIcon": false,
          "titleIcon": "more_horiz",
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "displayTimewindow": true,
          "enableDataExport": false,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": ""
        },
        "row": 0,
        "col": 0,
        "id": "b45a8ba5-3b00-23be-6d1c-5f110bc6d3a7"
      },
      "8f5b8cff-bca9-de6a-0e6f-baab364d1f75": {
        "typeFullFqn": "system.map",
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1745755787013,
                "endTimeMs": 1745842187013
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": false,
          "backgroundColor": "rgba(0, 0, 0, 0)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "mapType": "geoMap",
            "layers": [
              {
                "label": "{i18n:widgets.maps.layer.roadmap}",
                "provider": "openstreet",
                "layerType": "CartoDB.Positron",
                "referenceLayer": null
              },
              {
                "label": "{i18n:widgets.maps.layer.satellite}",
                "provider": "openstreet",
                "layerType": "Esri.WorldImagery"
              },
              {
                "label": "{i18n:widgets.maps.layer.hybrid}",
                "provider": "openstreet",
                "layerType": "Esri.WorldImagery",
                "referenceLayer": "openstreetmap_hybrid"
              }
            ],
            "imageSource": null,
            "markers": [
              {
                "dsType": "entity",
                "dsLabel": "",
                "dsDeviceId": null,
                "dsEntityAliasId": "d75c5b86-8b39-59e2-59f3-ae1c1ee40910",
                "dsFilterId": "3744b253-8d5c-7528-b178-0c8be5c3adca",
                "additionalDataSources": null,
                "additionalDataKeys": [
                  {
                    "name": "progress",
                    "type": "attribute",
                    "label": "progress",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.9725950885098493
                  },
                  {
                    "name": "name",
                    "type": "entityField",
                    "label": "name",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.2872987416504812,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  },
                  {
                    "name": "locationName",
                    "type": "attribute",
                    "label": "locationName",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.9686714923687729
                  },
                  {
                    "name": "label",
                    "type": "entityField",
                    "label": "label",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.11734397732048452,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  },
                  {
                    "name": "address",
                    "type": "attribute",
                    "label": "address",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8026110588871542
                  },
                  {
                    "name": "outsideTemp",
                    "type": "timeseries",
                    "label": "outsideTemp",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.759902282076257
                  },
                  {
                    "name": "outsideHumidity",
                    "type": "timeseries",
                    "label": "outsideHumidity",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.05821233805088244
                  }
                ],
                "label": {
                  "show": true,
                  "type": "pattern",
                  "pattern": "${entityName}"
                },
                "tooltip": {
                  "show": true,
                  "trigger": "click",
                  "autoclose": true,
                  "type": "function",
                  "pattern": "<b>${entityName}</b><br/><br/><b>Latitude:</b> ${latitude:7}<br/><b>Longitude:</b> ${longitude:7}<br/><b>Temperature:</b> ${temperature} °C<br/><small>See tooltip settings for details</small>",
                  "offsetX": 0,
                  "offsetY": -1,
                  "patternFunction": "const temperature = data.outsideTemp;\nconst humidity = data.outsideHumidity;\nconst pressure = data.pressure;\nconst longitude = data.longitude;\nconst latitude = data.latitude;\nvar locationName = data.locationName || 'N/A';\nconst installationType = data.installationType;\nconst address = data.address;\nconst name = data.name;\nconst label = data.label;\n/*console.log(data[0]);\nconsole.log(data[1]);\nconsole.log(data[2]);\nconsole.log(data);\nconsole.log(dsData[dsData.length -1]);*/\nconst userRole = dsData[dsData.length -1].role;\n\n\n\n// Alarms\nconst state = data.state;\nconst progress = data.progress;\nconst criticalAlarms = data.criticalAlarmsCount || 'N/A';\nconst majorAlarms = data.majorAlarmsCount || 'N/A';\nconst minorAlarms = data.minorAlarmsCount || 'N/A';\nconst warningAlarms = data.warningAlarmsCount || 'N/A';\n\n// Farben für Alarms\nconst criticalAlarmsColor = '#FF0000'; // Rot\nconst criticalAlarmsBgColor =\n'rgba(255, 0, 0, 0.1)'; // Transparenter Rot\n\nconst majorAlarmsColor = '#FF8C00'; // Orange\nconst majorAlarmsBgColor =\n'rgba(255, 140, 0, 0.1)'; // Transparenter Orange\n\nconst minorAlarmsColor = '#FFD700'; // Gold\nconst minorAlarmsBgColor =\n'rgba(255, 215, 0, 0.1)'; // Transparenter Gold\n\nconst warningAlarmsColor = '#000000'; // Schwarz\nconst warningAlarmsBgColor =\n'rgba(128, 128, 128, 0.1)'; // Transparenter Grau\n\nvar ButtonHtml = '';\nif (userRole !== \"Belimo Retrofit Users\") {\n    ButtonHtml = '<div style=\"text-align: center\">' +\n        '<link-act name=\"all_measurements\">Edit Measurements</link-act>' +\n        '</div>';\n}\nconsole.log(ButtonHtml);\n\nif (locationName === 'N/A') {\n    locationName = label;\n}\n\nreturn '<div style=\"display:flex;flex-direction:column;margin-bottom:8px;font-family:\\'Roboto\\';font-weight:500;font-size:16px;line-height:24px;letter-spacing:0.25px;color:#29313C\">' +\n    '<div>' + locationName + ' | ' + name + '</div>' +\n    '<div style=\"width: 100%;border-bottom:1px solid rgba(0, 0, 0, 0.12);margin:12px 0;\"></div>' +\n\n    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Address</div>' +\n    '<div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px\">' +\n    address + '</div>' +\n    '</div>' +\n/*    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Critical Alarms</div>' +\n    '<div style=\"width:fit-content;padding:4px 8px;border-radius:8px;line-height:20px;font-size:14px;font-weight:500;letter-spacing:0.25px;color:' +\n    criticalAlarmsColor + ';background-color:' +\n    criticalAlarmsBgColor + '\">' + criticalAlarms +\n    '</div>' +\n    '</div>' +\n    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Major Alarms</div>' +\n    '<div style=\"width:fit-content;padding:4px 8px;border-radius:8px;line-height:20px;font-size:14px;font-weight:500;letter-spacing:0.25px;color:' +\n    majorAlarmsColor + ';background-color:' +\n    majorAlarmsBgColor + '\">' + majorAlarms + '</div>' +\n    '</div>' +\n    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Minor Alarms</div>' +\n    '<div style=\"width:fit-content;padding:4px 8px;border-radius:8px;line-height:20px;font-size:14px;font-weight:500;letter-spacing:0.25px;color:' +\n    minorAlarmsColor + ';background-color:' +\n    minorAlarmsBgColor + '\">' + minorAlarms + '</div>' +\n    '</div>' +\n    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Warning Alarms</div>' +\n    '<div style=\"width:fit-content;padding:4px 8px;border-radius:8px;line-height:20px;font-size:14px;font-weight:500;letter-spacing:0.25px;color:' +\n    warningAlarmsColor + ';background-color:' +\n    warningAlarmsBgColor + '\">' + warningAlarms + '</div>' +\n    '</div>' +*/\n    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Temperature</div>' +\n    '<div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px\">' +\n    temperature + ' °C</div>' +\n    '</div>' +\n    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Humidity</div>' +\n    '<div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px\">' +\n    humidity + ' % r.H.</div>' +\n    '</div>' +\n    ButtonHtml +\n    '</div>';",
                  "tagActions": [
                    {
                      "name": "all_measurements",
                      "type": "custom",
                      "customFunction": "var params = JSON.parse(JSON.stringify(widgetContext.stateController.getStateParams()));\nparams['selectedProject'] = {\n        entityId: entityId,\n        entityName: entityName,\n        entityLabel: entityLabel,\n};\nparams['targetEntityParamName'] = 'selectedProject';\n/*params['selectedMeasurement'] = null;*/\n/*console.log(\"Params 2: \" + JSON.stringify(params));*/\nwidgetContext.stateController.openState('all_measurements', params);\t",
                      "openInSeparateDialog": false,
                      "openInPopover": false
                    }
                  ]
                },
                "click": {
                  "type": "custom",
                  "customFunction": "var params = widgetContext.stateController.getStateParams();\nvar selectedProject = params['selectedProject'];\nif (selectedProject && selectedProject.entityId.id === entityId.id) {\n    params['selectedProject'] = null;\n} else {\n    params['selectedProject'] = { entityId: entityId, entityName: entityName, entityLabel: entityLabel };\n}\nwidgetContext.stateController.updateState(null, params);\n/*console.log(\"Params 1: \" + JSON.stringify(params));*/",
                  "openInSeparateDialog": false,
                  "openInPopover": false
                },
                "groups": null,
                "edit": {
                  "enabledActions": [
                    "add",
                    "move"
                  ],
                  "attributeScope": "SERVER_SCOPE",
                  "snappable": false
                },
                "xKey": {
                  "name": "latitude",
                  "label": "latitude",
                  "type": "attribute",
                  "settings": {},
                  "color": "#2196f3"
                },
                "yKey": {
                  "name": "longitude",
                  "label": "longitude",
                  "type": "attribute",
                  "settings": {},
                  "color": "#2196f3"
                },
                "markerType": "icon",
                "markerShape": {
                  "shape": "markerShape1",
                  "size": 34,
                  "color": {
                    "type": "constant",
                    "color": "#307FE5"
                  }
                },
                "markerIcon": {
                  "iconContainer": "iconContainer4",
                  "icon": "domain",
                  "size": 40,
                  "color": {
                    "type": "function",
                    "color": "#307FE5",
                    "rangeKey": null,
                    "range": null,
                    "colorFunction": "function getBackgroundColor(progress) {\r\n  switch(progress) {\r\n    case 'in preparation': \r\n        return '#9C27B0'; // '#CAC1D2'--> grau\r\n    case 'finished': \r\n        return '#4CAF50'; // --> grün\r\n    case 'active': \r\n        return '#F5DD00'; // --> gelb\r\n    default: \r\n        return 'black'; // --> grau\r\n  }\r\n}\r\n\r\nreturn getBackgroundColor(data.progress);"
                  }
                },
                "markerImage": {
                  "type": "image",
                  "image": "/assets/markers/shape1.svg",
                  "imageSize": 34
                },
                "markerOffsetX": 0.5,
                "markerOffsetY": 1,
                "markerClustering": {
                  "enable": true,
                  "zoomOnClick": true,
                  "maxZoom": null,
                  "maxClusterRadius": 80,
                  "zoomAnimation": true,
                  "showCoverageOnHover": true,
                  "spiderfyOnMaxZoom": false,
                  "chunkedLoad": false,
                  "lazyLoad": true,
                  "useClusterMarkerColorFunction": false,
                  "clusterMarkerColorFunction": null
                }
              }
            ],
            "polygons": [],
            "circles": [],
            "additionalDataSources": [
              {
                "dsType": "entity",
                "dsLabel": "",
                "dataKeys": [
                  {
                    "name": "latitude",
                    "type": "attribute",
                    "label": "selectedProject",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.5634367819170003,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  }
                ],
                "dsEntityAliasId": "faef915b-be60-5c6b-d62c-114957e80421"
              },
              {
                "dsType": "entity",
                "dsLabel": "",
                "dataKeys": [
                  {
                    "name": "role",
                    "type": "attribute",
                    "label": "role",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.7014478669430672
                  }
                ],
                "dsEntityAliasId": "203b0867-b867-ef98-1791-03046c133b7d"
              }
            ],
            "controlsPosition": "topleft",
            "zoomActions": [
              "scroll",
              "doubleClick",
              "controlButtons"
            ],
            "scales": [
              "metric"
            ],
            "dragModeButton": false,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "defaultCenterPosition": "0,0",
            "defaultZoomLevel": null,
            "mapPageSize": 16384,
            "mapActionButtons": [],
            "background": {
              "type": "color",
              "color": "#fff",
              "overlay": {
                "enabled": false,
                "color": "rgba(255,255,255,0.72)",
                "blur": 3
              }
            },
            "padding": "8px"
          },
          "title": "Map",
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "showTitleIcon": false,
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": true,
          "widgetStyle": {},
          "widgetCss": "",
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "configMode": "advanced",
          "titleFont": null,
          "titleColor": null,
          "margin": "0px",
          "borderRadius": "8px",
          "iconSize": "24px",
          "titleIcon": "map",
          "iconColor": "#1F6BDD",
          "actions": {},
          "enableDataExport": false
        },
        "row": 0,
        "col": 0,
        "id": "8f5b8cff-bca9-de6a-0e6f-baab364d1f75"
      },
      "812eba56-40ea-35cd-6287-dffef871b246": {
        "typeFullFqn": "system.map",
        "type": "latest",
        "sizeX": 8.5,
        "sizeY": 6,
        "config": {
          "datasources": [],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1745755787013,
                "endTimeMs": 1745842187013
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": true,
          "backgroundColor": "rgba(0, 0, 0, 0)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "0px",
          "settings": {
            "mapType": "geoMap",
            "layers": [
              {
                "label": "{i18n:widgets.maps.layer.roadmap}",
                "provider": "openstreet",
                "layerType": "CartoDB.Positron",
                "referenceLayer": null
              },
              {
                "label": "{i18n:widgets.maps.layer.satellite}",
                "provider": "openstreet",
                "layerType": "Esri.WorldImagery"
              },
              {
                "label": "{i18n:widgets.maps.layer.hybrid}",
                "provider": "openstreet",
                "layerType": "Esri.WorldImagery",
                "referenceLayer": "openstreetmap_hybrid"
              },
              {
                "label": "Topographic",
                "provider": "openstreet",
                "layerType": "Esri.WorldTopoMap",
                "referenceLayer": null
              },
              {
                "label": "Hot",
                "provider": "openstreet",
                "layerType": "OpenStreetMap.HOT",
                "referenceLayer": null
              },
              {
                "label": null,
                "provider": "openstreet",
                "layerType": "Esri.WorldStreetMap",
                "referenceLayer": null
              }
            ],
            "imageSource": null,
            "markers": [
              {
                "dsType": "entity",
                "dsLabel": "",
                "dsDeviceId": null,
                "dsEntityAliasId": "df6ecbc0-0dae-bc9b-fbeb-96b5c11f9ebc",
                "dsFilterId": "3744b253-8d5c-7528-b178-0c8be5c3adca",
                "additionalDataSources": null,
                "additionalDataKeys": [
                  {
                    "name": "progress",
                    "type": "attribute",
                    "label": "progress",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.9725950885098493
                  },
                  {
                    "name": "name",
                    "type": "entityField",
                    "label": "name",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.2872987416504812,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  },
                  {
                    "name": "locationName",
                    "type": "attribute",
                    "label": "locationName",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.9686714923687729
                  },
                  {
                    "name": "label",
                    "type": "entityField",
                    "label": "label",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.11734397732048452,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  },
                  {
                    "name": "address",
                    "type": "attribute",
                    "label": "address",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.8026110588871542
                  },
                  {
                    "name": "outsideTemp",
                    "type": "timeseries",
                    "label": "outsideTemp",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.759902282076257
                  },
                  {
                    "name": "outsideHumidity",
                    "type": "timeseries",
                    "label": "outsideHumidity",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.05821233805088244
                  }
                ],
                "label": {
                  "show": true,
                  "type": "function",
                  "pattern": "${entityName}",
                  "patternFunction": "function getBackgroundColor(progress) {\r\n  switch(progress) {\r\n    case 'in preparation': \r\n        return '#9C27B0'; // '#CAC1D2'--> grau\r\n    case 'finished': \r\n        return '#4CAF50'; // --> grün\r\n    case 'active': \r\n        return '#F5DD00'; // --> gelb\r\n    default: \r\n        return 'black'; // --> grau\r\n  }\r\n}\r\n\r\nvar color = getBackgroundColor(data.progress);\r\n\r\nreturn '<span style=\"border: solid ' + color + '; border-radius: 10px; color: ' + color + '; background-color: #fff; padding: 3px 5px; font-size: 14px; position: relative; bottom: 6px;\">' + \r\n           '${entityName}' + \r\n        '</span>';"
                },
                "tooltip": {
                  "show": true,
                  "type": "function",
                  "pattern": "<b>${entityName}</b><br/><br/><b>Latitude:</b> ${latitude:7}<br/><b>Longitude:</b> ${longitude:7}<br/><b>Temperature:</b> ${temperature} °C<br/><small>See tooltip settings for details</small>",
                  "patternFunction": "const temperature = data.outsideTemp;\nconst humidity = data.outsideHumidity;\nconst pressure = data.pressure;\nconst longitude = data.longitude;\nconst latitude = data.latitude;\nvar locationName = data.locationName || 'N/A';\nconst installationType = data.installationType;\nconst address = data.address;\nconst name = data.name;\nconst label = data.label;\n/*console.log(data[0]);\nconsole.log(data[1]);\nconsole.log(data[2]);\nconsole.log(data);\nconsole.log(dsData[dsData.length -1]);*/\nconst userRole = dsData[dsData.length -1].role;\n\n// Alarms\nconst state = data.state;\nconst progress = data.progress;\nconst criticalAlarms = data.criticalAlarmsCount || 'N/A';\nconst majorAlarms = data.majorAlarmsCount || 'N/A';\nconst minorAlarms = data.minorAlarmsCount || 'N/A';\nconst warningAlarms = data.warningAlarmsCount || 'N/A';\n\n// Farben für Alarms\nconst criticalAlarmsColor = '#FF0000'; // Rot\nconst criticalAlarmsBgColor =\n'rgba(255, 0, 0, 0.1)'; // Transparenter Rot\n\nconst majorAlarmsColor = '#FF8C00'; // Orange\nconst majorAlarmsBgColor =\n'rgba(255, 140, 0, 0.1)'; // Transparenter Orange\n\nconst minorAlarmsColor = '#FFD700'; // Gold\nconst minorAlarmsBgColor =\n'rgba(255, 215, 0, 0.1)'; // Transparenter Gold\n\nconst warningAlarmsColor = '#000000'; // Schwarz\nconst warningAlarmsBgColor =\n'rgba(128, 128, 128, 0.1)'; // Transparenter Grau\n\nvar ButtonHtml = '';\nif (userRole !== \"Belimo Retrofit Users\") {\n    ButtonHtml = '<div style=\"text-align: center\">' +\n        '<link-act name=\"delete-project\">Delete Project</link-act>' +\n        '</div>';\n}\n\nif (locationName === 'N/A') {\n    locationName = label;\n}\n\nreturn '<div style=\"display:flex;flex-direction:column;margin-bottom:8px;font-family:\\'Roboto\\';font-weight:500;font-size:16px;line-height:24px;letter-spacing:0.25px;color:#29313C\">' +\n    '<div>' + locationName + ' | ' + name + '</div>' +\n    '<div style=\"width: 100%;border-bottom:1px solid rgba(0, 0, 0, 0.12);margin:12px 0;\"></div>' +\n\n    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Address</div>' +\n    '<div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px\">' +\n    address + '</div>' +\n    '</div>' +\n/*    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Critical Alarms</div>' +\n    '<div style=\"width:fit-content;padding:4px 8px;border-radius:8px;line-height:20px;font-size:14px;font-weight:500;letter-spacing:0.25px;color:' +\n    criticalAlarmsColor + ';background-color:' +\n    criticalAlarmsBgColor + '\">' + criticalAlarms +\n    '</div>' +\n    '</div>' +\n    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Major Alarms</div>' +\n    '<div style=\"width:fit-content;padding:4px 8px;border-radius:8px;line-height:20px;font-size:14px;font-weight:500;letter-spacing:0.25px;color:' +\n    majorAlarmsColor + ';background-color:' +\n    majorAlarmsBgColor + '\">' + majorAlarms + '</div>' +\n    '</div>' +\n    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Minor Alarms</div>' +\n    '<div style=\"width:fit-content;padding:4px 8px;border-radius:8px;line-height:20px;font-size:14px;font-weight:500;letter-spacing:0.25px;color:' +\n    minorAlarmsColor + ';background-color:' +\n    minorAlarmsBgColor + '\">' + minorAlarms + '</div>' +\n    '</div>' +\n    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Warning Alarms</div>' +\n    '<div style=\"width:fit-content;padding:4px 8px;border-radius:8px;line-height:20px;font-size:14px;font-weight:500;letter-spacing:0.25px;color:' +\n    warningAlarmsColor + ';background-color:' +\n    warningAlarmsBgColor + '\">' + warningAlarms + '</div>' +\n    '</div>' +*/\n    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Temperature</div>' +\n    '<div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px\">' +\n    temperature + ' °C</div>' +\n    '</div>' +\n    '<div style=\"display:flex;flex-direction:row;align-items:baseline;margin-bottom:9px;\">' +\n    '<div style=\"font-size:13px;line-height:16px;font-weight:500;color:rgba(0, 0, 0, 0.38);width:100px\">Humidity</div>' +\n    '<div style=\"font-size:14px;line-height:20px;font-weight:500;letter-spacing:0.25px\">' +\n    humidity + ' % r.H.</div>';\n/*    '</div>' +\n    ButtonHtml +\n    '</div>';*/",
                  "trigger": "click",
                  "autoclose": true,
                  "offsetX": 0,
                  "offsetY": -1,
                  "tagActions": [
                    {
                      "name": "all_measurements",
                      "type": "custom",
                      "customFunction": "var params = JSON.parse(JSON.stringify(widgetContext.stateController.getStateParams()));\nparams['selectedProject'] = {\n        entityId: entityId,\n        entityName: entityName,\n        entityLabel: entityLabel,\n};\nparams['targetEntityParamName'] = 'selectedProject';\n/*params['selectedMeasurement'] = null;*/\nconsole.log(\"Params 2: \" + JSON.stringify(params));\nwidgetContext.stateController.openState('all_measurements', params);",
                      "openInSeparateDialog": false,
                      "openInPopover": false
                    },
                    {
                      "name": "delete-project",
                      "type": "custom",
                      "customFunction": "// Injector & service setup\r\nconst $injector          = widgetContext.$scope.$injector;\r\nconst dialogs            = $injector.get(widgetContext.servicesMap.get('dialogs'));\r\nconst assetService       = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nconst deviceService      = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nconst entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\n\r\n// IDs & names\r\nconst projectEntityId = entityId.id;\r\nlet customerId;\r\nif (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n  customerId = widgetContext.stateController.getStateParams().entityId;\r\n} else {\r\n  customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER' };\r\n}\r\nconst projectName = entityName;\r\n\r\n// Search query for Measurements owned by this project\r\nconst assetSearchQuery = {\r\n  parameters: {\r\n    rootId:             projectEntityId,\r\n    rootType:           'ASSET',\r\n    direction:          'FROM',\r\n    relationTypeGroup:  'COMMON',\r\n    maxLevel:           10,\r\n    fetchLastLevelOnly: false\r\n  },\r\n  relationType: 'Owns',\r\n  assetTypes:   ['Measurement']\r\n};\r\n\r\n// 1) Load measurements, VR‐devices & devices in parallel\r\nassetService.findByQuery(assetSearchQuery).pipe(\r\n  widgetContext.rxjs.switchMap(measurements => {\r\n    const vrCalls = measurements.map(m => {\r\n      const q = {\r\n        parameters: { rootId: m.id.id, rootType: 'ASSET', direction: 'FROM', relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false },\r\n        relationType: 'Measurement VR',\r\n        deviceTypes:  ['P-Flow D116 VR','Temperature Sensor VR','Room Sensor CO2 VR','Gateway VR']\r\n      };\r\n      return deviceService.findByQuery(q);\r\n    });\r\n    const devCalls = measurements.map(m => {\r\n      const q = {\r\n        parameters: { rootId: m.id.id, rootType: 'ASSET', direction: 'FROM', relationTypeGroup: 'COMMON', maxLevel: 10, fetchLastLevelOnly: false },\r\n        relationType: 'Measurement',\r\n        deviceTypes:  ['P-Flow D116','Temperature Sensor','Room Sensor CO2','Gateway','RESI']\r\n      };\r\n      return deviceService.findByQuery(q);\r\n    });\r\n    return widgetContext.rxjs.forkJoin({\r\n      measurements: widgetContext.rxjs.of(measurements),\r\n      vrArrays:     widgetContext.rxjs.forkJoin(vrCalls),\r\n      deviceArrays: widgetContext.rxjs.forkJoin(devCalls)\r\n    });\r\n  })\r\n).subscribe(({ measurements, vrArrays, deviceArrays }) => {\r\n  const vrDevices = vrArrays.flat();\r\n  const devices   = deviceArrays.flat();\r\n\r\n  // 2) Open confirmation dialog\r\n  const title   = `Are you sure you want to delete the Project ${projectName}?`;\r\n  const content = `Be careful: this will delete the project and its ${measurements.length} measurements.`;\r\n  dialogs.confirm(title, content, 'Cancel', 'Delete').pipe(\r\n    widgetContext.rxjs.filter(Boolean),\r\n    // 3) assign & delete sequence\r\n    widgetContext.rxjs.switchMap(() =>\r\n      // wrap the assign step in catchError so a 404 here won't abort everything\r\n      assignToUnassignedMeasurementsGroup(devices).pipe(\r\n        widgetContext.rxjs.catchError(err => {\r\n          console.warn('Could not assign devices—continuing delete anyway', err);\r\n          return widgetContext.rxjs.of(null);\r\n        }),\r\n        // then delete VR devices\r\n        widgetContext.rxjs.switchMap(() =>\r\n          widgetContext.rxjs.forkJoin(\r\n            vrDevices.map(d =>\r\n              deviceService.deleteDevice(d.id.id).pipe(\r\n                widgetContext.rxjs.catchError(err => {\r\n                  console.error(`Error deleting VR device ${d.id.id}:`, err);\r\n                  return widgetContext.rxjs.of(null);\r\n                })\r\n              )\r\n            )\r\n          )\r\n        ),\r\n        // then delete measurements\r\n        widgetContext.rxjs.switchMap(() =>\r\n          widgetContext.rxjs.forkJoin(\r\n            measurements.map(m =>\r\n              assetService.deleteAsset(m.id.id).pipe(\r\n                widgetContext.rxjs.catchError(err => {\r\n                  console.error(`Error deleting measurement ${m.id.id}:`, err);\r\n                  return widgetContext.rxjs.of(null);\r\n                })\r\n              )\r\n            )\r\n          )\r\n        ),\r\n        // finally delete the project asset\r\n        widgetContext.rxjs.switchMap(() =>\r\n          assetService.deleteAsset(projectEntityId).pipe(\r\n            widgetContext.rxjs.catchError(err => {\r\n              console.error(`Error deleting project ${projectEntityId}:`, err);\r\n              return widgetContext.rxjs.of(null);\r\n            })\r\n          )\r\n        )\r\n      )\r\n    )\r\n  ).subscribe({\r\n    next: () => widgetContext.updateAliases(),\r\n    error: err => console.error('Delete flow fatal error:', err)\r\n  });\r\n});\r\n\r\n// Helper: assign all devices into “Unassigned Measurement Devices” group\r\nfunction assignToUnassignedMeasurementsGroup(devices) {\r\n    \r\n  return getUnassignedMeasurementGroup(customerId).pipe(\r\n    widgetContext.rxjs.switchMap(group => {\r\n        console.log(\"group\", group);\r\n        console.log(\"devices\", devices[0]);\r\n      const adds = devices.map(d =>\r\n        entityGroupService.addEntityToEntityGroup(/*group.id.id*/ \"61542e91-25c4-11f0-96af-dfbf0c87e3fe\", d.id.id).pipe(\r\n          widgetContext.rxjs.catchError(err => {\r\n            console.error(`Error assigning device ${d.id.id}:`, err);\r\n            return widgetContext.rxjs.of(null);\r\n          })\r\n        )\r\n      );\r\n      return widgetContext.rxjs.forkJoin(adds.length ? adds : [widgetContext.rxjs.of(null)]);\r\n    })\r\n  );\r\n}\r\n\r\n// Helper: get or create the “Unassigned Measurement Devices” group\r\nfunction getUnassignedMeasurementGroup(customerId) {\r\n  return entityGroupService\r\n    .getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE')\r\n    .pipe(\r\n      widgetContext.rxjs.switchMap(entityGroups => {\r\n        const grp = entityGroups.find(g => g.name === 'Unassigned Measurement Devices');\r\n        if (grp) {\r\n          return widgetContext.rxjs.of(grp);\r\n        } else {\r\n          const newGrp = { type: 'DEVICE', name: 'Unassigned Measurement Devices', ownerId: customerId };\r\n          return entityGroupService.saveEntityGroup(newGrp);\r\n        }\r\n      })\r\n    );\r\n}\r\n",
                      "openInSeparateDialog": false,
                      "openInPopover": false
                    }
                  ]
                },
                "click": {
                  "type": "custom",
                  "customFunction": "var params = widgetContext.stateController.getStateParams();\nvar selectedProject = params['selectedProject'];\nif (selectedProject && selectedProject.entityId.id === entityId.id) {\n    params['selectedProject'] = null;\n} else {\n    params['selectedProject'] = { entityId: entityId, entityName: entityName, entityLabel: entityLabel };\n}\nwidgetContext.stateController.updateState(null, params);\n/*console.log(\"Params 1: \" + JSON.stringify(params));*/",
                  "openInSeparateDialog": false,
                  "openInPopover": false
                },
                "groups": null,
                "edit": {
                  "enabledActions": [
                    "add",
                    "move"
                  ],
                  "attributeScope": "SERVER_SCOPE",
                  "snappable": false
                },
                "xKey": {
                  "name": "latitude",
                  "label": "latitude",
                  "type": "attribute",
                  "settings": {},
                  "color": "#2196f3"
                },
                "yKey": {
                  "name": "longitude",
                  "label": "longitude",
                  "type": "attribute",
                  "settings": {},
                  "color": "#2196f3"
                },
                "markerType": "icon",
                "markerShape": {
                  "shape": "markerShape1",
                  "size": 34,
                  "color": {
                    "type": "constant",
                    "color": "#307FE5"
                  }
                },
                "markerIcon": {
                  "iconContainer": "iconContainer4",
                  "icon": "domain",
                  "size": 40,
                  "color": {
                    "type": "function",
                    "color": "#307FE5",
                    "rangeKey": null,
                    "range": null,
                    "colorFunction": "function getBackgroundColor(progress) {\r\n  switch(progress) {\r\n    case 'in preparation': \r\n        return '#9C27B0'; // '#CAC1D2'--> grau\r\n    case 'finished': \r\n        return '#4CAF50'; // --> grün\r\n    case 'active': \r\n        return '#F5DD00'; // --> gelb\r\n    default: \r\n        return 'black'; // --> grau\r\n  }\r\n}\r\n\r\nreturn getBackgroundColor(data.progress);"
                  }
                },
                "markerImage": {
                  "type": "image",
                  "image": "/assets/markers/shape1.svg",
                  "imageSize": 34
                },
                "markerOffsetX": 0.5,
                "markerOffsetY": 1,
                "markerClustering": {
                  "enable": true,
                  "zoomOnClick": true,
                  "maxZoom": null,
                  "maxClusterRadius": 80,
                  "zoomAnimation": true,
                  "showCoverageOnHover": true,
                  "spiderfyOnMaxZoom": true,
                  "chunkedLoad": false,
                  "lazyLoad": true,
                  "useClusterMarkerColorFunction": false,
                  "clusterMarkerColorFunction": null
                }
              }
            ],
            "polygons": [],
            "circles": [],
            "additionalDataSources": [
              {
                "dsType": "entity",
                "dsLabel": "",
                "dataKeys": [
                  {
                    "name": "latitude",
                    "type": "attribute",
                    "label": "selectedProject",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.5634367819170003,
                    "aggregationType": null,
                    "units": null,
                    "decimals": null,
                    "funcBody": null,
                    "usePostProcessing": null,
                    "postFuncBody": null
                  }
                ],
                "dsEntityAliasId": "faef915b-be60-5c6b-d62c-114957e80421"
              },
              {
                "dsType": "entity",
                "dsLabel": "",
                "dataKeys": [
                  {
                    "name": "role",
                    "type": "attribute",
                    "label": "role",
                    "color": "#2196f3",
                    "settings": {},
                    "_hash": 0.7014478669430672
                  }
                ],
                "dsEntityAliasId": "203b0867-b867-ef98-1791-03046c133b7d"
              }
            ],
            "controlsPosition": "topleft",
            "zoomActions": [
              "scroll",
              "doubleClick",
              "controlButtons"
            ],
            "scales": [
              "metric"
            ],
            "dragModeButton": false,
            "fitMapBounds": true,
            "useDefaultCenterPosition": false,
            "defaultCenterPosition": "48.140447,11.569030",
            "defaultZoomLevel": null,
            "mapPageSize": 16384,
            "mapActionButtons": [
              {
                "label": "{i18n:custom.projects.project.add-project}",
                "icon": "add",
                "color": "#0000008a",
                "action": {
                  "type": "placeMapItem",
                  "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addProjectFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 350px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{'custom.projects.project.add-project' | translate}}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <div class=\"flex flex-col gap-0 sm:gap-2\">\r\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n            <mat-label>{{'custom.diagnostics.project-id.title' | translate}}</mat-label>\r\n            <input matInput formControlName=\"name\" required readonly>\r\n            <mat-error *ngIf=\"addProjectFormGroup.get('name').hasError('required')\">\r\n              {{'custom.projects.add-project.project-title-required' | translate}}\r\n            </mat-error>\r\n        </mat-form-field>\r\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n            <mat-label>Label</mat-label>\r\n            <input matInput formControlName=\"entityLabel\">\r\n        </mat-form-field>\r\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n            <mat-label>{{'custom.projects.add-project.project-address' | translate}}</mat-label>\r\n            <input matInput formControlName=\"address\">\r\n        </mat-form-field>\r\n    </div>\r\n  </div>\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button mat-button color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\" cdkFocusInitial>\r\n      {{'action.cancel' | translate}}\r\n    </button>\r\n    <button mat-button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(isLoading$ | async) || addProjectFormGroup.invalid || !addProjectFormGroup.dirty\">\r\n      {{'custom.projects.project.add-project' | translate}}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                  "customCss": "",
                  "customFunction": "/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n\nlet $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet customerId;\nlet shortNameAttr;\nlet customerShortName;\nlet nextProjectId = 0;\n\nlet customerName = widgetContext.stateController.getStateParams().entityName;\nlet userRole = widgetContext.stateController.getStateParams().userRole;\n\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN' || userRole === 'ECO Administrator') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\nconsole.log(\"CustomerID: \", customerId.id);\n\nlet assetSearchQuery = {\n  \"parameters\": {\n    \"rootId\": customerId.id,\n    \"rootType\": \"CUSTOMER\",\n    \"direction\": \"FROM\",\n    \"relationTypeGroup\": \"COMMON\",\n    \"maxLevel\": 10,\n    \"fetchLastLevelOnly\": false\n  },\n  \"relationType\": \"Owns\",\n  \"assetTypes\": [\n    \"Project\"\n  ]\n};\n\nconsole.log(\"Asset Search Query: \", assetSearchQuery);\n\nassetService.findByQuery(assetSearchQuery).subscribe(projects => {\n    console.log(\"Projects: \", projects);\n    nextProjectId = getLastProjectId(projects);\n    console.log(\"Next Project ID: \", nextProjectId);\n    attributeService.getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName']).subscribe(attributes => {\n        shortNameAttr = attributes.find(attr => attr.key === 'shortName');\n        customerShortName = shortNameAttr ? shortNameAttr.value : customerName;\n        openAddProjectDialog();\n    });\n});\n\nfunction getLastProjectId(projects) {\n    let maxNumber = 0;\n    projects.forEach(item => {\n        const name = item.name;\n        const parts = name.split('_');\n        if (parts.length === 2) {\n            const number = parseInt(parts[1], 10);\n            if (number > maxNumber) {\n                maxNumber = number;\n            }\n        }\n    });\n    const nextProjectId = maxNumber + 1;\n    return nextProjectId;\n}\n\nfunction openAddProjectDialog() {\n  customDialog.customDialog(htmlTemplate, AddProjectDialogController).subscribe();\n}\n\nfunction AddProjectDialogController(instance) {\n  let vm = instance;\n\n  vm.addProjectFormGroup = vm.fb.group({\n    name: [customerShortName + \"_\" + nextProjectId, [vm.validators.required]],\n    entityLabel: [''],\n    address: ['']\n  });\n\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n    \n    vm.save = function () {\n    vm.addProjectFormGroup.markAsPristine();\n    saveProjectObservable(customerId).subscribe(\n      function (Project) {\n          widgetContext.rxjs.forkJoin([\n              saveCustomerToProjectRelation(customerId, Project.id),\n              saveAttributes(Project.id)\n          ]).subscribe(\n              function () {\n                var params = widgetContext.stateController.getStateParams();\n                var selectedProject = params['selectedProject'];\n                params['selectedProject'] = { entityId: Project.id, entityName: Project.name, entityLabel: '' };\n                widgetContext.updateAliases();\n                vm.dialogRef.close(null);\n              }\n        );\n      }\n    );\n    };\n\n/*    function saveEntityObservable() {\n        const formValues = vm.addEntityFormGroup.value;\n        let entity = {\n            name: formValues.entityName,\n            type: formValues.type,\n            label: formValues.entityLabel\n        };\n        if (formValues.entityType == 'ASSET') {\n            return assetService.saveAsset(entity);\n        } else if (formValues.entityType == 'DEVICE') {\n            return deviceService.saveDevice(entity);\n        }\n    }*/\n    \n    function saveProjectObservable(customerId) {\n    return getProjectsGroup(customerId).pipe(\n        widgetContext.rxjs.switchMap((ProjectsGroup) => {\n            const formValues = vm.addProjectFormGroup.value;\n            let Project = {\n              name: formValues.name,\n              type: 'Project',\n              label: formValues.entityLabel,\n              customerId: customerId\n            };\n            return assetService.saveAsset(Project, ProjectsGroup.id.id)\n        })\n    );\n    }\n\n    function saveAttributes(entityId) {\n        let attributesArray = getMapItemLocationAttributes();\n        attributesArray.push({key: 'address', value: vm.addProjectFormGroup.value.address});\n        attributesArray.push({key: 'progress', value: 'in preparation'});\n        attributesArray.push({key: 'units', value: 'metric'});\n        \n        if (attributesArray.length > 0) {\n            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n        }\n        return widgetContext.rxjs.of([]);\n    }\n    \n    function getProjectsGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\n          widgetContext.rxjs.switchMap((entityGroups) => {\n              var ProjectsGroup = entityGroups.find(group => group.name === 'Projects');\n              if (ProjectsGroup) {\n                  return widgetContext.rxjs.of(ProjectsGroup);\n              } else {\n                  ProjectsGroup = {\n                      type: 'ASSET',\n                      name: 'Projects',\n                      ownerId: customerId\n                  };\n                  return entityGroupService.saveEntityGroup(ProjectsGroup);\n              }\n          })\n      );\n    }\n    \n    function saveCustomerToProjectRelation(customerId, ProjectId) {\n      var relation = {\n          from: customerId,\n          to: ProjectId,\n          typeGroup: 'COMMON',\n          type: 'Owns'\n      };\n      return entityRelationService.saveRelation(relation);\n    }\n\n    function getMapItemLocationAttributes() {\n        const attributes = [];\n        const mapItemType = $event.shape;\n        if (mapItemType === 'Marker') {\n            const mapType = widgetContext.mapInstance.type();\n            attributes.push({key: mapType === 'image' ? 'xPos' : 'latitude', value: additionalParams.coordinates.x});\n            attributes.push({key: mapType === 'image' ? 'yPos' : 'longitude', value: additionalParams.coordinates.y});\n        } else if (mapItemType === 'Rectangle' || mapItemType === 'Polygon') {\n            attributes.push({key: 'perimeter', value: additionalParams.coordinates});\n        } else if (mapItemType === 'Circle') {\n            attributes.push({key: 'circle', value: additionalParams.coordinates});\n        }\n        return attributes;\n    }\n}\n",
                  "customResources": [],
                  "mapItemType": "marker",
                  "mapItemTooltips": {},
                  "openInSeparateDialog": false,
                  "openInPopover": false
                }
              }
            ],
            "background": {
              "type": "color",
              "color": "#fff",
              "overlay": {
                "enabled": false,
                "color": "rgba(255,255,255,0.72)",
                "blur": 3
              }
            },
            "padding": "8px"
          },
          "title": "{i18n:custom.diagnostics.projects.title}",
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "showTitleIcon": false,
          "titleTooltip": "",
          "dropShadow": false,
          "enableFullscreen": false,
          "widgetStyle": {},
          "widgetCss": "",
          "titleStyle": {
            "fontSize": "24px",
            "fontWeight": 700,
            "padding": "5px 10px 5px 10px"
          },
          "pageSize": 1024,
          "noDataDisplayMessage": "",
          "configMode": "advanced",
          "titleFont": null,
          "titleColor": null,
          "margin": "0px",
          "borderRadius": "8px",
          "iconSize": "24px",
          "titleIcon": "map",
          "iconColor": "#1F6BDD",
          "actions": {
            "headerButton": [
              {
                "name": "{i18n:custom.projects.project.add-project}",
                "buttonType": "flat",
                "showIcon": true,
                "icon": "add",
                "buttonColor": "#ffffff",
                "buttonFillColor": "#3d9be9",
                "customButtonStyle": {},
                "useShowWidgetActionFunction": true,
                "showWidgetActionFunction": "return false;",
                "type": "placeMapItem",
                "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addProjectFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 350px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">{{'custom.projects.project.add-project' | translate}}</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n  </mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <div class=\"flex flex-col gap-0 sm:gap-2\">\r\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n            <mat-label>{{'custom.diagnostics.project-id.title' | translate}}</mat-label>\r\n            <input matInput formControlName=\"name\" required readonly>\r\n            <mat-error *ngIf=\"addProjectFormGroup.get('name').hasError('required')\">\r\n              {{'custom.projects.add-project.project-title-required' | translate}}\r\n            </mat-error>\r\n        </mat-form-field>\r\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n            <mat-label>Label</mat-label>\r\n            <input matInput formControlName=\"entityLabel\">\r\n        </mat-form-field>\r\n        <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n            <mat-label>{{'custom.projects.add-project.project-address' | translate}}</mat-label>\r\n            <input matInput formControlName=\"address\">\r\n        </mat-form-field>\r\n    </div>\r\n  </div>\r\n  <div mat-dialog-actions class=\"flex justify-end gap-2\">\r\n    <button mat-button color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\" cdkFocusInitial>\r\n      {{'action.cancel' | translate}}\r\n    </button>\r\n    <button mat-button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(isLoading$ | async) || addProjectFormGroup.invalid || !addProjectFormGroup.dirty\">\r\n      {{'custom.projects.project.add-project' | translate}}\r\n    </button>\r\n  </div>\r\n</form>\r\n",
                "customCss": "",
                "customFunction": "/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n\nlet $injector = widgetContext.$scope.$injector;\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\nlet customerId;\nlet shortNameAttr;\nlet customerShortName;\nlet nextProjectId = 0;\n\nlet customerName = widgetContext.stateController.getStateParams().entityName;\nlet userRole = widgetContext.stateController.getStateParams().userRole;\n\n    if (widgetContext.currentUser.authority === 'TENANT_ADMIN' || userRole === 'ECO Administrator') {\n        customerId = widgetContext.stateController.getStateParams().entityId;\n    } else {\n        customerId = { id: widgetContext.currentUser.customerId, entityType: 'CUSTOMER'};\n    }\nconsole.log(\"CustomerID: \", customerId.id);\n\nlet assetSearchQuery = {\n  \"parameters\": {\n    \"rootId\": customerId.id,\n    \"rootType\": \"CUSTOMER\",\n    \"direction\": \"FROM\",\n    \"relationTypeGroup\": \"COMMON\",\n    \"maxLevel\": 10,\n    \"fetchLastLevelOnly\": false\n  },\n  \"relationType\": \"Owns\",\n  \"assetTypes\": [\n    \"Project\"\n  ]\n};\n\nconsole.log(\"Asset Search Query: \", assetSearchQuery);\n\nassetService.findByQuery(assetSearchQuery).subscribe(projects => {\n    console.log(\"Projects: \", projects);\n    nextProjectId = getLastProjectId(projects);\n    console.log(\"Next Project ID: \", nextProjectId);\n    attributeService.getEntityAttributes(customerId, 'SERVER_SCOPE', ['shortName']).subscribe(attributes => {\n        shortNameAttr = attributes.find(attr => attr.key === 'shortName');\n        customerShortName = shortNameAttr ? shortNameAttr.value : customerName;\n        openAddProjectDialog();\n    });\n});\n\nfunction getLastProjectId(projects) {\n    let maxNumber = 0;\n    projects.forEach(item => {\n        const name = item.name;\n        const parts = name.split('_');\n        if (parts.length === 2) {\n            const number = parseInt(parts[1], 10);\n            if (number > maxNumber) {\n                maxNumber = number;\n            }\n        }\n    });\n    const nextProjectId = maxNumber + 1;\n    return nextProjectId;\n}\n\nfunction openAddProjectDialog() {\n  customDialog.customDialog(htmlTemplate, AddProjectDialogController).subscribe();\n}\n\nfunction AddProjectDialogController(instance) {\n  let vm = instance;\n\n  vm.addProjectFormGroup = vm.fb.group({\n    name: [customerShortName + \"_\" + nextProjectId, [vm.validators.required]],\n    entityLabel: [''],\n    address: ['']\n  });\n\n    vm.cancel = function() {\n        vm.dialogRef.close(null);\n    };\n    \n    vm.save = function () {\n    vm.addProjectFormGroup.markAsPristine();\n    saveProjectObservable(customerId).subscribe(\n      function (Project) {\n          widgetContext.rxjs.forkJoin([\n              saveCustomerToProjectRelation(customerId, Project.id),\n              saveAttributes(Project.id)\n          ]).subscribe(\n              function () {\n                var params = widgetContext.stateController.getStateParams();\n                var selectedProject = params['selectedProject'];\n                params['selectedProject'] = { entityId: Project.id, entityName: Project.name, entityLabel: '' };\n                widgetContext.updateAliases();\n                vm.dialogRef.close(null);\n              }\n        );\n      }\n    );\n    };\n\n/*    function saveEntityObservable() {\n        const formValues = vm.addEntityFormGroup.value;\n        let entity = {\n            name: formValues.entityName,\n            type: formValues.type,\n            label: formValues.entityLabel\n        };\n        if (formValues.entityType == 'ASSET') {\n            return assetService.saveAsset(entity);\n        } else if (formValues.entityType == 'DEVICE') {\n            return deviceService.saveDevice(entity);\n        }\n    }*/\n    \n    function saveProjectObservable(customerId) {\n    return getProjectsGroup(customerId).pipe(\n        widgetContext.rxjs.switchMap((ProjectsGroup) => {\n            const formValues = vm.addProjectFormGroup.value;\n            let Project = {\n              name: formValues.name,\n              type: 'Project',\n              label: formValues.entityLabel,\n              customerId: customerId\n            };\n            return assetService.saveAsset(Project, ProjectsGroup.id.id)\n        })\n    );\n    }\n\n    function saveAttributes(entityId) {\n        let attributesArray = getMapItemLocationAttributes();\n        attributesArray.push({key: 'address', value: vm.addProjectFormGroup.value.address});\n        attributesArray.push({key: 'progress', value: 'in preparation'});\n        attributesArray.push({key: 'units', value: 'metric'});\n        \n        if (attributesArray.length > 0) {\n            return attributeService.saveEntityAttributes(entityId, \"SERVER_SCOPE\", attributesArray);\n        }\n        return widgetContext.rxjs.of([]);\n    }\n    \n    function getProjectsGroup(customerId) {\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\n          widgetContext.rxjs.switchMap((entityGroups) => {\n              var ProjectsGroup = entityGroups.find(group => group.name === 'Projects');\n              if (ProjectsGroup) {\n                  return widgetContext.rxjs.of(ProjectsGroup);\n              } else {\n                  ProjectsGroup = {\n                      type: 'ASSET',\n                      name: 'Projects',\n                      ownerId: customerId\n                  };\n                  return entityGroupService.saveEntityGroup(ProjectsGroup);\n              }\n          })\n      );\n    }\n    \n    function saveCustomerToProjectRelation(customerId, ProjectId) {\n      var relation = {\n          from: customerId,\n          to: ProjectId,\n          typeGroup: 'COMMON',\n          type: 'Owns'\n      };\n      return entityRelationService.saveRelation(relation);\n    }\n\n    function getMapItemLocationAttributes() {\n        const attributes = [];\n        const mapItemType = $event.shape;\n        if (mapItemType === 'Marker') {\n            const mapType = widgetContext.mapInstance.type();\n            attributes.push({key: mapType === 'image' ? 'xPos' : 'latitude', value: additionalParams.coordinates.x});\n            attributes.push({key: mapType === 'image' ? 'yPos' : 'longitude', value: additionalParams.coordinates.y});\n        } else if (mapItemType === 'Rectangle' || mapItemType === 'Polygon') {\n            attributes.push({key: 'perimeter', value: additionalParams.coordinates});\n        } else if (mapItemType === 'Circle') {\n            attributes.push({key: 'circle', value: additionalParams.coordinates});\n        }\n        return attributes;\n    }\n}\n",
                "customResources": [],
                "mapItemType": "marker",
                "mapItemTooltips": {},
                "openInSeparateDialog": false,
                "openInPopover": false,
                "id": "31810d56-1400-76b9-850d-456f65f78d35"
              }
            ]
          },
          "enableDataExport": false
        },
        "row": 0,
        "col": 0,
        "id": "812eba56-40ea-35cd-6287-dffef871b246"
      },
      "2c5c07b1-e81b-c607-7729-a65a003be67b": {
        "typeFullFqn": "system.input_widgets.update_server_image_attribute",
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3.5,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "name": "",
              "entityAliasId": "faef915b-be60-5c6b-d62c-114957e80421",
              "dataKeys": [
                {
                  "name": "image",
                  "type": "attribute",
                  "label": "image",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.795569036953701
                }
              ],
              "alarmFilterConfig": {
                "statusList": [
                  "ACTIVE"
                ]
              }
            }
          ],
          "timewindow": {
            "displayValue": "",
            "selectedTab": 0,
            "realtime": {
              "realtimeType": 1,
              "interval": 1000,
              "timewindowMs": 60000,
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideQuickInterval": false
            },
            "history": {
              "historyType": 0,
              "interval": 1000,
              "timewindowMs": 60000,
              "fixedTimewindow": {
                "startTimeMs": 1764063476918,
                "endTimeMs": 1764149876918
              },
              "quickInterval": "CURRENT_DAY",
              "hideInterval": false,
              "hideLastInterval": false,
              "hideFixedInterval": false,
              "hideQuickInterval": false
            },
            "aggregation": {
              "type": "AVG",
              "limit": 50000
            }
          },
          "showTitle": false,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "showResultMessage": true,
            "displayPreview": true,
            "displayClearButton": false,
            "displayApplyButton": true,
            "displayDiscardButton": true
          },
          "title": "Update server image attribute",
          "dropShadow": true,
          "enableFullscreen": false,
          "enableDataExport": false,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "showLegend": false,
          "actions": {},
          "displayTimewindow": true,
          "widgetCss": "",
          "pageSize": 1024,
          "noDataDisplayMessage": ""
        },
        "row": 0,
        "col": 0,
        "id": "2c5c07b1-e81b-c607-7729-a65a003be67b"
      }
    },
    "states": {
      "default": {
        "name": "Smart Diagnostic Administration",
        "root": true,
        "layouts": {
          "main": {
            "widgets": {
              "c2559a58-e82d-3250-7e35-f520ced0d916": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "retail_companies": {
        "name": "Retail companies",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "777ded27-e3b8-d901-ca42-3079a23f7a12": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "Doktorkits": {
        "name": "Diagnostic Kits",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "ab845ee8-ff10-b684-3652-cb49e2d9acbe": {
                "sizeX": 25,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_Doktorkit_card": {
        "name": "Edit Diagnostic Kits card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "28303a0b-d427-6d9e-0ee1-ae2c3f344769": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "Doktorkits_card": {
        "name": "Diagnostic Kits card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "4a524a3c-2b87-903c-6256-47a5df398ba5": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_Doktorkit_address": {
        "name": "Edit Diagnostic Kits address",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "980bd0c3-44e9-a1f9-c8f9-3dc533011fde": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_Doktorkit_location": {
        "name": "Edit Diagnostic Kits location",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "1d0b53f4-7805-fbfd-1cc6-e91d0df3d4bf": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_Doktorkit_floorplan": {
        "name": "Edit Diagnostic Kits floorplan",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "59df0b6f-17dd-3c4c-a484-69c0836246da": {
                "sizeX": 24,
                "sizeY": 3,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "devices": {
        "name": "Devices",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "eac6e38e-62f2-1f91-754b-299d11e87c19": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "devices_plan": {
        "name": "Edit Floor Plan",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "0c48ee70-d617-faa5-2418-d9766c6ff378": {
                "sizeX": 24,
                "sizeY": 15,
                "row": 0,
                "col": 0,
                "mobileHide": true
              }
            },
            "gridSettings": {
              "backgroundColor": "#EEEEEE",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default",
              "minColumns": 24,
              "viewFormat": "grid",
              "rowHeight": 70
            }
          }
        }
      },
      "edit_Doktorkit_alias": {
        "name": "Edit Diagnostic Kits alias",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "2f3d74ea-ed1f-a52a-03c1-9dfb2f956dd8": {
                "sizeX": 24,
                "sizeY": 5,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 0,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "layoutType": "default"
            }
          }
        }
      },
      "gateways": {
        "name": "Gateways",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "0c7469aa-7b86-be27-5216-bc6cc702f8b1": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "Doktorkit_devices_plan": {
        "name": "Devices",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "5d58360e-ec9a-cace-33d3-f64d2ba8e946": {
                "sizeX": 60,
                "sizeY": 4,
                "row": 0,
                "col": 0
              },
              "faaa7767-eace-1546-163d-30d272242806": {
                "sizeX": 60,
                "sizeY": 24,
                "row": 4,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 60,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "Doktorkit_devices_table": {
        "name": "Devices",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "c7bcd0ec-a47b-5bb5-d7cf-9c07fbe96d98": {
                "sizeX": 60,
                "sizeY": 30,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 60,
              "margin": 5,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "doktorkit_devices_header_buttons": {
        "name": "doktorkit devices header buttons",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "248d9bcd-6dcc-381f-cd4c-211ec095b8c8": {
                "sizeX": 25,
                "sizeY": 1,
                "row": 0,
                "col": 0
              },
              "1bed8029-36f3-d139-9171-d41e4dc9bfa4": {
                "sizeX": 25,
                "sizeY": 1,
                "row": 0,
                "col": 25
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 50,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "autoFillHeight": false,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "layoutType": "default"
            }
          }
        }
      },
      "Projects": {
        "name": "Projects",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "d5ffcdcd-a934-115a-cf8b-641b03bea108": {
                "sizeX": 12,
                "sizeY": 12,
                "row": 0,
                "col": 13
              },
              "812eba56-40ea-35cd-6287-dffef871b246": {
                "sizeX": 13,
                "sizeY": 12,
                "row": 0,
                "col": 0,
                "resizable": false
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "measurements_card": {
        "name": "Measurements card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "0aca86bb-f602-af18-62ed-998cc968189d": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "measurements_map": {
        "name": "Measurements map",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "c23ea856-e76f-5b47-945a-b8a2e5b2b936": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 1,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "projects_card": {
        "name": "Projects card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "2eb3b5d4-b23a-63f6-2295-ffdf59a880f5": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "projects_map": {
        "name": "Projects map",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "b45a8ba5-3b00-23be-6d1c-5f110bc6d3a7": {
                "sizeX": 24,
                "sizeY": 13,
                "row": 0,
                "col": 0,
                "resizable": true,
                "mobileHide": true,
                "desktopHide": true
              },
              "8f5b8cff-bca9-de6a-0e6f-baab364d1f75": {
                "sizeX": 24,
                "sizeY": 14,
                "row": 13,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_measurements_card": {
        "name": "Edit Measurements card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "29bc4f22-e66e-ed76-cdd5-a2f4c1424ebd": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_project_card": {
        "name": "Edit Projects card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "89a03141-e3ba-4e60-661b-c36e1ec2360d": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_project_alias": {
        "name": "Edit Project alias",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "792f905b-6762-d356-e852-8960355c20bb": {
                "sizeX": 24,
                "sizeY": 5,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 0,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_project_address": {
        "name": "Edit Project address",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "68e52426-3b51-1e15-5564-c3f1922057bb": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_project_location": {
        "name": "Edit Project location",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "30311521-81d4-308a-e02c-1a33bcfdf2cf": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_measurement_address": {
        "name": "Edit Measurement address",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "6fe780fc-b5fc-0a29-95f0-41a82c0f22ca": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_measurement_alias": {
        "name": "Edit Measurement alias",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "39414644-240c-54ad-cc74-50fd83a19b8f": {
                "sizeX": 24,
                "sizeY": 8,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 0,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_measurement_location": {
        "name": "Edit Measurement location",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "43c4cbcd-127c-7085-0f83-5a168e646d12": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "payments": {
        "name": "Payments",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {},
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "layoutType": "default"
            }
          }
        }
      },
      "doktorkit_table": {
        "name": "Diagnostic Kits table",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "3c990db9-ab04-d3a5-ae24-bc58de2fbc94": {
                "sizeX": 29,
                "sizeY": 14,
                "desktopHide": false,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "measurements_all": {
        "name": "Measurements",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "a6772b51-aa31-a7a7-3c81-ed0107747969": {
                "sizeX": 13,
                "sizeY": 12,
                "row": 0,
                "col": 12
              },
              "0a63a6e0-cb6e-5d7b-7971-642221547ca4": {
                "sizeX": 12,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "measurements_map_all": {
        "name": "Measurements map",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "c247004e-34a4-57ee-cac3-8a661aa8da5a": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "measurements_card_all": {
        "name": "Measurements card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "2622a940-17ce-c92f-5caf-3e7781beb04b": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "doktorkits_all": {
        "name": "Diagnostic Kits",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "6d854f9b-bcf2-99f0-8f2c-5230b9d04615": {
                "sizeX": 25,
                "sizeY": 12,
                "row": 0,
                "col": 0
              },
              "fc9715d4-d47c-468c-9ccd-6be629cd0d53": {
                "sizeX": 25,
                "sizeY": 13,
                "row": 12,
                "col": 0,
                "mobileHide": true,
                "desktopHide": true
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "doktorkits_card_all": {
        "name": "Diagnostic Kits card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "d2cec1c0-f9bb-1c7c-25ae-ea8853bc3b7e": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "devices_table_doktorkit": {
        "name": "Devices table",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "c779ff45-4c69-b749-51b0-400f54ebf350": {
                "sizeX": 29,
                "sizeY": 14,
                "desktopHide": false,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "kits_all": {
        "name": "Kits",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "4890652b-3208-1522-fbf6-850ba92526cf": {
                "sizeX": 29,
                "sizeY": 16,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "layoutType": "default"
            }
          }
        }
      },
      "kits_card_all": {
        "name": "Kits Card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "73232f79-2115-af4e-4ad8-50f156b3cb16": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "autoFillHeight": false,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "layoutType": "default"
            }
          }
        }
      },
      "devices_all": {
        "name": "Devices All",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "9351f221-5ed8-ae9f-a593-d8c7bf85c675": {
                "sizeX": 27,
                "sizeY": 2,
                "row": 0,
                "col": 0
              },
              "298ac1a0-d9bc-068d-9f2d-2019aee5b38b": {
                "sizeX": 27,
                "sizeY": 14,
                "desktopHide": false,
                "row": 2,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "layoutType": "default"
            }
          }
        }
      },
      "manage_devices_header_buttons": {
        "name": "manage devices header buttons",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "8fea4189-280f-2e44-cbe0-960041160a6d": {
                "sizeX": 25,
                "sizeY": 1,
                "row": 0,
                "col": 0
              },
              "56a1ecae-2de0-84e3-30c9-84e00149a66a": {
                "sizeX": 25,
                "sizeY": 1,
                "row": 0,
                "col": 25
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 50,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "autoFillHeight": false,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "layoutType": "default"
            }
          }
        }
      },
      "kit_devices_table": {
        "name": "Kit Devices All",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "6f741a6d-8f2a-948e-1375-4aa557212d48": {
                "sizeX": 60,
                "sizeY": 3,
                "row": 13,
                "col": 0
              },
              "e0b5a782-3ec3-af12-bfdd-6b097611aad3": {
                "sizeX": 60,
                "sizeY": 20,
                "row": 16,
                "col": 0
              },
              "c0492355-0350-78f2-ad14-459ab9d07820": {
                "sizeX": 60,
                "sizeY": 10,
                "row": 0,
                "col": 0
              },
              "62d3c5ad-3b0a-49c2-60b0-c3d2d78dcc46": {
                "sizeX": 10,
                "sizeY": 3,
                "row": 10,
                "col": 10
              },
              "e3259a6e-5292-1b14-0589-6910138536e4": {
                "sizeX": 16,
                "sizeY": 2,
                "row": 10,
                "col": 27
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 60,
              "margin": 5,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "doktorkit_devices_table": {
        "name": "Devices",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "5edfc189-61b4-a221-d5b5-c57a2bcf7960": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "layoutType": "default"
            }
          }
        }
      },
      "Measurements": {
        "name": "Measurements",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "5c924b33-7327-d315-63e1-ba0e17e491d1": {
                "sizeX": 10,
                "sizeY": 12,
                "row": 0,
                "col": 14
              },
              "5b9ff680-3af1-b4b0-9c84-457d9fd4cce8": {
                "sizeX": 14,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "measurements_new": {
        "name": "Measurements",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "421606e7-2c9a-a84b-e215-adfba9ba99e7": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0,
                "mobileHide": true,
                "desktopHide": false
              },
              "255cd6bc-d63d-3ac5-6bf5-7f8f07a0aafe": {
                "sizeX": 14,
                "sizeY": 12,
                "row": 23,
                "col": 0,
                "resizable": true,
                "mobileHide": true,
                "desktopHide": true
              },
              "29bc4f22-e66e-ed76-cdd5-a2f4c1424ebd": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 12,
                "col": 0,
                "desktopHide": true
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_measurements_card_new": {
        "name": "Edit Measurements card new",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "56d2a93a-4e64-7513-8abd-f500eed9e95d": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_measurement_plan": {
        "name": "Edit Measurement Plan",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "fbc43902-53ed-c5f2-76cd-8163a7752dc2": {
                "sizeX": 24,
                "sizeY": 3,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "layoutType": "default"
            }
          }
        }
      },
      "customer_companies": {
        "name": "Customer Administration",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "646559d6-c1a5-ccee-b3fb-552496a7521b": {
                "sizeX": 8,
                "sizeY": 3,
                "row": 0,
                "col": 0
              },
              "5cf98db3-81f6-ad77-e161-e6e0f569a851": {
                "sizeX": 8,
                "sizeY": 6,
                "row": 0,
                "col": 8
              },
              "d0614cb8-3793-26e6-571c-61236d1a3252": {
                "sizeX": 8,
                "sizeY": 3,
                "row": 0,
                "col": 16
              },
              "fe3556b7-73a1-0009-cd3c-a9c6680ccd7a": {
                "sizeX": 8,
                "sizeY": 3,
                "row": 3,
                "col": 0
              },
              "6ec365fc-fe7f-18c5-0bfe-72fa77050c10": {
                "sizeX": 8,
                "sizeY": 3,
                "row": 3,
                "col": 16
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": false,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "Projects_customer": {
        "name": "Projects",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "9ce62891-046b-e732-060f-37704b7d8998": {
                "sizeX": 25,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "doktorkits_all_customer": {
        "name": "Diagnostic Kits",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "ed6cf40c-1c37-2fe9-4436-22c669817f3e": {
                "sizeX": 25,
                "sizeY": 12,
                "row": 0,
                "col": 0
              },
              "4cc2a279-fbae-dce8-0827-5a24057fe53e": {
                "sizeX": 25,
                "sizeY": 13,
                "row": 12,
                "col": 0,
                "mobileHide": true,
                "desktopHide": true
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "doktorkits_card_all_customer": {
        "name": "Diagnostic Kits card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "af8bd4a6-39c7-d8a5-2894-64840ac87fdd": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_label": {
        "name": "edit_label",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "70c3a394-8f22-3d3b-ccb3-ab1bf7bba2f4": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "edit_title": {
        "name": "edit_title",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "00041a85-d8fe-09f2-4aab-1c86d8a7444d": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "measurement_devices": {
        "name": "Devices",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "150eb2dc-f5f1-9ade-8ba7-b3246a205ec0": {
                "sizeX": 29,
                "sizeY": 18,
                "desktopHide": false,
                "row": 0,
                "col": 0,
                "resizable": true
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "user": {
        "name": "User",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "c12ec825-a7ef-cc4d-da3d-064fba7cc7d7": {
                "sizeX": 33,
                "sizeY": 48,
                "row": 3,
                "col": 0
              },
              "b687c65c-76de-dd49-b3b9-51eacf22114c": {
                "sizeX": 33,
                "sizeY": 48,
                "row": 3,
                "col": 66
              },
              "8a5a3b08-5990-7d43-feca-892f176bff4c": {
                "sizeX": 33,
                "sizeY": 48,
                "row": 3,
                "col": 33
              },
              "4f27f5c7-75b2-c14a-821f-ae5786bf1323": {
                "sizeX": 99,
                "sizeY": 3,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#eeeeee",
              "columns": 100,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": true,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "add_plan": {
        "name": "Add Plan",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "1e47b3eb-3599-35fc-6166-ad5b61d8be98": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#FFFFFF",
              "columns": 24,
              "margin": 10,
              "outerMargin": false,
              "backgroundSizeMode": "100%",
              "minColumns": 24,
              "viewFormat": "grid",
              "autoFillHeight": false,
              "rowHeight": 70,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": false,
              "mobileRowHeight": 70
            }
          }
        }
      },
      "measurements_card_proj": {
        "name": "Measurements card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "7abc3362-5ae6-3da5-cfc1-3fc4cd8db230": {
                "sizeX": 24,
                "sizeY": 12,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 10,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default",
              "minColumns": 24,
              "viewFormat": "grid",
              "rowHeight": 70
            }
          }
        }
      },
      "edit_measurements_card_proj": {
        "name": "Edit Measurements card",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "d7ea3d50-1015-96d2-cee3-535aaf923958": {
                "sizeX": 24,
                "sizeY": 11,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#ffffff",
              "columns": 24,
              "margin": 0,
              "backgroundSizeMode": "100%",
              "autoFillHeight": true,
              "backgroundImageUrl": null,
              "mobileAutoFillHeight": true,
              "mobileRowHeight": 70,
              "outerMargin": true,
              "layoutType": "default"
            }
          }
        }
      },
      "image_attribute": {
        "name": "image_attribute",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "2c5c07b1-e81b-c607-7729-a65a003be67b": {
                "sizeX": 24,
                "sizeY": 3,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "layoutType": "default",
              "backgroundColor": "#eeeeee",
              "columns": 24,
              "margin": 10,
              "outerMargin": true,
              "backgroundSizeMode": "100%"
            }
          }
        }
      }
    },
    "entityAliases": {
      "1c348dad-e738-a4db-5e7e-4c0271790ab7": {
        "id": "1c348dad-e738-a4db-5e7e-4c0271790ab7",
        "alias": "Doktorkits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Doktorkit"
          ]
        }
      },
      "d13f6078-0d81-ec59-529c-64acbbcaf470": {
        "id": "d13f6078-0d81-ec59-529c-64acbbcaf470",
        "alias": "Doktorkit Devices",
        "filter": {
          "type": "deviceSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedDoktorkit",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "deviceTypes": [
            "P-Flow D116",
            "Room Sensor CO2",
            "Room Sensor T",
            "Temperature Sensor",
            "Gateway",
            "RESI",
            "LTE Status"
          ]
        }
      },
      "04917190-aea7-e407-e308-4598f1671a71": {
        "id": "04917190-aea7-e407-e308-4598f1671a71",
        "alias": "Retrofit Partner",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": false,
          "stateEntityParamName": "selectedCustomer",
          "groupType": "CUSTOMER",
          "entityGroupNameFilter": "Belimo Retrofit"
        }
      },
      "7add11d8-cbf7-fd15-6b12-d5df058f11fa": {
        "id": "7add11d8-cbf7-fd15-6b12-d5df058f11fa",
        "alias": "Selected Doktorkit",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedDoktorkit",
          "defaultStateEntity": null
        }
      },
      "984b0bbe-9a03-40ac-90f0-31db7e70dc8c": {
        "id": "984b0bbe-9a03-40ac-90f0-31db7e70dc8c",
        "alias": "Customer Doktorkit Devices",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Doktorkit Devices"
        }
      },
      "60f60877-be45-311d-9ee7-25b68c466d89": {
        "id": "60f60877-be45-311d-9ee7-25b68c466d89",
        "alias": "Customer Doktorkit Gateways",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Gateways"
        }
      },
      "fe796be3-ffda-37f5-f182-7fb7fcd53f31": {
        "id": "fe796be3-ffda-37f5-f182-7fb7fcd53f31",
        "alias": "Selected device",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedDevice",
          "defaultStateEntity": null
        }
      },
      "21d657b1-d301-fa72-ed75-6e2000eb5e51": {
        "id": "21d657b1-d301-fa72-ed75-6e2000eb5e51",
        "alias": "Retrofit Partner All",
        "filter": {
          "type": "entityType",
          "resolveMultiple": true,
          "entityType": "CUSTOMER"
        }
      },
      "df6ecbc0-0dae-bc9b-fbeb-96b5c11f9ebc": {
        "id": "df6ecbc0-0dae-bc9b-fbeb-96b5c11f9ebc",
        "alias": "{i18n:custom.diagnostics.projects.title}",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Project"
          ]
        }
      },
      "f765d469-eafe-c53b-d010-c75a39278cad": {
        "id": "f765d469-eafe-c53b-d010-c75a39278cad",
        "alias": "Measurements",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedProject",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Measurement"
          ]
        }
      },
      "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4": {
        "id": "f789e4d6-fb9f-3dbe-dc28-156f2a58e9e4",
        "alias": "Selected Measurement",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null
        }
      },
      "faef915b-be60-5c6b-d62c-114957e80421": {
        "id": "faef915b-be60-5c6b-d62c-114957e80421",
        "alias": "Selected Project",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedProject",
          "defaultStateEntity": null
        }
      },
      "ab402d1e-d547-fc07-708c-2b7bb8306205": {
        "id": "ab402d1e-d547-fc07-708c-2b7bb8306205",
        "alias": "Selected Sensorkit",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedSensorkit",
          "defaultStateEntity": null
        }
      },
      "c81ac24b-34f8-946b-bf95-1609f607c82b": {
        "id": "c81ac24b-34f8-946b-bf95-1609f607c82b",
        "alias": "Sensorkits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Sensorkit"
          ]
        }
      },
      "f3353dc6-c514-fb37-dc74-73bbeb9d1921": {
        "id": "f3353dc6-c514-fb37-dc74-73bbeb9d1921",
        "alias": "Sensorkit Devices",
        "filter": {
          "type": "deviceSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedSensorkit",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "deviceTypes": [
            "Room Sensor CO2",
            "Room Sensor T"
          ]
        }
      },
      "950424d2-bccd-42c2-76a9-603429eed3f1": {
        "id": "950424d2-bccd-42c2-76a9-603429eed3f1",
        "alias": "Customer Sensorkit Devices",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Sensorkit Devices"
        }
      },
      "8c78ecdd-7a95-af08-137b-3cf7bc54edb4": {
        "id": "8c78ecdd-7a95-af08-137b-3cf7bc54edb4",
        "alias": "Customer Sensorkit Gateways",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": false,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Gateways"
        }
      },
      "62e540a9-69d4-98ce-afbc-1c3f7bc147a5": {
        "id": "62e540a9-69d4-98ce-afbc-1c3f7bc147a5",
        "alias": "Devices",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Diagnostickit Devices"
        }
      },
      "1a8c3475-c3d9-20d2-32e4-fa4dfc96c9a2": {
        "id": "1a8c3475-c3d9-20d2-32e4-fa4dfc96c9a2",
        "alias": "Measurement Doktorkit",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "assetTypes": [
            "Doktorkit"
          ]
        }
      },
      "95a1ca8c-a5d5-e4fd-98e0-d85640112887": {
        "id": "95a1ca8c-a5d5-e4fd-98e0-d85640112887",
        "alias": "Measurement Sensorkit",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "assetTypes": [
            "Sensorkit"
          ]
        }
      },
      "7a3ac371-a996-ee2e-8652-6fab5a79027c": {
        "id": "7a3ac371-a996-ee2e-8652-6fab5a79027c",
        "alias": "All Measurements",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Measurement"
          ]
        }
      },
      "2519c941-a1b9-45bd-9821-88acf22e10af": {
        "id": "2519c941-a1b9-45bd-9821-88acf22e10af",
        "alias": "All Doktorkits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Diagnostickit"
          ]
        }
      },
      "88a32db8-5dd9-f8b4-28b9-5e18c7c86c68": {
        "id": "88a32db8-5dd9-f8b4-28b9-5e18c7c86c68",
        "alias": "All Sensorkits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Sensorkit"
          ]
        }
      },
      "80b77cd9-f10d-6774-e609-cdfced593359": {
        "id": "80b77cd9-f10d-6774-e609-cdfced593359",
        "alias": "Selected Kit",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedKit",
          "defaultStateEntity": null
        }
      },
      "89a624d9-5882-ac3f-5001-e709d73e75f1": {
        "id": "89a624d9-5882-ac3f-5001-e709d73e75f1",
        "alias": "All Kits",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_USER_OWNER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          },
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Owns",
          "assetTypes": [
            "Sensorkit",
            "Doktorkit"
          ]
        }
      },
      "186b00f3-5c8d-7cab-7654-f96a15d58d64": {
        "id": "186b00f3-5c8d-7cab-7654-f96a15d58d64",
        "alias": "Devices All",
        "filter": {
          "type": "deviceSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedCustomer",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Contains",
          "deviceTypes": [
            "Gateway",
            "IoT Gateway",
            "IoT Gateway Device",
            "MUC",
            "P-Flow D116",
            "Room Sensor CO2",
            "Room Sensor T",
            "Temperature Sensor"
          ]
        }
      },
      "e76453a1-85ff-af7f-4d86-60a8dd65f0a3": {
        "id": "e76453a1-85ff-af7f-4d86-60a8dd65f0a3",
        "alias": "Customer",
        "filter": {
          "type": "entityGroup",
          "resolveMultiple": true,
          "groupStateEntity": false,
          "stateEntityParamName": null,
          "defaultStateGroupType": null,
          "defaultStateEntityGroup": null,
          "groupType": "CUSTOMER",
          "entityGroup": "0a9a8ea0-bfae-11ee-80de-5de32813ef75"
        }
      },
      "09a7d069-f810-fea9-8e3d-4309f4a424ae": {
        "id": "09a7d069-f810-fea9-8e3d-4309f4a424ae",
        "alias": "Current Customer",
        "filter": {
          "type": "stateEntityOwner",
          "resolveMultiple": false,
          "stateEntityParamName": null,
          "defaultStateEntity": {
            "entityType": "CURRENT_CUSTOMER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          }
        }
      },
      "11f99ccd-3fff-0e24-7f43-355d961fffcb": {
        "id": "11f99ccd-3fff-0e24-7f43-355d961fffcb",
        "alias": "Measurement Devices",
        "filter": {
          "type": "deviceSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedMeasurement",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": "Measurement",
          "deviceTypes": [
            "P-Flow D116",
            "Temperature Sensor",
            "Room Sensor T",
            "Room Sensor CO2",
            "LoRaWAN Gateway",
            "RESI",
            "LTE Status"
          ]
        }
      },
      "fbfce281-668f-0ad0-d8f4-6870d3ef679f": {
        "id": "fbfce281-668f-0ad0-d8f4-6870d3ef679f",
        "alias": "Belimo Retrofit Users",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "USER",
          "entityGroupNameFilter": "Belimo Retrofit Users"
        }
      },
      "1cab31a1-6ad5-e39d-7798-e0dfee1cd61c": {
        "id": "1cab31a1-6ad5-e39d-7798-e0dfee1cd61c",
        "alias": "Belimo Retrofit Administrators",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "USER",
          "entityGroupNameFilter": "Belimo Retrofit Administrators"
        }
      },
      "4128d7f0-9e28-5c7d-cf9a-b43cfe893568": {
        "id": "4128d7f0-9e28-5c7d-cf9a-b43cfe893568",
        "alias": "Belimo Retrofit Engineer",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "USER",
          "entityGroupNameFilter": "Belimo Retrofit Engineer"
        }
      },
      "9c45e942-79a2-d41b-37dd-9e0d461a6c7c": {
        "id": "9c45e942-79a2-d41b-37dd-9e0d461a6c7c",
        "alias": "Location Areas",
        "filter": {
          "type": "assetSearchQuery",
          "resolveMultiple": true,
          "rootStateEntity": true,
          "stateEntityParamName": "selectedLocation",
          "defaultStateEntity": null,
          "rootEntity": null,
          "direction": "FROM",
          "maxLevel": 1,
          "fetchLastLevelOnly": false,
          "relationType": null,
          "assetTypes": [
            "Area"
          ]
        }
      },
      "1ba8ad72-6096-f5aa-d8ef-7d58e375fab2": {
        "id": "1ba8ad72-6096-f5aa-d8ef-7d58e375fab2",
        "alias": "Selected Location",
        "filter": {
          "type": "stateEntity",
          "resolveMultiple": false,
          "stateEntityParamName": "selectedLocation",
          "defaultStateEntity": null
        }
      },
      "203b0867-b867-ef98-1791-03046c133b7d": {
        "id": "203b0867-b867-ef98-1791-03046c133b7d",
        "alias": "Current Owner",
        "filter": {
          "type": "singleEntity",
          "resolveMultiple": false,
          "singleEntity": {
            "entityType": "CURRENT_USER",
            "id": "13814000-1dd2-11b2-8080-808080808080"
          }
        }
      },
      "d75c5b86-8b39-59e2-59f3-ae1c1ee40910": {
        "id": "d75c5b86-8b39-59e2-59f3-ae1c1ee40910",
        "alias": "Project",
        "filter": {
          "type": "assetType",
          "resolveMultiple": true,
          "assetTypes": [
            "Project"
          ],
          "assetNameFilter": ""
        }
      }
    },
    "filters": {
      "6399251d-d843-e4ee-9b39-3a7096b8ef07": {
        "id": "6399251d-d843-e4ee-9b39-3a7096b8ef07",
        "filter": "Project",
        "keyFilters": [
          {
            "key": {
              "type": "ENTITY_FIELD",
              "key": "type"
            },
            "valueType": "STRING",
            "predicates": [
              {
                "keyFilterPredicate": {
                  "operation": "EQUAL",
                  "value": {
                    "defaultValue": "Project",
                    "dynamicValue": null
                  },
                  "ignoreCase": false,
                  "type": "STRING"
                },
                "userInfo": {
                  "editable": true,
                  "label": "",
                  "autogeneratedLabel": true,
                  "order": 0
                }
              }
            ]
          }
        ],
        "editable": true
      },
      "82f574c5-8303-0be1-01fa-b108c6097a90": {
        "id": "82f574c5-8303-0be1-01fa-b108c6097a90",
        "filter": "Devices",
        "keyFilters": [
          {
            "key": {
              "type": "ENTITY_FIELD",
              "key": "type"
            },
            "valueType": "STRING",
            "predicates": [
              {
                "keyFilterPredicate": {
                  "operation": "OR",
                  "predicates": [
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "Temperature Sensor",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "P-Flow D116",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "Room Sensor T",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "Room Sensor CO2",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "LTE Status",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    }
                  ],
                  "type": "COMPLEX"
                },
                "userInfo": {
                  "editable": true,
                  "label": "",
                  "autogeneratedLabel": true,
                  "order": 0
                }
              }
            ]
          }
        ],
        "editable": true
      },
      "3744b253-8d5c-7528-b178-0c8be5c3adca": {
        "id": "3744b253-8d5c-7528-b178-0c8be5c3adca",
        "filter": "Progress filter projects",
        "keyFilters": [
          {
            "key": {
              "type": "ATTRIBUTE",
              "key": "progress"
            },
            "valueType": "STRING",
            "predicates": [
              {
                "keyFilterPredicate": {
                  "operation": "OR",
                  "predicates": [
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "in preparation",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayPreparationMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "active",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayActiveMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "finished",
                          "dynamicValue": {
                            "sourceType": "CURRENT_USER",
                            "sourceAttribute": "displayFinishedMeasurement",
                            "inherit": false
                          }
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    },
                    {
                      "keyFilterPredicate": {
                        "operation": "EQUAL",
                        "value": {
                          "defaultValue": "in preperation",
                          "dynamicValue": null
                        },
                        "ignoreCase": false,
                        "type": "STRING"
                      },
                      "userInfo": {
                        "editable": true,
                        "label": "",
                        "autogeneratedLabel": true,
                        "order": 0
                      }
                    }
                  ],
                  "type": "COMPLEX"
                },
                "userInfo": {
                  "editable": true,
                  "label": "",
                  "autogeneratedLabel": true,
                  "order": 0
                }
              }
            ]
          }
        ],
        "editable": false
      }
    },
    "timewindow": {
      "displayValue": "",
      "hideAggregation": false,
      "hideAggInterval": false,
      "hideTimezone": false,
      "selectedTab": 0,
      "realtime": {
        "realtimeType": 0,
        "interval": 1000,
        "timewindowMs": 60000,
        "quickInterval": "CURRENT_DAY"
      },
      "history": {
        "historyType": 0,
        "interval": 1000,
        "timewindowMs": 60000,
        "fixedTimewindow": {
          "startTimeMs": 1639908545606,
          "endTimeMs": 1639994945606
        },
        "quickInterval": "CURRENT_DAY"
      },
      "aggregation": {
        "type": "AVG",
        "limit": 25000
      }
    },
    "settings": {
      "stateControllerId": "entity",
      "showTitle": false,
      "showDashboardsSelect": true,
      "showEntitiesSelect": false,
      "showDashboardTimewindow": false,
      "showDashboardExport": true,
      "toolbarAlwaysOpen": true,
      "titleColor": "rgba(0,0,0,0.870588)",
      "showDashboardLogo": false,
      "dashboardLogoUrl": null,
      "hideToolbar": false,
      "showFilters": false,
      "showUpdateDashboardImage": false,
      "dashboardCss": ".tb-widget-container > .tb-widget {\n    border-radius: 8px;\n}\n\ngridster-item:not(.tb-noselect) > .tb-widget-container > .tb-widget {\n    cursor: default !important;\n}\n\n.tb-widget-container > .tb-widget .tb-table-widget .mat-mdc-row {\n    cursor: pointer;\n}\n\n.tb-widget-container > .tb-widget .tb-legend-keys {\n    cursor: pointer;\n}"
    }
  },
  "name": "Smart Diagnostic Administration DEV",
  "resources": null
}