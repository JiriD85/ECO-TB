---
phase: 02-device-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js library/ECO Project Wizard.js
autonomous: false

must_haves:
  truths:
    - "Dialog shows all devices related to the measurement via Measurement relation"
    - "Each device shows its name and type"
    - "Each device shows active status with colored badge (green=active, red=inactive, gray=unknown)"
    - "Each device shows lastActivityTime formatted as DD.MM.YYYY hh:mm:ss"
    - "Diagnostic Kit is highlighted in a separate section"
  artifacts:
    - path: "js library/ECO Project Wizard.js"
      provides: "Extended openMeasurementInfoDialog with device loading and display"
      contains: "deviceService.findByQuery"
  key_links:
    - from: "openMeasurementInfoDialog"
      to: "deviceService.findByQuery"
      via: "relation query with Measurement type"
      pattern: "relationType.*Measurement"
    - from: "openMeasurementInfoDialog"
      to: "attributeService.getEntityAttributes"
      via: "device attribute fetch for active/lastActivityTime"
      pattern: "active.*lastActivityTime"
---

<objective>
Extend the Measurement Info dialog to load and display all devices related to the measurement, showing their names, types, active status badges, and formatted lastActivityTime. Diagnostic Kits should be highlighted in their own section.

Purpose: Enable users to see at a glance which devices are connected to a measurement and their current connection status.
Output: Extended openMeasurementInfoDialog function with device list display
</objective>

<execution_context>
@/Users/jiridockal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jiridockal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-device-display/02-RESEARCH.md
@.planning/phases/01-dialog-foundation/01-01-SUMMARY.md
@js library/ECO Project Wizard.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add device loading logic to openMeasurementInfoDialog</name>
  <files>js library/ECO Project Wizard.js</files>
  <action>
Extend the openMeasurementInfoDialog function to load devices with Measurement relation.

**1. Add deviceService and entityRelationService to injector calls** (around line 2244):
```javascript
const deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));
const entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));
```

**2. Add helper function loadDeviceAttributes** inside openMeasurementInfoDialog (before fetchAttributes):
```javascript
function loadDeviceAttributes(device) {
  return new Promise(function(resolve) {
    attributeService.getEntityAttributes(
      device.id,
      'SERVER_SCOPE',
      ['active', 'lastActivityTime']
    ).subscribe(
      function(attributes) {
        var activeAttr = attributes.find(function(a) { return a.key === 'active'; });
        var lastActivityAttr = attributes.find(function(a) { return a.key === 'lastActivityTime'; });
        device.active = activeAttr ? activeAttr.value : null;
        device.lastActivityTime = lastActivityAttr ? lastActivityAttr.value : null;
        resolve(device);
      },
      function() {
        device.active = null;
        device.lastActivityTime = null;
        resolve(device);
      }
    );
  });
}
```

**3. Add helper function findDeviceKit** (finds Diagnostic Kit for a device):
```javascript
function findDeviceKit(deviceId) {
  return new Promise(function(resolve) {
    entityRelationService.findByFrom(deviceId).subscribe(
      function(relations) {
        var assetRelations = (relations || []).filter(function(r) {
          return r.to && r.to.entityType === 'ASSET';
        });
        if (!assetRelations.length) {
          resolve(null);
          return;
        }
        function tryNext(index) {
          if (index >= assetRelations.length) {
            resolve(null);
            return;
          }
          assetService.getAsset(assetRelations[index].to.id).subscribe(
            function(kit) {
              if (kit && kit.type === 'Diagnostickit') {
                resolve(kit);
              } else {
                tryNext(index + 1);
              }
            },
            function() { tryNext(index + 1); }
          );
        }
        tryNext(0);
      },
      function() { resolve(null); }
    );
  });
}
```

**4. Add fetchDevices function** (after fetchAttributes function):
```javascript
function fetchDevices(callback) {
  var deviceSearchQuery = {
    parameters: {
      rootId: measurementId.id,
      rootType: 'ASSET',
      direction: 'FROM',
      relationTypeGroup: 'COMMON',
      maxLevel: 1,
      fetchLastLevelOnly: false
    },
    relationType: 'Measurement',
    deviceTypes: ['P-Flow D116', 'Room Sensor CO2', 'Temperature Sensor', 'RESI']
  };

  deviceService.findByQuery(deviceSearchQuery).subscribe(
    function(devices) {
      if (!devices || !devices.length) {
        callback({ kitGroups: [], noKitDevices: [] });
        return;
      }

      var devicePromises = devices.map(function(device) {
        return loadDeviceAttributes(device).then(function(updatedDevice) {
          return findDeviceKit(updatedDevice.id).then(function(kit) {
            return { device: updatedDevice, kit: kit };
          });
        });
      });

      Promise.all(devicePromises).then(function(results) {
        var kitMap = {};
        var noKitDevices = [];

        results.forEach(function(result) {
          var d = result.device;
          var kit = result.kit;
          var deviceData = {
            id: d.id,
            name: d.name,
            type: d.type,
            active: d.active,
            lastActivityTime: d.lastActivityTime
          };

          if (kit) {
            var kitKey = kit.id.id;
            if (!kitMap[kitKey]) {
              kitMap[kitKey] = {
                id: kit.id,
                name: kit.name,
                label: kit.label,
                devices: []
              };
            }
            kitMap[kitKey].devices.push(deviceData);
          } else {
            noKitDevices.push(deviceData);
          }
        });

        var kitGroups = Object.values(kitMap).sort(function(a, b) {
          return (a.name || '').localeCompare(b.name || '');
        });

        callback({ kitGroups: kitGroups, noKitDevices: noKitDevices });
      });
    },
    function(error) {
      console.error('Error fetching devices:', error);
      callback({ kitGroups: [], noKitDevices: [] });
    }
  );
}
```

**5. Update data flow** - modify fetchAttributes to call fetchDevices after getting attributes:
```javascript
// Change the openDialog() call in fetchAttributes success handler to:
fetchDevices(function(deviceData) {
  openDialog(deviceData);
});

// And in the error handler too:
fetchDevices(function(deviceData) {
  openDialog(deviceData);
});
```

**6. Update openDialog function** to accept device data:
```javascript
function openDialog(deviceData) {
  customDialog.customDialog(measurementInfoHtmlTemplate, MeasurementInfoDialogController, {
    measurementId,
    attributes: fetchedAttributes,
    entityName: fetchedAsset ? fetchedAsset.name : '',
    entityLabel: fetchedAsset ? fetchedAsset.label : '',
    kitGroups: deviceData ? deviceData.kitGroups : [],
    noKitDevices: deviceData ? deviceData.noKitDevices : []
  }, measurementInfoCss).subscribe();
}
```

**7. Add getActivityColor helper function** inside MeasurementInfoDialogController (before assigning vm.getActivityColor):
```javascript
function getActivityColor(active) {
  let color, bgColor, label, icon;
  if (active === true) {
    color = "#27AE60";      // Green
    bgColor = "rgba(39, 174, 96, 0.12)";
    label = "Active";
    icon = "check_circle";
  } else if (active === false) {
    color = "#EB5757";      // Red
    bgColor = "rgba(235, 87, 87, 0.12)";
    label = "Inactive";
    icon = "cancel";
  } else {
    color = "#828282";      // Gray for null/undefined
    bgColor = "rgba(130, 130, 130, 0.12)";
    label = "N/A";
    icon = "help_outline";
  }
  return { color, bgColor, label, icon };
}
```

**8. Update MeasurementInfoDialogController** to handle device data:
Add these lines after vm.installationType extraction:
```javascript
vm.kitGroups = config.kitGroups || [];
vm.noKitDevices = config.noKitDevices || [];

// Helper functions for template
vm.getActivityColor = getActivityColor;

vm.formatTimestampDE = function(ms) {
  if (ms === null || ms === undefined) return '-';
  var value = Number(ms);
  if (!Number.isFinite(value) || value <= 0) return '-';
  var date = new Date(value);
  function pad(n) { return n.toString().padStart(2, '0'); }
  return pad(date.getDate()) + '.' + pad(date.getMonth() + 1) + '.' + date.getFullYear() +
    ' ' + pad(date.getHours()) + ':' + pad(date.getMinutes()) + ':' + pad(date.getSeconds());
};
```
  </action>
  <verify>
Run JSON syntax validation on the JS file:
```bash
node -e "require('/Users/jiridockal/development/ECO-TB/js library/ECO Project Wizard.js')" 2>&1 || echo "Note: ES modules may need different validation"
```
Check that new functions exist:
```bash
grep -c "loadDeviceAttributes\|findDeviceKit\|fetchDevices\|formatTimestampDE\|function getActivityColor" "/Users/jiridockal/development/ECO-TB/js library/ECO Project Wizard.js"
```
Expected: At least 5 matches (one for each function definition including getActivityColor)
  </verify>
  <done>
- deviceService and entityRelationService injected
- loadDeviceAttributes helper loads active and lastActivityTime for each device
- findDeviceKit helper finds Diagnostic Kit relation for each device
- fetchDevices function queries devices by Measurement relation and groups by kit
- openDialog receives device data (kitGroups and noKitDevices)
- getActivityColor function defined inside MeasurementInfoDialogController (returns color/bgColor/label/icon based on active state)
- Controller exposes getActivityColor and formatTimestampDE to template
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend HTML template with devices section</name>
  <files>js library/ECO Project Wizard.js</files>
  <action>
Update the measurementInfoHtmlTemplate constant to include the devices section after the badges section.

**1. Add devices section** after the closing `</div>` of badges-section (around line 2219):

Insert before the closing `</div>` of `mat-dialog-content`:

```html
    <!-- Devices Section -->
    <div *ngIf="kitGroups.length > 0 || noKitDevices.length > 0" class="devices-section" style="margin-top: 16px;">
      <div style="font-size: 14px; font-weight: 600; color: #305680; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
        <mat-icon style="font-size: 18px; width: 18px; height: 18px;">devices</mat-icon>
        Connected Devices
      </div>

      <!-- Diagnostic Kit Groups (highlighted) -->
      <ng-container *ngFor="let kit of kitGroups">
        <div class="kit-group" style="margin-bottom: 12px; border: 1px solid #305680; border-radius: 8px; overflow: hidden;">
          <div style="background: linear-gradient(135deg, #305680 0%, #4a7ab0 100%); color: white; padding: 8px 12px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
            <mat-icon style="font-size: 16px; width: 16px; height: 16px;">router</mat-icon>
            {{ kit.label || kit.name }}
          </div>
          <div style="padding: 8px;">
            <ng-container *ngFor="let device of kit.devices">
              <div class="device-item flex flex-col" style="padding: 6px 8px; border-radius: 4px; background: #f5f5f5; margin-bottom: 4px;">
                <div class="flex items-center gap-2">
                  <mat-icon style="font-size: 14px; width: 14px; height: 14px; color: #666;">memory</mat-icon>
                  <div class="flex flex-col">
                    <span style="font-weight: 500; font-size: 13px;">{{ device.name }}</span>
                    <span style="color: #888; font-size: 11px;">{{ device.type }}</span>
                  </div>
                </div>
                <div class="flex items-center gap-2 flex-wrap" style="margin-left: 22px; margin-top: 6px;">
                  <div class="flex items-center gap-1"
                       [style.background]="getActivityColor(device.active).bgColor"
                       [style.color]="getActivityColor(device.active).color"
                       style="padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                    <mat-icon style="font-size: 12px; width: 12px; height: 12px;">{{ getActivityColor(device.active).icon }}</mat-icon>
                    {{ getActivityColor(device.active).label }}
                  </div>
                  <div class="flex items-center gap-1" style="color: #666; font-size: 11px;">
                    <mat-icon style="font-size: 12px; width: 12px; height: 12px;">schedule</mat-icon>
                    {{ formatTimestampDE(device.lastActivityTime) }}
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </ng-container>

      <!-- Devices without Kit -->
      <ng-container *ngIf="noKitDevices.length > 0">
        <div class="no-kit-devices" style="margin-bottom: 12px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
          <div style="background: #f5f5f5; color: #666; padding: 8px 12px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
            <mat-icon style="font-size: 16px; width: 16px; height: 16px;">device_unknown</mat-icon>
            Other Devices
          </div>
          <div style="padding: 8px;">
            <ng-container *ngFor="let device of noKitDevices">
              <div class="device-item flex flex-col" style="padding: 6px 8px; border-radius: 4px; background: #fafafa; margin-bottom: 4px;">
                <div class="flex items-center gap-2">
                  <mat-icon style="font-size: 14px; width: 14px; height: 14px; color: #666;">memory</mat-icon>
                  <div class="flex flex-col">
                    <span style="font-weight: 500; font-size: 13px;">{{ device.name }}</span>
                    <span style="color: #888; font-size: 11px;">{{ device.type }}</span>
                  </div>
                </div>
                <div class="flex items-center gap-2 flex-wrap" style="margin-left: 22px; margin-top: 6px;">
                  <div class="flex items-center gap-1"
                       [style.background]="getActivityColor(device.active).bgColor"
                       [style.color]="getActivityColor(device.active).color"
                       style="padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                    <mat-icon style="font-size: 12px; width: 12px; height: 12px;">{{ getActivityColor(device.active).icon }}</mat-icon>
                    {{ getActivityColor(device.active).label }}
                  </div>
                  <div class="flex items-center gap-1" style="color: #666; font-size: 11px;">
                    <mat-icon style="font-size: 12px; width: 12px; height: 12px;">schedule</mat-icon>
                    {{ formatTimestampDE(device.lastActivityTime) }}
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </ng-container>

      <!-- No devices message -->
      <div *ngIf="kitGroups.length === 0 && noKitDevices.length === 0" style="color: #888; font-style: italic; text-align: center; padding: 12px;">
        No devices connected to this measurement
      </div>
    </div>
```

**2. Update dialog width** - change from 450px to 500px in the first line of measurementInfoHtmlTemplate to accommodate device list:
```javascript
const measurementInfoHtmlTemplate = `<div class="measurement-info-dialog" style="width: 500px;">
```

**3. Add CSS for device items** - update measurementInfoCss:
```javascript
const measurementInfoCss = `.measurement-info-dialog .badge {
  display: inline-flex;
  align-items: center;
}
.measurement-info-dialog .device-item:last-child {
  margin-bottom: 0;
}
.measurement-info-dialog .kit-group:last-child {
  margin-bottom: 0;
}`;
```
  </action>
  <verify>
Check template includes device sections:
```bash
grep -c "kit-group\|noKitDevices\|formatTimestampDE\|getActivityColor" "/Users/jiridockal/development/ECO-TB/js library/ECO Project Wizard.js"
```
Expected: At least 6 matches

Verify width update:
```bash
grep "width: 500px" "/Users/jiridockal/development/ECO-TB/js library/ECO Project Wizard.js"
```
Expected: Match found
  </verify>
  <done>
- Devices section added with "Connected Devices" header
- Diagnostic Kit groups displayed with blue gradient header and router icon (highlighted)
- Kit devices shown with name, type, active badge, and DD.MM.YYYY timestamp
- Devices without kit shown in "Other Devices" section with gray header
- Dialog width increased to 500px for device list
- CSS updated for proper device item spacing
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Extended Measurement Info dialog with device loading and display. Devices are grouped by Diagnostic Kit, showing name, type, active status badge (green/red/gray), and lastActivityTime in DD.MM.YYYY format. Diagnostic Kits are highlighted with blue gradient headers.
  </what-built>
  <how-to-verify>
1. Sync JS library to ThingsBoard:
   ```bash
   cd /Users/jiridockal/development/ECO-TB && node sync/sync.js sync --js
   ```

2. Open Measurements dashboard in ThingsBoard

3. Click on any measurement row to open the Info dialog

4. Verify dialog displays:
   - Measurement name and label (from Phase 1)
   - installationType badge (from Phase 1)
   - **NEW: "Connected Devices" section**
   - **NEW: Diagnostic Kit groups with blue gradient header**
   - **NEW: Each device shows name, type**
   - **NEW: Each device shows active status badge (green=active, red=inactive, gray=N/A)**
   - **NEW: Each device shows lastActivityTime as DD.MM.YYYY hh:mm:ss**

5. Try a measurement with multiple devices to verify grouping works

6. Try a measurement with no devices to verify "No devices connected" message
  </how-to-verify>
  <resume-signal>Type "approved" if device display works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 2 complete when:
1. Dialog loads all devices with FROM/Measurement relation
2. Devices grouped by Diagnostic Kit with highlighted kit headers
3. Each device shows: name, type, active badge, lastActivityTime (DD.MM.YYYY)
4. Devices without kit shown in separate "Other Devices" section
5. User has visually confirmed device display in ThingsBoard
</verification>

<success_criteria>
- [ ] DEV-01: Devices with Measurement relation loaded via deviceService.findByQuery
- [ ] DEV-02: Device name/label displayed for each device
- [ ] DEV-03: lastActivityTime formatted as DD.MM.YYYY hh:mm:ss
- [ ] DEV-04: active status shown with colored badge (green=active, red=inactive, gray=unknown)
- [ ] DEV-05: Diagnostic Kit highlighted with blue gradient header section
- [ ] User verified dialog displays devices correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-device-display/02-01-SUMMARY.md`
</output>
