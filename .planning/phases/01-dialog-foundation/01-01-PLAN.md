---
phase: 01-dialog-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js library/ECO Project Wizard.js
  - dashboards/measurements.json
autonomous: false

must_haves:
  truths:
    - "User can open Measurement Info dialog from table row"
    - "Dialog displays entityLabel correctly"
    - "Dialog displays entityName correctly"
    - "installationType shows as colored badge (heating=red, cooling=blue)"
    - "Dialog styling matches ECO Project Wizard dialogs"
    - "Close button closes the dialog"
  artifacts:
    - path: "js library/ECO Project Wizard.js"
      provides: "openMeasurementInfoDialog function"
      contains: "export function openMeasurementInfoDialog"
    - path: "dashboards/measurements.json"
      provides: "Row action calling dialog function"
      contains: "openMeasurementInfoDialog"
  key_links:
    - from: "dashboards/measurements.json"
      to: "ECO Project Wizard.js"
      via: "custom action with modules"
      pattern: "projectWizard\\.openMeasurementInfoDialog"
---

<objective>
Create a Measurement Info Dialog that displays basic measurement information (entityLabel, entityName, installationType badge) with ECO Project Wizard styling.

Purpose: Enable users to quickly view measurement details without navigating away from the Measurements table. This is the foundation for the live data popup.

Output: Working dialog accessible from Measurements_card table row action, displaying measurement name and installation type badge.
</objective>

<execution_context>
@/Users/jiridockal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jiridockal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-dialog-foundation/01-RESEARCH.md

# Key source files
@js library/ECO Project Wizard.js
@dashboards/measurements.json
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create openMeasurementInfoDialog function</name>
  <files>js library/ECO Project Wizard.js</files>
  <action>
Add new exported function `openMeasurementInfoDialog(widgetContext, measurementId, callback)` to ECO Project Wizard.js.

**Follow exact pattern of `openMeasurementParametersDialog` (line 1807+):**

1. Inject services via $injector pattern:
   - customDialog
   - attributeService
   - assetService

2. Fetch data sequence:
   - First: assetService.getAsset(measurementId.id) for entityName, entityLabel
   - Then: attributeService.getEntityAttributes for installationType (SERVER_SCOPE)
   - Only open dialog after both complete

3. Create HTML template (inline const):
   - mat-toolbar header with #305680 color, info icon, title "Measurement Info", close button
   - mat-progress-bar for loading state
   - Entity info card (border: 2px solid #305680, gradient background) showing:
     - entityName with assessment icon
     - entityLabel below (if exists)
   - Badges section with installationType badge using getInstallationTypeStyle()
   - Footer with Close button only (no save - this is info dialog)
   - Width: 450px (smaller than parameters dialog since info-only)

4. Create CSS (inline const):
   - Minimal styles for badge layout
   - Reuse existing ECO patterns

5. Create DialogController:
   - vm pattern (vm = instance, config = vm.data)
   - Extract installationType from attributes using findAttr helper
   - Expose getInstallationTypeStyle to template
   - vm.cancel() closes dialog and calls callback

**Template structure example:**
```html
<form style="width: 450px;">
  <mat-toolbar class="flex items-center" color="primary">
    <mat-icon style="margin-right: 12px;">info</mat-icon>
    <h2 style="margin: 0; font-size: 18px;">Measurement Info</h2>
    <span class="flex-1"></span>
    <button mat-icon-button (click)="cancel()" type="button">
      <mat-icon>close</mat-icon>
    </button>
  </mat-toolbar>

  <mat-progress-bar color="warn" mode="indeterminate" *ngIf="isLoading"></mat-progress-bar>
  <div style="height: 4px;" *ngIf="!isLoading"></div>

  <div mat-dialog-content class="flex flex-col p-4">
    <!-- Entity Info Card -->
    <div style="border: 2px solid #305680; border-radius: 8px; padding: 16px; margin-bottom: 16px; background: linear-gradient(135deg, #f8fafc 0%, #e8f4fd 100%);">
      <div class="flex items-center gap-2">
        <mat-icon style="color: #305680;">assessment</mat-icon>
        <span style="font-weight: 700; font-size: 18px; color: #305680;">{{ vm.entityName }}</span>
      </div>
      <div *ngIf="vm.entityLabel" style="font-size: 14px; color: #546e7a; margin-top: 4px; margin-left: 32px;">
        {{ vm.entityLabel }}
      </div>
    </div>

    <!-- Installation Type Badge -->
    <div class="flex items-center gap-2 mb-4" *ngIf="vm.installationType">
      <span style="color: #546e7a; font-size: 14px;">Installation Type:</span>
      <div class="flex items-center gap-1"
           [style.color]="vm.getInstallationTypeStyle(vm.installationType).color"
           [style.background-color]="vm.getInstallationTypeStyle(vm.installationType).bgColor"
           style="padding: 4px 12px; border-radius: 16px; font-weight: 500;">
        <mat-icon style="font-size: 16px; width: 16px; height: 16px;">
          {{ vm.getInstallationTypeStyle(vm.installationType).icon }}
        </mat-icon>
        {{ vm.getInstallationTypeStyle(vm.installationType).label }}
      </div>
    </div>
  </div>

  <div class="flex justify-end items-center gap-2 p-4" style="border-top: 1px solid #e0e0e0; background: #fafafa;">
    <button mat-button type="button" (click)="cancel()">Close</button>
  </div>
</form>
```

Place the new function after the existing openMeasurementParametersDialog function (around line 2050+).
  </action>
  <verify>
1. Grep for "openMeasurementInfoDialog" in ECO Project Wizard.js
2. Verify function is exported: `grep "export function openMeasurementInfoDialog"`
3. Run: `node sync/sync.js sync --js` to sync to ThingsBoard
  </verify>
  <done>
openMeasurementInfoDialog function exists in ECO Project Wizard.js with:
- Proper service injection
- Data fetching for entityName, entityLabel, installationType
- Dialog template with ECO styling
- Close button functionality
- Function is exported and synced to ThingsBoard
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dialog action to Measurements_card widget</name>
  <files>dashboards/measurements.json</files>
  <action>
Add a new row action to the Measurements_card widget that opens the Measurement Info dialog.

**Steps:**

1. First pull latest dashboard: `node sync/sync.js pull "Measurements"`

2. Find the Measurements_card widget in the dashboard JSON:
   - Located in: configuration.states.Measurements_card.layouts.main.widgets
   - Look for the entity table widget with measurement data

3. Add new action to the widget's config.actions.rowClick (or appropriate row actions array):

```json
{
  "id": "measurement-info-action",
  "name": "Measurement Info",
  "icon": "info",
  "type": "custom",
  "customFunction": {
    "body": "const measurementId = entityId;\\nprojectWizard.openMeasurementInfoDialog(widgetContext, measurementId);",
    "modules": {
      "projectWizard": "tb-resource;/api/resource/js_module/tenant/ECO Project Wizard.js"
    }
  }
}
```

**IMPORTANT:**
- Use object syntax for customFunction (NOT string syntax)
- Include modules object inside customFunction
- entityId is available in row action context and refers to the clicked row's entity

4. If multiple row actions exist, add this as the first action (most frequently used).

5. Sync dashboard: `node sync/sync.js sync --dashboards`
  </action>
  <verify>
1. Grep measurements.json for "openMeasurementInfoDialog"
2. Verify action structure has correct modules format
3. Dashboard synced without errors
  </verify>
  <done>
Measurements_card widget has row action that:
- Uses "custom" type (not customPretty)
- Calls projectWizard.openMeasurementInfoDialog
- Has correct modules declaration inside customFunction object
- Is synced to ThingsBoard
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Measurement Info Dialog with ECO styling, accessible from Measurements table</what-built>
  <how-to-verify>
1. Open ThingsBoard and navigate to the Measurements dashboard
2. In the Measurements table, click on a row or the info action button for any measurement
3. Verify dialog opens with:
   - ECO blue header (#305680) with "Measurement Info" title
   - Close (X) button in header
   - Entity name displayed prominently with assessment icon
   - Entity label shown below name (if exists)
   - installationType badge with correct color:
     - Heating = red badge with fire icon
     - Cooling = blue badge with snowflake icon
4. Click Close button - dialog should close
5. Test with both heating and cooling measurements to verify badge colors
  </how-to-verify>
  <resume-signal>Type "approved" if dialog works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
All Phase 1 requirements verified:

- [ ] INFO-01: entityLabel visible in dialog
- [ ] INFO-02: entityName visible in dialog (prominent display)
- [ ] INFO-03: installationType badge with heating=red, cooling=blue
- [ ] STYLE-01: Dialog matches ECO Project Wizard styling (blue header, gradient card)
- [ ] STYLE-02: Responsive layout (450px width fits various screens)
</verification>

<success_criteria>
1. Dialog opens when clicking measurement row action
2. entityLabel and entityName display correctly from asset data
3. installationType shows as colored badge (red for heating, blue for cooling)
4. Dialog styling matches existing ECO dialogs (blue toolbar, gradient info card)
5. Close button closes the dialog without errors
6. No console errors during dialog operation
</success_criteria>

<output>
After completion, create `.planning/phases/01-dialog-foundation/01-01-SUMMARY.md`
</output>
