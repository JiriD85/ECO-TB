{
  "ruleChain": {
    "name": "Update Project",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": true,
    "configuration": null,
    "additionalInfo": {
      "description": "Updates an existing Project Asset when 'updateProject' attribute is received. Triggered by external services via API."
    }
  },
  "metadata": {
    "firstNodeIndex": 0,
    "nodes": [
      {
        "type": "org.thingsboard.rule.engine.filter.TbJsSwitchNode",
        "name": "Check updateProject",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "",
          "tbelScript": "if (msg.updateProject != null) {\n    return ['hasUpdate'];\n} else {\n    return ['other'];\n}"
        },
        "additionalInfo": {
          "description": "Check if message contains updateProject attribute",
          "layoutX": 100,
          "layoutY": 200
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Save Data and Prepare Login",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "",
          "tbelScript": "// Store update data in metadata\nvar updateData = msg.updateProject;\nmetadata.updateDataJson = JSON.stringify(updateData);\n\n// Store project ID (originator is the Project asset)\nmetadata.projectId = metadata.originatorId;\n\n// Check for measurements\nif (updateData.measurements != null && updateData.measurements.length() > 0) {\n    metadata.measurementsJson = JSON.stringify(updateData.measurements);\n    metadata.hasMeasurements = 'true';\n} else {\n    metadata.hasMeasurements = 'false';\n}\n\n// Prepare login body - REPLACE WITH ACTUAL CREDENTIALS\nvar loginBody = {\n    username: 'api-user@ecoenergygroup.com',\n    password: 'API_PASSWORD_HERE'\n};\n\nreturn { msg: loginBody, metadata: metadata, msgType: msgType };"
        },
        "additionalInfo": {
          "description": "Save update data and prepare login",
          "layoutX": 300,
          "layoutY": 200
        }
      },
      {
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Login API",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 5,
        "configuration": {
          "restEndpointUrlPattern": "https://diagnostics.ecoenergygroup.com/api/auth/login",
          "requestMethod": "POST",
          "useSimpleClientHttpFactory": false,
          "parseToPlainText": false,
          "ignoreRequestBody": false,
          "enableProxy": false,
          "readTimeoutMs": 5000,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Content-Type": "application/json"
          },
          "credentials": { "type": "anonymous" }
        },
        "additionalInfo": {
          "description": "Get JWT token",
          "layoutX": 500,
          "layoutY": 200
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Extract Token and Prepare Attributes",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "",
          "tbelScript": "// Extract token\nmetadata.jwtToken = msg.token;\n\n// Parse update data\nvar updateData = JSON.parse(metadata.updateDataJson);\n\n// Build attributes object (only non-null values)\nvar attributes = {};\n\nif (updateData.projectName != null) {\n    metadata.newLabel = updateData.projectName;\n}\nif (updateData.address != null) {\n    attributes.address = updateData.address;\n}\nif (updateData.postalCode != null) {\n    attributes.postalCode = updateData.postalCode;\n}\nif (updateData.city != null) {\n    attributes.city = updateData.city;\n}\nif (updateData.country != null) {\n    attributes.country = updateData.country;\n}\nif (updateData.latitude != null) {\n    attributes.latitude = updateData.latitude;\n}\nif (updateData.longitude != null) {\n    attributes.longitude = updateData.longitude;\n}\nif (updateData.normOutdoorTemp != null) {\n    attributes.normOutdoorTemp = updateData.normOutdoorTemp;\n}\nif (updateData.units != null) {\n    attributes.units = updateData.units;\n}\nif (updateData.area != null) {\n    attributes.area = updateData.area;\n}\nif (updateData.progress != null) {\n    attributes.progress = updateData.progress;\n}\n\nreturn { msg: attributes, metadata: metadata, msgType: msgType };"
        },
        "additionalInfo": {
          "description": "Extract token and prepare project attributes",
          "layoutX": 700,
          "layoutY": 200
        }
      },
      {
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Update Project Attributes",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 5,
        "configuration": {
          "restEndpointUrlPattern": "https://diagnostics.ecoenergygroup.com/api/plugins/telemetry/ASSET/${projectId}/attributes/SERVER_SCOPE",
          "requestMethod": "POST",
          "useSimpleClientHttpFactory": false,
          "parseToPlainText": false,
          "ignoreRequestBody": false,
          "enableProxy": false,
          "readTimeoutMs": 5000,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Content-Type": "application/json",
            "X-Authorization": "Bearer ${jwtToken}"
          },
          "credentials": { "type": "anonymous" }
        },
        "additionalInfo": {
          "description": "Update Project attributes",
          "layoutX": 900,
          "layoutY": 200
        }
      },
      {
        "type": "org.thingsboard.rule.engine.filter.TbJsSwitchNode",
        "name": "Check for Measurements",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "",
          "tbelScript": "if (metadata.hasMeasurements == 'true') {\n    return ['hasMeasurements'];\n} else {\n    return ['done'];\n}"
        },
        "additionalInfo": {
          "description": "Check for measurement updates",
          "layoutX": 1100,
          "layoutY": 200
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Prepare Measurements Array",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "",
          "tbelScript": "var measurements = JSON.parse(metadata.measurementsJson);\nvar result = [];\n\nforeach(m : measurements) {\n    if (m.measurementId != null) {\n        m.jwtToken = metadata.jwtToken;\n        result.add(m);\n    }\n}\n\nreturn { msg: result, metadata: metadata, msgType: msgType };"
        },
        "additionalInfo": {
          "description": "Prepare measurements with token",
          "layoutX": 1300,
          "layoutY": 200
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbSplitArrayMsgNode",
        "name": "Split Measurements",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {},
        "additionalInfo": {
          "description": "Split into messages",
          "layoutX": 1500,
          "layoutY": 200
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Prepare Measurement Attributes",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "",
          "tbelScript": "var m = msg;\nmetadata.measurementId = m.measurementId;\nmetadata.jwtToken = m.jwtToken;\n\nvar attributes = {};\n\nif (m.installationType != null) { attributes.installationType = m.installationType; }\nif (m.systemType != null) { attributes.systemType = m.systemType; }\nif (m.measurementType != null) { attributes.measurementType = m.measurementType; }\nif (m.measurementRole != null) { attributes.measurementRole = m.measurementRole; }\nif (m.hydraulicScheme != null) { attributes.hydraulicScheme = m.hydraulicScheme; }\nif (m.fluidType != null) { attributes.fluidType = m.fluidType; }\nif (m.designFlowTemp != null) { attributes.designFlowTemp = m.designFlowTemp; }\nif (m.designReturnTemp != null) { attributes.designReturnTemp = m.designReturnTemp; }\nif (m.designDeltaT != null) { attributes.designDeltaT = m.designDeltaT; }\nif (m.designPower != null) { attributes.designPower = m.designPower; }\nif (m.designFlow != null) { attributes.designFlow = m.designFlow; }\nif (m.pipeDimension != null) { attributes.pipeDimension = m.pipeDimension; }\nif (m.valveDimension != null) { attributes.valveDimension = m.valveDimension; }\nif (m.valveKvs != null) { attributes.valveKvs = m.valveKvs; }\nif (m.flowOnThreshold != null) { attributes.flowOnThreshold = m.flowOnThreshold; }\nif (m.hysteresisMinutes != null) { attributes.hysteresisMinutes = m.hysteresisMinutes; }\nif (m.weeklySchedule != null) { attributes.weeklySchedule = m.weeklySchedule; }\nif (m.collapseThreshold != null) { attributes.collapseThreshold = m.collapseThreshold; }\nif (m.spikeThreshold != null) { attributes.spikeThreshold = m.spikeThreshold; }\nif (m.cyclingThreshold != null) { attributes.cyclingThreshold = m.cyclingThreshold; }\nif (m.stabilityThreshold != null) { attributes.stabilityThreshold = m.stabilityThreshold; }\nif (m.pumpPresent != null) { attributes.pumpPresent = m.pumpPresent; }\nif (m.pumpControlType != null) { attributes.pumpControlType = m.pumpControlType; }\nif (m.pumpRatedPower != null) { attributes.pumpRatedPower = m.pumpRatedPower; }\nif (m.auxSensor1 != null) { attributes.auxSensor1 = m.auxSensor1; }\nif (m.auxSensor2 != null) { attributes.auxSensor2 = m.auxSensor2; }\nif (m.calculatePower != null) { attributes.calculatePower = m.calculatePower; }\nif (m.progress != null) { attributes.progress = m.progress; }\n\nreturn { msg: attributes, metadata: metadata, msgType: msgType };"
        },
        "additionalInfo": {
          "description": "Prepare measurement attributes",
          "layoutX": 1700,
          "layoutY": 200
        }
      },
      {
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Update Measurement Attributes",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 5,
        "configuration": {
          "restEndpointUrlPattern": "https://diagnostics.ecoenergygroup.com/api/plugins/telemetry/ASSET/${measurementId}/attributes/SERVER_SCOPE",
          "requestMethod": "POST",
          "useSimpleClientHttpFactory": false,
          "parseToPlainText": false,
          "ignoreRequestBody": false,
          "enableProxy": false,
          "readTimeoutMs": 5000,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Content-Type": "application/json",
            "X-Authorization": "Bearer ${jwtToken}"
          },
          "credentials": { "type": "anonymous" }
        },
        "additionalInfo": {
          "description": "Update measurement attributes",
          "layoutX": 1900,
          "layoutY": 200
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Log Measurement Updated",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "",
          "tbelScript": "return 'Measurement updated: ' + metadata.measurementId;"
        },
        "additionalInfo": {
          "description": "Log success",
          "layoutX": 2100,
          "layoutY": 200
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Log Project Done",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "",
          "tbelScript": "return 'Project updated: ' + metadata.projectId;"
        },
        "additionalInfo": {
          "description": "Log project done",
          "layoutX": 1300,
          "layoutY": 100
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Log Error",
        "debugSettings": { "allEnabled": true },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "",
          "tbelScript": "return 'Update Project Error: ' + JSON.stringify(msg);"
        },
        "additionalInfo": {
          "description": "Log errors",
          "layoutX": 900,
          "layoutY": 400
        }
      }
    ],
    "connections": [
      { "fromIndex": 0, "toIndex": 1, "type": "hasUpdate" },
      { "fromIndex": 1, "toIndex": 2, "type": "Success" },
      { "fromIndex": 2, "toIndex": 3, "type": "Success" },
      { "fromIndex": 3, "toIndex": 4, "type": "Success" },
      { "fromIndex": 4, "toIndex": 5, "type": "Success" },
      { "fromIndex": 5, "toIndex": 6, "type": "hasMeasurements" },
      { "fromIndex": 5, "toIndex": 11, "type": "done" },
      { "fromIndex": 6, "toIndex": 7, "type": "Success" },
      { "fromIndex": 7, "toIndex": 8, "type": "Success" },
      { "fromIndex": 8, "toIndex": 9, "type": "Success" },
      { "fromIndex": 9, "toIndex": 10, "type": "Success" },
      { "fromIndex": 2, "toIndex": 12, "type": "Failure" },
      { "fromIndex": 4, "toIndex": 12, "type": "Failure" },
      { "fromIndex": 9, "toIndex": 12, "type": "Failure" }
    ],
    "ruleChainConnections": null
  }
}
