{
  "widget": {
    "type": "latest",
    "sizeX": 7.5,
    "sizeY": 6.5,
    "config": {
      "timewindow": {
        "displayValue": "",
        "selectedTab": 0,
        "realtime": {
          "realtimeType": 1,
          "interval": 1000,
          "timewindowMs": 86400000,
          "quickInterval": "CURRENT_DAY",
          "hideInterval": false,
          "hideLastInterval": false,
          "hideQuickInterval": false
        },
        "history": {
          "historyType": 0,
          "interval": 1000,
          "timewindowMs": 60000,
          "fixedTimewindow": {
            "startTimeMs": 1678197897861,
            "endTimeMs": 1678284297861
          },
          "quickInterval": "CURRENT_DAY",
          "hideInterval": false,
          "hideLastInterval": false,
          "hideFixedInterval": false,
          "hideQuickInterval": false
        },
        "aggregation": {
          "type": "NONE",
          "limit": 200
        }
      },
      "showTitle": true,
      "backgroundColor": "rgb(255, 255, 255)",
      "color": "rgba(0, 0, 0, 0.87)",
      "padding": "0px",
      "settings": {
        "entitiesTitle": "Gateways",
        "enableSearch": true,
        "enableSelectColumnDisplay": false,
        "enableStickyHeader": true,
        "enableStickyAction": true,
        "showCellActionsMenu": true,
        "reserveSpaceForHiddenAction": "true",
        "displayEntityName": false,
        "entityNameColumnTitle": "",
        "displayEntityLabel": false,
        "entityLabelColumnTitle": "Label",
        "displayEntityType": false,
        "displayPagination": true,
        "defaultPageSize": 15,
        "defaultSortOrder": "Label",
        "useRowStyleFunction": false,
        "rowStyleFunction": ""
      },
      "title": "Devices",
      "dropShadow": false,
      "enableFullscreen": false,
      "titleStyle": {
        "fontSize": "24px",
        "fontWeight": 700,
        "padding": "5px 10px 5px 10px",
        "height": "60px"
      },
      "useDashboardTimewindow": false,
      "showLegend": false,
      "datasources": [
        {
          "type": "entity",
          "name": null,
          "entityAliasId": "60f60877-be45-311d-9ee7-25b68c466d89",
          "filterId": null,
          "dataKeys": [
            {
              "name": "label",
              "type": "entityField",
              "label": "Label",
              "color": "#9c27b0",
              "settings": {},
              "_hash": 0.08471582519880028
            },
            {
              "name": "name",
              "type": "entityField",
              "label": "Name",
              "color": "#2196f3",
              "settings": {
                "columnWidth": "0px",
                "useCellStyleFunction": false,
                "cellStyleFunction": "",
                "useCellContentFunction": false,
                "cellContentFunction": "",
                "defaultColumnVisibility": "visible",
                "columnSelectionToDisplay": "enabled",
                "columnExportOption": "onlyVisible"
              },
              "_hash": 0.46096251592014714
            },
            {
              "name": "type",
              "type": "entityField",
              "label": "Type",
              "color": "#4caf50",
              "settings": {
                "customTitle": "",
                "columnWidth": "0px",
                "useCellStyleFunction": false,
                "cellStyleFunction": "",
                "useCellContentFunction": false,
                "useCellContentFunctionOnExport": false,
                "cellContentFunction": "var type = value;\n\nvar typeSvg = getTypeSvg(type);\nvar encodedTypeSvg = encodeURIComponent(typeSvg);\nvar typeSvgUrl = 'data:image/svg+xml,' + encodedTypeSvg;\n\nreturn '<span>'+\n           '<img style=\"vertical-align: middle;\" class=\"mat-icon\" src=\"'+ typeSvgUrl +'\">' +\n           '<span style=\"vertical-align: middle; padding-left: 8px;\">'+ type +'</span>' +\n       '</span>';\n            \nfunction getTypeSvg(type) {\n    var typeSvg;\n    switch (type) {\n        case 'Smart Shelf':\n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M2.5 2C2.22386 2 2 2.22386 2 2.5V17.5C2 17.7761 2.22386 18 2.5 18C2.77614 18 3 17.7761 3 17.5V17H17V17.5C17 17.7761 17.2239 18 17.5 ' +\n                      '18C17.7761 18 18 17.7761 18 17.5V2.5C18 2.22386 17.7761 2 17.5 2C17.2239 2 17 2.22386 17 2.5V8H14C14.5523 8 15 7.55228 15 7V4C15 3.44772 14.5523 3 14 3H11C10.4477 3 10 3.44772 10 4V7C10 ' +\n                      '7.55228 10.4477 8 11 8H7C7.55228 8 8 7.55228 8 7V6C8 5.44772 7.55228 5 7 5H6C5.44772 5 5 5.44772 5 6V7C5 7.55228 5.44772 8 6 8H3V2.5C3 2.22386 2.77614 2 2.5 2ZM17 16V9H3V16H6C5.44772 16 ' +\n                      '5 15.5523 5 15V12C5 11.4477 5.44772 11 6 11H9C9.55228 11 10 11.4477 10 12V15C10 15.5523 9.55228 16 9 16H12C11.4477 16 11 15.5523 11 15V13C11 12.4477 11.4477 12 12 12H14C14.5523 12 15 ' +\n                      '12.4477 15 13V15C15 15.5523 14.5523 16 14 16H17Z\" fill=\"#212121\"/>';\n            break;\n        case 'Freezer':            \n            typeSvg = '<rect x=\"9\" y=\"2\" width=\"2\" height=\"16\" rx=\"1\" fill=\"#212121\"/>' +\n                      '<path d=\"M12.5 3.5L10 6L7.5 3.5M12.5 16.5L10 14L7.5 16.5\" stroke=\"#212121\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>' +\n                      '<path d=\"M16.8792 8.91509L13.4641 8.00002L14.3792 4.58496M5.62082 15.4151L6.53588 12L3.12082 11.085\" stroke=\"#212121\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>' +\n                      '<path d=\"M5.62085 4.58491L6.53591 7.99998L3.12085 8.91504M16.8792 11.0849L13.4641 12L14.3792 15.415\" stroke=\"#212121\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>' +\n                      '<rect x=\"16.4282\" y=\"5.13379\" width=\"2\" height=\"16\" rx=\"1\" transform=\"rotate(60 16.4282 5.13379)\" fill=\"#212121\"/>' +\n                      '<rect x=\"2.57178\" y=\"6.86621\" width=\"2\" height=\"16\" rx=\"1\" transform=\"rotate(-60 2.57178 6.86621)\" fill=\"#212121\"/>';\n            break;\n        case 'Chiller':            \n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M13.0001 7.49994C13.0001 8.53714 12.2661 9.2516 11.4454 9.64333C11.2807 9.72191 11.1185 9.75061 10.9657 9.73874C10.9881 9.82201 ' +\n                      '11.0001 9.90957 11.0001 9.99994C11.0001 10.0304 10.9988 10.0605 10.9961 10.0902C11.1511 10.0322 11.322 9.99993 11.5001 9.99993L12.5001 9.99994L13.5 9.99993C14.3285 9.99992 15.0003 ' +\n                      '10.6975 14.6435 11.4452C14.2517 12.2658 13.5373 12.9999 12.5001 12.9999C11.4629 12.9999 10.7484 12.2658 10.3567 11.4452C10.2781 11.2805 10.2494 11.1184 10.2613 10.9655C10.178 10.988 ' +\n                      '10.0905 10.9999 10.0001 10.9999C9.96965 10.9999 9.93949 10.9986 9.90971 10.9959C9.96779 11.1509 10 11.3218 10 11.5L10 12.4999L10 13.4999C10.0001 14.3284 9.30246 15.0002 8.55482 ' +\n                      '14.6433C7.73413 14.2516 7.00006 13.5371 7.00006 12.4999C7.00006 11.4627 7.73413 10.7483 8.55482 10.3566C8.71948 10.278 8.8817 10.2493 9.03459 10.2611C9.01212 10.1779 9.00013 10.0903 ' +\n                      '9.00013 9.99994C9.00013 9.9695 9.00149 9.93938 9.00416 9.90963C8.84921 9.96766 8.67837 9.9999 8.50029 9.99989L7.50031 9.99988L6.50033 9.99989C5.67189 9.9999 5.00006 9.3023 5.35692 ' +\n                      '8.55467C5.74865 7.73397 6.46311 6.99991 7.50031 6.99991C8.5375 6.99991 9.25197 7.73397 9.6437 8.55467C9.72227 8.71929 9.75098 8.88149 9.73911 9.03435C9.82232 9.01191 9.90983 8.99994 ' +\n                      '10.0001 8.99994C10.0306 8.99994 10.0607 9.0013 10.0905 9.00397C10.0324 8.84898 10.0002 8.67807 10.0002 8.49992L10.0002 7.49994L10.0002 6.49996C10.0001 5.67153 10.6977 4.99969 11.4454 ' +\n                      '5.35655C12.2661 5.74828 13.0001 6.46274 13.0001 7.49994Z\" fill=\"#212121\"/>' +\n                      '<circle cx=\"10\" cy=\"10\" r=\"8\" stroke=\"#212121\" stroke-width=\"2\"/>';\n            break;                      \n        case 'Smart Bin':\n            typeSvg = '<path d=\"M6.71849 14C5.15241 14 4.19394 12.2816 5.01686 10.9491L5.09816 10.8175C5.17797 10.8327 5.26094 10.8383 5.34575 10.8332C5.89704 10.8001 6.31713 10.3264 6.28404 9.77509L6.21705 8.65906C6.19838 8.34795 6.03571 8.06333 5.77714 7.88933C5.51856 7.71533 5.19363 7.67184 4.8984 7.77171L3.93237 8.09851C3.40921 8.27549 3.12858 8.84306 3.30556 9.36622C3.34237 9.47504 3.39608 9.57337 3.46278 9.65927L3.31523 9.89818C1.66939 12.5631 3.58633 16 6.71849 16H7.83485C8.38714 16 8.83485 15.5523 8.83485 15C8.83485 14.4478 8.38714 14 7.83485 14L6.71849 14Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M13.3135 13.8409C14.8789 13.8873 15.8879 12.198 15.1048 10.8418L14.5467 9.87495C14.2705 9.39666 14.4344 8.78507 14.9127 8.50893C15.391 8.23279 16.0026 8.39666 16.2787 8.87495L16.8369 9.84175C18.403 12.5543 16.3849 15.9329 13.2542 15.84L12.9735 15.8317C12.9324 15.9324 12.8741 16.0281 12.7983 16.1143C12.4337 16.5292 11.8019 16.5699 11.387 16.2054L10.621 15.5322C10.3869 15.3264 10.2621 15.0233 10.2835 14.7123C10.3049 14.4014 10.47 14.1182 10.7301 13.9465L11.6632 13.3305C12.124 13.0262 12.7444 13.1531 13.0487 13.614C13.0955 13.6849 13.1321 13.7596 13.1588 13.8363L13.3135 13.8409Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M11.6696 5.21002C10.9272 3.83113 8.95968 3.80195 8.17664 5.15821L7.61846 6.12501C7.34232 6.6033 6.73073 6.76718 6.25244 6.49104C5.77414 6.21489 5.61027 5.6033 5.88641 5.12501L6.44459 4.15821C8.01067 1.44568 11.9456 1.50404 13.4306 4.26183L13.5637 4.50907C13.6715 4.49425 13.7835 4.4969 13.8961 4.51943C14.4377 4.62774 14.7889 5.15457 14.6806 5.69613L14.4806 6.69613C14.4195 7.00175 14.2193 7.26139 13.9393 7.39833C13.6594 7.53526 13.3315 7.53382 13.0528 7.39444L12.0528 6.89444C11.5588 6.64745 11.3586 6.04678 11.6056 5.5528C11.6436 5.47681 11.6899 5.40777 11.743 5.34624L11.6696 5.21002Z\" fill=\"#212121\"/>';\n            break;          \n        case 'Door Sensor':\n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M14 4H6V16H14V4ZM8 12C8.55228 12 9 11.5523 9 11C9 10.4477 8.55228 10 8 10C7.44772 10 7 10.4477 7 11C7 11.5523 7.44772 12 8 12Z\" fill=\"#212121\"/>' +\n                      '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M16 17V3C16 2.44772 15.5523 2 15 2H5C4.44772 2 4 2.44772 4 3V17H3.5C3.22386 17 3 17.2239 3 17.5C3 17.7761 3.22386 18 3.5 18H16.5C16.7761 18 17 17.7761 17 17.5C17 17.2239 16.7761 17 16.5 17H16ZM15 3H5L5 17H15V3Z\" fill=\"#212121\"/>';\n            break;\n        case 'Liquid Level Sensor':\n            typeSvg = '<path d=\"M14.6363 0.453212C14.8228 0.210257 15.1772 0.210257 15.3637 0.453213C15.9404 1.2044 17 2.73057 17 3.80373C17 5.02723 16.1143 5.99982 15 5.99982C13.8857 5.99982 13 5.02723 13 3.80373C13 2.73057 14.0596 1.2044 14.6363 0.453212Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M8.3017 2.76073C8.67788 2.33798 9.32212 2.33798 9.6983 2.76073C11.2801 4.53832 15 9.0479 15 12.1437C15 15.4064 12.3427 18 9 18C5.65725 18 3 15.4064 3 12.1437C3 9.0479 6.71994 4.53832 8.3017 2.76073Z\" fill=\"#212121\"/>';\n            break;\n        case 'Motion Sensor':\n            typeSvg = '<path d=\"M2.5 5C2.22386 5 2 5.22386 2 5.5C2 5.77614 2.22386 6 2.5 6H4C4 6.55228 4.44772 7 5 7H15C15.5523 7 16 6.55228 16 6H17.5C17.7761 6 18 5.77614 18 5.5C18 5.22386 17.7761 5 17.5 5H2.5Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M12.0001 12C12.5524 12 13.0001 11.5523 13.0001 11C13.0001 10.4477 12.5524 10 12.0001 10C11.4478 10 11.0001 10.4477 11.0001 11C11.0001 11.5523 11.4478 12 12.0001 12Z\" fill=\"#212121\"/>' +\n                      '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M10.0001 16C14.0804 16 17.4472 12.9453 17.9384 8.99801C18.0066 8.44996 17.5524 8 17.0001 8H3.00009C2.4478 8 1.99353 8.44996 2.06173 8.99801C2.55295 12.9453 5.91978 16 10.0001 16ZM12.0001 13C13.1047 13 14.0001 12.1046 14.0001 11C14.0001 9.89543 13.1047 9 12.0001 9C10.8955 9 10.0001 9.89543 10.0001 11C10.0001 12.1046 10.8955 13 12.0001 13Z\" fill=\"#212121\"/>';\n            break;\n        case 'Occupancy Sensor':\n            typeSvg = '<path d=\"M7 3.5C7 4.32843 6.32843 5 5.5 5C4.67157 5 4 4.32843 4 3.5C4 2.67157 4.67157 2 5.5 2C6.32843 2 7 2.67157 7 3.5Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M3 12C2.44772 12 2 11.5523 2 11L2 7.88652C2 6.84462 2.84462 6 3.88652 6C3.90535 6 3.92403 6.00055 3.94255 6.00162C3.96157 6.00055 3.98072 6 4 6H7C7.01928 6 7.03843 6.00055 7.05745 6.00162C7.07597 6.00055 7.09465 6 7.11348 6C8.15538 6 9 6.84462 9 7.88652V11C9 11.5523 8.55229 12 8 12V17C8 17.5523 7.55228 18 7 18C6.44772 18 6 17.5523 6 17L6 14H5V17C5 17.5523 4.55228 18 4 18C3.44772 18 3 17.5523 3 17V12Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M16 18C15.4477 18 15 17.5523 15 17V14H14V17C14 17.5523 13.5523 18 13 18C12.4477 18 12 17.5523 12 17V14H10.7215C10.3724 14 10.1308 13.6513 10.2533 13.3244L12.4733 7.40449C12.7901 6.55968 13.5977 6 14.5 6C15.4023 6 16.2099 6.55968 16.5267 7.40449L18.7467 13.3244C18.8692 13.6513 18.6276 14 18.2785 14H17V17C17 17.5523 16.5523 18 16 18Z\" fill=\"#212121\"/>' +\n                      '<path d=\"M14.5 5C15.3284 5 16 4.32843 16 3.5C16 2.67157 15.3284 2 14.5 2C13.6716 2 13 2.67157 13 3.5C13 4.32843 13.6716 5 14.5 5Z\" fill=\"#212121\"/>';\n            break;\n        case 'Smoke Sensor':\n            typeSvg = '<path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M9.64491 2.08319C9.48444 1.9888 9.28482 1.99138 9.12685 2.08988C8.96887 2.18839 8.87871 2.3665 8.89285 2.55213C8.98169 3.71876 8.78795 4.5943 8.45363 5.30483C8.11607 6.02225 7.62209 6.60008 7.06387 7.157C6.88401 7.33644 6.69008 7.52013 6.49214 7.70763C6.10197 8.07721 5.69618 8.46158 5.35189 8.85718C4.81113 9.47853 4.35082 10.1982 4.15741 11.131C3.35478 15.0023 6.43952 18.1649 10.361 17.9822C10.41 17.9806 10.4592 17.9779 10.5088 17.9741L10.55 17.9708L10.5673 17.9695C10.6635 17.9622 10.7585 17.9532 10.8523 17.9427C10.897 17.9427 10.9422 17.9409 10.9878 17.9375C11.1369 17.9261 11.2735 17.9002 11.3976 17.8614C12.9028 17.5787 14.0571 16.8581 14.836 15.8302C15.7453 14.6303 16.1036 13.0646 15.9781 11.4151C15.7275 8.1215 13.5473 4.37866 9.64491 2.08319ZM12.1372 15.5326C12.1487 15.5269 12.1601 15.521 12.1714 15.5152C12.2227 15.2706 12.2393 15.0003 12.2172 14.7101C12.1353 13.6344 11.5243 12.3752 10.3912 11.4298C10.3443 11.6743 10.2711 11.8979 10.1767 12.1045C9.97248 12.5515 9.68116 12.8915 9.40451 13.1748C9.2918 13.2902 9.1897 13.3891 9.09461 13.4812C8.93666 13.6341 8.79804 13.7684 8.66241 13.9284C8.46694 14.1591 8.33595 14.3839 8.28119 14.6575C8.20904 15.018 8.23357 15.3634 8.33595 15.6725C8.69526 15.8186 9.08844 15.9185 9.50948 15.9633C9.62655 15.764 9.79981 15.6036 9.97777 15.4389C10.3505 15.0938 10.7439 14.7297 10.6844 13.949C11.3929 14.3558 11.8813 14.938 12.1372 15.5326ZM13.2143 14.6343L13.2159 14.6563L13.2421 14.6222C13.7907 13.8983 14.0816 12.8503 13.9839 11.5668C13.8301 9.5445 12.7138 7.15459 10.6097 5.25541C10.5143 5.57021 10.3981 5.86993 10.2634 6.15628C9.78098 7.18157 9.09869 7.9521 8.47652 8.57282C8.20885 8.83986 7.97694 9.05847 7.76612 9.25719C7.43058 9.57348 7.14846 9.83941 6.86065 10.1701C6.45742 10.6334 6.21678 11.0502 6.11585 11.537C5.83546 12.8894 6.29313 14.1616 7.23945 14.9971C7.24423 14.8222 7.26422 14.6432 7.30064 14.4613C7.39921 13.9687 7.63564 13.5933 7.89951 13.2819C8.06367 13.0882 8.26661 12.8908 8.44919 12.7131C8.53584 12.6288 8.61792 12.549 8.68907 12.4761C8.93347 12.2258 9.13295 11.9826 9.26713 11.689C9.39844 11.4016 9.47964 11.0379 9.44124 10.5337C9.42702 10.347 9.51835 10.168 9.67788 10.0698C9.83741 9.97174 10.0384 9.97101 10.1986 10.068C12.0451 11.1851 13.0906 13.0082 13.2143 14.6343Z\" fill=\"#212121\"/>';\n            break;\n        default:\n            typeSvg = '<circle cx=\"10\" cy=\"10\" r=\"10\" fill=\"#AAAAAA\"/>';\n    }\n    \n    return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' + \n           typeSvg +\n           '</svg>';\n} \n",
                "defaultColumnVisibility": "visible",
                "columnSelectionToDisplay": "enabled",
                "columnExportOption": "onlyVisible"
              },
              "_hash": 0.8077097060074172,
              "units": null,
              "decimals": null,
              "funcBody": null,
              "usePostProcessing": null,
              "postFuncBody": null,
              "aggregationType": null
            },
            {
              "name": "state",
              "type": "attribute",
              "label": "State",
              "color": "#ffc107",
              "settings": {
                "columnWidth": "0px",
                "useCellStyleFunction": false,
                "cellStyleFunction": "",
                "useCellContentFunction": true,
                "defaultColumnVisibility": "visible",
                "columnSelectionToDisplay": "enabled",
                "columnExportOption": "onlyVisible",
                "cellContentFunction": "var state = value;\nvar active = entity.active;\nif (active === 'false') {\n    state = 'disconnected';\n}\n\nvar stateSvg = getStateSvg(state);\nvar encodedStateSvg = encodeURIComponent(stateSvg);\nvar stateSvgUrl = 'data:image/svg+xml,' + encodedStateSvg;\nvar stateLabel = getStateLabel(state);\n\nreturn '<span>'+\n           '<img style=\"vertical-align: middle;\" class=\"mat-icon\" src=\"'+ stateSvgUrl +'\">' +\n           '<span style=\"vertical-align: middle; padding-left: 8px;\">'+ stateLabel +'</span>' +\n       '</span>';\n            \nfunction getStateSvg(state) {\n    switch (state) {\n        case 'critical':\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#E64A19\"/>' +\n                   '</svg>';\n        case 'major':            \n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#D5C21B\"/>' +\n                   '</svg>';\n        case 'normal':            \n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#1F8B4D\"/>' +\n                   '</svg>';\n        case 'disconnected':\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<g clip-path=\"url(#clip0_2839_52564)\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#CAC1D2\"/>' +\n                   '<path d=\"M1.92896 16.728L16.0711 2.58589L17.4853 4.00011L3.34317 18.1422L1.92896 16.728Z\" fill=\"#CAC1D2\"/>' +\n                   '<path d=\"M2.10692 16.3171C1.81393 16.0241 1.81393 15.5491 2.10692 15.2561L15.1852 2.17788C15.4781 1.88489 15.9532 1.88489 16.2462 2.17788C16.5392 2.47088 16.5392 2.94591 16.2462 3.2389L3.16794 16.3171C2.87495 16.6101 2.39991 16.6101 2.10692 16.3171Z\" fill=\"white\"/>' +\n                   '</g>' +\n                   '<defs>' +\n                   '<clipPath id=\"clip0_2839_52564\">' +\n                   '<rect width=\"20\" height=\"20\" fill=\"white\"/>' +\n                   '</clipPath>' +\n                   '</defs>' +\n                   '</svg>';\n        default:\n            return '<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">' +\n                   '<circle cx=\"10\" cy=\"10\" r=\"6\" fill=\"#AAAAAA\"/>' +\n                   '</svg>';\n    }\n}\n\nfunction getStateLabel(state) {\n    switch(state) {\n        case 'critical':\n            return 'Critical';\n        case 'major':\n            return 'Major';\n        case 'normal':\n            return 'Normal';\n        case 'disconnected':\n            return 'Disconnected';\n        default:\n            return state;\n    }\n}\n"
              },
              "_hash": 0.2718881518921066,
              "units": null,
              "decimals": null,
              "funcBody": null,
              "usePostProcessing": null,
              "postFuncBody": null
            },
            {
              "name": "active",
              "type": "attribute",
              "label": "active",
              "color": "#607d8b",
              "settings": {
                "columnWidth": "0px",
                "useCellStyleFunction": false,
                "cellStyleFunction": "",
                "useCellContentFunction": false,
                "cellContentFunction": "",
                "defaultColumnVisibility": "hidden",
                "columnSelectionToDisplay": "disabled",
                "columnExportOption": "onlyVisible"
              },
              "_hash": 0.04680501891139488,
              "units": null,
              "decimals": null,
              "funcBody": null,
              "usePostProcessing": null,
              "postFuncBody": null
            },
            {
              "name": "project",
              "type": "attribute",
              "label": "Project",
              "color": "#8bc34a",
              "settings": {},
              "_hash": 0.8763152471849911,
              "aggregationType": null,
              "units": null,
              "decimals": null,
              "funcBody": null,
              "usePostProcessing": null,
              "postFuncBody": null
            },
            {
              "name": "measurement",
              "type": "attribute",
              "label": "Measurement",
              "color": "#3f51b5",
              "settings": {},
              "_hash": 0.35624237678584225,
              "aggregationType": null,
              "units": null,
              "decimals": null,
              "funcBody": null,
              "usePostProcessing": null,
              "postFuncBody": null
            }
          ],
          "alarmFilterConfig": {
            "statusList": [
              "ACTIVE"
            ]
          }
        }
      ],
      "showTitleIcon": false,
      "titleTooltip": "",
      "enableDataExport": false,
      "widgetStyle": {},
      "widgetCss": "div.tb-widget .tb-widget-title {\n    max-height: 100px !important;\n}",
      "noDataDisplayMessage": "",
      "actions": {
        "rowClick": [],
        "headerButton": [
          {
            "name": "Go-Back",
            "icon": "arrow_back",
            "useShowWidgetActionFunction": null,
            "showWidgetActionFunction": "return true;",
            "type": "custom",
            "customFunction": "var params = widgetContext.stateController.getStateParams();\r\nvar number = (widgetContext.stateController.getStateIndex())-1;\r\n/*params['selectedLocation'] = null; //selectedLocation ersetzen mit passenden Parameter bei bedarf kann man mehrere params auf null setzten*/\r\nwidgetContext.stateController.updateState(null,params);\r\nwidgetContext.stateController.navigatePrevState(number);",
            "openInSeparateDialog": false,
            "openInPopover": false,
            "id": "7d1a4c6c-81a8-efc8-e7aa-46a5d330d301"
          },
          {
            "name": "Add Gateway",
            "buttonType": "icon",
            "icon": "add",
            "buttonColor": "rgba(0, 0, 0, 0.87)",
            "useShowWidgetActionFunction": true,
            "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
            "type": "customPretty",
            "customHtml": "<form\r\n  #editEntityForm=\"ngForm\"\r\n  [formGroup]=\"editEntityFormGroup\"\r\n  (ngSubmit)=\"save()\"\r\n  class=\"add-entity-form max-w-3xl mx-auto\" style=\"width:600px;\"\r\n>\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">Add Gateway</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon class=\"material-icons\">close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n\r\n  <mat-progress-bar\r\n    color=\"warn\"\r\n    mode=\"indeterminate\"\r\n    *ngIf=\"isLoading$ | async\"\r\n  ></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <mat-stepper\r\n      *ngIf=\"editEntityFormGroup\"\r\n      #stepper\r\n      [linear]=\"true\"\r\n      animationDuration=\"500ms\"\r\n      style=\"flex-grow: 1;\"\r\n    >\r\n      <!-- Step 1: Gateway details -->\r\n      <mat-step [stepControl]=\"editEntityFormGroup.get('general')\">\r\n        <ng-template matStepLabel>Gateway details</ng-template>\r\n\r\n        <div\r\n          class=\"flex flex-col justify-start items-stretch flex-grow\"\r\n          [formGroup]=\"editEntityFormGroup.get('general')\"\r\n        >\r\n          <!-- Device Type -->\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Device Type</mat-label>\r\n            <mat-select\r\n              formControlName=\"type\"\r\n              placeholder=\"Select Type\"\r\n              (selectionChange)=\"onDeviceTypeChange()\"\r\n            >\r\n              <mat-option value=\"RESI\">RESI</mat-option>\r\n              <mat-option value=\"Gateway\">LoRaWAN Gateway</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n\r\n          <!-- Non-Gateway fields -->\r\n          <div *ngIf=\"editEntityFormGroup.get('general').get('type').value !== 'Gateway'\">\r\n            <!--<div class=\"flex flex-col gap-0 sm:flex-row sm:gap-2\">-->\r\n             <div class=\"flex w-full gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Name</mat-label>\r\n                <input matInput formControlName=\"entityName\" required />\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('general').get('entityName').hasError('required')\">\r\n                  Entity name is required.\r\n                </mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Label</mat-label>\r\n                <input matInput formControlName=\"entityLabel\" />\r\n              </mat-form-field>\r\n            </div>\r\n            <div formGroupName=\"attributes\" class=\"flex flex-col\">\r\n               <div class=\"flex w-full gap-2\">\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>Display Name</mat-label>\r\n                  <input matInput formControlName=\"displayName\" />\r\n                </mat-form-field>\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>Customer</mat-label>\r\n                  <input matInput formControlName=\"customer\" required readonly />\r\n                </mat-form-field>\r\n              </div>\r\n              <div class=\"flex flex-col gap-0 sm:flex-row sm:gap-2\">\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>Serial Number</mat-label>\r\n                  <input matInput formControlName=\"serialNumber\" required />\r\n                </mat-form-field>\r\n              </div>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Inactivity Timeout</mat-label>\r\n                <input type=\"number\" matInput formControlName=\"inactivityTimeout\" required />\r\n              </mat-form-field>\r\n            </div>\r\n          </div>\r\n\r\n          <!-- Gateway-specific fields -->\r\n          <div *ngIf=\"editEntityFormGroup.get('general').get('type').value === 'Gateway'\">\r\n            <div class=\"flex w-full gap-2\">\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Name</mat-label>\r\n                <input matInput formControlName=\"entityName\" required />\r\n                <mat-error *ngIf=\"editEntityFormGroup.get('general').get('entityName').hasError('required')\">\r\n                  Entity name is required.\r\n                </mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                <mat-label>Label</mat-label>\r\n                <input matInput formControlName=\"entityLabel\" />\r\n              </mat-form-field>\r\n            </div>\r\n            <div formGroupName=\"attributes\" fxLayout=\"column\">\r\n               <div class=\"flex w-full gap-2\">\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>Display Name</mat-label>\r\n                  <input matInput formControlName=\"displayName\" />\r\n                </mat-form-field>\r\n                <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                  <mat-label>Customer</mat-label>\r\n                  <input matInput formControlName=\"customer\" required readonly />\r\n                </mat-form-field>\r\n              </div>\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>Gateway ID</mat-label>\r\n                <input matInput formControlName=\"gatewayID\" required pattern=\"[a-zA-Z0-9]{16}\" />\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>Inactivity Timeout</mat-label>\r\n                <input type=\"number\" matInput formControlName=\"inactivityTimeout\" required />\r\n              </mat-form-field>\r\n            </div>\r\n          </div>\r\n\r\n          <!-- Further Actions -->\r\n          <fieldset class=\"fieldset\" style=\"margin-bottom: 15px;\">\r\n            <legend>Select further Actions</legend>\r\n            <div\r\n              style=\"display: flex; flex-direction: column; align-items: flex-start; margin-top: 5px; margin-bottom: 15px;\"\r\n            >\r\n              <div\r\n                class=\"flex justify-between items-center flex-auto w-full h-full\"\r\n                style=\"margin-top: 5px; margin-bottom: 15px;\"\r\n              >\r\n                <mat-checkbox\r\n                  formControlName=\"createKit\"\r\n                  (change)=\"onCreateKitChange($event)\"\r\n                  style=\"flex: 0 0 50%;\"\r\n                >\r\n                  Create Kit\r\n                </mat-checkbox>\r\n                <mat-checkbox\r\n                  *ngIf=\"editEntityFormGroup.get('general').get('createKit').value\"\r\n                  formControlName=\"addDevices\"\r\n                  (change)=\"onAddDevicesChange($event)\"\r\n                  style=\"flex: 0 0 50%;\"\r\n                >\r\n                  Add Devices\r\n                </mat-checkbox>\r\n              </div>\r\n              <mat-form-field\r\n                class=\"flex-1 block\"\r\n                *ngIf=\"editEntityFormGroup.get('general').get('createKit').value\"\r\n                style=\"width: 100%;\"\r\n              >\r\n                <mat-label>New Kit</mat-label>\r\n                <input matInput formControlName=\"newKit\" required />\r\n              </mat-form-field>\r\n              <mat-checkbox formControlName=\"activateSIM\" style=\"width:auto;\">Activate SIM</mat-checkbox>\r\n              <div\r\n                *ngIf=\"editEntityFormGroup.get('general').get('activateSIM').value\"\r\n                formGroupName=\"connectivity\" class=\"w-full\"\r\n              >\r\n                <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                  <mat-label>ICCID</mat-label>\r\n                  <input matInput formControlName=\"ICCID\" required />\r\n                  <mat-error\r\n                    *ngIf=\"\r\n                      editEntityFormGroup.get('general').get('connectivity').get('ICCID').hasError(\r\n                        'required'\r\n                      )\r\n                    \"\r\n                  >\r\n                    ICCID is required.\r\n                  </mat-error>\r\n                </mat-form-field>\r\n                <div class=\"flex w-full gap-2\">\r\n                  <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                    <mat-label>Carrier</mat-label>\r\n                    <mat-select formControlName=\"carrierSIM\" placeholder=\"Select Carrier\" required>\r\n                      <mat-option value=\"tech+\">wherever SIM tech+</mat-option>\r\n                      <mat-option value=\"link+\">wherever SIM link+</mat-option>\r\n                    </mat-select>\r\n                    <mat-error\r\n                      *ngIf=\"\r\n                        editEntityFormGroup.get('general').get('connectivity').get('carrierSIM').hasError(\r\n                          'required'\r\n                        )\r\n                      \"\r\n                    >\r\n                      Carrier is required.\r\n                    </mat-error>\r\n                  </mat-form-field>\r\n                  <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                    <mat-label>SIM Status</mat-label>\r\n                    <mat-select formControlName=\"statusSIM\" placeholder=\"Select SIM-Status\" required>\r\n                      <mat-option value=\"2\">Activate</mat-option>\r\n                      <mat-option value=\"5\">Deactivate</mat-option>\r\n                    </mat-select>\r\n                    <mat-error\r\n                      *ngIf=\"\r\n                        editEntityFormGroup.get('general').get('connectivity').get('statusSIM').hasError(\r\n                          'required'\r\n                        )\r\n                      \"\r\n                    >\r\n                      Status is required.\r\n                    </mat-error>\r\n                  </mat-form-field>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </fieldset>\r\n        </div>\r\n\r\n        <!-- Step 1 Footer -->\r\n        <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n          <button\r\n            mat-button\r\n            color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\"\r\n            cdkFocusInitial\r\n          >\r\n            Cancel\r\n          </button>\r\n          <button\r\n            mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            matStepperNext\r\n            type=\"button\"\r\n            *ngIf=\"\r\n              editEntityFormGroup.get('general').get('type').value !== 'Gateway' ||\r\n              editEntityFormGroup.get('general').get('addDevices').value === true\r\n            \"\r\n            [disabled]=\"\r\n              (isLoading$ | async) ||\r\n              editEntityFormGroup.get('general').invalid ||\r\n              !editEntityFormGroup.get('general').dirty\r\n            \"\r\n          >\r\n            Next\r\n          </button>\r\n          <button\r\n            mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            type=\"submit\"\r\n            *ngIf=\"\r\n              editEntityFormGroup.get('general').get('type').value === 'Gateway' &&\r\n              editEntityFormGroup.get('general').get('addDevices').value === false\r\n            \"\r\n            [disabled]=\"\r\n              (isLoading$ | async) ||\r\n              editEntityFormGroup.invalid ||\r\n              !editEntityFormGroup.dirty\r\n            \"\r\n          >\r\n            Create\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <!-- Step 2: Credentials -->\r\n      <mat-step\r\n        [stepControl]=\"editEntityFormGroup.get('credentials')\"\r\n        *ngIf=\"editEntityFormGroup.get('general').get('type').value !== 'Gateway'\"\r\n      >\r\n        <ng-template matStepLabel>Credentials</ng-template>\r\n        <div\r\n          class=\"flex flex-col justify-start items-stretch\"\r\n          style=\"margin-top: 30px;\"\r\n          [formGroup]=\"editEntityFormGroup.get('credentials')\"\r\n        >\r\n          <mat-form-field class=\"w-full\">\r\n            <mat-label>Credentials Type</mat-label>\r\n            <input matInput formControlName=\"credentialsType\" readonly />\r\n          </mat-form-field>\r\n          <mat-form-field class=\"w-full\">\r\n            <mat-label>Client ID</mat-label>\r\n            <input matInput formControlName=\"clientId\" required />\r\n            <button\r\n              mat-icon-button\r\n              type=\"button\"\r\n              matSuffix\r\n              matTooltip=\"Copy Client ID\"\r\n              (click)=\"copyToClipboard($event, 'credentials.clientId')\"\r\n            >\r\n              <mat-icon>content_copy</mat-icon>\r\n            </button>\r\n            <mat-error\r\n              *ngIf=\"editEntityFormGroup.get('credentials').get('clientId').hasError('required')\"\r\n            >\r\n              Client ID is required.\r\n            </mat-error>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"w-full\">\r\n            <mat-label>User Name</mat-label>\r\n            <input matInput formControlName=\"userName\" required />\r\n            <button\r\n              mat-icon-button\r\n              type=\"button\"\r\n              matSuffix\r\n              matTooltip=\"Copy User Name\"\r\n              (click)=\"copyToClipboard($event, 'credentials.userName')\"\r\n            >\r\n              <mat-icon>content_copy</mat-icon>\r\n            </button>\r\n            <mat-error\r\n              *ngIf=\"editEntityFormGroup.get('credentials').get('userName').hasError('required')\"\r\n            >\r\n              User Name is required.\r\n            </mat-error>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"w-full\">\r\n            <mat-label>Password</mat-label>\r\n            <input\r\n              matInput\r\n              [type]=\"hidePassword ? 'password' : 'text'\"\r\n              formControlName=\"password\"\r\n              required\r\n            />\r\n            <button\r\n              mat-icon-button\r\n              type=\"button\"\r\n              matSuffix\r\n              matTooltip=\"{{ hidePassword ? 'Show Password' : 'Hide Password' }}\"\r\n              (click)=\"togglePasswordVisibility()\"\r\n            >\r\n              <mat-icon>{{ hidePassword ? 'visibility' : 'visibility_off' }}</mat-icon>\r\n            </button>\r\n            <button\r\n              mat-icon-button\r\n              type=\"button\"\r\n              matSuffix\r\n              matTooltip=\"Copy Password\"\r\n              (click)=\"copyToClipboard($event, 'credentials.password')\"\r\n            >\r\n              <mat-icon>content_copy</mat-icon>\r\n            </button>\r\n            <mat-error\r\n              *ngIf=\"editEntityFormGroup.get('credentials').get('password').hasError('required')\"\r\n            >\r\n              Password is required.\r\n            </mat-error>\r\n          </mat-form-field>\r\n        </div>\r\n        <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n          <button\r\n            mat-button\r\n            color=\"primary\"\r\n            type=\"button\"\r\n            [disabled]=\"(isLoading$ | async)\"\r\n            (click)=\"cancel()\"\r\n            cdkFocusInitial\r\n          >\r\n            Cancel\r\n          </button>\r\n          <button\r\n            mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            matStepperNext\r\n            type=\"button\"\r\n            *ngIf=\"editEntityFormGroup.get('general').get('addDevices').value === true\"\r\n          >\r\n            Next\r\n          </button>\r\n          <button\r\n            mat-button\r\n            mat-raised-button\r\n            color=\"primary\"\r\n            type=\"submit\"\r\n            *ngIf=\"editEntityFormGroup.get('general').get('addDevices').value === false\"\r\n            [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid || !editEntityFormGroup.dirty\"\r\n          >\r\n            Create\r\n          </button>\r\n        </div>\r\n      </mat-step>\r\n\r\n      <!-- Step 3: Devices -->\r\n      <mat-step label=\"Devices\" *ngIf=\"showDevicesStep\">\r\n        <ng-template matStepLabel>Devices</ng-template>\r\n        <div\r\n          class=\"flex flex-col justify-start items-stretch\"\r\n          style=\"margin-top: 5px;\"\r\n          [formGroup]=\"editEntityFormGroup.get('devices')\"\r\n        >\r\n          <div style=\"padding-top: 10px;\">\r\n            <mat-tab-group (selectedIndexChange)=\"onTabChange($event)\">\r\n              <!-- Create Tab -->\r\n              <mat-tab label=\"Create\">\r\n                <ng-template matTabContent>\r\n                  <div style=\"margin-top: 10px;\">\r\n                    <div class=\"flex gap-2\" style=\"margin-bottom: 10px;\">\r\n                      <button\r\n                        mat-stroked-button\r\n                        type=\"button\"\r\n                        style=\"flex: 1; background-color: #f0f0f0; color: black;\"\r\n                        (click)=\"addPflow()\"\r\n                        *ngIf=\"editEntityFormGroup.get('general')?.get('type')?.value === 'RESI'\"\r\n                      >\r\n                        Add P-Flow\r\n                      </button>\r\n                      <button\r\n                        mat-stroked-button\r\n                        type=\"button\"\r\n                        style=\"flex: 1; background-color: #f0f0f0; color: black;\"\r\n                        (click)=\"addSensor()\"\r\n                      >\r\n                        Add Sensor\r\n                      </button>\r\n                    </div>\r\n\r\n                    <!-- P-Flow Devices -->\r\n                    <div formArrayName=\"pflowDevices\">\r\n                      <div\r\n                        *ngFor=\"\r\n                          let pflowGroup of editEntityFormGroup.get('devices').get('pflowDevices')\r\n                            .controls;\r\n                          let i = index\r\n                        \"\r\n                        [formGroupName]=\"i\"\r\n                        class=\"flex justify-start items-center gap-2\"\r\n                      >\r\n                        <div class=\"flex-1\">\r\n                          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                            <mat-label>P-Flow {{ i + 1 }}</mat-label>\r\n                            <input matInput formControlName=\"name\" required readonly />\r\n                          </mat-form-field>\r\n                        </div>\r\n                        <button mat-icon-button type=\"button\" (click)=\"removePflow(i)\" *ngIf=\"canRemovePflow(i)\">\r\n                          <mat-icon>delete</mat-icon>\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <!-- Sensor Devices -->\r\n                    <div formArrayName=\"sensorDevices\">\r\n                      <div\r\n                        *ngFor=\"\r\n                          let sensorGroup of editEntityFormGroup.get('devices').get('sensorDevices')\r\n                            .controls;\r\n                          let i = index\r\n                        \"\r\n                        [formGroupName]=\"i\"\r\n                        class=\"flex flex-col gap-2\"\r\n                      >\r\n                        <div class=\"flex justify-start items-center gap-2\">\r\n                          <div class=\"flex-none w-[65%]\">\r\n                            <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                              <mat-label>Sensor {{ i + 1 }}</mat-label>\r\n                              <input matInput formControlName=\"name\" required readonly />\r\n                            </mat-form-field>\r\n                          </div>\r\n                          <div class=\"flex-none w-[35%]\">\r\n                            <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                              <mat-label>Sensor Type</mat-label>\r\n                              <mat-select\r\n                                formControlName=\"type\"\r\n                                required\r\n                                (selectionChange)=\"onSensorTypeChange(i)\"\r\n                              >\r\n                                <mat-option\r\n                                  *ngIf=\"\r\n                                    editEntityFormGroup.get('general')?.get('type')?.value ===\r\n                                    'RESI'\r\n                                  \"\r\n                                  value=\"Temperature Sensor\"\r\n                                >\r\n                                  Temperature\r\n                                </mat-option>\r\n                                <mat-option\r\n                                  *ngIf=\"\r\n                                    editEntityFormGroup.get('general')?.get('type')?.value !==\r\n                                    'RESI'\r\n                                  \"\r\n                                  value=\"Room Sensor CO2\"\r\n                                >\r\n                                  CO2\r\n                                </mat-option>\r\n                              </mat-select>\r\n                            </mat-form-field>\r\n                          </div>\r\n                          <button\r\n                            mat-icon-button\r\n                            type=\"button\"\r\n                            (click)=\"removeSensor(i)\"\r\n                            *ngIf=\"canRemoveSensor(i)\"\r\n                          >\r\n                            <mat-icon>delete</mat-icon>\r\n                          </button>\r\n                        </div>\r\n                        <div\r\n                          *ngIf=\"sensorGroup.get('devEUI')\"\r\n                          class=\"flex gap-2 justify-start items-center\"\r\n                        >\r\n                          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                            <mat-label>devEUI</mat-label>\r\n                            <input\r\n                              matInput\r\n                              formControlName=\"devEUI\"\r\n                              required\r\n                              pattern=\"[a-zA-Z0-9]{16}\"\r\n                            />\r\n                            <mat-error *ngIf=\"sensorGroup.get('devEUI').hasError('required')\">\r\n                              devEUI is required.\r\n                            </mat-error>\r\n                            <mat-error *ngIf=\"sensorGroup.get('devEUI').hasError('pattern')\">\r\n                              devEUI must be 16 alphanumeric characters.\r\n                            </mat-error>\r\n                          </mat-form-field>\r\n                          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                            <mat-label>appKey</mat-label>\r\n                            <input\r\n                              matInput\r\n                              formControlName=\"appKey\"\r\n                              required\r\n                              pattern=\"[a-zA-Z0-9]{32}\"\r\n                            />\r\n                            <mat-error *ngIf=\"sensorGroup.get('appKey').hasError('required')\">\r\n                              appKey is required.\r\n                            </mat-error>\r\n                            <mat-error *ngIf=\"sensorGroup.get('appKey').hasError('pattern')\">\r\n                              appKey must be 32 alphanumeric characters.\r\n                            </mat-error>\r\n                          </mat-form-field>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </ng-template>\r\n              </mat-tab>\r\n\r\n              <!-- Assign Tab -->\r\n              <mat-tab label=\"Assign\">\r\n                <ng-template matTabContent>\r\n                  <div style=\"margin-top: 10px;\" [formGroup]=\"editEntityFormGroup.get('devices').get('assignmentStep')\">\r\n                    <div class=\"flex gap-2\" style=\"margin-bottom: 10px;\">\r\n                      <button\r\n                        mat-stroked-button\r\n                        type=\"button\"\r\n                        style=\"width: 100%; margin-bottom: 8px; background-color: #f0f0f0; color: black;\"\r\n                        (click)=\"addAssignDevice()\"\r\n                        *ngIf=\"editEntityFormGroup.get('general')?.get('type')?.value === 'RESI'\"\r\n                      >\r\n                        Add P-Flow\r\n                      </button>\r\n                      <button\r\n                        mat-stroked-button\r\n                        type=\"button\"\r\n                        style=\"width: 100%; margin-bottom: 16px; background-color: #f0f0f0; color: black;\"\r\n                        (click)=\"addAssignSensor()\"\r\n                      >\r\n                        Add Sensor\r\n                      </button>\r\n                    </div>\r\n\r\n                    <div formArrayName=\"devices\" *ngIf=\"editEntityFormGroup.get('general')?.get('type')?.value === 'RESI'\">\r\n                      <div\r\n                        *ngFor=\"let deviceGroup of editEntityFormGroup.get('devices').get('assignmentStep').get('devices').controls; let i = index\"\r\n                        [formGroupName]=\"i\"\r\n                        class=\"flex justify-start items-center gap-2\"\r\n                      >\r\n                        <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                          <mat-label>P-Flow {{ i + 1 }}</mat-label>\r\n                          <input\r\n                            type=\"text\"\r\n                            matInput\r\n                            formControlName=\"device\"\r\n                            [matAutocomplete]=\"auto\"\r\n                            (keyup)=\"filterAssignDevices(i)\"\r\n                            (focus)=\"resetAssignFilter(i)\"\r\n                            required\r\n                          />\r\n                          <mat-autocomplete #auto=\"matAutocomplete\" [displayWith]=\"displayDevice\">\r\n                            <mat-option *ngFor=\"let device of filteredAssignDevices[i]\" [value]=\"device\">\r\n                              <div class=\"device-item flex flex-col gap-1\">\r\n                                <div class=\"flex\">\r\n                                  <div>{{ device?.name }}</div>\r\n                                </div>\r\n                                <div class=\"flex justify-between items-center\">\r\n                                  <div class=\"device-type\">{{ device?.type }}</div>\r\n                                  <div class=\"device-name\">{{ device?.label }}</div>\r\n                                </div>\r\n                              </div>\r\n                              <mat-divider></mat-divider>\r\n                            </mat-option>\r\n                            <mat-option *ngIf=\"filteredAssignDevices[i].length === 0\" disabled>\r\n                              No devices available\r\n                            </mat-option>\r\n                          </mat-autocomplete>\r\n                          <mat-error *ngIf=\"deviceGroup.get('device')?.hasError('required')\">\r\n                            Device is required.\r\n                          </mat-error>\r\n                          <mat-error *ngIf=\"deviceGroup.get('device').hasError('invalidDevice')\">\r\n                            Please select a valid device from the list.\r\n                          </mat-error>\r\n                        </mat-form-field>\r\n                        <button\r\n                          mat-icon-button\r\n                          type=\"button\"\r\n                          (click)=\"removeAssignDevice(i)\"\r\n                          *ngIf=\"canRemoveAssignDevice(i)\"\r\n                        >\r\n                          <mat-icon>delete</mat-icon>\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div formArrayName=\"sensors\">\r\n                      <div\r\n                        *ngFor=\"let sensorGroup of editEntityFormGroup.get('devices').get('assignmentStep').get('sensors').controls; let i = index\"\r\n                        [formGroupName]=\"i\"\r\n                        class=\"flex justify-start items-center gap-2\"\r\n                      >\r\n                        <mat-form-field appearance=\"fill\" class=\"flex-1\">\r\n                          <mat-label>Sensor {{ i + 1 }}</mat-label>\r\n                          <input\r\n                            type=\"text\"\r\n                            matInput\r\n                            formControlName=\"device\"\r\n                            [matAutocomplete]=\"autoSensor\"\r\n                            (keyup)=\"filterAssignSensors(i)\"\r\n                            (focus)=\"resetAssignSensorFilter(i)\"\r\n                            required\r\n                          />\r\n                          <mat-autocomplete #autoSensor=\"matAutocomplete\" [displayWith]=\"displaySensor\">\r\n                            <mat-option *ngFor=\"let device of filteredAssignSensors[i]\" [value]=\"device\">\r\n                              <div class=\"device-item flex flex-col gap-1\">\r\n                                <div class=\"flex\">\r\n                                  <div>{{ device?.name }}</div>\r\n                                </div>\r\n                                <div class=\"flex justify-between items-center\">\r\n                                  <div class=\"device-type\">{{ device?.type }}</div>\r\n                                  <div class=\"device-name\">{{ device?.label }}</div>\r\n                                </div>\r\n                              </div>\r\n                              <mat-divider></mat-divider>\r\n                            </mat-option>\r\n                            <mat-option *ngIf=\"filteredAssignSensors[i].length === 0\" disabled>\r\n                              No devices available\r\n                            </mat-option>\r\n                          </mat-autocomplete>\r\n                          <mat-error *ngIf=\"sensorGroup.get('device')?.hasError('required')\">\r\n                            Device is required.\r\n                          </mat-error>\r\n                          <mat-error *ngIf=\"sensorGroup.get('device')?.hasError('invalidDevice')\">\r\n                            Please select a valid device from the list.\r\n                          </mat-error>\r\n                        </mat-form-field>\r\n                        <button\r\n                          mat-icon-button\r\n                          type=\"button\"\r\n                          (click)=\"removeAssignSensor(i)\"\r\n                          *ngIf=\"canRemoveAssignSensor(i)\"\r\n                        >\r\n                          <mat-icon>delete</mat-icon>\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </ng-template>\r\n              </mat-tab>\r\n            </mat-tab-group>\r\n\r\n            <!-- Step 3 Footer -->\r\n            <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n              <button mat-button color=\"primary\" type=\"button\" [disabled]=\"isLoading$ | async\" (click)=\"cancel()\">\r\n                Cancel\r\n              </button>\r\n              <button mat-button mat-raised-button color=\"primary\" type=\"submit\" [disabled]=\"(isLoading$ | async) || editEntityFormGroup.invalid || !editEntityFormGroup.dirty\">\r\n                Create\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </mat-step>\r\n    </mat-stepper>\r\n  </div>\r\n</form>\r\n",
            "customCss": "/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n.device-item {\n    line-height: 24px;\n    width: 100%;\n    padding-top: 8px;\n    padding-bottom: 8px;\n}\n\n.device-item .device-name {\n    font-size: 12px;\n    opacity: 0.7;\n}\n\n.device-item .device-type {\n    font-size: 14px;\n    opacity: 0.7;\n}\n\nmat-option {\n    height: auto !important;\n    white-space: normal !important;\n}\n\n.mat-select-value-text {\n    display: block;\n    width: 100%;\n}",
            "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet customerService = $injector.get(widgetContext.servicesMap.get('customerService'));\r\nlet diagnostickitsAll = [];\r\n// Fetch all customers, then fetch all their Diagnostickits\r\n//customerService.getCustomers(pageLink).subscribe(customers => {\r\n  //console.log(\"customers:\", customers);\r\n\r\n  // Track how many customer queries have completed\r\n  let processed = 0;\r\n  //const totalCustomers = customers.data.length;\r\n\r\n  /*customers.data.map(customer => {\r\n    // Build our query for this specific customer's ID\r\n    const assetSearchQuery = {\r\n      parameters: {\r\n        rootId: customer.id.id,       \r\n        rootType: 'CUSTOMER',\r\n        direction: 'FROM',\r\n        relationTypeGroup: 'COMMON',\r\n        maxLevel: 1,\r\n        fetchLastLevelOnly: false\r\n      },\r\n      relationType: 'Owns',\r\n      assetTypes: ['Diagnostickit']\r\n    };\r\n    assetService.findByQuery(assetSearchQuery).subscribe(diagnostickits => {\r\n      //console.log(\"diagnostickits of customer:\", customer.name, diagnostickits);    \r\n      // Merge these Diagnostickits into our master array\r\n      diagnostickitsAll.push(...diagnostickits);\r\n\r\n      // Increment the processed counter\r\n      processed++;\r\n      // If we've processed all customers, open the dialog\r\n      if (processed === totalCustomers) {\r\n        //console.log('All Diagnostickits across all customers:', diagnostickitsAll);\r\n        openAddEntityDialog();\r\n      }\r\n    });\r\n  });\r\n});*/\r\nopenAddEntityDialog();\r\nfunction openAddEntityDialog() {\r\n  customDialog.customDialog(htmlTemplate, AddEntityDialogController).subscribe();\r\n}\r\n\r\nfunction getSelectedCustomerId() {\r\n  let stateParams = widgetContext.stateController.getStateParams();\r\n  return stateParams.entityId.id;\r\n}\r\n\r\nfunction getSelectedCustomerName() {\r\n  let stateParams = widgetContext.stateController.getStateParams();\r\n  try {\r\n    return stateParams.entityName;\r\n  } catch (error) {\r\n    return stateParams.entityName;\r\n  }\r\n}\r\n\r\nfunction generateRandomPassword() {\r\n  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';\r\n  let password = '';\r\n  for (let i = 0; i < 20; i++) {\r\n    password += chars.charAt(Math.floor(Math.random() * chars.length));\r\n  }\r\n  return password;\r\n}\r\n\r\nfunction AddEntityDialogController(instance) {\r\n  let vm = instance;\r\n  let customerID = widgetContext.stateController.getStateParams().entityId.id;\r\n  let customerName = widgetContext.stateController.getStateParams().entityName;\r\n  vm.allowedEntityTypes = ['ASSET', 'DEVICE', 'Gateway'];\r\n  vm.entitySearchDirection = {\r\n    from: 'FROM',\r\n    to: 'TO',\r\n  };\r\n    \r\n     function deviceSelectionValidator(control) {\r\n       if (!control.value) {\r\n            return null;\r\n       }\r\n       return (typeof control.value === 'object' && control.value !== null)\r\n         ? null\r\n         : { invalidDevice: true };\r\n    }\r\n    \r\n  vm.editEntityFormGroup = vm.fb.group({\r\n    general: vm.fb.group({\r\n      type: ['MUC', [vm.validators.required]],\r\n      entityName: [{ value: '' }, [vm.validators.required]],\r\n      entityLabel: [''],\r\n      createKit: [false],\r\n      addDevices: [false],\r\n      activateSIM: [false],\r\n      newKit: [''],\r\n      attributes: vm.fb.group({\r\n        isGateway: [true],\r\n        inactivityTimeout: ['60'],\r\n        street: [''],\r\n        displayName: [''],\r\n        city: [''],\r\n        plz: [''],\r\n        customer: [getSelectedCustomerName()],\r\n        gatewayID: [''],\r\n        serialNumber: ['']\r\n      }),\r\n      connectivity: vm.fb.group({\r\n        ICCID: [''],\r\n        statusSIM: [''],\r\n        carrierSIM: ['']\r\n      }),\r\n    }),\r\n    credentials: vm.fb.group({\r\n      credentialsType: ['MQTT_BASIC'],\r\n      clientId: ['', [vm.validators.required]],\r\n      userName: ['pke', [vm.validators.required]],\r\n      password: [generateRandomPassword(), [vm.validators.required]],\r\n    }),\r\n    devices: vm.fb.group({\r\n      pflowDevices: vm.fb.array([]),\r\n      sensorDevices: vm.fb.array([]),\r\n      assignmentStep: vm.fb.group({\r\n        devices: vm.fb.array([\r\n          vm.fb.group({\r\n            device: [null, [vm.validators.required]],\r\n          }),\r\n        ]),\r\n        sensors: vm.fb.array([]),\r\n      }),\r\n    }),\r\n  });\r\n\r\n  vm.selectedTabIndex = 0;\r\n  \r\n    // Call this when the user types in the input field.\r\n    // 'i' is the index of the assign device group.\r\n    vm.filterAssignDevices = function(i) {\r\n      // Get the current input value from the form control.\r\n      let inputValue = vm.editEntityFormGroup.get('devices')\r\n                          .get('assignmentStep')\r\n                          .get('devices')\r\n                          .at(i)\r\n                          .get('device').value;\r\n      \r\n      // If the value is not a string, fallback to an empty string.\r\n      let filterValue = (typeof inputValue === 'string' ? inputValue.toLowerCase() : '');\r\n      \r\n      if (!filterValue) {\r\n        vm.filteredAssignDevices[i] = vm.getAvailablePFlowDevices(i).slice();\r\n      } else {\r\n        vm.filteredAssignDevices[i] = vm.getAvailablePFlowDevices(i).filter(device =>\r\n          device.name.toLowerCase().includes(filterValue) ||\r\n          (device.label && device.label.toLowerCase().includes(filterValue)) ||\r\n          device.type.toLowerCase().includes(filterValue)\r\n        );\r\n      }\r\n    };\r\n    \r\n    // Reset the filtered devices when the field is focused:\r\n    vm.resetAssignFilter = function(i) {\r\n      vm.filteredAssignDevices[i] = vm.getAvailablePFlowDevices(i).slice();\r\n    };\r\n    \r\n    // A helper display function (as used in your inspiration code)\r\n    vm.displayDevice = function(device) {\r\n      return device ? `${device.name} (${device.type})` : '';\r\n    };\r\n    \r\n    vm.filterAssignSensors = function(i) {\r\n      // Get current input value from the sensor assign control.\r\n      let inputValue = vm.editEntityFormGroup.get('devices')\r\n                          .get('assignmentStep')\r\n                          .get('sensors')\r\n                          .at(i)\r\n                          .get('device').value;\r\n      \r\n      // If the input is an object, get its name property; otherwise use it directly.\r\n      let filterValue = '';\r\n      if (typeof inputValue === 'object' && inputValue !== null) {\r\n        filterValue = inputValue.name ? inputValue.name.toLowerCase() : '';\r\n      } else if (typeof inputValue === 'string') {\r\n        filterValue = inputValue.toLowerCase();\r\n      }\r\n      \r\n      if (!filterValue) {\r\n        vm.filteredAssignSensors[i] = vm.getAvailableSensorDevices(i).slice();\r\n      } else {\r\n        vm.filteredAssignSensors[i] = vm.getAvailableSensorDevices(i).filter(sensor =>\r\n          sensor.name.toLowerCase().includes(filterValue) ||\r\n          (sensor.label && sensor.label.toLowerCase().includes(filterValue)) ||\r\n          sensor.type.toLowerCase().includes(filterValue)\r\n        );\r\n      }\r\n    };\r\n\r\n    \r\n    // 2. Reset function for sensor assign field:\r\n    vm.resetAssignSensorFilter = function(i) {\r\n      vm.filteredAssignSensors[i] = vm.getAvailableSensorDevices(i).slice();\r\n    };\r\n    \r\n    // 3. Display function for sensor:\r\n    vm.displaySensor = function(sensor) {\r\n      return sensor ? `${sensor.name} (${sensor.type})` : '';\r\n    };\r\n\r\n  vm.addPflow = function () {\r\n      if(vm.editEntityFormGroup.get('general').get('type').value === 'RESI') {\r\n        const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n        const index = pflowDevicesArray.length + 1;\r\n        const pflowName = constructBasicPflowName(\r\n          vm.customerShortName,\r\n          vm.editEntityFormGroup.get('general').get('type').value,\r\n          vm.editEntityFormGroup.get('general').get('attributes').get('serialNumber')?.value || '',\r\n          vm.editEntityFormGroup.get('general').get('attributes').get('gatewayID')?.value || '',\r\n          index\r\n        );\r\n      \r\n\r\n        const newPflowGroup = vm.fb.group({\r\n          name: [pflowName],\r\n        });\r\n        pflowDevicesArray.push(newPflowGroup);\r\n      }\r\n  };\r\n\r\n  vm.removePflow = function (index) {\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n    if (\r\n      pflowDevicesArray.length > 1 &&\r\n      index === pflowDevicesArray.length - 1 &&\r\n      index > 0\r\n    ) {\r\n      pflowDevicesArray.removeAt(index);\r\n    }\r\n  };\r\n\r\n  vm.canRemovePflow = function (index) {\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n    return (\r\n      pflowDevicesArray.length > 1 &&\r\n      index === pflowDevicesArray.length - 1 &&\r\n      index > 0\r\n    );\r\n  };\r\n\r\n  vm.addSensor = function () {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      let sensorType;\r\n      if(vm.editEntityFormGroup.get('general').get('type').value === 'RESI') {\r\n            sensorType = 'Temperature Sensor';\r\n      } else{\r\n            sensorType = 'Room Sensor CO2';\r\n      }\r\n      \r\n      let sensorGroupConfig = {\r\n        name: [''],\r\n        type: [sensorType, [vm.validators.required]],\r\n      };\r\n    \r\n      if (\r\n          vm.editEntityFormGroup.get('general').get('type').value === 'Gateway' &&\r\n          vm.editEntityFormGroup.get('general').get('createKit').value &&\r\n          vm.editEntityFormGroup.get('general').get('addDevices').value &&\r\n          sensorType === 'Room Sensor CO2'\r\n        ) {\r\n          sensorGroupConfig['devEUI'] = ['', [vm.validators.required, vm.validators.pattern('[a-zA-Z0-9]{16}')]];\r\n          sensorGroupConfig['appKey'] = ['', [vm.validators.required, vm.validators.pattern('[a-zA-Z0-9]{32}')]];\r\n        }\r\n\r\n    \r\n      const newSensorGroup = vm.fb.group(sensorGroupConfig);\r\n      sensorDevicesArray.push(newSensorGroup);\r\n      updateSensorNames();\r\n    };\r\n\r\n  vm.removeSensor = function (index) {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      if (sensorDevicesArray.length > 0 && index >= 0) {\r\n        sensorDevicesArray.removeAt(index);\r\n\r\n        updateSensorNames();\r\n      }\r\n    };\r\n\r\n  vm.canRemoveSensor = function (index) {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      return (\r\n        sensorDevicesArray.length > 0 &&\r\n        index === sensorDevicesArray.length - 1\r\n      );\r\n    };\r\n\r\n\r\n  vm.onSensorTypeChange = function (index) {\r\n    const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices') ;\r\n    const sensorGroup = sensorDevicesArray.at(index);\r\n    const sensorType = sensorGroup.get('type').value;\r\n    const sensorName = constructSensorName(\r\n      vm.customerShortName,\r\n      vm.editEntityFormGroup.get('general').get('type').value,\r\n      vm.editEntityFormGroup.get('general').get('attributes').get('serialNumber')?.value || '',\r\n      vm.editEntityFormGroup.get('general').get('attributes').get('gatewayID')?.value || '',\r\n      index + 1,\r\n      sensorType\r\n    );\r\n    sensorGroup.get('name').setValue(sensorName);\r\n    \r\n     updateSensorNames();\r\n  };\r\n\r\n  vm.onTabChange = function (index) {\r\n    vm.selectedTabIndex = index;\r\n    vm.updateTabControls();\r\n  };\r\n\r\n  vm.updateTabControls = function () {\r\n    if (vm.selectedTabIndex === 0) {\r\n      vm.enableCreateTabControls();\r\n      vm.disableAssignTabControls();\r\n    } else if (vm.selectedTabIndex === 1) {\r\n      vm.enableAssignTabControls();\r\n      vm.disableCreateTabControls();\r\n    }\r\n  };\r\n\r\n  vm.enableCreateTabControls = function () {\r\n    vm.editEntityFormGroup.get('devices').get('pflowDevices').enable();\r\n    vm.editEntityFormGroup.get('devices').get('sensorDevices').enable();\r\n\r\n    updateEntityName();\r\n\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n   const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices') ;\r\n    \r\n    if (pflowDevicesArray.length === 0 && vm.editEntityFormGroup.get('general').get('type').value === 'RESI') {\r\n      vm.addPflow();\r\n    }\r\n    if (sensorDevicesArray.length === 0 && vm.editEntityFormGroup.get('general').get('type').value === 'Gateway') {\r\n        /*console.log(\"Hello 1\");*/\r\n      vm.addSensor();\r\n    }\r\n  };\r\n\r\n  vm.disableCreateTabControls = function () {\r\n    vm.editEntityFormGroup.get('devices').get('pflowDevices').disable();\r\n    vm.editEntityFormGroup.get('devices').get('sensorDevices').disable();\r\n    vm.editEntityFormGroup.get('devices').get('pflowDevices').reset();\r\n    vm.editEntityFormGroup.get('devices').get('sensorDevices').reset();\r\n  };\r\n\r\n  vm.enableAssignTabControls = function () {\r\n    vm.editEntityFormGroup.get('devices').get('assignmentStep').enable();\r\n  };\r\n\r\n  vm.disableAssignTabControls = function () {\r\n    vm.editEntityFormGroup.get('devices').get('assignmentStep').disable();\r\n    vm.editEntityFormGroup.get('devices').get('assignmentStep').reset();\r\n  };\r\n\r\n  vm.updateTabControls();\r\n\r\n  vm.showDevicesStep = false;\r\n  vm.availableDevices = [];\r\n  vm.pFlowDevices = [];\r\n  vm.sensorDevices = [];\r\n  vm.unassignedDevicesGroup = null;\r\n  vm.customerId = null;\r\n\r\n  if (widgetContext.currentUser.authority === 'TENANT_ADMIN') {\r\n    vm.customerId = widgetContext.stateController.getStateParams().entityId;\r\n  } else {\r\n    vm.customerId = {\r\n      id: widgetContext.currentUser.customerId,\r\n      entityType: 'CUSTOMER',\r\n    };\r\n  }\r\n\r\n  entityGroupService\r\n    .getEntityGroupsByOwnerId(\r\n      vm.customerId.entityType,\r\n      vm.customerId.id,\r\n      'DEVICE'\r\n    )\r\n    .subscribe((entityGroups) => {\r\n      vm.unassignedDevicesGroup = entityGroups.find(\r\n        (group) => group.name === 'Unassigned Diagnostickit Devices'\r\n      );\r\n      if (vm.unassignedDevicesGroup) {\r\n        var query = {\r\n          entityFilter: {\r\n            type: 'entityGroup',\r\n            groupType: 'DEVICE',\r\n            entityGroup: vm.unassignedDevicesGroup.id.id,\r\n          },\r\n          pageLink: {\r\n            pageSize: 100,\r\n            page: 0,\r\n          },\r\n          entityFields: [\r\n            { key: 'name', type: 'ENTITY_FIELD' },\r\n            { key: 'type', type: 'ENTITY_FIELD' },\r\n          ],\r\n        };\r\n        entityService.findEntityDataByQuery(query).subscribe((data) => {\r\n          vm.availableDevices = data.data.map((entityData) => {\r\n            return {\r\n              deviceId: entityData.entityId,\r\n              name: entityData.latest['ENTITY_FIELD'].name.value,\r\n              type: entityData.latest['ENTITY_FIELD'].type.value,\r\n            };\r\n          });\r\n\r\n          vm.pFlowDevices = vm.availableDevices.filter(\r\n            (device) => device.type === 'P-Flow D116'\r\n          );\r\n          vm.sensorDevices = vm.availableDevices.filter(\r\n            (device) =>\r\n              device.type !== 'P-Flow D116' &&\r\n              device.type !== 'IoT Gateway' &&\r\n              device.type !== 'RESI' &&\r\n              device.type !== 'Gateway' &&\r\n              device.type !== 'MUC'\r\n          );\r\n          // Initialize the filtered list for assign fields.\r\n          // For example, if you have at least one assignment group already (default group):\r\n          if (\r\n            vm.editEntityFormGroup.get('devices').get('assignmentStep').get('devices')\r\n              .controls.length > 0\r\n          ) {\r\n            // For the first assign field (index 0)\r\n            let allPFlowDevices = vm.getAvailablePFlowDevices(0);\r\n            vm.filteredAssignDevices = {}; // ensure the object exists\r\n            vm.filteredAssignDevices[0] = allPFlowDevices.slice();\r\n          }\r\n          \r\n          if (\r\n              vm.editEntityFormGroup.get('devices').get('assignmentStep').get('sensors')\r\n                .controls.length > 0\r\n            ) {\r\n              // For the first sensor assign field (index 0)\r\n              let allSensors = vm.getAvailableSensorDevices(0);\r\n              vm.filteredAssignSensors = {}; // ensure the object exists\r\n              vm.filteredAssignSensors[0] = allSensors.slice();\r\n            }\r\n        });\r\n      }\r\n    });\r\n\r\n  vm.getAvailableSensorDevices = function (currentIndex) {\r\n    const assignSensorsArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('sensors').controls;\r\n    const selectedDevices = assignSensorsArray\r\n      .map((sensorGroup, index) =>\r\n        index !== currentIndex ? sensorGroup.get('device').value : null\r\n      )\r\n      .filter((device) => device !== null);\r\n\r\n    return vm.sensorDevices.filter(\r\n      (device) =>\r\n        !selectedDevices.some(\r\n          (selectedDevice) => device.name === selectedDevice.name\r\n        )\r\n    );\r\n  };\r\n\r\n  vm.getAvailablePFlowDevices = function (currentIndex) {\r\n    const assignDevicesArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('devices').controls;\r\n    const selectedDevices = assignDevicesArray\r\n      .map((deviceGroup, index) =>\r\n        index !== currentIndex ? deviceGroup.get('device').value : null\r\n      )\r\n      .filter((device) => device !== null);\r\n\r\n    return vm.pFlowDevices.filter(\r\n      (device) =>\r\n        !selectedDevices.some(\r\n          (selectedDevice) => device.name === selectedDevice.name\r\n        )\r\n    );\r\n  };\r\n\r\n  vm.onCreateKitChange = function (event) {\r\n    let createKitControl = event.checked;\r\n    if (!createKitControl) {\r\n      vm.editEntityFormGroup.get('general').get('newKit').setValue('');\r\n      vm.editEntityFormGroup.get('general').get('addDevices').setValue(false);\r\n      vm.showDevicesStep = false;\r\n    }\r\n  };\r\n\r\n  vm.onAddDevicesChange = function (event) {\r\n    const type = vm.editEntityFormGroup.get('general').get('type').value;\r\n    let addDevicesControl = event.checked;\r\n    vm.showDevicesStep = addDevicesControl;\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices');\r\n    const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n\r\n    if (addDevicesControl === true) {\r\n      if (pflowDevicesArray.length === 0 && type==='RESI') {\r\n        vm.addPflow();\r\n      }else if (type ==='Gateway'){\r\n        sensorDevicesArray.clear();\r\n        vm.addSensor();\r\n        pflowDevicesArray.clear();  \r\n      }\r\n    } else {\r\n      pflowDevicesArray.clear();\r\n      sensorDevicesArray.clear();\r\n    }\r\n  };\r\n\r\n  vm.addAssignDevice = function () {\r\n      const assignDevicesArray = vm.editEntityFormGroup.get('devices').get('assignmentStep').get('devices');\r\n      const newDeviceGroup = vm.fb.group({\r\n        device: [null, [vm.validators.required, deviceSelectionValidator]]\r\n      });\r\n      assignDevicesArray.push(newDeviceGroup);\r\n    };\r\n\r\n  vm.removeAssignDevice = function (index) {\r\n    const assignDevicesArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('devices') ;\r\n    if (\r\n      assignDevicesArray.length > 1 &&\r\n      index === assignDevicesArray.length - 1 &&\r\n      index > 0\r\n    ) {\r\n      assignDevicesArray.removeAt(index);\r\n    }\r\n  };\r\n\r\n  vm.canRemoveAssignDevice = function (index) {\r\n    const assignDevicesArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('devices') ;\r\n    return (\r\n      assignDevicesArray.length > 1 &&\r\n      index === assignDevicesArray.length - 1 &&\r\n      index > 0\r\n    );\r\n  };\r\n\r\n  vm.addAssignSensor = function () {\r\n      const assignSensorsArray = vm.editEntityFormGroup.get('devices').get('assignmentStep').get('sensors');\r\n      const newSensorGroup = vm.fb.group({\r\n        device: [null, [vm.validators.required, deviceSelectionValidator]]\r\n      });\r\n      assignSensorsArray.push(newSensorGroup);\r\n    \r\n      // Ensure the filtered sensor object exists\r\n      if (!vm.filteredAssignSensors) {\r\n        vm.filteredAssignSensors = {};\r\n      }\r\n      // Initialize the filtered sensors for the new index\r\n      const newIndex = assignSensorsArray.length - 1;\r\n      vm.filteredAssignSensors[newIndex] = vm.getAvailableSensorDevices(newIndex).slice();\r\n    };\r\n\r\n  vm.removeAssignSensor = function (index) {\r\n    const assignSensorsArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('sensors') ;\r\n    if (\r\n      assignSensorsArray.length > 0 &&\r\n      index >= 0\r\n    ) {\r\n      assignSensorsArray.removeAt(index);\r\n    }\r\n  };\r\n\r\n  vm.canRemoveAssignSensor = function (index) {\r\n    const assignSensorsArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('sensors') ;\r\n    return assignSensorsArray.length > 0 && index === assignSensorsArray.length -1;\r\n  };\r\n\r\n  vm.editEntityFormGroup\r\n    .get('general')\r\n    .get('entityName')\r\n    .valueChanges.subscribe((value) => {\r\n      vm.editEntityFormGroup.get('credentials').patchValue({\r\n        clientId: value,\r\n      });\r\n    });\r\n\r\n  updateControls();\r\n\r\n  function setupControlSubscriptions() {\r\n    vm.editEntityFormGroup\r\n      .get('general')\r\n      .get('entityName')\r\n      .valueChanges.subscribe((value) => {\r\n        vm.editEntityFormGroup.get('credentials').patchValue({\r\n          clientId: value,\r\n        });\r\n      });\r\n\r\n    const serialNumberControl = vm.editEntityFormGroup\r\n      .get('general')\r\n      .get('attributes')\r\n      .get('serialNumber');\r\n    if (serialNumberControl) {\r\n      serialNumberControl.valueChanges.subscribe(() => updateEntityName());\r\n    }\r\n\r\n    const gatewayIDControl = vm.editEntityFormGroup\r\n      .get('general')\r\n      .get('attributes')\r\n      .get('gatewayID');\r\n    if (gatewayIDControl) {\r\n      gatewayIDControl.valueChanges.subscribe(() => updateEntityName());\r\n    }\r\n\r\n    const typeControl = vm.editEntityFormGroup.get('general').get('type');\r\n    if (typeControl) {\r\n      typeControl.valueChanges.subscribe(() => {\r\n        updateEntityName();\r\n      });\r\n    }\r\n\r\n    const createKitControl = vm.editEntityFormGroup\r\n      .get('general')\r\n      .get('createKit');\r\n    if (createKitControl) {\r\n      createKitControl.valueChanges.subscribe(() => {\r\n        updateEntityName();\r\n      });\r\n    }\r\n  }\r\n\r\n  function updateControls() {\r\n    const type = vm.editEntityFormGroup.get('general').get('type').value;\r\n    const attributesGroup = vm.editEntityFormGroup.get('general').get('attributes');\r\n    const connectivityGroup = vm.editEntityFormGroup.get('general').get('connectivity');\r\n\r\n    if (type === 'Gateway') {\r\n      if (!attributesGroup.contains('gatewayID')) {\r\n        attributesGroup.addControl('gatewayID', vm.fb.control('', [vm.validators.required]));\r\n      }\r\n      if (attributesGroup.contains('serialNumber')) {\r\n        attributesGroup.removeControl('serialNumber');\r\n      }\r\n      vm.editEntityFormGroup.get('credentials').disable();\r\n    } else {\r\n      if (!attributesGroup.contains('serialNumber')) {\r\n        attributesGroup.addControl('serialNumber', vm.fb.control('', [vm.validators.required]));\r\n      }\r\n      if (attributesGroup.contains('gatewayID')) {\r\n        attributesGroup.removeControl('gatewayID');\r\n      }\r\n      vm.editEntityFormGroup.get('credentials').enable();\r\n    }\r\n    \r\n    if(vm.editEntityFormGroup.get('general').get('activateSIM').value === true) {\r\n        connectivityGroup.addControl('ICCID', vm.fb.control('', [vm.validators.required]));\r\n        connectivityGroup.addControl('carrierSIM', vm.fb.control('', [vm.validators.required]));\r\n        connectivityGroup.addControl('statusSIM', vm.fb.control('', [vm.validators.required]));\r\n    } else if(vm.editEntityFormGroup.get('general').get('activateSIM').value === false) {\r\n        connectivityGroup.removeControl('ICCID');\r\n        connectivityGroup.removeControl('carrierSIM');\r\n        connectivityGroup.removeControl('statusSIM');\r\n    }\r\n\r\n    setupControlSubscriptions();\r\n  }\r\n  \r\n  function updateSensorNames() {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      const sensorTypeCounts = {};\r\n    \r\n      for (let i = 0; i < sensorDevicesArray.length; i++) {\r\n        const sensorGroup = sensorDevicesArray.at(i);\r\n        const sensorType = sensorGroup.get('type').value;\r\n    \r\n        const countingType = (sensorType === 'Temperature Sensor' || sensorType === 'Room Sensor T') ? 'Temperature' : sensorType;\r\n    \r\n        if (!sensorTypeCounts[countingType]) {\r\n          sensorTypeCounts[countingType] = 1;\r\n        } else {\r\n          sensorTypeCounts[countingType] += 1;\r\n        }\r\n    \r\n        const sensorTypeIndex = sensorTypeCounts[countingType];\r\n    \r\n        const sensorName = constructSensorName(\r\n          vm.customerShortName,\r\n          vm.editEntityFormGroup.get('general').get('type').value,\r\n          vm.editEntityFormGroup.get('general').get('attributes').get('serialNumber')?.value || '',\r\n          vm.editEntityFormGroup.get('general').get('attributes').get('gatewayID')?.value || '',\r\n          sensorTypeIndex,\r\n          sensorType\r\n        );\r\n    \r\n        sensorGroup.get('name').setValue(sensorName);\r\n      }\r\n    }\r\n\r\n\r\n\r\n  function updateEntityName() {\r\n    const type = vm.editEntityFormGroup.get('general').get('type').value;\r\n    const serialNumber =\r\n      vm.editEntityFormGroup\r\n        .get('general')\r\n        .get('attributes')\r\n        .get('serialNumber')?.value || '';\r\n    const gatewayID =\r\n      vm.editEntityFormGroup\r\n        .get('general')\r\n        .get('attributes')\r\n        .get('gatewayID')?.value || '';\r\n    const customerShortName = vm.customerShortName || '';\r\n    const updatedDeviceName = constructDeviceName(\r\n      customerShortName,\r\n      type,\r\n      serialNumber,\r\n      gatewayID\r\n    );\r\n    vm.editEntityFormGroup.get('general').get('entityName').setValue(updatedDeviceName);\r\n\r\n    /*if (vm.editEntityFormGroup.get('general').get('createKit').value) {\r\n      const kitName = generateDiagnostickitName(type);\r\n      vm.editEntityFormGroup.get('general').get('newKit').setValue(kitName);\r\n    }*/\r\n\r\n    const pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n    for (let i = 0; i < pflowDevicesArray.length; i++) {\r\n      const pflowGroup = pflowDevicesArray.at(i);\r\n      const pflowName = constructBasicPflowName(\r\n        customerShortName,\r\n        type,\r\n        serialNumber,\r\n        gatewayID,\r\n        i + 1\r\n      );\r\n      pflowGroup.get('name').setValue(pflowName);\r\n    }\r\n\r\n    const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices') ;\r\n    for (let i = 0; i < sensorDevicesArray.length; i++) {\r\n      const sensorGroup = sensorDevicesArray.at(i);\r\n      const sensorType = sensorGroup.get('type').value;\r\n      const sensorName = constructSensorName(\r\n        customerShortName,\r\n        type,\r\n        serialNumber,\r\n        gatewayID,\r\n        i + 1,\r\n        sensorType\r\n      );\r\n      sensorGroup.get('name').setValue(sensorName);\r\n    }\r\n    \r\n    updateSensorNames();\r\n  }\r\n\r\n  attributeService\r\n    .getEntityAttributes(\r\n      { entityType: 'CUSTOMER', id: customerID },\r\n      'SERVER_SCOPE',\r\n      ['shortName']\r\n    )\r\n    .subscribe((attributes) => {\r\n      const shortNameAttr = attributes.find((attr) => attr.key === 'shortName');\r\n      vm.customerShortName = shortNameAttr\r\n        ? shortNameAttr.value\r\n        : generateCustomerShortName(customerName);\r\n      updateEntityName();\r\n    });\r\n\r\n  vm.editEntityFormGroup.get('general').get('type').valueChanges.subscribe(() => {\r\n    updateControls();\r\n    updateEntityName();\r\n  });\r\n  \r\n  vm.editEntityFormGroup.get('general').get('activateSIM').valueChanges.subscribe(() => {\r\n    updateControls();\r\n  });\r\n\r\n  setupControlSubscriptions();\r\n\r\n  vm.cancel = function () {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  vm.save = function () {\r\n    vm.editEntityFormGroup.markAsPristine();\r\n\r\n    var customer = widgetContext.stateController.getStateParams().entityId;\r\n    var formValues = vm.editEntityFormGroup.value;\r\n    var kit;\r\n\r\n    if (vm.editEntityFormGroup.get('general').get('createKit').value) {\r\n      saveDiagnostickitObservable(customer).subscribe(\r\n      function (Diagnostickit) {\r\n        kit = Diagnostickit;\r\n        let kitType;\r\n        switch (vm.editEntityFormGroup.get('general').get('type').value) {\r\n            case 'RESI':\r\n                kitType = \"basis\";\r\n                break;\r\n            case 'Gateway':\r\n                kitType = \"loraWan\";\r\n                break;\r\n            default:\r\n                kitType = \"basis\";\r\n                break;\r\n        }\r\n        let attribute = [{\r\n            key : \"kitType\",\r\n            value:kitType,\r\n        }];\r\n        /*console.log(\"kit\",kit);\r\n        console.log(\"kitType\",kitType);*/\r\n        \r\n        attributeService.saveEntityAttributes(kit.id,'SERVER_SCOPE',attribute).subscribe();\r\n        saveCustomerToDiagnostickitRelation(customer, Diagnostickit.id).subscribe();\r\n\r\n        if (vm.editEntityFormGroup.get('general').get('addDevices').value) {\r\n          if (vm.selectedTabIndex === 1) {\r\n            var devicesArray = vm.editEntityFormGroup\r\n              .get('devices')\r\n              .get('assignmentStep')\r\n              .get('devices').value;\r\n\r\n            var sensorsArray = vm.editEntityFormGroup\r\n              .get('devices')\r\n              .get('assignmentStep')\r\n              .get('sensors').value;\r\n\r\n            devicesArray = devicesArray.concat(sensorsArray);\r\n\r\n            assignExistingDevices(kit.id, devicesArray).subscribe(\r\n              function () {\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              },\r\n              function (error) {\r\n                widgetContext.dialogs.alert('Error assigning devices:', error.message);\r\n              }\r\n            );\r\n          } else if (vm.selectedTabIndex === 0) {\r\n            var pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices').value;\r\n\r\n            var pflowDevices = pflowDevicesArray.map(function (device) {\r\n              return { name: device.name, type: 'P-Flow D116' };\r\n            });\r\n\r\n            var sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices').value;\r\n            var sensorDevices = sensorDevicesArray.map(function (device) {\r\n              let sensor = { name: device.name, type: device.type };\r\n              if (device.type === 'Room Sensor CO2' && device.devEUI && device.appKey) {\r\n                sensor.devEUI = device.devEUI;\r\n                sensor.appKey = device.appKey;\r\n              }\r\n              return sensor;\r\n            });\r\n\r\n            var devicesToCreate = pflowDevices.concat(sensorDevices);\r\n\r\n            createAndAssignDevices(kit.id, devicesToCreate).subscribe(\r\n              function () {\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              },\r\n              function (error) {\r\n                widgetContext.dialogs.alert('Error creating and assigning devices:', error.message);\r\n              }\r\n            );\r\n          } else {\r\n            vm.dialogRef.close(null);\r\n          }\r\n        } else {\r\n          vm.dialogRef.close(null);\r\n        }\r\n      });\r\n    } else {\r\n      vm.dialogRef.close(null);\r\n    }\r\n\r\n    \r\n    function createAndAssignDevices(DiagnostickitId, devicesToCreate) {\r\n      var customerId = widgetContext.stateController.getStateParams().entityId;\r\n    \r\n      return getDiagnostickitDevicesGroup(customerId).pipe(\r\n        widgetContext.rxjs.switchMap(function (DiagnostickitDevicesGroup) {\r\n        return getUnassignedDevicesGroupMeasurement(customerId).pipe(\r\n        widgetContext.rxjs.switchMap(function (unassignedDevicesGroupMeasurement) {\r\n          var observables = devicesToCreate.map(function (deviceInfo) {\r\n            return createDeviceObservable(customerId, DiagnostickitDevicesGroup,unassignedDevicesGroupMeasurement, deviceInfo).pipe(\r\n              widgetContext.rxjs.switchMap(function (savedDevice) {\r\n                return saveDeviceToDiagnostickitRelation(DiagnostickitId, savedDevice.id);\r\n              })\r\n            );\r\n          });\r\n    \r\n          return widgetContext.rxjs.forkJoin(observables);\r\n        })\r\n      );\r\n            \r\n        })\r\n      );\r\n    }\r\n    \r\n    function getDiagnostickitDevicesGroup(customerId) {\r\n      return entityGroupService\r\n        .getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE')\r\n        .pipe(\r\n          widgetContext.rxjs.switchMap(function (groups) {\r\n            return getOrCreateDevicesGroup(groups, 'Diagnostickit Devices', customerId);\r\n          })\r\n        );\r\n    }\r\n    function getUnassignedDevicesGroupMeasurement(customerId) {\r\n      return entityGroupService\r\n        .getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE')\r\n        .pipe(\r\n          widgetContext.rxjs.switchMap(function (groups) {\r\n            return getOrCreateDevicesGroup(groups, 'Unassigned Measurement Devices', customerId);\r\n          })\r\n        );\r\n    }\r\n\r\n\r\n    \r\n    function createDeviceObservable(customerId, DiagnostickitDevicesGroup,unassignedDevicesGroupMeasurement, deviceInfo) {\r\n      var device = {\r\n        name: deviceInfo.name,\r\n        type: deviceInfo.type,\r\n        customerId: customerId,\r\n      };\r\n    \r\n      return deviceService.saveDevice(device, DiagnostickitDevicesGroup.id.id).pipe(\r\n        widgetContext.rxjs.switchMap(function (savedDevice) {\r\n                if (deviceInfo.type === 'Room Sensor CO2' && deviceInfo.devEUI && deviceInfo.appKey) {\r\n                let attributesArray = [\r\n                  { key: 'devEui', value: deviceInfo.devEUI },\r\n                  { key: 'appKey', value: deviceInfo.appKey }\r\n                ];\r\n                return attributeService.saveEntityAttributes(savedDevice.id, 'SERVER_SCOPE', attributesArray).pipe(\r\n                  widgetContext.rxjs.map(() => savedDevice)\r\n                );\r\n              }\r\n            return entityGroupService\r\n              .addEntityToEntityGroup(unassignedDevicesGroupMeasurement.id.id, savedDevice.id.id)\r\n              .pipe(\r\n                widgetContext.rxjs.switchMap(() => {\r\n              return saveCustomerToDeviceRelation(customerId, savedDevice.id).pipe(\r\n                widgetContext.rxjs.map(function () {\r\n                  return savedDevice;\r\n                })\r\n              );\r\n            })\r\n          );\r\n        })\r\n      );\r\n    }\r\n\r\n    function updateSensorControls() {\r\n      const sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n      const isGateway = vm.editEntityFormGroup.get('general').get('type').value === 'Gateway';\r\n      const createKit = vm.editEntityFormGroup.get('general').get('createKit').value;\r\n      const addDevices = vm.editEntityFormGroup.get('general').get('addDevices').value;\r\n      \r\n      sensorDevicesArray.controls.forEach(sensorGroup => {\r\n        // Only for Room Sensor CO2 sensors\r\n        if (sensorGroup.get('type').value === 'Room Sensor CO2') {\r\n          if (isGateway && createKit && addDevices) {\r\n            // Add extra controls if missing\r\n            if (!sensorGroup.contains('devEUI')) {\r\n              sensorGroup.addControl('devEUI', vm.fb.control(''));\r\n            }\r\n            if (!sensorGroup.contains('appKey')) {\r\n              sensorGroup.addControl('appKey', vm.fb.control(''));\r\n            }\r\n          } else {\r\n            // Remove extra controls if present\r\n            if (sensorGroup.contains('devEUI')) {\r\n              sensorGroup.removeControl('devEUI');\r\n            }\r\n            if (sensorGroup.contains('appKey')) {\r\n              sensorGroup.removeControl('appKey');\r\n            }\r\n          }\r\n        } else {\r\n          // For any sensor that isnt a Room Sensor CO2, remove extra controls if they exist.\r\n          if (sensorGroup.contains('devEUI')) {\r\n            sensorGroup.removeControl('devEUI');\r\n          }\r\n          if (sensorGroup.contains('appKey')) {\r\n            sensorGroup.removeControl('appKey');\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n\r\n    \r\n    function assignExistingDevices(DiagnostickitId, devicesArray) {\r\n        var observables = [];\r\n        devicesArray.forEach((deviceGroup) => {\r\n            if (deviceGroup.device) {\r\n                var deviceId = deviceGroup.device.deviceId;\r\n                observables.push(\r\n                    widgetContext.rxjs.forkJoin([\r\n                        entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n                        saveDeviceToDiagnostickitRelation(DiagnostickitId, deviceId)\r\n                    ])\r\n                );\r\n            } else {\r\n                var deviceId = deviceGroup.deviceId;\r\n                observables.push(\r\n                    widgetContext.rxjs.forkJoin([\r\n                        entityGroupService.removeEntityFromEntityGroup(vm.unassignedDevicesGroup.id.id, deviceId.id),\r\n                        saveDeviceToDiagnostickitRelation(DiagnostickitId, deviceId)\r\n                    ])\r\n                );\r\n            }\r\n        });\r\n        return widgetContext.rxjs.forkJoin(observables);\r\n    }\r\n    \r\n    function saveDeviceToDiagnostickitRelation(DiagnostickitId, deviceId) {\r\n        var relation = {\r\n            from: DiagnostickitId,\r\n            to: deviceId,\r\n            typeGroup: 'COMMON',\r\n            type: 'Contains'\r\n        };\r\n        return entityRelationService.saveRelation(relation);\r\n    }\r\n\r\n    function saveDiagnostickitObservable(customer) {\r\n        return getDiagnostickitsGroup(customer).pipe(\r\n            widgetContext.rxjs.switchMap((DiagnostickitsGroup) => {\r\n                const formValues = vm.editEntityFormGroup.value;\r\n                const Diagnostickit = {\r\n                    name: formValues.general.newKit,\r\n                    type: 'Diagnostickit',\r\n                    customerId: customer\r\n                };\r\n                /*console.log(\"kit:\", Diagnostickit);*/\r\n    \r\n                return assetService.saveAsset(Diagnostickit, DiagnostickitsGroup.id.id).pipe(\r\n                    widgetContext.rxjs.switchMap((savedAsset) => {\r\n                        //console.log(\"saved asset:\", savedAsset);\r\n                        return widgetContext.rxjs.of(savedAsset);\r\n                    })\r\n                );\r\n            })\r\n        );\r\n    }\r\n    \r\n    try {\r\n      getTargetDeviceGroups(customer)\r\n        .pipe(\r\n          widgetContext.rxjs.switchMap((targetDevicesGroup) => {\r\n            var DiagnostickitDevicesGroup = targetDevicesGroup[0];\r\n            var unassignedDevicesGroupMeasurement= targetDevicesGroup[1];\r\n            var unassignedDevicesGroupKit = targetDevicesGroup[2];\r\n            var Gateways = targetDevicesGroup[3];\r\n            \r\n            if(vm.editEntityFormGroup.get('general').get('createKit').value) {\r\n                return saveEntityObservableKit(\r\n                  customer,\r\n                  DiagnostickitDevicesGroup,\r\n                  unassignedDevicesGroupMeasurement,\r\n                  Gateways\r\n            );\r\n            } else {\r\n                return saveEntityObservable(\r\n                  customer,\r\n                  DiagnostickitDevicesGroup,\r\n                  unassignedDevicesGroupMeasurement,\r\n                  unassignedDevicesGroupKit,\r\n                  Gateways\r\n                );\r\n            }\r\n          })\r\n        )\r\n        .subscribe(gateway =>{\r\n            \r\n            if(vm.editEntityFormGroup.get('general').get('createKit').value) {\r\n                saveDeviceToDiagnostickitRelation(kit.id, gateway.id).subscribe();\r\n            }\r\n            \r\n            saveCustomerToDeviceRelation(customer, gateway.id).subscribe();\r\n            saveAttributes(gateway.id).subscribe();\r\n            \r\n            if (vm.editEntityFormGroup.get('general').get('type').value !== 'Gateway') {\r\n            updateCredentials(gateway.id).subscribe(\r\n              () => {\r\n                widgetContext.updateAliases();\r\n                vm.dialogRef.close(null);\r\n              },\r\n              (error) => {\r\n                widgetContext.dialogs.alert('Error updating credentials:', error.message);\r\n              }\r\n            );\r\n          } else {\r\n            widgetContext.updateAliases();\r\n            vm.dialogRef.close(null);\r\n          }\r\n        });\r\n        \r\n    } catch (error) {\r\n      widgetContext.dialogs.alert('Unexpected error:', error.message);\r\n    }\r\n    \r\n    vm.dialogRef.close(null);\r\n  };\r\n  \r\n  function getDiagnostickitsGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var DiagnostickitsGroup = entityGroups.find(group => group.name === 'Diagnostickits');\r\n              if (DiagnostickitsGroup) {\r\n                  return widgetContext.rxjs.of(DiagnostickitsGroup);\r\n              } else {\r\n                  DiagnostickitsGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Diagnostickits',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(DiagnostickitsGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  \r\n  function getUnassignedKitGroup(customerId) {\r\n      return entityGroupService.getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'ASSET').pipe(\r\n          widgetContext.rxjs.switchMap((entityGroups) => {\r\n              var UnassignedKitGroup = entityGroups.find(group => group.name === 'Unassigned Kit');\r\n              if (UnassignedKitGroup) {\r\n                  return widgetContext.rxjs.of(UnassignedKitGroup);\r\n              } else {\r\n                  UnassignedKitGroup = {\r\n                      type: 'ASSET',\r\n                      name: 'Unassigned Kit',\r\n                      ownerId: customerId\r\n                  };\r\n                  return entityGroupService.saveEntityGroup(UnassignedKitGroup);\r\n              }\r\n          })\r\n      );\r\n  }\r\n  \r\n function saveCustomerToDiagnostickitRelation(customerId, DiagnostickitId) {\r\n    var relation = {\r\n        from: customerId,\r\n        to: DiagnostickitId,\r\n        typeGroup: 'COMMON',\r\n        type: 'Owns'\r\n    };\r\n    //console.log(\"Initiating save relation with payload:\", relation);\r\n\r\n    return entityRelationService.saveRelation(relation).pipe(\r\n        widgetContext.rxjs.tap({\r\n            next: (response) => {\r\n                //console.log(\"Successfully saved relation:\", response);\r\n            },\r\n            error: (error) => {\r\n                console.error(\"Error occurred while saving relation:\", error);\r\n            },\r\n        }),\r\n        widgetContext.rxjs.catchError((error) => {\r\n            console.error(\"Caught error while saving relation:\", error);\r\n            return widgetContext.rxjs.throwError(() => new Error(`Failed to save relation: ${error.message}`));\r\n        })\r\n    );\r\n}\r\n\r\nfunction saveCustomerToDeviceRelation(customerId, DeviceId) {\r\n    var relation = {\r\n        from: customerId,\r\n        to: DeviceId,\r\n        typeGroup: 'COMMON',\r\n        type: 'Contains'\r\n    };\r\n    //console.log(\"Initiating save relation with payload:\", relation);\r\n\r\n    return entityRelationService.saveRelation(relation).pipe(\r\n        widgetContext.rxjs.tap({\r\n            next: (response) => {\r\n                //console.log(\"Successfully saved relation:\", response);\r\n            },\r\n            error: (error) => {\r\n                console.error(\"Error occurred while saving relation:\", error);\r\n            },\r\n        }),\r\n        widgetContext.rxjs.catchError((error) => {\r\n            console.error(\"Caught error while saving relation:\", error);\r\n            return widgetContext.rxjs.throwError(() => new Error(`Failed to save relation: ${error.message}`));\r\n        })\r\n    );\r\n}\r\n\r\n\r\n\r\n  vm.copyToClipboard = function (event, controlName) {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const value = vm.editEntityFormGroup.get(controlName.split('.')).value;\r\n    navigator.clipboard.writeText(value).then(() => {\r\n      widgetContext.showSuccessToast(\r\n        'Copied to clipboard!',\r\n        2000,\r\n        'top',\r\n        'center'\r\n      );\r\n    }).catch((err) => {\r\n      widgetContext.showErrorToast(\r\n        'Failed to copy to clipboard.',\r\n        2000,\r\n        'top',\r\n        'center'\r\n      );\r\n    });\r\n  };\r\n\r\n  vm.onDeviceTypeChange = function (stepper) {\r\n     let pflowDevicesArray = vm.editEntityFormGroup.get('devices').get('pflowDevices') ;\r\n    let sensorDevicesArray = vm.editEntityFormGroup.get('devices').get('sensorDevices');\r\n    let assignSensorsArray = vm.editEntityFormGroup\r\n      .get('devices')\r\n      .get('assignmentStep')\r\n      .get('sensors');\r\n    let assignDevicesArray = vm.editEntityFormGroup\r\n          .get('devices')\r\n          .get('assignmentStep')\r\n          .get('devices');\r\n    const type = vm.editEntityFormGroup.get('general').get('type').value;\r\n    /*console.log(pflowDevicesArray);*/\r\n    \r\n    if (type === 'Gateway') {\r\n      vm.editEntityFormGroup.get('credentials').disable();\r\n        pflowDevicesArray.clear();\r\n        sensorDevicesArray.clear();\r\n        assignSensorsArray.clear();\r\n        assignDevicesArray.clear();\r\n      /*stepper.selectedIndex = 0;*/\r\n    } else {\r\n      vm.editEntityFormGroup.get('credentials').enable();\r\n      /*if (stepper.selectedIndex === 0) {\r\n        stepper.selectedIndex = 1;\r\n      }*/\r\n      sensorDevicesArray.clear();\r\n      assignSensorsArray.clear();\r\n      assignDevicesArray.clear();\r\n    }\r\n    /*console.log(pflowDevicesArray);*/\r\n  };\r\n\r\n  vm.editEntityFormGroup.get('general').get('type').valueChanges.subscribe((type) => {\r\n    if (type === 'Gateway') {\r\n      vm.editEntityFormGroup.get('credentials').disable();\r\n    } else {\r\n      vm.editEntityFormGroup.get('credentials').enable();\r\n    }\r\n  });\r\n\r\n  vm.hidePassword = true;\r\n\r\n  vm.togglePasswordVisibility = function () {\r\n    vm.hidePassword = !vm.hidePassword;\r\n  };\r\n\r\n  function getTargetDeviceGroups(customerId) {\r\n    return entityGroupService\r\n      .getEntityGroupsByOwnerId(customerId.entityType, customerId.id, 'DEVICE')\r\n      .pipe(\r\n        widgetContext.rxjs.switchMap((groups) => {\r\n          return widgetContext.rxjs.forkJoin([\r\n            getOrCreateDevicesGroup(groups, 'Diagnostickit Devices', customerId),\r\n            getOrCreateDevicesGroup(groups, 'Unassigned Measurement Devices', customerId),\r\n            getOrCreateDevicesGroup(groups, 'Unassigned Diagnostickit Devices', customerId),\r\n            getOrCreateDevicesGroup(groups, 'Gateways', customerId),\r\n          ]);\r\n        })\r\n      );\r\n  }\r\n\r\n  function getOrCreateDevicesGroup(groups, groupName, customerId) {\r\n    var devicesGroup = groups.find((group) => group.name === groupName);\r\n    if (devicesGroup) {\r\n      return widgetContext.rxjs.of(devicesGroup);\r\n    } else {\r\n      devicesGroup = {\r\n        type: 'DEVICE',\r\n        name: groupName,\r\n        ownerId: customerId,\r\n      };\r\n      return entityGroupService.saveEntityGroup(devicesGroup);\r\n    }\r\n  }\r\n\r\n  function saveEntityObservable(customerId, DiagnostickitDevicesGroup,unassignedDevicesGroupMeasurement, unassignedDevicesGroup, Gateways) {\r\n    const formValues = vm.editEntityFormGroup.get('general').value;\r\n    let entity = {\r\n      name: formValues.entityName,\r\n      type: formValues.type,\r\n      label: formValues.entityLabel,\r\n      customerId: customerId,\r\n    };\r\n\r\n    return deviceService.saveDevice(entity, unassignedDevicesGroup.id.id).pipe(\r\n      widgetContext.rxjs.switchMap((savedDevice) => {\r\n        return entityGroupService\r\n          .addEntityToEntityGroup(DiagnostickitDevicesGroup.id.id, savedDevice.id.id)\r\n          .pipe(\r\n            widgetContext.rxjs.switchMap(() => { \r\n            return entityGroupService\r\n              .addEntityToEntityGroup(unassignedDevicesGroupMeasurement.id.id, savedDevice.id.id)\r\n              .pipe(\r\n                widgetContext.rxjs.switchMap(() => {\r\n                  return entityGroupService\r\n                    .addEntityToEntityGroup(Gateways.id.id, savedDevice.id.id)\r\n                    .pipe(\r\n                      widgetContext.rxjs.map(() => {\r\n                        return savedDevice;\r\n                      })\r\n                    );\r\n                })\r\n              );\r\n            })\r\n          );\r\n      })\r\n    );\r\n  }\r\n\r\nfunction saveEntityObservableKit(customerId, DiagnostickitDevicesGroup,unassignedDevicesGroupMeasurement, Gateways) {\r\n    const formValues = vm.editEntityFormGroup.get('general').value;\r\n    let entity = {\r\n      name: formValues.entityName,\r\n      type: formValues.type,\r\n      label: formValues.entityLabel,\r\n      customerId: customerId,\r\n    };\r\n\r\n    return deviceService.saveDevice(entity).pipe(\r\n      widgetContext.rxjs.switchMap((savedDevice) => {\r\n        return entityGroupService\r\n          .addEntityToEntityGroup(DiagnostickitDevicesGroup.id.id, savedDevice.id.id)\r\n          .pipe(\r\n            widgetContext.rxjs.switchMap(() => {\r\n            return entityGroupService\r\n          .addEntityToEntityGroup(unassignedDevicesGroupMeasurement.id.id, savedDevice.id.id)\r\n          .pipe(\r\n            widgetContext.rxjs.switchMap(() => {\r\n              return entityGroupService\r\n                .addEntityToEntityGroup(Gateways.id.id, savedDevice.id.id)\r\n                .pipe(\r\n                  widgetContext.rxjs.map(() => {\r\n                    return savedDevice;\r\n                  })\r\n                );\r\n            })\r\n          );\r\n            })\r\n          );\r\n      })\r\n    );\r\n  }\r\n  \r\n  function constructDeviceName(customerShortName, type, serialNumber = '', gatewayID = '') {\r\n    return type === 'Gateway'\r\n      ? `ECO_${gatewayID}_gw`\r\n      : `ECO_${serialNumber}_gw`;\r\n  }\r\n\r\n  function constructBasicPflowName(customerShortName, type, serialNumber = '', gatewayID = '', index = '') {\r\n    return type === 'Gateway'\r\n      ? `ECO_${gatewayID}_PF${index}`\r\n      : `ECO_${serialNumber}_PF${index}`;\r\n  }\r\n\r\n  /*function constructKitName(customerShortName, type, serialNumber = '', gatewayID = '') {\r\n    return type === 'Gateway'\r\n      ? `${customerShortName}_${gatewayID}_Kit`\r\n      : `${customerShortName}_${serialNumber}_Kit`;\r\n  }*/\r\n  /*function generateDiagnostickitName(kitType) {\r\n  // Current 2-digit year\r\n  const year = (new Date().getFullYear() % 100).toString().padStart(2, '0');\r\n  // Prefix depends on kitType\r\n  const prefix = kitType === 'basis' ? 'DBKIT' : 'DEKIT';\r\n\r\n  // Pattern to match, ignoring the year for the counter:\r\n  // e.g. DBKITxxEU-0001 or DEKITxxEU-0001\r\n  // where \"xx\" can be any 2-digit year\r\n  const pattern = new RegExp(`^${prefix}\\\\d{2}EU-(\\\\d{4})$`);\r\n\r\n  // Find the maximum counter among all matching kits\r\n  let maxNumber = 0;\r\n  diagnostickitsAll.forEach(d => {\r\n    const match = d.name.match(pattern);\r\n    if (match) {\r\n      const currentNum = parseInt(match[1], 10);\r\n      if (currentNum > maxNumber) {\r\n        maxNumber = currentNum;\r\n      }\r\n    }\r\n  });\r\n\r\n  // Next counter (increment by 1)\r\n  const nextNumber = (maxNumber + 1).toString().padStart(4, '0');\r\n\r\n  // Construct new name with current year (but counter won't reset per year)\r\n  return `${prefix}${year}EU-${nextNumber}`;\r\n}\r\n  */\r\n  function constructSensorName(customerShortName, type, serialNumber = '', gatewayID = '', index = '', sensorType = 'Temperature Sensor') {\r\n      const sensorTypeShort = sensorType === 'Temperature Sensor' || sensorType === 'Room Sensor T' ? 'TS' :\r\n                              sensorType === 'Room Sensor CO2' ? 'CO2_' :\r\n                              'Sensor';\r\n    \r\n      return type === 'Gateway'\r\n        ? `ECO_${gatewayID}_${sensorTypeShort}${index}`\r\n        : `ECO_${serialNumber}_${sensorTypeShort}${index}`;\r\n    }\r\n\r\n\r\n\r\n  function generateCustomerShortName(customerName) {\r\n    if (!customerName) return '';\r\n    return customerName\r\n      .split(' ')\r\n      .map((word) => word[0].toUpperCase())\r\n      .join('');\r\n  }\r\n\r\n  function updateCredentials(entityId) {\r\n    return deviceService.getDeviceCredentials(entityId.id).pipe(\r\n      widgetContext.rxjs.mergeMap((existingCredentials) => {\r\n        let credentials = vm.editEntityFormGroup.get('credentials').value;\r\n        let deviceCredentials = {\r\n          id: existingCredentials.id,\r\n          deviceId: existingCredentials.deviceId,\r\n          credentialsType: credentials.credentialsType,\r\n          credentialsValue: JSON.stringify({\r\n            clientId: credentials.clientId,\r\n            userName: credentials.userName,\r\n            password: credentials.password,\r\n          }),\r\n        };\r\n        return deviceService.saveDeviceCredentials(deviceCredentials);\r\n      }),\r\n      widgetContext.rxjs.catchError((error) => {\r\n        widgetContext.showErrorToast(\r\n          `Failed to update credentials: ${error.message}`,\r\n          4000,\r\n          'top',\r\n          'center'\r\n        );\r\n        return widgetContext.rxjs.throwError(error);\r\n      })\r\n    );\r\n  }\r\n\r\n function saveAttributes(entityId) {\r\n     \r\n     /*console.log(\"entityId:\", entityId);*/\r\n      let attributes = vm.editEntityFormGroup.get('general').get('attributes').value;\r\n      let attributesArray = [];\r\n    \r\n      attributes.inactivityTimeout *= 60000;\r\n    \r\n      for (let key in attributes) {\r\n        if (attributes[key] !== null && attributes[key] !== '') {\r\n          attributesArray.push({\r\n            key: key,\r\n            value: attributes[key],\r\n          });\r\n        }\r\n      }\r\n    \r\n      if (vm.editEntityFormGroup.get('general').get('activateSIM').value) {\r\n        var connectivityValues = vm.editEntityFormGroup.get('general').get('connectivity').value;\r\n        var connectivityAttr = {\r\n          key: \"connectivity\",\r\n          value: {\r\n            \"carrier\": connectivityValues.carrierSIM,\r\n            \"ICCID\": connectivityValues.ICCID,\r\n            \"simStatus\": connectivityValues.statusSIM,\r\n          }\r\n        };\r\n    \r\n        attributesArray.push(connectivityAttr);\r\n      }\r\n      var kitAttr = {\r\n            key: 'diagnostickit',\r\n            value: vm.editEntityFormGroup.get('general').get('newKit').value\r\n        }\r\n    \r\n      attributesArray.push(kitAttr);\r\n      if (attributesArray.length > 0) {\r\n        return attributeService.saveEntityAttributes(\r\n          entityId,\r\n          'SERVER_SCOPE',\r\n          attributesArray\r\n        ).pipe(\r\n          widgetContext.rxjs.tap(() => {\r\n            /*console.log('Attributes saved successfully.');*/\r\n          }),\r\n          widgetContext.rxjs.catchError((error) => {\r\n            console.error('Error saving attributes:', error);\r\n            return widgetContext.rxjs.throwError(error);\r\n          })\r\n        );\r\n      } else {\r\n        return widgetContext.rxjs.of([]);\r\n      }\r\n    }\r\n\r\n\r\n\r\n  function saveRelations(entityId) {\r\n    let relations = vm.editEntityFormGroup.get('relations').value;\r\n    let tasks = [];\r\n    for (let i = 0; i < relations.length; i++) {\r\n      let relation = {\r\n        type: relations[i].relationType,\r\n        typeGroup: 'COMMON',\r\n      };\r\n      if (relations[i].direction == 'FROM') {\r\n        relation.to = relations[i].relatedEntity;\r\n        relation.from = entityId;\r\n      } else {\r\n        relation.to = entityId;\r\n        relation.from = relations[i].relatedEntity;\r\n      }\r\n      tasks.push(entityRelationService.saveRelation(relation));\r\n    }\r\n    if (tasks.length > 0) {\r\n      return widgetContext.rxjs.forkJoin(tasks);\r\n    }\r\n    return widgetContext.rxjs.of([]);\r\n  }\r\n}\r\n",
            "customResources": [],
            "openInSeparateDialog": false,
            "openInPopover": false,
            "id": "dd13ad24-5569-02a3-b26d-446d9e9d436b"
          }
        ],
        "actionCellButton": [
          {
            "name": "Edit Gateway",
            "icon": "edit",
            "useShowWidgetActionFunction": true,
            "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
            "type": "customPretty",
            "customHtml": "<form [formGroup]=\"editDeviceFormGroup\" (ngSubmit)=\"save()\" class=\"add-entity-form max-w-3xl mx-auto\" style=\"width: 500px;\">\r\n  <mat-toolbar class=\"flex items-center bg-primary text-white px-4\" color=\"primary\">\r\n    <h2 class=\"text-lg font-semibold\">Edit Gateway</h2>\r\n    <span class=\"flex-1\"></span>\r\n    <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </mat-toolbar>\r\n  <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\"></mat-progress-bar>\r\n  <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n  <div mat-dialog-content class=\"flex flex-col p-4 space-y-4\">\r\n    <mat-horizontal-stepper [linear]=\"true\" #stepper style=\"flex-grow: 1;\">\r\n        \r\n      <mat-step [stepControl]=\"editDeviceFormGroup.get('gatewayDetails')\">\r\n        <ng-template matStepLabel>Gateway</ng-template>\r\n        <div class=\"flex flex-col justify-start items-stretch flex-grow\" [formGroup]=\"editDeviceFormGroup.get('gatewayDetails')\">\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Name</mat-label>\r\n            <input matInput formControlName=\"name\" required readonly>\r\n            <mat-error *ngIf=\"editDeviceFormGroup.get('gatewayDetails.name').hasError('required')\">\r\n              Device name is required.\r\n            </mat-error>\r\n          </mat-form-field>\r\n          <!--<mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Type</mat-label>\r\n            <mat-select formControlName=\"type\" required>\r\n              <mat-option *ngFor=\"let type of deviceTypes\" [value]=\"type\">\r\n                {{ type }}\r\n              </mat-option>\r\n            </mat-select>\r\n            <mat-error *ngIf=\"editDeviceFormGroup.get('gatewayDetails.type').hasError('required')\">\r\n              Device type is required.\r\n            </mat-error>\r\n          </mat-form-field>-->\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Label</mat-label>\r\n            <input matInput formControlName=\"label\">\r\n          </mat-form-field>\r\n          <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n              <button mat-button mat-raised-button color=\"primary\" matStepperNext type=\"button\">\r\n                Next\r\n              </button>\r\n            </div>\r\n        </div>\r\n      </mat-step>\r\n      \r\n      <mat-step [stepControl]=\"editDeviceFormGroup.get('simDetails')\">\r\n        <div class=\"flex flex-col justify-start items-stretch flex-grow\" [formGroup]=\"editDeviceFormGroup.get('simDetails')\">\r\n          <ng-template matStepLabel>SIM Card</ng-template>\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>ICCID</mat-label>\r\n            <input matInput formControlName=\"ICCID\">\r\n          </mat-form-field>\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>Carrier</mat-label>\r\n            <mat-select formControlName=\"carrierSIM\">\r\n              <mat-option value=\"tech+\">wherever SIM tech+</mat-option>\r\n              <mat-option value=\"link+\">wherever SIM link+</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n            <mat-label>SIM Status</mat-label>\r\n            <mat-select formControlName=\"statusSIM\">\r\n              <mat-option [value]=\"2\">Activate</mat-option>\r\n              <mat-option [value]=\"5\">Deactivate</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n              <button mat-button mat-raised-button color=\"primary\" matStepperNext type=\"button\">\r\n                Next\r\n              </button>\r\n            </div>\r\n        </div>\r\n      </mat-step>\r\n      \r\n      <mat-step [stepControl]=\"editDeviceFormGroup.get('credentialsDetails')\">\r\n        <div class=\"flex flex-col justify-start items-stretch flex-grow\" [formGroup]=\"editDeviceFormGroup.get('credentialsDetails')\">\r\n          <ng-template matStepLabel>Credentials</ng-template>\r\n          \r\n          <!-- MQTT_BASIC Fields -->\r\n          <div *ngIf=\"editDeviceFormGroup.get('credentialsDetails').get('credentialsType').value === 'MQTT_BASIC'\">\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>Client ID</mat-label>\r\n                <input matInput formControlName=\"clientId\" required />\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"Copy Client ID\" (click)=\"copyToClipboard($event, 'credentialsDetails.clientId')\">\r\n                  <mat-icon>content_copy</mat-icon>\r\n                </button>\r\n                <mat-error *ngIf=\"editDeviceFormGroup.get('credentialsDetails.clientId').hasError('required')\">Client ID is required.</mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>User Name</mat-label>\r\n                <input matInput formControlName=\"userName\" required />\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"Copy User Name\" (click)=\"copyToClipboard($event, 'credentialsDetails.userName')\">\r\n                  <mat-icon>content_copy</mat-icon>\r\n                </button>\r\n                <mat-error *ngIf=\"editDeviceFormGroup.get('credentialsDetails.userName').hasError('required')\">User Name is required.</mat-error>\r\n              </mat-form-field>\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>Password</mat-label>\r\n                <input matInput [type]=\"hidePassword ? 'password' : 'text'\" formControlName=\"password\" readonly/>\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"{{ hidePassword ? 'Show Password' : 'Hide Password' }}\" (click)=\"togglePasswordVisibility()\">\r\n                    <mat-icon>{{ hidePassword ? 'visibility' : 'visibility_off' }}</mat-icon>\r\n                </button>\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"Copy Password\" (click)=\"copyToClipboard($event, 'credentialsDetails.password')\">\r\n                    <mat-icon>content_copy</mat-icon>\r\n                </button>\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"Generate new Password\" (click)=\"generatePassword()\">\r\n                    <mat-icon>autorenew</mat-icon>\r\n                  </button>\r\n              </mat-form-field>\r\n          </div>\r\n          \r\n          <!-- ACCESS_TOKEN Fields -->\r\n          <div *ngIf=\"editDeviceFormGroup.get('credentialsDetails').get('credentialsType').value === 'ACCESS_TOKEN'\">\r\n            <div class=\"flex flex-col justify-evenly items-stretch flex-auto w-full h-full\">\r\n              <mat-form-field appearance=\"fill\" class=\"w-full\">\r\n                <mat-label>Credentials ID</mat-label>\r\n                <input matInput formControlName=\"credentialsId\" required>\r\n                <button mat-icon-button type=\"button\" matSuffix matTooltip=\"Copy Credentials ID\" (click)=\"copyToClipboard($event, 'credentialsDetails.credentialsId')\">\r\n                    <mat-icon>content_copy</mat-icon>\r\n                </button>\r\n                <mat-error *ngIf=\"editDeviceFormGroup.get('credentialsDetails.credentialsId').hasError('required')\">\r\n                    Credentials ID is required.\r\n                </mat-error>\r\n              </mat-form-field>\r\n              <br>\r\n            </div>\r\n          </div>\r\n          \r\n          <div class=\"flex justify-end items-center gap-2\" style=\"margin-top: auto;\">\r\n              <button mat-button matStepperPrevious type=\"button\">Back</button>\r\n              <button mat-button mat-raised-button color=\"primary\" type=\"submit\"\r\n                [disabled]=\"(isLoading$ | async) || editDeviceFormGroup.invalid || !editDeviceFormGroup.dirty\">\r\n                Update Device\r\n              </button>\r\n            </div>\r\n        </div>\r\n      </mat-step>\r\n      \r\n    </mat-horizontal-stepper>\r\n  </div>\r\n</form>\r\n",
            "customCss": "\n.device-item {\n    line-height: 24px;\n    width: 100%;\n    padding-top: 8px;\n    padding-bottom: 8px;\n}\n\n.device-item .device-name {\n    font-size: 12px;\n    opacity: 0.7;\n}\n\n.device-item .device-type {\n    font-size: 14px;\n    opacity: 0.7;\n}\n\nmat-option {\n    height: auto !important;\n    white-space: normal !important;\n}\n\n.mat-select-value-text {\n    display: block;\n    width: 100%;\n}\n\n/* apply a half-opaque blue to disabled filled text-fields */\n.add-entity-form .mdc-text-field--filled.mdc-text-field--disabled {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n/* make sure the disabled focus-overlay is tinted the same */\n.add-entity-form .mat-mdc-form-field-disabled .mat-mdc-form-field-focus-overlay {\n  background-color: rgba(244, 249, 254, 0.5) !important;\n}\n\n.add-entity-form\n  .mdc-text-field--filled:not(.mdc-text-field--disabled) {\n  background-color: #F4F9FE !important;\n}\n\n.add-entity-form\n  .mat-mdc-form-field-focus-overlay {\n  background-color: #F4F9FE !important;\n}\n\n\nmat-icon {\n    vertical-align: middle; /* or baseline, top, bottom */\n    margin-right: 4px; /* space between icon and text */\n}\n\n.fieldset {\n    border: 1px solid #e2e8f0;\n    background: #ffffff;\n    color: #334155;\n    border-radius: 6px;\n    padding-bottom: 1px;\n    padding-top: 1px;\n    padding-left: 10px;\n    padding-right: 10px;\n}\n.fieldset-legend {\n    margin-bottom: 0.375rem;\n    color: #334155;\n    background: #ffffff;\n    font-weight: 300;\n    border-radius: 6px;\n    padding: 2px;\n}\n.fieldset-container{\n    padding-bottom: 10px;\n}\n\n.disabled-checkbox {\n  pointer-events: none;\n  opacity: 0.5; /* To make it visually look disabled */\n}\n\n.disabled-fields {\n  pointer-events: none;   /* Prevents interaction */\n  opacity: 0.5;           /* Makes it look disabled */\n}\n\n/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
            "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\n\r\nconst { mergeMap, of } = widgetContext.rxjs;\r\n\r\nopenEditDeviceDialog();\r\n\r\nfunction openEditDeviceDialog() {\r\n  customDialog.customDialog(htmlTemplate, EditDeviceDialogController).subscribe();\r\n}\r\n\r\nfunction EditDeviceDialogController(instance) {\r\n  let vm = instance;\r\n\r\n  vm.deviceTypes = [\r\n      'MUC',\r\n      'LoRaWAN Gateway',\r\n      'IoT Gateway',\r\n      'RESI'\r\n  ];\r\n\r\n  vm.device = {};\r\n  vm.credentials = {};\r\n  vm.hidePassword = true;\r\n\r\n  vm.editDeviceFormGroup = vm.fb.group({\r\n    gatewayDetails: vm.fb.group({\r\n      name: ['', [vm.validators.required]],\r\n      type: ['', [vm.validators.required]],\r\n      label: ['']\r\n    }),\r\n    simDetails: vm.fb.group({\r\n      ICCID: [''],\r\n      statusSIM: [''],\r\n      carrierSIM: ['']\r\n    }),\r\n    credentialsDetails: vm.fb.group({\r\n      clientId:[''],\r\n      userName:[''],\r\n      password: [''],\r\n      credentialsId:[''],\r\n      credentialsType:['']\r\n    })\r\n  });\r\n\r\n  getDevice();\r\n\r\n  vm.cancel = function() {\r\n    vm.dialogRef.close(null);\r\n  };\r\n\r\n  vm.save = function() {\r\n    saveDevice().pipe(\r\n      mergeMap(() => {\r\n        if (vm.editDeviceFormGroup.get('credentialsDetails').dirty) {\r\n          return updateDeviceCredentials(vm.device.id);\r\n        }\r\n        return of(null);\r\n      })\r\n    ).subscribe(\r\n      function () {\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n      },\r\n      function (error) {\r\n        console.error('Failed to save device or credentials:', error);\r\n        widgetContext.showErrorToast(`Failed to save device or credentials: ${error.message}`, 4000, 'top', 'center');\r\n      }\r\n    );\r\n  };\r\n\r\n  vm.copyToClipboard = function (event, controlName) {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const value = vm.editDeviceFormGroup.get(controlName.split('.')).value;\r\n    navigator.clipboard.writeText(value).then(() => {\r\n      widgetContext.showSuccessToast(\r\n        'Copied to clipboard!',\r\n        2000,\r\n        'top',\r\n        'center'\r\n      );\r\n    }).catch((err) => {\r\n      widgetContext.showErrorToast(\r\n        'Failed to copy to clipboard.',\r\n        2000,\r\n        'top',\r\n        'center'\r\n      );\r\n    });\r\n  };\r\n\r\n  vm.togglePasswordVisibility = function () {\r\n    vm.hidePassword = !vm.hidePassword;\r\n  };\r\n\r\n  vm.generatePassword = function() {\r\n    const newPassword = generatePassword();\r\n    vm.editDeviceFormGroup.get('credentialsDetails.password').setValue(newPassword);\r\n    vm.editDeviceFormGroup.get('credentialsDetails').markAsDirty(); \r\n  };\r\n\r\n  function generatePassword() {\r\n    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\r\n    let password = '';\r\n    for (let i = 0; i < 20; i++) {\r\n      password += chars.charAt(Math.floor(Math.random() * chars.length));\r\n    }\r\n    return password;\r\n  }\r\n\r\n  function getDevice() {\r\n    deviceService.getDevice(entityId.id).subscribe(\r\n      function (device) {\r\n        vm.device = device;\r\n        attributeService.getEntityAttributes(entityId, 'SERVER_SCOPE', ['connectivity']).subscribe(\r\n          function (attributes) {\r\n            if (attributes && attributes.length > 0) {\r\n              const connectivity = attributes.find(attr => attr.key === 'connectivity').value;\r\n              vm.editDeviceFormGroup.get('simDetails').patchValue({\r\n                ICCID: connectivity.ICCID,\r\n                carrierSIM: connectivity.carrier,\r\n                statusSIM: connectivity.simStatus\r\n              });\r\n            }\r\n\r\n            vm.editDeviceFormGroup.get('gatewayDetails').patchValue({\r\n              name: vm.device.name,\r\n              type: vm.device.type,\r\n              label: vm.device.label\r\n            });\r\n\r\n            getDeviceCredentials(entityId.id);\r\n          },\r\n          function (error) {\r\n            console.error('Failed to fetch attributes:', error);\r\n          }\r\n        );\r\n      }\r\n    );\r\n  }\r\n\r\n  function getDeviceCredentials(eid) {\r\n    deviceService.getDeviceCredentials(eid).subscribe(\r\n      (credentials) => {\r\n        let credentialsObject = { credentialsType: credentials.credentialsType };\r\n\r\n        if (credentials.credentialsType === \"MQTT_BASIC\") {\r\n          let credentialsValue = JSON.parse(credentials.credentialsValue);\r\n          credentialsObject.clientId = credentialsValue.clientId;\r\n          credentialsObject.userName = credentialsValue.userName;\r\n          credentialsObject.password = credentialsValue.password;\r\n        } else if (credentials.credentialsType === \"ACCESS_TOKEN\") {\r\n          const credentialsValue = credentials.credentialsValue ? JSON.parse(credentials.credentialsValue) : null;\r\n          if (credentialsValue && credentialsValue.credentialsId) {\r\n            credentialsObject.credentialsId = credentialsValue.credentialsId;\r\n          } else {\r\n            credentialsObject.credentialsId = '';\r\n            console.warn('Missing credentialsId in the device credentials.');\r\n          }\r\n        }\r\n\r\n        vm.credentials = credentialsObject;\r\n\r\n        vm.editDeviceFormGroup.get('credentialsDetails').patchValue({\r\n          credentialsType: credentialsObject.credentialsType || '',\r\n          clientId: credentialsObject.clientId || '',\r\n          userName: credentialsObject.userName || '',\r\n          password: credentialsObject.password || '',\r\n          credentialsId: credentialsObject.credentialsId || ''\r\n        });\r\n\r\n        vm.editDeviceFormGroup.markAsPristine();\r\n        vm.editDeviceFormGroup.markAsUntouched();\r\n        vm.editDeviceFormGroup.updateValueAndValidity();\r\n      },\r\n      (error) => {\r\n        console.error('Failed to load device credentials:', error);\r\n      }\r\n    );\r\n  }\r\n\r\n  function saveDevice() {\r\n    const gatewayValues = vm.editDeviceFormGroup.get('gatewayDetails').value;\r\n    const simValues = vm.editDeviceFormGroup.get('simDetails').value;\r\n\r\n    vm.device.name = gatewayValues.name;\r\n    if (vm.device.type !== gatewayValues.type) {\r\n      vm.device.type = gatewayValues.type;\r\n      vm.device.deviceProfileId = null;\r\n    }\r\n    vm.device.label = gatewayValues.label;\r\n\r\n    const attributes = [\r\n      {\r\n        key: 'connectivity',\r\n        value: {\r\n          ICCID: simValues.ICCID,\r\n          carrier: simValues.carrierSIM,\r\n          simStatus: simValues.statusSIM\r\n        }\r\n      }\r\n    ];\r\n\r\n    return deviceService.saveDevice(vm.device).pipe(\r\n      mergeMap(() => {\r\n        return attributeService.saveEntityAttributes(entityId, 'SERVER_SCOPE', attributes);\r\n      })\r\n    );\r\n  }\r\n\r\n  function updateDeviceCredentials(eid) {\r\n    return deviceService.getDeviceCredentials(eid).pipe(\r\n      mergeMap(existingCredentials => {\r\n        const credentialsValues = vm.editDeviceFormGroup.get('credentialsDetails').value;\r\n        let newCredentials = {\r\n          id: existingCredentials.id,\r\n          deviceId: existingCredentials.deviceId,\r\n          credentialsType: credentialsValues.credentialsType\r\n        };\r\n\r\n        if (credentialsValues.credentialsType === 'MQTT_BASIC') {\r\n          newCredentials.credentialsValue = JSON.stringify({\r\n            clientId: credentialsValues.clientId,\r\n            userName: credentialsValues.userName,\r\n            password: credentialsValues.password\r\n          });\r\n        } else if (credentialsValues.credentialsType === 'ACCESS_TOKEN') {\r\n          newCredentials.credentialsValue = JSON.stringify({\r\n            credentialsId: credentialsValues.credentialsId\r\n          });\r\n        }\r\n\r\n        return deviceService.saveDeviceCredentials(newCredentials);\r\n      })\r\n    );\r\n  }\r\n}\r\n",
            "customResources": [],
            "openInSeparateDialog": false,
            "openInPopover": false,
            "id": "7e870fd2-9559-9a6e-d847-beefc971ecaa"
          },
          {
            "name": "Delete device",
            "icon": "delete",
            "useShowWidgetActionFunction": true,
            "showWidgetActionFunction": "var userRole = widgetContext.stateController.getStateParams().userRole;\n/*console.log(\"UR:\", userRole);*/\nif(userRole !==\"Belimo Retrofit Users\" && userRole !== \"Belimo Retrofit Engineer\" && userRole !== \"Belimo Retrofit Administrators\"){\n    return true;\n}else{\n    return false;\n}",
            "type": "custom",
            "customFunction": "var $injector = widgetContext.$scope.$injector;\nvar dialogs = $injector.get(widgetContext.servicesMap.get('dialogs'));\nvar deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\n\nopenDeleteDeviceDialog();\n\nfunction openDeleteDeviceDialog() {\n  var title = 'Are you sure you want to delete the gateway ' + entityName + '?';\n  var content = 'Be careful, after the confirmation, the gateway and all related data will become unrecoverable!';\n  dialogs.confirm(title, content, 'Cancel', 'Delete').subscribe(\n    function(result) {\n      if (result) {\n        deleteDevice();\n      }\n    }\n  );\n}\n\nfunction deleteDevice() {\n  deviceService.deleteDevice(entityId.id).subscribe(\n    function() {\n      widgetContext.updateAliases();\n    }\n  );\n}\n",
            "openInSeparateDialog": false,
            "openInPopover": false,
            "id": "70f87b5b-3dbc-91e6-0e59-80511b0be772"
          }
        ]
      },
      "titleIcon": "devices_other",
      "iconColor": "rgba(0, 0, 0, 0.87)",
      "iconSize": "28px",
      "displayTimewindow": true,
      "pageSize": 1024
    },
    "row": 0,
    "col": 0,
    "id": "0c7469aa-7b86-be27-5216-bc6cc702f8b1",
    "typeFullFqn": "system.cards.entities_table"
  },
  "aliasesInfo": {
    "datasourceAliases": {
      "0": {
        "alias": "Customer Doktorkit Gateways",
        "filter": {
          "type": "entitiesByGroupName",
          "resolveMultiple": true,
          "groupStateEntity": true,
          "stateEntityParamName": null,
          "groupType": "DEVICE",
          "entityGroupNameFilter": "Gateways"
        }
      }
    },
    "targetDeviceAlias": null
  },
  "filtersInfo": {
    "datasourceFilters": {}
  },
  "originalSize": {
    "sizeX": 24,
    "sizeY": 11
  },
  "originalColumns": 24
}